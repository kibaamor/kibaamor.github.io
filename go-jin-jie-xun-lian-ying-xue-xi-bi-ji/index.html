<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="《Go进阶训练营》学习笔记, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="一个普通游戏程序员的博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>《Go进阶训练营》学习笔记 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/leetcode/" class="waves-effect waves-light">
      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>LeetCode</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>学习</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/softwares/" class="waves-effect waves-light">
      
      <i class="fas fa-toolbox" style="zoom: 0.6;"></i>
      
      <span>软件</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            一个普通游戏程序员的博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/leetcode/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-code"></i>
			
			LeetCode
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			学习
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/softwares/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-toolbox"></i>
			
			软件
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'f65e070788a2647953051a7a1b70ada7fd2b3f70cd4d93c977207f5b762987d4';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">《Go进阶训练营》学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                <span class="chip bg-color">极客时间</span>
                            </a>
                        
                            <a href="/tags/golang/">
                                <span class="chip bg-color">golang</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-10-22
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-10-28
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    12.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    49 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>重点资料：</p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">Practical Go: Real world advice for writing maintainable Go programs</a></p>
<p><a target="_blank" rel="noopener" href="https://research.swtch.com/mm">Memory Models</a></p>
<h2 id="第1周-微服务-微服务概览与治理"><a href="#第1周-微服务-微服务概览与治理" class="headerlink" title="第1周 微服务(微服务概览与治理)"></a>第1周 微服务(微服务概览与治理)</h2><h3 id="1-1-微服务概览"><a href="#1-1-微服务概览" class="headerlink" title="1.1 微服务概览"></a>1.1 微服务概览</h3><h4 id="1-1-1-单体架构"><a href="#1-1-1-单体架构" class="headerlink" title="1.1.1 单体架构"></a>1.1.1 单体架构</h4><p>缺点：无法扩展，可靠性低。无法敏捷性开发和部署。</p>
<p>应对：化繁为简，分而治之。</p>
<h4 id="1-1-2-微服务起源"><a href="#1-1-2-微服务起源" class="headerlink" title="1.1.2 微服务起源"></a>1.1.2 微服务起源</h4><p>SOA（Service-Oriented Architecture，面向服务的架构）和微服务的关系：微服务是 SOA 的一种实践。</p>
<blockquote>
<p>You should instead think of Microservices as a specific approach for SOA in the same way that XP or Scrum are specific approaches for Agile software development.</p>
</blockquote>
<p>微服务更细致的定义：</p>
<ul>
<li>小即是美：小的服务代码少，bug 也少，易测试，易维护，也更容易不断迭代完善的精致进而美妙。</li>
<li>单一职责：一个服务也只需要做好一件事，专注才能做好。</li>
<li>尽可能早地创建原型：尽可能早的提供服务API，建立服务契约，达成服务间沟通的一致性约定，至于实现和完善可以慢慢再做。</li>
<li>可移植性比效率更重要：服务间的轻量级交互协议在效率和可移植性二者间，首要依然考虑兼容性和移植性。</li>
</ul>
<h4 id="1-1-3-微服务的定义"><a href="#1-1-3-微服务的定义" class="headerlink" title="1.1.3 微服务的定义"></a>1.1.3 微服务的定义</h4><p>围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。微服务架构通过业务拆分实现服务组件化，通过组件组合快速开发系统，业务单一的服务组件又可以独立部署<br>使得整个系统变得清晰灵活：</p>
<ul>
<li>原子服务</li>
<li>独立进程</li>
<li>隔离部署</li>
<li>去中心化服务治理</li>
</ul>
<p>缺点：</p>
<ul>
<li>基础设施的建设、复杂度高</li>
</ul>
<h4 id="1-1-4-微服务的不足"><a href="#1-1-4-微服务的不足" class="headerlink" title="1.1.4 微服务的不足"></a>1.1.4 微服务的不足</h4><ul>
<li>微服务应用是分布式系统，由此会带来固有的复杂性。开发者不得不使用 RPC 或者消息传递，来实现进程间通信；此外，必须要写代码来处理消息传递中速度过慢或者服务不可用等局部失效问题。</li>
<li>分区的数据库架构，同时更新多个业务主体的事务很普遍。这种事务对于单体式应用来说很容易，因为只有一个数据库。在微服务架构应用中，需要更新不同服务所使用的不同的数据库，从而对开发者提出了更高的要求和挑战。</li>
<li>测试一个基于微服务架构的应用也是很复杂的任务。</li>
<li>服务模块间的依赖，应用的升级有可能会波及多个服务模块的修改。</li>
<li>对运维基础设施的挑战比较大。</li>
</ul>
<h4 id="1-1-5-组件服务化"><a href="#1-1-5-组件服务化" class="headerlink" title="1.1.5 组件服务化"></a>1.1.5 组件服务化</h4><p>传统实现组件的方式是通过库(library)，库是和应用一起运行在进程中，库的局部变化意味着整个应用的重新部署。通过服务来实现组件，意味着将应用拆散为一系列的服务运行在不同的进程中，那么单一服务的局部变化只需重新部署对应的服务进程。我们用 Go 实施一个微服务：</p>
<ul>
<li>kit：一个微服务的基础库(框架)</li>
<li>service：业务代码 + kit 依赖 + 第三方依赖组成的业务微服务</li>
<li>rpc + message queue：轻量级通讯</li>
</ul>
<p>本质上等同于，多个微服务组合(compose)完成了一个完整的用户场景(usecase)。</p>
<h4 id="1-1-6-按业务组织服务"><a href="#1-1-6-按业务组织服务" class="headerlink" title="1.1.6 按业务组织服务"></a>1.1.6 按业务组织服务</h4><p>按业务能力组织服务的意思是服务提供的能力和业务功能对应，比如：订单服务和数据访问服务，前者反应了真实的订单相关业务，后者是一种技术抽象服务不反应真实的业务。所以按微服务架构理念来划分服务时，是不应该存在数据访问服务这样一个服务的。</p>
<p>事实上传统应用设计架构的分层结构正反映了不同角色的沟通结构。所以若要按微服务的方式来构建应用，也需要对应调整团队的组织架构。每个服务背后的小团队的组织是跨功能的，包含实现业务所需的全面的技能。</p>
<p>我们的模式：大前端(移动/Web) =》网关接入=》业务服务=》平台服务=》基础设施(PaaS/Saas)</p>
<p>开发团队对软件在生产环境的运行负全部责任！</p>
<blockquote>
<p>You built it, you fix it.</p>
</blockquote>
<h4 id="1-1-7-去中心化"><a href="#1-1-7-去中心化" class="headerlink" title="1.1.7 去中心化"></a>1.1.7 去中心化</h4><p>每个服务面临的业务场景不同，可以针对性的选择合适的技术解决方案。但也需要避免过度多样化，结合团队实际情况来选择取舍，要是每个服务都用不同的语言的技术栈来实现，想想维护成本真够高的。</p>
<ul>
<li>数据去中心化</li>
<li>治理去中心化</li>
<li>技术去中心化</li>
</ul>
<p>每个服务独享自身的数据存储设施(缓存，数据库等)，不像传统应用共享一个缓存和数据库，这样有利于服务的独立性，隔离相关干扰。</p>
<h4 id="1-1-8-基础设施自动化"><a href="#1-1-8-基础设施自动化" class="headerlink" title="1.1.8 基础设施自动化"></a>1.1.8 基础设施自动化</h4><p>无自动化不微服务，自动化包括测试和部署。单一进程的传统应用被拆分为一系列的多进程服务后，意味着开发、调试、测试、监控和部署的复杂度都会相应增大，必须要有合适的自动化基础设施来支持微服务架构模式，否则开发、运维成本将大大增加。</p>
<ul>
<li>CICD：Gitlab + Gitlab Hooks + k8s</li>
<li>Testing：测试环境、单元测试、API自动化测试</li>
<li>在线运行时：k8s，以及一系列Prometheus、ELK、Control Panel</li>
</ul>
<h4 id="1-1-9-可用性-amp-兼容性设计"><a href="#1-1-9-可用性-amp-兼容性设计" class="headerlink" title="1.1.9 可用性 &amp; 兼容性设计"></a>1.1.9 可用性 &amp; 兼容性设计</h4><p>著名的 Design For Failure 思想，微服务架构采用粗粒度的进程间通信，引入了额外的复杂性和需要处理的新问题，如网络延迟、消息格式、负载均衡和容错，忽略其中任何一点都属于对“分布式计算的误解”。</p>
<ul>
<li>隔离</li>
<li>超时控制</li>
<li>负载保护</li>
<li>限流</li>
<li>降级</li>
<li>重试</li>
<li>负载均衡</li>
</ul>
<p>一旦采用了微服务架构模式，那么在服务需要变更时我们要特别小心，服务提供者的变更可能引发服务消费者的兼容性破坏，时刻谨记保持服务契约(接口)的兼容性。</p>
<p>Be conservative in what you send, be liberal in what you accept.</p>
<p>发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。</p>
<h3 id="1-2-微服务设计"><a href="#1-2-微服务设计" class="headerlink" title="1.2 微服务设计"></a>1.2 微服务设计</h3><h4 id="1-2-1-API-Gateway"><a href="#1-2-1-API-Gateway" class="headerlink" title="1.2.1 API Gateway"></a>1.2.1 API Gateway</h4><ol>
<li><p>第一版的设计</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/APIGateway第一版.png" alt="APIGateway第一版"></p>
<p> 我们进行了 SOA 服务化的架构演进，按照垂直功能进行了拆分，对外暴露了一批微服务，但是因为缺乏统一的出口面临了不少困难：</p>
<ul>
<li>客户端到微服务直接通信，强耦合（很老的客户端的可能一直存在）。</li>
<li>需要多次请求，客户端聚合数据，工作量巨大，延迟高（客户端工作量巨大）。</li>
<li>协议不利于统一，各个部门间有差异，需要端来兼容（各个部门的接口不统一）。</li>
<li>面向“端”的 API 适配，耦合到了内部服务（各个终端的适配代码复杂并耦合到服务内部）。</li>
<li>多终端兼容逻辑复杂，每个服务都需要处理。</li>
<li><p>统一逻辑无法收敛，比如安全认证、限流（每个服务都要做验证）。</p>
<p>我们之前提到了我们工作模型，要内聚模式配合。</p>
</li>
</ul>
</li>
<li><p>第二版的设计</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/APIGateway第二版.png" alt="APIGateway第二版"></p>
<p> 我们新增了一个 app-interface 用于统一的协议出口，在服务内进行大量的 dataset join，按照业务场景来设计粗粒度的 API，给后续服务的演进带来的很多优势：</p>
<ul>
<li>轻量交互：协议精简、聚合。</li>
<li>差异服务：数据裁剪以及聚合、针对终端定制化 API。</li>
<li>动态升级：原有系统兼容升级，更新服务而非协议。</li>
<li><p>沟通效率提升，协作模式演进为移动业务+网关小组。</p>
<p>BFF 可以认为是一种适配服务，将后端的微服务进行适配(主要包括聚合裁剪和格式适配等逻辑)，向无线端设备暴露友好和统一的API，方便无线设备接入访问后端服务。</p>
</li>
</ul>
</li>
<li><p>第三版的设计</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/APIGateway第三版.png" alt="APIGateway第三版"></p>
<p> 最致命的一个问题是整个 app-interface 属于 single point of failure，严重代码缺陷或者流量洪峰可能引发集群宕机。</p>
<ul>
<li><p>单个模块也会导致后续业务集成复杂度高，根据康威法则，单块的无线BFF和多团队之间就出现不匹配问题，团队之间沟通协调成本高，交付效率低下。</p>
<p>解决方法是按照业务域和重要性拆分出了一些大的网关。这种模式在微服务设计模式中叫做 <a target="_blank" rel="noopener" href="https://microservices.io/patterns/data/api-composition.html">API Composition</a>。</p>
</li>
</ul>
</li>
<li><p>第四版的设计</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/APIGateway第四版.png" alt="APIGateway第四版"></p>
<p> 很多跨横切面逻辑，比如安全认证，日志监控，限流熔断等。随着时间的推移，代码变得越来越复杂，技术债越堆越多。</p>
<p> 跨横切面(Cross-Cutting Concerns)的功能，需要协调更新框架升级发版(路由、认证、限流、安全)，因此全部上沉，引入了API Gateway，把业务集成度高的BFF 层和通用功能服务层APIGateway 进行了分层处理。</p>
<p> 在新的架构中，网关承担了重要的角色，它是解耦拆分和后续升级迁移的利器。在网关的配合下，单块BFF实现了解耦拆分，各业务线团队可以独立开发和交付各自的微服务，研发效率大大提升。另外，把跨横切面逻辑从BFF 剥离到网关上去以后，BFF 的开发人员可以更加专注业务逻辑交付，实现了架构上的关注分离(Separation of Concerns)。</p>
<p> 我们业务流量实际为：</p>
<p> 移动端-&gt; API Gateway -&gt; BFF -&gt; Microservice，在Front-end Web业务中，BFF 可以是nodejs 来做服务端渲染(SSR，Server-Side Rendering)，注意这里忽略了上游的CDN、4/7层负载均衡(ELB)。</p>
</li>
</ol>
<h4 id="1-2-2-Microservice-划分"><a href="#1-2-2-Microservice-划分" class="headerlink" title="1.2.2 Microservice 划分"></a>1.2.2 Microservice 划分</h4><p>微服务架构时遇到的第一个问题就是如何划分服务的边界。在实际项目中通常会采用两种不同的方式划分服务边界，即通过业务职能(BusinessCapability)或是DDD 的限界上下文(BoundedContext)。</p>
<p>在不熟悉业务领域时，可以用两种方式划分：</p>
<ul>
<li>Business Capability<br>  按部门划分，由公司内部不同部门提供的职能。例如客户服务部门提供客户服务的职能，财务部门提供财务相关的职能。</li>
<li>Bounded Context<br>  限界上下文是 DDD 中用来划分不同业务边界的元素，这里业务边界的含义是“解决不同业务问题”的问题域和对应的解决方案域，为了解决某种类型的业务问题，贴近领域知识，也就是业务。</li>
</ul>
<p>这本质上也促进了组织结构的演进：Service per team 。</p>
<p>建议：</p>
<ul>
<li>尽量闭环的团队负责一个服务。</li>
<li>尽量在服务划分的很细，需要扇出的请求特别多时再和服务的整合。</li>
</ul>
<h4 id="1-2-3-Microservice-划分之-CQRS"><a href="#1-2-3-Microservice-划分之-CQRS" class="headerlink" title="1.2.3 Microservice 划分之 CQRS"></a>1.2.3 Microservice 划分之 CQRS</h4><p>CQRS，将应用程序分为两部分：命令端和查询端。命令端处理程序创建，更新和删除请求，并在数据更改时发出事件。查询端通过针对一个或多个物化视图执行查询来处理查询，这些物化视图通过订阅数据更改时发出的事件流而保持最新。</p>
<p><img src="/images/《Go进阶训练营》学习笔记/稿件服务的CQRS.png" alt="稿件服务的CQRS"></p>
<p>在稿件服务演进过程中，我们发现围绕着创作稿件、审核稿件、最终发布稿件有大量的逻辑揉在一块，其中稿件本身的状态也有非常多种，但是最终前台用户只关注稿件能否查看，我们依赖稿件数据库 binlog 以及订阅 binlog 的中间件 canal，将我们的稿件结果发布到消息队列 kafka 中，最终消费数据独立组建一个稿件查阅结果数据库，并对外提供一个独立查询服务，来拆分复杂架构和业务。</p>
<p>我们架构也从 Polling publisher -&gt; Transaction log tailing 进行了演进(Pull vs Push)。</p>
<h4 id="1-2-4-Microservice-安全"><a href="#1-2-4-Microservice-安全" class="headerlink" title="1.2.4 Microservice 安全"></a>1.2.4 Microservice 安全</h4><p>对于外网的请求来说，我们通常在 API Gateway 进行统一的认证拦截，一旦认证成功，我们会使<br>用 JWT 方式通过 RPC 元数据传递的方式带到 BFF 层，BFF 校验 Token 完整性后把身份信息注入到应用的Context 中，BFF 到其他下层的微服务，建议是直接在 RPC Request 中带入用户身份信息(UserID)请求服务。</p>
<ul>
<li>API Gateway -&gt; BFF -&gt; Service</li>
<li>Biz Auth -&gt; JWT -&gt; Request Args</li>
</ul>
<p>对于服务内部，一般要区分身份认证和授权（先做认证再做授权再通过RBAC控制）。</p>
<ul>
<li>Full Trust：认证且加密</li>
<li>Half Trust：认证但不加密</li>
<li>Zero Trust：不认证不加密</li>
</ul>
<h3 id="1-3-gRPC-amp-服务发现"><a href="#1-3-gRPC-amp-服务发现" class="headerlink" title="1.3 gRPC &amp; 服务发现"></a>1.3 gRPC &amp; 服务发现</h3><h4 id="1-3-1-gRPC"><a href="#1-3-1-gRPC" class="headerlink" title="1.3.1 gRPC"></a>1.3.1 gRPC</h4><ul>
<li>多语言：语言中立，支持多种语言。</li>
<li>轻量级、高性能：序列化支持PB(Protocol Buffer)和JSON，PB 是一种语言无关的高性能序列化框架。</li>
<li>可插拔</li>
<li>IDL：基于文件定义服务，通过proto3 工具生成指定语言的数据结构、服务端接口以及客户端Stub。</li>
<li>设计理念</li>
<li>移动端：基于标准的HTTP2 设计，支持双向流、消息头压缩、单TCP 的多路复用、服务端推送等特性，这些特性使得gRPC 在移动端设备上更加省电和节省网络流量。</li>
<li>服务而非对象、消息而非引用：促进微服务的系统间粗粒度消息交互设计理念。</li>
<li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如protocol buffers、JSON、XML 和Thrift。</li>
<li>流：Streaming API。</li>
<li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li>
<li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li>
<li>标准化状态码：客户端通常以有限的方式响应API 调用返回的错误。</li>
</ul>
<p>不要过早关注性能问题，先标准化。</p>
<h4 id="1-3-2-gRPC-HealthCheck"><a href="#1-3-2-gRPC-HealthCheck" class="headerlink" title="1.3.2 gRPC - HealthCheck"></a>1.3.2 gRPC - HealthCheck</h4><p><img src="/images/《Go进阶训练营》学习笔记/gRPCHealthCheck.png" alt="gRPCHealthCheck"></p>
<p>gRPC 有一个标准的健康检测协议，在 gRPC 的所有语言实现中基本都提供了生成代码和用于设置运行状态的功能。</p>
<p>主动健康检查 health check，可以在服务提供者服务不稳定时，被消费者所感知，临时从负载均衡中摘除，减少错误请求。当服务提供者重新稳定后，health check成功，重新加入到消费者的负载均衡，恢复请求。<br>health check，同样也被用于外挂方式的容器健康检测，或者流量检测(k8s liveness &amp; readiness)。</p>
<p><img src="/images/《Go进阶训练营》学习笔记/k8s平滑发布.png" alt="k8s平滑发布"></p>
<h4 id="1-3-3-服务发现"><a href="#1-3-3-服务发现" class="headerlink" title="1.3.3 服务发现"></a>1.3.3 服务发现</h4><ol>
<li><p>客户端发现模式</p>
<p> 一个服务实例被启动时，它的网络地址会被写到注册表上；当服务实例终止时，再从注册表中删除；这个服务实例的注册表通过心跳机制动态刷新；客户端使用一个负载均衡算法，去选择一个可用的服务实例，来响应这个请求。</p>
</li>
<li><p>服务端发现模式</p>
<p> 客户端通过负载均衡器向一个服务发送请求，这个负载均衡器会查询服务注册表，并将请求路由到可用的服务实例上。服务实例在服务注册表上被注册和注销(Consul Template+Nginx，kubernetes+etcd)。</p>
</li>
<li><p>对比</p>
<p> 客户端发现： 直连，比服务端服务发现少一次网络跳转，Consumer 需要内置特定的服务发现客户端和发现逻辑。<br> 服务端发现：Consumer 无需关注服务发现具体细节，只需知道服务的DNS 域名即可，支持异构语言开发，需要基础设施支撑，多了一次网络跳转，可能有性能损失。</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/服务发现模式对比.png" alt="服务发现模式对比"></p>
<p> 微服务的核心是去中心化，我们使用客户端发现模式。</p>
</li>
</ol>
<h4 id="1-3-4-服务发送的使用"><a href="#1-3-4-服务发送的使用" class="headerlink" title="1.3.4 服务发送的使用"></a>1.3.4 服务发送的使用</h4><p><img src="/images/《Go进阶训练营》学习笔记/服务发现应用对比.png" alt="服务发现应用对比"></p>
<p>早期我们使用最熟悉的 Zookeeper 作为服务发现，但是实际场景是海量服务发现和注册，服务状态可以弱一致, 需要的是 AP 系统。</p>
<ul>
<li>分布式协调服务(要求任何时刻对 ZooKeeper 的访问请求能得到一致的数据，从而牺牲可用性)。</li>
<li>网络抖动或网络分区会导致的 master 节点因为其他节点失去联系而重新选举或超过半数不可用导致服务注册发现瘫痪。</li>
<li>大量服务长连接导致性能瓶颈。</li>
</ul>
<p>我们参考了 Eureka 实现了自己的 AP 发现服务。</p>
<blockquote>
<p>现在推荐直接使用 <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">nacos</a> 。</p>
</blockquote>
<p><img src="/images/《Go进阶训练营》学习笔记/Eureka原理.png" alt="Eureka原理"></p>
<p>更多的细节：</p>
<ul>
<li>通过Family(appid) 和Addr(IP:Port) 定位实例，除此之外还可以附加更多的元数据：权重、染色标签、集群等。<blockquote>
<p>appid: 使用三段式命名，business.service.xxx</p>
</blockquote>
</li>
<li>Provider 注册后定期(30s)心跳一次，注册，心跳，下线都需要进行同步，注册和下线需要进行长轮询推送。<blockquote>
<p>新启动节点，需要load cache，JVM 预热。</p>
<p>故障时，Provider 不建议重启和发布。</p>
</blockquote>
</li>
<li>Consumer 启动时拉取实例，发起30s长轮询。<blockquote>
<p>故障时，需要client 侧cache 节点信息。</p>
</blockquote>
</li>
<li>Server 定期(60s) 检测失效(90s)的实例，失效则剔除。短时间里丢失了大量的心跳连接(15分钟内心跳低于期望值*85%)，开启自我保护，保留过期服务不删除。</li>
</ul>
<p>试想两个场景，牺牲一致性，最终一致性的情况：</p>
<ul>
<li>注册的事件延迟</li>
<li>注销的事件延迟：有点到点 RPC 的 health check 能让节点及时的下线。</li>
</ul>
<h3 id="1-4-多集群-amp-多租户"><a href="#1-4-多集群-amp-多租户" class="headerlink" title="1.4 多集群 &amp; 多租户"></a>1.4 多集群 &amp; 多租户</h3><h4 id="1-4-1-多集群"><a href="#1-4-1-多集群" class="headerlink" title="1.4.1 多集群"></a>1.4.1 多集群</h4><p><strong>这里指定的是单个机房内的多集群。</strong></p>
<p>Level 0（最重要的服务等级）服务，类似像我们账号，之前是一套大集群，一旦故障影响返回巨大，所以我们从几个角度考虑多集群的必要性：</p>
<ul>
<li>从单一集群考虑，多个节点保证可用性，我们通常使用N+2 的方式来冗余节点。</li>
<li>从单一集群故障带来的影响面角度考虑冗余多套集群。</li>
<li>单个机房内的机房故障导致的问题。</li>
</ul>
<p><img src="/images/《Go进阶训练营》学习笔记/多集群.png" alt="多集群"></p>
<p>我们利用 paas 平台，给某个 appid 服务建立多套集群(物理上相当于两套资源，逻辑上维护 cluster 的概念)，对于不同集群服务启动后，从环境变量里可以获取当下服务的 cluster，在服务发现注册的时候，带入这些元信息。当然，不同集群可以隔离使用不同的缓存资源等。</p>
<blockquote>
<p>实际使用时，是为不同的业务单独搭一套。比如：为直播的业务搭一套账号，为游戏的业务搭一套账号。</p>
</blockquote>
<ul>
<li>多套冗余的集群对应多套独占的缓存，带来更好的性能和冗余能力。</li>
<li>尽量避免业务隔离使用或者sharding 带来的 cache hit 影响（按照业务划分集群资源）。</li>
</ul>
<p>业务隔离集群带来的问题是 cache hit ratio 下降，不同业务形态数据正交（会导致连其他业务对应的账号服务时有巨量的缓存穿透），我们退而求其次整个集群全部连接（让所有客户端连接所有(m x n)业务的账号服务，这样就能让所有账号服务对应的缓存热起来）。</p>
<h4 id="1-4-2-多集群的高资源占用处理"><a href="#1-4-2-多集群的高资源占用处理" class="headerlink" title="1.4.2 多集群的高资源占用处理"></a>1.4.2 多集群的高资源占用处理</h4><p>让所有客户端都连接所有的账号服，导致即使空闲时，gRPC 因处理 HealthCheck 的 CPU 也高达 30% 。</p>
<blockquote>
<p>下面的解决思路来自 <a target="_blank" rel="noopener" href="https://book.douban.com/subject/26675256/">Google SRE</a> 。</p>
</blockquote>
<p>统一为一套逻辑集群（物理上多套资源池），即 gRPC 客户端默认忽略服务发现中的 cluster 信息，按照全部节点，全部连接。能不能找到一种算法从全集群中选取一批节点(子集)，利用划分子集限制连接池大小。</p>
<ul>
<li>长连接导致的内存和CPU 开销，HealthCheck 可以高达30%。</li>
<li>短连接极大的资源成本和延迟。</li>
</ul>
<p><img src="/images/《Go进阶训练营》学习笔记/多集群子集算法.png" alt="多集群子集算法"></p>
<p>合适的子集大小和选择算法：</p>
<ul>
<li>通常20-100个后端，部分场景需要大子集，比如大批量读写操作。</li>
<li>后端平均分给客户端。</li>
<li>客户端重启，保持重新均衡，同时对后端重启保持透明，同时连接的变动最小。</li>
</ul>
<h4 id="1-4-3-多租户"><a href="#1-4-3-多租户" class="headerlink" title="1.4.3 多租户"></a>1.4.3 多租户</h4><p>在一个微服务架构中允许多系统共存是利用微服务稳定性以及模块化最有效的方式之一，这种方式一般被称为多租户(multi-tenancy)。租户可以是测试，金丝雀发布，影子系统(shadow systems)，甚至服务层或者产品线，使用租户能够保证代码的隔离性并且能够基于流量租户做路由决策。</p>
<p>对于传输中的数据(data-in-flight)（例如，消息队列中的请求或者消息）以及静态数据(data-at-rest)（例如，存储或者持久化缓存），租户都能够保证隔离性和公平性，以及基于租户的路由机会。</p>
<p><img src="/images/《Go进阶训练营》学习笔记/多租户.png" alt="多租户"></p>
<p>如果我们对服务 B 做出改变，我们需要确保它仍然能够和服务 A、C、D 正常交互。在微服务架构中，我们需要做这些集成测试场景，也就是测试和该系统中其他服务的交互。通常来说，微服务架构有两种基本的集成测试方式：并行测试和生产环境测试。</p>
<ol>
<li><p>并行测试</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/并行测试.png" alt="并行测试"></p>
<p> 并行测试需要一个和生产环境一样的过渡(staging)环境，并且只是用来处理测试流量。在并行测试中，工程师团队首先完成生产服务的一次变动，然后将变动的代码部署到测试栈。这种方法可以在不影响生产环境的情况下让开发者稳定的测试服务，同时能够在发布前更容易的识别和控制bug。尽管并行测试是一种非常有效的集成测试方法，但是它也带来了一些可能影响微服务架构成功的挑战：</p>
<ul>
<li>混用环境导致的不可靠测试。</li>
<li>多套环境带来的硬件成本。</li>
<li>难以做负载测试，仿真线上真实流量情况。</li>
</ul>
</li>
<li><p>灰度测试</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/灰度测试.png" alt="灰度测试"></p>
<p> 使用这种方法(内部叫染色发布)，我们可以把待测试的服务 B 在一个隔离的沙盒环境中启动，并且在沙盒环境下可以访问集成环境(UAT) C 和 D。我们把测试流量路由到服务B，同时保持生产流量正常流入到集成服务。服务 B 仅仅处理测试流量而不处理生产流量。另外要确保集成流量不要被测试流量影响。生产中的测试提出了两个基本要求，它们也构成了多租户体系结构的基础：</p>
<ul>
<li>流量路由：能够基于流入栈中的流量类型做路由。</li>
<li><p>隔离性：能够可靠的隔离测试和生产中的资源，这样可以保证对于关键业务微服务没有副作用。</p>
<p>灰度测试成本代价很大，影响 1/N 的用户。其中 N 为节点数量。</p>
</li>
</ul>
</li>
<li><p>多租户</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/多租户测试.png" alt="多租户测试"></p>
<p> 给入站请求绑定上下文(如: http header)， in-process 使用 context 传递，跨服务使用metadata 传递(如: opentracing baggage item)，在这个架构中每一个基础组件都能够理解租户信息，并且能够基于租户路由隔离流量，同时在我们的平台中允许对运行不同的微服务有更多的控制，比如指标和日志。在微服务架构中典型的基础组件是日志，指标，存储，消息队列，缓存以及配置。基于租户信息隔离数据需要分别处理基础组件。</p>
<p> 多租户架构本质上描述为：跨服务传递请求携带上下文(context)，数据隔离的流量路由方案。</p>
<p> 利用服务发现注册租户信息，注册成特定的租户。</p>
</li>
</ol>
<h2 id="第2周-error"><a href="#第2周-error" class="headerlink" title="第2周 error"></a>第2周 error</h2><h3 id="2-1-Error-vs-Exception"><a href="#2-1-Error-vs-Exception" class="headerlink" title="2.1 Error vs Exception"></a>2.1 Error vs Exception</h3><h4 id="2-1-1-Go-中的-error"><a href="#2-1-1-Go-中的-error" class="headerlink" title="2.1.1 Go 中的 error"></a>2.1.1 Go 中的 error</h4><p>Go error 就是普通的一个接口，普通的值。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// The error built-in interface type is the conventional interface for</span>
<span class="token comment">// representing an error condition, with the nil value representing no error.</span>
<span class="token keyword">type</span> <span class="token builtin">error</span> <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经常使用 errors.New() 来返回一个 error 对象。<br>errors.New() 返回的是内部 errorString 对象的指针。</p>
<blockquote>
<p>返回指针是为了保证即使值相同的但是错误依然要不同（见代码中的注释）。</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// New returns an error that formats as the given text.</span>
<span class="token comment">// Each call to New returns a distinct error value even if the text is identical.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>text <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>errorString<span class="token punctuation">{</span>text<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-1-2-其他语言中的错误处理"><a href="#2-1-2-其他语言中的错误处理" class="headerlink" title="2.1.2 其他语言中的错误处理"></a>2.1.2 其他语言中的错误处理</h4><p>各个语言的演进历史：</p>
<ol>
<li><p>C</p>
<p> 单返回值，一般通过传递指针作为入参，返回值为 int 表示成功还是失败。</p>
</li>
<li><p>C++</p>
<p> 引入了 exception，但是无法知道被调用方会抛出什么异常。</p>
</li>
<li><p>Java</p>
<p> 引入了 checked exception，方法的所有者必须申明，调用者必须处理。在启动时抛出大量的异常是司空见惯的事情，并在它们的调用堆栈中尽职地记录下来。Java 异常不再是异常，而是变得司空见惯了。它们从良性到灾难性都有使用，异常的严重性由函数的调用者来区分。</p>
</li>
<li><p>Go</p>
<p> Go 的处理异常逻辑是不引入 exception，支持多参数返回，所以你很容易的在函数签名中带上实现了 error interface 的对象，交由调用者来判定。</p>
<blockquote>
<p>如果一个函数返回了 value, error，你不能对这个 value 做任何假设，必须先判定 error。唯一可以忽略 error 的是，如果你连 value 也不关心。</p>
</blockquote>
<p> Go 中有 panic 的机制，如果你认为和其他语言的 exception 一样，那你就错了。当我们抛出异常的时候，相当于你把 exception 扔给了调用者来处理。</p>
<blockquote>
<p>比如，你在 C++ 中，把 string 转为 int，如果转换失败，会抛出异常。或者在 java 中转换 string 为 date 失败时，会抛出异常。</p>
<p>Go panic 意味着 fatal error(就是挂了)。不能假设调用者来解决 panic，意味着代码不能继续运行。</p>
</blockquote>
<p> 使用多个返回值和一个简单的约定，Go 解决了让程序员知道什么时候出了问题，并为真正的异常情况保留了 panic。</p>
</li>
</ol>
<p>对于真正意外的情况，那些表示不可恢复的程序错误，例如索引越界、不可恢复的环境问题、栈溢出，我们才使用 panic。对于其他的错误情况，我们应该是期望使用 error 来进行判定。</p>
<blockquote>
<p>you only need to check the error value if you care about the result.  — Dave</p>
<p>This <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/oldnewthing/?p=36693">blog post</a> from Microsoft’s engineering blog in 2005 still holds true today, namely:</p>
<blockquote>
<p>My point isn’t that exceptions are bad. My point is that exceptions are too hard and I’m not smart enough to handle them.</p>
</blockquote>
</blockquote>
<p>Go 的错误设计：</p>
<ul>
<li>简单。</li>
<li>考虑失败，而不是成功(Plan for failure, not success)。</li>
<li>没有隐藏的控制流。</li>
<li>完全交给你来控制 error。</li>
<li>Error are values。</li>
</ul>
<h3 id="2-2-Error-Type"><a href="#2-2-Error-Type" class="headerlink" title="2.2 Error Type"></a>2.2 Error Type</h3><h4 id="2-2-1-Sentinel-Error"><a href="#2-2-1-Sentinel-Error" class="headerlink" title="2.2.1 Sentinel Error"></a>2.2.1 Sentinel Error</h4><p>预定义的特定错误，我们叫为 <code>sentinel error</code>，这个名字来源于计算机编程中使用一个特定值来表示不可能进行进一步处理的做法。所以对于 Go，我们使用特定的值来表示错误。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">==</span> ErrSomething <span class="token punctuation">{</span> … <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>类似的 <code>io.EOF</code>，更底层的 <code>syscall.ENOENT</code>。</p>
<blockquote>
<p>使用 sentinel 值是最不灵活的错误处理策略，因为调用方必须使用 == 将结果与预先声明的值进行比较。当您想要提供更多的上下文时，这就出现了一个问题，因为返回一个不同的错误将破坏相等性检查。</p>
<p>甚至是一些有意义的 fmt.Errorf 携带一些上下文，也会破坏调用者的 == ，调用者将被迫查看 error.Error() 方法的输出，以查看它是否与特定的字符串匹配。</p>
</blockquote>
<ol>
<li><p>不依赖检查 error.Error 的输出。</p>
<p> 不应该依赖检测 error.Error 的输出，Error 方法存在于 error 接口主要用于方便程序员使用，但不是程序(编写测试可能会依赖这个返回)。这个输出的字符串用于记录日志、输出到 stdout 等。</p>
</li>
<li><p>Sentinel errors 成为你 API 公共部分。</p>
<p> 如果您的公共函数或方法返回一个特定值的错误，那么该值必须是公共的，当然要有文档记录，这会增加 API 的表面积。</p>
<p> 如果 API 定义了一个返回特定错误的 interface，则该接口的所有实现都将被限制为仅返回该错误，即使它们可以提供更具描述性的错误。</p>
<p> 比如 io.Reader。像 io.Copy 这类函数需要 reader 的实现者比如返回 io.EOF 来告诉调用者没有更多数据了，但这又不是错误。</p>
</li>
<li><p>Sentinel errors 在两个包之间创建了依赖。</p>
<p> sentinel errors 最糟糕的问题是它们在两个包之间创建了源代码依赖关系。例如，检查错误是否等于 io.EOF，您的代码必须导入 io 包。这个特定的例子听起来并不那么糟糕，因为它非常常见，但是想象一下，当项目中的许多包导出错误值时，存在耦合，项目中的其他包必须导入这些错误值才能检查特定的错误条件(in the form of an import loop)。</p>
</li>
<li><p>结论: 尽可能避免 sentinel errors。</p>
<p> 我的建议是避免在编写的代码中使用 sentinel errors。在标准库中有一些使用它们的情况，但这不是一个您应该模仿的模式。</p>
</li>
</ol>
<h4 id="2-2-2-Error-types"><a href="#2-2-2-Error-types" class="headerlink" title="2.2.2 Error types"></a>2.2.2 Error types</h4><p>Error type 是实现了 error 接口的自定义类型。例如 MyError 类型记录了文件和行号以展示发生了什么。因为 MyError 是一个 type，调用者可以使用断言转换成这个类型，来获取更多的上下文信息。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> MyError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Msg  <span class="token builtin">string</span>
    File <span class="token builtin">string</span>
    Line <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>MyError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%d: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>File<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MyError<span class="token punctuation">{</span><span class="token string">"kibazen.cn"</span><span class="token punctuation">,</span> <span class="token string">"server.go"</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">:=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span> err <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
        <span class="token comment">// call succeeded, nothing to do</span>
    <span class="token keyword">case</span> <span class="token operator">*</span>MyError<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error occurred on line: "</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>Line<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// unknown error</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与错误值相比，错误类型的一大改进是它们能够包装底层错误以提供更多上下文。<br>一个不错的例子就是 os.PathError 他提供了底层执行了什么操作、那个路径出了什么问题。</p>
<p><img src="/images/《Go进阶训练营》学习笔记/os.PathError.png" alt="os.PathError"></p>
<p>调用者要使用类型断言和类型 <code>switch</code> ，就要让自定义的 <code>error</code> 变为 public。这种模型会导致和调用者产生强耦合，从而导致 API 变得脆弱。</p>
<p>结论是尽量避免使用 error types，虽然错误类型比 sentinel errors 更好，因为它们可以捕获关于出错的更多上下文，但是 error types 共享 error values 许多相同的问题。</p>
<p>因此，我的建议是避免错误类型，或者至少避免将它们作为公共 API 的一部分。</p>
<h4 id="2-2-3-Opaque-errors"><a href="#2-2-3-Opaque-errors" class="headerlink" title="2.2.3 Opaque errors"></a>2.2.3 Opaque errors</h4><p>在我看来，这是最灵活的错误处理策略，因为它要求代码和调用者之间的耦合最少。</p>
<p>我将这种风格称为不透明错误处理，因为虽然您知道发生了错误，但您没有能力看到错误的内部。作为调用者，关于操作的结果，您所知道的就是它起作用了，或者没有起作用(成功还是失败)。</p>
<p>这就是不透明错误处理的全部功能–只需返回错误而不假设其内容。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">,</span> err <span class="token operator">:=</span> bar<span class="token punctuation">.</span><span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment">// use x</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Assert errors for behaviour, not type.</strong></p>
<p>在少数情况下，这种二分错误处理方法是不够的。例如，与进程外的世界进行交互(如网络活动)，需要调用方调查错误的性质，以确定重试该操作是否合理。在这种情况下，我们可以断言错误实现了特定的行为，而不是断言错误是特定的类型或值。考虑这个例子：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> net

<span class="token comment">// An Error represents a network error.</span>
<span class="token keyword">type</span> Error <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token builtin">error</span>
    <span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>   <span class="token comment">// Is the error a timeout?</span>
    <span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// Is the error temporary?</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> temporary <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment">// IsTemporary returns true if err is temporary.</span>
<span class="token keyword">func</span> <span class="token function">IsTemporary</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    te<span class="token punctuation">,</span> ok <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">Cause</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>temporary<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ok <span class="token operator">&amp;&amp;</span> te<span class="token punctuation">.</span><span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的关键是，这个逻辑可以在不导入定义错误的包或者实际上不了解 err 的底层类型的情况下实现——我们只对它的行为感兴趣。</p>
<h3 id="2-3-Handling-Error"><a href="#2-3-Handling-Error" class="headerlink" title="2.3 Handling Error"></a>2.3 Handling Error</h3><h4 id="2-3-1-Indented-flow-is-for-errors"><a href="#2-3-1-Indented-flow-is-for-errors" class="headerlink" title="2.3.1 Indented flow is for errors"></a>2.3.1 Indented flow is for errors</h4><p>无错误的正常流程代码，将成为一条直线，而不是缩进的代码。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle error</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// do stuff</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-3-2-Eliminate-error-handling-by-eliminating-errors"><a href="#2-3-2-Eliminate-error-handling-by-eliminating-errors" class="headerlink" title="2.3.2 Eliminate error handling by eliminating errors"></a>2.3.2 Eliminate error handling by eliminating errors</h4><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/2019/01/27/eliminate-error-handling-by-eliminating-errors">Eliminate error handling by eliminating errors</a></p>
<h4 id="2-3-3-Wrap-error"><a href="#2-3-3-Wrap-error" class="headerlink" title="2.3.3 Wrap error"></a>2.3.3 Wrap error</h4><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don’t just check errors, handle them gracefully</a></p>
<ol>
<li>在你的应用代码中，使用 errors.New 或者 errros.Errorf 返回错误。</li>
<li>如果调用其他的函数，通常简单的直接返回。</li>
<li>如果和其他库进行协作，考虑使用 errors.Wrap 或者 errors.Wrapf 保存堆栈信息。同样适用于和标准库协作的时候。</li>
<li>直接返回错误，而不是每个错误产生的地方到处打日志。</li>
<li>在程序的顶部或者是工作的 goroutine 顶部(请求入口)，使用 %+v 把堆栈详情记录。</li>
<li>使用 errors.Cause 获取 root error，再进行和 sentinel error 判定。</li>
</ol>
<h4 id="2-3-4-总结"><a href="#2-3-4-总结" class="headerlink" title="2.3.4 总结"></a>2.3.4 总结</h4><ol>
<li><p>Packages that are reusable across many projects only return root error values.</p>
<p> 选择 wrap error 是只有 applications 可以选择应用的策略。具有最高可重用性的包只能返回根错误值。此机制与 Go 标准库中使用的相同(kit 库的 sql.ErrNoRows)。</p>
</li>
<li><p>If the error is not going to be handled, wrap and return up the call stack.</p>
<p> 这是关于函数/方法调用返回的每个错误的基本问题。如果函数/方法不打算处理错误，那么用足够的上下文 wrap errors 并将其返回到调用堆栈中。例如，额外的上下文可以是使用的输入参数或失败的查询语句。确定您记录的上下文是足够多还是太多的一个好方法是检查日志并验证它们在开发期间是否为您工作。</p>
</li>
<li><p>Once an error is handled, it is not allowed to be passed up the call stack any longer.</p>
<p> 一旦确定函数/方法将处理错误，错误就不再是错误。如果函数/方法仍然需要发出返回，则它不能返回错误值。它应该只返回零(比如降级处理中，你返回了降级数据，然后需要 return nil)。</p>
</li>
</ol>
<h3 id="2-4-Go-1-13-errors"><a href="#2-4-Go-1-13-errors" class="headerlink" title="2.4 Go 1.13 errors"></a>2.4 Go 1.13 errors</h3><p><a target="_blank" rel="noopener" href="https://go.dev/blog/go1.13-errors">Working with Errors in Go 1.13</a></p>
<h4 id="2-4-1-Unwrap"><a href="#2-4-1-Unwrap" class="headerlink" title="2.4.1 Unwrap"></a>2.4.1 Unwrap</h4><p>go1.13为 errors 和 fmt 标准库包引入了新特性，以简化处理包含其他错误的错误。其中最重要的是: 包含另一个错误的 error 可以实现返回底层错误的 Unwrap 方法。如果 e1.Unwrap() 返回 e2，那么我们说 e1 包装 e2，您可以展开 e1 以获得 e2。</p>
<p>go1.13 errors 包包含两个用于检查错误的新函数：Is 和 As。</p>
<h4 id="2-4-2-Wrapping-errors-with-w"><a href="#2-4-2-Wrapping-errors-with-w" class="headerlink" title="2.4.2 Wrapping errors with %w"></a>2.4.2 Wrapping errors with %w</h4><p>使用 fmt.Errorf 向错误添加附加信息。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"decompress %v: %v"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在 Go 1.13中 fmt.Errorf 支持新的 %w 谓词。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// Return an error which unwraps to err.</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"decompress %v: %w"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>用 %w 包装错误可用于 errors.Is 以及 errors.As。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"access denied: %w"</span><span class="token punctuation">,</span> ErrPermission<span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrPermission<span class="token punctuation">)</span> <span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2-5-Go-2-Error-Inspection"><a href="#2-5-Go-2-Error-Inspection" class="headerlink" title="2.5 Go 2 Error Inspection"></a>2.5 Go 2 Error Inspection</h3><p><a target="_blank" rel="noopener" href="https://go.googlesource.com/proposal/+/master/design/29934-error-values.md">Proposal: Go 2 Error Inspection</a></p>
<h3 id="2-6-References"><a href="#2-6-References" class="headerlink" title="2.6 References"></a>2.6 References</h3><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/2012/01/18/why-go-gets-exceptions-right">https://dave.cheney.net/2012/01/18/why-go-gets-exceptions-right</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2015/01/26/errors-and-exceptions-redux">https://dave.cheney.net/2015/01/26/errors-and-exceptions-redux</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/11/04/error-handling-vs-exceptions-redux">https://dave.cheney.net/2014/11/04/error-handling-vs-exceptions-redux</a><br><a target="_blank" rel="noopener" href="https://rauljordan.com/2020/07/06/why-go-error-handling-is-awesome.html">https://rauljordan.com/2020/07/06/why-go-error-handling-is-awesome.html</a><br><a target="_blank" rel="noopener" href="https://morsmachine.dk/error-handling">https://morsmachine.dk/error-handling</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/error-handling-and-go">https://blog.golang.org/error-handling-and-go</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/10/error-handling-in-go-part-i.html">https://www.ardanlabs.com/blog/2014/10/error-handling-in-go-part-i.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/11/error-handling-in-go-part-ii.html">https://www.ardanlabs.com/blog/2014/11/error-handling-in-go-part-ii.html</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully</a><br><a target="_blank" rel="noopener" href="https://commandcenter.blogspot.com/2017/12/error-handling-in-upspin.html">https://commandcenter.blogspot.com/2017/12/error-handling-in-upspin.html</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/errors-are-values">https://blog.golang.org/errors-are-values</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/06/12/stack-traces-and-the-errors-package">https://dave.cheney.net/2016/06/12/stack-traces-and-the-errors-package</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2017/05/design-philosophy-on-logging.html">https://www.ardanlabs.com/blog/2017/05/design-philosophy-on-logging.html</a><br><a target="_blank" rel="noopener" href="https://crawshaw.io/blog/xerrors">https://crawshaw.io/blog/xerrors</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/go1.13-errors">https://blog.golang.org/go1.13-errors</a><br><a target="_blank" rel="noopener" href="https://medium.com/gett-engineering/error-handling-in-go-53b8a7112d04">https://medium.com/gett-engineering/error-handling-in-go-53b8a7112d04</a><br><a target="_blank" rel="noopener" href="https://medium.com/gett-engineering/error-handling-in-go-1-13-5ee6d1e0a55c">https://medium.com/gett-engineering/error-handling-in-go-1-13-5ee6d1e0a55c</a></p>
<h2 id="第3周-concurrency"><a href="#第3周-concurrency" class="headerlink" title="第3周 concurrency"></a>第3周 concurrency</h2><h3 id="3-1-Goroutine"><a href="#3-1-Goroutine" class="headerlink" title="3.1 Goroutine"></a>3.1 Goroutine</h3><h4 id="3-1-1-Processes-and-Threads"><a href="#3-1-1-Processes-and-Threads" class="headerlink" title="3.1.1 Processes and Threads"></a>3.1.1 Processes and Threads</h4><p>操作系统会为该应用程序创建一个进程。作为一个应用程序，它像一个为所有资源而运行的容器。这些资源包括内存地址空间、文件句柄、设备和线程。</p>
<p>线程是操作系统调度的一种执行路径，用于在处理器执行我们在函数中编写的代码。一个进程从一个线程开始，即主线程，当该线程终止时，进程终止。这是因为主线程是应用程序的原点。然后，主线程可以依次启动更多的线程，而这些线程可以启动更多的线程。</p>
<p>无论线程属于哪个进程，操作系统都会安排线程在可用处理器上运行。每个操作系统都有自己的算法来做出这些决定。</p>
<h4 id="3-1-2-Goroutines-and-Parallelism"><a href="#3-1-2-Goroutines-and-Parallelism" class="headerlink" title="3.1.2 Goroutines and Parallelism"></a>3.1.2 Goroutines and Parallelism</h4><p>Go 语言层面支持的 go 关键字，可以快速的让一个函数创建为 goroutine，我们可以认为 main 函数就是作为 goroutine 执行的。操作系统调度线程在可用处理器上运行，Go运行时调度 goroutines 在绑定到单个操作系统线程的逻辑处理器中运行(P)。即使使用这个单一的逻辑处理器和操作系统线程，也可以调度数十万 goroutine 以惊人的效率和性能并发运行。</p>
<blockquote>
<p>Concurrency is not Parallelism.</p>
</blockquote>
<p>并发不是并行。并行是指两个或多个线程同时在不同的处理器执行代码。如果将运行时配置为使用多个逻辑处理器，则调度程序将在这些逻辑处理器之间分配 goroutine，这将导致 goroutine 在不同的操作系统线程上运行。但是，要获得真正的并行性，您需要在具有多个物理处理器的计算机上运行程序。否则，goroutines 将针对单个物理处理器并发运行，即使 Go 运行时使用多个逻辑处理器。</p>
<h4 id="3-1-3-Keep-yourself-busy-or-do-the-work-yourself"><a href="#3-1-3-Keep-yourself-busy-or-do-the-work-yourself" class="headerlink" title="3.1.3 Keep yourself busy or do the work yourself"></a>3.1.3 Keep yourself busy or do the work yourself</h4><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_keep_yourself_busy_or_do_the_work_yourself">Keep yourself busy or do the work yourself</a></p>
<p>空的 select 语句将永远阻塞。</p>
<p>如果你的 goroutine 在从另一个 goroutine 获得结果之前无法取得进展，那么通常情况下，你自己去做这项工作比委托它( go func() )更简单。<br>这通常消除了将结果从 goroutine 返回到其启动器所需的大量状态跟踪和 chan 操作。</p>
<h4 id="3-1-4-Leave-concurrency-to-the-caller"><a href="#3-1-4-Leave-concurrency-to-the-caller" class="headerlink" title="3.1.4 Leave concurrency to the caller"></a>3.1.4 Leave concurrency to the caller</h4><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_leave_concurrency_to_the_caller">Leave concurrency to the caller</a></p>
<p>这两个 API 有什么区别？</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ListDirectory returns the contents of dir.</span>
<span class="token keyword">func</span> <span class="token function">ListDirectory</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token comment">// ListDirectory returns a channel over which</span>
<span class="token comment">// directory entries will be published. When the list</span>
<span class="token comment">// of entries is exhausted, the channel will be closed.</span>
<span class="token keyword">func</span> <span class="token function">ListDirectory</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">string</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>将目录读取到一个 slice 中，然后返回整个切片，或者如果出现错误，则返回错误。这是同步调用的，ListDirectory 的调用方会阻塞，直到读取所有目录条目。根据目录的大小，这可能需要很长时间，并且可能会分配大量内存来构建目录条目名称的 slice。</li>
<li>ListDirectory 返回一个 chan string，将通过该 chan 传递目录。当通道关闭时，这表示不再有目录。由于在 ListDirectory 返回后发生通道的填充，ListDirectory 可能内部启动 goroutine 来填充通道。</li>
</ol>
<p>ListDirectory chan 版本还有两个问题：</p>
<ol>
<li>通过使用一个关闭的通道作为不再需要处理的项目的信号，ListDirectory 无法告诉调用者通过通道返回的项目集不完整，因为中途遇到了错误。调用方无法区分空目录与完全从目录读取的错误之间的区别。这两种方法都会导致从 ListDirectory 返回的通道会立即关闭。</li>
<li>调用者必须继续从通道读取，直到它关闭，因为这是调用者知道开始填充通道的 goroutine 已经停止的唯一方法。这对 ListDirectory 的使用是一个严重的限制，调用者必须花时间从通道读取数据，即使它可能已经收到了它想要的答案。对于大中型目录，它可能在内存使用方面更为高校，但这种方法并不比原始的基于 slice 的方法快。</li>
</ol>
<p>正确的方法是使用回调函数。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ListDirectory</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>filepath.WalkDir 也是类似的模型，如果函数启动 goroutine，则必须向调用方提供显式停止该goroutine 的方法。通常，将异步执行函数的决定权交给该函数的调用方通常更容易。</p>
<h4 id="3-1-5-Never-start-a-goroutine-without-knowning-when-it-will-stop"><a href="#3-1-5-Never-start-a-goroutine-without-knowning-when-it-will-stop" class="headerlink" title="3.1.5 Never start a goroutine without knowning when it will stop"></a>3.1.5 Never start a goroutine without knowning when it will stop</h4><p><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_never_start_a_goroutine_without_knowning_when_it_will_stop">Never start a goroutine without knowning when it will stop</a></p>
<p>Any time you start a Goroutine you must ask yourself:</p>
<ul>
<li>When will it terminate?</li>
<li>What could prevent it from terminating?</li>
</ul>
<blockquote>
<p>Only use log.Fatal from main.main or init functions.</p>
</blockquote>
<h4 id="3-1-6-Incomplete-Work"><a href="#3-1-6-Incomplete-Work" class="headerlink" title="3.1.6 Incomplete Work"></a>3.1.6 Incomplete Work</h4><p><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html">Concurrency Trap #2: Incomplete Work</a></p>
<p>使用 sync.WaitGroup 来追踪每一个创建的 goroutine。</p>
<p>将 wg.Wait() 操作托管到其他 goroutine，owner goroutine 使用 context 处理超时。</p>
<p><a target="_blank" rel="noopener" href="https://play.golang.org/p/p4gsDkpw1Gh">https://play.golang.org/p/p4gsDkpw1Gh</a></p>
<h3 id="3-2-Memory-model"><a href="#3-2-Memory-model" class="headerlink" title="3.2 Memory model"></a>3.2 Memory model</h3><h4 id="3-2-1-Memory-model"><a href="#3-2-1-Memory-model" class="headerlink" title="3.2.1 Memory model"></a>3.2.1 Memory model</h4><p>如何保证在一个 goroutine 中看到在另一个 goroutine 修改的变量的值，如果程序中修改数据时有其他 goroutine 同时读取，那么必须将读取串行化。为了串行化访问，请使用 channel 或其他同步原语，例如 sync 和 sync/atomic 来保护数据。</p>
<p><a target="_blank" rel="noopener" href="https://golang.org/ref/mem">https://golang.org/ref/mem</a></p>
<p>先行发生（happens before）：如果事件 e1 发生在 e2 前，我们可以说 e2 发生在 e1 后。如果 e1不发生在 e2 前也不发生在 e2 后，我们就说 e1 和 e2 是并发的。</p>
<p>写入单个 machine word 将是原子的。</p>
<blockquote>
<p>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5e44168f47a3">Go的内存模型</a></p>
<h4 id="3-2-2-Memory-Reordering"><a href="#3-2-2-Memory-Reordering" class="headerlink" title="3.2.2 Memory Reordering"></a>3.2.2 Memory Reordering</h4><p><a target="_blank" rel="noopener" href="https://www.cs.utexas.edu/~bornholt/post/memory-models.html">Memory Consistency Models: A Tutorial</a></p>
<h3 id="3-3-Package-sync"><a href="#3-3-Package-sync" class="headerlink" title="3.3 Package sync"></a>3.3 Package sync</h3><h4 id="3-3-1-Share-Memory-By-Communicating"><a href="#3-3-1-Share-Memory-By-Communicating" class="headerlink" title="3.3.1 Share Memory By Communicating"></a>3.3.1 Share Memory By Communicating</h4><p><a target="_blank" rel="noopener" href="https://go.dev/blog/codelab-share">Share Memory By Communicating</a></p>
<p>传统的线程模型(通常在编写 Java、C++ 和Python 程序时使用)程序员在线程之间通信需要使用共享内存。通常，共享数据结构由锁保护，线程将争用这些锁来访问数据。在某些情况下，通过使用线程安全的数据结构(如Python的Queue)，这会变得更容易。</p>
<p>Go 的并发原语 goroutines 和 channels 为构造并发软件提供了一种优雅而独特的方法。Go 没有显式地使用锁来协调对共享数据的访问，而是鼓励使用 chan 在 goroutine 之间传递对数据的引用。这种方法确保在给定的时间只有一个goroutine 可以访问数据。</p>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
<h4 id="3-3-2-Detecting-Race-Conditions-With-Go"><a href="#3-3-2-Detecting-Race-Conditions-With-Go" class="headerlink" title="3.3.2 Detecting Race Conditions With Go"></a>3.3.2 Detecting Race Conditions With Go</h4><p><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2013/09/detecting-race-conditions-with-go.html">Detecting Race Conditions With Go</a></p>
<p><a target="_blank" rel="noopener" href="https://go.dev/blog/race-detector">Introducing the Go Race Detector</a></p>
<p>data race 是两个或多个 goroutine 访问同一个资源(如变量或数据结构)，并尝试对该资源进行读写而不考虑其他 goroutine。这种类型的代码可以创建您见过的最疯狂和最随机的 bug。通常需要大量的日志记录和运气才能找到这些类型的bug。</p>
<p><a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races">Ice cream makers and data races</a></p>
<p>interface 内部是是两个 machine word 的值。</p>
<blockquote>
<p>Type 指向实现了接口的 struct，Data 指向了实际的值。Data 作为通过 interface 中任何方法调用的接收方传递。</p>
</blockquote>
<p><img src="/images/《Go进阶训练营》学习笔记/interface的结构.png" alt="interface的结构"></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> <span class="token keyword">interface</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Type <span class="token builtin">uintptr</span>     <span class="token comment">// points to the type of the interface implementation</span>
    Data <span class="token builtin">uintptr</span>     <span class="token comment">// holds the data for the interface's receiver</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-3-3-sync-atomic"><a href="#3-3-3-sync-atomic" class="headerlink" title="3.3.3 sync.atomic"></a>3.3.3 sync.atomic</h4><p>Copy-On-Write 思路在微服务降级或者 local cache 场景中经常使用。写时复制指的是，写操作时候复制全量老数据到一个新的对象中，携带上本次新写的数据，之后利用原子替换(atomic.Value)，更新调用者的变量。来完成无锁访问共享数据。</p>
<p><img src="/images/《Go进阶训练营》学习笔记/Copy-On-Write.png" alt="Copy-On-Write"></p>
<h4 id="3-3-4-Mutex"><a href="#3-3-4-Mutex" class="headerlink" title="3.3.4 Mutex"></a>3.3.4 Mutex</h4><p><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-mutex-and-starvation-3f4f4e75ad50">Go: Mutex and Starvation</a></p>
<ol>
<li><p>饥饿问题</p>
 <pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex

    <span class="token comment">// goroutine 1</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
                <span class="token keyword">return</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Microsecond<span class="token punctuation">)</span>
                mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// goroutine 2</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Microsecond<span class="token punctuation">)</span>
        mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    done <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 这个案例基于两个 goroutine:</p>
<ol>
<li>goroutine 1 持有锁很长时间</li>
<li><p>goroutine 2 每100ms 持有一次锁</p>
<p>都是100ms 的周期，但是由于 goroutine 1 不断的请求锁，可预期它会更频繁的持续到锁。我们基于 Go 1.8 循环了10次，下面是锁的请求占用分布:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Lock acquired per goroutine:
g1: 7200216
g2: 10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Mutex 被 g1 获取了700多万次，而 g2 只获取了10次。</p>
</li>
</ol>
</li>
<li><p>分析</p>
<p> 首先，goroutine1 将获得锁并休眠100ms。当goroutine2 试图获取锁时，它将被添加到锁的队列中- FIFO 顺序，goroutine 将进入等待状态：</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/mutex的锁饥饿问题一.png" alt="mutex的锁饥饿问题一"></p>
<p> 然后，当 goroutine1 完成它的工作时，它将释放锁。这次释放将通知队列唤醒 goroutine2。goroutine2 将被标记为可运行的，并且正在等待 Go 调度程序在线程上运行：</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/mutex的锁饥饿问题二.png" alt="mutex的锁饥饿问题二"></p>
<p> 然而，当 goroutine2 等待运行时，goroutine1将再次请求锁：</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/mutex的锁饥饿问题三.png" alt="mutex的锁饥饿问题三"></p>
<p> goroutine2 尝试去获取锁，结果悲剧的发现锁又被人持有了，它自己继续进入到等待模式：</p>
<p> <img src="/images/《Go进阶训练营》学习笔记/mutex的锁饥饿问题四.png" alt="mutex的锁饥饿问题四"></p>
<p> goroutine 2对锁的获取将取决于它在线程上运行获取锁所需的时间。</p>
<blockquote>
<p>The acquisition of the lock by goroutine 2 will depend on the time it takes for it to run on a thread.</p>
</blockquote>
</li>
<li><p>解法方法</p>
<ul>
<li><p>Barging</p>
<p>  这种模式是为了提高吞吐量，当锁被释放时，它会唤醒第一个等待者，然后把锁给第一个等待者或者给第一个请求锁的人。</p>
</li>
<li><p>Handsoff</p>
<p>  当锁释放时候，锁会一直持有直到第一个等待者准备好获取锁。它降低了吞吐量，因为锁被持有，即使另一个 goroutine 准备获取它。</p>
<blockquote>
<p>一个互斥锁的 handsoff 会完美地平衡两个goroutine 之间的锁分配，但是会降低性能，因为它会迫使第一个 goroutine 等待锁。</p>
</blockquote>
</li>
<li><p>Spinning</p>
<p>  自旋在等待队列为空或者应用程序重度使用锁时效果不错。Parking 和 Unparking goroutines 有不低的性能成本开销，相比自旋来说要慢得多。</p>
</li>
</ul>
</li>
<li><p>饥饿模式</p>
<p> Go 1.8 使用了 Barging 和 Spining 的结合实现。当试图获取已经被持有的锁时，如果本地队列为空并且 P 的数量大于1，goroutine 将自旋几次(用一个 P 旋转会阻塞程序)。自旋后，goroutine park。在程序高频使用锁的情况下，它充当了一个快速路径。</p>
<p> Go 1.9 通过添加一个新的饥饿模式来解决先前解释的问题，该模式将会在释放时候触发 handsoff。所有等待锁超过一毫秒的 goroutine(也称为有界等待)将被诊断为饥饿。当被标记为饥饿状态时，unlock 方法会 handsoff 把锁直接扔给第一个等待者。</p>
<p> 在饥饿模式下，自旋也被停用，因为传入的goroutines 将没有机会获取为下一个等待者保留的锁。</p>
<p> 使用 Go 1.9 运行上面的代码会得到一个更公平的结果：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">Lock acquired per goroutine:
g1: 57
g2: 10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="3-3-5-errgroup"><a href="#3-3-5-errgroup" class="headerlink" title="3.3.5 errgroup"></a>3.3.5 errgroup</h4></li>
</ol>
<p>我们把一个复杂的任务，尤其是依赖多个微服务 rpc 需要聚合数据的任务，分解为依赖和并行，依赖的意思为: 需要上游 a 的数据才能访问下游 b 的数据进行组合。但是并行的意思为: 分解为多个小任务并行执行，最终等全部执行完毕。</p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/golang.org/x/sync/errgroup">https://pkg.go.dev/golang.org/x/sync/errgroup</a></p>
<p>核心原理: 利用 sync.Waitgroup 管理并行执行的 goroutine 。</p>
<ul>
<li>并行工作流</li>
<li>错误处理 或者 优雅降级</li>
<li>context 传播和取消</li>
<li>利用局部变量+闭包</li>
</ul>
<h4 id="3-3-6-sync-Pool"><a href="#3-3-6-sync-Pool" class="headerlink" title="3.3.6 sync.Pool"></a>3.3.6 sync.Pool</h4><p>sync.Pool 的场景是用来保存和复用临时对象，以减少内存分配，降低 GC 压力(Request-Driven 特别合适)。</p>
<p>Get 返回 Pool 中的任意一个对象。如果 Pool 为空，则调用 New 返回一个新创建的对象。</p>
<p>放进 Pool 中的对象，会在说不准什么时候被回收掉。所以如果事先 Put 进去 100 个对象，下次 Get 的时候发现 Pool 是空也是有可能的。不过这个特性的一个好处就在于不用担心 Pool 会一直增长，因为 Go 已经帮你在 Pool 中做了回收机制。</p>
<p>这个清理过程是在每次垃圾回收之前做的。之前每次GC 时都会清空 pool，而在1.13版本中引入了 victim cache，会将 pool 内数据拷贝一份，避免 GC 将其清空，即使没有引用的内容也可以保留最多两轮 GC。</p>
<h3 id="3-4-chan"><a href="#3-4-chan" class="headerlink" title="3.4 chan"></a>3.4 chan</h3><h3 id="3-5-Package-context"><a href="#3-5-Package-context" class="headerlink" title="3.5 Package context"></a>3.5 Package context</h3><h3 id="3-6-References"><a href="#3-6-References" class="headerlink" title="3.6 References"></a>3.6 References</h3><p><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2018/11/goroutine-leaks-the-forgotten-sender.html">https://www.ardanlabs.com/blog/2018/11/goroutine-leaks-the-forgotten-sender.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html">https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/01/concurrency-goroutines-and-gomaxprocs.html">https://www.ardanlabs.com/blog/2014/01/concurrency-goroutines-and-gomaxprocs.html</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html#_concurrency">https://dave.cheney.net/practical-go/presentations/qcon-china.html#_concurrency</a><br><a target="_blank" rel="noopener" href="https://golang.org/ref/mem">https://golang.org/ref/mem</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/caoshangpa/article/details/78853919">https://blog.csdn.net/caoshangpa/article/details/78853919</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qcrao/article/details/92759907">https://blog.csdn.net/qcrao/article/details/92759907</a><br><a target="_blank" rel="noopener" href="https://cch123.github.io/ooo/">https://cch123.github.io/ooo/</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/codelab-share">https://blog.golang.org/codelab-share</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package">https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package</a><br><a target="_blank" rel="noopener" href="http://blog.golang.org/race-detector">http://blog.golang.org/race-detector</a><br><a target="_blank" rel="noopener" href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races">https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html">https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-how-to-reduce-lock-contention-with-the-atomic-package-ba3b2664b549">https://medium.com/a-journey-with-go/go-how-to-reduce-lock-contention-with-the-atomic-package-ba3b2664b549</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-discovery-of-the-trace-package-e5a821743c3c">https://medium.com/a-journey-with-go/go-discovery-of-the-trace-package-e5a821743c3c</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-mutex-and-starvation-3f4f4e75ad50">https://medium.com/a-journey-with-go/go-mutex-and-starvation-3f4f4e75ad50</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html">https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-buffered-and-unbuffered-channels-29a107c00268">https://medium.com/a-journey-with-go/go-buffered-and-unbuffered-channels-29a107c00268</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-ordering-in-select-statements-fd0ff80fd8d6">https://medium.com/a-journey-with-go/go-ordering-in-select-statements-fd0ff80fd8d6</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html">https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/02/the-nature-of-channels-in-go.html">https://www.ardanlabs.com/blog/2014/02/the-nature-of-channels-in-go.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2013/10/my-channel-select-bug.html">https://www.ardanlabs.com/blog/2013/10/my-channel-select-bug.html</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/io2013-talk-concurrency">https://blog.golang.org/io2013-talk-concurrency</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/waza-talk">https://blog.golang.org/waza-talk</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/io2012-videos">https://blog.golang.org/io2012-videos</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/concurrency-timeouts">https://blog.golang.org/concurrency-timeouts</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/pipelines">https://blog.golang.org/pipelines</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2014/02/running-queries-concurrently-against.html">https://www.ardanlabs.com/blog/2014/02/running-queries-concurrently-against.html</a><br><a target="_blank" rel="noopener" href="https://blogtitle.github.io/go-advanced-concurrency-patterns-part-3-channels/">https://blogtitle.github.io/go-advanced-concurrency-patterns-part-3-channels/</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2013/05/thread-pooling-in-go-programming.html">https://www.ardanlabs.com/blog/2013/05/thread-pooling-in-go-programming.html</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2013/09/pool-go-routines-to-process-task.html">https://www.ardanlabs.com/blog/2013/09/pool-go-routines-to-process-task.html</a><br><a target="_blank" rel="noopener" href="https://blogtitle.github.io/categories/concurrency/">https://blogtitle.github.io/categories/concurrency/</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-context-and-cancellation-by-propagation-7a808bbc889c">https://medium.com/a-journey-with-go/go-context-and-cancellation-by-propagation-7a808bbc889c</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/context">https://blog.golang.org/context</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2019/09/context-package-semantics-in-go.html">https://www.ardanlabs.com/blog/2019/09/context-package-semantics-in-go.html</a><br><a target="_blank" rel="noopener" href="https://golang.org/ref/spec#Channel_types">https://golang.org/ref/spec#Channel_types</a><br><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view">https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view</a><br><a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-context-and-cancellation-by-propagation-7a808bbc889c">https://medium.com/a-journey-with-go/go-context-and-cancellation-by-propagation-7a808bbc889c</a><br><a target="_blank" rel="noopener" href="https://blog.golang.org/context">https://blog.golang.org/context</a><br><a target="_blank" rel="noopener" href="https://www.ardanlabs.com/blog/2019/09/context-package-semantics-in-go.html">https://www.ardanlabs.com/blog/2019/09/context-package-semantics-in-go.html</a><br><a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html#concurrency">https://golang.org/doc/effective_go.html#concurrency</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/34417106?hmsr=toutiao.io">https://zhuanlan.zhihu.com/p/34417106?hmsr=toutiao.io</a><br><a target="_blank" rel="noopener" href="https://talks.golang.org/2014/gotham-context.slide#1">https://talks.golang.org/2014/gotham-context.slide#1</a><br><a href="mailto:https://medium.com/@cep21/how-to-correctly-use-context-context-in-go-1-7-8f2c0fafdf39">https://medium.com/@cep21/how-to-correctly-use-context-context-in-go-1-7-8f2c0fafdf39</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/go-jin-jie-xun-lian-ying-xue-xi-bi-ji/">https://kibazen.cn/go-jin-jie-xun-lian-ying-xue-xi-bi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                    <span class="chip bg-color">极客时间</span>
                                </a>
                            
                                <a href="/tags/golang/">
                                    <span class="chip bg-color">golang</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/go-jin-jie-xun-lian-ying-xue-xi-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/7.jpg" class="responsive-img" alt="《Go进阶训练营》学习笔记">
                        
                        <span class="card-title">《Go进阶训练营》学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-10-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                        <span class="chip bg-color">极客时间</span>
                    </a>
                    
                    <a href="/tags/golang/">
                        <span class="chip bg-color">golang</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/shu-ju-ku-he-huan-cun-bei-wang/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/5.jpg" class="responsive-img" alt="数据库和缓存备忘">
                        
                        <span class="card-title">数据库和缓存备忘</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-10-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/" class="post-category">
                                    后端架构
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="chip bg-color">数据库</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%93%E5%AD%98/">
                        <span class="chip bg-color">缓存</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (true) {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 木叶禅<br />'
            + '文章作者: Kiba Amor<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者木叶禅所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">199.3k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>









    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=562236616" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 562236616" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/kibaamor" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kibaamor" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
