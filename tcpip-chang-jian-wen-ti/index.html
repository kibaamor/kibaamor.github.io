<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="TCPIP常见问题, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="一个普通游戏程序员的博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>TCPIP常见问题 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/leetcode/" class="waves-effect waves-light">
      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>LeetCode</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>学习</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tool/" class="waves-effect waves-light">
      
      <i class="fas fa-toolbox" style="zoom: 0.6;"></i>
      
      <span>工具</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            一个普通游戏程序员的博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/leetcode/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-code"></i>
			
			LeetCode
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			学习
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tool/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-toolbox"></i>
			
			工具
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">TCPIP常见问题</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/IP/">
                                <span class="chip bg-color">IP</span>
                            </a>
                        
                            <a href="/tags/TCP/">
                                <span class="chip bg-color">TCP</span>
                            </a>
                        
                            <a href="/tags/HTTP/">
                                <span class="chip bg-color">HTTP</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%BD%91%E7%BB%9C/" class="post-category">
                                网络
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-10-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-01-25
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    15 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-TIME-WAIT-会在什么情况下出现"><a href="#1-TIME-WAIT-会在什么情况下出现" class="headerlink" title="1. TIME_WAIT 会在什么情况下出现"></a>1. TIME_WAIT 会在什么情况下出现</h2><p>如果处于 TIMEWAIT 状态，说明双方建立成功过连接，而且已经发送了最后的 ACK 之后，才会处于这个状态，而且是主动发起关闭的一方处于这个状态。</p>
<p>其次，当断开TCP的主动方收到了被动方发来的FIN包并回复对应的ACK包给被动方后，主动方就进入了TIME_WAIT状态。然后等待 <code>2 * MSL</code> 时间（此时间段内如果再次收到被动方发来的FIN消息，说明之前回复的ACK包丢失，需要重新发送给被动方，并重新开始计时）后，再进入CLOSED状态，此时才能完成的释放相关的资源。</p>
<p>如果存在大量的 TIMEWAIT，往往是因为短连接太多，不断的创建连接，然后释放连接，从而导致很多连接在这个状态，可能会导致无法发起新的连接。解决的方式往往是：</p>
<ul>
<li>打开 tcp_tw_recycle 和 tcp_timestamps 选项；</li>
<li>打开 tcp_tw_reuse 和 tcp_timestamps 选项；</li>
<li>程序中使用 SO_LINGER，应用强制使用 rst 关闭。</li>
</ul>
<p>当客户端收到 Connection Reset，往往是收到了 TCP 的 RST 消息，RST 消息一般在下面的情况下发送：</p>
<ul>
<li>试图连接一个未被监听的服务端；</li>
<li>对方处于 TIMEWAIT 状态，或者连接已经关闭处于 CLOSED 状态，或者重新监听 seq num 不匹配；</li>
<li>发起连接时超时，重传超时，keepalive 超时；</li>
<li>在程序中使用 SO_LINGER，关闭连接时，放弃缓存中的数据，给对方发送 RST。</li>
</ul>
<p>更多资料：</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.serverframework.com/asynchronousevents/2011/01/time-wait-and-its-design-implications-for-protocols-and-scalable-servers.html">TIME_WAIT and its design implications for protocols and scalable client server systems</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/8WmASie_DjDDMQRdQi1FDg">系统调优，你所不知道的TIME_WAIT和CLOSE_WAIT</a></li>
</ol>
<h2 id="2-什么是-MSL"><a href="#2-什么是-MSL" class="headerlink" title="2. 什么是 MSL"></a>2. 什么是 MSL</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Maximum_segment_lifetime">MSL, Maximum Segment Lifetime</a>，TCP Segment 在网络上的最长存活时间。</p>
<p><a href="www.rfc-editor.org/rfc/rfc793.txt">RFC793</a> 将 MSL 定义为 2 分钟。Linux 下 MSL 默认是 30 秒，Windows 下 MSL 默认是 240 秒。Linux 下可以通过下面的命令查看实际的 MSL 值。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sysctl net.ipv4.tcp_fin_timeout
<span class="token function">cat</span> /proc/sys/net/ipv4/tcp_fin_timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="3-为什么不直接进入-CLOSED-状态，还需要等待-2-MSL-时间"><a href="#3-为什么不直接进入-CLOSED-状态，还需要等待-2-MSL-时间" class="headerlink" title="3. 为什么不直接进入 CLOSED 状态，还需要等待 2 * MSL 时间"></a>3. 为什么不直接进入 CLOSED 状态，还需要等待 <code>2 * MSL</code> 时间</h2><p>主要原因有两个：</p>
<ol>
<li><p>进入TIME_WAIT状态并等待 <code>2 * MSL</code>，保证了如果被动方没有收到主动方回复的 ACK，被动方至少有时间能重发一次之前 FIN 包。一回一重发，正好 <code>2 * MSL</code>。</p>
<blockquote>
<p>如果主动方回的 ACK 包丢失，被动方重发的 FIN 包也丢失，那么就不管了。</p>
</blockquote>
</li>
<li><p>避免断开的 TCP 连接不影响后面新建立的 TCP 连接。</p>
<blockquote>
<p>如果主动方不等待 <code>2*MSL</code> 直接进入 CLOSED 状态，然后再重新建立 TCP 连接，如果此时收到了之前关闭的被动方重发 FIN 消息，那么重新建立的 TCP 连接就会被断开。</p>
</blockquote>
</li>
</ol>
<h2 id="4-MTU-1500-的具体含义是什么"><a href="#4-MTU-1500-的具体含义是什么" class="headerlink" title="4. MTU 1500 的具体含义是什么"></a>4. MTU 1500 的具体含义是什么</h2><p>MTU（Maximum Transmission Unit，最大传输单元）是二层的一个定义。以以太网为例，MTU 为 1500 个 Byte，前面有 6 个 Byte 的目标 MAC 地址，6 个 Byte 的源 MAC 地址，2 个 Byte 的类型，后面有 4 个 Byte 的 CRC 校验，共 1518 个 Byte。</p>
<p>在 IP 层，一个 IP 数据报在以太网中传输，如果它的长度大于该 MTU 值，就要进行分片传输。如果不允许分片 DF，就会发送 ICMP 包，</p>
<p>在 TCP 层有个 MSS（Maximum Segment Size，最大分段大小），它等于 MTU 减去 IP 头，再减去 TCP 头。即在不分片的情况下，TCP 里面放的最大内容。</p>
<h2 id="5-HTTPS-的双向认证流程"><a href="#5-HTTPS-的双向认证流程" class="headerlink" title="5. HTTPS 的双向认证流程"></a>5. HTTPS 的双向认证流程</h2><p><img src="/images/TCPIP常见问题/HTTPS的双向认证流程.jpg" alt="HTTPS的双向认证流程"></p>
<p>其中，随机数和 premaster 的含义是：</p>
<p><img src="/images/TCPIP常见问题/HTTPS中的随机数和premaster.jpg" alt="HTTPS中的随机数和premaster"></p>
<h2 id="6-RTMP-连接建立的过程"><a href="#6-RTMP-连接建立的过程" class="headerlink" title="6. RTMP 连接建立的过程"></a>6. RTMP 连接建立的过程</h2><ol>
<li>首先，客户端发送 C0 表明自己的版本号，不必等对方的回复，然后发送 C1 表明自己的时间戳。</li>
<li>服务器只有在收到 C0 的时候，才能返回 S0，表明自己的版本号。如果版本不匹配，可以断开连接。</li>
<li>服务器发送完 S0 后，也不用等什么，就直接发送自己的时间戳 S1。客户端收到 S1 的时候，发一个知道了对方时间戳的 ACK C2。同理服务器收到 C1 的时候，发一个知道了对方时间戳的 ACK S2。</li>
<li>握手完成。</li>
</ol>
<p><img src="/images/TCPIP常见问题/RTMP连接建立的过程.jpg" alt="RTMP连接建立的过程"></p>
<h2 id="7-SO-RCVBUF-和-SO-SNDBUF-值设置的问题"><a href="#7-SO-RCVBUF-和-SO-SNDBUF-值设置的问题" class="headerlink" title="7. SO_RCVBUF 和 SO_SNDBUF 值设置的问题"></a>7. SO_RCVBUF 和 SO_SNDBUF 值设置的问题</h2><p>在 Windows 和 MacOS 下，套接字选项 SO_RCVBUF 和 SO_SNDBUF <strong>设置后的值</strong> 和 <strong>设置的值</strong> 相同。</p>
<p>但是在 Linux 下，<strong>设置后的值</strong> 是 <strong>设置值</strong> 的两倍。具体可以参考 <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/socket.7.html"><code>man 7 socket</code></a>：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">SO_RCVBUF
    Sets or gets the maximum socket receive buffer in bytes.
    The kernel doubles this value (to allow space for
    bookkeeping overhead) when it is set using setsockopt(2),
    and this doubled value is returned by getsockopt(2).  The
    default value is set by the
    /proc/sys/net/core/rmem_default file, and the maximum
    allowed value is set by the /proc/sys/net/core/rmem_max
    file.  The minimum (doubled) value for this option is 256.

SO_SNDBUF
    Sets or gets the maximum socket send buffer in bytes.  The
    kernel doubles this value (to allow space for bookkeeping
    overhead) when it is set using setsockopt(2), and this
    doubled value is returned by getsockopt(2).  The default
    value is set by the /proc/sys/net/core/wmem_default file
    and the maximum allowed value is set by the
    /proc/sys/net/core/wmem_max file.  The minimum (doubled)
    value for this option is 2048.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="8-SO-REUSEADDR-和-SO-REUSEPORT-的区别"><a href="#8-SO-REUSEADDR-和-SO-REUSEPORT-的区别" class="headerlink" title="8. SO_REUSEADDR 和 SO_REUSEPORT 的区别"></a>8. SO_REUSEADDR 和 SO_REUSEPORT 的区别</h2><p>参考 <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/socket.7.html"><code>man 7 socket</code> 的说明</a>：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">SO_REUSEADDR
    Indicates that the rules used in validating addresses
    supplied in a bind(2) call should allow reuse of local
    addresses.  For AF_INET sockets this means that a socket
    may bind, except when there is an active listening socket
    bound to the address.  When the listening socket is bound
    to INADDR_ANY with a specific port then it is not possible
    to bind to this port for any local address.  Argument is
    an integer boolean flag.

SO_REUSEPORT (since Linux 3.9)
    Permits multiple AF_INET or AF_INET6 sockets to be bound
    to an identical socket address.  This option must be set
    on each socket (including the first socket) prior to
    calling bind(2) on the socket.  To prevent port hijacking,
    all of the processes binding to the same address must have
    the same effective UID.  This option can be employed with
    both TCP and UDP sockets.

    For TCP sockets, this option allows accept(2) load
    distribution in a multi-threaded server to be improved by
    using a distinct listener socket for each thread.  This
    provides improved load distribution as compared to
    traditional techniques such using a single accept(2)ing
    thread that distributes connections, or having multiple
    threads that compete to accept(2) from the same socket.

    For UDP sockets, the use of this option can provide better
    distribution of incoming datagrams to multiple processes
    (or threads) as compared to the traditional technique of
    having multiple processes compete to receive datagrams on
    the same socket.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更详细的区别：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/14388706/how-do-so-reuseaddr-and-so-reuseport-differ">How do SO_REUSEADDR and SO_REUSEPORT differ?</a></p>
<ol>
<li><p><code>SO_REUSEADDR</code></p>
<ol>
<li>对于相同的端口，允许两个 socket 绑定的 ip 范围有交集，但 ip 的值不同，比如：<code>0.0.0.0:8080</code> 和 <code>192.168.0.1:8080</code> 。</li>
<li>允许 socket 绑定到还有处于 <code>TIME-WAIT</code> 状态的 socket 的地址端口。</li>
</ol>
</li>
<li><p><code>SO_REUSEPORT</code></p>
<ol>
<li>允许不同的 socket 绑定到完全相同的地址端口，比如每个 socket 都绑定到 <code>0.0.0.0:8080</code> 。</li>
</ol>
</li>
</ol>
<h2 id="9-SO-LINGER-选项的使用"><a href="#9-SO-LINGER-选项的使用" class="headerlink" title="9. SO_LINGER 选项的使用"></a>9. SO_LINGER 选项的使用</h2><p>SO_LINGER 选项用于控制在函数 <code>close</code> 关闭面向连接的套接字时，操作系统应该如何处理发送缓存中未发送完的数据？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">linger</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> l_onoff<span class="token punctuation">;</span>    <span class="token comment">/* linger active */</span>
    <span class="token keyword">int</span> l_linger<span class="token punctuation">;</span>   <span class="token comment">/* how many seconds to linger for */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><p>设置 <code>l_onoff</code> 为 0，<code>l_linger</code> 值将被忽略。此时 <code>close</code> 调用会立即返回。操作系统将尽可能（并不保证）发送完任何未发送的数据。 <strong>这也是操作系统的默认处理方式。</strong></p>
</li>
<li><p>设置 <code>l_onoff</code> 为非 0，<code>l_linger</code> 为 0。此时 <code>close</code> 调用会立即返回。操作系统将会丢弃任何未发送完的数据，并发送一个 RST 给对方强制关闭连接。这种情况不会出现 <code>TIME_WAIT</code> 状态 。</p>
</li>
<li><p>设置 <code>l_onoff</code> 为非 0，同时 <code>l_linger</code> 也为非 0。此时 <code>close</code> 调用可能会阻塞一段时间。阻塞直到：</p>
<ul>
<li>所有未发送的数据都被发送完且被对方确认，之后进行正常的套接字断开流程。</li>
<li><p><code>l_linger</code> 指定的时间到了。</p>
<p>如果在数据发送完且被确认前 <code>l_linger</code> 指定时间到了，Windows、Linux、MacOS 都会在后台继续发送剩余的数据。套接字的状态变化为：<code>FIN-WAIT-1</code> -&gt; <code>FIN-WAIT-2</code> -&gt; <code>TIME-WAIT</code>。</p>
<blockquote>
<p>实际上在 <code>close</code> 返回后但数据还未发送完时套接字状态就已经变成了 <code>FIN-WAIT-1</code> ，在剩余数据发送完和 FIN 发出后收到对于的 ACK 之前，套接字都是 <code>FIN-WAIT-1</code> 状态。</p>
<p>分析 Linux 的源码可以看出，之所以出现这种情况是因为，发出 FIN 包也是排队发送的，而发送队列的前面还有那些缓存中未发送完成的数据包。</p>
</blockquote>
<p>但是在 Windows 和 MacOS 下， <code>close</code> 调用一般不会阻塞，而在 Linux 下， <code>close</code> 会阻塞指定的时间（即使是非阻塞的套接字也会阻塞指定的时间）。</p>
<blockquote>
<p>参考 Linux 源码中 <code>tcp_close</code> 函数的实现。</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h2 id="10-tcp-tw-reuse-选项"><a href="#10-tcp-tw-reuse-选项" class="headerlink" title="10. tcp_tw_reuse 选项"></a>10. tcp_tw_reuse 选项</h2><p>首先看内核源码 (4.19.194) <code>ip-sysctl.txt</code> 文件中关于这两个选项的说明：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_tw_reuse - INTEGER
    Enable reuse of TIME-WAIT sockets for new connections when it is
    safe from protocol viewpoint.
    0 - disable
    1 - global enable
    2 - enable for loopback traffic only
    It should not be changed without advice/request of technical
    experts.
    Default: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4396e46187ca5070219b81773c4e65088dac50cc">tcp_tw_recycle 在 4.12 内核选项被移除。</a></p>
</blockquote>
<p>tcp_tw_reuse 设置的是内核变量 sysctl_tcp_tw_reuse ，而这个变量仅在 <code>tcp_twsk_unique</code> 函数中使用。而这个函数的调用路径有且仅有一个：</p>
<ol>
<li><code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_v4_connect</code> 函数。</li>
<li><code>net/ipv4/inet_hashtables.c</code> 文件中的 <code>inet_hash_connect</code> 函数。</li>
<li><code>net/ipv4/inet_hashtables.c</code> 文件中的 <code>__inet_check_established</code> 函数。</li>
<li><code>include/net/timewait_sock.h</code> 文件中的 <code>twsk_unique</code> 函数。</li>
<li><code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_twsk_unique</code> 函数。</li>
</ol>
<p><code>tcp_twsk_unique</code> 函数的主要实现如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tcp_twsk_unique</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sktw<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>twp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* With PAWS, it is safe from the viewpoint
       of data integrity. Even without PAWS it is safe provided sequence
       spaces do not overlap i.e. at data rates &lt;= 80Mbit/sec.

       Actually, the idea is close to VJ's one, only timestamp cache is
       held not per host, but per port pair and TW bucket is used as state
       holder.

       If TW bucket has been already destroyed we fall back to VJ's scheme
       and use initial timestamp retrieved from peer table.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcptw<span class="token operator">-&gt;</span>tw_ts_recent_stamp <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>twp <span class="token operator">||</span> <span class="token punctuation">(</span>reuse <span class="token operator">&amp;&amp;</span> <span class="token function">time_after32</span><span class="token punctuation">(</span><span class="token function">ktime_get_seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tcptw<span class="token operator">-&gt;</span>tw_ts_recent_stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* In case of repair and re-using TIME-WAIT sockets we still
         * want to be sure that it is safe as above but honor the
         * sequence numbers and time stamps set as part of the repair
         * process.
         *
         * Without this check re-using a TIME-WAIT socket with TCP
         * repair would accumulate a -1 on the repair assigned
         * sequence number. The first time it is reused the sequence
         * is -1, the second time -2, etc. This fixes that issue
         * without appearing to create any others.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span>tp<span class="token operator">-&gt;</span>repair<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            u32 seq <span class="token operator">=</span> tcptw<span class="token operator">-&gt;</span>tw_snd_nxt <span class="token operator">+</span> <span class="token number">65535</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seq<span class="token punctuation">)</span>
                seq <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>write_seq<span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tp<span class="token operator">-&gt;</span>rx_opt<span class="token punctuation">.</span>ts_recent       <span class="token operator">=</span> tcptw<span class="token operator">-&gt;</span>tw_ts_recent<span class="token punctuation">;</span>
            tp<span class="token operator">-&gt;</span>rx_opt<span class="token punctuation">.</span>ts_recent_stamp <span class="token operator">=</span> tcptw<span class="token operator">-&gt;</span>tw_ts_recent_stamp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sock_hold</span><span class="token punctuation">(</span>sktw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从源码实现中可以看出：</p>
<ol>
<li><p>因为 <code>tcp_twsk_unique</code> 函数最初只能由 <code>tcp_v4_connect</code> 函数调用，所以 <code>tcp_tw_reuse</code> 仅在 TCP 套接字作为客户端时起作用。</p>
</li>
<li><p>因为 <code>tcptw-&gt;tw_ts_recent_stamp</code> 的值要不为 0 ， 所以服务端发回的包中要包含 timestamp 数据才有效，这个功能可以通过设置 <code>net.ipv4.tcp_timestamps = 1</code>（默认为 1） 来开启。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc1323#section-3">RFC 1323</a> 引入了新的 TCP 选项：两个 4 字节的时间戳字段，用于记录 TCP 发送方的当前时间戳和从对端接收到的最新时间戳。此选项对应的解析代码在 <code>net/ipv4/tcp_input.c</code> 文件 <code>tcp_parse_options</code> 函数中的 <code>case TCPOPT_TIMESTAMP:</code> 下。</p>
</blockquote>
</li>
<li><p>因为 <code>time_after32(ktime_get_seconds(), tcptw-&gt;tw_ts_recent_stamp)</code> ，所以套接字必须要处于 <code>TIME-WAIT</code> 状态 1 秒及以上才行。</p>
</li>
</ol>
<h2 id="11-close-和-shutdown-SHUT-RDWR-的区别"><a href="#11-close-和-shutdown-SHUT-RDWR-的区别" class="headerlink" title="11. close() 和 shutdown(SHUT_RDWR) 的区别"></a>11. close() 和 shutdown(SHUT_RDWR) 的区别</h2><ol>
<li><p><code>close</code> 函数</p>
<ol>
<li>把套接字的引用计数减 1，如果引用计数达到 0 时才进行后面的步骤。</li>
<li>在输入方向上，系统内核会将改套接字设置为不可读，任何读操作都会返回异常；</li>
<li>在输出方向上，系统内核尝试将发送缓冲区的数据发送给对端，并最后向对端发送一个 FIN 报文，接下来如果再对该套接字进行写操作就会返回异常；</li>
<li>如果对端没有检测到套接字已关闭，还继续发送报文，就会收到一个 RST 报文。</li>
</ol>
</li>
<li><p><code>shutdown</code> 函数</p>
<ol>
<li><code>SHUT_RD</code> ：关闭连接的“读”，对该套接字进行读操作直接返回 EOF 。套接字上接收缓冲区已有的数据将会丢弃，如果还要新的数据流到达，会对数据进行 ACK ，然后悄悄地丢弃。</li>
<li><code>SHUT_WR</code> ：关闭连接的“写”，这常被称为“半关闭”的连接。不管套接字引用计数的值是多少，都会直接关闭连接的写方向。套接字上发送缓冲区已有的数据将被立即发送出去，并发送一个 FIN 报文给对端。应用程序如果再对该套接字进行写操作会出错。</li>
<li><code>SHUT_RDWR</code> ： 相当于 <code>SHUT_RD</code> 和 <code>SHUT_WR</code> 都操作一次。</li>
</ol>
</li>
<li><p><code>close()</code> 和 <code>shutdown(SHUT_RDWR)</code> 的区别</p>
<ol>
<li><code>close</code> 会关闭连接，并释放连接所对应的资源；而 <code>shutdown</code> 仅关闭连接，但不会释放连接所对应的资源。</li>
<li><code>close</code> 存在引用计数的概念，并不一定导致该套接字不可用； <code>shutdown</code> 则不管引用计数，直接使套接字不可用，如果有别的进程使用该套接字，将会受影响。</li>
<li><code>close</code> 的引用计数导致不一定会发出 FIN 结束报文； <code>shutdown</code> 总是会发送 FIN 结束报文。</li>
</ol>
</li>
</ol>
<h2 id="12-不会导致产生-ICMP-差错报文情况"><a href="#12-不会导致产生-ICMP-差错报文情况" class="headerlink" title="12. 不会导致产生 ICMP 差错报文情况"></a>12. 不会导致产生 ICMP 差错报文情况</h2><ol>
<li>ICMP 差错报文（ICMP 查询报文可能会产生 ICMP 差错报文）；</li>
<li>目的地址是广播地址或多播地址的 IP 数据报；</li>
<li>作为链路层广播的数据报；</li>
<li>不是 IP 分片的第一片；</li>
<li>源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。</li>
</ol>
<h2 id="13-UDP-connect-的作用"><a href="#13-UDP-connect-的作用" class="headerlink" title="13. UDP connect 的作用"></a>13. UDP connect 的作用</h2><p>对 UDP 套接字进行 <code>connect</code> 操作的意义在于将该套接字和服务端的地址和端口绑定，如果操作系统收到了与该地址和端口匹配的网络错误（如 ICMP 不可达），后续在该套接字上的操作就能获取到这些错误。</p>
<h2 id="14-为什么推荐将监听套接字设置为非阻塞"><a href="#14-为什么推荐将监听套接字设置为非阻塞" class="headerlink" title="14. 为什么推荐将监听套接字设置为非阻塞"></a>14. 为什么推荐将监听套接字设置为非阻塞</h2><p>因为当 <code>accept</code> 和 I/O 多路复用 <code>select</code> 、 <code>poll</code> 等一起配合使用时，如果在监听套接字上触发了事件，说明有连接建立完成。但是在调用 <code>accept</code> 获取已连接的套接字之前，该连接被关闭了（如客户端发送了 RST），那么再调用 <code>accept</code> 将会阻塞程序。</p>
<h2 id="15-Reactor-和-Proactor-网络编程模式"><a href="#15-Reactor-和-Proactor-网络编程模式" class="headerlink" title="15. Reactor 和 Proactor 网络编程模式"></a>15. Reactor 和 Proactor 网络编程模式</h2><p><strong>Reactor 模式</strong> 基于待完成的 I/O 事件。每次感知到事件后再调用 <code>read</code> 、 <code>write</code> 方法完成数据的读写。如 <code>epoll</code>。</p>
<p><strong>Proactor 模式</strong> 基于已完成的 I/O 事件。它只负责感知事件完成，并由对应的 handler 发起异步读写请求, I/O 读写操作本身由操作系统内核完成。如：<code>IOCP</code>。</p>
<p>无论是 <strong>Reactor 模式</strong> 还是 <strong>Proactor 模式</strong> ，都是一种基于事件分发的网络编程模式。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/tcpip-chang-jian-wen-ti/">https://kibazen.cn/tcpip-chang-jian-wen-ti/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/IP/">
                                    <span class="chip bg-color">IP</span>
                                </a>
                            
                                <a href="/tags/TCP/">
                                    <span class="chip bg-color">TCP</span>
                                </a>
                            
                                <a href="/tags/HTTP/">
                                    <span class="chip bg-color">HTTP</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/li-jie-tcp-zhong-de-shu-ju-chuan-shu/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/20.jpg" class="responsive-img" alt="理解TCP中的数据传输">
                        
                        <span class="card-title">理解TCP中的数据传输</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-10-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BD%91%E7%BB%9C/" class="post-category">
                                    网络
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/IP/">
                        <span class="chip bg-color">IP</span>
                    </a>
                    
                    <a href="/tags/TCP/">
                        <span class="chip bg-color">TCP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/dong-shou-xue-shen-du-xue-xi-di-er-ban-du-shu-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/15.jpg" class="responsive-img" alt="《动手学深度学习（第二版）》读书笔记">
                        
                        <span class="card-title">《动手学深度学习（第二版）》读书笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CPP/">
                        <span class="chip bg-color">CPP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (true) {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 木叶禅<br />'
            + '文章作者: Kiba Amor<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者木叶禅所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">787k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>









    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=562236616" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 562236616" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/kibaamor" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kibaamor" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
