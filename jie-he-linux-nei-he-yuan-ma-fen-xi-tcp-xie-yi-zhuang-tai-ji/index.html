<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="结合Linux内核源码分析TCP协议状态机, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="一个普通游戏程序员的博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>结合Linux内核源码分析TCP协议状态机 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/leetcode/" class="waves-effect waves-light">
      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>LeetCode</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>学习</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/softwares/" class="waves-effect waves-light">
      
      <i class="fas fa-toolbox" style="zoom: 0.6;"></i>
      
      <span>软件</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            一个普通游戏程序员的博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/leetcode/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-code"></i>
			
			LeetCode
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			学习
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/softwares/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-toolbox"></i>
			
			软件
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">结合Linux内核源码分析TCP协议状态机</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%86%85%E6%A0%B8%E5%88%86%E6%9E%90/">
                                <span class="chip bg-color">内核分析</span>
                            </a>
                        
                            <a href="/tags/Ubuntu/">
                                <span class="chip bg-color">Ubuntu</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%BD%91%E7%BB%9C/" class="post-category">
                                网络
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-06-17
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-11-01
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    21 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a>一、准备环境</h2><blockquote>
<p>环境：Ubuntu18.04</p>
<p>编辑器：VSCode</p>
<p>内核版本：<a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.19.194.tar.xz">linux-4.19.194</a></p>
</blockquote>
<h3 id="1-下载编译内核源码"><a href="#1-下载编译内核源码" class="headerlink" title="1. 下载编译内核源码"></a>1. 下载编译内核源码</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.19.194.tar.xz

<span class="token function">tar</span> xf linux-4.19.194.tar.xz
<span class="token builtin class-name">cd</span> linux-4.19.194

<span class="token comment"># 想要编译什么架构就指定什么值，所有合法的值在源码的arch文件夹下必须存在同名的文件夹</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86 <span class="token comment">#x86架构</span>

<span class="token comment"># make命令的参数可以通过 make help 获取</span>
<span class="token function">make</span> x86_64_defconfig <span class="token comment"># 生成64位平台的默认配置</span>

<span class="token function">make</span> <span class="token comment"># 编译内核</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-分析编译时的宏定义"><a href="#2-分析编译时的宏定义" class="headerlink" title="2. 分析编译时的宏定义"></a>2. 分析编译时的宏定义</h3><p>在第一步 <a href="#1-下载编译内核源码">下载编译内核源码</a> 成功后，源代码目录下会生成一个名为 <code>.config</code> 的文件，该文件指明了编译内核时所用到的设置。可以使用下面的命令来生成编译内核代码时使用的宏定义列表：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token string">"^CONFIG_.*"</span> .config <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/=y//g"</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/=m/_MODULE/g"</span> <span class="token operator">|</span> <span class="token function">cat</span> - <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token builtin class-name">echo</span> __KERNEL__<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>最后添加的宏 <code>__KERNEL__</code> 来自源代码根目录下 <code>Makefile</code> 文件的443行。</p>
</blockquote>
<p>将上面命令生成的结果配置到vscode中，可以更加方面有效的查看内核代码。</p>
<h2 id="二、确定套接字调用对应的内核实现函数"><a href="#二、确定套接字调用对应的内核实现函数" class="headerlink" title="二、确定套接字调用对应的内核实现函数"></a>二、确定套接字调用对应的内核实现函数</h2><blockquote>
<p>下面以创建套接字的函数 <code>socket</code> 为例。</p>
</blockquote>
<h3 id="1-确定socket调用的syscall号"><a href="#1-确定socket调用的syscall号" class="headerlink" title="1. 确定socket调用的syscall号"></a>1. 确定socket调用的syscall号</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: main.c</span>
<span class="token comment">// compile: gcc -ggdb main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GDB反汇编调试socket调用</p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">0x7ffff7b04d50 &lt;socket&gt;         mov    $0x29,%eax
0x7ffff7b04d55 &lt;socket+5&gt;       syscall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以发现socket调用的syscall号为0x29（即41）。</p>
<blockquote>
<p>命令 <code>man syscall</code> 可以获取更多关于 syscall 调用的信息。</p>
</blockquote>
<h3 id="2-确定socket对应的内核实现"><a href="#2-确定socket对应的内核实现" class="headerlink" title="2. 确定socket对应的内核实现"></a>2. 确定socket对应的内核实现</h3><p>系统调用表定义在 <code>arch/x86/entry/syscall_64.c</code> 文件中：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: arch/x86/entry/syscall_64.c</span>
asmlinkage <span class="token keyword">const</span> sys_call_ptr_t sys_call_table<span class="token punctuation">[</span>__NR_syscall_max<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
     * Smells like a compiler bug -- it doesn't work
     * when the &amp; below is removed.
     */</span>
    <span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> __NR_syscall_max<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>sys_ni_syscall<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/syscalls_64.h&gt;</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码中 <code>#include &lt;asm/syscalls_64.h&gt;</code> 对应的文件是 <code>arch/x86/include/generated/asm/syscalls_64.h</code> ：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: arch/x86/include/generated/asm/syscalls_64.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_X86</span></span>
<span class="token function">__SYSCALL_64</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> __x64_sys_socket<span class="token punctuation">,</span> <span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* CONFIG_UML */</span></span>
<span class="token function">__SYSCALL_64</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> sys_socket<span class="token punctuation">,</span> <span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><code>arch/x86/include/generated/asm/syscalls_64.h</code> 文件由 <code>arch/x86/entry/syscalls/syscall_64.tbl</code> 文件生成而来。</p>
</blockquote>
<p>根据 <a href="#2-分析编译时的宏定义">分析编译时的宏定义</a> 的结果，可以确定宏 <code>CONFIG_X86</code> 是定义了的，所以调用号41对应的实现为 <code>__x64_sys_socket</code> 。</p>
<p>在源码中却找不到 <code>__x64_sys_socket</code> 的定义，但能在文件 <code>net/socket.c</code> 中找到 <code>__sys_socket</code> 函数的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: net/socket.c</span>
<span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">__sys_socket</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析宏 <code>SYSCALL_DEFINE3</code> 的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: include/linux/syscalls.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">SYSCALL_DEFINEx</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> _</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">SYSCALL_DEFINEx</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">SYSCALL_METADATA</span><span class="token punctuation">(</span>sname<span class="token punctuation">,</span> x<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span>         </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">__SYSCALL_DEFINEx</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着分析宏 <code>__SYSCALL_DEFINEx</code> 的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: arch/x86/include/asm/syscall_wrapper.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">__SYSCALL_DEFINEx</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                 </span><span class="token punctuation">\</span>
    <span class="token expression">asmlinkage <span class="token keyword">long</span> __x64_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">ALLOW_ERROR_INJECTION</span><span class="token punctuation">(</span>__x64_sys</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">,</span> ERRNO<span class="token punctuation">)</span><span class="token punctuation">;</span>          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">long</span> __se_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_LONG<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> __do_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_DECL<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
    <span class="token expression">asmlinkage <span class="token keyword">long</span> __x64_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{</span>                               </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> __se_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">SC_X86_64_REGS_TO_ARGS</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                               </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">__IA32_SYS_STUBx</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> name<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span>              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">long</span> __se_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_LONG<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{</span>                               </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">long</span> ret <span class="token operator">=</span> __do_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_CAST<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_TEST<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>             </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">__PROTECT</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> ret<span class="token punctuation">,</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_ARGS<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> ret<span class="token punctuation">;</span>                     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                               </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> __do_sys</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">name</span><span class="token punctuation">(</span><span class="token function">__MAP</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>__SC_DECL<span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以确定，宏 <code>SYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)</code> 展开后，定义了 <code>__x64_sys_socket</code>。</p>
<p>即 <code>__x64_sys_socket</code> 函数的本体就是 <code>net/socket.c</code> 文件中的 <code>__sys_socket</code> 函数。</p>
<h2 id="三、分析TCP协议状态机"><a href="#三、分析TCP协议状态机" class="headerlink" title="三、分析TCP协议状态机"></a>三、分析TCP协议状态机</h2><h3 id="1-socket"><a href="#1-socket" class="headerlink" title="1. socket"></a>1. socket</h3><p>调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">__sys_socket                // net/socket.c:1355
    |- sock_create          // net/socket.c:1346
        |- __sock_create    // net/socket.c:1316<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>socket</code> 函数最后会调用函数 <code>__sock_create</code> ，其主要代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">__sock_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span>
            <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token keyword">int</span> kern<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_proto_family</span> <span class="token operator">*</span>pf<span class="token punctuation">;</span>

    sock <span class="token operator">=</span> <span class="token function">sock_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pf <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>net_families<span class="token punctuation">[</span>family<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pf<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>sock_alloc()</code> 函数分配套接字的一些资源后，再从 <code>net_families</code> 取出网络协议簇对应的处理函数，最后创建对应网络协议簇的套接字。</p>
<p><code>net_families</code> 是一个数组，里面存放了不同的协议簇对应的处理函数。通过函数 <code>sock_register</code> 可以注册到此数组中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: net/ipv4/af_inet.c</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_proto_family</span> inet_family_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>family <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>create <span class="token operator">=</span> inet_create<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">inet_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">sock_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet_family_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说，上面代码中的 <code>err = pf-&gt;create(net, sock, protocol, kern)</code> 调用的其实是 <code>inet_create(net, sock, protocol, kern)</code> 。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_create                             // net/ipv4/af_inet.c:1075
    |- sock_init_data                   // net/core/sock.c:347
        |- sk-&gt;sk_state = TCP_CLOSE     // net/core/sock.c:2790<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>综上，调用 <code>socket()</code> 函数后，套接字的默认状态为 <code>TCP_CLOSE</code> 。</p>
<h3 id="2-listen"><a href="#2-listen" class="headerlink" title="2. listen"></a>2. listen</h3><p>调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">__sys_listen                    // net/socket.c:1525
    |- sock-&gt;ops-&gt;listen()      // net/socket.c:1516<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说，上面代码中的 <code>sock-&gt;ops-&gt;listen()</code> 调用的其实是 <code>net/ipv4/af_inet.c</code> 文件中的 <code>inet_listen</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_listen                                     // net/ipv4/af_inet.c:991
    |- inet_csk_listen_start                    // net/ipv4/af_inet.c:229
        |- inet_sk_state_store(sk, TCP_LISTEN)  // net/ipv4/inet_connection_sock.c:923<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>综上，调用 <code>listen()</code> 函数后，套接字的状态由 <code>TCP_CLOSE</code> 变为 <code>TCP_LISTEN</code> 。</p>
<h3 id="3-connect"><a href="#3-connect" class="headerlink" title="3. connect"></a>3. connect</h3><p>调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">__sys_connect                // net/socket.c:1674
    |- sock-&gt;ops-&gt;connect()  // net/socket.c:1663<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同理，对于 TCP/IPv4 来说，上面代码中的 <code>sock-&gt;ops-&gt;connect()</code> 调用的其实是 <code>net/ipv4/af_inet.c</code> 文件中的 <code>inet_stream_connect</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_stream_connect                 // net/ipv4/af_inet.c:985
    |- __inet_stream_connect        // net/ipv4/af_inet.c:719
        |- sk-&gt;sk_prot-&gt;connect()   // net/ipv4/af_inet.c:655<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>上面代码中的 <code>sk-&gt;sk_prot-&gt;connect()</code> 调用的其实是 <code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_v4_connect</code> 函数。</p>
<h4 id="1-发送SYN"><a href="#1-发送SYN" class="headerlink" title="1. 发送SYN"></a>1. 发送SYN</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_connect                                      // net/ipv4/tcp_ipv4.c:2460
    |- tcp_set_state(sk, TCP_SYN_SENT)              // net/ipv4/tcp_ipv4.c:280
    |- tcp_connect                                  // net/ipv4/tcp_ipv4.c:318
        |- tcp_transmit_skb                         // net/ipv4/tcp_output.c:3529
            |- __tcp_transmit_skb                   // net/ipv4/tcp_output.c:1164
                |- icsk-&gt;icsk_af_ops-&gt;queue_xmit()  // net/ipv4/tcp_output.c:1148<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>tcp_v4_connect</code> 函数先将套接字的状态设置为 <code>TCP_SYN_SENT</code> ，然后再调用 <code>tcp_connect</code> 发送实际的SYN包。</p>
<p>在函数 <code>__tcp_transmit_skb</code> 中构建网络包的TCP头。构建好后，调用 <code>icsk-&gt;icsk_af_ops-&gt;queue_xmit()</code> 发送TCP包，而函数 <code>icsk-&gt;icsk_af_ops-&gt;queue_xmit()</code> 实际就是 <code>include/net/ip.h</code> 文件中的 <code>ip_queue_xmit</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ip_queue_xmit                                   // net/ipv4/tcp_ipv4.c:1931
    |- __ip_queue_xmit                          // include/net/ip.h:197
        |- skb_dst_set_noref(skb, &amp;rt-&gt;dst)     // net/ipv4/ip_output.c:473
        |- ip_local_out                         // net/ipv4/ip_output.c:506<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先在函数 <code>__ip_queue_xmit</code> 中调用 <code>skb_dst_set_noref(skb, &amp;rt-&gt;dst)</code> 设置发送的目标，然后构建 IP 头并调用函数 <code>ip_local_out</code> 将包含有 SYN 标志的 TCP 包发送出去。</p>
<h4 id="2-接收到SYN和ACK，并回复ACK"><a href="#2-接收到SYN和ACK，并回复ACK" class="headerlink" title="2. 接收到SYN和ACK，并回复ACK"></a>2. 接收到SYN和ACK，并回复ACK</h4><p>当 IP 层接收到 TCPv4 的包时，会调用函数 <code>tcp_v4_rcv</code> 来处理。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_rcv                                                  // net/ipv4/af_inet.c:1684
    |- tcp_v4_do_rcv                                        // net/ipv4/tcp_ipv4.c:1832
        |- tcp_rcv_state_process                            // net/ipv4/tcp_ipv4.c:1569
            |- tcp_rcv_synsent_state_process                // net/ipv4/tcp_input.c:6065
                |- tcp_finish_connect                       // net/ipv4/tcp_input.c:5898
                    |- tcp_set_state(sk, TCP_ESTABLISHED)   // net/ipv4/tcp_input.c:5695
                |- tcp_send_ack                             // net/ipv4/tcp_input.c:5928<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 <code>tcp_rcv_synsent_state_process</code> 中，先将套接字的状态设置为 <code>TCP_ESTABLISHED</code> ，然后再调用 <code>tcp_send_ack</code> 发送 ACK 完成 TCP 的三次握手。</p>
<p>综上，调用 <code>connect()</code> 函数后，套接字的状态由 <code>TCP_CLOSE</code> 变为 <code>TCP_SYN_SENT</code> ，在成功收到 ACK 后，状态再变为 <code>TCP_ESTABLISHED</code> 。</p>
<h3 id="4-accept"><a href="#4-accept" class="headerlink" title="4. accept"></a>4. accept</h3><p>调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">__sys_accept4                               // net/socket.c:1630
    |- sock-&gt;ops-&gt;accept(sock, newsock)     // net/socket.c:1589<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说， <code>sock-&gt;ops-&gt;accept()</code> 实际调用的是 <code>net/ipv4/af_inet.c</code> 文件中的 <code>inet_accept</code> 。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_accept                     // net/ipv4/af_inet.c:987
    |- sk1-&gt;sk_prot-&gt;accept()   // net/ipv4/af_inet.c:734<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说， <code>sk1-&gt;sk_prot-&gt;accept()</code> 实际调用的是 <code>net/ipv4/inet_connection_sock.c</code> 文件中的 <code>inet_csk_accept</code> 。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span><span class="token function">inet_csk_accept</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>err<span class="token punctuation">,</span> bool kern<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">reqsk_queue_empty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timeo <span class="token operator">=</span> <span class="token function">sock_rcvtimeo</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* If this is a non blocking socket don't sleep */</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeo<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>

        <span class="token function">inet_csk_wait_for_connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> timeo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    req <span class="token operator">=</span> <span class="token function">reqsk_queue_remove</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newsk <span class="token operator">=</span> req<span class="token operator">-&gt;</span>sk<span class="token punctuation">;</span>
    <span class="token keyword">return</span> newsk<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>inet_csk_accept</code> 首先检查监听套接字上的连接队列是否为空，为空且设置了 <code>O_NONBLOCK</code> 标志的话就返回错误 <code>EAGAIN</code> ，否则就等待直到有连接到来。</p>
<h4 id="1-接收到SYN，发送SYN和ACK"><a href="#1-接收到SYN，发送SYN和ACK" class="headerlink" title="1. 接收到SYN，发送SYN和ACK"></a>1. 接收到SYN，发送SYN和ACK</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_rcv                                          // net/ipv4/af_inet.c:1684
    |- tcp_v4_do_rcv                                // net/ipv4/tcp_ipv4.c:1822
        |- tcp_rcv_state_process                    // net/ipv4/tcp_ipv4.c:1569
            |- icsk-&gt;icsk_af_ops-&gt;conn_request()    // net/ipv4/tcp_input.c:6051<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说，调用 <code>icsk-&gt;icsk_af_ops-&gt;conn_request()</code> 其实是调用 <code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_v4_conn_request</code>：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_conn_request                                 // net/ipv4/tcp_ipv4.c:1935
    |- tcp_conn_request                             // net/ipv4/tcp_ipv4.c:1397
        |- inet_reqsk_alloc                         // net/ipv4/tcp_input.c:6461
            |- ireq-&gt;ireq_state = TCP_NEW_SYN_RECV  // net/ipv4/tcp_input.c:6374
        |- af_ops-&gt;send_synack()                    // net/ipv4/tcp_input.c:6556<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在连接请求处理函数 <code>tcp_conn_request</code> 中，首先把新分配的套接字的 <code>request_sock</code> 设置为 <code>TCP_NEW_SYN_RECV</code> 状态。然后调用 <code>af_ops-&gt;send_synack()</code> 来发送 SYN 和 ACK 。对于 TCP/IPv4 来说，调用 <code>af_ops-&gt;send_synack()</code> 其实是调用 <code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_v4_send_synack</code> 。而函数 <code>tcp_v4_send_synack</code> 做的也确实是发送一个带有 SYN 和 ACK 标志的包。</p>
<h4 id="2-接收到ACK"><a href="#2-接收到ACK" class="headerlink" title="2. 接收到ACK"></a>2. 接收到ACK</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_rcv                                              // net/ipv4/af_inet.c:1684
    |- tcp_check_req                                    // net/ipv4/tcp_ipv4.c:1773
        |- inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock()   // net/ipv4/tcp_minisocks.c:789
        |- inet_csk_complete_hashdance                  // net/ipv4/tcp_minisocks.c:797
    |- tcp_child_process                                // net/ipv4/tcp_ipv4.c:1792<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><p>对于 TCP/IPv4 来说，调用 <code>inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock()</code> 其实是调用 <code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_v4_syn_recv_sock</code>：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_syn_recv_sock                                    // net/ipv4/tcp_ipv4.c:1936
    |- tcp_create_openreq_child                         // net/ipv4/tcp_ipv4.c:1429
        |- inet_csk_clone_lock                          // net/ipv4/tcp_minisocks.c:452
            |- inet_sk_set_state(newsk, TCP_SYN_RECV)   // net/ipv4/inet_connection_sock.c:829<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p> 需要注意的是，新创建的套接字的状态为 <code>TCP_SYN_RECV</code> 。</p>
</li>
<li><p>函数 <code>inet_csk_complete_hashdance</code> 主要做的是将请求控制块从未完成连接队列中删除，加入到已完成连接队列中：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_csk_complete_hashdance                 // net/ipv4/tcp_minisocks.c:797
    |- inet_csk_reqsk_queue_drop            // net/ipv4/inet_connection_sock.c:992
        |- reqsk_queue_unlink               // net/ipv4/inet_connection_sock.c:703
    |- inet_csk_reqsk_queue_add             // net/ipv4/inet_connection_sock.c:994<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>函数 <code>tcp_child_process</code> 进一步对新创建的套接字进行处理并把状态更新为 <code>TCP_ESTABLISHED</code> ：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_child_process                               // net/ipv4/tcp_ipv4.c:1792
    |- tcp_rcv_state_process                    // net/ipv4/tcp_minisocks.c:851
        |- tcp_set_state(sk, TCP_ESTABLISHED)   // net/ipv4/tcp_input.c:6132<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h3 id="5-close"><a href="#5-close" class="headerlink" title="5. close"></a>5. close</h3><h4 id="1-发送FIN"><a href="#1-发送FIN" class="headerlink" title="1. 发送FIN"></a>1. 发送FIN</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_close                                               // net/ipv4/tcp_ipv4.c:2458
    |- tcp_close_state                                  // net/ipv4/tcp.c:2393
        |- tcp_set_state(sk, ns)                        // net/ipv4/tcp.c:2294
    |- tcp_send_fin                                     // net/ipv4/tcp.c:2423
        |- TCP_SKB_CB(tskb)-&gt;tcp_flags |= TCPHDR_FIN    // net/ipv4/tcp_output.c:3087
    |- sk_stream_wait_close                             // net/ipv4/tcp.c:2426<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于状态是 <code>TCP_ESTABLISHED</code> 的套接字，函数 <code>tcp_close_state</code> 会把套接字的状态更新为 <code>TCP_FIN_WAIT1</code> 。 <code>tcp_send_fin</code> 函数则发送带有 FIN 标记的包给对方。</p>
<h4 id="2-接收ACK"><a href="#2-接收ACK" class="headerlink" title="2. 接收ACK"></a>2. 接收ACK</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_rcv                                              // net/ipv4/af_inet.c:1684
    |- tcp_v4_do_rcv                                    // net/ipv4/tcp_ipv4.c:1832
        |- tcp_rcv_state_process                        // net/ipv4/tcp_ipv4.c:1569
            |- tcp_set_state(sk, TCP_FIN_WAIT2)         // net/ipv4/tcp_input.c:6175<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-等待FIN并发送ACK"><a href="#3-等待FIN并发送ACK" class="headerlink" title="3. 等待FIN并发送ACK"></a>3. 等待FIN并发送ACK</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">tcp_v4_rcv                                                      // net/ipv4/af_inet.c:1684
    |- tcp_v4_do_rcv                                            // net/ipv4/tcp_ipv4.c:1832
        |- tcp_rcv_state_process                                // net/ipv4/tcp_ipv4.c:1569
            |- tcp_data_queue                                   // net/ipv4/tcp_input.c:6262
                |- tcp_fin                                      // net/ipv4/tcp_input.c:4756
                    |- tcp_send_ack(sk)                         // net/ipv4/tcp_input.c:4139
                    |- tcp_time_wait(TCP_TIME_WAIT)             // net/ipv4/tcp_input.c:4140
                        |- inet_twsk_alloc                      // net/ipv4/tcp_minisocks.c:259
                            |- tw-&gt;tw_state = TCP_TIME_WAIT     // net/ipv4/inet_timewait_sock.c:175
                            |- timer_setup(tw_timer_handler)    // net/ipv4/inet_timewait_sock.c:188
                        |- inet_twsk_schedule()                 // net/ipv4/tcp_minisocks.c:319<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数 <code>tcp_fin</code> 中，发送了 ACK 后，并进入 <code>TCP_TIME_WAIT</code> 状态。同时注册一个超时的定时器。</p>
<blockquote>
<p>注意，虽然在 <code>inet_twsk_alloc</code> 函数中，修改的是 <code>tw-&gt;tw_state</code> 字段为 <code>TCP_TIME_WAIT</code> 状态。但是查看宏 <code>tw_state</code> 的定义可以知道，<code>tw_state</code> 指向的依旧是结构体 <code>sock_common</code> 中的字段 <code>skc_state</code> 。</p>
</blockquote>
<h3 id="6-shutdown"><a href="#6-shutdown" class="headerlink" title="6. shutdown"></a>6. shutdown</h3><p>调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">__sys_shutdown                                  // net/socket.c:1973
    |- sock-&gt;ops-&gt;shutdown()                    // net/socket.c:1965<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于 TCP/IPv4 来说，调用 <code>sock-&gt;ops-&gt;shutdown()</code> 其实是调用 <code>net/ipv4/tcp_ipv4.c</code> 文件中的 <code>tcp_shutdown</code>：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">tcp_shutdown</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>how <span class="token operator">&amp;</span> SEND_SHUTDOWN<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">/* If we've already sent a FIN, or it's a closed state, skip this. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> sk<span class="token operator">-&gt;</span>sk_state<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
        <span class="token punctuation">(</span>TCPF_ESTABLISHED <span class="token operator">|</span> TCPF_SYN_SENT <span class="token operator">|</span>
            TCPF_SYN_RECV <span class="token operator">|</span> TCPF_CLOSE_WAIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Clear out any half completed packets.  FIN if needed. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tcp_close_state</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">tcp_send_fin</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与调用 <code>close</code> 类似，</p>
<h2 id="四、IP层及以下层的工作"><a href="#四、IP层及以下层的工作" class="headerlink" title="四、IP层及以下层的工作"></a>四、IP层及以下层的工作</h2><h3 id="1-IP层发送包"><a href="#1-IP层发送包" class="headerlink" title="1. IP层发送包"></a>1. IP层发送包</h3><p>上层想要发送 IP 包，都会调用函数 <code>ip_local_out</code> 来发送。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ip_local_out                            // include/net/ip.h:165
    |- dst_output                       // net/ipv4/ip_output.c:125
        |- skb_dst(skb)-&gt;output()       // include/net/dst.h:455<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对 IP 协议来说， <code>skb_dst(skb)-&gt;output()</code> 实际调用的是 <code>net/ipv4/ip_output.c</code> 文件中的 <code>ip_output</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ip_output                               // net/ipv4/route.c:1636
    |- ip_finish_output                 // net/ipv4/ip_output.c:408
        |- ip_finish_output2            // net/ipv4/ip_output.c:318
            |- neigh_output             // net/ipv4/ip_output.c:230
                |- neigh_hh_output      // include/net/neighbour.h:499
                    |- dev_queue_xmit   // include/net/neighbour.h:491<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用 <code>dev_queue_xmit</code> 是将 IP 包交给网络设备子系统来发送，而 <code>dev_queue_xmit</code> 直接调用的函数 <code>__dev_queue_xmit</code> 。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dev_queue_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">__dev_queue_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__dev_queue_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>sb_dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    txq <span class="token operator">=</span> <span class="token function">netdev_pick_tx</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> sb_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    q <span class="token operator">=</span> <span class="token function">rcu_dereference_bh</span><span class="token punctuation">(</span>txq<span class="token operator">-&gt;</span>qdisc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>enqueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__dev_xmit_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> q<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> txq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* The device has no queue. Common case for software devices:
     * loopback, all the sorts of tunnels...
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> IFF_UP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_hard_start_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> txq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数 <code>__dev_queue_xmit</code> 内部：</p>
<ol>
<li><p>针对有发送队列的设备</p>
<p> 首先调用 <code>netdev_pick_tx</code> 选择一个发送队列（现在的网卡一般都支持多个发送队列），然后再调用 <code>__dev_xmit_skb</code> 进行发送。在经过层层调用后，最后会调用的函数 <code>dev_hard_start_xmit</code> 发送包。</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">|- __dev_xmit_skb                               // net/core/dev.c:3807
    |- q-&gt;enqueue(skb, q, &amp;to_free)             // net/core/dev.c:3450
    |- qdisc_run                                // net/core/dev.c:3451
        |- __qdisc_run                          // include/net/pkt_sched.h:120
            |- qdisc_restart                    // net/sched/sch_generic.c:403
                |- sch_direct_xmit              // net/sched/sch_generic.c:395
                    |- dev_hard_start_xmit      // net/sched/sch_generic.c:332<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 需要注意函数 <code>__qdisc_run</code> 的实现：</p>
 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">__qdisc_run</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Qdisc</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> quota <span class="token operator">=</span> dev_tx_weight<span class="token punctuation">;</span>
    <span class="token keyword">int</span> packets<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">qdisc_restart</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        * Ordered by possible occurrence: Postpone processing if
        * 1. we've exceeded packet quota
        * 2. another process needs the CPU;
        */</span>
        quota <span class="token operator">-=</span> packets<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>quota <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">need_resched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">__netif_schedule</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 如果系统态 CPU 发送网络包不够用的时候，会调用函数 <code>__netif_schedule</code> 进而调用函数 <code>__netif_reschedule</code> 触发一个软中断 <code>NET_TX_SOFTIRQ</code> 。而对应的中断处理函数 <code>net_tx_action</code> 会重新调用 <code>qdisc_run</code> 继续发送剩余的网络包。</p>
</li>
<li><p>针对没有发送队列的设备</p>
<p> 如注释里说的回环地址，隧道网络等，就直接调用 <code>dev_hard_start_xmit</code> 发送包。</p>
</li>
</ol>
<p>所以，不管设备有无发送队列，最后都会调用函数 <code>dev_hard_start_xmit</code> ：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">|- dev_hard_start_xmit                      // net/core/dev.c:3262
    |- xmit_one                             // net/core/dev.c:3272
        |- netdev_start_xmit                // net/core/dev.c:3256
            |- __netdev_start_xmit          // include/linux/netdevice.h:4359
                |- ops-&gt;ndo_start_xmit      // include/linux/netdevice.h:4345<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在经过层层调用后，最后调用的 <code>ops-&gt;ndo_start_xmit()</code> 其实是各个网卡驱动的实现了。</p>
<h3 id="2-Intel的igb网卡驱动的发送流程"><a href="#2-Intel的igb网卡驱动的发送流程" class="headerlink" title="2. Intel的igb网卡驱动的发送流程"></a>2. Intel的igb网卡驱动的发送流程</h3><p>对网卡驱动 <code>drivers/net/ethernet/intel/igb</code> 来说， 函数 <code>ops-&gt;ndo_start_xmit</code> 调用的其实就是 <code>igb_netdev_ops</code> 中的 <code>ndo_start_xmit</code> 的值，即 <code>drivers/net/ethernet/intel/igb/igb_main.c</code> 文件中的 <code>igb_xmit_frame</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_xmit_frame              // drivers/net/ethernet/intel/igb/igb_main.c:2865
    |- igb_xmit_frame_ring  // drivers/net/ethernet/intel/igb/igb_main.c:6201
        |- igb_tx_map       // drivers/net/ethernet/intel/igb/igb_main.c:6157<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>函数 <code>igb_tx_map</code> 做的主要的工作就是把网络包数据映射到 RAM 的 DMA 区域，然后唤醒设备发送数据。</p>
<h3 id="3-Intel的igb网卡驱动的初始化"><a href="#3-Intel的igb网卡驱动的初始化" class="headerlink" title="3. Intel的igb网卡驱动的初始化"></a>3. Intel的igb网卡驱动的初始化</h3><ol>
<li><p>模块加载</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_init_module                                         // drivers/net/ethernet/intel/igb/igb_main.c:680
    |- pci_register_driver(&amp;igb_driver)                 // drivers/net/ethernet/intel/igb/igb_main.c:676
        |- __pci_register_driver                        // include/linux/pci.h:1289
            |- driver_register                          // drivers/pci/pci-driver.c:1409
                |- bus_add_driver                       // drivers/base/driver.c:170
                    |- driver_attach                    // drivers/base/bus.c:672
                        |- __driver_attach              // drivers/base/dd.c:922
                            |- driver_probe_device      // drivers/base/dd.c:903
                                |- really_probe         // drivers/base/dd.c:667
                                    |- drv-&gt;probe(dev)  // drivers/base/dd.c:510<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 最后调用的 <code>drv-&gt;probe(dev)</code> 其实就是 <code>igb_driver</code> 中的 <code>probe</code> 的值，即 <code>drivers/net/ethernet/intel/igb/igb_main.c</code> 文件中的 <code>igb_probe</code> 函数。</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_probe                                       // drivers/net/ethernet/intel/igb/igb_main.c:230
    |- netdev-&gt;netdev_ops = &amp;igb_netdev_ops     // drivers/net/ethernet/intel/igb/igb_main.c:3095
    |- igb_sw_init                              // drivers/net/ethernet/intel/igb/igb_main.c:3121
        |- igb_init_interrupt_scheme            // drivers/net/ethernet/intel/igb/igb_main.c:3888
            |- igb_alloc_q_vectors              // drivers/net/ethernet/intel/igb/igb_main.c:1387
                |- igb_alloc_q_vector           // drivers/net/ethernet/intel/igb/igb_main.c:1331
                    |- netif_napi_add(igb_poll) // drivers/net/ethernet/intel/igb/igb_main.c:1216
                        |- napi-&gt;poll = poll    // net/core/dev.c:6194<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 对 Intel 的 igb 网卡来说，模块加载函数 <code>igb_probe</code> 做了：</p>
<ul>
<li>初始化了设备相关的操作回调函数信息 <code>igb_netdev_ops</code> 。</li>
<li>注册了 napi 的轮询回调函数 <code>igb_poll</code> 。</li>
</ul>
</li>
<li><p>启动设备</p>
<p> 在函数 <code>igb_probe</code> 中，通过语句 <code>netdev-&gt;netdev_ops = &amp;igb_netdev_ops</code> 初始化了网卡相关的操作回调。在网卡启用时，比如执行命令 <code>ifconfig eth0 up</code> 时，系统会依次调用：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">dev_open                        // net/core/dev.c:1430
    |- __dev_open               // net/core/dev.c:1437
        |- ops-&gt;ndo_open(dev)   // net/core/dev.c:1402<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p> 对于网卡驱动 <code>drivers/net/ethernet/intel/igb</code> 来说，函数 <code>ops-&gt;ndo_open(dev)</code> 调用的就是函数 <code>igb_open</code> 。</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_open                                        // drivers/net/ethernet/intel/igb/igb_main.c:2863
    |- __igb_open                               // drivers/net/ethernet/intel/igb/igb_main.c:4017
        |- igb_request_irq                      // drivers/net/ethernet/intel/igb/igb_main.c:3953
            |- igb_request_msix                 // drivers/net/ethernet/intel/igb/igb_main.c:1416
                |- request_irq(igb_msix_ring)   // drivers/net/ethernet/intel/igb/igb_main.c:968
        |- igb_irq_enable(adapter)              // drivers/net/ethernet/intel/igb/igb_main.c:3978<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 在 <code>igb_open</code> 函数调用的深处，对于多队列网卡，通过 <code>request_irq(igb_msix_ring)</code> 为每个队列都注册了中断处理函数 <code>igb_msix_ring</code> 。设置好中断处理程序后，再调用 <code>igb_irq_enable(adapter)</code> 来开启中断。</p>
</li>
</ol>
<h3 id="4-Intel的igb网卡驱动的接收流程"><a href="#4-Intel的igb网卡驱动的接收流程" class="headerlink" title="4. Intel的igb网卡驱动的接收流程"></a>4. Intel的igb网卡驱动的接收流程</h3><p>当网卡的某个队列中收到网络数据后，会触发一个中断，这个中断的处理函数就是在启动设备时设置的 <code>igb_msix_ring</code> 函数：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_msix_ring                                   // drivers/net/ethernet/intel/igb/igb_main.c:6621
    |- napi_schedule                            // drivers/net/ethernet/intel/igb/igb_main.c:6628
        |- __napi_schedule                      // include/linux/netdevice.h:445
            |- ____napi_schedule                // net/core/dev.c:5892<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>网卡队列中断处理函数最深处的调用 <code>____napi_schedule</code> 主要做两件事：</p>
<ul>
<li>保存待处理的数据。</li>
<li>触发中断 <code>NET_RX_SOFTIRQ</code> 。</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">____napi_schedule</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">softnet_data</span> <span class="token operator">*</span>sd<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>napi<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>napi<span class="token operator">-&gt;</span>poll_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sd<span class="token operator">-&gt;</span>poll_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__raise_softirq_irqoff</span><span class="token punctuation">(</span>NET_RX_SOFTIRQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而中断 <code>NET_RX_SOFTIRQ</code> 的处理函数是 <code>net_rx_action</code> ：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">net_rx_action           // net/core/dev.c:9874
    |- napi_poll        // net/core/dev.c:6338
        |- n-&gt;poll()    // net/core/dev.c:6272<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>中断处理函数 <code>net_rx_action</code> ，最终的会调用函数 <code>n-&gt;poll()</code> 。这函数就是网卡驱动模块加载时注册的处理回调函数 <code>igb_poll</code> ：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">igb_poll                                                // drivers/net/ethernet/intel/igb/igb_main.c:1216
    |- igb_clean_rx_irq                                 // drivers/net/ethernet/intel/igb/igb_main.c:7759
        |- napi_gro_receive                             // drivers/net/ethernet/intel/igb/igb_main.c:8408
            |- napi_skb_finish                          // net/core/dev.c:5631
                |- netif_receive_skb_internal           // net/core/dev.c:5600
                    |- __netif_receive_skb              // net/core/dev.c:5156
                        |- __netif_receive_skb_one_core // net/core/dev.c:5066
                            |- __netif_receive_skb_core // net/core/dev.c:4952<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数 <code>__netif_receive_skb_core</code> 中：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__netif_receive_skb_core</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token operator">*</span>pskb<span class="token punctuation">,</span> bool pfmemalloc<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> <span class="token class-name">packet_type</span> <span class="token operator">*</span><span class="token operator">*</span>ppt_prev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">list_for_each_entry_rcu</span><span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptype_all<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_prev<span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token function">deliver_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> pt_prev<span class="token punctuation">,</span> orig_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pt_prev <span class="token operator">=</span> ptype<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">list_for_each_entry_rcu</span><span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> <span class="token operator">&amp;</span>skb<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>ptype_all<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_prev<span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token function">deliver_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> pt_prev<span class="token punctuation">,</span> orig_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pt_prev <span class="token operator">=</span> ptype<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">deliver_ptype_list_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pt_prev<span class="token punctuation">,</span> orig_dev<span class="token punctuation">,</span> type<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>ptype_base<span class="token punctuation">[</span><span class="token function">ntohs</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
                        PTYPE_HASH_MASK<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个循环 <code>list_for_each_entry_rcu(ptype, &amp;ptype_all, list)</code> 中的 <code>ptype_all</code> 是一个设备无关的保存有所有协议处理回调的地方，而第二个循环 <code>list_for_each_entry_rcu(ptype, &amp;skb-&gt;dev-&gt;ptype_all, list)</code> 中的 <code>skb-&gt;dev-&gt;ptype_all</code> 是一个设备有关的保存有所有协议处理回调的地方。这两个循环就能让像 tcpdump 这样的程序监听处理到收到的所有的网络包。</p>
<p>后面代码 <code>deliver_ptype_list_skb</code> 中的 <code>ptype_base</code> 是保存所有支持的3层协议处理函数的地方。才是将包转发给对应L3处理函数。函数 <code>deliver_ptype_list_skb</code> 的调用流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">deliver_ptype_list_skb      // net/core/dev.c:4905
    |- deliver_skb          // net/core/dev.c:1971
        |- pt_prev-&gt;func()  // net/core/dev.c:1956<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对于 IP 协议来说，其注册到 <code>ptype_base</code> 的流程如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">inet_init                               // net/ipv4/af_inet.c:1890
    |- dev_add_pack(&amp;ip_packet_type)    // net/core/dev.c:408<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>dev_add_pack(&amp;ip_packet_type)</code> 函数内部就是把 <code>ip_packet_type</code> 添加到处理 <code>ETH_P_IP</code> 的协议链中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">packet_type</span> ip_packet_type __read_mostly <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token function">cpu_to_be16</span><span class="token punctuation">(</span>ETH_P_IP<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>func <span class="token operator">=</span> ip_rcv<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>list_func <span class="token operator">=</span> ip_list_rcv<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-接收IP包"><a href="#5-接收IP包" class="headerlink" title="5. 接收IP包"></a>5. 接收IP包</h3><p>所以对 IP 来说 <code>pt_prev-&gt;func()</code> 实际调用的是 <code>ip_rcv</code> 函数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ip_rcv                                  // ip_packet_type:1886
    |- ip_rcv_finish                    // net/ipv4/ip_input.c:526
        |- dst_input                    // net/ipv4/ip_input.c:414
            |- skb_dst(skb)-&gt;input(skb) // include/net/dst.h:461<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对 TCP/IPv4 来说 <code>skb_dst(skb)-&gt;input(skb)</code> 调用的其实是 <code>net/ipv4/ip_input.c</code> 文件中的 <code>ip_local_deliver</code> 。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ip_local_deliver                // net/ipv4/route.c:1638
    |- ip_local_deliver_finish  // net/ipv4/ip_input.c:258
        |- ipprot-&gt;handler(skb) // net/ipv4/ip_input.c:215<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里调用的 <code>ipprot-&gt;handler(skb)</code> 就是传输层的处理回调了。 在文件 <code>net/ipv4/af_inet.c</code> 中的函数 <code>inet_init</code> 内初始化：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">inet_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icmp_protocol<span class="token punctuation">,</span> IPPROTO_ICMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udp_protocol<span class="token punctuation">,</span> IPPROTO_UDP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_protocol<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>igmp_protocol<span class="token punctuation">,</span> IPPROTO_IGMP<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1492374">Linux syscall过程分析（万字长文）</a><br><a target="_blank" rel="noopener" href="https://xinqiu.gitbooks.io/linux-insides-cn/content/SysCall/linux-syscall-2.html">Linux 内核如何处理系统调用</a><br><a target="_blank" rel="noopener" href="https://blog.packagecloud.io/eng/2017/02/06/monitoring-tuning-linux-networking-stack-sending-data/">Monitoring and Tuning the Linux Networking Stack: Sending Data</a><br><a target="_blank" rel="noopener" href="https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/">Monitoring and Tuning the Linux Networking Stack: Receiving Data</a></p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/jie-he-linux-nei-he-yuan-ma-fen-xi-tcp-xie-yi-zhuang-tai-ji/">https://kibazen.cn/jie-he-linux-nei-he-yuan-ma-fen-xi-tcp-xie-yi-zhuang-tai-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%86%85%E6%A0%B8%E5%88%86%E6%9E%90/">
                                    <span class="chip bg-color">内核分析</span>
                                </a>
                            
                                <a href="/tags/Ubuntu/">
                                    <span class="chip bg-color">Ubuntu</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/tcp-zhong-de-keepalive-ji-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/12.jpg" class="responsive-img" alt="TCP中的keepalive机制">
                        
                        <span class="card-title">TCP中的keepalive机制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BD%91%E7%BB%9C/" class="post-category">
                                    网络
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/TCP/">
                        <span class="chip bg-color">TCP</span>
                    </a>
                    
                    <a href="/tags/keepalive/">
                        <span class="chip bg-color">keepalive</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/she-ji-mo-shi-zhi-mei-xue-xi-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/3.jpg" class="responsive-img" alt="《设计模式之美》学习笔记">
                        
                        <span class="card-title">《设计模式之美》学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                        <span class="chip bg-color">极客时间</span>
                    </a>
                    
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="chip bg-color">设计模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (true) {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 木叶禅<br />'
            + '文章作者: Kiba Amor<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者木叶禅所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">221.1k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>









    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=562236616" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 562236616" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/kibaamor" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kibaamor" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
