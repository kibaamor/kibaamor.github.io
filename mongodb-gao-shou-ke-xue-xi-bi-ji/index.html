<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="《MongoDB高手课》学习笔记, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="You are too concerned with what was and what will be">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>《MongoDB高手课》学习笔记 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>Learn</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/memo/" class="waves-effect waves-light">
      
      <i class="fas fa-sticky-note" style="zoom: 0.6;"></i>
      
      <span>Memo</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            You are too concerned with what was and what will be
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			Learn
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/memo/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sticky-note"></i>
			
			Memo
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'f65e070788a2647953051a7a1b70ada7fd2b3f70cd4d93c977207f5b762987d4';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">《MongoDB高手课》学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                <span class="chip bg-color">极客时间</span>
                            </a>
                        
                            <a href="/tags/MongoDB/">
                                <span class="chip bg-color">MongoDB</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-07-03
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-10-08
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    16.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    62 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/geektime-mongodb-course">https://github.com/kibaamor/geektime-mongodb-course</a></p>
<h2 id="第一章：MongoDB再入门"><a href="#第一章：MongoDB再入门" class="headerlink" title="第一章：MongoDB再入门"></a>第一章：MongoDB再入门</h2><h3 id="03-认识文档数据库MongoDB"><a href="#03-认识文档数据库MongoDB" class="headerlink" title="03 | 认识文档数据库MongoDB"></a>03 | 认识文档数据库MongoDB</h3><h4 id="关于-MongoDB"><a href="#关于-MongoDB" class="headerlink" title="关于 MongoDB"></a>关于 MongoDB</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Q</th>
<th>A</th>
</tr>
</thead>
<tbody>
<tr>
<td>什么是 MongoDB</td>
<td>-个以JSON 为数据模型的文档数据库</td>
</tr>
<tr>
<td>为什么叫文档数据库?</td>
<td>文档来自于”JSON Document”，并非我们一般理解的 PDF，WORD文档</td>
</tr>
<tr>
<td>谁开发 MongDB?</td>
<td>上市公司 MongoDB Inc.，总部位于美国纽约。</td>
</tr>
<tr>
<td>主要用途</td>
<td>应用数据库，类似于 Oracle,MySOL海量数据处理，数据平台</td>
</tr>
<tr>
<td>主要特点</td>
<td>建模为可选、JSON 数据模型比较适合开发者、横向扩展可以支撑很大数据量和并发</td>
</tr>
<tr>
<td>MongoDB 是免费的吗?</td>
<td>MongoDB 有两个发布版本:社区版和企业版。社区版是基于 SSPL，一种和 AGPL 基本类似的开源协议企业版是基于商业协议，需付费使用</td>
</tr>
</tbody>
</table>
</div>
<h4 id="MongoDB-版本变迁"><a href="#MongoDB-版本变迁" class="headerlink" title="MongoDB 版本变迁"></a>MongoDB 版本变迁</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB版本变迁.png" alt="MongoDB版本变迁"></p>
<h4 id="MongoDB和关系型数据库"><a href="#MongoDB和关系型数据库" class="headerlink" title="MongoDB和关系型数据库"></a>MongoDB和关系型数据库</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB和关系型数据库.png" alt="MongoDB和关系型数据库"></p>
<blockquote>
<p>MongoDB 使用 <code>B+</code> 树 和 BSON（二进制 JSON） 组合来存储和管理数据。</p>
</blockquote>
<h3 id="04-MongoDB特色及优势"><a href="#04-MongoDB特色及优势" class="headerlink" title="04 | MongoDB特色及优势"></a>04 | MongoDB特色及优势</h3><h4 id="MongoDB的优势"><a href="#MongoDB的优势" class="headerlink" title="MongoDB的优势"></a>MongoDB的优势</h4><ol>
<li>简单直观:以自然的方式来建模，以直观的方式来与数据库交互</li>
<li>结构灵活:弹性模式从容响应需求的频繁变化</li>
<li>快速开发:做更多的事，写更少的代码</li>
</ol>
<h4 id="灵活"><a href="#灵活" class="headerlink" title="灵活"></a>灵活</h4><ul>
<li>多形性：同一个集合中可以包含不同字段（类型）的文档对象</li>
<li>动态性：线上修改数据模式，修改时应用与数据库均无须下线</li>
<li>数据治理：支持使用 JSON Schema 来规范数据模式。在保证模式 灵活动态的前提下，提供数据治理能力</li>
</ul>
<h4 id="快速"><a href="#快速" class="headerlink" title="快速"></a>快速</h4><ul>
<li>数据库引擎只需要在一个存储区读写</li>
<li>反范式、无关联的组织极大优化查询速度</li>
<li>程序API自然，开发快速</li>
</ul>
<h4 id="原生的高可用"><a href="#原生的高可用" class="headerlink" title="原生的高可用"></a>原生的高可用</h4><ul>
<li>Replica Set-2 to 50 个成员</li>
<li>自恢复</li>
<li>多中心容灾能力</li>
<li>滚动服务-最小化服务终端</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/原生的高可用.png" alt="原生的高可用"></p>
<h4 id="横向扩展能力"><a href="#横向扩展能力" class="headerlink" title="横向扩展能力"></a>横向扩展能力</h4><ul>
<li>需要的时候无缝扩展</li>
<li>应用全透明</li>
<li>多种数据分布策略</li>
<li>轻松支持 TB-PB 数量级</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/横向扩展能力.png" alt="横向扩展能力"></p>
<h4 id="MongoDB-技术优势总结"><a href="#MongoDB-技术优势总结" class="headerlink" title="MongoDB 技术优势总结"></a>MongoDB 技术优势总结</h4><ul>
<li>JSON 结构和对象模型接近，开发代码量低</li>
<li>JSON 的动态模型意味着更容易响应新的业务需求</li>
<li>复制集提供 99.999% 高可用</li>
<li>分片架构支持海量数据和无缝扩容</li>
</ul>
<h3 id="06-MongoDB基本操作"><a href="#06-MongoDB基本操作" class="headerlink" title="06 | MongoDB基本操作"></a>06 | MongoDB基本操作</h3><h4 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 插入</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"apple"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	<span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"apple"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"pear"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"orange"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><ul>
<li>find 相当于SQL中的SELECT。</li>
<li>find 返回的是游标</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"year"</span><span class="token operator">:</span> <span class="token number">1975</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//单条件查询</span>
db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"year"</span><span class="token operator">:</span> <span class="token number">1989</span><span class="token punctuation">,</span><span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"Batman"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//多条件and查询</span>
db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$and<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"Batman"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"category"</span><span class="token operator">:</span> <span class="token string">"action"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//and的另一种形式</span>
db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$or<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"year"</span><span class="token operator">:</span> <span class="token number">1989</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"Batman"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//多条件or查询</span>
db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^B</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token comment">//按正则表达式查找</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询条件对照表</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>SQL</th>
<th>MQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>a = 1</td>
<td><code>{a: 1}</code></td>
</tr>
<tr>
<td>a &lt;&gt; 1</td>
<td><code>{a: {$ne: 1}}</code></td>
</tr>
<tr>
<td>a &gt; 1</td>
<td><code>{a: {$gt: 1}}</code></td>
</tr>
<tr>
<td>a &gt;= 1</td>
<td><code>{a: {$gte: 1}}</code></td>
</tr>
<tr>
<td>a &lt; 1</td>
<td><code>{a: {$lt: 1}}</code></td>
</tr>
<tr>
<td>a &lt;= 1</td>
<td><code>{a: {$lte: 1}}</code></td>
</tr>
<tr>
<td>a = 1 AND b = 1</td>
<td><code>{a: 1, b: 1}或{$and: [{a: 1}, {b: 1}]}</code></td>
</tr>
<tr>
<td>a = 1 OR b = 1</td>
<td><code>{$or: [{a: 1}, {b: 1}]}</code></td>
</tr>
<tr>
<td>a IS NULL</td>
<td><code>{a: {$exists: false}}</code></td>
</tr>
<tr>
<td>a IN (1, 2, 3)</td>
<td><code>{a: {$in: [1, 2, 3]}}}</code></td>
</tr>
</tbody>
</table>
</div>
<p>查询逻辑运算符</p>
<ul>
<li><code>$lt</code>:存在并小于</li>
<li><code>$lte</code>:存在并小于等于</li>
<li><code>$gt</code>: 存在并大于</li>
<li><code>$gte</code>:存在并大于等于</li>
<li><code>$ne</code>:不存在或存在但不等于</li>
<li><code>$in</code>:存在并在指定数组中</li>
<li><code>$nin</code>:不存在或不在指定数组中</li>
<li><code>$or</code>: 匹配两个或多个条件中的一个</li>
<li><code>$and</code>:匹配全部条件</li>
</ul>
<h4 id="子文档查询"><a href="#子文档查询" class="headerlink" title="子文档查询"></a>子文档查询</h4><p>find 支持使用 “field.sub_field” 的形式查询子文档。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">"apple"</span>
    <span class="token keyword">from</span><span class="token operator">:</span><span class="token punctuation">{</span>
        country<span class="token operator">:</span><span class="token string">"China"</span>
        province<span class="token operator">:</span><span class="token string">"Guangdong"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 考虑一下查询的意义</span>
<span class="token comment">// 能查询到上面插入的文档</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"from.country"</span><span class="token operator">:</span> <span class="token string">"China"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 查询一个文档中有一个字段"from",其值为 `{country: "China"}` 的记录，查询不到上面插入的文档</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"from"</span><span class="token operator">:</span> <span class="token punctuation">{</span>country<span class="token operator">:</span> <span class="token string">"China"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="搜索数组"><a href="#搜索数组" class="headerlink" title="搜索数组"></a>搜索数组</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Apple"</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Mango"</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"yellow"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 返回第一条数据</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">"red"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 返回两条数据</span>
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$or<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">"red"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token string">"yellow"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另一个例子</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"Raiders of the Lost Ark"</span><span class="token punctuation">,</span>
    <span class="token string">"filming_locations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"city"</span><span class="token operator">:</span> <span class="token string">"Los Angeles"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token operator">:</span> <span class="token string">"CA"</span><span class="token punctuation">,</span> <span class="token string">"country"</span><span class="token operator">:</span> <span class="token string">"USA"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"city"</span><span class="token operator">:</span> <span class="token string">"Rome"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token operator">:</span> <span class="token string">"Lazio"</span><span class="token punctuation">,</span> <span class="token string">"country"</span><span class="token operator">:</span> <span class="token string">"Italy"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"city"</span><span class="token operator">:</span> <span class="token string">"Florence"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token operator">:</span> <span class="token string">"SC"</span><span class="token punctuation">,</span> <span class="token string">"country"</span><span class="token operator">:</span> <span class="token string">"USA"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 查找城市是 Rome 的记录</span>
db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"filming_locations.city"</span><span class="token operator">:</span> <span class="token string">"Rome"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在数组中搜索子对象的多个字段时，如果使用 <code>$elemMatch</code>，它表示必须是同一个子对象满足多个条件。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 查询满足 city 是 Rome 或者 country 是 USA 的文档</span>
db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"filming_locations.city"</span><span class="token operator">:</span><span class="token string">"Rome"</span><span class="token punctuation">,</span>
    <span class="token string">"filming_locations.country"</span><span class="token operator">:</span><span class="token string">"USA"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 查询 满足 city 是 Rome 且 country 是 USA 的文档</span>
db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"filming_locations"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        $elemMatch<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">"city"</span><span class="token operator">:</span><span class="token string">"Rome"</span><span class="token punctuation">,</span><span class="token string">"country"</span><span class="token operator">:</span><span class="token string">"USA"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="控制-find-返回的字段"><a href="#控制-find-返回的字段" class="headerlink" title="控制 find 返回的字段"></a>控制 find 返回的字段</h4><ul>
<li>find 可以指定只返回指定的字段,</li>
<li>id 字段必须明确指明不返回，否则默认返回;</li>
<li>在 MongoDB 中我们称这为投影(projection);</li>
<li><code>db.movies.find({"category": "action"},{"_id":0, title:1})</code>：不返回 <code>_id</code>，返回 <code>title</code>。</li>
</ul>
<h4 id="使用-remove-删除文档"><a href="#使用-remove-删除文档" class="headerlink" title="使用 remove 删除文档"></a>使用 remove 删除文档</h4><ul>
<li>remove 命令需要配合查询条件使用</li>
<li>匹配查询条件的的文档会被删除;</li>
<li>指定一个空文档条件会删除所有文档</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>testcol<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> # 删除 a 等于<span class="token number">1</span> 的记录
db<span class="token punctuation">.</span>testcol<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token punctuation">{</span>$lt<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> # 删除 a 小于<span class="token number">5</span>的记录
db<span class="token punctuation">.</span>testcol<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> # 删除所有记录
db<span class="token punctuation">.</span>testcol<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # 报错<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用-update-更新文档"><a href="#使用-update-更新文档" class="headerlink" title="使用 update 更新文档"></a>使用 update 更新文档</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"apple"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"pear"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"orange"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

# 更新多条使用 updateMany，第一项为查询条件，第二项为更新内容，支持$set<span class="token operator">/</span>$unset<span class="token punctuation">,</span> $push<span class="token operator">/</span>$pushAll<span class="token operator">/</span>$pop<span class="token punctuation">,</span> $pull<span class="token operator">/</span>$pullAll<span class="token punctuation">,</span> $addToSet
db<span class="token punctuation">.</span>fruit<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">"apple"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>$set<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">from</span><span class="token operator">:</span> <span class="token string">"China"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>使用 updateOne 表示无论条件匹配多少条记录，始终只更新第一条;</li>
<li>使用 updateMany 表示条件匹配多少条就更新多少条;</li>
<li>updateOne/updateMany方法要求更新条件部分必须具有以下之一，否则将报错:<ul>
<li>$set/$unset</li>
<li>$push/$pushAll/$pop</li>
<li>$pull/$pulLAl</li>
<li>$addToSet</li>
</ul>
</li>
</ul>
<p>意义</p>
<ul>
<li>$push: 增加一个对象到数组底部</li>
<li>$pushAll: 增加多个对象到数组底部</li>
<li>$pop: 从数组底部删除一个对象</li>
<li>$pul: 如果匹配指定的值，从数组中删除相应的对象</li>
<li>$pullAll: 如果匹配任意的值，从数据中删除相应的对象</li>
<li>$addToSet: 如果不存在则增加一个值到数组</li>
</ul>
<h4 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h4><ul>
<li>使用 <code>db.&lt;集合&gt;.drop()</code> 来删除一个集合</li>
<li>集合中的全部文档都会被删除</li>
<li>集合相关的索引也会被删除 <code>db.colToBeDropped.drop()</code></li>
</ul>
<h4 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h4><ul>
<li>使用 <code>db.dropDatabase()</code>来删除数据库</li>
<li>数据库相应文件也会被删除，磁盘空间将被释放</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">use tempDB
db<span class="token punctuation">.</span><span class="token function">dropDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
show collections <span class="token comment">//No collections</span>
show dbs <span class="token comment">//The db is gone</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="08-聚合查询"><a href="#08-聚合查询" class="headerlink" title="08 | 聚合查询"></a>08 | 聚合查询</h3><h4 id="什么是-MongoDB-聚合框架"><a href="#什么是-MongoDB-聚合框架" class="headerlink" title="什么是 MongoDB 聚合框架"></a>什么是 MongoDB 聚合框架</h4><p>MongoDB聚合框架(Aggregation Framework)是一个计算框架，它可以:</p>
<ul>
<li>作用在一个或几个集合上;</li>
<li>对集合中的数据进行的一系列运算;</li>
<li>将这些数据转化为期望的形式;</li>
</ul>
<p>从效果而言，聚合框架相当于 SOL 查询中的:</p>
<ul>
<li>GROUP BY</li>
<li>LEFT OUTER JOIN</li>
<li>AS等</li>
</ul>
<h4 id="管道和步骤"><a href="#管道和步骤" class="headerlink" title="管道和步骤"></a>管道和步骤</h4><p>整个聚合运算过程称为管道(Pipeline)，它是由多个步骤(Stage)组成的每个管道:</p>
<ul>
<li>接受一系列文档(原始数据)</li>
<li>每个步骤对这些文档进行一系列运算;</li>
<li>结果文档输出给下一个步骤;</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/管道和步骤.png" alt="管道和步骤"></p>
<h4 id="聚合运算的基本格式"><a href="#聚合运算的基本格式" class="headerlink" title="聚合运算的基本格式"></a>聚合运算的基本格式</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>$stage1<span class="token punctuation">,</span> $stage2<span class="token punctuation">,</span> <span class="token operator">...</span> $stageN<span class="token punctuation">]</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token constant">COLLECTION</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    pipeline<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> options <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="常见步骤"><a href="#常见步骤" class="headerlink" title="常见步骤"></a>常见步骤</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/聚合常见步骤.png" alt="聚合常见步骤"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/聚合常见步骤2.png" alt="聚合常见步骤2"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/常见步骤中的运算符.png" alt="常见步骤中的运算符"></p>
<h4 id="聚合运算的使用场景"><a href="#聚合运算的使用场景" class="headerlink" title="聚合运算的使用场景"></a>聚合运算的使用场景</h4><p>聚合查询可以用于 OLAP 和 OLTP 场景。例如:</p>
<blockquote>
<p>OLTP (Online Transaction Processing,联机事务处理)，OLAP (Online Analytical Processing,联机分析处理)</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/聚合查询可以用于OLAP和OLTP场景.png" alt="聚合查询可以用于OLAP和OLTP场景"></p>
<h4 id="MQL常用步骤与SQL对比"><a href="#MQL常用步骤与SQL对比" class="headerlink" title="MQL常用步骤与SQL对比"></a>MQL常用步骤与SQL对比</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MQL常用步骤与SQL对比1.png" alt="MQL常用步骤与SQL对比1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MQL常用步骤与SQL对比2.png" alt="MQL常用步骤与SQL对比2"></p>
<h4 id="MQL特有步骤"><a href="#MQL特有步骤" class="headerlink" title="MQL特有步骤"></a>MQL特有步骤</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MQL特有步骤unwind.png" alt="MQL特有步骤unwind"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MQL特有步骤bucket.png" alt="MQL特有步骤bucket"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MQL特有步骤facet.png" alt="MQL特有步骤facet"></p>
<h3 id="10-复制集机制及原理"><a href="#10-复制集机制及原理" class="headerlink" title="10 | 复制集机制及原理"></a>10 | 复制集机制及原理</h3><h4 id="复制集的作用"><a href="#复制集的作用" class="headerlink" title="复制集的作用"></a>复制集的作用</h4><ol>
<li><p>MongoDB 复制集的主要意义在于实现服务高可用。</p>
</li>
<li><p>它的现实依赖于两个方面的功能:</p>
<ul>
<li>数据写入时将数据迅速复制到另一个独立节点上</li>
<li>在接受写入的节点发生故障时自动选举出一个新的替代节点</li>
</ul>
</li>
<li><p>在实现高可用的同时，复制集实现了其他几个附加作用</p>
<ul>
<li>数据分发:将数据从一个区域复制到另一个区域，减少另一个区域的读延迟</li>
<li>读写分离:不同类型的压力分别在不同的节点上执行</li>
<li>异地容灾:在数据中心故障时候快速切换到异地</li>
</ul>
</li>
</ol>
<h4 id="典型复制集结构"><a href="#典型复制集结构" class="headerlink" title="典型复制集结构"></a>典型复制集结构</h4><p>一个典型的复制集由3个以上具有投票权的节点组成，包括:</p>
<ul>
<li>一个主节点(PRIMARY):接受写入操作和选举时投票</li>
<li>两个(或多个)从节点(SECONDARY):复制主节点上的新数据和选举时投票</li>
<li>不推荐使用Arbiter(投票节点)</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/典型复制集结构.png" alt="典型复制集结构"></p>
<h4 id="数据是如何复制的"><a href="#数据是如何复制的" class="headerlink" title="数据是如何复制的?"></a>数据是如何复制的?</h4><ul>
<li>一个修改操作，当无论是插入、更新或删除，到达主节点时，它对数据的操作将被记录下来(经过一-些必要的转换)，这些记录称为 oplog。</li>
<li>从节点通过在主节点上打开一个 tailable 游标不断获取新进入主节点的 oplog，并在自己的数据上回放，以此保持跟主节点的数据一致。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据是如何复制的.png" alt="数据是如何复制的"></p>
<h4 id="通过选举完成故障恢复"><a href="#通过选举完成故障恢复" class="headerlink" title="通过选举完成故障恢复"></a>通过选举完成故障恢复</h4><ul>
<li>具有投票权的节点之间两两互相发送心跳，</li>
<li>当5次心跳未收到时判断为节点失联，</li>
<li>如果失联的是主节点，从节点会发起选举，选出新的主节点，</li>
<li>如果失联的是从节点则不会产生新的选举，</li>
<li>选举基于 <strong>RAFT一致性算法</strong> 实现，选举成功的必要条件是大多数投票节点存活;</li>
<li>复制集中最多可以有50个节点，但具有投票权的节点最多7个</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/通过选举完成故障恢复.png" alt="通过选举完成故障恢复"></p>
<h4 id="影响选举的因素"><a href="#影响选举的因素" class="headerlink" title="影响选举的因素"></a>影响选举的因素</h4><ul>
<li>整个集群必须有大多数节点存活;</li>
<li>被选举为主节点的节点必须:<ul>
<li>能够与多数节点建立连接</li>
<li>具有较新的 oplog</li>
<li>具有较高的优先级(如果有配置)</li>
</ul>
</li>
</ul>
<h4 id="常见选项"><a href="#常见选项" class="headerlink" title="常见选项"></a>常见选项</h4><p>复制集节点有以下常见的选配项:</p>
<ul>
<li>是否具有投票权(v 参数):有则参与投票;</li>
<li>优先级(priority 参数):优先级越高的节点越优先成为主节点。优先级为0的节点无法成为主节点;</li>
<li>隐藏(hidden 参数):复制数据，但对应用不可见。隐藏节点可以具有投票仅，但优先级必须为0;</li>
<li>延迟(slaveDelay 参数):复制n秒之前的数据，保持与主节点的时间差</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/复制集常见选项.png" alt="复制集常见选项"></p>
<h4 id="复制集注意事项"><a href="#复制集注意事项" class="headerlink" title="复制集注意事项"></a>复制集注意事项</h4><ul>
<li><p>关于硬件:</p>
<ul>
<li>因为正常的复制集节点都有可能成为主节点，它们的地位是一样的，因此硬件配置上必须一致;</li>
<li>为了保证节点不会同时宕机，各节点使用的硬件必须具有独立性。</li>
</ul>
</li>
<li><p>关于软件:</p>
<ul>
<li>复制集各节点软件版本必须一致，以避免出现不可预知的问题。</li>
</ul>
</li>
<li><p>增加节点不会增加系统写性能!</p>
</li>
</ul>
<h3 id="11-实验：搭建MongoDB复制集"><a href="#11-实验：搭建MongoDB复制集" class="headerlink" title="11 | 实验：搭建MongoDB复制集"></a>11 | 实验：搭建MongoDB复制集</h3><h4 id="启动-3-个-MongoDB-实例"><a href="#启动-3-个-MongoDB-实例" class="headerlink" title="启动 3 个 MongoDB 实例"></a>启动 3 个 MongoDB 实例</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2404-8.0.11.tgz
<span class="token function">tar</span> xf mongodb-linux-x86_64-ubuntu2404-8.0.11.tgz
<span class="token builtin class-name">cd</span> mongodb-linux-x86_64-ubuntu2404-8.0.11

<span class="token function">mkdir</span> -p db<span class="token punctuation">{</span><span class="token number">1,2</span>,3<span class="token punctuation">}</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ./db1/mongod.conf</span>
systemLog:
  destination: file
  path: ./db1/mongod.log
  logAppend: true
storage:
  dbPath: ./db1
net:
  bindIp: 0.0.0.0
  port: 28017
replication:
  replSetName: rs0
processManagement:
  fork: true
EOF</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ./db2/mongod.conf</span>
systemLog:
  destination: file
  path: ./db2/mongod.log
  logAppend: true
storage:
  dbPath: ./db2
net:
  bindIp: 0.0.0.0
  port: 28018
replication:
  replSetName: rs0
processManagement:
  fork: true
EOF</span>


<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ./db3/mongod.conf</span>
systemLog:
  destination: file
  path: ./db3/mongod.log
  logAppend: true
storage:
  dbPath: ./db3
net:
  bindIp: 0.0.0.0
  port: 28019
replication:
  replSetName: rs0
processManagement:
  fork: true
EOF</span>

./bin/mongod -f ./db1/mongod.conf
./bin/mongod -f ./db2/mongod.conf
./bin/mongod -f ./db3/mongod.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置复制集"><a href="#配置复制集" class="headerlink" title="配置复制集"></a>配置复制集</h4><p>安装mongosh</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://downloads.mongodb.com/compass/mongosh-2.5.5-linux-x64.tgz
<span class="token function">tar</span> xf mongosh-2.5.5-linux-x64.tgz
<span class="token builtin class-name">cd</span> mongosh-2.5.5-linux-x64/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><blockquote>
<p>注意：此方式 hostname 需要能被解析</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./mongosh --port <span class="token number">28017</span>

test<span class="token operator">&gt;</span> rs.<span class="token function-name function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  info2: <span class="token string">'no configuration specified. Using a default configuration for the set'</span>,
  me: <span class="token string">'CTU-WKS-AB847:28017'</span>,
  ok: <span class="token number">1</span>,
  <span class="token string">'<span class="token variable">$clusterTime</span>'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    clusterTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878515</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    signature: <span class="token punctuation">{</span>
      hash: Binary.createFromBase64<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAA='</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
      keyId: Long<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  operationTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878515</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

rs0 <span class="token punctuation">[</span>direct: secondary<span class="token punctuation">]</span> test<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">"CTU-WKS-AB847:28018"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ok: <span class="token number">1</span>,
  <span class="token string">'<span class="token variable">$clusterTime</span>'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    clusterTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878612</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    signature: <span class="token punctuation">{</span>
      hash: Binary.createFromBase64<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAA='</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
      keyId: Long<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  operationTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878612</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

rs0 <span class="token punctuation">[</span>direct: primary<span class="token punctuation">]</span> test<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">"CTU-WKS-AB847:28019"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ok: <span class="token number">1</span>,
  <span class="token string">'<span class="token variable">$clusterTime</span>'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    clusterTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878630</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    signature: <span class="token punctuation">{</span>
      hash: Binary.createFromBase64<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAA='</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
      keyId: Long<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  operationTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751878630</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

rs0 <span class="token punctuation">[</span>direct: primary<span class="token punctuation">]</span> test<span class="token operator">&gt;</span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  set: <span class="token string">'rs0'</span>,
  date: ISODate<span class="token punctuation">(</span><span class="token string">'2025-07-07T08:58:16.809Z'</span><span class="token punctuation">)</span>,
  myState: <span class="token number">1</span>,
  term: Long<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>,
  syncSourceHost: <span class="token string">''</span>,
  syncSourceId: -1,
  heartbeatIntervalMillis: Long<span class="token punctuation">(</span><span class="token string">'2000'</span><span class="token punctuation">)</span>,
  majorityVoteCount: <span class="token number">2</span>,
  writeMajorityCount: <span class="token number">2</span>,
  votingMembersCount: <span class="token number">3</span>,
  writableVotingMembersCount: <span class="token number">3</span>,
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./mongosh --port <span class="token number">28017</span>

test<span class="token operator">&gt;</span> rs.initiate<span class="token punctuation">(</span><span class="token punctuation">{</span>
    _id: <span class="token string">"rs0"</span>,
    members: <span class="token punctuation">[</span><span class="token punctuation">{</span>
        _id:0, 
        host: <span class="token string">"localhost:28017"</span>
    <span class="token punctuation">}</span>,<span class="token punctuation">{</span>
        _id:1, 
        host: <span class="token string">"localhost:28018"</span>
    <span class="token punctuation">}</span>,<span class="token punctuation">{</span>
        _id:2, 
        host: <span class="token string">"localhost:28019"</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ok: <span class="token number">1</span>,
  <span class="token string">'<span class="token variable">$clusterTime</span>'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    clusterTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751879103</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    signature: <span class="token punctuation">{</span>
      hash: Binary.createFromBase64<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAA='</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
      keyId: Long<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  operationTime: Timestamp<span class="token punctuation">(</span><span class="token punctuation">{</span> t: <span class="token number">1751879103</span>, i: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><h5 id="在主节点上写"><a href="#在主节点上写" class="headerlink" title="在主节点上写"></a>在主节点上写</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./mongosh --port <span class="token number">28017</span>

rs0 <span class="token punctuation">[</span>direct: primary<span class="token punctuation">]</span> test<span class="token operator">&gt;</span> db.test.insertOne<span class="token punctuation">(</span><span class="token punctuation">{</span>a:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  acknowledged: true,
  insertedId: ObjectId<span class="token punctuation">(</span><span class="token string">'686b8e5e2e3134769f32a03d'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="在从节点上读"><a href="#在从节点上读" class="headerlink" title="在从节点上读"></a>在从节点上读</h5><p>在 MongoDB 的 复制集环境中，默认情况下：</p>
<ul>
<li>只允许从 Primary 节点读取数据</li>
<li>直接访问 Secondary 节点会被拒绝（抛出 not master 错误）</li>
</ul>
<p>为了在 Secondary 节点上也允许读取，MongoDB 提供了 <code>rs.slaveOk()</code> 这个方法。</p>
<blockquote>
<p>使用mongosh 连接从节点时不再需要手动运行 <code>rs.secondaryOk()</code> 便可以直接读取数据。 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/mongodb-shell/reference/compatibility/#read-preference-behavior">Read Preference Behavior</a></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./mongosh --port <span class="token number">28018</span>

rs0 <span class="token punctuation">[</span>direct: secondary<span class="token punctuation">]</span> test<span class="token operator">&gt;</span> db.test.find<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">{</span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">'686b8e5e2e3134769f32a03d'</span><span class="token punctuation">)</span>, a: <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="12-MongoDB全家桶"><a href="#12-MongoDB全家桶" class="headerlink" title="12 | MongoDB全家桶"></a>12 | MongoDB全家桶</h3><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB全家桶.png" alt="MongoDB全家桶"></p>
<h4 id="Mongodump-mongorestore"><a href="#Mongodump-mongorestore" class="headerlink" title="Mongodump/mongorestore"></a>Mongodump/mongorestore</h4><ul>
<li>类似于 MySQL的 dump/restore 工具</li>
<li>可以完成全库 dump: 不加条件</li>
<li>也可以根据条件 dump 部分数据: -q 参数</li>
<li>Dump 的同时跟踪数据就更:—oplog</li>
<li>Restore 是反操作，把mongodump的输出导入到 mongodb</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2404-x86_64-100.12.2.tgz
<span class="token function">tar</span> xf mongodb-database-tools-ubuntu2404-x86_64-100.12.2.tgz
<span class="token builtin class-name">cd</span> mongodb-database-tools-ubuntu2404-x86_64-100.12.2/bin

./mongodump -h <span class="token number">127.0</span>.0.1:28017 -d <span class="token builtin class-name">test</span> -c <span class="token builtin class-name">test</span>
./mongorestore -h <span class="token number">127.0</span>.0.1:28017 -d <span class="token builtin class-name">test</span> -c <span class="token builtin class-name">test</span> xxx.bson<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Atlas"><a href="#Atlas" class="headerlink" title="Atlas"></a>Atlas</h4><p>MongoDB 公有云托管服务</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/Atlas.png" alt="Atlas"></p>
<h4 id="MongoDB-BI-Connector"><a href="#MongoDB-BI-Connector" class="headerlink" title="MongoDB BI Connector"></a>MongoDB BI Connector</h4><p>企业版软件，提供MySQL语法兼容的SQL解释器，仅支持从MongoDB读数据。</p>
<h4 id="MongoDB-Ops-Manager"><a href="#MongoDB-Ops-Manager" class="headerlink" title="MongoDB Ops Manager"></a>MongoDB Ops Manager</h4><p>MongoDB的集群管理平台</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDBOpsManager.png" alt="MongoDBOpsManager"></p>
<h4 id="MongoDB-Charts"><a href="#MongoDB-Charts" class="headerlink" title="MongoDB Charts"></a>MongoDB Charts</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDBCharts.png" alt="MongoDBCharts"></p>
<h2 id="第二章：从熟练到精通的开发之路"><a href="#第二章：从熟练到精通的开发之路" class="headerlink" title="第二章：从熟练到精通的开发之路"></a>第二章：从熟练到精通的开发之路</h2><h3 id="13-模型设计基础"><a href="#13-模型设计基础" class="headerlink" title="13 | 模型设计基础"></a>13 | 模型设计基础</h3><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>什么是数据模型?</p>
<p>数据模型是一组由符号、文本组成的集合，用以准确表达信息，达到有效交流、沟通的目的。</p>
<p>Steve Hoberman 霍伯曼.数据建模经典教程</p>
<h4 id="数据模型设计的元素"><a href="#数据模型设计的元素" class="headerlink" title="数据模型设计的元素"></a>数据模型设计的元素</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据模型设计的元素.png" alt="数据模型设计的元素"></p>
<h4 id="传统模型设计"><a href="#传统模型设计" class="headerlink" title="传统模型设计"></a>传统模型设计</h4><p>从概念到逻辑到物理</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/传统模型设计.png" alt="传统模型设计"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/从开发者的视角下的概念模型.png" alt="从开发者的视角下的概念模型"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/从开发者的视角下的逻辑模型.png" alt="从开发者的视角下的逻辑模型"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/从开发者的视角下的物理模型.png" alt="从开发者的视角下的物理模型"></p>
<h4 id="模型设计小结"><a href="#模型设计小结" class="headerlink" title="模型设计小结"></a>模型设计小结</h4><p>数据模型的三要素:</p>
<ol>
<li>实体</li>
<li>属性</li>
<li>关系</li>
</ol>
<p>数据模型的三层深度 :</p>
<ul>
<li>概念模型，逻辑模型，物理模型</li>
<li>一个模型逐步细化的过程</li>
</ul>
<h3 id="14-JSON文档模型设计特点"><a href="#14-JSON文档模型设计特点" class="headerlink" title="14 | JSON文档模型设计特点"></a>14 | JSON文档模型设计特点</h3><h4 id="MongoDB-文档模型设计的三个误区"><a href="#MongoDB-文档模型设计的三个误区" class="headerlink" title="MongoDB 文档模型设计的三个误区"></a>MongoDB 文档模型设计的三个误区</h4><p>下面的陈述均为错</p>
<ol>
<li>不需要模型设计</li>
<li>MongoDB 应该用一个超级大文档来组织所有数据</li>
<li>MongoDB 不支持关联或者事务</li>
</ol>
<h4 id="关于-JSON-文档模型设计"><a href="#关于-JSON-文档模型设计" class="headerlink" title="关于 JSON 文档模型设计"></a>关于 JSON 文档模型设计</h4><ul>
<li>文档模型设计处于是物理模型设计阶段(PDM)</li>
<li>JSON 文档模型通过内嵌数组或引用字段来表示关系</li>
<li>文档模型设计不遵从第三范式，允许冗余</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/JSON文档模型设计.png" alt="JSON文档模型设计"></p>
<h4 id="为什么人们都说-MongoDB-是无模式"><a href="#为什么人们都说-MongoDB-是无模式" class="headerlink" title="为什么人们都说 MongoDB 是无模式?"></a>为什么人们都说 MongoDB 是无模式?</h4><p>严格来说，MongoDB同样需要概念/逻辑建模</p>
<p>文档模型设计的物理层结构可以和逻辑层类似</p>
<p>MongoDB 无模式由来:</p>
<ul>
<li>可以省略物理建模的具体过程</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB无模式由来.png" alt="MongoDB无模式由来"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/JSON模型.png" alt="JSON模型"></p>
<h4 id="关系模型-vs-文档模型"><a href="#关系模型-vs-文档模型" class="headerlink" title="关系模型 vs 文档模型"></a>关系模型 vs 文档模型</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/关系模型vs文档模型.png" alt="关系模型vs文档模型"></p>
<h3 id="15-文档模型设计之一：基础设计"><a href="#15-文档模型设计之一：基础设计" class="headerlink" title="15 | 文档模型设计之一：基础设计"></a>15 | 文档模型设计之一：基础设计</h3><p>MongoDB 文档模型设计三步曲</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB文档模型设计三步曲.png" alt="MongoDB文档模型设计三步曲"></p>
<h4 id="第一步-建立基础文档模型"><a href="#第一步-建立基础文档模型" class="headerlink" title="第一步:建立基础文档模型"></a>第一步:建立基础文档模型</h4><ol>
<li>根据概念模型或者业务需求推导出逻辑模型-找到对象</li>
<li>列出实体之间的关系(及基数)-明确关系</li>
<li>套用逻辑设计原则来决定内嵌方式-进行建</li>
<li>完成基础模型构建</li>
</ol>
<p>一个联系人管理应用的例子</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/一个联系人管理应用的例子.png" alt="一个联系人管理应用的例子"></p>
<ol>
<li><p>1-1 关系建模: portraits</p>
<ol>
<li>基本原则<ul>
<li>一对一关系以内嵌为主作为子文档形式 或者直接在顶级不涉及到数据冗余</li>
</ul>
</li>
<li><p>例外情况</p>
<ul>
<li>如果内嵌后导致文档大小超过16MB</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/1对1关系建模.png" alt="1对1关系建模"></p>
</li>
</ol>
</li>
<li><p>1-N 关系建模: Addresses</p>
<ol>
<li>基本原则<ul>
<li>一对多关系同样以内嵌为主</li>
<li>用数组来表示一对多</li>
<li>不涉及到数据冗余</li>
</ul>
</li>
<li><p>例外情况</p>
<ul>
<li>内嵌后导致文档大小超过16MB</li>
<li>数组长度太大(数万或更多)</li>
<li>数组长度不确定</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/1对N关系建模.png" alt="1对N关系建模"></p>
</li>
</ol>
</li>
<li><p>N-N 关系建模:内嵌数组模式</p>
<ol>
<li>基本原则<ul>
<li>不需要映射表</li>
<li>一般用内嵌数组来表示一对多</li>
<li>通过冗余来实现N-N</li>
</ul>
</li>
<li><p>例外情况</p>
<ul>
<li>内嵌后导致文档大小超过16MB</li>
<li>数组长度太大(数万或更多)</li>
<li>数组长度不确定</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/N对N关系建模.png" alt="N对N关系建模"></p>
</li>
</ol>
</li>
</ol>
<h3 id="16-文档模型设计之二：工况细化"><a href="#16-文档模型设计之二：工况细化" class="headerlink" title="16 | 文档模型设计之二：工况细化"></a>16 | 文档模型设计之二：工况细化</h3><h4 id="第二步-根据读写工况细化"><a href="#第二步-根据读写工况细化" class="headerlink" title="第二步:根据读写工况细化"></a>第二步:根据读写工况细化</h4><ul>
<li>最频繁的数据查询模式</li>
<li>最常用的查询参数最频繁的数据写入模式</li>
<li>读写操作的比例</li>
<li>数据量的大小</li>
</ul>
<p>基于内嵌的文档模型，根据业务需求，使用引用来避免性能瓶颈、使用冗余来优化访问性能。</p>
<h5 id="联系人管理应用的分组需求"><a href="#联系人管理应用的分组需求" class="headerlink" title="联系人管理应用的分组需求"></a>联系人管理应用的分组需求</h5><ol>
<li>用于客户营销</li>
<li>有千万级联系人</li>
<li>需要频繁变动分组(group)的信息，如增加分组及修改名称及描述以及营销状态</li>
<li>一个分组可以有百万级联系人</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/联系人管理应用的分组需求.png" alt="联系人管理应用的分组需求"></p>
<p>解决方案: Group 使用单独的集合</p>
<ol>
<li>类似于关系型设计</li>
<li>用 id 或者唯一键关联</li>
<li>使用 $lookup 来提供一次查询多表的能力(类似关联)</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/联系人管理应用的分组需求解决方案.png" alt="联系人管理应用的分组需求解决方案"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/引用模式下的关联查询.png" alt="引用模式下的关联查询"></p>
<h5 id="联系人的头像-引用模式"><a href="#联系人的头像-引用模式" class="headerlink" title="联系人的头像:引用模式"></a>联系人的头像:引用模式</h5><ol>
<li>头像使用高保真，大小在5MB-10MB</li>
<li>头像一旦上传:一个月不可更换</li>
<li>基础信息查询(不含头像)和 头像查询的比例为9:1</li>
<li>建议: 使用引用方式，把头像数据放到另外一个集合，可以显著提升 90% 的查询效率</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/联系人的头像.png" alt="联系人的头像"></p>
<p>什么时候该使用引用方式?</p>
<ul>
<li>内嵌文档太大，数 MB 或者超过16MB</li>
<li>内嵌文档或数组元素会频繁修改</li>
<li>内嵌数组元素会持续增长并且没有封顶</li>
</ul>
<p>MongoDB引用设计的限制</p>
<ol>
<li>MongoDB 对使用引用的集合之间并无主外键检查</li>
<li>MongoDB 使用聚合框架的 $lookup 来模仿关联查询</li>
<li>$lookup 只支持 left outer join</li>
<li>$lookup 的关联目标(from)不能是分片表</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB引用设计的限制.png" alt="MongoDB引用设计的限制"></p>
<h3 id="17-文档模型设计之三：模式套用"><a href="#17-文档模型设计之三：模式套用" class="headerlink" title="17 | 文档模型设计之三：模式套用"></a>17 | 文档模型设计之三：模式套用</h3><h4 id="第三步-套用设计模式"><a href="#第三步-套用设计模式" class="headerlink" title="第三步:套用设计模式"></a>第三步:套用设计模式</h4><p>文档模型:无范式，无思维定式，充分发挥想象力</p>
<p>设计模式:实战过屡试不爽的设计技巧，快速应用</p>
<p>举例:一个IOT场景的分桶设计模式，可以帮助把存储空间降低10倍并且查询效率提升数十倍.</p>
<h5 id="问题-物联网场景下的海量数据处理-飞机监控数据"><a href="#问题-物联网场景下的海量数据处理-飞机监控数据" class="headerlink" title="问题:物联网场景下的海量数据处理-飞机监控数据"></a>问题:物联网场景下的海量数据处理-飞机监控数据</h5><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"20160101050000:CA2790"</span><span class="token punctuation">,</span>
    <span class="token property">"icao"</span><span class="token operator">:</span><span class="token string">"CA2790"</span><span class="token punctuation">,</span>
    <span class="token property">"callsign"</span><span class="token operator">:</span><span class="token string">"CA2790"</span><span class="token punctuation">,</span>
    <span class="token property">"ts"</span><span class="token operator">:</span>ISoDate(<span class="token string">"2016-01-01T05:00:00.000+0000"</span>)<span class="token punctuation">,</span>
    <span class="token property">"events"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"a"</span><span class="token operator">:</span><span class="token number">31418</span><span class="token punctuation">,</span>
        <span class="token property">"b"</span><span class="token operator">:</span> <span class="token operator">:</span> <span class="token number">173</span><span class="token punctuation">,</span>
        <span class="token property">"p"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">115</span>，<span class="token number">-134</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"s"</span><span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">,</span>
        <span class="token property">"v"</span><span class="token operator">:</span> <span class="token number">80</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/海量数据.png" alt="海量数据"></p>
<p>模式小结:分桶</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/模式小结分桶.png" alt="模式小结分桶"></p>
<h3 id="本讲小结"><a href="#本讲小结" class="headerlink" title="本讲小结"></a>本讲小结</h3><p>一个好的设计模式可以显著地:</p>
<ul>
<li>提升数据读写的效率</li>
<li>降低资源的需求</li>
</ul>
<p>更多的MongoDB设计模式:</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/更多的MongoDB设计模式.png" alt="更多的MongoDB设计模式"></p>
<h3 id="18-设计模式集锦"><a href="#18-设计模式集锦" class="headerlink" title="18 | 设计模式集锦"></a>18 | 设计模式集锦</h3><h4 id="问题-大文档，很多字段，很多索引"><a href="#问题-大文档，很多字段，很多索引" class="headerlink" title="问题:大文档，很多字段，很多索引"></a>问题:大文档，很多字段，很多索引</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">"Dunkirk"</span><span class="token punctuation">,</span>
    release_USA<span class="token operator">:</span><span class="token string">"2017/07/23"</span><span class="token punctuation">,</span>
    release_UK<span class="token operator">:</span><span class="token string">"2017/08/01"</span><span class="token punctuation">,</span>
    release_France<span class="token operator">:</span><span class="token string">"2017/08/01"</span><span class="token punctuation">,</span>
    release_Festival_San_Jose<span class="token operator">:</span><span class="token string">"2017/07/22"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要很多索引</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    <span class="token punctuation">{</span>release_UsA<span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>release_UK<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span>release_France<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span>release_Festival San Jose<span class="token operator">:</span><span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方案: 列转行</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/列转行.png" alt="列转行"></p>
<p>模式小结: 列转行</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/模式小结列转行.png" alt="模式小结列转行"></p>
<h4 id="问题-模型灵活了，如何管理文档不同版本"><a href="#问题-模型灵活了，如何管理文档不同版本" class="headerlink" title="问题:模型灵活了，如何管理文档不同版本?"></a>问题:模型灵活了，如何管理文档不同版本?</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/如何管理文档不同版本.png" alt="如何管理文档不同版本"></p>
<p>解决方案:增加一个版本字段</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/增加一个版本字段.png" alt="增加一个版本字段"></p>
<p>模式小结: 版本字段</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/模式小结版本字段.png" alt="模式小结版本字段"></p>
<h4 id="问题-统计网页点击流量"><a href="#问题-统计网页点击流量" class="headerlink" title="问题:统计网页点击流量"></a>问题:统计网页点击流量</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/统计网页点击流量.png" alt="统计网页点击流量"></p>
<p>解决方案:用近似计算</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/用近似计算.png" alt="用近似计算"></p>
<p>模式小结:近似计算</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/模式小结近似计算.png" alt="模式小结近似计算"></p>
<h4 id="问题-业绩排名，游戏排名，商品统计等精确统计"><a href="#问题-业绩排名，游戏排名，商品统计等精确统计" class="headerlink" title="问题:业绩排名，游戏排名，商品统计等精确统计"></a>问题:业绩排名，游戏排名，商品统计等精确统计</h4><ul>
<li>热销榜:某个商品今天卖了多少，这个星期卖了多少，这个月卖了多少?</li>
<li>电影排行:观影者，场次统计</li>
<li>传统解决方案:通过聚合计算</li>
</ul>
<p>痛点:消耗资源多，聚合计算时间长</p>
<p>解决方案:用预聚合字段</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/用预聚合字段.png" alt="用预聚合字段"></p>
<p>模式小结:预聚合</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/模式小结预聚合.png" alt="模式小结预聚合"></p>
<h3 id="19-丨-事务开发：写操作事务"><a href="#19-丨-事务开发：写操作事务" class="headerlink" title="19 丨 事务开发：写操作事务"></a>19 丨 事务开发：写操作事务</h3><h4 id="什么是-writeconcern"><a href="#什么是-writeconcern" class="headerlink" title="什么是 writeconcern?"></a>什么是 writeconcern?</h4><p>writeConcern 决定一个写操作落到多少个节点上才算成功。writeConcern 的取值包括:</p>
<ul>
<li>0: 发起写操作，不关心是否成功;</li>
<li>1~集群最大数据节点数: 写操作需要被复制到指定节点数才算成功;</li>
<li>majority: 写操作需要被复制到大多数节点上才算成功，发起写操作的程序将阻塞到写操作到达指定的节点数为止</li>
</ul>
<h4 id="默认行为"><a href="#默认行为" class="headerlink" title="默认行为"></a>默认行为</h4><p>主节点写到内存中后就返回成功。</p>
<p>以 3 节点复制集不作任何特别设定（默认值）为例。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/writeconcern默认行为.png" alt="writeconcern默认行为"></p>
<h4 id="w-“majority”"><a href="#w-“majority”" class="headerlink" title="w: “majority”"></a>w: “majority”</h4><p>大多数节点确认模式</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/大多数节点确认模式.png" alt="大多数节点确认模式"></p>
<h4 id="w-“all”"><a href="#w-“all”" class="headerlink" title="w: “all”"></a>w: “all”</h4><p>全部节点确认模式</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/全部节点确认模式.png" alt="全部节点确认模式"></p>
<h4 id="j-true"><a href="#j-true" class="headerlink" title="j: true"></a>j: true</h4><p>writeconcern 可以决定写操作到达多少个节点才算成功，journal 则定义如何才算成功。取值包括:</p>
<ul>
<li>true: 写操作落到journal文件中才算成功;</li>
<li>false: 写操作到达内存即算作成功。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/journal.png" alt="journal"></p>
<h4 id="writeconcern-实验"><a href="#writeconcern-实验" class="headerlink" title="writeconcern 实验"></a>writeconcern 实验</h4><p>在复制集测试writeConcern参数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>writeconcern<span class="token operator">:</span> <span class="token punctuation">{</span>w<span class="token operator">:</span> <span class="token string">"majority"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>count<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>writeConcern<span class="token operator">:</span> <span class="token punctuation">{</span>w<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>writeConcern<span class="token operator">:</span> <span class="token punctuation">{</span>w<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>配置延迟节点，模拟网络延迟(复制延迟)</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">conf<span class="token operator">=</span>rs<span class="token punctuation">.</span><span class="token function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
conf<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slaveDelay<span class="token operator">=</span><span class="token number">5</span>
conf<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>priority<span class="token operator">=</span><span class="token number">0</span>
rs<span class="token punctuation">.</span><span class="token function">reconfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>观察复制延迟下的写入，以及timeout参数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>count<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>writeConcern<span class="token operator">:</span> <span class="token punctuation">{</span>w<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>count<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>writeConcern<span class="token operator">:</span> <span class="token punctuation">{</span>w<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> wtimeout<span class="token operator">:</span><span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>虽然多于半数的 writeConcern 都是安全的，但通常只会设置 majority，因为这是等待写入延迟时间最短的选择;</li>
<li>不要设置 writeconcern 等于总节点数，因为一旦有一个节点故障，所有写操作都将失败;</li>
<li>writeConcern 虽然会增加写操作延迟时间，但并不会显著增加集群压力，因此无论是否等待，写操作最终都会复制到所有节点上。设置 writeconcern 只是让写操作等待复制后再返回而已;</li>
<li>应对重要数据应用 <code>{w: "majority"}</code>，普通数据可以应用 <code>{w: 1}</code> 以确保最佳性能</li>
</ul>
<h3 id="20丨事务开发：读操作事务之一"><a href="#20丨事务开发：读操作事务之一" class="headerlink" title="20丨事务开发：读操作事务之一"></a>20丨事务开发：读操作事务之一</h3><h4 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h4><p>在读取数据的过程中我们需要关注以下两个问题:</p>
<ul>
<li>从哪里读?关注数据节点 位置</li>
<li>什么样的数据可以读? 关注数据的隔离性</li>
</ul>
<ol>
<li>第一个问题是是由 readPreference 来解决</li>
<li>第二个问题则是由 readconcern 来解决</li>
</ol>
<h4 id="什么是-readPreference"><a href="#什么是-readPreference" class="headerlink" title="什么是 readPreference?"></a>什么是 readPreference?</h4><p>readPreference 决定使用哪一个节点来满足正在发起的读请求。可选值包括:</p>
<ul>
<li>primary: 只选择主节点;</li>
<li>primaryPreferred:优先选择主节点，如果不可用则选择从节点;</li>
<li>secondary:只选择从节点;</li>
<li>secondaryPreferred:优先选择从节点如果从节点不可用则选择主节点;</li>
<li>nearest:选择最近的节点;</li>
</ul>
<h4 id="readPreference-场景举例"><a href="#readPreference-场景举例" class="headerlink" title="readPreference 场景举例"></a>readPreference 场景举例</h4><ul>
<li>用户下订单后马上将用户转到订单详情页—primary/primaryPreferred。因为此时从节点可能还没复制到新订单;</li>
<li>用户查询自己下过的订单—secondary/secondaryPreferred。查询历史订单对时效性通常没有太高要求;</li>
<li>生成报表—secondary。报表对时效性要求不高，但资源需求大，可以在从节点单独处理，避免对线上用户造成影响;</li>
<li>将用户上传的图片分发到全世界，让各地用户能够就近读取—nearest。每个地区的应用选择最近的节点读取数据。</li>
</ul>
<h4 id="readPreference-与Tag"><a href="#readPreference-与Tag" class="headerlink" title="readPreference 与Tag"></a>readPreference 与Tag</h4><p>readPreference 只能控制使用一类节点。Tag 则可以将节点选择控制到一个或几个节点。考虑以下场景:</p>
<p>一个5个节点的复制集;</p>
<ul>
<li>3个节点硬件较好，专用于服务线上客户</li>
<li>2个节点硬件较差，专用于生成报表;</li>
</ul>
<p>可以使用 Tag 来达到这样的控制目的:</p>
<ul>
<li>为3个较好的节点打上{purpose:”online”};</li>
<li>为2个较差的节点打上{purpose:”analyse”};</li>
</ul>
<p>在线应用读取时指定 online，报表读取时指定reporting。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB的Tag.png" alt="MongoDB的Tag"></p>
<h4 id="readPreference-配置"><a href="#readPreference-配置" class="headerlink" title="readPreference 配置"></a>readPreference 配置</h4><p>通过 MongoDB 的连接串参数:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">mongodb://host1:27107,host2:27107,host3:27017/?replicaSet=rs&amp;readPreference=secondary<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过 MongoDB 驱动程序 API:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">MongoCollection.withReadPreference(ReadPreference readPref)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Mongo shell:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">db.collection.find({}).readPref("secondary")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="readPreference-实验-从节点读"><a href="#readPreference-实验-从节点读" class="headerlink" title="readPreference 实验:从节点读"></a>readPreference 实验:从节点读</h4><ul>
<li>主节点写入 <code>{x:1}</code>,观察该条数据在各个节点均可见</li>
<li>在两个从节点分别执行 <code>db.fsyncLock()</code> 来锁定写入(同步)</li>
<li><p>主节点写入 {x:2}</p>
<ul>
<li><code>db.test.find({a:123})</code></li>
<li><code>db.test.find({a:123}).readPref( "secondary" )</code></li>
</ul>
</li>
<li><p>解除从节点锁定 <code>db.fsyncUnlock()</code></p>
<ul>
<li><code>db.test.find({a:123}).readPref( "secondary")</code></li>
</ul>
</li>
</ul>
<h4 id="注意事项极客时间"><a href="#注意事项极客时间" class="headerlink" title="注意事项极客时间"></a>注意事项极客时间</h4><ul>
<li>指定 readPreference 时也应注意高可用问题。例如将 readPreference 指定 primary，则发生故障转移不存在 primary期间将没有节点可读。如果业务允许，则应选择 primaryPreferred;</li>
<li>使用 Tag 时也会遇到同样的问题，如果只有一个节点拥有一个特定 Tag，则在这个节点失效时将无节点可读。这在有时候是期望的结果，有时候不是。例如:<ul>
<li>如果报表使用的节点失效，即使不生成报表，通常也不希望将报表负载转移到其他节点上，此时只有一个节点有报表 Tag 是合理的选择;</li>
<li>如果线上节点失效，通常希望有替代节点，所以应该保持多个节点有同样的Tag;</li>
</ul>
</li>
<li>Tag 有时需要与优先级、选举权综合考虑。例如做报表的节点通常不会希望它成为主节点，则优先级应为 0。</li>
</ul>
<h3 id="21丨事务开发：读操作事务之二"><a href="#21丨事务开发：读操作事务之二" class="headerlink" title="21丨事务开发：读操作事务之二"></a>21丨事务开发：读操作事务之二</h3><h4 id="什么是-readconcern"><a href="#什么是-readconcern" class="headerlink" title="什么是 readconcern?"></a>什么是 readconcern?</h4><p>在 readPreference 选择了指定的节点后，readconcern 决定这个节点上的数据哪些是可读的，类似于关系数据库的隔离级别。可选值包括:</p>
<ul>
<li>available: 读取所有可用的数据:</li>
<li>local: 读取所有可用且属于当前分片的数据;</li>
<li>majority: 读取在大多数节点上提交完成的数据</li>
<li>linearizable: 可线性化读取文档;</li>
<li>snapshot: 读取最近快照中的数据;</li>
</ul>
<h4 id="readconcern-local-和-available"><a href="#readconcern-local-和-available" class="headerlink" title="readconcern: local 和 available"></a>readconcern: local 和 available</h4><p>在复制集中 local和 available 是没有区别的。两者的区别主要体现在分片集上。</p>
<p>考虑以下场景:一个chunk x正在从shard1 向 shard2 迁移;</p>
<p>整个迁移过程中 chunk x中的部分数据会在 shard1和 shard2 中同时存在，但源分片 shard1 仍然是chunk x 的负责方:</p>
<ul>
<li>所有对 chunk x 的读写操作仍然进入 shard1;</li>
<li>config 中记录的信息 chunk x 仍然属于 shard1;</li>
</ul>
<p>此时如果读 shard2，则会体现出 local 和 available 的区别。</p>
<ul>
<li>local: 只取应该由 shard2 负责的数据(不包括x);</li>
<li>available: shard2 上有什么就读什么(包括x);</li>
</ul>
<p>注意事项:</p>
<ol>
<li>虽然看上去总是应该选择 local，但毕竟对结果集进行过滤会造成额外消耗。在一些无关紧要的场景(例如统计)下，也可以考虑 available;</li>
<li>MongoDB &lt;=3.6 不支持对从节点使用 <code>{readconcern:"local"}</code>;</li>
<li>从主节点读取数据时默认 readconcern 是 local，从从节点读取数据时默认readconcern 是 available(向前兼容原因)。</li>
</ol>
<h4 id="readconcern-majority"><a href="#readconcern-majority" class="headerlink" title="readconcern: majority"></a>readconcern: majority</h4><p>只读取大多数据节点上都提交了的数据。考虑如下场景: 集合中原有文档 <code>{x: 0}</code>; 将x值更新为1;</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/readconcernmajority举例1.png" alt="readconcernmajority举例1"></p>
<p>如果在各节点上应用 <code>{readConcern:"majority"}</code> 来读取数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/readconcernmajority举例2.png" alt="readconcernmajority举例2"></p>
<h5 id="readconcern-majority-的实现方式"><a href="#readconcern-majority-的实现方式" class="headerlink" title="readconcern: majority 的实现方式"></a>readconcern: majority 的实现方式</h5><p>考虑 t3 时刻的 Secondary1，此时:</p>
<ul>
<li>对于要求 majority 的读操作，它将返回 x=0;</li>
<li>对于不要求 majority 的读操作，它将返回 x=1;</li>
</ul>
<p>如何实现?</p>
<p>节点上维护多个x版本，MVCC机制</p>
<p>MongoDB 通过维护多个快照来链接不同的版本:</p>
<ul>
<li>每个被大多数节点确认过的版本都将是一个快照;</li>
<li>快照持续到没有人使用为止才被删除;</li>
</ul>
<h5 id="实验-readconcern-“majority”-vs-“local”"><a href="#实验-readconcern-“majority”-vs-“local”" class="headerlink" title="实验:readconcern: “majority” vs “local”"></a>实验:readconcern: “majority” vs “local”</h5><ol>
<li><p>安装3节点复制集。</p>
</li>
<li><p>注意配置文件内 server 参数 enableMajorityReadConcern</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">replication:
    replSetName: rs0
    enableMajorityReadconcern: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li>将复制集中的两个从节点使用 db.fsyncLock()锁住写入(模拟同步延迟)</li>
</ol>
<h5 id="readconcern-验证"><a href="#readconcern-验证" class="headerlink" title="readconcern 验证"></a>readconcern 验证</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"A"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readconcern</span><span class="token punctuation">(</span> <span class="token string">"local"</span> <span class="token punctuation">)</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readconcern</span><span class="token punctuation">(</span> <span class="token string">"majority"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在某一个从节点上执行 db.fsyncUnlock()</p>
<p>结论:</p>
<ul>
<li>使用 local参数，则可以直接查询到写入数据</li>
<li>使用 majority，只能查询到已经被多数节点确认过的数据</li>
<li>update与remove 与上同理。</li>
</ul>
<h5 id="readconcern-majority-与脏读"><a href="#readconcern-majority-与脏读" class="headerlink" title="readconcern: majority 与脏读"></a>readconcern: majority 与脏读</h5><p>MongoDB 中的回滚:</p>
<ul>
<li>写操作到达大多数节点之前都是不安全的，一旦主节点崩溃，而从节还没复制到该次操作，刚才的写操作就丢失了;</li>
<li>把一次写操作视为一个事务，从事务的角度，可以认为事务被回滚了。</li>
</ul>
<p>所以从分布式系统的角度来看，事务的提交被提升到了分布式集群的多个节点级别的”提交”，而不再是单个节点上的”提交”在可能发生回滚的前提下考虑脏读问题:</p>
<ul>
<li>如果在一次写操作到达大多数节点前读取了这个写操作，然后因为系统故障该操作回滚了，则发生了脏读问题;</li>
</ul>
<p>使用 <code>{readConcern:"majority"}</code> 可以有效避免脏读</p>
<h5 id="readconcern-如何实现安全的读写分离"><a href="#readconcern-如何实现安全的读写分离" class="headerlink" title="readconcern:如何实现安全的读写分离"></a>readconcern:如何实现安全的读写分离</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/如何实现安全的读写分离.png" alt="如何实现安全的读写分离"></p>
<h5 id="小测试"><a href="#小测试" class="headerlink" title="小测试"></a>小测试</h5><p>readconcern 主要关注读的隔离性，ACID 中的 isolation，但是是分布式数据库里特有的概念</p>
<p>readconcern: majority 对应于事务中隔离级别中的 Read Committed。</p>
<h4 id="readconcern-linearizable"><a href="#readconcern-linearizable" class="headerlink" title="readconcern: linearizable"></a>readconcern: linearizable</h4><p>只读取大多数节点确认过的数据。和 majority 最大差别是保证绝对的操作线性顺序</p>
<ul>
<li>在写操作自然时间后面的发生的读，一定可以读到之前的写</li>
<li>只对读取单个文档时有效;</li>
<li>可能导致非常慢的读，因此总是建议配合使用 maxTimeMS;</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/readconcernlinearizable.png" alt="readconcernlinearizable"></p>
<h4 id="readconcern-snapshot"><a href="#readconcern-snapshot" class="headerlink" title="readconcern:snapshot"></a>readconcern:snapshot</h4><p><code>{readConcern:"snapshot"}</code> 只在多文档事务中生效。将一个事务的readconcern设置为 snapshot，将保证在事务中的读:</p>
<ul>
<li>不出现脏读;</li>
<li>不出现不可重复读;</li>
<li>不出现幻读。</li>
</ul>
<p>因为所有的读都将使用同一个快照，直到事务提交为止该快照才被释放。</p>
<h3 id="22丨事务开发：多文档事务"><a href="#22丨事务开发：多文档事务" class="headerlink" title="22丨事务开发：多文档事务"></a>22丨事务开发：多文档事务</h3><p>MongoDB 虽然已经在 4.2 开始全面支持了多文档事务，但并不代表大家应该毫无节制地使用它。相反，对事务的使用原则应该是:能不用尽量不用。</p>
<p>通过合理地设计文档模型，可以规避绝大部分使用事务的必要性</p>
<p>为什么?事务=锁，节点协调，额外开销，性能影响</p>
<h4 id="MongoDB-ACID-多文档事务支持"><a href="#MongoDB-ACID-多文档事务支持" class="headerlink" title="MongoDB ACID 多文档事务支持"></a>MongoDB ACID 多文档事务支持</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ACID多文档事务支持.png" alt="ACID多文档事务支持"></p>
<h5 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h5><p>MongoDB 多文档事务的使用方式与关系数据库非常相似:</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/多文档事务支持使用方法.png" alt="多文档事务支持使用方法"></p>
<h5 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h5><p>事务完成前，<strong>事务外的操作</strong> 对该事务所做的修改不可访问</p>
<p>如果事务内使用<code>{readconcern:"snapshot"}</code>，则可以达到可重复读 Repeatable Read</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/启用事务后的隔离性.png" alt="启用事务后的隔离性"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/可重复读RepeatableRead.png" alt="可重复读RepeatableRead"></p>
<h4 id="事务写机制"><a href="#事务写机制" class="headerlink" title="事务写机制"></a>事务写机制</h4><p>MongoDB 的事务错误处理机制不同于关系数据库:</p>
<ul>
<li>当一个事务开始后，如果事务要修改的文档在事务外部被修改过，则事务修改这个文档时会触发 Abort 错误，因为此时的修改冲突了;</li>
<li>这种情况下，只需要简单地重做事务就可以了，</li>
<li>如果一个事务已经开始修改一个文档，在事务以外尝试修改同一个文档，则事务以外的修改会等待事务完成才能继续进行(<a target="_blank" rel="noopener" href="https://github.com/kibaamor/geektime-mongodb-course/blob/master/transaction/write-wait.md">write-wait.md</a>实验)。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/事务写冲突.png" alt="事务写冲突"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/事务写冲突2.png" alt="事务写冲突2"></p>
<h4 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>可以实现和关系型数据库类似的事务场景</li>
<li>必须使用与 MongoDB 4.2 兼容的驱动;</li>
<li>事务默认必须在 60 秒(可调)内完成，否则将被取消</li>
<li>涉及事务的分片不能使用仲裁节点;</li>
<li>事务会影响 chunk 迁移效率。正在迁移的 chunk也可能造成事务提交失败(重试即可);</li>
<li>多文档事务中的读操作必须使用主节点读</li>
<li>readConcern 只应该在事务级别设置，不能设置在每次读写操作上。</li>
</ul>
<h3 id="23丨Change-Stream"><a href="#23丨Change-Stream" class="headerlink" title="23丨Change Stream"></a>23丨Change Stream</h3><h4 id="什么是-Change-Stream"><a href="#什么是-Change-Stream" class="headerlink" title="什么是 Change Stream"></a>什么是 Change Stream</h4><p>Change Stream 是 MongoDB 用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同:</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ChangeStream.png" alt="ChangeStream"></p>
<h4 id="Change-stream-的实现原理"><a href="#Change-stream-的实现原理" class="headerlink" title="Change stream 的实现原理"></a>Change stream 的实现原理</h4><p>Change stream 是基于 oplog 实现的。它在 oplog 上开启一个 tailable cursor 来追踪所有复制集上的变更操作，最终调用应用中定义的回调函数。</p>
<ul>
<li>insert/update/delete: 插入、更新、删除;</li>
<li>drop: 集合被删除;</li>
<li>rename: 集合被重命名;</li>
<li>数据库被删除: dropDatabase;</li>
<li>invalidate: drop/rename/dropDatabase 将导致invalidate 被触发并关闭 change stream;</li>
</ul>
<h4 id="Change-stream-与可重复读"><a href="#Change-stream-与可重复读" class="headerlink" title="Change stream 与可重复读"></a>Change stream 与可重复读</h4><p>Change Stream 只推送已经在大多数节点上提交的变更操作。即”可重复读”的变更这个验证是通过 <code>{readconcern:"majority"}</code> 实现的。因此:</p>
<ul>
<li>未开启 majority readconcern 的集群无法使用 Change Stream;</li>
<li>当集群无法满足 <code>{w:"majority"}</code> 时，不会触发 Change Stream(例如 PSA 架构中的S因故障宕机)。</li>
</ul>
<h4 id="Change-Stream-变更过滤"><a href="#Change-Stream-变更过滤" class="headerlink" title="Change Stream 变更过滤"></a>Change Stream 变更过滤</h4><p>如果只对某些类型的变更事件感兴趣，可以使用使用聚合管道的过滤步骤过滤事件</p>
<p>例如:</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ChangeStream变更过滤举例.png" alt="ChangeStream变更过滤举例"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ChangeStream变更过滤实验.png" alt="ChangeStream变更过滤实验"></p>
<p>配置中必须打开 <code>enableMajorityReadConcern: true</code>。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">systemLog:
  destination: file
  path: ./db1/mongod.log
  logAppend: true
storage:
  dbPath: ./db1
net:
  bindIp: 0.0.0.0
  port: 28017
replication:
  replSetName: rs0
  enableMajorityReadConcern: true # &lt;--------------------
processManagement:
  fork: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Change-stream-故障恢复"><a href="#Change-stream-故障恢复" class="headerlink" title="Change stream 故障恢复"></a>Change stream 故障恢复</h4><p>假设在一系列写入操作的过程中，订阅 Change stream 的应用在接收到”写3”之后于 t0 时刻崩溃，重启后后续的变更怎么办?</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/Changestream故障恢复.png" alt="Changestream故障恢复"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/Changestream故障恢复2.png" alt="Changestream故障恢复2"></p>
<h4 id="Change-Stream-使用场景"><a href="#Change-Stream-使用场景" class="headerlink" title="Change Stream 使用场景"></a>Change Stream 使用场景</h4><ul>
<li>跨集群的变更复制 —— 在源集群中订阅 Change Stream，一旦得到任何变更立即写入目标集群。</li>
<li>微服务联动 —— 当一个微服务变更数据库时，其他微服务得到通知并做出相应的变更。</li>
<li>其他任何需要系统联动的场景。</li>
</ul>
<h4 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>Change stream 依赖于 oplog，因此中断时间不可超过 oplog 回收的最大时间窗</li>
<li>在执行 update 操作时，如果只更新了部分数据，那么 Change Stream 通知的也是增量部分;</li>
<li>同理，删除数据时通知的仅是删除数据的 id。</li>
</ul>
<h3 id="24丨MongoDB开发最佳实践"><a href="#24丨MongoDB开发最佳实践" class="headerlink" title="24丨MongoDB开发最佳实践"></a>24丨MongoDB开发最佳实践</h3><h4 id="连接到-MongoDB"><a href="#连接到-MongoDB" class="headerlink" title="连接到 MongoDB"></a>连接到 MongoDB</h4><ul>
<li>关于驱动程序: 总是选择与所用之 MongoDB 相兼容的驱动程序。这可以很容易地从 <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/drivers/about-compatibility/">驱动兼容对照表</a> 中查到;<ul>
<li>如果使用第三方框架(如 Spring Data)，则还需要考虑框架版本与驱动的兼容性</li>
</ul>
</li>
<li>关于连接对象 MongoClient: 使用 MongoClient 对象连接到 MongoDB 实例时总是应该保证它单例，并且在整个生命周期中都从它获取其他操作对象。</li>
<li>关于连接字符串: 连接字符串中可以配置大部分连接选项，建议总是在连接字符串中配置这些选项;</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 连接到复制集</span>
mongodb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>节点<span class="token number">1</span><span class="token punctuation">,</span>节点<span class="token number">2</span><span class="token punctuation">,</span>节点<span class="token number">3.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>database<span class="token operator">?</span><span class="token punctuation">[</span>options<span class="token punctuation">]</span>
<span class="token comment">//连接到分片集</span>
mongodb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mongos1<span class="token punctuation">,</span>mongos2<span class="token punctuation">,</span>mongos3<span class="token operator">...</span><span class="token operator">/</span>database<span class="token operator">?</span><span class="token punctuation">[</span>options<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="常见连接字符串参数"><a href="#常见连接字符串参数" class="headerlink" title="常见连接字符串参数"></a>常见连接字符串参数</h4><ul>
<li>maxPoolSize 连接池大小</li>
<li>Max Wait Time 建议设置，自动杀掉太慢的查询</li>
<li>Write Concern 建议 majority 保证数据安全</li>
<li>Read Concern 对于数据一致性要求高的场景适当使用</li>
</ul>
<h4 id="连接字符串节点和地址"><a href="#连接字符串节点和地址" class="headerlink" title="连接字符串节点和地址"></a>连接字符串节点和地址</h4><ul>
<li>无论对于复制集或分片集，连接字符串中都应尽可能多地提供节点地址，建议全部列出;<ul>
<li>复制集利用这些地址可以更有效地发现集群成员;</li>
<li>分片集利用这些地址可以更有效地分散负载;</li>
</ul>
</li>
<li>连接字符串中尽可能使用与复制集内部配置相同的域名或IP;</li>
</ul>
<h4 id="使用域名连接集群"><a href="#使用域名连接集群" class="headerlink" title="使用域名连接集群"></a>使用域名连接集群</h4><p>在配置集群时使用域名可以为集群变更时提供一层额外的保护。例如需要将集群整体迁移到新网段，直接修改域名解析即可。</p>
<p>另外，MongoDB 提供的 <code>mongodb+srv://</code> 协议可以提供额外一层的保护。该协议允许通过域名解析得到所有 mongos 或节点的地址，而不是写在连接字符串中。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">mongodb+srv://server.example.com/

Record TTL Class Priority Weight Port Target 
_mongodb._tcp.server.example.com.86400 IN SRV 0 5 27317 mongodb1.example.com.
_mongodb._tcp.server.example.com.86400 IN SRV 0 5 27017 mongodb2.example.com.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="不要在mongos前面使用负载均衡"><a href="#不要在mongos前面使用负载均衡" class="headerlink" title="不要在mongos前面使用负载均衡"></a>不要在mongos前面使用负载均衡</h4><p>基于前面提到的原因，驱动已经知晓在不同的 mongos 之间实现负载均衡，而复制集则需要根据节点的角色来选择发送请求的目标。如果在 mongos 或复制集上层部署负载均衡:</p>
<ul>
<li>驱动会无法探测具体哪个节点存活，从而无法完成自动故障恢复</li>
<li>驱动会无法判断游标是在哪个节点创建的，从而遍历游标时出错</li>
</ul>
<p>结论:不要在 mongos 或复制集上层放置负载均衡器，让驱动处理负载均衡和自动故障恢复。</p>
<h4 id="游标使用"><a href="#游标使用" class="headerlink" title="游标使用"></a>游标使用</h4><p>如果一个游标已经遍历完，则会自动关闭;如果没有遍历完，则需要手动调用 <code>close()</code> 方法，否则该游标将在服务器上存在 10 分钟(默认值)后超时释放，造成不必要的资源浪费。</p>
<p>但是，如果不能遍历完一个游标，通常意味着查询条件太宽泛，更应该考虑的问题是如何将条件收紧</p>
<h4 id="关于查询及索引"><a href="#关于查询及索引" class="headerlink" title="关于查询及索引"></a>关于查询及索引</h4><ul>
<li>每一个查询都必须要有对应的索引</li>
<li>尽量使用覆盖索引 Covered Indexes (可以避免读数据文件)</li>
<li>使用 projection 来减少返回到客户端的的文档的内容</li>
</ul>
<h4 id="关于写入"><a href="#关于写入" class="headerlink" title="关于写入"></a>关于写入</h4><ul>
<li>在update语句里只包括需要更新的字段</li>
<li>尽可能使用批量插入来提升写入性能</li>
<li>使用TTL自动过期日志类型的数据</li>
</ul>
<h4 id="关于文档结构"><a href="#关于文档结构" class="headerlink" title="关于文档结构"></a>关于文档结构</h4><ul>
<li>防止使用太长的字段名(浪费空间)</li>
<li>防止使用太深的数组嵌套(超过2层操作比较复杂)</li>
<li>不使用中文，标点符号等非拉丁字母作为字段名</li>
</ul>
<h4 id="处理分页问题-避免使用count"><a href="#处理分页问题-避免使用count" class="headerlink" title="处理分页问题-避免使用count"></a>处理分页问题-避免使用count</h4><p>尽可能不要计算总页数，特别是数据量大和查询条件不能完整命中索引时。</p>
<p>考虑以下场景: 假设集合总共有 1000w 条数据，在没有索引的情况下考虑以下查询:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>coll<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>coll<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>前者只需要遍历前 n 条，直到找到 50 条队伍 x=100 的文档即可结束。</li>
<li>后者需要遍历完 1000w 条找到所有符合要求的文档才能得到结果</li>
</ul>
<p>为了计算总页数而进行的 <code>count()</code> 往往是拖慢页面整体加载速度的原因</p>
<h4 id="处理分页问题-巧分页"><a href="#处理分页问题-巧分页" class="headerlink" title="处理分页问题-巧分页"></a>处理分页问题-巧分页</h4><p>避免使用 <code>skip/limit</code> 形式的分页，特别是数据量大的时候;</p>
<p>替代方案: 使用查询条件+唯一排序条件;</p>
<p>例如:</p>
<ol>
<li>第一页: <code>db.posts.find({}).sort({ id: 1}).limit(20);</code></li>
<li>第二页: <code>db.posts.find({ id: {$gt:&lt;第一页最后一个 id&gt;}}).sort({ id: 1}).limit(20);</code></li>
<li>第三页: <code>db.posts.find({ id: {$gt:&lt;第二页最后一个 id&gt;}}).sort({ id: 1}).limit(20);</code><br>…</li>
</ol>
<h4 id="关于事务"><a href="#关于事务" class="headerlink" title="关于事务"></a>关于事务</h4><p>使用事务的原则:</p>
<ul>
<li>无论何时，事务的使用总是能避免则避免;</li>
<li>模型设计先于事务，尽可能用模型设计规避事务</li>
<li>不要使用过大的事务(尽量控制在 1000个文档更新以内);</li>
<li>当必须使用事务时，尽可能让涉及事务的文档分布在同一个分片上，这将有效地提高效率;</li>
</ul>
<h2 id="第三章：分片集群与高级运维之道"><a href="#第三章：分片集群与高级运维之道" class="headerlink" title="第三章：分片集群与高级运维之道"></a>第三章：分片集群与高级运维之道</h2><h3 id="25丨分片集群机制及原理"><a href="#25丨分片集群机制及原理" class="headerlink" title="25丨分片集群机制及原理"></a>25丨分片集群机制及原理</h3><h4 id="MongoDB-常见部署架构"><a href="#MongoDB-常见部署架构" class="headerlink" title="MongoDB 常见部署架构"></a>MongoDB 常见部署架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB常见部署架构.png" alt="MongoDB常见部署架构"></p>
<h4 id="为什么要使用分片集群"><a href="#为什么要使用分片集群" class="headerlink" title="为什么要使用分片集群?"></a>为什么要使用分片集群?</h4><ul>
<li>数据容量日益增大，访问性能日渐降低，怎么破?</li>
<li>新品上线异常火爆，如何支撑更多的并发用户?</li>
<li>单库已有 10TB 数据，恢复需要1-2 天，如何加速?</li>
<li>地理分布数据</li>
</ul>
<h4 id="完整的分片集群"><a href="#完整的分片集群" class="headerlink" title="完整的分片集群"></a>完整的分片集群</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/完整的分片集群.png" alt="完整的分片集群"></p>
<ol>
<li><p>mongos</p>
<p> 路由节点</p>
<p> 提供集群单一入口转发应用端请求选择合适数据节点进行读写合并多个数据节点的返回</p>
<p> 无状态</p>
<p> 建议至少2个</p>
</li>
<li><p>config</p>
<p> 配置（目录）节点</p>
<p> 提供集群元数据存储分片数据分布的映射</p>
<p> 普通复制集架构</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/配置节点.png" alt="配置节点"></p>
</li>
<li><p>primary/secondary</p>
<p> 数据节点</p>
<p> 以复制集为单位横向扩展</p>
<p> 最大1024分片</p>
<p> 分片之间数据不重复</p>
<p> 所有分片在一起才可完整工作</p>
</li>
</ol>
<h4 id="MongoDB-分片集群特点"><a href="#MongoDB-分片集群特点" class="headerlink" title="MongoDB 分片集群特点"></a>MongoDB 分片集群特点</h4><ul>
<li>应用全透明，无特殊处理</li>
<li>数据自动均衡</li>
<li>动态扩容，无须下线</li>
<li>提供三种分片方式</li>
</ul>
<h4 id="分片集群数据分布方式"><a href="#分片集群数据分布方式" class="headerlink" title="分片集群数据分布方式"></a>分片集群数据分布方式</h4><ol>
<li><p>基于范围</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/分片集群数据分布方式基于范围.png" alt="分片集群数据分布方式基于范围"></p>
</li>
<li><p>基于 Hash</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/分片集群数据分布方式基于哈希.png" alt="分片集群数据分布方式基于哈希"></p>
</li>
<li><p>基于 zone/tag</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/分片集群数据分布方式基于zonetag.png" alt="分片集群数据分布方式基于zonetag"></p>
</li>
</ol>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><ul>
<li>分片集群可以有效解决性能瓶颈及系统扩容问题</li>
<li>分片额外消耗较多，管理复杂，尽量不要分片</li>
<li>如果实在要用，请仔细学习下一讲</li>
</ul>
<h3 id="26丨分片集群设计"><a href="#26丨分片集群设计" class="headerlink" title="26丨分片集群设计"></a>26丨分片集群设计</h3><h4 id="如何用好分片集群"><a href="#如何用好分片集群" class="headerlink" title="如何用好分片集群"></a>如何用好分片集群</h4><p>合理的架构</p>
<ul>
<li>是否需要分片?</li>
<li>需要多少分片?</li>
<li>数据的分布规则</li>
</ul>
<p>正确的姿势</p>
<ul>
<li>选择需要分片的表</li>
<li>选择正确的片键</li>
<li>使用合适的均衡策略</li>
</ul>
<p>足够的资源</p>
<ul>
<li>CPU</li>
<li>RAM</li>
<li>存储</li>
</ul>
<h4 id="合理的架构-分片大小"><a href="#合理的架构-分片大小" class="headerlink" title="合理的架构-分片大小"></a>合理的架构-分片大小</h4><p>分片的基本标准</p>
<ul>
<li>关于数据: 数据量不超过 3TB，尽可能保持在 2TB一个片;</li>
<li>关于索引: 常用索引必须容纳进内存;</li>
</ul>
<p>按照以上标准初步确定分片后，还需要考虑业务压力，随着压力增大，CPU、RAM、磁盘中的任何一项出现瓶颈时，都可以通过添加更多分片来解决。</p>
<h4 id="合理的架构-需要多少个分片"><a href="#合理的架构-需要多少个分片" class="headerlink" title="合理的架构-需要多少个分片"></a>合理的架构-需要多少个分片</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/需要多少个分片.png" alt="需要多少个分片"></p>
<h4 id="合理的架构-其他需求"><a href="#合理的架构-其他需求" class="headerlink" title="合理的架构-其他需求"></a>合理的架构-其他需求</h4><p>考虑分片的分布:</p>
<ul>
<li>是否需要跨机房分布分片?</li>
<li>是否需要容灾?</li>
<li>高可用的要求如何?</li>
</ul>
<h4 id="正确的姿势"><a href="#正确的姿势" class="headerlink" title="正确的姿势"></a>正确的姿势</h4><p>各种概念由小到大</p>
<ul>
<li>片键 shard key:文档中的一个字段</li>
<li>文档 doc: 包含 shard key 的一行数据</li>
<li>块 Chunk: 包含n个文档</li>
<li>分片 Shard: 包含n个chunk</li>
<li>集群 Cluster: 包含n个分片</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/分片中的各种概念.png" alt="分片中的各种概念"></p>
<h4 id="正确的姿势-选择合适片键"><a href="#正确的姿势-选择合适片键" class="headerlink" title="正确的姿势-选择合适片键"></a>正确的姿势-选择合适片键</h4><p>影响片键效率的主要因素</p>
<ul>
<li>取值基数(Cardinality)</li>
<li>取值分布</li>
<li>分散写，集中读</li>
<li>被尽可能多的业务场景用到</li>
<li>避免单调递增或递减的片键</li>
</ul>
<h4 id="正确的姿势-选择基数大的片键"><a href="#正确的姿势-选择基数大的片键" class="headerlink" title="正确的姿势-选择基数大的片键"></a>正确的姿势-选择基数大的片键</h4><p>对于小基数的片键:</p>
<ul>
<li>因为备选值有限，那么块的总数量就有限。</li>
<li>随着数据增多，块的大小会越来越大;</li>
<li>太大的块，会导致水平扩展时移动块会非常困难</li>
</ul>
<p>例如:存储一个高中的师生数据，以年龄(假设年龄范围为15~65岁)作为片键，那么:</p>
<ul>
<li>15&lt;=年龄&lt;=65，且只为整数</li>
<li>最多只会有 51个chunk</li>
</ul>
<p>结论: 取值基数要大!</p>
<h4 id="正确的姿势-选择分布均匀的片键"><a href="#正确的姿势-选择分布均匀的片键" class="headerlink" title="正确的姿势-选择分布均匀的片键"></a>正确的姿势-选择分布均匀的片键</h4><p>对于分布不均匀的片键:</p>
<ul>
<li>造成某些块的数据量急剧增大</li>
<li>这些块压力随之增大</li>
<li>数据均衡以chunk为单位，所以系统无能为力</li>
</ul>
<p>例如:存储一个学校的师生数据，以年龄(假设年龄范围为15~65岁)作为片键，那么:</p>
<ul>
<li>15&lt;=年龄&lt;=65，且只为整数</li>
<li>大部分人的年龄范围为15~18岁(学生)</li>
<li>15、16、17、18四个chunk的数据量、访问压力远大于其他chunk</li>
</ul>
<p>结论: 取值分布应尽可能均匀</p>
<h4 id="正确的姿势-定向性好"><a href="#正确的姿势-定向性好" class="headerlink" title="正确的姿势-定向性好"></a>正确的姿势-定向性好</h4><p>考虑:</p>
<ul>
<li>4个分片的集群，你希望读某条特定的数据</li>
<li>如果你用片键作为条件查询，mongos 可以直接定位到具体的分片</li>
<li>如果你不用片键，mongos需要把查询发到4个分片</li>
<li>等最后的一个分片响应，mongos才能响应应用端。</li>
</ul>
<p>结论: 对主要查询要具有定向能力</p>
<h4 id="一个mail-系统的片键例子"><a href="#一个mail-系统的片键例子" class="headerlink" title="一个mail 系统的片键例子"></a>一个mail 系统的片键例子</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    _id<span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user<span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    subject<span class="token operator">:</span> <span class="token string">"..."</span>
    recipients<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    attachments<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><p>片建 <code>{_id: 1}</code></p>
<p> 基数 good</p>
<p> 写分布 bad</p>
<p> 定向查询 bad</p>
</li>
<li><p>片建 <code>{_id: "hashed"}</code></p>
<p> 基数 good</p>
<p> 写分布 good</p>
<p> 定向查询 bad</p>
</li>
<li><p>片建 <code>{user_id: 1}</code></p>
<p> 基数 bad</p>
<p> 写分布 good</p>
<p> 定向查询 good</p>
</li>
<li><p>片建 <code>{user_id: 1, time: 1}</code></p>
<p> 基数 good</p>
<p> 写分布 good</p>
<p> 定向查询 good</p>
</li>
</ol>
<h4 id="足够的资源"><a href="#足够的资源" class="headerlink" title="足够的资源"></a>足够的资源</h4><p>mongos与 config 通常消耗很少的资源，可以选择低规格虚拟机;</p>
<p>资源的重点在于 shard 服务器</p>
<ul>
<li>需要足以容纳热数据索引的内存;</li>
<li>正确创建索引后 CPU 通常不会成为瓶颈，除非涉及非常多的计算;</li>
<li>磁盘尽量选用 SSD。</li>
</ul>
<p>最后，实际测试是最好的检验，来看你的资源配置是否完备</p>
<p>即使项目初期已经具备了足够的资源，仍然需要考虑在合适的时候扩展。</p>
<p>建议监控各项资源使用情况，无论哪一项达到 60%以上，则开始考虑扩展，因为:</p>
<ul>
<li>扩展需要新的资源，申请新资源需要时间;</li>
<li>扩展后数据需要均衡，均衡需要时间。应保证新数据入库速度慢于均衡速度</li>
<li>均衡需要资源，如果资源即将或已经耗尽，均衡也是会很低效的。</li>
</ul>
<h3 id="27丨实验：分片集群搭建及扩容"><a href="#27丨实验：分片集群搭建及扩容" class="headerlink" title="27丨实验：分片集群搭建及扩容"></a>27丨实验：分片集群搭建及扩容</h3><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/mongodb-docker-compose">https://github.com/kibaamor/mongodb-docker-compose</a></p>
<h3 id="28丨MongoDB监控最佳实践"><a href="#28丨MongoDB监控最佳实践" class="headerlink" title="28丨MongoDB监控最佳实践"></a>28丨MongoDB监控最佳实践</h3><ul>
<li>MongoDB Ops Manager</li>
<li>Percona</li>
<li>通用监控平台</li>
<li>程序脚本</li>
</ul>
<p>监控信息的来源</p>
<ul>
<li><code>db.serverStatus()</code> (主要)</li>
<li><code>db.isMaster()</code> (次要)</li>
<li><code>mongostats</code> 命令行工具(只有部分信息)</li>
</ul>
<blockquote>
<p>注意: <code>db.serverStatus()</code> 包含的监控信息是从上次开机到现在为止的累计数据因此不能简单使用。</p>
</blockquote>
<h4 id="db-serverStatus"><a href="#db-serverStatus" class="headerlink" title="db.serverStatus()"></a>db.serverStatus()</h4><ul>
<li>connections: 关于连接数的信息</li>
<li>locks: 关于MongoDB使用的锁情况</li>
<li>network: 网络使用情况统计</li>
<li>opcounters: CRUD的执行次数统计</li>
<li>repl: 复制集配置信息</li>
<li><p>wiredTiger:包含大量WiredTiger执行情况的信息</p>
<ul>
<li>block-manager: WT数据块的读写情况</li>
<li>session: session使用数量</li>
<li>concurrentTransactions: Ticket使用情况</li>
</ul>
</li>
<li><p>mem: 内存使用情况</p>
</li>
<li>metrics: 一系列性能指标统计信息</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/serverStatus/">https://www.mongodb.com/docs/manual/reference/command/serverStatus/</a></p>
<h4 id="监控报警的考量"><a href="#监控报警的考量" class="headerlink" title="监控报警的考量"></a>监控报警的考量</h4><ul>
<li>具备一定的容错机制以减少误报的发生</li>
<li>总结应用各指标峰值</li>
<li>适时调整报警阈值</li>
<li>留出足够的处理时间</li>
</ul>
<h4 id="建议监控指标"><a href="#建议监控指标" class="headerlink" title="建议监控指标"></a>建议监控指标</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/建议监控指标.png" alt="建议监控指标"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/建议监控指标2.png" alt="建议监控指标2"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/建议监控指标3.png" alt="建议监控指标3"></p>
<h3 id="29丨MongoDB备份与恢复"><a href="#29丨MongoDB备份与恢复" class="headerlink" title="29丨MongoDB备份与恢复"></a>29丨MongoDB备份与恢复</h3><h4 id="为何备份"><a href="#为何备份" class="headerlink" title="为何备份"></a>为何备份</h4><p>备份的目的:</p>
<ul>
<li>防止硬件故障引起的数据丢失</li>
<li>防止人为错误误删数据</li>
<li>时间回溯</li>
<li>监管要求</li>
</ul>
<p>第一点MongoDB生产集群已经通过复制集的多节点实现，本讲的备份主要是为其他几个目的。</p>
<h4 id="MongoDB的备份"><a href="#MongoDB的备份" class="headerlink" title="MongoDB的备份"></a>MongoDB的备份</h4><p>MongoDB的备份机制分为:</p>
<ul>
<li>延迟节点备份</li>
<li>全量备份+Oplog 增量</li>
</ul>
<p>最常见的全量备份方式包括</p>
<ul>
<li>mongodump;</li>
<li>复制数据文件;</li>
<li>文件系统快照;</li>
</ul>
<h4 id="方案一-延迟节点备份"><a href="#方案一-延迟节点备份" class="headerlink" title="方案一:延迟节点备份"></a>方案一:延迟节点备份</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/延迟节点备份.png" alt="延迟节点备份"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/延迟节点备份2.png" alt="延迟节点备份2"></p>
<h4 id="方案二-全量备份加oplog"><a href="#方案二-全量备份加oplog" class="headerlink" title="方案二:全量备份加oplog"></a>方案二:全量备份加oplog</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/全量备份加oplog.png" alt="全量备份加oplog"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/全量备份加oplog2.png" alt="全量备份加oplog2"></p>
<h4 id="复制文件全量备份注意事项"><a href="#复制文件全量备份注意事项" class="headerlink" title="复制文件全量备份注意事项"></a>复制文件全量备份注意事项</h4><p>复制数据库文件:</p>
<ul>
<li>必须先关闭节点才能复制，否则复制到的文件无效;</li>
<li>也可以选择 <code>db.fsyncLock()</code> 锁定节点，但完成后不要忘记 <code>db.fsyncUnlock()</code> 解锁;</li>
<li>可以且应该在从节点上完成;</li>
<li>该方法实际上会暂时宕机一个从节点，所以整个过程中应注意投票节点总数。</li>
</ul>
<p>文件系统快照:</p>
<ul>
<li>MongoDB支持使用文件系统快照直接获取数据文件在某一时刻的镜像;</li>
<li>快照过程中可以不用停机;</li>
<li>数据文件和Journal必须在同一个卷上;</li>
<li>快照完成后请尽快复制文件并删除快照;</li>
</ul>
<h4 id="Mongodump全量备份注意事项"><a href="#Mongodump全量备份注意事项" class="headerlink" title="Mongodump全量备份注意事项"></a>Mongodump全量备份注意事项</h4><p>mongodump:</p>
<ul>
<li>使用mongodump备份最灵活，但速度上也是最慢的;</li>
<li>mongodump 出来的数据不能表示某个个时间点，只是某个时间段</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/Mongodump全量备份注意事项.png" alt="Mongodump全量备份注意事项"></p>
<p>解决方案:幂等性</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/oplog的幂等性.png" alt="oplog的幂等性"></p>
<p>用幂等性解决一致性问题</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/用幂等性解决一致性问题.png" alt="用幂等性解决一致性问题"></p>
<h3 id="30丨备份与恢复操作"><a href="#30丨备份与恢复操作" class="headerlink" title="30丨备份与恢复操作"></a>30丨备份与恢复操作</h3><h4 id="备份和恢复工具参数"><a href="#备份和恢复工具参数" class="headerlink" title="备份和恢复工具参数"></a>备份和恢复工具参数</h4><p>几个重要参数:</p>
<p>mongodump</p>
<ul>
<li>—oplog:复制 mongodump 开始到结束过程中的所有 oplog 并输出到结果中。输出文件位于 dump/oplog.bson</li>
</ul>
<p>mongorestore</p>
<ul>
<li>—oplogReplay: 恢复完数据文件后再重放 oplog。默认重放 <code>dump/oplog.bson</code> =&gt; <code>&lt;dump-directory&gt;/local/oplog.rs.bson</code>。如果 oplog 不在这，则可以:</li>
<li>—oplogFile:指定需要重放的 oplog 文件位置</li>
<li>—oplogLimit: 重放 oplog 时截止到指定时间点</li>
</ul>
<p>更多说明：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/database-tools/mongodump/">https://www.mongodb.com/docs/database-tools/mongodump/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/database-tools/mongorestore/">https://www.mongodb.com/docs/database-tools/mongorestore/</a></li>
</ul>
<h4 id="实际操作-mongodump-mongorestore"><a href="#实际操作-mongodump-mongorestore" class="headerlink" title="实际操作:mongodump/mongorestore"></a>实际操作:mongodump/mongorestore</h4><p>为了模拟dump过程中的数据变化，我们开启一个循环插入数据的线程:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span><span class="token punctuation">(</span>vari<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>db<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">:</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">100000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在另一个窗口中我们对其进行mongodump:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mongodump -h <span class="token number">127.0</span>.1:27017 --oplog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用mongorestore恢复到一个新集群:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mongorestore --host <span class="token number">127.0</span>.0.1 --oplogReplay dump<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>更复杂的重放oplog</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/更复杂的重放oplog.png" alt="更复杂的重放oplog"></p>
<p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/database-tools/bsondump/">https://www.mongodb.com/docs/database-tools/bsondump/</a></p>
<h4 id="分片集备份"><a href="#分片集备份" class="headerlink" title="分片集备份"></a>分片集备份</h4><p>分片集备份大致与复制集原理相同，不过存在以下差异:</p>
<ul>
<li>应分别为每个片和config备份;</li>
<li>分片集备份不仅要考虑一个分片内的一致性问题，还要考虑分片间的一致性问题。因此每个片要能够恢复到同一个时间点;</li>
</ul>
<p>尽管理论上我们可以使用与复制集同样的方式来为分片集完成增量备份，但实际上分片集的情况更加复杂。这种复杂性来自两个方面:</p>
<ul>
<li>各个数据节点的时间不一致:每个数据节点很难完全恢复到一个真正的一致时间点上，通常只能做到大致一致，而这种大致一致通常足够好，除了以下情况;</li>
<li>分片间的数据迁移:当一部分数据从一个片迁移到另一个片时，最终数据到底在哪里取决于config中的元数据。如果元数据与数据节点之间的时间差异正好导致数据实际已经迁移到新分片上，而元数据仍然认为数据在旧分片上，就会导致数据丢失情况发生。虽然这种情况发生的概率很小，但仍有可能导致问题。</li>
</ul>
<p>要避免上述问题的发生，只有定期停止均衡器;只有在均衡器停止期间，增量恢复才能保证正确，</p>
<h3 id="31丨MongoDB安全架构"><a href="#31丨MongoDB安全架构" class="headerlink" title="31丨MongoDB安全架构"></a>31丨MongoDB安全架构</h3><h4 id="MongoDB-安全架构一览"><a href="#MongoDB-安全架构一览" class="headerlink" title="MongoDB 安全架构一览"></a>MongoDB 安全架构一览</h4><ul>
<li>认证</li>
<li>鉴权</li>
<li>审计</li>
<li>加密</li>
</ul>
<h4 id="MongoDB-用户认证方式"><a href="#MongoDB-用户认证方式" class="headerlink" title="MongoDB 用户认证方式"></a>MongoDB 用户认证方式</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB用户认证方式.png" alt="MongoDB用户认证方式"></p>
<h4 id="MongoDB-集群节点认证"><a href="#MongoDB-集群节点认证" class="headerlink" title="MongoDB 集群节点认证"></a>MongoDB 集群节点认证</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB集群节点认证.png" alt="MongoDB集群节点认证"></p>
<h4 id="MongoDB-鉴权-基于角色的权限机制"><a href="#MongoDB-鉴权-基于角色的权限机制" class="headerlink" title="MongoDB 鉴权-基于角色的权限机制"></a>MongoDB 鉴权-基于角色的权限机制</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/基于角色的权限机制.png" alt="基于角色的权限机制"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/角色的组成.png" alt="角色的组成"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB内置角色及权限继承关系.png" alt="MongoDB内置角色及权限继承关系"></p>
<h4 id="自定义角色"><a href="#自定义角色" class="headerlink" title="自定义角色"></a>自定义角色</h4><p>MongoDB 支持按需自定义角色，适合一些高安全要求的业务场景</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/自定义角色.png" alt="自定义角色"></p>
<h4 id="传输加密"><a href="#传输加密" class="headerlink" title="传输加密"></a>传输加密</h4><p>MongoDB支持TLS/SSL来加密 MongoDB 的所有网络传输(客户端应用和服务器端之间，内部复制集之间)</p>
<p>TLS/SSL确保 MongoDB 网络传输仅可由允许的客户端读取。</p>
<h4 id="落盘加密"><a href="#落盘加密" class="headerlink" title="落盘加密"></a>落盘加密</h4><blockquote>
<p>企业版功能</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/落盘加密.png" alt="落盘加密"></p>
<h4 id="字段级加密"><a href="#字段级加密" class="headerlink" title="字段级加密"></a>字段级加密</h4><ul>
<li>单独文档字段通过自身密钥加密</li>
<li>数据库只看见密文</li>
<li>优势<ul>
<li>便捷:自动及透明</li>
<li>任务分开:(简化基于服务的系统步骤，因为没有服务工程师能够看到纯文本)</li>
<li>合规:监管”被遗忘权”</li>
<li>快速:最小性能代偿</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/字段级加密查询流程.png" alt="字段级加密查询流程"></p>
<h4 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h4><ul>
<li>数据库等记录型系统通常使用审计监控数据库相关的一些活动，以及对一些可疑的操作进行调查。</li>
<li>记录格式:JSON</li>
<li>记录方式:本地文件 或 syslog</li>
<li>记录内容:<ul>
<li>Schema change (DDL)</li>
<li>CRUD 操作(DML)</li>
<li>用户认证</li>
</ul>
</li>
</ul>
<h4 id="审计配置参数举例"><a href="#审计配置参数举例" class="headerlink" title="审计配置参数举例"></a>审计配置参数举例</h4><p>审计日志记录到 syslog</p>
<ul>
<li><code>--auditDestination syslog</code></li>
</ul>
<p>审计日志记录写到指定文件</p>
<ul>
<li><code>--auditDestination file --auditFormat jSON --auditPath /path/to/auditLog.json</code></li>
</ul>
<p>对删表和创建表动作进行审计日志记录</p>
<ul>
<li><code>--auditDestination file --auditFormatjSON --auditPath auditLog.json --auditFilter'{atype: {$in:["createCollection","dropCollection"]}}'</code></li>
</ul>
<h3 id="32丨MongoDB安全加固实践"><a href="#32丨MongoDB安全加固实践" class="headerlink" title="32丨MongoDB安全加固实践"></a>32丨MongoDB安全加固实践</h3><h4 id="MongoDB-安全最佳实践"><a href="#MongoDB-安全最佳实践" class="headerlink" title="MongoDB 安全最佳实践"></a>MongoDB 安全最佳实践</h4><ol>
<li><p>启用身份认证</p>
<p> 启用访问控制并强制执行身份认证</p>
<p> 使用强密码</p>
</li>
<li><p>权限控制</p>
<p> 基于 Deny All 原则</p>
<p> 不多给多余权限</p>
</li>
<li><p>加密和审计</p>
<p> 启用传输加密、数据保护和活动审计</p>
</li>
<li><p>网络加固</p>
<p> 内网部署服务器</p>
<p> 设置防火墙</p>
<p> 操作系统设置</p>
</li>
<li><p>遵循安全准则</p>
<p> 遵守不同行业或地区安全标准合规性要求</p>
</li>
</ol>
<h4 id="合理配置权限"><a href="#合理配置权限" class="headerlink" title="合理配置权限"></a>合理配置权限</h4><ul>
<li>创建管理员</li>
<li>使用复杂密码</li>
<li>不同用户不同账户</li>
<li>应用隔离</li>
<li>最小权限原则</li>
</ul>
<h4 id="启用加密"><a href="#启用加密" class="headerlink" title="启用加密"></a>启用加密</h4><ul>
<li>使用 TLS 作为传输协议</li>
<li>使用4.2版本的字段级加密对敏感字段加密</li>
<li>如有需要，使用企业版进行落盘加密</li>
<li>如有需要，使用企业版并启用审计日志</li>
</ul>
<h4 id="网络和操作系统加固"><a href="#网络和操作系统加固" class="headerlink" title="网络和操作系统加固"></a>网络和操作系统加固</h4><p>使用专用用户运行 MongoDB</p>
<ul>
<li>不建议在操作系统层使用 root用户运行 MongoDB</li>
</ul>
<p>限制网络开放度</p>
<ul>
<li>通过防火墙，iptables 规则控制对 MongoDB 的访问</li>
<li>使用 VPN/VPCS 可以创建一个安全通道，MongoDB 服务不应该直接暴露在互联网上</li>
<li>使用白名单列表限制允许访问的网段</li>
<li>使用 bind ip 绑定一个具体地址</li>
<li>修改默认监听端口:27017</li>
</ul>
<p>使用安全配置选项运行 MongoDB</p>
<ul>
<li>如果不需要执行 JavaScript 脚本，使用 <code>--noscripting</code> 禁止脚本执行</li>
<li>如果使用老版本MongoDB,关闭http接口: <code>net.http.enabled=False net.http.JSONPEnabled= False</code></li>
<li>如果使用老版本 MongoDB,关闭 Rest API接囗: <code>net.http.RESTInterfaceEnabled= False</code></li>
</ul>
<h4 id="Demo-启用认证"><a href="#Demo-启用认证" class="headerlink" title="Demo:启用认证"></a>Demo:启用认证</h4><ol>
<li>方式一: 命令行方式通过”—auth”参数</li>
<li>方式二:配置文件方式在 security下添加<code>authorization:enabled</code></li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mongod --auth--port <span class="token number">27017</span>--dbpath /data/db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启用鉴权后，无密码可以登录，但是只能执行创建用户操作mongo</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&gt;</span> use admin
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user<span class="token operator">:</span> <span class="token string">"superuser"</span><span class="token punctuation">,</span> pwd<span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span> roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>role<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span> db<span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>安全登录，执行如下命令查看认证机制</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mongo -usuperuser -p password --authenticationDatabase admin
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span>getParameter:1,authenticationMechanisms:1<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从数据库中查看用户</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>system<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="33丨MongoDB索引机制（一）"><a href="#33丨MongoDB索引机制（一）" class="headerlink" title="33丨MongoDB索引机制（一）"></a>33丨MongoDB索引机制（一）</h3><h4 id="术语-Index-Key"><a href="#术语-Index-Key" class="headerlink" title="术语-Index/Key"></a>术语-Index/Key</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/IndexKey.png" alt="IndexKey"></p>
<h4 id="术语-Covered-Query"><a href="#术语-Covered-Query" class="headerlink" title="术语-Covered Query"></a>术语-Covered Query</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/CoveredQuery.png" alt="CoveredQuery"></p>
<h4 id="术语-IXSCAN-COLLSCAN"><a href="#术语-IXSCAN-COLLSCAN" class="headerlink" title="术语-IXSCAN/COLLSCAN"></a>术语-IXSCAN/COLLSCAN</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/IXSCANCOLLSCAN.png" alt="IXSCANCOLLSCAN"></p>
<h4 id="术语-Query-Shape"><a href="#术语-Query-Shape" class="headerlink" title="术语-Query Shape"></a>术语-Query Shape</h4><p>查询条件用到了哪些字段。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/QueryShape.png" alt="QueryShape"></p>
<h4 id="术语-Index-Prefix"><a href="#术语-Index-Prefix" class="headerlink" title="术语-Index Prefix"></a>术语-Index Prefix</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/IndexPrefix.png" alt="IndexPrefix"></p>
<h4 id="术语-Selectivity"><a href="#术语-Selectivity" class="headerlink" title="术语-Selectivity"></a>术语-Selectivity</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/Selectivity.png" alt="Selectivity"></p>
<h4 id="B树结构"><a href="#B树结构" class="headerlink" title="B树结构"></a>B树结构</h4><p>MongoDB使用 B+ 树</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/B树结构.png" alt="B树结构"></p>
<h4 id="数据结构与算法复习"><a href="#数据结构与算法复习" class="headerlink" title="数据结构与算法复习"></a>数据结构与算法复习</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据结构与算法复习.png" alt="数据结构与算法复习"></p>
<h3 id="34丨MongoDB索引机制（二）"><a href="#34丨MongoDB索引机制（二）" class="headerlink" title="34丨MongoDB索引机制（二）"></a>34丨MongoDB索引机制（二）</h3><h4 id="索引执行计划"><a href="#索引执行计划" class="headerlink" title="索引执行计划"></a>索引执行计划</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/索引执行计划.png" alt="索引执行计划"></p>
<h4 id="explain"><a href="#explain" class="headerlink" title="explain()"></a>explain()</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/explain.png" alt="explain"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/explain2.png" alt="explain2"></p>
<h4 id="MongoDB-索引类型"><a href="#MongoDB-索引类型" class="headerlink" title="MongoDB 索引类型"></a>MongoDB 索引类型</h4><ul>
<li>单键索引</li>
<li>组合索引</li>
<li>多值索引</li>
<li>地理位置索引</li>
<li>全文索引</li>
<li>TTL索引</li>
<li>部分索引</li>
<li>哈希索引</li>
</ul>
<h4 id="组合索引-Compound-Index"><a href="#组合索引-Compound-Index" class="headerlink" title="组合索引-Compound Index"></a>组合索引-Compound Index</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/组合索引.png" alt="组合索引"></p>
<p>组合索引工作模式</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/组合索引工作模式.png" alt="组合索引工作模式"></p>
<ol>
<li><p>精确匹配</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/组合索引工作模式精确匹配.png" alt="组合索引工作模式精确匹配"></p>
</li>
<li><p>范围查询</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/组合索引工作模式范围查询.png" alt="组合索引工作模式范围查询"></p>
</li>
<li><p>索引字段顺序的影响</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/范围组合查询索引字段顺序的影响.png" alt="范围组合查询索引字段顺序的影响"></p>
</li>
<li><p>范围+排序组合查询: 索引字段顺序的影响</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/范围排序组合查询索引字段顺序的影响.png" alt="范围排序组合查询索引字段顺序的影响"></p>
</li>
</ol>
<h4 id="地理位置索引"><a href="#地理位置索引" class="headerlink" title="地理位置索引"></a>地理位置索引</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/地理位置索引.png" alt="地理位置索引"></p>
<h4 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/全文索引.png" alt="全文索引"></p>
<h4 id="部分索引"><a href="#部分索引" class="headerlink" title="部分索引"></a>部分索引</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/部分索引.png" alt="部分索引"></p>
<h4 id="其他索引技巧"><a href="#其他索引技巧" class="headerlink" title="其他索引技巧"></a>其他索引技巧</h4><p>后台创建索引</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>member<span class="token punctuation">.</span><span class="token function">createindex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> city<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>background<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对BI/报表专用节点单独创建索引</p>
<ul>
<li>该从节点priority设为0</li>
<li>关闭该从节点，</li>
<li>以单机模式启动</li>
<li>添加索引(分析用)关闭该从节点，以副本集模式启动</li>
</ul>
<h3 id="35丨MongoDB读写性能机制"><a href="#35丨MongoDB读写性能机制" class="headerlink" title="35丨MongoDB读写性能机制"></a>35丨MongoDB读写性能机制</h3><h4 id="一次数据库请求过程中发生了什么"><a href="#一次数据库请求过程中发生了什么" class="headerlink" title="一次数据库请求过程中发生了什么"></a>一次数据库请求过程中发生了什么</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/一次数据库请求过程中发生了什么.png" alt="一次数据库请求过程中发生了什么"></p>
<h4 id="应用端"><a href="#应用端" class="headerlink" title="应用端"></a>应用端</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/应用端.png" alt="应用端"></p>
<h5 id="选择节点"><a href="#选择节点" class="headerlink" title="选择节点"></a>选择节点</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/应用端选择节点.png" alt="应用端选择节点"></p>
<h5 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h5><p>排队等待连接是如何发生的?</p>
<ul>
<li>总连接数大于允许的最大连接数maxPoolSize;</li>
</ul>
<p>如何解决这个问题?</p>
<ul>
<li>加大最大连接数(不一定有用);</li>
<li>优化查询性能;</li>
</ul>
<h5 id="连接与认证"><a href="#连接与认证" class="headerlink" title="连接与认证"></a>连接与认证</h5><p>如果一个请求需要等待创建新连接和进行认证，相比直接从连接池获取连接，它将耗费更长时间。</p>
<p>可能解决方案:</p>
<ul>
<li>设置 minPoolSize(最小连接数)一次性创建足够的连接;</li>
<li>避免突发的大量请求;</li>
</ul>
<h4 id="数据库端"><a href="#数据库端" class="headerlink" title="数据库端"></a>数据库端</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库端.png" alt="数据库端"></p>
<h5 id="排队等待-1"><a href="#排队等待-1" class="headerlink" title="排队等待"></a>排队等待</h5><p>由 ticket 不足引起的排队等待，问题往往不在 ticket本身，而在于为什么正在执行的操作会长时间占用 ticket。</p>
<p>可能解决方案:</p>
<ul>
<li>优化 CRUD 性能可以减少 ticket 占用时间;</li>
<li>zlib 压缩方式也可能引起 ticket 不足，因为 zlib 算法本身在进行压缩、解压时需要的时间比较长，从而造成长时间的 ticket 占用;</li>
</ul>
<h5 id="执行请求-读"><a href="#执行请求-读" class="headerlink" title="执行请求(读)"></a>执行请求(读)</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库端执行请求读.png" alt="数据库端执行请求读"></p>
<h5 id="执行请求-写"><a href="#执行请求-写" class="headerlink" title="执行请求(写)"></a>执行请求(写)</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库端执行请求写.png" alt="数据库端执行请求写"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库端执行请求写2.png" alt="数据库端执行请求写2"></p>
<h5 id="合并结果"><a href="#合并结果" class="headerlink" title="合并结果"></a>合并结果</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库端合并结果.png" alt="数据库端合并结果"></p>
<h4 id="网络的考量"><a href="#网络的考量" class="headerlink" title="网络的考量"></a>网络的考量</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/网络的考量.png" alt="网络的考量"></p>
<h4 id="性能瓶颈总结"><a href="#性能瓶颈总结" class="headerlink" title="性能瓶颈总结"></a>性能瓶颈总结</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/性能瓶颈总结.png" alt="性能瓶颈总结"></p>
<h3 id="36丨性能诊断工具"><a href="#36丨性能诊断工具" class="headerlink" title="36丨性能诊断工具"></a>36丨性能诊断工具</h3><h4 id="mongostat"><a href="#mongostat" class="headerlink" title="mongostat"></a>mongostat</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/mongostat.png" alt="mongostat"></p>
<p>mongostat 是 MongoDB 自带的实时监控工具，用于展示实例的运行状态与性能指标。</p>
<p>它会每隔一段时间（默认 1 秒）采样一次，输出数据库的关键统计信息。</p>
<h5 id="命令示例"><a href="#命令示例" class="headerlink" title="命令示例"></a>命令示例</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ mongostat --host localhost --port <span class="token number">27017</span>
insert query update delete getmore <span class="token builtin class-name">command</span> dirty used flushes vsize  res qr<span class="token operator">|</span>qw ar<span class="token operator">|</span>aw net_in net_out conn
    <span class="token number">10</span>     <span class="token number">3</span>      <span class="token number">5</span>      <span class="token number">1</span>       <span class="token number">2</span>     <span class="token number">25</span><span class="token operator">|</span><span class="token number">0</span>  <span class="token number">3.2</span>%  <span class="token number">76.8</span>%       <span class="token number">1</span>  <span class="token number">5</span>.80G <span class="token number">3</span>.20G <span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span> <span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span>   40kB   120kB   <span class="token number">58</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="各字段详细说明"><a href="#各字段详细说明" class="headerlink" title="各字段详细说明"></a>各字段详细说明</h5><div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
<th>示例值</th>
<th>说明</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>insert</strong></td>
<td>每秒插入操作次数</td>
<td>10</td>
<td>每秒执行的 <code>insert</code> 操作数量（包括批量插入）。</td>
<td></td>
</tr>
<tr>
<td><strong>query</strong></td>
<td>每秒查询操作次数</td>
<td>3</td>
<td>每秒执行的 <code>find</code> 操作数量。</td>
<td></td>
</tr>
<tr>
<td><strong>update</strong></td>
<td>每秒更新操作次数</td>
<td>5</td>
<td>每秒执行的 <code>update</code> 操作数量。</td>
<td></td>
</tr>
<tr>
<td><strong>delete</strong></td>
<td>每秒删除操作次数</td>
<td>1</td>
<td>每秒执行的 <code>remove</code> 操作数量。</td>
<td></td>
</tr>
<tr>
<td><strong>getmore</strong></td>
<td>每秒从游标获取更多文档的次数</td>
<td>2</td>
<td>主要反映分页或游标查询的频率。</td>
<td></td>
</tr>
<tr>
<td><strong>command</strong></td>
<td>每秒执行的命令次数</td>
<td>25\</td>
<td>0</td>
<td>前者是普通命令（如 findAndModify、aggregate），后者是内部命令数。</td>
<td></td>
</tr>
<tr>
<td><strong>flushes</strong></td>
<td>WiredTiger checkpoint 次数</td>
<td>1</td>
<td>表示在采样间隔内，缓存同步到磁盘的次数（通常每分钟约 1 次）。</td>
<td></td>
</tr>
<tr>
<td><strong>dirty</strong></td>
<td>缓存中未落盘的脏页比例</td>
<td>3.2%</td>
<td>WiredTiger 缓存中已修改但未写入磁盘的页占比。</td>
<td></td>
</tr>
<tr>
<td><strong>used</strong></td>
<td>缓存使用率</td>
<td>76.8%</td>
<td>表示 WiredTiger 缓存已使用的百分比。</td>
<td></td>
</tr>
<tr>
<td><strong>vsize</strong></td>
<td>虚拟内存占用</td>
<td>5.80G</td>
<td>MongoDB 进程使用的虚拟内存大小。</td>
<td></td>
</tr>
<tr>
<td><strong>res</strong></td>
<td>常驻内存（物理内存）占用</td>
<td>3.20G</td>
<td>MongoDB 实际驻留在物理内存中的大小。</td>
<td></td>
</tr>
<tr>
<td>**qr\</td>
<td>qw**</td>
<td>等待队列中的读/写请求数</td>
<td>0\</td>
<td>0</td>
<td>当前阻塞等待的读写操作数量。</td>
</tr>
<tr>
<td>**ar\</td>
<td>aw**</td>
<td>活跃的读/写请求数</td>
<td>1\</td>
<td>0</td>
<td>当前正在执行的读写操作数量。</td>
</tr>
<tr>
<td><strong>net_in</strong></td>
<td>网络输入流量</td>
<td>40kB</td>
<td>MongoDB 每秒接收的数据量。</td>
<td></td>
</tr>
<tr>
<td><strong>net_out</strong></td>
<td>网络输出流量</td>
<td>120kB</td>
<td>MongoDB 每秒发送的数据量。</td>
<td></td>
</tr>
<tr>
<td><strong>conn</strong></td>
<td>当前活动连接数</td>
<td>58</td>
<td>当前连接到 mongod 实例的客户端数量。</td>
<td></td>
</tr>
<tr>
<td><strong>time</strong>（部分版本）</td>
<td>采样时间戳</td>
<td>—</td>
<td>显示统计采样的时间点。</td>
</tr>
</tbody>
</table>
</div>
<p>WiredTiger 默认缓存大小为 <code>max(0.5 * (RAM - 1 GB), 256 MB)</code>。</p>
<blockquote>
<p>注意：在某些情况下（例如在容器中运行时），数据库的内存限制可能低于系统总内存。此时，该<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/reference/command/hostInfo/#mongodb-data-hostInfo.system.memLimitMB">内存限制(hostInfo.system.memLimitMB)</a>而非系统总内存将被用作可用的最大RAM。</p>
<p>参考： <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/core/wiredtiger/#memory-use">https://www.mongodb.com/docs/manual/core/wiredtiger/#memory-use</a></p>
</blockquote>
<h5 id="辅助字段（在某些版本或参数下出现）"><a href="#辅助字段（在某些版本或参数下出现）" class="headerlink" title="辅助字段（在某些版本或参数下出现）"></a>辅助字段（在某些版本或参数下出现）</h5><div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>faults</strong></td>
<td>页面错误（Page Faults）</td>
<td>MongoDB 从磁盘加载数据到内存的次数，过高表示内存不足。</td>
</tr>
<tr>
<td><strong>repl</strong></td>
<td>副本集同步状态</td>
<td>对副本集节点显示同步操作的相关统计。</td>
</tr>
<tr>
<td><strong>opcounters</strong></td>
<td>操作计数</td>
<td>如果使用 <code>--json</code> 输出，可查看详细操作计数器。</td>
</tr>
<tr>
<td><strong>ttl_deletes / ttl_passes</strong></td>
<td>TTL 索引相关</td>
<td>TTL 索引触发的删除次数与扫描次数。</td>
</tr>
<tr>
<td><strong>scan_and_order</strong></td>
<td>排序扫描次数</td>
<td>查询中使用内存排序的次数。</td>
</tr>
<tr>
<td><strong>journaled / written</strong></td>
<td>日志写入量</td>
<td>写入 journal 和数据文件的字节数。</td>
</tr>
</tbody>
</table>
</div>
<h5 id="重点指标解释与诊断建议"><a href="#重点指标解释与诊断建议" class="headerlink" title="重点指标解释与诊断建议"></a>重点指标解释与诊断建议</h5><div class="table-container">
<table>
<thead>
<tr>
<th>指标</th>
<th>意义</th>
<th>异常表现</th>
<th>可能原因</th>
<th>建议</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>dirty / used</strong></td>
<td>缓存健康度</td>
<td>长期偏高</td>
<td>写入压力大 / I/O 性能差</td>
<td>检查磁盘延迟，调整缓存大小</td>
</tr>
<tr>
<td><strong>qr / qw</strong></td>
<td>请求等待</td>
<td>持续非 0</td>
<td>锁竞争 / 慢查询</td>
<td>优化查询或增加资源</td>
</tr>
<tr>
<td><strong>ar / aw</strong></td>
<td>活跃操作</td>
<td>持续高</td>
<td>写入量大</td>
<td>分析操作类型与索引情况</td>
</tr>
<tr>
<td><strong>conn</strong></td>
<td>连接数</td>
<td>过高</td>
<td>应用连接池未复用</td>
<td>优化连接池配置</td>
</tr>
<tr>
<td><strong>net_in / net_out</strong></td>
<td>网络流量</td>
<td>异常激增</td>
<td>应用暴增或复制压力</td>
<td>检查客户端或复制链路</td>
</tr>
</tbody>
</table>
</div>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><code>mongostat</code> 是监控 MongoDB 性能的首选命令之一，尤其适合快速判断：</p>
<ul>
<li>数据库写入是否积压（dirty、used）</li>
<li>锁竞争情况（qr|qw）</li>
<li>网络及连接状态（net_in/out、conn）</li>
<li>I/O 压力与内存健康状况（flushes、vsize、res）</li>
</ul>
<p>配合 <code>mongotop</code> 与监控系统（如 Cloud Manager、Prometheus、Grafana）使用，可以获得更全面的性能视图。</p>
<h4 id="mongotop"><a href="#mongotop" class="headerlink" title="mongotop"></a>mongotop</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/mongotop.png" alt="mongotop"></p>
<h4 id="mongod日志"><a href="#mongod日志" class="headerlink" title="mongod日志"></a>mongod日志</h4><p>日志中会记录执行超过 100ms 的查询及其执行计划。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/mongod日志.png" alt="mongod日志"></p>
<h4 id="mtools"><a href="#mtools" class="headerlink" title="mtools"></a>mtools</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/mtools.png" alt="mtools"></p>
<h3 id="37丨高级集群设计：两地三中心"><a href="#37丨高级集群设计：两地三中心" class="headerlink" title="37丨高级集群设计：两地三中心"></a>37丨高级集群设计：两地三中心</h3><h4 id="容灾级别"><a href="#容灾级别" class="headerlink" title="容灾级别"></a>容灾级别</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/容灾级别.png" alt="容灾级别.png"></p>
<ol>
<li><p>RPO — 数据丢失容忍度</p>
<p> Recovery Point Objective（恢复点目标）</p>
<ul>
<li>含义：系统或数据在灾难发生时允许丢失的最大数据量或时间窗口。它衡量数据备份的频率和容忍的数据丢失程度。</li>
<li>核心意义：在灾难发生时，你能接受丢失多少数据？</li>
<li>举例：如果 RPO = 15 分钟，意味着系统发生故障后，你最多能容忍最近 15 分钟内的数据丢失。如果数据库每小时备份一次，RPO 可能就是 1 小时。</li>
<li>应用：决定数据备份频率（如增量备份、实时复制）。评估系统设计是否满足业务需求。</li>
</ul>
</li>
<li><p>RTO — 系统恢复时限</p>
<p> Recovery Time Objective（恢复时间目标）</p>
<ul>
<li>含义：系统或服务在发生故障后恢复到正常运行状态所允许的最长时间。它衡量业务可接受的中断时间长度。</li>
<li>核心意义：灾难发生后，你需要多快将系统恢复运行？</li>
<li>举例：如果 RTO = 2 小时，意味着系统宕机后必须在 2 小时内恢复业务。RTO 越短，通常意味着需要更多的高可用架构和资源投入。</li>
<li>应用：设计容灾架构（热备、冷备、异地灾备）。决定自动化恢复和故障转移方案。</li>
</ul>
</li>
</ol>
<h4 id="双活的技术组件"><a href="#双活的技术组件" class="headerlink" title="双活的技术组件"></a>双活的技术组件</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/双活的技术组件.png" alt="双活的技术组件"></p>
<h5 id="网络层解决方案"><a href="#网络层解决方案" class="headerlink" title="网络层解决方案"></a>网络层解决方案</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/网络层解决方案.png" alt="网络层解决方案"></p>
<h5 id="应用层解决方案"><a href="#应用层解决方案" class="headerlink" title="应用层解决方案"></a>应用层解决方案</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/应用层解决方案.png" alt="应用层解决方案"></p>
<h5 id="数据库解决方案"><a href="#数据库解决方案" class="headerlink" title="数据库解决方案"></a>数据库解决方案</h5><p>数据跨中心同步</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/数据库解决方案.png" alt="数据库解决方案"></p>
<h4 id="MongoDB-三中心方案"><a href="#MongoDB-三中心方案" class="headerlink" title="MongoDB 三中心方案"></a>MongoDB 三中心方案</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB三中心方案1.png" alt="MongoDB三中心方案1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB三中心方案2.png" alt="MongoDB三中心方案2"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB三中心方案3.png" alt="MongoDB三中心方案3"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB三中心方案4.png" alt="MongoDB三中心方案4"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB三中心方案5.png" alt="MongoDB三中心方案5"></p>
<ul>
<li>节点数量建议要5个，2+2+1模式</li>
<li>主数据中心的两个节点要设置高一点的优先级，减少跨中心换主节点</li>
<li>同城双中心之间的网络要保证低延迟和频宽，满足 <code>writeConcern:Majority</code> 的双中心写需求</li>
<li>使用 Retryable Writes and Retryable Reads 来保证零下线时间</li>
<li>用户需要自行处理好业务层的双中心切换</li>
</ul>
<h3 id="38丨实验：搭建两地三中心集群"><a href="#38丨实验：搭建两地三中心集群" class="headerlink" title="38丨实验：搭建两地三中心集群"></a>38丨实验：搭建两地三中心集群</h3><h3 id="39丨高级集群设计：全球多写"><a href="#39丨高级集群设计：全球多写" class="headerlink" title="39丨高级集群设计：全球多写"></a>39丨高级集群设计：全球多写</h3><h4 id="MongoDB多中心部署的三种模式"><a href="#MongoDB多中心部署的三种模式" class="headerlink" title="MongoDB多中心部署的三种模式"></a>MongoDB多中心部署的三种模式</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB多中心部署的三种模式.png" alt="MongoDB多中心部署的三种模式"></p>
<h4 id="全球化业务需求"><a href="#全球化业务需求" class="headerlink" title="全球化业务需求"></a>全球化业务需求</h4><ul>
<li>某奢侈品牌厂商业务集中在大中华地区</li>
<li>2020年的目标是要进入美国市场</li>
<li>他们的主要业务系统都集中在香港</li>
<li>如何设计我们的业务系统来保证海外用户的最佳体验?</li>
</ul>
<h4 id="远距离访问无法保证用户体验"><a href="#远距离访问无法保证用户体验" class="headerlink" title="远距离访问无法保证用户体验"></a>远距离访问无法保证用户体验</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/远距离访问无法保证用户体验.png" alt="远距离访问无法保证用户体验"></p>
<h4 id="MongoDB复制集-只解决了读的问题"><a href="#MongoDB复制集-只解决了读的问题" class="headerlink" title="MongoDB复制集-只解决了读的问题"></a>MongoDB复制集-只解决了读的问题</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB复制集只解决了读的问题.png" alt="MongoDB复制集只解决了读的问题"></p>
<h4 id="MongoDB-Zone-sharding-全球集群"><a href="#MongoDB-Zone-sharding-全球集群" class="headerlink" title="MongoDB Zone sharding-全球集群"></a>MongoDB Zone sharding-全球集群</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDBZoneSharding全球集群.png" alt="MongoDBZoneSharding全球集群"></p>
<h5 id="Zone-sharding-设置步骤"><a href="#Zone-sharding-设置步骤" class="headerlink" title="Zone sharding 设置步骤"></a>Zone sharding 设置步骤</h5><ul>
<li>针对每个要分片的数据集合，模型中增加一个区域字段</li>
<li>给集群的每个分片加区域标签</li>
<li>给每个区域指定属于这个区域的分片块范围(chunkrange)</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ZoneSharding设置步骤1.png" alt="ZoneSharding设置步骤1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ZoneSharding设置步骤2.png" alt="ZoneSharding设置步骤2"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/ZoneSharding设置步骤3.png" alt="ZoneSharding设置步骤3"></p>
<h5 id="MongoDB-Zone-sharding-工作原理"><a href="#MongoDB-Zone-sharding-工作原理" class="headerlink" title="MongoDB Zone sharding 工作原理"></a>MongoDB Zone sharding 工作原理</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDBZoneSharding工作原理.png" alt="MongoDBZoneSharding工作原理"></p>
<h5 id="读写场景分析"><a href="#读写场景分析" class="headerlink" title="读写场景分析"></a>读写场景分析</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDBZoneSharding读写场景分析.png" alt="MongoDBZoneSharding读写场景分析"></p>
<h4 id="独立集群模式-需要外部工具双向同步"><a href="#独立集群模式-需要外部工具双向同步" class="headerlink" title="独立集群模式-需要外部工具双向同步"></a>独立集群模式-需要外部工具双向同步</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/独立集群模式需要外部工具双向同步.png" alt="独立集群模式需要外部工具双向同步"></p>
<h3 id="40丨MongoDB上线及升级"><a href="#40丨MongoDB上线及升级" class="headerlink" title="40丨MongoDB上线及升级"></a>40丨MongoDB上线及升级</h3><h4 id="上线前-性能测试"><a href="#上线前-性能测试" class="headerlink" title="上线前:性能测试"></a>上线前:性能测试</h4><p>模拟真实压力，对集群完成充分的性能测试，了解集群概况。</p>
<p>性能测试的输出:</p>
<ul>
<li>压测过程中各项指标表现，例如CRUD达到多少，连接数达到多少等。</li>
<li>根据正常指标范围配置监控阈值;</li>
<li>根据压测结果按需调整硬件资源;</li>
</ul>
<h4 id="上线前-环境检查"><a href="#上线前-环境检查" class="headerlink" title="上线前:环境检查"></a>上线前:环境检查</h4><p>按照最佳实践要求对生产环境所使用的操作系统进行检查和调整。最常见的需要调整的参数包括:</p>
<ul>
<li>禁用NUMA，否则在某些情况下会引起突发大量swap交换</li>
<li>禁用Transparent Huge Page，否则会影响数据库效率;</li>
<li>tcp keepalive time调整为120秒，避免一些网络问题;</li>
<li>ulimit -n，避免打开文件句柄不足的情况;</li>
<li>关闭atime，提高数据文件访问效率;</li>
</ul>
<p>更多检查项，请参考文档:<a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/administration/production-notes/">Production Notes</a></p>
<h4 id="上线后"><a href="#上线后" class="headerlink" title="上线后"></a>上线后</h4><p>性能监控</p>
<ul>
<li>为防止突发状况，应对常见性能指标进行监控以及时发现问题。</li>
<li>性能监控请参考前述章节的内容</li>
</ul>
<p>定期健康检查</p>
<ul>
<li>mongod日志;</li>
<li>环境设置是否有变动;</li>
<li>MongoDB配置是否有变动</li>
</ul>
<h4 id="MongoDB-版本发布规律"><a href="#MongoDB-版本发布规律" class="headerlink" title="MongoDB 版本发布规律"></a>MongoDB 版本发布规律</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB版本发布规律.png" alt="MongoDB版本发布规律"></p>
<h4 id="主版本升级流程"><a href="#主版本升级流程" class="headerlink" title="主版本升级流程"></a>主版本升级流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/主版本升级流程.png" alt="主版本升级流程"></p>
<p><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/drivers/compatibility/">https://www.mongodb.com/docs/drivers/compatibility/</a></p>
<h4 id="MongoDB单机升级流程"><a href="#MongoDB单机升级流程" class="headerlink" title="MongoDB单机升级流程"></a>MongoDB单机升级流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB单机升级流程.png" alt="MongoDB单机升级流程"></p>
<h4 id="MongoDB复制集升级流程"><a href="#MongoDB复制集升级流程" class="headerlink" title="MongoDB复制集升级流程"></a>MongoDB复制集升级流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB复制集升级流程.png" alt="MongoDB复制集升级流程"></p>
<h4 id="MongoDB分片集群升级流程"><a href="#MongoDB分片集群升级流程" class="headerlink" title="MongoDB分片集群升级流程"></a>MongoDB分片集群升级流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/MongoDB分片集群升级流程.png" alt="MongoDB分片集群升级流程"></p>
<h4 id="版本升级-在线升级"><a href="#版本升级-在线升级" class="headerlink" title="版本升级:在线升级"></a>版本升级:在线升级</h4><p>MongoDB支持在线升级，即升级过程中不需要间断服务;</p>
<p>升级过程中虽然会发生主从节点切换，存在短时间不可用，但是:</p>
<ul>
<li>3.6版本开始支持自动写重试可以自动恢复主从切换引起的集群暂时不可写，</li>
<li>4.2开始支持的自动读重试则提供了包括主从切换在内的读问题的自动恢复;</li>
</ul>
<p>升级需要逐版本完成，不可以跳版本:</p>
<ul>
<li>正确:3.2-&gt;3.4-&gt;3.6-&gt;4.0-&gt;4.2</li>
<li>错误:3.2-&gt;4.2</li>
<li>原因:<ul>
<li>MongoDB复制集仅仅允许相邻版本共存</li>
<li>有一些升级内部数据格式如密码加密字段，需要在升级过程中由mongo进行转换</li>
</ul>
</li>
</ul>
<h4 id="升级流程-降级"><a href="#升级流程-降级" class="headerlink" title="升级流程:降级"></a>升级流程:降级</h4><p>如果升级无论因何种原因失败，则需要降级到原有旧版本。在降级过程中:</p>
<ul>
<li>滚动降级过程中集群可以保持在线，仅在切换节点时会产生一定的不可写时间;</li>
<li>降级前应先去除已经用到的新版本特性。例如用到了NumberDecimal则应把所有使用NumberDecimal的文档先去除该字段;</li>
<li>通过设置FCV(Feature compatibility Version)可以在功能上降到与旧版本兼容;</li>
<li>FCV设置完成后再滚动替换为旧版本。</li>
</ul>
<h3 id="41丨MongoDB应用场景及选型"><a href="#41丨MongoDB应用场景及选型" class="headerlink" title="41丨MongoDB应用场景及选型"></a>41丨MongoDB应用场景及选型</h3><h4 id="MongoDB-数据库定位"><a href="#MongoDB-数据库定位" class="headerlink" title="MongoDB 数据库定位"></a>MongoDB 数据库定位</h4><ul>
<li>OLTP 数据库</li>
<li>原则上 Oracle 和 MySQL能做的事情，MongoDB 都能做(包括 ACID 事务)</li>
<li>优点:横向扩展能力，数据量或并发量增加时候架构可以自动扩展</li>
<li>优点:灵活模型，适合迭代开发，数据模型多变场景</li>
<li>优点:JSON 数据结构，适合微服务/REST API</li>
</ul>
<h4 id="基于功能选择-MongoDB"><a href="#基于功能选择-MongoDB" class="headerlink" title="基于功能选择 MongoDB"></a>基于功能选择 MongoDB</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《MongoDB高手课》学习笔记/基于功能选择MongoDB.png" alt="基于功能选择MongoDB"></p>
<h4 id="基于场景选择-MongoDB"><a href="#基于场景选择-MongoDB" class="headerlink" title="基于场景选择 MongoDB"></a>基于场景选择 MongoDB</h4><ul>
<li>移动/小程序App</li>
<li>SaaS 应用</li>
<li>电商</li>
<li>主机分流</li>
<li>内容管理</li>
<li>实时分析</li>
<li>物联网</li>
<li>关系型迁移</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/mongodb-gao-shou-ke-xue-xi-bi-ji/">https://kibazen.cn/mongodb-gao-shou-ke-xue-xi-bi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                    <span class="chip bg-color">极客时间</span>
                                </a>
                            
                                <a href="/tags/MongoDB/">
                                    <span class="chip bg-color">MongoDB</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/javascript-yu-yan-jing-cui-du-shu-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/3.jpg" class="responsive-img" alt="《JavaScript语言精粹》读书笔记">
                        
                        <span class="card-title">《JavaScript语言精粹》读书笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-10-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/javascript/">
                        <span class="chip bg-color">javascript</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/redis-he-xin-yuan-li-yu-shi-zhan-xue-xi-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/18.jpg" class="responsive-img" alt="《Redis 核心原理与实战》学习笔记">
                        
                        <span class="card-title">《Redis 核心原理与实战》学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-06-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:5093911+kibaamor@users.noreply.github.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
