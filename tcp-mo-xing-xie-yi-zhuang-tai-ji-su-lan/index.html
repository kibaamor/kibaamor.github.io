<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="TCP模型协议状态机速览, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="一个普通游戏程序员的博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>TCP模型协议状态机速览 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/leetcode/" class="waves-effect waves-light">
      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>LeetCode</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>学习</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/softwares/" class="waves-effect waves-light">
      
      <i class="fas fa-toolbox" style="zoom: 0.6;"></i>
      
      <span>软件</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            一个普通游戏程序员的博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/leetcode/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-code"></i>
			
			LeetCode
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			学习
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/softwares/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-toolbox"></i>
			
			软件
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">TCP模型协议状态机速览</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/">
                                <span class="chip bg-color">TCP状态机</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%BD%91%E7%BB%9C/" class="post-category">
                                网络
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-11
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-08-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    7 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="一、OSI模型"><a href="#一、OSI模型" class="headerlink" title="一、OSI模型"></a>一、OSI模型</h2><p><img src="/images/TCP模型协议状态机速览/计算机网络体系结构.png" alt="计算机网络体系结构"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>名字</th>
<th>说明</th>
<th>数据包名</th>
<th>常用格式协议</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>允许访问OSI环境的手段</td>
<td>应用协议数据单元 APDU</td>
<td>HTTP、FTP、TELNET、DNS、BT、NTP、DHCP、SNMP</td>
</tr>
<tr>
<td>表示层</td>
<td>对数据进行翻译、加密和压缩</td>
<td>表示协议数据单元 PPDU</td>
<td>JPEG、MPEG、ASCll</td>
</tr>
<tr>
<td>会话层</td>
<td>建立、管理和终止会话</td>
<td>会话协议数据单元 SPDU</td>
<td>SSL、TLS、NFS、SQL、NETBIOS、RPC</td>
</tr>
<tr>
<td>传输层</td>
<td>提供端到端的可靠报文传递和错误恢复</td>
<td>段 Segment</td>
<td>TCP、UDP、SPX</td>
</tr>
<tr>
<td>网络层</td>
<td>负责数据包从源到宿的传递和网际互连</td>
<td>包 Packet</td>
<td>IP、ICMP、ARP、RARP、OSPF、IPX、RIP、IGRP（路由器）</td>
</tr>
<tr>
<td>数据链路层</td>
<td>将比特组装成帧和点到点的传递</td>
<td>帧 Frame</td>
<td>PPP、FR、HDLC、VLAN、MAC（网桥，交换机）</td>
</tr>
<tr>
<td>物理层</td>
<td>通过媒介传输比特，确定机械及电气规范</td>
<td>比特 Bit</td>
<td>RJ45、CLOCK、IEEE802.3（中继器，集线器）</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="http://www.colasoft.com.cn/download/protocols_map.php">网络通讯协议图</a></p>
</blockquote>
<h2 id="二、常用协议"><a href="#二、常用协议" class="headerlink" title="二、常用协议"></a>二、常用协议</h2><h3 id="以太网协议头格式"><a href="#以太网协议头格式" class="headerlink" title="以太网协议头格式"></a>以太网协议头格式</h3><p><img src="/images/TCP模型协议状态机速览/以太网协议头格式.png" alt="以太网协议头格式"></p>
<h3 id="ICMP协议头格式"><a href="#ICMP协议头格式" class="headerlink" title="ICMP协议头格式"></a>ICMP协议头格式</h3><p><img src="/images/TCP模型协议状态机速览/ICMP协议头格式.png" alt="ICMP协议头格式"></p>
<h3 id="IPv4协议头格式"><a href="#IPv4协议头格式" class="headerlink" title="IPv4协议头格式"></a>IPv4协议头格式</h3><p><img src="/images/TCP模型协议状态机速览/IPv4协议头格式.png" alt="IPv4协议头格式"></p>
<h3 id="TCP协议头格式"><a href="#TCP协议头格式" class="headerlink" title="TCP协议头格式"></a>TCP协议头格式</h3><p><img src="/images/TCP模型协议状态机速览/TCP协议头格式.png" alt="TCP协议头格式"></p>
<h3 id="UDP协议头格式"><a href="#UDP协议头格式" class="headerlink" title="UDP协议头格式"></a>UDP协议头格式</h3><p><img src="/images/TCP模型协议状态机速览/UDP协议头格式.png" alt="UDP协议头格式"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="https://nmap.org/book/tcpip-ref.html">TCP/IP Reference</a></p>
</blockquote>
<h2 id="三、TCP状态机"><a href="#三、TCP状态机" class="headerlink" title="三、TCP状态机"></a>三、TCP状态机</h2><h3 id="完整TCP连接和断开状态图"><a href="#完整TCP连接和断开状态图" class="headerlink" title="完整TCP连接和断开状态图"></a>完整TCP连接和断开状态图</h3><p><img src="/images/TCP模型协议状态机速览/完整TCP连接和断开状态图.png" alt="完整TCP连接和断开状态图"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm">TCP Operational Overview and the TCP Finite State Machine (FSM) 2</a></p>
</blockquote>
<h3 id="TCP断开状态图"><a href="#TCP断开状态图" class="headerlink" title="TCP断开状态图"></a>TCP断开状态图</h3><p><img src="/images/TCP模型协议状态机速览/TCP断开状态图.png" alt="TCP断开状态图"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPConnectionTermination-2.htm">TCP Connection Termination 2</a></p>
</blockquote>
<h3 id="TCP双方同时断开状态图"><a href="#TCP双方同时断开状态图" class="headerlink" title="TCP双方同时断开状态图"></a>TCP双方同时断开状态图</h3><p><img src="/images/TCP模型协议状态机速览/TCP双方同时断开状态图.png" alt="TCP双方同时断开状态图"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPConnectionTermination-4.htm">TCP Connection Termination 4</a></p>
</blockquote>
<h3 id="实际操作和截图"><a href="#实际操作和截图" class="headerlink" title="实际操作和截图"></a>实际操作和截图</h3><h4 id="1-TCP连接发送数据断开的Wireshark截图"><a href="#1-TCP连接发送数据断开的Wireshark截图" class="headerlink" title="1. TCP连接发送数据断开的Wireshark截图"></a>1. TCP连接发送数据断开的Wireshark截图</h4><p><img src="/images/TCP模型协议状态机速览/TCP连接发送数据断开的Wireshark截图.png" alt="TCP连接发送数据断开的Wireshark截图"></p>
<ul>
<li><p>让Wireshark显示绝对的sequence numbers</p>
<p>  在菜单栏依次点击 <code>编辑</code> -&gt; <code>首选项</code> -&gt; <code>Protocols</code> -&gt; <code>TCP</code> 中，取消选项 <code>Relative sequence numbers</code> 前的复选框。</p>
</li>
<li><p>如何显示截图的界面</p>
<p>  在菜单栏依次点击 <code>统计</code> -&gt; <code>流量图</code>，然后点击右键，在弹出的选项中选择<code>放大</code>/<code>缩小</code>调整图形。</p>
</li>
</ul>
<h4 id="2-环境及操作"><a href="#2-环境及操作" class="headerlink" title="2. 环境及操作"></a>2. 环境及操作</h4><p>两台机器分别是：</p>
<ul>
<li>A: 192.168.81.88（Windows 10）</li>
<li>B: 192.168.20.122（CentOS 7.7）</li>
</ul>
<p>操作步骤：</p>
<ol>
<li>B在9999端口监听TCP连接。</li>
<li>A连接B的9999端口。</li>
<li>A向B发送4个字节的数据。</li>
<li>B向A发送4个字节的数据。</li>
<li>B主动断开连接。</li>
</ol>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="1-TIME-WAIT会在什么情况下出现"><a href="#1-TIME-WAIT会在什么情况下出现" class="headerlink" title="1. TIME_WAIT会在什么情况下出现"></a>1. TIME_WAIT会在什么情况下出现</h4><p>首先，TIME_WAIT状态只会出现在主动断开TCP的那一方。</p>
<p>其次，当断开TCP的主动方收到了被动方发来的FIN包并回复对应的ACK包给被动方后，主动方就进入了TIME_WAIT状态。然后等待<code>2 * MSL</code>时间（此时间段内如果再次收到被动方发来的FIN消息，说明之前回复的ACK包丢失，需要重新发送给被动方，并重新开始计时）后，再进入CLOSED状态，此时才能完成的释放相关的资源。</p>
<h4 id="2-什么是MSL"><a href="#2-什么是MSL" class="headerlink" title="2. 什么是MSL"></a>2. 什么是MSL</h4><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Maximum_segment_lifetime">MSL, Maximum Segment Lifetime</a>，TCP Segment在网络上的最长存活时间。</p>
<p><a href="www.rfc-editor.org/rfc/rfc793.txt">RFC793</a>将MSL定义为2分钟。Linux下MSL默认是30秒，Windows下MSL默认是240秒。Linux下可以通过下面的命令查看实际的MSL值。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sysctl net.ipv4.tcp_fin_timeout
<span class="token function">cat</span> /proc/sys/net/ipv4/tcp_fin_timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="3-为什么不直接进入CLOSED状态，还需要等待2-MSL时间"><a href="#3-为什么不直接进入CLOSED状态，还需要等待2-MSL时间" class="headerlink" title="3. 为什么不直接进入CLOSED状态，还需要等待2 * MSL时间"></a>3. 为什么不直接进入CLOSED状态，还需要等待<code>2 * MSL</code>时间</h4><p>主要原因有两个：</p>
<ol>
<li><p>进入TIME_WAIT状态并等待<code>2 * MSL</code>，保证了如果被动方没有收到主动方回复的ACK，被动方至少有时间能重发一次之前FIN包。一回一重发，正好<code>2 * MSL</code>。</p>
<blockquote>
<p>如果主动方回的ACK包丢失，被动方重发的FIN包也丢失，那么就不管了。</p>
</blockquote>
</li>
<li><p>避免断开的TCP连接不影响后面新建立的TCP连接。</p>
<blockquote>
<p>如果主动方不等待<code>2*MSL</code>直接进入CLOSED状态，然后再重新建立TCP连接，如果此时收到了之前关闭的被动方重发FIN消息，那么重新建立的TCP连接就会被断开。</p>
</blockquote>
</li>
</ol>
<h2 id="四、TCP滑动窗口"><a href="#四、TCP滑动窗口" class="headerlink" title="四、TCP滑动窗口"></a>四、TCP滑动窗口</h2><h3 id="1-什么是滑动窗口"><a href="#1-什么是滑动窗口" class="headerlink" title="1. 什么是滑动窗口"></a>1. 什么是滑动窗口</h3><p>滑动窗口（Sliding Window），也叫发送窗口（Send Window），滑动窗口表明接收方有多少空间来接收数据。在TCP连接建立的过程中协商滑动窗口的大小，当连接成功建立后，双方的滑动窗口的大小都协商好了。在通信的过程中也可以动态的修改滑动窗口的大小。</p>
<p>滑动窗口主要用来做流控（Flow Control），它主要受TCP连接双方内存大小的影响，并不直接关心网速等问题。所以完整的TCP控制除了流控（Flow Control）外，还有需要拥塞处理（Congestion Handling）来处理网络相关的问题。</p>
<p><img src="/images/TCP模型协议状态机速览/什么是滑动窗口.png" alt="什么是滑动窗口"></p>
<ol>
<li>已经收到ACK确认的数据。字节1-31。</li>
<li>在滑动窗口中，已经发送出去了，但是还没收到ACK确认的数据。字节32-45。</li>
<li>在滑动窗口中，还没发送出去的数据（接收方还有空间接收）。字节46-51。</li>
<li>待发送的数据（接收方没有空间接收）。字节52及以上。</li>
</ol>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo-6.htm">TCP Sliding Window Acknowledgment System For Data Transport, Reliability and Flow Control 6</a></p>
</blockquote>
<h3 id="2-滑动窗口怎么工作"><a href="#2-滑动窗口怎么工作" class="headerlink" title="2. 滑动窗口怎么工作"></a>2. 滑动窗口怎么工作</h3><ol>
<li><p>当上图中所有滑动窗口内的数据都发送出后，滑动窗口内的状态变成了下图的状态：</p>
<p> <img src="/images/TCP模型协议状态机速览/滑动窗口内的数据都已被发送但未被确认.png" alt="滑动窗口内的数据都已被发送但未被确认"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo-7.htm">TCP Sliding Window Acknowledgment System For Data Transport, Reliability and Flow Control 7</a></p>
</blockquote>
<ol>
<li>已经收到ACK确认的数据。字节1-31。</li>
<li>在滑动窗口中，已经发送出去了，但是还没收到ACK确认的数据。字节32-51。</li>
<li>在滑动窗口中，还没发送出去的数据（接收方还有空间接收）。无。</li>
<li>待发送的数据（接收方没有空间接收）。字节52及以上。</li>
</ol>
</li>
<li><p>如果一段时间后，收到了32-36字节的ACK确认消息，那么滑动窗口就会向后面滑动，并可以发送字节52-56。如下图：</p>
<p> <img src="/images/TCP模型协议状态机速览/滑动窗口收到确认后向后滑动.png" alt="滑动窗口收到确认后向后滑动"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo-8.htm">TCP Sliding Window Acknowledgment System For Data Transport, Reliability and Flow Control 8</a></p>
</blockquote>
<ol>
<li>已经收到ACK确认的数据。字节1-36。</li>
<li>在滑动窗口中，已经发送出去了，但是还没收到ACK确认的数据。字节37-51。</li>
<li>在滑动窗口中，还没发送出去的数据（接收方还有空间接收）。字节52-56。</li>
<li>待发送的数据（接收方没有空间接收）。字节57及以上。</li>
</ol>
</li>
<li><p>循环上面的步骤就能够一直发送数据了。如下图（下图中滑动窗口没有向后滑动，所以最后滑动窗口的大小会变成0）：</p>
<p> <img src="/images/TCP模型协议状态机速览/滑动窗口完整工作流程.png" alt="滑动窗口完整工作流程"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPWindowSizeAdjustmentandFlowControl-2.htm">TCP Window Size Adjustment and Flow Control 2</a></p>
</blockquote>
</li>
</ol>
<h3 id="3-常见问题"><a href="#3-常见问题" class="headerlink" title="3. 常见问题"></a>3. 常见问题</h3><h4 id="1-如果滑动窗口变成了0会发生什么"><a href="#1-如果滑动窗口变成了0会发生什么" class="headerlink" title="1. 如果滑动窗口变成了0会发生什么"></a>1. 如果滑动窗口变成了0会发生什么</h4><p>当滑动窗口减少到0后，就不能再发送数据给对方了。此时可以发送<code>Zero Window Probe</code>包给对方，这样在对方回复此包的ACK的同时，可以更新滑动窗口的大小。</p>
<h4 id="2-什么是“糊涂窗口综合症”"><a href="#2-什么是“糊涂窗口综合症”" class="headerlink" title="2. 什么是“糊涂窗口综合症”"></a>2. 什么是“糊涂窗口综合症”</h4><p>如果发送方每次都发送很少的字节，或者接受方每次都处理很少的字节时，或者双方都有的情况下，就叫<code>糊涂窗口综合症（Silly Window Syndrome）</code>。因为每次发送出去的字节数很少，比如几个字节，明显小于了TCP/IP的协议头的大小（TCP+IP头有40个字节），此时网络传输的效率就很低。</p>
<p>一个解决办法就是使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Nagle%27s_algorithm">纳格算法，Nagle’s algorithm</a>，这个算法默认是启用的。该算法的伪代码如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">if there is new data to send then
    if the window size ≥ MSS and available data is ≥ MSS then
        send complete MSS segment now
    else
        if there is unconfirmed data still in the pipe then
            enqueue data in the buffer until an acknowledge is received
        else
            send data immediately
        end if
    end if
end if<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="五、TCP拥塞处理"><a href="#五、TCP拥塞处理" class="headerlink" title="五、TCP拥塞处理"></a>五、TCP拥塞处理</h2><h3 id="1-为什么需要拥塞处理"><a href="#1-为什么需要拥塞处理" class="headerlink" title="1. 为什么需要拥塞处理"></a>1. 为什么需要拥塞处理</h3><p>如果网络延时突然增大丢包严重，TCP发送出去的数据包，很久都没收到对应包的ACK，那么TCP就只能选择重传该数据包。但是不能无限制不间断的重发数据包，因为这会增加网络的负担，导致更大的网络延迟和更多的网络丢包，所以需要拥塞处理（Congestion Handling）来控制数据包的重发。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/tcp-mo-xing-xie-yi-zhuang-tai-ji-su-lan/">https://kibazen.cn/tcp-mo-xing-xie-yi-zhuang-tai-ji-su-lan/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/">
                                    <span class="chip bg-color">TCP状态机</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/effective-modern-c-du-shu-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/19.jpg" class="responsive-img" alt="《Effective Modern C++》读书笔记">
                        
                        <span class="card-title">《Effective Modern C++》读书笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CPP/">
                        <span class="chip bg-color">CPP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/shen-du-tan-suo-c-dui-xiang-mo-xing-du-shu-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/4.jpg" class="responsive-img" alt="《深度探索C++对象模型》读书笔记">
                        
                        <span class="card-title">《深度探索C++对象模型》读书笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CPP/">
                        <span class="chip bg-color">CPP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (true) {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 木叶禅<br />'
            + '文章作者: Kiba Amor<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者木叶禅所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">154.5k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>









    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=562236616" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 562236616" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/kibaamor" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kibaamor" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
