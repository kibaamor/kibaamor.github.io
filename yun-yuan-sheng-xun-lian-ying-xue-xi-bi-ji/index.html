<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="《云原生训练营》学习笔记, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="You are too concerned with what was and what will be">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>《云原生训练营》学习笔记 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>Learn</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/memo/" class="waves-effect waves-light">
      
      <i class="fas fa-sticky-note" style="zoom: 0.6;"></i>
      
      <span>Memo</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            You are too concerned with what was and what will be
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			Learn
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/memo/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sticky-note"></i>
			
			Memo
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'f65e070788a2647953051a7a1b70ada7fd2b3f70cd4d93c977207f5b762987d4';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">《云原生训练营》学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                <span class="chip bg-color">极客时间</span>
                            </a>
                        
                            <a href="/tags/kubernetes/">
                                <span class="chip bg-color">kubernetes</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-03-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-05-21
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    57.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    240 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>课程资源： <a target="_blank" rel="noopener" href="https://github.com/kibaamor/101">https://github.com/kibaamor/101</a></p>
<p>代码走读：<a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/source-code-reading/readme.MD">https://github.com/kibaamor/101/blob/master/source-code-reading/readme.MD</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/golang-843c958dafc54f0aab4fa1e4527da78a">https://cncamp.notion.site/golang-843c958dafc54f0aab4fa1e4527da78a</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/kubernetes-8a9d48ee26284b3c8ddf9de4c62ea895">https://cncamp.notion.site/kubernetes-8a9d48ee26284b3c8ddf9de4c62ea895</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/mesh-adf426d889f0448faa1671f5e05c9f12">https://cncamp.notion.site/mesh-adf426d889f0448faa1671f5e05c9f12</a></p>
<p>iptables: <a target="_blank" rel="noopener" href="https://ipset.netfilter.org/iptables-extensions.man.html">https://ipset.netfilter.org/iptables-extensions.man.html</a></p>
<h2 id="Go-语言特性"><a href="#Go-语言特性" class="headerlink" title="Go 语言特性"></a>Go 语言特性</h2><h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><h4 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h4><ul>
<li>并发（concurrency）：两个或多个事件在同一时间间隔发生。</li>
<li>并行（parallellism）：两个或者多个事件在同一时刻发生。</li>
</ul>
<h2 id="Go-语言进阶"><a href="#Go-语言进阶" class="headerlink" title="Go 语言进阶"></a>Go 语言进阶</h2><h3 id="线程调度"><a href="#线程调度" class="headerlink" title="线程调度"></a>线程调度</h3><h4 id="深入理解-Go-语言线程调度"><a href="#深入理解-Go-语言线程调度" class="headerlink" title="深入理解 Go 语言线程调度"></a>深入理解 Go 语言线程调度</h4><ul>
<li>进程：资源分配的基本单位</li>
<li>线程：调度的基本单位</li>
<li>无论是线程还是进程，在 linux 中都以 task_struct 描述，从内核角度看，与进程无本质区别</li>
<li>Glibc 中的 pthread 库提供 NPTL（Native POSIX Threading Library）支持</li>
</ul>
<h4 id="进程切换开销"><a href="#进程切换开销" class="headerlink" title="进程切换开销"></a>进程切换开销</h4><ol>
<li>直接开销<ul>
<li>切换页表全局目录（PGD）</li>
<li>切换内核态堆栈</li>
<li>切换硬件上下文（进程恢复前，必须装入寄存器的数据统称为硬件上下文）</li>
<li>刷新TLB</li>
<li>系统调度器的代码执行</li>
</ul>
</li>
<li>间接开销<ul>
<li>CPU 缓存失效导致的进程需要到内存直接访问的IO 操作变多</li>
</ul>
</li>
</ol>
<h4 id="线程切换开销"><a href="#线程切换开销" class="headerlink" title="线程切换开销"></a>线程切换开销</h4><ul>
<li>线程本质上只是一批共享资源的进程，线程切换本质上依然需要内核进行进程切换。</li>
<li>一组线程因为共享内存资源，因此一个进程的所有线程共享虚拟地址空间，线程切换相比进程切换，<strong>主要节省了虚拟地址空间的切换</strong>。</li>
</ul>
<h4 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h4><p>Go 语言基于 GMP 模型实现用户态线程</p>
<ul>
<li>G：表示 goroutine，每个 goroutine 都有自己的栈空间，定时器，初始化的栈空间在2k 左右，空间会随着需求增长。</li>
<li>M：抽象化代表内核线程，记录内核线程栈信息，当 goroutine 调度到线程时，使用该 goroutine 自己的栈信息。</li>
<li>P：代表调度器，负责调度 goroutine，维护一个本地 goroutine 队列，M 从 P 上获得 goroutine 并执行，同时还负责部分内存的管理。</li>
</ul>
<h4 id="GMP模型细节"><a href="#GMP模型细节" class="headerlink" title="GMP模型细节"></a>GMP模型细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GMP模型细节.png" alt="GMP模型细节"></p>
<h4 id="G-所处的位置"><a href="#G-所处的位置" class="headerlink" title="G 所处的位置"></a>G 所处的位置</h4><ul>
<li>进程都有一个全局的 G 队列</li>
<li>每个 P 拥有自己的本地执行队列</li>
<li>有不在运行队列中的 G<ul>
<li>处于 channel 阻塞态的 G 被放在 sudog</li>
<li>脱离 P 绑定在 M 上的 G，如系统调用</li>
<li>为了复用，执行结束进入 P 的 gFree 列表中的 G</li>
</ul>
</li>
</ul>
<h4 id="Goroutine-创建过程"><a href="#Goroutine-创建过程" class="headerlink" title="Goroutine 创建过程"></a>Goroutine 创建过程</h4><ul>
<li>获取或者创建新的 Goroutine 结构体<ul>
<li>从处理器的 gFree 列表中查找空闲的 Goroutine</li>
<li>如果不存在空闲的 Goroutine，会通过 runtime.malg 创建一个栈大小足够的新结构体</li>
</ul>
</li>
<li>将函数传入的参数移到 Goroutine 的栈上</li>
<li>更新 Goroutine 调度相关的属性，更新状态为 _Grunnable</li>
<li>返回的 Goroutine 会存储到全局变量 allgs 中</li>
</ul>
<h4 id="将-Goroutine-放到运行队列上"><a href="#将-Goroutine-放到运行队列上" class="headerlink" title="将 Goroutine 放到运行队列上"></a>将 Goroutine 放到运行队列上</h4><blockquote>
<p>关键函数 <code>func runqput(pp *p, gp *g, next bool)</code></p>
</blockquote>
<ul>
<li>Goroutine 设置到处理器的 runnext 作为下一个处理器执行的任务</li>
<li>当处理器的本地运行队列已经没有剩余空间时，就会把本地队列中的前一半 Goroutine 和待加入的 Goroutine 一起打乱顺序后通过 <code>runtime.runqputslow</code> 添加到调度器持有的全局运行队列上</li>
</ul>
<h4 id="调度器行为"><a href="#调度器行为" class="headerlink" title="调度器行为"></a>调度器行为</h4><blockquote>
<p>关键函数 <code>func schedule()</code></p>
<p>可以参考的资料<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/586236582">《深入分析Go1.18 GMP调度器底层原理》</a></p>
</blockquote>
<ul>
<li>为了保证公平，当全局运行队列中有待执行的 Goroutine 时，通过 schedtick 保证有一定几率(1/61) 通过 <code>runtime.globrunqget</code> 从全局的运行队列中查找一个的 Goroutine 来运行</li>
<li>从处理器本地的运行队列中查找待执行的 Goroutine</li>
<li>如果前两种方法都没有找到 Goroutine，会通过 <code>runtime.findrunnable</code> 进行阻塞地查找 Goroutine</li>
<li>从本地运行队列、全局运行队列中查找</li>
<li>从网络轮询器中查找是否有 Goroutine 等待运行</li>
<li>通过 runtime.runqsteal 尝试从其他随机的处理器中窃取待运行的 Goroutine</li>
</ul>
<h5 id="源码走读"><a href="#源码走读" class="headerlink" title="源码走读"></a>源码走读</h5><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/scheduling-b32ff8b83f674741ba9c2ecfd592f997">scheduling</a></p>
<p>关于M和P的数量的问题答疑昨天群里陷入了讨论，我看了一下代码把调用关系列在了这个文档里</p>
<p><strong>设计考量</strong></p>
<ul>
<li>默认配置下，P的数量 = CPU个数，可通过GOMAXPROCS修改，上限是256</li>
<li>M数量是内核线程数量，M大于P，上限是10000</li>
<li>P的数量在调度器初始化的procresize中控制</li>
<li>当调度器进行调度，唤醒P的时候，会通过met获取idle m，如果获取不到，则创建新的M（也就是内核线程）</li>
<li>这样做的目的是，M可能陷入系统调用，而系统调用可能是阻塞的，比如磁盘读取，这个时候CPU是空闲的，创建新的M并与P关联，可以让更多的G被调度，充分利用CPU。</li>
</ul>
<p><strong>代码分析</strong></p>
<p><code>/usr/local/go/src/runtime/proc.go</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    sched<span class="token punctuation">.</span>maxmcount <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">// m count limit is 10000 by default</span>
    procs <span class="token operator">=</span> <span class="token function">atoi32</span><span class="token punctuation">(</span><span class="token function">gogetenv</span><span class="token punctuation">(</span><span class="token string">"GOMAXPROCS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">procresize</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        nallp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">,</span> nprocs<span class="token punctuation">)</span> <span class="token comment">// P count is read from environment variable GOMAXPROCS</span>
        pp<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// mget to associate p with idle m</span>

<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token function">startm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            nmp <span class="token operator">:=</span> <span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> nmp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">newm</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> _p_<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    mp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
                    mp<span class="token punctuation">.</span>g0 <span class="token operator">=</span> <span class="token function">malg</span><span class="token punctuation">(</span><span class="token number">8192</span> <span class="token operator">*</span> sys<span class="token punctuation">.</span>StackGuardMultiplier<span class="token punctuation">)</span> <span class="token comment">// g0 is the maintainer for the m, like create other G</span>
            <span class="token punctuation">}</span>
            nmp<span class="token punctuation">.</span>nextp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>
            <span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nmp<span class="token punctuation">.</span>park<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token function">semawakeup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp<span class="token punctuation">.</span>cond<span class="token punctuation">)</span> <span class="token comment">// wake up the kernel thread</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><h4 id="TCMalloc"><a href="#TCMalloc" class="headerlink" title="TCMalloc"></a>TCMalloc</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://goog-perftools.sourceforge.net/doc/tcmalloc.html">TCMalloc : Thread-Caching Malloc</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/TCMalloc.png" alt="TCMalloc"></p>
<ul>
<li>page: 内存页，一块 8K 大小的内存空间。Go 与操作系统之间的内存申请和释放，都是以 page 为单位的</li>
<li>span: 内存块，一个或多个连续的 page 组成一个 span</li>
<li>sizeclass: 空间规格，每个 span 都带有一个 sizeclass ，标记着该 span 中的 page 应该如何使用</li>
<li><p>object: 对象，用来存储一个变量数据内存空间，一个 span 在初始化时，会被切割成一堆等大的 object ；假设 object 的大小是 16B ，span 大小是 8K ，那么就会把 span 中的 page 就会被初始化 8K / 16B = 512 个 object 。所谓内存分配，就是分配一个object 出去</p>
</li>
<li><p>对象大小定义</p>
<ul>
<li>小对象大小：0~256KB</li>
<li>中对象大小：256KB~1MB</li>
<li>大对象大小：&gt;1MB</li>
</ul>
</li>
<li>小对象的分配流程<ul>
<li>ThreadCache -&gt; CentralCache -&gt; PageHeap，大部分时候，ThreadCache 缓存都是足够的，不需要去访问 CentralCache 和 PageHeap，无系统调用配合无锁分配，分配效率是非常高的</li>
</ul>
</li>
<li>中对象分配流程<ul>
<li>直接在 PageHeap 中选择适当的大小即可，128 Page 的 Span 所保存的最大内存就是 1MB</li>
</ul>
</li>
<li>大对象分配流程<ul>
<li>从 large span set 选择合适数量的页面组成 span，用来存储数据</li>
</ul>
</li>
</ul>
<h4 id="Go-语言内存分配"><a href="#Go-语言内存分配" class="headerlink" title="Go 语言内存分配"></a>Go 语言内存分配</h4><blockquote>
<p>关键函数 <code>func mallocgc</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/go1.22.1/src/runtime/malloc.go#L7">Go 语言的内存分配器是基于 TCMalloc 实现的</a>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coldnight/go-memory-allocator-visual-guide">Go 语言内存分配可视化指南（A visual guide to Go Memory Allocator from scratch (Golang)）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sobyte.net/post/2021-12/golang-memory-allocator/">Principle of memory allocator implementation in Go language</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Go语言内存分配.png" alt="Go语言内存分配"></p>
<ul>
<li><p>对象大小定义</p>
<ul>
<li>小（Small）对象：&lt;=32KB<ul>
<li>其中大小 &lt;16B 且不是指针的对象称为微（Tiny）对象</li>
</ul>
</li>
<li>大（Large）对象：&gt;32KB</li>
</ul>
</li>
<li><p>mcache：小对象的内存分配直接走</p>
<ul>
<li>size class 从 1 到 66，每个 class 两个 span （scan 和 noscan）</li>
<li>Span 大小是 8KB，按 span class 大小切分</li>
</ul>
</li>
<li>mcentral<ul>
<li>Span 内的所有内存块都被占用时，没有剩余空间继续分配对象，mcache 会向 mcentral 申请 1 个 span，mcache 拿到 span 后继续分配对象</li>
<li>当 mcentral 向 mcache 提供 span 时，如果没有符合条件的 span，mcentral 会向 mheap 申请 span</li>
</ul>
</li>
<li>mheap<ul>
<li>当 mheap 没有足够的内存时，mheap 会向 OS 申请内存</li>
<li>mheap 把 Span 组织成了树结构，而不是链表</li>
<li>然后把 Span 分配到 heapArena 进行管理，它包含地址映射和 span 是否包含指针等位图<ul>
<li>为了更高效的分配、回收和再利用内存</li>
</ul>
</li>
</ul>
</li>
<li>mspan<ul>
<li>allocBits<ul>
<li>记录了每块内存分配的情况</li>
</ul>
</li>
<li>gcmarkBits<ul>
<li>记录了每块内存的引用情况，标记阶段对每块内存进行标记，有对象引用的内存标记为 1，没有的标记为 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Go-语言-GC"><a href="#Go-语言-GC" class="headerlink" title="Go 语言 GC"></a>Go 语言 GC</h4><blockquote>
<p>Golang 的汇编看不懂时可以看 <a target="_blank" rel="noopener" href="https://go.dev/doc/asm">A Quick Guide to Go’s Assembler</a></p>
<p>可以参考的资料<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/02/gc1.html">《Golang 垃圾回收（一）概述》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/02/gc2.html">《golang 垃圾回收（二）屏障技术》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/03/gc3.html">《golang 垃圾回收（三）插入写屏障》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/13/gc4.html">《golang 垃圾回收（四）删除写屏障》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%86%99%E5%B1%8F%E9%9A%9C/2020/07/24/gc5.html">《golang 垃圾回收（五）混合写屏障》</a></p>
</blockquote>
<p>混合写屏障伪代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/runtime/mbarrier.go</span>

<span class="token comment">// Go uses a hybrid barrier that combines a Yuasa-style deletion</span>
<span class="token comment">// barrier—which shades the object whose reference is being</span>
<span class="token comment">// overwritten—with Dijkstra insertion barrier—which shades the object</span>
<span class="token comment">// whose reference is being written. The insertion part of the barrier</span>
<span class="token comment">// is necessary while the calling goroutine's stack is grey. In</span>
<span class="token comment">// pseudocode, the barrier is:</span>
<span class="token function">writePointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">shade</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span>    <span class="token comment">// 删除写屏障（Yuasa-style 屏障）</span>
    <span class="token keyword">if</span> current stack is grey<span class="token punctuation">:</span>
        <span class="token function">shade</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>  <span class="token comment">// 插入写屏障（Dijkstra屏障）</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> ptr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Go 实际实现为</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">writePointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">shade</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span>
    <span class="token function">shade</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> ptr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="垃圾回收触发机制"><a href="#垃圾回收触发机制" class="headerlink" title="垃圾回收触发机制"></a>垃圾回收触发机制</h4><ul>
<li>内存分配量达到阀值触发 GC<ul>
<li>每次内存分配时都会检查当前内存分配量是否已达到阀值，如果达到阀值则立即启动 GC。<ul>
<li>阀值 = 上次 GC 内存分配量 * 内存增长率</li>
<li>内存增长率由环境变量 GOGC 控制，默认为 100，即每当内存扩大一倍时启动 GC。</li>
</ul>
</li>
</ul>
</li>
<li>定期触发 GC<ul>
<li>默认情况下，最长 2 分钟触发一次 GC，这个间隔在 <code>src/runtime/proc.go:forcegcperiod</code> 变量中被声明</li>
</ul>
</li>
<li>手动触发<ul>
<li>程序代码中也可以使用 <code>runtime.GC()</code> 来手动触发 GC。这主要用于 GC 性能测试和统计。</li>
</ul>
</li>
</ul>
<h3 id="动手编写一个-HTTP-Server"><a href="#动手编写一个-HTTP-Server" class="headerlink" title="动手编写一个 HTTP Server"></a>动手编写一个 HTTP Server</h3><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/http-server-socket-detail-e1f350d63c7c4d9f86ce140949bd90c2">http server socket detail</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            lc<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> network<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                sl<span class="token punctuation">.</span><span class="token function">listenTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> la<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">internetSocket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sl<span class="token punctuation">.</span>network<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"listen"</span><span class="token punctuation">,</span> sl<span class="token punctuation">.</span>ListenConfig<span class="token punctuation">.</span>Control<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        <span class="token function">socket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> net<span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> ipv6only<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            <span class="token function">sysSocket</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">)</span> <span class="token comment">// syscall.Socket and return fd</span>
                            fd<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">newFD</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> net<span class="token punctuation">)</span> <span class="token comment">// fd.pfd.sysfd = sysfd(socket fd)</span>
                        fd<span class="token punctuation">.</span><span class="token function">listenStream</span><span class="token punctuation">(</span>laddr<span class="token punctuation">,</span> <span class="token function">listenerBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            syscall<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> lsa<span class="token punctuation">)</span> <span class="token comment">// bind socket with address</span>
                            <span class="token function">listenFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// syscall.Listen</span>
                            fd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                <span class="token function">runtime_pollServerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_poll_runtime.go</span>
                                    <span class="token function">poll_runtime_pollServerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll.go</span>
                                        <span class="token function">netpollGenericInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll_epoll.go</span>
                                                <span class="token function">epollcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                <span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
                                <span class="token function">runtime_pollOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                    <span class="token function">poll_runtime_pollOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll.go</span>
                                        <span class="token function">netpollopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll_epoll.go</span>
                                            <span class="token keyword">var</span> ev epollevent
                                            ev<span class="token punctuation">.</span>events <span class="token operator">=</span> _EPOLLIN <span class="token operator">|</span> _EPOLLOUT <span class="token operator">|</span> _EPOLLRDHUP <span class="token operator">|</span> _EPOLLET
                                            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> pd
                                            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
        srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// tcpsocket.go</span>
                l<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// return TCPConn which holds the connection fd</span>
                    fd <span class="token operator">:=</span> ln<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_unix.go syscall.Accept4</span>
                            <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> s<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err
                            <span class="token punctuation">}</span>
                            <span class="token keyword">switch</span> err <span class="token punctuation">{</span>
                            <span class="token keyword">case</span> syscall<span class="token punctuation">.</span>EAGAIN<span class="token punctuation">:</span>
                                <span class="token keyword">if</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                        <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">netpollblock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span>gpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pdWait<span class="token punctuation">)</span>
                                            <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            <span class="token function">mcall</span><span class="token punctuation">(</span>park_m<span class="token punctuation">)</span> <span class="token comment">// put the go routine to park, schedule-&gt;findrunnable will wake it up</span>
                                <span class="token punctuation">}</span>

            <span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>connCtx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>c<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                req<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>bufr<span class="token punctuation">,</span> keepHostHeader<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>tp<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>r<span class="token punctuation">.</span><span class="token function">readLineSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>r<span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>b<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    b<span class="token punctuation">.</span>rd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>b<span class="token punctuation">.</span>w<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_unix.go Read implements io.Reader.</span>
                        <span class="token function">ignoringEINTRIO</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Read<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">)</span>  <span class="token comment">// syscall.Read</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// shedule parked go routine</span>
<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//proc.go</span>
        n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toRun<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                rg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// find related go routine of the epoll fd</span>
                toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token function">startIdle</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>startm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Linux-epoll"><a href="#Linux-epoll" class="headerlink" title="Linux epoll"></a>Linux epoll</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LinuxEpoll.png" alt="LinuxEpoll"></p>
<h4 id="HttpServer-的实现细节"><a href="#HttpServer-的实现细节" class="headerlink" title="HttpServer 的实现细节"></a>HttpServer 的实现细节</h4><p>Go 语言将协程与 fd 资源绑定</p>
<ul>
<li>一个 socket fd 与一个协程绑定</li>
<li>当 socket fd 未就绪时，将对应协程设置为 Gwaiting 状态，将 CPU 时间片让给其他协程</li>
<li>Go 语言 runtime 调度器进行调度唤醒协程时，检查 fd 是否就绪，如果就绪则将协程置为 Grunnable 并加入执行队列</li>
<li>协程被调度后处理 fd 数据</li>
</ul>
<h2 id="Docker-核心技术"><a href="#Docker-核心技术" class="headerlink" title="Docker 核心技术"></a>Docker 核心技术</h2><h3 id="理解Docker"><a href="#理解Docker" class="headerlink" title="理解Docker"></a>理解Docker</h3><h4 id="Linux-内核代码中-Namespace-的实现"><a href="#Linux-内核代码中-Namespace-的实现" class="headerlink" title="Linux 内核代码中 Namespace 的实现"></a>Linux 内核代码中 Namespace 的实现</h4><p>进程数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>

    <span class="token comment">/* Namespaces: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">nsproxy</span> <span class="token operator">*</span>nsproxy<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Namespace 数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/nsproxy.h</span>

<span class="token comment">/*
 * A structure to contain pointers to all per-process
 * namespaces - fs (mount), uts, network, sysvipc, etc.
 *
 * The pid namespace is an exception -- it's accessed using
 * task_active_pid_ns.  The pid namespace here is the
 * namespace that children will use.
 *
 * 'count' is the number of tasks holding a reference.
 * The count for each namespace, then, will be the number
 * of nsproxies pointing to it, not the number of tasks.
 *
 * The nsproxy is shared by tasks which share all namespaces.
 * As soon as a single namespace is cloned or unshared, the
 * nsproxy is copied.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">nsproxy</span> <span class="token punctuation">{</span>
    refcount_t count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">uts_namespace</span> <span class="token operator">*</span>uts_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_namespace</span> <span class="token operator">*</span>ipc_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mnt_namespace</span> <span class="token operator">*</span>mnt_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pid_namespace</span> <span class="token operator">*</span>pid_ns_for_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">time_namespace</span> <span class="token operator">*</span>time_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">time_namespace</span> <span class="token operator">*</span>time_ns_for_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cgroup_namespace</span> <span class="token operator">*</span>cgroup_ns<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Linux-对-Namespace-操作方法"><a href="#Linux-对-Namespace-操作方法" class="headerlink" title="Linux 对 Namespace 操作方法"></a>Linux 对 Namespace 操作方法</h4><h5 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h5><p>在创建新进程的系统调用时，可以通过 flags 参数指定需要新建的 Namespace 类型：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// CLONE_NEWCGROUP / CLONE_NEWIPC / CLONE_NEWNET / CLONE_NEWNS / CLONE_NEWPID / CLONE_NEWUSER / CLONE_NEWUTS</span>
<span class="token keyword">int</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>child_stack<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="setns"><a href="#setns" class="headerlink" title="setns"></a>setns</h5><p>该系统调用可以让调用进程加入某个已经存在的 Namespace 中：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Int <span class="token function">setns</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> nstype<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="unshare"><a href="#unshare" class="headerlink" title="unshare"></a>unshare</h5><p>该系统调用可以将调用进程移动到新的 Namespace 下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">unshare</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="关于-namespace-的常用操作"><a href="#关于-namespace-的常用操作" class="headerlink" title="关于 namespace 的常用操作"></a>关于 namespace 的常用操作</h4><ul>
<li>查看当前系统的 namespace：<code>lsns -t &lt;type&gt;</code></li>
<li>查看某进程的 namespace：<code>ls -la /proc/&lt;pid&gt;/ns/</code></li>
<li>查看某命令的 namespace: <code>sudo lsns | grep &lt;command name&gt;</code></li>
<li>进入某 namespace 运行命令：<code>nsenter -t &lt;pid&gt; -n ip addr</code></li>
<li>在新 network namespace 运行命令：<code>unshare -fn sleep 60</code></li>
</ul>
<h4 id="Linux-内核代码中-Cgroups-的实现"><a href="#Linux-内核代码中-Cgroups-的实现" class="headerlink" title="Linux 内核代码中 Cgroups 的实现"></a>Linux 内核代码中 Cgroups 的实现</h4><p>进程数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_CGROUPS</span></span>
    <span class="token comment">/* Control Group info protected by css_set_lock: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">css_set</span> __rcu <span class="token operator">*</span>cgroups<span class="token punctuation">;</span>
    <span class="token comment">/* cg_list protected by css_set_lock and tsk-&gt;alloc_lock: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> cg_list<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>css_set</code> 是 <code>cgroup_subsys_state</code> 对象的集合数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/cgroup-defs.h</span>

<span class="token comment">/*
 * A css_set is a structure holding pointers to a set of
 * cgroup_subsys_state objects. This saves space in the task struct
 * object and speeds up fork()/exit(), since a single inc/dec and a
 * list_add()/del() can bump the reference count on the entire cgroup
 * set for a task.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">css_set</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * Set of subsystem states, one for each subsystem. This array is
    * immutable after creation apart from the init_css_set during
    * subsystem registration (at boot time).
    */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cgroup_subsys_state</span> <span class="token operator">*</span>subsys<span class="token punctuation">[</span>CGROUP_SUBSYS_COUNT<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="cgroups"><a href="#cgroups" class="headerlink" title="cgroups"></a>cgroups</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-subsystems_and_tunable_parameters">Chapter 3. Subsystems and Tunable Parameters</a></p>
</blockquote>
<p>cgroups 实现了对资源的配额和度量</p>
<ul>
<li>blkio： 这个子系统设置限制每个块设备的输入输出控制。例如:磁盘，光盘以及 USB 等等。</li>
<li>CPU： 这个子系统使用调度程序为 cgroup 任务提供 CPU 的访问。</li>
<li>cpuacct： 产生 cgroup 任务的CPU 资源报告。</li>
<li>cpuset： 如果是多核心的 CPU，这个子系统会为 cgroup 任务分配单独的 CPU 和内存。</li>
<li>devices： 允许或拒绝 cgroup 任务对设备的访问。</li>
<li>freezer： 暂停和恢复 cgroup 任务。</li>
<li>memory： 设置每个 cgroup 的内存限制以及产生内存资源报告。</li>
<li>net_cls： 标记每个网络包以供 cgroup 方便使用。</li>
<li>ns： 名称空间子系统。</li>
<li>pid: 进程标识子系统。</li>
</ul>
<h4 id="CPU-子系统"><a href="#CPU-子系统" class="headerlink" title="CPU 子系统"></a>CPU 子系统</h4><ul>
<li>cpu.shares： 可出让的能获得 CPU 使用时间的相对值。<br>  <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/cpu-shares.png" alt="cpu-shares"></li>
<li>cpu.cfs_period_us：cfs_period_us 用来配置时间周期长度，单位为 us（微秒）。<br>  <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/cpu-period-quota.png" alt="cpu-period-quota"></li>
<li>cpu.cfs_quota_us：cfs_quota_us 用来配置当前 Cgroup 在 cfs_period_us 时间内最多能使用的 CPU 时间数，单位为 us（微秒）。</li>
<li>cpu.stat ： Cgroup 内的进程使用的 CPU 时间统计。</li>
<li>nr_periods ： 经过 cpu.cfs_period_us 的时间周期数量。</li>
<li>nr_throttled ： 在经过的周期内，有多少次因为进程在指定的时间周期内用光了配额时间而受到限制。</li>
<li>throttled_time ： Cgroup 中的进程被限制使用CPU 的总用时，单位是 ns（纳秒）</li>
</ul>
<h4 id="Linux-调度器"><a href="#Linux-调度器" class="headerlink" title="Linux 调度器"></a>Linux 调度器</h4><p>内核默认提供了 5 个调度器，Linux 内核使用 <code>struct sched_class</code> 来对调度器进行抽象：</p>
<ul>
<li>Stop 调度器，<code>stop_sched_class</code>：优先级最高的调度类，可以抢占其他所有进程，不能被其他进程抢占；</li>
<li>Deadline 调度器，<code>dl_sched_class</code>：使用红黑树，把进程按照绝对截止期限进行排序，选择最小进程进行调度运行；</li>
<li>RT 调度器， <code>rt_sched_class</code>：实时调度器，为每个优先级维护一个队列；</li>
<li>CFS 调度器， <code>cfs_sched_class</code>：完全公平调度器，采用完全公平调度算法，引入虚拟运行时间概念；</li>
<li>IDLE-Task 调度器， <code>idle_sched_class</code>：空闲调度器，每个 CPU 都会有一个 idle 线程，当没有其他进程可以调度时，调度运行 idle 线程。</li>
</ul>
<h4 id="CFS-调度器"><a href="#CFS-调度器" class="headerlink" title="CFS 调度器"></a>CFS 调度器</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/XiaoliBoy/p/10410686.html">Linux内核CFS调度器</a>, <a target="_blank" rel="noopener" href="http://www.wowotech.net/process_management/451.html">CFS调度器（5）-带宽控制</a></p>
</blockquote>
<p>CFS 是 Completely Fair Scheduler 简称，即完全公平调度器。</p>
<ul>
<li>CFS 实现的主要思想是维护为任务提供处理器时间方面的平衡，这意味着应给进程分配相当数量的处理器。</li>
<li>分给某个任务的时间失去平衡时，应给失去平衡的任务分配时间，让其执行。</li>
<li><p>CFS 通过虚拟运行时间（vruntime）来实现平衡，维护提供给某个任务的时间量。</p>
<p>  <code>vruntime = 实际运行时间 * 1024 / 进程权重</code></p>
</li>
<li><p>进程按照各自不同的速率在物理时钟节拍内前进，优先级高则权重大，其虚拟时钟比真实时钟跑得慢，但获得比较多的运行时间。</p>
</li>
</ul>
<h4 id="vruntime-红黑树"><a href="#vruntime-红黑树" class="headerlink" title="vruntime 红黑树"></a>vruntime 红黑树</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/vruntime红黑树.png" alt="vruntime红黑树"></p>
<h4 id="CFS进程调度"><a href="#CFS进程调度" class="headerlink" title="CFS进程调度"></a>CFS进程调度</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CFS进程调度.png" alt="CFS进程调度"></p>
<h4 id="cpuacct-子系统"><a href="#cpuacct-子系统" class="headerlink" title="cpuacct 子系统"></a>cpuacct 子系统</h4><p>用于统计 Cgroup 及其子 Cgroup 下进程的 CPU 的使用情况。</p>
<ul>
<li>cpuacct.usage</li>
</ul>
<p>包含该 Cgroup 及其子 Cgroup 下进程使用 CPU 的时间，单位是 ns（纳秒）。</p>
<ul>
<li>cpuacct.stat</li>
</ul>
<p>包含该 Cgroup 及其子 Cgroup 下进程使用的 CPU 时间，以及用户态和内核态的时间。</p>
<h4 id="Memory-子系统"><a href="#Memory-子系统" class="headerlink" title="Memory 子系统"></a>Memory 子系统</h4><ul>
<li><p>memory.usage_in_bytes</p>
<p>  cgroup 下进程使用的内存，包含 cgroup 及其子 cgroup 下的进程使用的内存</p>
</li>
<li><p>memory.max_usage_in_bytes</p>
<p>  cgroup 下进程使用内存的最大值，包含子 cgroup 的内存使用量。</p>
</li>
<li><p>memory.limit_in_bytes</p>
<p>  设置 Cgroup 下进程最多能使用的内存。如果设置为 -1，表示对该 cgroup 的内存使用不做限制。</p>
</li>
<li><p>memory.soft_limit_in_bytes</p>
<p>  这个限制并不会阻止进程使用超过限额的内存，只是在系统内存足够时，会优先回收超过限额的内存，使之向限定值靠拢。</p>
</li>
<li><p>memory.oom_control</p>
<p>  设置是否在 Cgroup 中使用 OOM（Out of Memory）Killer，默认为使用。当属于该 cgroup 的进程使用的内存超过最大的限定值时，会立刻被 OOM Killer 处理。</p>
</li>
</ul>
<h4 id="Cgroup-driver"><a href="#Cgroup-driver" class="headerlink" title="Cgroup driver"></a>Cgroup driver</h4><p>systemd:</p>
<ul>
<li>当操作系统使用 systemd 作为 init system 时，初始化进程生成一个根 cgroup 目录结构并作为 cgroup 管理器。</li>
<li>systemd 与 cgroup 紧密结合，并且为每个 systemd unit 分配 cgroup。</li>
</ul>
<p>cgroupfs:</p>
<ul>
<li>docker 默认用 cgroupfs 作为 cgroup 驱动。</li>
</ul>
<p>存在问题：</p>
<ul>
<li>在 systemd 作为 init system 的系统中，默认并存着两套 groupdriver。</li>
<li>这会使得系统中 Docker 和 kubelet 管理的进程被 cgroupfs 驱动管，而 systemd 拉起的服务由 systemd 驱动管，让 cgroup 管理混乱且容易在资源紧张时引发问题。</li>
</ul>
<p>因此 kubelet 会默认 —cgroup-driver=systemd，若运行时 cgroup 不一致时，kubelet 会报错。</p>
<h4 id="Cgroup-的使用"><a href="#Cgroup-的使用" class="headerlink" title="Cgroup 的使用"></a>Cgroup 的使用</h4><p>可以使用 <code>cgroup-tools</code> 来管理 Cgroup</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建一个名为 k 的 CPU 子系统</span>
$ cgcreate -g cpu:k

<span class="token comment"># 创建后的路径为</span>
$ <span class="token function">ls</span> /sys/fs/cgroup/cpu/k
cgroup.clone_children  cgroup.procs  cpu.cfs_burst_us  cpu.cfs_period_us  cpu.cfs_quota_us  cpu.idle  cpu.rt_period_us  cpu.rt_runtime_us  cpu.shares  cpu.stat  notify_on_release  tasks

<span class="token comment"># 获取 CPU 配额</span>
$ cgget -r cpu.cfs_period_us -r cpu.cfs_quota_us k
k:
cpu.cfs_period_us: <span class="token number">100000</span>
cpu.cfs_quota_us: -1

<span class="token comment"># 限制 CPU 使用率为 50%</span>
$ cgset -r cpu.cfs_quota_us<span class="token operator">=</span><span class="token number">50000</span> k

<span class="token comment"># 确认设置生效</span>
$ cgget -r cpu.cfs_period_us -r cpu.cfs_quota_us k
k:
cpu.cfs_period_us: <span class="token number">100000</span>
cpu.cfs_quota_us: <span class="token number">50000</span>

<span class="token comment"># 测试</span>
$ <span class="token function">top</span> -p <span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'bash -c while : ; do : ; done'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span> -b -n <span class="token number">1</span>
<span class="token function">top</span> - <span class="token number">22</span>:48:54 up  <span class="token number">1</span>:25,  <span class="token number">2</span> users,  load average: <span class="token number">1.54</span>, <span class="token number">1.41</span>, <span class="token number">1.21</span>
Tasks:   <span class="token number">1</span> total,   <span class="token number">1</span> running,   <span class="token number">0</span> sleeping,   <span class="token number">0</span> stopped,   <span class="token number">0</span> zombie
%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  <span class="token number">8.4</span> us,  <span class="token number">0.8</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">86.8</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">4.0</span> si,  <span class="token number">0.0</span> st
MiB Mem <span class="token builtin class-name">:</span>   <span class="token number">7898.4</span> total,    <span class="token number">141.7</span> free,   <span class="token number">2822.3</span> used,   <span class="token number">4934.4</span> buff/cache
MiB Swap:   <span class="token number">2048.0</span> total,   <span class="token number">2042.7</span> free,      <span class="token number">5.3</span> used.   <span class="token number">4779.8</span> avail Mem

    PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  <span class="token number">33693</span> root      <span class="token number">20</span>   <span class="token number">0</span>    <span class="token number">4784</span>   <span class="token number">3224</span>   <span class="token number">2976</span> R  <span class="token number">53.3</span>   <span class="token number">0.0</span>   <span class="token number">4</span>:32.59 <span class="token function">bash</span>

<span class="token comment"># 删除 CPU 子系统 k</span>
$ cgdelete cpu:k<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h4><p>Union FS</p>
<ul>
<li>将不同目录挂载到同一个虚拟文件系统下（unite several directories into a single virtual filesystem）的文件系统</li>
<li>支持为每一个成员目录（类似 Git Branch）设定 readonly、readwrite 和 whiteout-able 权限</li>
<li>文件系统分层, 对 readonly 权限的 branch 可以逻辑上进行修改(增量地, 不影响 readonly 部分的)。</li>
<li>通常 Union FS 有两个用途, 一方面可以将多个 disk 挂到同一个目录下, 另一个更常用的就是将一个 readonly 的 branch 和一个 writeable 的 branch 联合在一起。</li>
</ul>
<h4 id="Docker-的文件系统"><a href="#Docker-的文件系统" class="headerlink" title="Docker 的文件系统"></a>Docker 的文件系统</h4><p>典型的 Linux 文件系统组成：</p>
<ul>
<li>Bootfs（boot file system）<ul>
<li>Bootloader - 引导加载 kernel，</li>
<li>Kernel - 当 kernel 被加载到内存中后 umount bootfs。</li>
</ul>
</li>
<li>rootfs （root file system）<ul>
<li>/dev，/proc，/bin，/etc 等标准目录和文件。</li>
<li>对于不同的 linux 发行版, bootfs 基本是一致的，但 rootfs 会有差别。</li>
</ul>
</li>
</ul>
<h4 id="Docker-启动"><a href="#Docker-启动" class="headerlink" title="Docker 启动"></a>Docker 启动</h4><p>Linux</p>
<ul>
<li>在启动后，首先将 rootfs 设置为 readonly, 进行一系列检查, 然后将其切换为 “readwrite” 供用户使用。</li>
</ul>
<p>Docker 启动</p>
<ul>
<li>初始化时也是将 rootfs 以 readonly 方式加载并检查，然而接下来利用 union mount 的方式将一个 readwrite 文件系统挂载在 readonly 的 rootfs 之上；</li>
<li>并且允许再次将下层的 FS（file system） 设定为 readonly 并且向上叠加。</li>
<li>这样一组 readonly 和一个 writeable 的结构构成一个 container 的运行时态, 每一个 FS 被称作一个 FS 层。</li>
</ul>
<h4 id="Docker-写操作"><a href="#Docker-写操作" class="headerlink" title="Docker 写操作"></a>Docker 写操作</h4><p>由于镜像具有共享特性，所以对容器可写层的操作需要依赖存储驱动提供的写时复制和用时分配机制，以此来支持对容器可写层的修改，进而提高对存储和内存资源的利用率。</p>
<ul>
<li>写时复制<ul>
<li>写时复制，即 Copy-on-Write。</li>
<li>一个镜像可以被多个容器使用，但是不需要在内存和磁盘上做多个拷贝。</li>
<li>在需要对镜像提供的文件进行修改时，该文件会从镜像的文件系统被复制到容器的可写层的文件系统进行修改，而镜像里面的文件不会改变。</li>
<li>不同容器对文件的修改都相互独立、互不影响。</li>
</ul>
</li>
<li>用时分配<ul>
<li>按需分配空间，而非提前分配，即当一个文件被创建出来后，才会分配空间。</li>
</ul>
</li>
</ul>
<h4 id="Docker-引擎架构"><a href="#Docker-引擎架构" class="headerlink" title="Docker 引擎架构"></a>Docker 引擎架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Docker引擎架构.png" alt="Docker引擎架构"></p>
<p>需要注意的是，在这个架构中，运行的 Docker 容器的父进程不是 Docker daemon ，这样就能避免重启 daemon 导致容器也必须重启。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker inspect c07 <span class="token operator">|</span> <span class="token function">grep</span> -i pid
            <span class="token string">"Pid"</span><span class="token builtin class-name">:</span> <span class="token number">5621</span>,
            <span class="token string">"PidMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"PidsLimit"</span><span class="token builtin class-name">:</span> null,

$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5621</span>
root        <span class="token number">5621</span>    <span class="token number">5600</span>  <span class="token number">0</span> <span class="token number">11</span>:45 pts/0    00:00:00 <span class="token function">zsh</span>

$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5600</span>
root        <span class="token number">5600</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">11</span>:45 ?        00:00:00 /snap/docker/2915/bin/containerd-shim-runc-v2 -namespace moby -id c07f841e7a66cb54f78f72445cb5baf7d479a3c27e8ea03966da1841e3605151 -address /run/snap.docker/containerd/containerd.sock

$ pstree -H <span class="token number">5600</span> -p -s -T
systemd<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>───containerd-shim<span class="token punctuation">(</span><span class="token number">5600</span><span class="token punctuation">)</span>───zsh<span class="token punctuation">(</span><span class="token number">5621</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h4><ul>
<li>Null(—net=None)<ul>
<li>把容器放入独立的网络空间但不做任何网络配置；</li>
<li>用户需要通过运行 docker network 命令来完成网络配置。</li>
</ul>
</li>
<li>Host<ul>
<li>使用主机网络名空间，复用主机网络。</li>
</ul>
</li>
<li>Container<ul>
<li>重用其他容器的网络。</li>
</ul>
</li>
<li>Bridge(—net=bridge)<ul>
<li>使用 Linux 网桥和 iptables 提供容器互联，Docker 在每台主机上创建一个名叫 docker0 的网桥，通过 veth pair 来连接该主机的每一个 EndPoint。</li>
</ul>
</li>
<li>Overlay(libnetwork, libkv)<ul>
<li>通过网络封包实现。</li>
</ul>
</li>
<li>Remote(work with remote drivers)<ul>
<li>Underlay：使用现有底层网络，为每一个容器配置可路由的网络 IP。</li>
<li>Overlay：通过网络封包实现。</li>
</ul>
</li>
</ul>
<h4 id="Null-模式"><a href="#Null-模式" class="headerlink" title="Null 模式"></a>Null 模式</h4><ol>
<li>Null 模式是一个空实现；</li>
<li>可以通过 Null 模式启动容器并在宿主机上通过命令为容器配置网络。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module3/setup-network.md">https://github.com/kibaamor/101/blob/master/module3/setup-network.md</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以后台的方式运行一个名为 nginx 的 nginx 容器，但不配置网络</span>
$ docker run --network<span class="token operator">=</span>none --name nginx -d nginx

<span class="token comment"># 获取刚刚运行的 nginx 容器中 nginx 进程在主机上的 Pid</span>
$ docker inspect -f <span class="token string">'{{.State.Pid}}'</span> nginx
<span class="token number">63648</span>

<span class="token comment"># 查看 nginx 容器的网络配置</span>
$ nsenter -t <span class="token number">63648</span> -n <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever

<span class="token comment"># 将 nginx 容器进程所使用的 network namespace 连接到 /var/run/netns，这样才能使用 ip netns 命令查看和修改</span>
<span class="token comment"># 创建目录</span>
$ <span class="token function">mkdir</span> -p /var/run/netns
<span class="token comment"># 链接</span>
$ <span class="token function">ln</span> -s /proc/63648/ns/net /var/run/netns/63648
<span class="token comment"># 确认链接成功</span>
$ <span class="token function">ip</span> netns list
<span class="token number">63648</span>

<span class="token comment"># 查看主机上网桥的配置</span>
$ brctl show
bridge name     bridge <span class="token function">id</span>               STP enabled     interfaces
docker0         <span class="token number">8000</span>.0242b3da2420       no

<span class="token comment"># 显示主机上 docker0 网口的 ip 信息</span>
$ <span class="token function">ip</span> address show dev docker0
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:b3:da:24:20 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:b3ff:feda:2420/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever

<span class="token comment"># 创建 veth pair</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> A <span class="token builtin class-name">type</span> veth peer name B

<span class="token comment"># 配置 A</span>
<span class="token comment"># 把 A 添加到网桥 docker0</span>
$ brctl addif docker0 A
<span class="token comment"># 启动 A</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A up

<span class="token comment"># 配置 B</span>
<span class="token comment"># 将 B 的 network namespace 移动到进程 63648 中</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B netns <span class="token number">63648</span>
<span class="token comment"># 将 B 改名为 eth0</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev B name eth0
<span class="token comment"># 启动 eth0</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 up
<span class="token comment"># 设置 eth0 的 IP 和子网掩码（根据 docker0 信息来）</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.17</span>.0.100/16 dev eth0
<span class="token comment"># 设置 eth0 的默认网关（即为 docker0 的 IP 地址）</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">172.17</span>.0.1

<span class="token comment"># 测试能访问 nginx（如果失败，检查一下 HTTP_PROXY 等配置）</span>
$ <span class="token function">curl</span> <span class="token number">172.17</span>.0.100
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="默认模式-网桥和-NAT"><a href="#默认模式-网桥和-NAT" class="headerlink" title="默认模式 - 网桥和 NAT"></a>默认模式 - 网桥和 NAT</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DockerNAT.png" alt="DockerNAT"></p>
<h4 id="Underlay"><a href="#Underlay" class="headerlink" title="Underlay"></a>Underlay</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Underlay.png" alt="Underlay"></p>
<h4 id="Overlay"><a href="#Overlay" class="headerlink" title="Overlay"></a>Overlay</h4><ul>
<li>Docker overlay 网络驱动原生支持多主机网络；</li>
<li>Libnetwork 是一个内置的基于 VXLAN 的网络驱动。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/VXLAN.png" alt="VXLAN"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Flannel.png" alt="Flannel"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlannelPacketSample.png" alt="FlannelPacketSample"></p>
<h3 id="Dockerfile-的最佳实践"><a href="#Dockerfile-的最佳实践" class="headerlink" title="Dockerfile 的最佳实践"></a>Dockerfile 的最佳实践</h3><h4 id="回顾12-Factor-之进程"><a href="#回顾12-Factor-之进程" class="headerlink" title="回顾12 Factor 之进程"></a>回顾12 Factor 之进程</h4><ul>
<li>运行环境中，应用程序通常是以一个和多个<strong>进程</strong>运行的。<ul>
<li>12-Factor 应用的进程必须无状态（Stateless）且无共享（Share nothing）。</li>
</ul>
</li>
<li>任何需要持久化的数据都要存储在后端服务内，比如数据库。<ul>
<li>应在构建阶段将源代码编译成待执行应用。</li>
</ul>
</li>
<li>Session Sticky 是 12-Factor 极力反对的。<ul>
<li>Session 中的数据应该保存在诸如 Memcached 或 Redis 这样的带有过期时间的缓存中。</li>
</ul>
</li>
</ul>
<p><strong>Docker 遵循以上原则管理和构建应用。</strong></p>
<h4 id="理解构建上下文（Build-Context）"><a href="#理解构建上下文（Build-Context）" class="headerlink" title="理解构建上下文（Build Context）"></a>理解构建上下文（Build Context）</h4><ul>
<li>当运行docker build 命令时，当前工作目录被称为构建上下文。</li>
<li>docker build 默认查找当前目录的Dockerfile 作为构建输入，也可以通过 -f 指定Dockerfile。<ul>
<li><code>docker build -f ./Dockerfile</code></li>
</ul>
</li>
<li>当docker build 运行时，首先会把构建上下文传输给 docker daemon，把没用的文件包含在构建上下文时，会导致传输时间长，构建需要的资源多，构建出的镜像大等问题。<ul>
<li>试着到一个包含文件很多的目录运行下面的命令，会感受到差异；</li>
<li><code>docker build -f $GOPATH/src/github.com/cncamp/golang/httpserver/Dockerfile</code> ；</li>
<li><code>docker build $GOPATH/src/github.com/cncamp/golang/httpserver/</code>；</li>
<li>可以通过 <code>.dockerignore</code> 文件从编译上下文排除某些文件。</li>
</ul>
</li>
<li>因此需要确保构建上下文清晰，比如创建一个专门的目录放置 Dockerfile，并在目录中运行 <code>docker build</code>。</li>
</ul>
<h4 id="Build-Cache"><a href="#Build-Cache" class="headerlink" title="Build Cache"></a>Build Cache</h4><p>构建容器镜像时，Docker 依次读取 Dockerfile 中的指令，并按顺序依次执行构建指令。<br>Docker 读取指令后，会先判断缓存中是否有可用的已存镜像，只有已存镜像不存在时才会重新构建。</p>
<ul>
<li>通常 Docker 简单判断 Dockerfile 中的指令与镜像。</li>
<li>针对 ADD 和 COPY 指令，Docker 判断该镜像层每一个文件的内容并生成一个 checksum，与现存镜像比较时，Docker 比较的是二者的 checksum。</li>
<li>其他指令，比如 <code>RUN apt-get -y update</code>，Docker 简单比较与现存镜像中的指令字串是否一致。</li>
<li>当某一层 cache 失效以后，所有所有层级的 cache 均一并失效，后续指令都重新构建镜像。</li>
</ul>
<h4 id="Dockerfile-常用指令"><a href="#Dockerfile-常用指令" class="headerlink" title="Dockerfile 常用指令"></a>Dockerfile 常用指令</h4><ul>
<li><p>FROM：选择基础镜像，推荐alpine</p>
<p>  <code>FROM [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</code></p>
</li>
<li><p>LABELS：按标签组织项目</p>
<p>  LABEL multi.label1=”value1” multi.label2=”value2” other=”value3”</p>
<p>  配合label filter 可过滤镜像查询结果</p>
<p>  <code>docker images -f label=multi.label1="value1"</code></p>
</li>
<li><p>RUN：执行命令</p>
<p>  最常见的用法是 RUN apt-get update &amp;&amp; apt-get install，这两条命令应该永远用 &amp;&amp; 连接，如果分开执行，RUN apt-get update 构建层被缓存，可能会导致新 package 无法安装</p>
</li>
<li><p>CMD：容器镜像中包含应用的运行命令，需要带参数</p>
<p>  CMD [“executable”, “param1”, “param2”…]</p>
</li>
<li><p>EXPOSE：发布端口</p>
<p>  <code>EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]</code></p>
<ul>
<li><p>是镜像创建者和使用者的约定</p>
</li>
<li><p>在 docker run -P 时，docker 会自动映射 expose 的端口到主机大端口，如 0.0.0.0:32768-&gt;80/tcp</p>
</li>
</ul>
</li>
<li><p>ENV 设置环境变量</p>
<p>  <code>ENV &lt;key&gt;=&lt;value&gt;</code> …</p>
</li>
<li><p>ADD：从源地址（文件，目录或者URL）复制文件到目标路径</p>
<p>  <code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</code></p>
<p>  <code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</code> （路径中有空格时使用）</p>
<ul>
<li><p>ADD 支持 Go 风格的通配符，如 ADD check* /testdir/</p>
</li>
<li><p>src 如果是文件，则必须包含在编译上下文中，ADD 指令无法添加编译上下文之外的文件</p>
</li>
<li><p>src 如果是URL</p>
<ul>
<li>如果 dest 结尾没有 /，那么 dest 是目标文件名，如果 dest 结尾有 /，那么 dest 是目标目录名</li>
</ul>
</li>
<li><p>如果 src 是一个目录，则所有文件都会被复制至 dest</p>
</li>
<li><p><strong>如果 src 是一个本地压缩文件，则在 ADD 的同时完整解压操作</strong></p>
</li>
<li><p>如果 dest 不存在，则 ADD 指令会创建目标目录</p>
</li>
<li><p>应尽量减少通过 ADD URL 添加 remote 文件，建议使用 curl 或者 wget &amp;&amp; untar （维护起来理解成本高）</p>
</li>
</ul>
</li>
<li><p>COPY：从源地址（文件，目录或者URL）复制文件到目标路径</p>
<p>  <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</code></p>
<p>  <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</code> // 路径中有空格时使用</p>
<ul>
<li><p>COPY 的使用与 ADD 类似，但有如下区别</p>
<ul>
<li><p>COPY 只支持本地文件的复制，不支持URL</p>
</li>
<li><p><strong>COPY 不解压文件</strong></p>
</li>
<li><p>COPY 可以用于多阶段编译场景，可以用前一个临时镜像中拷贝文件</p>
<p>  COPY —from=build /bin/project /bin/project</p>
</li>
</ul>
</li>
<li><p>COPY 语义上更直白，复制本地文件时，优先使用 COPY</p>
</li>
</ul>
</li>
<li><p>ENTRYPOINT：定义可以执行的容器镜像入口命令</p>
<p>  ENTRYPOINT [“executable”, “param1”, “param2”] // docker run参数追加模式</p>
<p>  ENTRYPOINT command param1 param2 // docker run 参数替换模式</p>
<ul>
<li><p>docker run -entrypoint 可替换 Dockerfile 中定义的 ENTRYPOINT</p>
</li>
<li><p>ENTRYPOINT 的最佳实践是用 ENTRYPOINT 定义镜像主命令，并通过 CMD 定义主要参数，如下所示</p>
<p>  ENTRYPOINT [“s3cmd”]</p>
<p>  CMD [“—help”]</p>
</li>
</ul>
</li>
<li><p>VOLUME： 将指定目录定义为外挂存储卷，Dockerfile 中在该指令之后所有对同一目录的修改都无效</p>
<p>  VOLUME [“/data”]</p>
<p>  等价于docker run -v /data，可通过docker inspect 查看主机的mount point，<code>/var/lib/docker/volumes/&lt;containerid&gt;/_data</code></p>
</li>
<li><p>USER：切换运行镜像的用户和用户组，因安全性要求，越来越多的场景要求容器应用要以 non-root 身份运行</p>
<p>  <code>USER &lt;user&gt;[:&lt;group&gt;]</code></p>
</li>
<li><p>WORKDIR：等价于cd，切换工作目录</p>
<p>  WORKDIR /path/to/workdir</p>
</li>
<li><p>其他非常用指令</p>
<ul>
<li>ARG</li>
<li>ONBUILD</li>
<li>STOPSIGNAL</li>
<li>HEALTHCHECK</li>
<li>SHELL</li>
</ul>
</li>
</ul>
<h4 id="Dockerfile-最佳实践"><a href="#Dockerfile-最佳实践" class="headerlink" title="Dockerfile 最佳实践"></a>Dockerfile 最佳实践</h4><p><strong>目标：易管理、少漏洞、镜像小、层级少、利用缓存。</strong></p>
<ul>
<li>不要安装无效软件包。</li>
<li>应简化镜像中同时运行的进程数，理想状况下，每个镜像应该只有一个进程。</li>
<li>当无法避免同一镜像运行多进程时，应选择合理的初始化进程（init process）。</li>
<li>最小化层级数<ul>
<li>最新的 docker 只有 RUN，COPY，ADD 创建新层，其他指令创建临时层，不会增加镜像大小。<ul>
<li>比如 EXPOSE 指令就不会生成新层。</li>
</ul>
</li>
<li>多条RUN 命令可通过连接符连接成一条指令集以减少层数。</li>
<li>通过多段构建减少镜像层数。</li>
</ul>
</li>
<li>把多行参数按字母排序，可以减少可能出现的重复参数，并且提高可读性。</li>
<li>编写 dockerfile 的时候，应该把变更频率低的编译指令优先构建以便放在镜像底层以有效利用 build cache。</li>
<li>复制文件时，每个文件应独立复制，这确保某个文件变更时，只影响改文件对应的缓存。</li>
</ul>
<h4 id="多进程的容器镜像"><a href="#多进程的容器镜像" class="headerlink" title="多进程的容器镜像"></a>多进程的容器镜像</h4><ul>
<li>选择适当的 init 进程<ul>
<li>需要捕获 SIGTERM 信号并完成子进程的优雅终止</li>
<li>负责清理退出的子进程以避免僵尸进程</li>
</ul>
</li>
</ul>
<p>开源项目</p>
<p><a target="_blank" rel="noopener" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a></p>
<h4 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h4><p>创建私有镜像仓库</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/">https://distribution.github.io/distribution/</a></p>
<p> <code>docker run -d -p 5000:5000 registry</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://goharbor.io/">https://goharbor.io/</a></p>
</li>
</ol>
<h2 id="Kubernetes-架构原则和对象设计"><a href="#Kubernetes-架构原则和对象设计" class="headerlink" title="Kubernetes 架构原则和对象设计"></a>Kubernetes 架构原则和对象设计</h2><h3 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h3><h4 id="什么是云计算"><a href="#什么是云计算" class="headerlink" title="什么是云计算"></a>什么是云计算</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云计算.png" alt="云计算"></p>
<p>云计算是对所有计算资源、网络资源和存储资源的一种抽象。</p>
<p>怎么理解呢？</p>
<p>比如，有 5000 台机器。</p>
<ol>
<li>我们可以从网络上打通，把它们形成一个集群。</li>
<li>我们可以有一个用于控制的控制平面，把这些计算资源抽象出来。</li>
</ol>
<p>我们就能知道这 5000 个节点，每个节点上有多少 CPU、内存等。对于整个集群来说，我们也知道哪些节点是健康的，哪些节点是不健康的。谁能参与计算，谁不能参与计算等。这样我们就拥有了一个大的计算池。</p>
<p>上面是从云平台侧考虑的，做了资源的抽象。</p>
<p>另一方面，从业务的角度来说，业务也不用管作业实际部署在哪儿，只用告诉云平台某个业务需要多少实例，每个实例需要多少 CPU 和内存等资源信息即可。云平台会自动找合适节点来运行业务。</p>
<p>这就是云计算，对计算资源做一个抽象，让业务面向抽象的计算资源来部署应用。</p>
<h4 id="云计算平台的分类"><a href="#云计算平台的分类" class="headerlink" title="云计算平台的分类"></a>云计算平台的分类</h4><p>以 Openstack 为典型的<strong>虚拟化平台</strong></p>
<ul>
<li>虚拟机构建和业务代码部署分离。</li>
<li>可变的基础架构使后续维护风险变大。</li>
</ul>
<p>以谷歌 borg 为典型的<strong>基于进程的作业调度平台</strong></p>
<ul>
<li>技术的迭代引发 borg 的换代需求。</li>
<li>早期的隔离依靠 chroot jail 实现，一些不合理的设计需要在新产品中改进。<ul>
<li>对象之间的强依赖 job 和 task 是强包含关系，不利于重组。</li>
<li>所有容器共享 IP，会导致端口冲突，隔离困难等问题。</li>
<li>为超级用户添加复杂逻辑导致系统过于复杂。</li>
</ul>
</li>
</ul>
<h3 id="Kubernetes-架构基础"><a href="#Kubernetes-架构基础" class="headerlink" title="Kubernetes 架构基础"></a>Kubernetes 架构基础</h3><h4 id="Google-Borg"><a href="#Google-Borg" class="headerlink" title="Google Borg"></a>Google Borg</h4><blockquote>
<p>建议对原论文</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GoogleBorg.png" alt="GoogleBorg"></p>
<p>特性</p>
<ul>
<li>物理资源利用率高。</li>
<li>服务器共享，在进程级别做隔离。</li>
<li>应用高可用，故障恢复时间短。</li>
<li>调度策略灵活。</li>
<li>应用接入和使用方便，提供了完备的 Job 描述语言，服务发现，实时状态监控和诊断工具。</li>
</ul>
<p>优势</p>
<ul>
<li>对外隐藏底层资源管理和调度、故障处理等。</li>
<li>实现应用的高可靠和高可用。</li>
<li>足够弹性，支持应用跑在成千上万的机器上。</li>
</ul>
<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><ul>
<li><p>Workload</p>
<ul>
<li>prod：在线任务，长期运行、对延时敏感、面向终端用户等，比如 Gmail, Google Docs,Web Search 服务等。</li>
<li>non-prod ： 离线任务，也称为批处理任务（Batch），比如一些分布式计算服务等。</li>
</ul>
</li>
<li><p>Cell</p>
<blockquote>
<p>相当于一个集群</p>
</blockquote>
<ul>
<li>一个 Cell 上跑一个<strong>集群</strong>管理系统 Borg。</li>
<li>通过定义 Cell 可以让 Borg 对服务器资源进行统一抽象，作为用户就无需知道自己的应用跑在哪台机器上，也不用关心资源分配、程序安装、依赖管理、健康检查及故障恢复等。</li>
</ul>
</li>
<li><p>Job 和 Task</p>
<blockquote>
<p>相当于 k8s 中的 pod 和 container</p>
</blockquote>
<ul>
<li>用户以 Job 的形式提交应用部署请求。一个 Job 包含一个或多个相同的 Task，每个 Task 运行相同的应用程序，Task 数量就是应用的副本数。</li>
<li>每个 Job 可以定义属性、元信息和优先级，优先级涉及到抢占式调度过程。</li>
</ul>
</li>
<li><p>Naming</p>
<ul>
<li>Borg 的服务发现通过 BNS （ Borg NameService）来实现。</li>
<li>50.jfoo.ubar.cc.borg.google.com 可表示在一个名为 cc 的 Cell 中由用户 uBar 部署的一个名为 jFoo 的 Job下的第 50 个 Task。</li>
</ul>
</li>
</ul>
<h4 id="Borg-架构"><a href="#Borg-架构" class="headerlink" title="Borg 架构"></a>Borg 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Borg架构.png" alt="Borg架构"></p>
<h4 id="应用高可用"><a href="#应用高可用" class="headerlink" title="应用高可用"></a>应用高可用</h4><ul>
<li>被抢占的 non-prod 任务放回 pending queue，等待重新调度。</li>
<li>多副本应用跨故障域部署。所谓故障域有大有小，比如相同机器、相同机架或相同电源插座等，一挂全挂。</li>
<li>对于类似服务器或操作系统升级的维护操作，避免大量服务器同时进行。</li>
<li>支持幂等性，支持客户端重复操作。</li>
<li>当服务器状态变为不可用时，要控制重新调度任务的速率。因为 Borg 无法区分是节点故障还是出现了短暂的网络分区，如果是后者，静静地等待网络恢复更利于保障服务可用性。</li>
<li>当某种”任务 @ 服务器”的组合出现故障时，下次重新调度时需避免这种组合再次出现，因为极大可能会再次出现相同故障。</li>
<li>记录详细的内部信息，便于故障排查和分析。</li>
<li>保障应用高可用的关键性设计原则：无论何种原因，即使 Borgmaster 或者 Borglet 挂掉、失联，都不能杀掉正在运行的服务（Task）。</li>
</ul>
<h4 id="Borg-系统自身高可用"><a href="#Borg-系统自身高可用" class="headerlink" title="Borg 系统自身高可用"></a>Borg 系统自身高可用</h4><ul>
<li>Borgmaster 组件多副本设计。</li>
<li>采用一些简单的和底层（low-level）的工具来部署 Borg 系统实例，避免引入过多的外部依赖。</li>
<li>每个 Cell 的 Borg 均独立部署，避免不同 Borg 系统相互影响。</li>
</ul>
<h4 id="资源利用率"><a href="#资源利用率" class="headerlink" title="资源利用率"></a>资源利用率</h4><ul>
<li>通过将在线任务（prod）和离线任务（non-prod，Batch）混合部署，空闲时，离线任务可以充分利用计算资源；繁忙时，在线任务通过抢占的方式保证优先得到执行，合理地利用资源。</li>
<li>98% 的服务器实现了混部。</li>
<li>90% 的服务器中跑了超过25 个 Task 和 4500 个线程。</li>
<li>在一个中等规模的 Cell 里，在线任务和离线任务独立部署比混合部署所需的服务器数量多出约20%-30%。</li>
</ul>
<p>可以简单算一笔账，Google 的服务器数量在千万级别，按 20% 算也是百万级别，大概能省下的服务器采购费用就是百亿级别了，这还不包括省下的机房等基础设施和电费等费用。</p>
<h4 id="Brog-调度原理"><a href="#Brog-调度原理" class="headerlink" title="Brog 调度原理"></a>Brog 调度原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Brog调度原理.png" alt="Brog调度原理"></p>
<h4 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h4><p>安全性隔离：</p>
<ul>
<li>早期采用 Chroot jail，后期版本基于 Namespace。</li>
</ul>
<p>性能隔离：</p>
<ul>
<li>采用基于 Cgroup 的容器技术实现。</li>
<li>在线任务（prod）是延时敏感（latency-sensitive）型的，优先级高，而离线任务（non-prod，Batch）优先级低。</li>
<li>Borg 通过不同优先级之间的抢占式调度来优先保障在线任务的性能，牺牲离线任务。</li>
<li>Borg 将资源类型分成两类：</li>
<li>可压榨的（compressible），CPU 是可压榨资源，资源耗尽不会终止进程；</li>
<li>不可压榨的（non-compressible），内存是不可压榨资源，资源耗尽进程会被终止。</li>
</ul>
<h4 id="什么是Kubernetes（K8s）"><a href="#什么是Kubernetes（K8s）" class="headerlink" title="什么是Kubernetes（K8s）"></a>什么是Kubernetes（K8s）</h4><p>Kubernetes 是谷歌开源的容器集群管理系统，是 Google 多年大规模容器管理技术 Borg 的开源版本，主要功能包括：</p>
<ul>
<li>基于容器的应用部署、维护和滚动升级；</li>
<li>负载均衡和服务发现；</li>
<li>跨机器和跨地区的集群调度；</li>
<li>自动伸缩；</li>
<li>无状态服务和有状态服务；</li>
<li>插件机制保证扩展性。</li>
</ul>
<h4 id="命令式（-Imperative）vs-声明式（-Declarative）"><a href="#命令式（-Imperative）vs-声明式（-Declarative）" class="headerlink" title="命令式（ Imperative）vs 声明式（ Declarative）"></a>命令式（ Imperative）vs 声明式（ Declarative）</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/命令式和声明式.png" alt="命令式和声明式"></p>
<h4 id="声明式（Declaritive）系统规范"><a href="#声明式（Declaritive）系统规范" class="headerlink" title="声明式（Declaritive）系统规范"></a>声明式（Declaritive）系统规范</h4><p>命令式：</p>
<ul>
<li>我要你做什么，怎么做，请严格按照我说的做。</li>
</ul>
<p>声明式：</p>
<ul>
<li>我需要你帮我做点事，但是我只告诉你我需要你做什么，不是你应该怎么做。</li>
<li>直接声明：我直接告诉你我需要什么。</li>
<li>间接声明：我不直接告诉你我的需求，我会把我的需求放在特定的地方，请在方便的时候拿出来处理。</li>
</ul>
<p>幂等性：</p>
<ul>
<li>状态固定，每次我要你做事，请给我返回相同结果。</li>
</ul>
<p>面向对象的：</p>
<ul>
<li>把一切抽象成对象。</li>
</ul>
<h4 id="Kubernetes：声明式系统"><a href="#Kubernetes：声明式系统" class="headerlink" title="Kubernetes：声明式系统"></a>Kubernetes：声明式系统</h4><p>Kubernetes 的所有管理能力构建在对象抽象的基础上，核心对象包括：</p>
<ul>
<li>Node：计算节点的抽象，用来描述计算节点的资源抽象、健康状态等。</li>
<li>Namespace：资源隔离的基本单位，可以简单理解为文件系统中的目录结构。</li>
<li>Pod：用来描述应用实例，包括镜像地址、资源需求等。Kubernetes 中最核心的对象，也是打通应用和基础架构的秘密武器。</li>
<li>Service：服务如何将应用发布成服务，本质上是负载均衡和域名服务的声明。</li>
</ul>
<h4 id="Kubernetes-架构"><a href="#Kubernetes-架构" class="headerlink" title="Kubernetes 架构"></a>Kubernetes 架构</h4><p>Kubernetes 采用与 Borg 类似的架构</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/k8s架构.png" alt="k8s架构"></p>
<p>主要组件</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/k8s主要组件.png" alt="k8s主要组件"></p>
<h4 id="Kubernetes-的主节点（Master-Node）"><a href="#Kubernetes-的主节点（Master-Node）" class="headerlink" title="Kubernetes 的主节点（Master Node）"></a>Kubernetes 的主节点（Master Node）</h4><ol>
<li><p>API 服务器（API Server）</p>
<blockquote>
<p>API Server 的主要作用是对请求做认证、鉴权以及准入（验证请求内容的合法性），无其他逻辑。</p>
</blockquote>
<p> 这是Kubernetes 控制面板中唯一带有用户可访问API 以及用户可交互的组件。API 服务器会暴露一个RESTful 的Kubernetes API 并使用JSON 格式的清单文件（manifest files）。</p>
</li>
<li><p>群的数据存储（Cluster Data Store）</p>
<p> Kubernetes 使用 “etcd” 。这是一个强大的、稳定的、高可用的键值存储， 被 Kubernetes 用于长久储存所有的API 对象。</p>
</li>
<li><p>控制管理器（Controller Manager）</p>
<p> 被称为 “kube-controller manager”，它运行着所有处理集群日常任务的控制器。包括了节点控制器、副本控制器、端点（endpoint）控制器以及服务账户等。</p>
</li>
<li><p>调度器（Scheduler）</p>
<p> 调度器会监控新建的 pods（一组或一个容器）并将其分配给节点。</p>
</li>
</ol>
<h4 id="Kubernetes-的工作节点（Worker-Node）"><a href="#Kubernetes-的工作节点（Worker-Node）" class="headerlink" title="Kubernetes 的工作节点（Worker Node）"></a>Kubernetes 的工作节点（Worker Node）</h4><ol>
<li><p>Kubelet</p>
<p> 负责调度到对应节点的 Pod 的生命周期管理，执行任务并将 Pod 状态报告给主节点的渠道，通过容器运行时（拉取镜像、启动和停止容器等）来运行这些容器。它还会定期执行被请求的容器的健康探测程序。</p>
</li>
<li><p>Kube-proxy</p>
<p> 它负责节点的网络，在主机上维护网络规则并执行连接转发。它还负责对正在服务的 pods 进行负载平衡。</p>
</li>
</ol>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd.png" alt="etcd"></p>
<h4 id="直接访问-etcd-的数据"><a href="#直接访问-etcd-的数据" class="headerlink" title="直接访问 etcd 的数据"></a>直接访问 etcd 的数据</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动一个 minikube 集群</span>
$ minikube start

<span class="token comment"># 获取 kube-system 中所有 pods</span>
$ kubectl -n kube-system get pods
NAME                               READY   STATUS    RESTARTS       AGE
coredns-7db6d8ff4d-z2rlw           <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
etcd-minikube                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-apiserver-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-controller-manager-minikube   <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-proxy-m5fjm                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-scheduler-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
storage-provisioner                <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>4h9m ago<span class="token punctuation">)</span>   4h10m

<span class="token comment"># 进入集群 etcd 所在的容器</span>
$ kubectl -n kube-system <span class="token builtin class-name">exec</span> -it etcd-minikube /bin/sh

$ <span class="token builtin class-name">alias</span> <span class="token assign-left variable">etcdctl</span><span class="token operator">=</span><span class="token string">"etcdctl --endpoints https://localhost:2379 --cacert=/var/lib/minikube/certs/etcd/ca.crt --cert=/var/lib/minikube/certs/etcd/server.crt --key=/var/lib/minikube/certs/etcd/server.key"</span>

<span class="token comment"># 查看 etcd 中的数据</span>
$ etcdctl get --prefix / --keys-only

<span class="token comment"># 监听 default 命名空间中名为 nginx-svc 的 service 的变化</span>
$ etcdctl <span class="token function">watch</span> --prefix /registry/services/specs/default/nginx-svc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="APIServer"><a href="#APIServer" class="headerlink" title="APIServer"></a>APIServer</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer.png" alt="APIServer"></p>
<h4 id="APIServer-展开"><a href="#APIServer-展开" class="headerlink" title="APIServer 展开"></a>APIServer 展开</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer展开.png" alt="APIServer展开"></p>
<h4 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h4><ul>
<li>Controller Manager 是集群的大脑，是确保整个集群动起来的关键；</li>
<li>作用是确保 Kubernetes 遵循声明式系统规范，确保系统的真实状态（Actual State）与用户定义的期望状态（Desired State）一致；</li>
<li>Controller Manager 是多个控制器的组合，每个 Controller 事实上都是一个 control loop，负责侦听其管控的对象，当对象发生变更时完成配置；</li>
<li>Controller 配置失败通常会触发自动重试，整个集群会在控制器不断重试的机制下确保最终一致性（ Eventual Consistency）。</li>
</ul>
<h4 id="控制器的工作流程"><a href="#控制器的工作流程" class="headerlink" title="控制器的工作流程"></a>控制器的工作流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的工作流程.png" alt="控制器的工作流程"></p>
<h4 id="Informer-的内部机制"><a href="#Informer-的内部机制" class="headerlink" title="Informer 的内部机制"></a>Informer 的内部机制</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Informer的内部机制.png" alt="Informer的内部机制"></p>
<h4 id="控制器的协同工作原理"><a href="#控制器的协同工作原理" class="headerlink" title="控制器的协同工作原理"></a>控制器的协同工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的协同工作原理.png" alt="控制器的协同工作原理"></p>
<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Scheduler.png" alt="Scheduler"></p>
<h4 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubelet.png" alt="Kubelet"></p>
<h4 id="Kube-Proxy"><a href="#Kube-Proxy" class="headerlink" title="Kube-Proxy"></a>Kube-Proxy</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kube-Proxy.png" alt="Kube-Proxy"></p>
<h4 id="推荐的-Add-ons"><a href="#推荐的-Add-ons" class="headerlink" title="推荐的 Add-ons"></a>推荐的 Add-ons</h4><ul>
<li>kube-dns：负责为整个集群提供 DNS 服务；</li>
<li>Ingress Controller：为服务提供外网入口；</li>
<li>MetricsServer：提供资源监控；</li>
<li>Dashboard：提供GUI；</li>
<li>Fluentd-Elasticsearch：提供集群日志采集、存储与查询。</li>
</ul>
<h3 id="了解-kubectl"><a href="#了解-kubectl" class="headerlink" title="了解 kubectl"></a>了解 kubectl</h3><h4 id="Kubectl-命令和-kubeconfig"><a href="#Kubectl-命令和-kubeconfig" class="headerlink" title="Kubectl 命令和 kubeconfig"></a>Kubectl 命令和 kubeconfig</h4><ul>
<li>kubectl 是一个 Kubernetes 的命令行工具，它允许 Kubernetes 用户以命令行的方式与 Kubernetes 交互，其默认读取配置文件 ~/.kube/config。</li>
<li>kubectl 会将接收到的用户请求转化为 rest 调用以 rest client 的形式与 apiserver 通讯。</li>
<li>apiserver 的地址，用户信息等配置在 kubeconfig。</li>
</ul>
<p>可以在命令后加 <code>-v 9</code> 来开启详细的日志，如 <code>kubectl get namespace default -v 9</code>。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">certificate-authority</span><span class="token punctuation">:</span> /home/k/.minikube/ca.crt
    <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">extension</span><span class="token punctuation">:</span>
        <span class="token key atrule">last-update</span><span class="token punctuation">:</span> Thu<span class="token punctuation">,</span> 02 May 2024 21<span class="token punctuation">:</span>50<span class="token punctuation">:</span>24 CST
        <span class="token key atrule">provider</span><span class="token punctuation">:</span> minikube.sigs.k8s.io
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.33.0
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster_info
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">32774</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> minikube
    <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">extension</span><span class="token punctuation">:</span>
        <span class="token key atrule">last-update</span><span class="token punctuation">:</span> Thu<span class="token punctuation">,</span> 02 May 2024 21<span class="token punctuation">:</span>50<span class="token punctuation">:</span>24 CST
        <span class="token key atrule">provider</span><span class="token punctuation">:</span> minikube.sigs.k8s.io
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.33.0
      <span class="token key atrule">name</span><span class="token punctuation">:</span> context_info
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
    <span class="token key atrule">user</span><span class="token punctuation">:</span> minikube
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">preferences</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token key atrule">client-certificate</span><span class="token punctuation">:</span> /home/k/.minikube/profiles/minikube/client.crt
    <span class="token key atrule">client-key</span><span class="token punctuation">:</span> /home/k/.minikube/profiles/minikube/client.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubectl-常用命令"><a href="#kubectl-常用命令" class="headerlink" title="kubectl 常用命令"></a>kubectl 常用命令</h4><p><strong>kubectl get po -oyaml -w</strong></p>
<ul>
<li>kubectl 可查看对象。</li>
<li>-oyaml 输出详细信息为 yaml 格式。</li>
<li>-w watch 该对象的后续变化。</li>
<li>-owide 以详细列表的格式查看对象。</li>
</ul>
<p><strong>kubectl describe 展示资源的详细信息和相关 Event。</strong></p>
<p><strong>kubectl exec 提供进入运行容器的通道，可以进入容器进行 debug 操作。</strong></p>
<p><strong>Kubectl logs 可查看 pod 的标准输入（stdout, stderr），与 tail 用法类似。</strong></p>
<h3 id="深入理解-Kubernetes"><a href="#深入理解-Kubernetes" class="headerlink" title="深入理解 Kubernetes"></a>深入理解 Kubernetes</h3><h4 id="云计算的传统分类"><a href="#云计算的传统分类" class="headerlink" title="云计算的传统分类"></a>云计算的传统分类</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云计算的传统分类.png" alt="云计算的传统分类"></p>
<h4 id="Kubernetes-生态系统"><a href="#Kubernetes-生态系统" class="headerlink" title="Kubernetes 生态系统"></a>Kubernetes 生态系统</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes生态系统.png" alt="Kubernetes生态系统"></p>
<h4 id="Kubernetes-设计理念"><a href="#Kubernetes-设计理念" class="headerlink" title="Kubernetes 设计理念"></a>Kubernetes 设计理念</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes设计理念.png" alt="Kubernetes设计理念"></p>
<h4 id="Kubernetes-Master"><a href="#Kubernetes-Master" class="headerlink" title="Kubernetes Master"></a>Kubernetes Master</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/KubernetesMaster.png" alt="KubernetesMaster"></p>
<h4 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h4><ul>
<li>核心层：Kubernetes 最核心的功能，对外提供 API 构建高层的应用，对内提供插件式应用执行环境。</li>
<li>应用层：部署（无状态应用、有状态应用、批处理任务、集群应用等）和路由（服务发现、DNS 解析等）。</li>
<li>管理层：系统度量（如基础设施、容器和网络的度量）、自动化（如自动扩展、动态 Provision 等）、策略管理（RBAC、Quota、PSP、NetworkPolicy 等）。</li>
<li>接口层：Kubectl 命令行工具、客户端 SDK 以及集群联邦。</li>
<li>生态系统：在接口层之上的庞大容器集群管理调度的生态系统，可以划分为两个范畴：<ul>
<li>Kubernetes 外部：日志、监控、配置管理、CI、CD、Workflow、FaaS、OTS 应用、ChatOps 等；</li>
<li>Kubernetes 内部：CRI、CNI、CVI、镜像仓库、Cloud Provider、集群自身的配置和管理等。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分层架构一.png" alt="分层架构一"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分层架构二.png" alt="分层架构二"></p>
<h4 id="API-设计原则"><a href="#API-设计原则" class="headerlink" title="API 设计原则"></a>API 设计原则</h4><ul>
<li>所有 API 都应是声明式的<ul>
<li>相对于命令式操作，声明式操作对于重复操作的效果是稳定的，这对于容易出现数据丢失或重复的分布式环境来说是很重要的。</li>
<li>声明式操作更易被用户使用，可以使系统向用户隐藏实现的细节，同时也保留了系统未来持续优化的可能性。</li>
<li>此外，声明式的 API 还隐含了所有的 API 对象都是名词性质的，例如 Service、Volume 这些 API 都是名词，这些名词描述了用户所期望得到的一个目标对象。</li>
</ul>
</li>
<li>API 对象是彼此互补而且可组合的<ul>
<li>这实际上鼓励 API 对象尽量实现面向对象设计时的要求，即”高内聚，松耦合”，对业务相关的概念有一个合适的分解，提高分解出来的对象的可重用性。</li>
</ul>
</li>
<li>高层 API 以操作意图为基础设计<ul>
<li>如何能够设计好 API，跟如何能用面向对象的方法设计好应用系统有相通的地方，高层设计一定是从业务出发，而不是过早的从技术实现出发。</li>
<li>因此，针对 Kubernetes 的高层 API 设计，一定是以 Kubernetes 的业务为基础出发，也就是以系统调度管理容器的操作意图为基础设计。</li>
</ul>
</li>
<li>低层 API 根据高层 API 的控制需要设计<ul>
<li>设计实现低层 API 的目的，是为了被高层 API 使用，考虑减少冗余、提高重用性的目的，低层 API 的设计也要以需求为基础，要尽量抵抗受技术实现影响的诱惑。</li>
</ul>
</li>
<li>尽量避免简单封装，不要有在外部 API 无法显式知道的内部隐藏的机制<ul>
<li>简单的封装，实际没有提供新的功能，反而增加了对所封装 API 的依赖性。</li>
<li>例如 StatefulSet 和 ReplicaSet，本来就是两种 Pod 集合，那么 Kubernetes 就用不同 API 对象来定义它们，而不会说只用同一个 ReplicaSet，内部通过特殊的算法再来区分这个 ReplicaSet 是有状态的还是无状态。</li>
</ul>
</li>
<li>API 操作复杂度与对象数量成正比<ul>
<li>API 的操作复杂度不能超过 O(N)，否则系统就不具备水平伸缩性了。</li>
</ul>
</li>
<li>API 对象状态不能依赖于网络连接状态<ul>
<li>由于众所周知，在分布式环境下，网络连接断开是经常发生的事情，因此要保证 API 对象状态能应对网络的不稳定，API 对象的状态就不能依赖于网络连接状态。</li>
</ul>
</li>
<li>尽量避免让操作机制依赖于全局状态<ul>
<li>因为在分布式系统中要保证全局状态的同步是非常困难的。</li>
</ul>
</li>
</ul>
<h4 id="Kubernetes-如何通过对象的组合完成业务描述"><a href="#Kubernetes-如何通过对象的组合完成业务描述" class="headerlink" title="Kubernetes 如何通过对象的组合完成业务描述"></a>Kubernetes 如何通过对象的组合完成业务描述</h4><blockquote>
<p>引用依赖：一个对象中有个属性的名字指向了另一个对象。</p>
<p>基于命名规范：Deployment 根据 PodTemplate 的 hash 值来作为 Replicaset 名字的一部分，这个关系是写在代码中的。</p>
<p>基于标签：根据标签来筛选。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes如何通过对象的组合完成业务描述.png" alt="Kubernetes如何通过对象的组合完成业务描述"></p>
<h4 id="架构设计原则"><a href="#架构设计原则" class="headerlink" title="架构设计原则"></a>架构设计原则</h4><ul>
<li>只有 APIServer 可以直接访问 etcd 存储，其他服务必须通过 Kubernetes API 来访问集群状态；</li>
<li>单节点故障不应该影响集群的状态；</li>
<li>在没有新请求的情况下，所有组件应该在故障恢复后继续执行上次最后收到的请求（比如网络分区或服务重启等）；</li>
<li>所有组件都应该在内存中保持所需要的状态，APIServer 将状态写入 etcd 存储，而其他组件则通过 API Server 更新并监听所有的变化；</li>
<li>优先使用事件监听而不是轮询。</li>
</ul>
<h4 id="引导（Bootstrapping）原则"><a href="#引导（Bootstrapping）原则" class="headerlink" title="引导（Bootstrapping）原则"></a>引导（Bootstrapping）原则</h4><ul>
<li>Self-hosting 是目标。</li>
<li>减少依赖，特别是稳态运行的依赖。</li>
<li>通过分层的原则管理依赖。</li>
<li>循环依赖问题的原则：<ul>
<li>同时还接受其他方式的数据输入（比如本地文件等），这样在其他服务不可用时还可以手动配置引导服务；</li>
<li>状态应该是可恢复或可重新发现的；</li>
<li>支持简单的启动临时实例来创建稳态运行所需要的状态，使用分布式锁或文件锁等来协调不同状态的切换（通常称为 pivoting 技术）；</li>
<li>自动重启异常退出的服务，比如副本或者进程管理器等。</li>
</ul>
</li>
</ul>
<h4 id="核心技术概念和-API-对象"><a href="#核心技术概念和-API-对象" class="headerlink" title="核心技术概念和 API 对象"></a>核心技术概念和 API 对象</h4><p>API 对象是 Kubernetes 集群中的管理操作单元。</p>
<p>Kubernetes 集群系统每支持一项新功能，引入一项新技术，一定会新引入对应的API 对象，支持对该功能的管理操作。</p>
<p>每个 API 对象都有四大类属性：</p>
<ul>
<li>TypeMeta</li>
<li>MetaData</li>
<li>Spec</li>
<li>Status</li>
</ul>
<h4 id="TypeMeta"><a href="#TypeMeta" class="headerlink" title="TypeMeta"></a>TypeMeta</h4><p>Kubernetes对象的最基本定义，它通过引入 GKV（Group，Kind，Version）模型定义了一个对象的类型。</p>
<ol>
<li>Group<br> Kubernetes 定义了非常多的对象，如何将这些对象进行归类是一门学问，将对象依据其功能范围归入不同的分组，比如把支撑最基本功能的对象归入 core 组，把与应用部署有关的对象归入 apps 组，会使这些对象的可维护性和可理解性更高。</li>
<li>Kind<br> 定义一个对象的基本类型，比如 Node、Pod、Deployment 等。</li>
<li>Version<br> 社区每个季度会推出一个 Kubernetes 版本，随着 Kubernetes 版本的演进，对象从创建之初到能够完全生产化就绪的版本是不断变化的。与软件版本类似，通常社区提出一个模型定义以后，随着该对象不断成熟，其版本可能会从 v1alpha1 到 v1alpha2，或者到 v1beta1，最终变成生产就绪版本 v1。</li>
</ol>
<h4 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h4><p>Metadata 中有两个最重要的属性：Namespace 和 Name，分别定义了对象的 Namespace 归属及名字，这两个属性唯一定义了某个对象实例。</p>
<ol>
<li><p>Label</p>
<p> 顾名思义就是给对象打标签，一个对象可以有任意对标签，其存在形式是键值对。Label 定义了对象的可识别属性，Kubernetes API 支持以 Label 作为过滤条件查询对象。</p>
</li>
<li><p>Annotation</p>
<p> Annotation 与 Label 一样用键值对来定义，但 Annotation 是作为属性扩展，更多面向于系统管理员和开发人员，因此需要像其他属性一样做合理归类。</p>
</li>
<li><p>Finalizer</p>
<p> Finalizer 本质上是一个资源锁，Kubernetes 在接收某对象的删除请求时，会检查 Finalizer 是否为空，如果不为空则只对其做逻辑删除，即只会更新对象中的 metadata.deletionTimestamp 字段。</p>
<p> 主要用于避免某个资源控制器意外终止，而无法监听到对应资源删除事件的情况。一旦某个资源设置了 Finalizer，那么这个资源删除时将不会消除，需要删除资源上的 Finalizer 后这个资源才会真正的删除，这就给了对应资源控制器处理的机会。</p>
</li>
<li><p>ResourceVersion</p>
<p> ResourceVersion 可以被看作一种乐观锁，每个对象在任意时刻都有其 ResourceVersion，当 Kubernetes 对象被客户端读取以后，ResourceVersion 信息也被一并读取。此机制确保了分布式系统中任意多线程能够无锁并发访问对象，极大提升了系统的整体效率。</p>
</li>
</ol>
<h5 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h5><ul>
<li>Label 是识别 Kubernetes 对象的标签，以 key/value 的方式附加到对象上。</li>
<li>key 最长不能超过 63 字节，value 可以为空，也可以是不超过 253 字节的字符串。</li>
<li>Label 不提供唯一性，并且实际上经常是很多对象（如 Pods）都使用相同的 label 来标志具体的应用。</li>
<li>Label 定义好后其他对象可以使用 Label Selector 来选择一组相同 label 的对象</li>
<li>Label Selector 支持以下几种方式：<ul>
<li>等式，如 app=nginx 和 env!=production；</li>
<li>集合，如 env in (production, qa)；</li>
<li>多个 label（它们之间是 AND 关系），如 app=nginx,env=test。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Label.png" alt="Label"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="https://draveness.me/kubernetes-object-intro/">https://draveness.me/kubernetes-object-intro/</a></p>
</blockquote>
<h5 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h5><ul>
<li>Annotations 是 key/value 形式附加于对象的注解。</li>
<li>不同于 Labels 用于标志和选择对象，Annotations 则是用来记录一些附加信息，用来辅助应用部署、安全策略以及调度策略等。</li>
<li>比如 deployment 使用 annotations 来记录 rolling update 的状态。</li>
</ul>
<h5 id="Spec-和-Status"><a href="#Spec-和-Status" class="headerlink" title="Spec 和 Status"></a>Spec 和 Status</h5><ul>
<li>Spec 和 Status 才是对象的核心。</li>
<li>Spec 是用户的期望状态，由创建对象的用户端来定义。</li>
<li>Status 是对象的实际状态，由对应的控制器收集实际状态并更新。</li>
<li>与 TypeMeta 和 Metadata 等通用属性不同，Spec 和 Status 是每个对象独有的。</li>
</ul>
<h4 id="常用Kubernetes-对象及其分组"><a href="#常用Kubernetes-对象及其分组" class="headerlink" title="常用Kubernetes 对象及其分组"></a>常用Kubernetes 对象及其分组</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/常用Kubernetes对象及其分组.png" alt="常用Kubernetes对象及其分组.png"></p>
<h3 id="核心对象概览"><a href="#核心对象概览" class="headerlink" title="核心对象概览"></a>核心对象概览</h3><h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><ul>
<li>Node 是 Pod 真正运行的主机，可以物理机，也可以是虚拟机。</li>
<li>为了管理 Pod，每个 Node 节点上至少要运行 container runtime（比如Docker 或者Rkt）、Kubelet 和 Kube-proxy 服务。</li>
</ul>
<h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h4><p>Namespace 是对一组资源和对象的抽象集合，比如可以用来将系统内部的对象划分为不同的项目组或用户组。</p>
<p>常见的 pods, services, replication controllers 和 deployments 等都是属于某一个 Namespace 的（默认是 default），而 Node, persistentVolumes 等则不属于任何 Namespace。</p>
<h4 id="什么是-Pod"><a href="#什么是-Pod" class="headerlink" title="什么是 Pod"></a>什么是 Pod</h4><ul>
<li>Pod 是一组紧密关联的容器集合，它们共享 PID、IPC、Network 和 UTS namespace，是 Kubernetes 调度的基本单位。</li>
<li>Pod 的设计理念是支持多个容器在一个 Pod 中共享网络和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。</li>
<li>同一个 Pod 中的不同容器可共享资源：<ul>
<li>共享网络 Namespace；</li>
<li>可通过挂载存储卷共享存储；</li>
<li>共享 Security Context。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.15</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="如何通过Pod-对象定义支撑应用运行"><a href="#如何通过Pod-对象定义支撑应用运行" class="headerlink" title="如何通过Pod 对象定义支撑应用运行"></a>如何通过Pod 对象定义支撑应用运行</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何通过Pod对象定义支撑应用运行.png" alt="如何通过Pod对象定义支撑应用运行"></p>
<h4 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h4><ul>
<li>通过存储卷可以将外挂存储挂载到 Pod 内部使用。</li>
<li>存储卷定义包括两个部分: Volume 和 VolumeMounts。<ul>
<li>Volume：定义 Pod 可以使用的存储卷来源；</li>
<li>VolumeMounts：定义存储卷如何 Mount 到容器内部。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>volume
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.15</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Pod-网络"><a href="#Pod-网络" class="headerlink" title="Pod 网络"></a>Pod 网络</h4><p>Pod 的多个容器是共享网络 Namespace 的，这意味着：</p>
<ul>
<li>同一个 Pod 中的不同容器可以彼此通过 Loopback 地址访问：<ul>
<li>在第一个容器中起了一个服务 <a target="_blank" rel="noopener" href="http://127.0.0.1">http://127.0.0.1</a> 。</li>
<li>在第二个容器内，是可以通过 httpGet <a target="_blank" rel="noopener" href="http://172.0.0.1">http://172.0.0.1</a> 访问到该地址的。</li>
</ul>
</li>
<li>这种方法常用于不同容器的互相协作。</li>
</ul>
<h4 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h4><p>Kubernetes 通过 Cgroups 提供容器资源管理的功能，可以限制每个容器的 CPU 和内存使用，比如对于刚才创建的 deployment，可以通过下面的命令限制 nginx 容器最多只用 50% 的CPU 和 128MB 的内存：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">set</span> resources deployment nginx-app -c<span class="token operator">=</span>nginx --limits<span class="token operator">=</span>cpu<span class="token operator">=</span>500m,memory<span class="token operator">=</span>128Mi
deployment <span class="token string">"nginx"</span> resource requirements updated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>等同于在每个 Pod 中设置 resources limits</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"500m"</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"128Mi"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h4><p>Kubernetes 作为一个面向应用的集群管理工具，需要确保容器在部署后确实处在正常的运行状态。</p>
<ol>
<li>探针类型：</li>
</ol>
<ul>
<li>LivenessProbe<ul>
<li>探测应用是否处于健康状态，如果不健康则删除并重新创建容器。</li>
</ul>
</li>
<li>ReadinessProbe<ul>
<li>探测应用是否就绪并且处于正常服务状态，如果不正常则不会接收来自 Kubernetes Service 的流量。</li>
</ul>
</li>
<li>StartupProbe<ul>
<li>探测应用是否启动完成，如果在 <code>failureThreshold * periodSeconds</code> 周期内未就绪，则会应用进程会被重启。</li>
</ul>
</li>
</ul>
<ol>
<li>探活方式：</li>
</ol>
<ul>
<li>Exec</li>
<li>TCP socket</li>
<li>HTTP</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/健康检查spec.png" alt="健康检查spec"></p>
<h4 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><ul>
<li>ConfigMap 用来将非机密性的数据保存到键值对中。</li>
<li>使用时， Pods 可以将其用作环境变量、命令行参数或者存储卷中的配置文件。</li>
<li>ConfigMap 将环境配置信息和容器镜像解耦，便于应用配置的修改。</li>
</ul>
<h4 id="密钥对象（Secret）"><a href="#密钥对象（Secret）" class="headerlink" title="密钥对象（Secret）"></a>密钥对象（Secret）</h4><ul>
<li>Secret 是用来保存和传递密码、密钥、认证凭证这些敏感信息的对象。</li>
<li>使用 Secret 的好处是可以避免把敏感信息明文写在配置文件里。</li>
<li>Kubernetes 集群中配置和使用服务不可避免的要用到各种敏感信息实现登录、认证等功能，例\如访问 AWS 存储的用户名密码。</li>
<li>为了避免将类似的敏感信息明文写在所有需要使用的配置文件中，可以将这些信息存入一个 Secret 对象，而在配置文件中通过 Secret 对象引用这些敏感信息。</li>
<li>这种方式的好处包括：意图明确，避免重复，减少暴漏机会。</li>
</ul>
<h4 id="用户（User-Account）-amp-服务帐户（Service-Account）"><a href="#用户（User-Account）-amp-服务帐户（Service-Account）" class="headerlink" title="用户（User Account）&amp; 服务帐户（Service Account）"></a>用户（User Account）&amp; 服务帐户（Service Account）</h4><ul>
<li>顾名思义，用户帐户为人提供账户标识，而服务账户为计算机进程和 Kubernetes 集群中运行的 Pod 提供账户标识。</li>
<li>用户帐户和服务帐户的一个区别是作用范围：<ul>
<li>用户帐户对应的是人的身份，人的身份与服务的 Namespace 无关，所以用户账户是跨 Namespace 的；</li>
<li>而服务帐户对应的是一个运行中程序的身份，与特定 Namespace 是相关的。</li>
</ul>
</li>
</ul>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p>Service 是应用服务的抽象，通过 labels 为应用提供负载均衡和服务发现。匹配 labels 的 Pod IP 和端口列表组成 <code>endpoints</code>，由 Kube-proxy 负责将服务 IP 负载均衡到这些 endpoints 上。</p>
<p>每个 Service 都会自动分配一个 cluster IP（仅在集群内部可访问的虚拟地址）和 DNS 名，其他容器可以通过该地址或 DNS 来访问服务，而不需要了解后端容器的运行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service.png" alt="Service"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8078</span> <span class="token comment"># the port that this service should serve on</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token comment"># the container on each pod to connect to, can be a name</span>
    <span class="token comment"># (e.g. 'www') or a number (e.g. 80)</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="副本集（Replica-Set）"><a href="#副本集（Replica-Set）" class="headerlink" title="副本集（Replica Set）"></a>副本集（Replica Set）</h4><ul>
<li>Pod 只是单个应用实例的抽象，要构建高可用应用，通常需要构建多个同样的副本，提供同一个服务。</li>
<li>Kubernetes 为此抽象出副本集 ReplicaSet，其允许用户定义 Pod 的副本数，每一个 Pod 都会被当作一个无状态的成员进行管理，Kubernetes 保证总是有用户期望的数量的 Pod 正常运行。</li>
<li>当某个副本宕机以后，控制器将会创建一个新的副本。</li>
<li>当因业务负载发生变更而需要调整扩缩容时，可以方便地调整副本数量。</li>
</ul>
<p>RS 创建出来的名字分为三个部分，如：<code>nginx-deploy-59dc7f9d89-k9rj9</code></p>
<ol>
<li>第一个部分 <code>nginx-deploy</code> 是 deployment 的名字。</li>
<li>第二个部分 <code>59dc7f9d89</code> 是配置字符串的 hash 值。</li>
<li>第三个部分 <code>k9rj9</code> 是随机值，因为是无状态的，所以给任何值都是可以的。</li>
</ol>
<h4 id="部署（Deployment）"><a href="#部署（Deployment）" class="headerlink" title="部署（Deployment）"></a>部署（Deployment）</h4><ul>
<li>部署表示用户对 Kubernetes 集群的一次更新操作。</li>
<li>部署是一个比 RS 应用模式更广的 API 对象，可以是创建一个新的服务，更新一个新的服务，也可以是滚动升级一个服务。</li>
<li>滚动升级一个服务，实际是创建一个新的 RS，然后逐渐将新 RS 中副本数增加到理想状态，将旧 RS 中的副本数减小到 0 的复合操作。</li>
<li>这样一个复合操作用一个 RS 是不太好描述的，所以用一个更通用的 Deployment 来描述。</li>
<li>以 Kubernetes 的发展方向，未来对所有长期伺服型的的业务的管理，都会通过 Deployment 来管理。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Deployment.png" alt="Deployment"></p>
<h4 id="有状态服务集（StatefulSet）"><a href="#有状态服务集（StatefulSet）" class="headerlink" title="有状态服务集（StatefulSet）"></a>有状态服务集（StatefulSet）</h4><ul>
<li>对于 StatefulSet 中的 Pod，每个 Pod 挂载自己独立的存储，如果一个 Pod 出现故障，从其他节点启动一个同样名字的 Pod，要挂载上原来 Pod 的存储继续以它的状态提供服务。</li>
<li>适合于 StatefulSet 的业务包括数据库服务 MySQL 和 PostgreSQL，集群化管理服务 ZooKeeper、etcd 等有状态服务。</li>
<li>使用 StatefulSet，Pod 仍然可以通过漂移到不同节点提供高可用，而存储也可以通过外挂的存储来提供高可靠性，StatefulSet 做的只是将确定的 Pod 与确定的存储关联起来保证状态的连续性。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/StatefulSet.png" alt="StatefulSet"></p>
<h4 id="Statefulset-与Deployment-的差异"><a href="#Statefulset-与Deployment-的差异" class="headerlink" title="Statefulset 与Deployment 的差异"></a>Statefulset 与Deployment 的差异</h4><ul>
<li>身份标识<ul>
<li>StatefulSet Controller 为每个 Pod 编号，序号从 0 开始。</li>
</ul>
</li>
<li>数据存储<ul>
<li>StatefulSet 允许用户定义volumeClaimTemplates，Pod 被创建的同时，Kubernetes 会以 volumeClaimTemplates 中定义的模板创建存储卷，并挂载给Pod。</li>
</ul>
</li>
<li>StatefulSet 的升级策略不同<ul>
<li>onDelete</li>
<li>滚动升级</li>
<li>分片升级</li>
</ul>
</li>
</ul>
<h4 id="任务（Job）"><a href="#任务（Job）" class="headerlink" title="任务（Job）"></a>任务（Job）</h4><ul>
<li>Job 是 Kubernetes 用来控制批处理型任务的 API 对象。</li>
<li>Job 管理的 Pod 根据用户的设置把任务成功完成后就自动退出。</li>
<li>成功完成的标志根据不同的 spec.completions 策略而不同：<ul>
<li>单 Pod 型任务有一个 Pod 成功就标志完成；</li>
<li>定数成功型任务保证有 N 个任务全部成功；</li>
<li>工作队列型任务根据应用确认的全局成功而标志成功。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Job.png" alt="Job"></p>
<h4 id="后台支撑服务集（DaemonSet）"><a href="#后台支撑服务集（DaemonSet）" class="headerlink" title="后台支撑服务集（DaemonSet）"></a>后台支撑服务集（DaemonSet）</h4><ul>
<li>长期伺服型和批处理型服务的核心在业务应用，可能有些节点运行多个同类业务的 Pod，有些节点上又没有这类 Pod 运行；</li>
<li>而后台支撑型服务的核心关注点在 Kubernetes 集群中的节点（物理机或虚拟机），要保证每个节点上都有一个此类 Pod 运行。</li>
<li>节点可能是所有集群节点也可能是通过 nodeSelector 选定的一些特定节点。</li>
<li>典型的后台支撑型服务包括存储、日志和监控等在每个节点上支撑 Kubernetes 集群运行的服务。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DaemonSet.png" alt="DaemonSet"></p>
<h4 id="存储-PV-和-PVC"><a href="#存储-PV-和-PVC" class="headerlink" title="存储 PV 和 PVC"></a>存储 PV 和 PVC</h4><ul>
<li>PersistentVolume（PV）是集群中的一块存储卷，可以由管理员手动设置，或当用户创建 PersistentVolumeClaim（PVC）时根据 StorageClass 动态设置。</li>
<li>PV 和 PVC 与 Pod 生命周期无关。也就是说，当 Pod 中的容器重新启动、Pod 重新调度或者删除时，PV 和 PVC 不会受到影响，Pod 存储于 PV 里的数据得以保留。</li>
<li>对于不同的使用场景，用户通常需要不同属性（例如性能、访问模式等）的 PV。</li>
</ul>
<h4 id="CustomResourceDefinition"><a href="#CustomResourceDefinition" class="headerlink" title="CustomResourceDefinition"></a>CustomResourceDefinition</h4><ul>
<li>CRD 就像数据库的开放式表结构，允许用户自定义 Schema。</li>
<li>有了这种开放式设计，用户可以基于 CRD 定义一切需要的模型，满足不同业务的需求。</li>
<li>社区鼓励基于 CRD 的业务抽象，众多主流的扩展应用都是基于 CRD 构建的，比如 Istio、Knative。</li>
<li>甚至基于 CRD 推出了 Operator Mode 和 Operator SDK，可以以极低的开发成本定义新对象，并构建新对象的控制器。</li>
</ul>
<h2 id="Kubernetes-控制平面组件-etcd"><a href="#Kubernetes-控制平面组件-etcd" class="headerlink" title="Kubernetes 控制平面组件 etcd"></a>Kubernetes 控制平面组件 etcd</h2><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/etcd-apiserver-ca58297a3d6f4b2c813ced100724a463">etcd在apiserver中的使用</a></p>
<h3 id="etcd-1"><a href="#etcd-1" class="headerlink" title="etcd"></a>etcd</h3><p>Etcd是 CoreOS 基于 Raft 开发的分布式 key value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）。</p>
<p>在分布式系统中，如何管理节点间的状态一直是一个难题，etcd 像是专门为集群环境的服务发现和注册而设计，它提供了数据 TTL 失效、数据改变监视、多值、目录监听、分布式锁原子操作等功能，可以方便的跟踪并管理集群节点的状态。</p>
<ul>
<li>键值对存储：将数据存储在分层组织的目录中，如同在标准文件系统中</li>
<li>监测变更：监测特定的键或目录以进行更改，并对值的更改做出反应</li>
<li>简单 curl 可访问的用户的 API HTTP+JSON</li>
<li>安全 : 可选的 SSL 客户端证书认证</li>
<li>快速 : 单实例每秒 1000 次写操作， 2000+ 次读操作</li>
<li>可靠 : 使用 Raft 算法保证一致性</li>
</ul>
<h4 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h4><ul>
<li>基本的 key value 存储</li>
<li>监听机制</li>
<li>key 的过期及续约机制，用于监控和服务发现</li>
<li>原子 Compare And Swap 和 Compare And Delete ，用于分布式锁和 leader 选举</li>
</ul>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li>也可以用于键值对存储，应用程序可以读取和写入 etcd 中的数据</li>
<li>etcd 比较多的应用场景是用于服务注册与发现</li>
<li>基于监听机制的分布式异步系统</li>
</ul>
<h4 id="键值对存储"><a href="#键值对存储" class="headerlink" title="键值对存储"></a>键值对存储</h4><p>etcd 是一个 <strong>键值存储</strong> 的组件，其他的应用都是基于其键值存储的功能展开。</p>
<ul>
<li>采用 kv 型数据存储，一般情况下比关系型数据库快。</li>
<li>支持动态存储（内存）以及静态存储（磁盘）。</li>
<li>分布式存储，可集成为多节点集群。</li>
<li>存储方式，采用类似目录结构。（B+tree）</li>
<li>只有叶子节点才能真正存储数据，相当于文件。</li>
<li>叶子节点的父节点一定是目录，目录不能存储数据。</li>
</ul>
<h4 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h4><ul>
<li>强一致性、高可用的服务存储目录。<ul>
<li>基于 Raft 算法的 etcd 天生就是这样一个强一致性、高可用的服务存储目录。</li>
</ul>
</li>
<li>一种注册服务和服务健康状况的机制。<ul>
<li>用户可以在 etcd 中注册服务，并且对注册的服务配置 key TTL 定时保持服务的心跳以达到监控健康状态的效果。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd服务注册与发现.png" alt="etcd服务注册与发现"></p>
<h4 id="消息发布与订阅"><a href="#消息发布与订阅" class="headerlink" title="消息发布与订阅"></a>消息发布与订阅</h4><ul>
<li>在分布式系统中，最适用的一种组件间通信方式就是消息发布与订阅。</li>
<li>即构建一个配置共享中心，数据提供者在这个配置中心发布消息，而消息使用者则订阅他们关心的主题，一旦主题有消息发布，就会实时通知订阅者。</li>
<li>通过这种方式可以做到分布式系统配置的集中式管理与动态更新。</li>
<li>应用中用到的一些配置信息放到 etcd 上进行集中管理。</li>
<li>应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候， etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd消息发布与订阅.png" alt="etcd消息发布与订阅"></p>
<h4 id="etcd-练习"><a href="#etcd-练习" class="headerlink" title="etcd 练习"></a>etcd 练习</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cncamp/101/blob/master/module5/1.etcd-member-list.MD">etcd 的安装</a></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">查看集群成员状态
$ etcdctl member list <span class="token function">write</span> <span class="token assign-left variable">out</span><span class="token operator">=</span>table
+------------------+---------+----------+---------------------------+---------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>   NAME   <span class="token operator">|</span>        PEER ADDRS         <span class="token operator">|</span>       CLIENT ADDRS        <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+----------+---------------------------+---------------------------+------------+
<span class="token operator">|</span> aec36adc501070cc <span class="token operator">|</span> started <span class="token operator">|</span> minikube <span class="token operator">|</span> https://192.168.49.2:2380 <span class="token operator">|</span> https://192.168.49.2:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+----------+---------------------------+---------------------------+------------+

<span class="token comment"># 写</span>
$ etcdctl put /a b
OK

<span class="token comment"># 读</span>
$ etcdctl get /a
/a
b

$ etcdctl get /a -wjson
<span class="token punctuation">{</span>
  <span class="token string">"header"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"cluster_id"</span><span class="token builtin class-name">:</span> <span class="token number">18038207397139143000</span>,
    <span class="token string">"member_id"</span><span class="token builtin class-name">:</span> <span class="token number">12593026477526643000</span>,
    <span class="token string">"revision"</span><span class="token builtin class-name">:</span> <span class="token number">23279</span>,              // 全局唯一的 revision， 每当 etcd 中有数据修改时，这个记录就会 +1
    <span class="token string">"raft_term"</span><span class="token builtin class-name">:</span> <span class="token number">4</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"kvs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token string">"L2E="</span>,
      <span class="token string">"create_revision"</span><span class="token builtin class-name">:</span> <span class="token number">11164</span>,     // key 创建时 revision 的值
      <span class="token string">"mod_revision"</span><span class="token builtin class-name">:</span> <span class="token number">11164</span>,        // key 上次修改时 revision 的值
      <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token string">"Yg=="</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"count"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment"># 按 key 的前缀查询数据</span>
$ etcdctl get --prefix /
$ etcdctl get --prefix / --keys-only --debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="核心：TTL-amp-CAS"><a href="#核心：TTL-amp-CAS" class="headerlink" title="核心：TTL &amp; CAS"></a>核心：TTL &amp; CAS</h4><p>TTL（time to live）指的是给一个 key 设置一个有效期，到期后这个 key 就会被自动删掉，这在很多分布式锁的实现上都会用到，可以保证锁的实时有效性。<br>Atomic Compare and Swap（CAS）指的是在对 key 进行赋值的时候，客户端需要提供一些条件，当这些条件满足后，才能赋值成功。这些条件包括：</p>
<ul>
<li>prevExist key 当前赋值前是否存在</li>
<li>prevValue key 当前赋值前的值</li>
<li>prevIndex key 当前赋值前的 Index</li>
</ul>
<p>这样的话，key 的设置是有前提的，需要知道这个 key 当前的具体情况才可以对其设置。</p>
<h3 id="Raft-协议"><a href="#Raft-协议" class="headerlink" title="Raft 协议"></a>Raft 协议</h3><h4 id="Raft-协议概览"><a href="#Raft-协议概览" class="headerlink" title="Raft 协议概览"></a>Raft 协议概览</h4><p>Raft 协议基于 quorum 机制，即大多数同意原则，任何的变更都需超过半数的成员确认</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Raft协议概览.png" alt="Raft协议概览"></p>
<h4 id="理解-Raft-协议"><a href="#理解-Raft-协议" class="headerlink" title="理解 Raft 协议"></a>理解 Raft 协议</h4><p><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p>
<h4 id="learner"><a href="#learner" class="headerlink" title="learner"></a>learner</h4><p>Raft 4.2.1 引入的新角色</p>
<p>当出现一个 etcd 集群 需要增加节点 时 ，新节点与 Leader 的数据差异较大，需要较多数据同步才能跟上 leader 的最新的数据。</p>
<p>此时 Leader 的网络带宽很可能被用尽，进而使得 leader 无法正常保持心跳。</p>
<p>进而导致 follower 重新发起投票 。</p>
<p>进而可能引发 etcd 集群不可用 。</p>
<p>Learner 角色只接收数据而不参与投票 ，因此增加 learner 节点时，集群的 quorum 不变 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdLearner.png" alt="EtcdLearner"></p>
<h4 id="etcd-基于-Raft-的一致性"><a href="#etcd-基于-Raft-的一致性" class="headerlink" title="etcd 基于 Raft 的一致性"></a>etcd 基于 Raft 的一致性</h4><p>选举方法</p>
<ul>
<li>初始启动时，节点处于 follower 状态并被设定一个 election timeout ，如果在这一时间周期内没有收到来自 leader 的 heartbeat ，节点将发起选举：将自己切换为 candidate 之后，向集群中其它 follower 节点发送请求，询问其是否选举自己成为 leader 。</li>
<li>当收到来自集群中过半数节点的接受投票后，节点即成为 leader ，开始接收保存 client 的数据并向其它的 follower 节点同步日志。如果没有达成一致，则 candidate 随机选择一个等待间隔（ 150ms ~ 300ms ）再次发起投票，得到集群中半数以上 follower 接受的 candidate 将成为 leader</li>
<li>leader 节点依靠定时向 follower 发送 heartbeat 来保持其地位。</li>
<li>任何时候如果其它 follower 在 election timeout 期间都没有收到来自 leader 的 heartbeat ，同样会将自己的状态切换为 candidate 并发起选举。每成功选举一次，新 leader 的任期（ Term ）都会比之前 leader 的任期大 1 。</li>
</ul>
<h4 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h4><p>当接 Leader 收到客户端的日志（事务请求）后先把该日志追加到本地的 Log 中，然后通过 heartbeat 把该 Entry 同步给其他 Follower Follower 接收到日志后记录日志然后向 Leader 发送 ACK ，当 Leader 收到大多数（ n/2+1 Follower 的 ACK 信息后将该日志设置为已提交并追加到本地磁盘中，通知客户端并在下个 heartbeat 中 Leader 将通知所有的 Follower 将该日志存储在自己的本地磁盘中。</p>
<h4 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h4><p>安全性是用于保证每个节点都执行相同序列的安全机制，如当某个 Follower 在当前 Leader commit Log 时变得不可用了，稍后可能该 Follower 又会被选举为 Leader ，这时新 Leader 可能会用新的 Log 覆盖先前已 committed 的 Log ，这就是导致节点执行不同序列 Safety 就是用于保证选举出来的 Leader 一定包含先前 committed Log 的机制；</p>
<p>选举安全性（Election Safety ）：每个任期（Term）只能选举出一个 Leader</p>
<p>Leader完整性（ Leader Completeness ）：指 Leader 日志的完整性，当 Log 在任期 Term1 被 Commit 后，那么以后任期 Term2 、 Term3… 等的 Leader 必须包含该 Log Raft 在选举阶段就使用 Term 的判断用于保证完整性：当请求投票的该 Candidate 的 Term 较大或 Term 相同 Index 更大则投票，否则拒绝该请求。</p>
<h4 id="失效处理"><a href="#失效处理" class="headerlink" title="失效处理"></a>失效处理</h4><ol>
<li>Leader 失效：其他没有收到 heartbeat 的节点会发起新的选举，而当 Leader 恢复后由于步进数小会自动成为 follower （日志也会被新 leader 的日志覆盖）</li>
<li>follower 节点不可用： follower 节点不可用的情况相对容易解决。因为集群中的日志内容始终是从 leader 节点同步的，只要这一节点再次加入集群时重新从 leader 节点处制日志即可。</li>
<li>多个 candidate ：冲突后 candidate 将随机选择一个等待间隔（ 150ms ~ 300ms ）再次发起投票，得到集群中半数以上 follower 接受的 candidate 将成为 leader</li>
</ol>
<h4 id="wal-日志"><a href="#wal-日志" class="headerlink" title="wal 日志"></a>wal 日志</h4><p>wal 日志是二进制的，解析出来后是以上数据结构 LogEntry 。其中第一个字段 type ，只有两种。一种是 0 表示 Normal 1 表示 ConfChange ConfChange 表示 Etcd 本身的配置变更同步，比如有新的节点加入等）。第二个字段是 term ，每个 term 代表一个主节点的任期，每次主节点变更 term 就会变化。第三个字段是 index ，这个序号是严格有序递增的，代表变更序号。第四个字段是二进制的 data ，将 raft request 对象的 pb 结构整个保存下。 etcd 源码下有个 tools/etcd dump logs ，可以将 wal 日志 dump 成文本查看，可以协助分析 Raft 协议。</p>
<p>Raft 协议本身不关心应用数据，也就是 data 中的部分，一致性都通过同步 wal 日志来实现，每个节点将从主节点收到的 data apply 到本地的存储， Raft 只关心日志的同步状态，如果本地存储实现的有 bug ，比如没有正确的将 data apply 到本地，也可能会导致数据不一致。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdLogEntry.png" alt="EtcdLogEntry"></p>
<h4 id="etcd-v3-存储"><a href="#etcd-v3-存储" class="headerlink" title="etcd v3 存储"></a>etcd v3 存储</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdV3存储.png" alt="EtcdV3存储"></p>
<h4 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h4><p>etcd v3 store 分为两部分，一部分是内存中的索引， kvindex ，是基于 Google 开源的一个 Golang 的 btree 实现的，另外一部分是后端存储。按照它的设计， backend 可以对接多种存储，当前使用的 boltdb 。 boltdb 是一个单机的支持事务的 kv 存储， etcd 的事务是基于 boltdb 的事务实现的。 etcd 在 boltdb 中存储的 key 是 reversion value 是 etcd 自己的 key value 组合，也就是说 etcd 会在 boltdb 中把每个版本都保存下，从而实现了多版本机制。</p>
<p>reversion 主要由两部分组成，第一部分 main rev ，每次事务进行加一，第二部分 sub rev ，同一个事务中的每次操作加一。</p>
<p>etcd 提供了命令和设置选项来控制 compact ，同时支持 put 操作的参数来精确控制某个 key 的历史版本数。</p>
<p>内存 kvindex 保存的就是 key 和 reversion 之前的映射关系，用来加速查询。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd存储机制.png" alt="Etcd存储机制"></p>
<blockquote>
<ol>
<li><p>每个 Etcd node 都有这些模块。</p>
</li>
<li><p>只有 Leader 能写，即使是 Follower 收到写请求，在做完 “预检查” 后，也会把请求转给 Leader。</p>
</li>
<li><p>Leader 收到请求后，先把修改放到 <code>unstable</code>，等收到超过半数的 Node 确认后移动到 <code>committed</code>，最后把修改应用到内存中的 MVCC 模块后才会挪到 <code>applied</code>。</p>
</li>
<li><p>只有存在在 MVCC 模块中的数据才能被客户端查询到。</p>
</li>
</ol>
</blockquote>
<h4 id="Watch-机制"><a href="#Watch-机制" class="headerlink" title="Watch 机制"></a>Watch 机制</h4><p>etcd v3 的 watch 机制支持 watch 某个固定的 key ，也支持 watch 一个范围（可以用于模拟目录的结构的 watch ），所以 watchGroup 包含两种 watcher ，一种是 key watchers ，数据结构是每个 key 对应一组 watcher ，另外一种是 range watchers, 数据结构是一个 IntervalTree ，方便通过区间查找到对应的 watcher 。</p>
<p>同时，每个 WatchableStore 包含两种 watcherGroup ，一种是 synced ，一种是 unsynced 前者表示该 group 的 watcher 数据都已经同步完毕，在等待新的变更，后者表示该 group 的 watcher 数据同步落后于当前最新变更，还在追赶。</p>
<p>当 etcd 收到客户端的 watch 请求，如果请求携带了 revision 参数，则比较请求的 revision 和 store 当前的 revision ，如果大于当前 revision ，则放入 synced 组中，否则放入 unsynced 组。同时 etcd 会启动一个后台的 goroutine 持续同步 unsynced 的 watcher ，然后将其迁移到 synced 组。也就是这种机制下， etcd v3 支持从任意版本开始 watch ，没有 v2 的 1000 条历史 event 表限制的问题（当然这是指没有 compact 的情况下）</p>
<h4 id="etcd-重要参数"><a href="#etcd-重要参数" class="headerlink" title="etcd 重要参数"></a>etcd 重要参数</h4><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">成员相关参数
  --name 'default'
    Human-readable name for this member.
  --data-dir '${name}.etcd'
    Path to the data directory.
  --listen-peer-urls 'http://localhost:2380'
    List of URLs to listen on for peer traffic.
  --listen-client-urls 'http://localhost:2379'
    List of URLs to listen on for client grpc traffic and http as long as --listen-client-http-urls is not specified.

集群相关参数
  --initial-advertise-peer-urls 'http://localhost:2380'
    List of this member's peer URLs to advertise to the rest of the cluster.
  --initial-cluster 'default=http://localhost:2380'
    Initial cluster configuration for bootstrapping.
  --initial-cluster-state 'new'
    Initial cluster state ('new' when bootstrapping a new cluster or 'existing' when adding new members to an existing cluster).
    After successful initialization (bootstrapping or adding), flag is ignored on restarts.
  --initial-cluster-token 'etcd-cluster'
    Initial cluster token for the etcd cluster during bootstrap.
    Specifying this can protect you from unintended cross-cluster interaction when running multiple clusters.
  --advertise-client-urls 'http://localhost:2379'
    List of this member's client URLs to advertise to the public.
    The client URLs advertised should be accessible to machines that talk to etcd cluster. etcd client libraries parse these URLs to connect to the cluster.

安全相关参数
  --cert-file ''
    Path to the client server TLS cert file.
  --key-file ''
    Path to the client server TLS key file.
  --client-crl-file ''
    Path to the client certificate revocation list file.
  --trusted-ca-file ''
    Path to the client server TLS trusted CA cert file.
  --peer-cert-file ''
    Path to the peer server TLS cert file.
  --peer-key-file ''
    Path to the peer server TLS key file.
  --peer-trusted-ca-file ''
    Path to the peer server TLS trusted CA file.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="灾备"><a href="#灾备" class="headerlink" title="灾备"></a>灾备</h4><p>创建 Snapshot：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcdctl snapshot save snapshot.db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>恢复数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcdctl snapshot restore snapshot.db <span class="token punctuation">\</span>
    --name infra2 <span class="token punctuation">\</span>
    --data-dir<span class="token operator">=</span>/tmp/etcd/infra2 <span class="token punctuation">\</span>
    --initial-cluster <span class="token assign-left variable">infra0</span><span class="token operator">=</span>http://127.0.0.1:3380,infra1<span class="token operator">=</span>http://127.0.0.1:4380,infra2<span class="token operator">=</span>http://127.0.0.1:5380 <span class="token punctuation">\</span>
    --initial-cluster-token etcd-cluster-1 <span class="token punctuation">\</span>
    --initial-advertise-peer-urls http://127.0.0.1:5380<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="容量管理"><a href="#容量管理" class="headerlink" title="容量管理"></a>容量管理</h4><ul>
<li>单个对象不建议超过 1.5M</li>
<li>默认容量 2G</li>
<li>不建议超过 8G</li>
</ul>
<h4 id="Alarm-amp-Disarm-Alarm"><a href="#Alarm-amp-Disarm-Alarm" class="headerlink" title="Alarm &amp; Disarm Alarm"></a>Alarm &amp; Disarm Alarm</h4><p>设置 etcd 存储大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcd --quota-backend-bytes<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token variable">))</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>写爆磁盘</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token operator">|</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put key <span class="token operator">||</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 endpoint 状态</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --write-out<span class="token operator">=</span>table endpoint status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 alarm</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl alarm list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>清理碎片</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl defrag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>清理 alarm</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl alarm disarm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="碎片整理"><a href="#碎片整理" class="headerlink" title="碎片整理"></a>碎片整理</h4><p>Keep one hour of history</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcd --auto-compaction-retention<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Compact up to revision 3</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ etcdctl compact <span class="token number">3</span>
$ etcdctl defrag
Finished defragmenting etcd member<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:2379<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="高可用-etcd-解决方案"><a href="#高可用-etcd-解决方案" class="headerlink" title="高可用 etcd 解决方案"></a>高可用 etcd 解决方案</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cncamp/101/tree/master/module5/etcd-ha-demo">https://github.com/cncamp/101/tree/master/module5/etcd-ha-demo</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdOperator.png" alt="EtcdOperator"></p>
<p>etcd operator: coreos 开源的 ，基于 kubernetes CRD 完成 etcd 集群配置。 Archived</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/etcd-operator">https://github.com/coreos/etcd-operator</a></p>
<p>Etcd statefulset Helm chart: Bitnami (powered by vmware )</p>
<p><a target="_blank" rel="noopener" href="https://bitnami.com/stack/etcd/helm">https://bitnami.com/stack/etcd/helm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/bitnami/charts/blob/master/bitnami/etcd">https://github.com/bitnami/charts/blob/master/bitnami/etcd</a></p>
<h4 id="Kubernetes-如何使用-etcd"><a href="#Kubernetes-如何使用-etcd" class="headerlink" title="Kubernetes 如何使用 etcd"></a>Kubernetes 如何使用 etcd</h4><p>etcd 是 kubernetes 的后端存储</p>
<p>对于每一个 kubernetes Object ，都有对应的 storage.go 负责对象的存储操作 <code>pkg/registry/core/pod/storage/storage.go</code></p>
<p>API server 启动脚本中指定 etcd servers 集群</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> etcd
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2379</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>data<span class="token punctuation">-</span>dir=/var/lib/etcd
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>cluster=cadmin=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.key
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2379</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2381</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>name=cadmin
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.key
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>snapshot<span class="token punctuation">-</span>count=10000
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>早期 API server 对 etcd 做简单的 Ping check ，现在已经改为真实的 etcd api call</p>
<h4 id="etcd-在集群中所处的位置"><a href="#etcd-在集群中所处的位置" class="headerlink" title="etcd 在集群中所处的位置"></a>etcd 在集群中所处的位置</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd在集群中所处的位置.png" alt="etcd在集群中所处的位置"></p>
<h4 id="集群的高可用拓扑"><a href="#集群的高可用拓扑" class="headerlink" title="集群的高可用拓扑"></a>集群的高可用拓扑</h4><h5 id="堆叠式-etcd-集群的高可用拓扑"><a href="#堆叠式-etcd-集群的高可用拓扑" class="headerlink" title="堆叠式 etcd 集群的高可用拓扑"></a>堆叠式 etcd 集群的高可用拓扑</h5><p>这种拓扑将相同节点上的控制平面和 etcd 成员耦合在一起。优点在于建立起来非常容易，并且对副本的管理也更容易。但是，堆叠式存在耦合失败的风险。如果一个节点发生故障，则 etcd 成员和控制平面实例都会丢失，并且集群冗余也会受到损害。可以通过添加更多控制平面节点来减轻这种风险。因此为实现集群高可用应该至少运行三个堆叠的 Master 节点。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/堆叠式etcd集群的高可用拓扑.png" alt="堆叠式etcd集群的高可用拓扑"></p>
<h5 id="外部-etcd-集群的高可用拓扑"><a href="#外部-etcd-集群的高可用拓扑" class="headerlink" title="外部 etcd 集群的高可用拓扑"></a>外部 etcd 集群的高可用拓扑</h5><p>该拓扑将控制平面和 etcd 成员解耦。如果丢失一个 Master 节点，对 etcd 成员的影响较小，并且不会像堆叠式拓扑那样对集群冗余产生太大影响。但是，此拓扑所需的主机数量是堆叠式拓扑的两倍。具有此拓扑的群集至少需要三个主机用于控制平面节点，三个主机用于 etcd 集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/外部etcd集群的高可用拓扑.png" alt="外部etcd集群的高可用拓扑"></p>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="etcd-集群高可用"><a href="#etcd-集群高可用" class="headerlink" title="etcd 集群高可用"></a>etcd 集群高可用</h5><p>多少个 peer 最适合？</p>
<ul>
<li>1 个？ 3 个？ 5 个？</li>
<li>保证高可用是首要目标</li>
<li>所有写操作都要经过 leader</li>
<li>peer 多了是否能提升集群并读操作的并发能力？<ul>
<li>apiserver 的配置只连本地的 etcd peer</li>
<li>apiserver 的配置指定所有 etcd peers ，但只有当前连接的 etcd member 异常，apiserver 才会换目标</li>
</ul>
</li>
<li>需要动态 flex up 吗？</li>
</ul>
<p>保证 apiserver 和 etcd 之间的高效性通讯</p>
<ul>
<li>apiserver 和 etcd 部署在同一节点</li>
<li>apiserver 和 etcd 之间的通讯基于 gRPC<ul>
<li>针对每一个 object apiserver 和 etcd 之间的 Connection —&gt; stream 共享</li>
<li>http2 的特性<ul>
<li>Stream quota</li>
<li>带来的问题？对于大规模集群，会造成链路阻塞</li>
<li>10000 个 pod ，一次 list 操作需要返回的数据可能超过 100M</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="etcd-存储规划"><a href="#etcd-存储规划" class="headerlink" title="etcd 存储规划"></a>etcd 存储规划</h5><ul>
<li>本地 vs 远程？<ul>
<li>Remote Storage<ul>
<li>优势是假设永远可用，现实真是如此吗？</li>
<li>劣势是 IO 效率，可能带来的问题？</li>
</ul>
</li>
<li>最佳实践：<ul>
<li>Local SSD</li>
<li>利用 local volume 分配空间</li>
</ul>
</li>
</ul>
</li>
<li>多少空间？<ul>
<li>与集群规模相关</li>
</ul>
</li>
</ul>
<p>思考：为什么每个 member 的 DB size 不一致？</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd各个DB大小不同.png" alt="Etcd各个DB大小不同"></p>
<h5 id="etcd-2"><a href="#etcd-2" class="headerlink" title="etcd"></a>etcd</h5><p>安全性</p>
<ul>
<li>peer 和 peer 之间的通讯加密<ul>
<li>是否有需求<ul>
<li>TLS 的额外开销</li>
<li>运营复杂度增加</li>
</ul>
</li>
</ul>
</li>
<li>数据加密<ul>
<li>是否有需求</li>
<li>Kubernetes 提供了针对 secret 的加密 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</a></li>
</ul>
</li>
</ul>
<p>事件分离</p>
<ul>
<li>对于大规模集群，大量的事件会对 etcd 造成压力</li>
<li>API server 启动脚本中指定 etcd servers 集群</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ks <span class="token builtin class-name">exec</span> -it kube-apiserver-minikube -- kube-apiserver --help
  --etcd-servers-overrides strings
    Per-resource etcd servers overrides, comma separated. The individual override format: group/resource<span class="token comment">#servers, where servers are URLs, semicolon separated. Note that this applies only to resources compiled into this server binary.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如何监控</p>
<h5 id="减少网络延迟"><a href="#减少网络延迟" class="headerlink" title="减少网络延迟"></a>减少网络延迟</h5><ul>
<li>数据中心内的 RTT 大概是数毫秒，国内的典型 RTT 约为 50ms ，两大洲之间的 RTT 可能慢至 400ms 。因此建议 etcd 集群尽量同地域部署。</li>
<li>当客户端到 Leader 的并发连接数量过多，可能会导致其他 Follower 节点发往 Leader 的请求因为网络拥塞而被延迟处理。在 Follower 节点上，可能会看到这样的错误：<ul>
<li>dropped MsgProp to 247ae21ff9436b2d since streamMsg’s sending buffer is full</li>
</ul>
</li>
<li>可以在节点上通过流量控制工具（ Traffic Control ）提高 etcd 成员之间发送数据的优先级来避免。</li>
</ul>
<h5 id="减少磁盘-I-O-延迟"><a href="#减少磁盘-I-O-延迟" class="headerlink" title="减少磁盘 I/O 延迟"></a>减少磁盘 I/O 延迟</h5><p>对于磁盘延迟，典型的旋转磁盘写延迟约为 10 毫秒。对于 SSD Solid State Drives ，固态硬盘），延迟通常低于 1 毫秒。 HDD Hard Disk Drive ，硬盘驱动器）或者网盘在大量数据读写操作的情况下延时会不稳定。因此强烈建议使用 SSD 。</p>
<p>同时为了降低其他应用程序的 I/O 操作对 etcd 的干扰，建议将 etcd 的数据存放在单独的磁盘内。也可以将不同类型的对象存储在不同的若干个 etcd 集群中，比如将频繁变更的 event 对象从主 etcd 集群中分离出来，以保证主集群的高性能。在 APIServer 处这是可以通过参数配置的。这些 etcd 集群最好也分别能有一块单独的存储磁盘。</p>
<p>如果不可避免地， etcd 和其他的业务共享存储磁盘，那么就需要通过下面 ionice 命令对 etcd 服务设置更高的磁盘 I/O 优先级，尽可能避免其他进程的影响。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ionice -c2 -n0 -p <span class="token string">'pgrep etcd'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="保持合理的日志文件大小"><a href="#保持合理的日志文件大小" class="headerlink" title="保持合理的日志文件大小"></a>保持合理的日志文件大小</h5><p>etcd 以日志的形式保存数据，无论是数据创建还是修改，它都将操作追加到日志文件，因此日志文件大小会随着数据修改次数而线性增长。</p>
<p>当 Kubernetes 集群规模较大时，其对 etcd 集群中的数据更改也会很频繁，集群日记文件会迅速增长。</p>
<p>为了有效降低日志文件大小，etcd 会以固定周期创建快照保存系统的当前状态，并移除旧日志文件。另外当修改次数累积到一定的数量（默认是 10000 ，通过参数 “—snapshot-count” 指定）， etcd 也会创建快照文件。</p>
<p>如果 etcd 的内存使用和磁盘使用过高，可以先分析是否数据写入频度过大导致快照频度过高，确认后可通过调低快照触发的阈值来降低其对内存和磁盘的使用。</p>
<h5 id="设置合理的存储配额"><a href="#设置合理的存储配额" class="headerlink" title="设置合理的存储配额"></a>设置合理的存储配额</h5><p>存储空间的配额用于控制 etcd 数据空间的大小。合理的存储配额可保证集群操作的可靠性。如果没有存储配额，也就是 etcd 可以利用整个磁盘空间， etcd 的性能会因为存储空间的持续增长而严重下降，甚至有耗完集群磁盘空间导致不可预测集群行为的风险。如果设置的存储配额太小，一旦其中一个节点的后台数据库的存储空间超出了存储配额， etcd 就会触发集群范围的告警，并将集群置于只接受读和删除请求的维护模式。只有在释放足够的空间、消除后端数据库的碎片和清除存储配额告警之后，集群才能恢复正常操作。</p>
<h5 id="自动压缩历史版本"><a href="#自动压缩历史版本" class="headerlink" title="自动压缩历史版本"></a>自动压缩历史版本</h5><p>etcd 会为每个键都保存了历史版本。为了避免出现性能问题或存储空间消耗完导致写不进去的问题，这些历史版本需要进行周期性地压缩。压缩历史版本就是丢弃该键给定版本之前的所有信息，节省出来的空间可以用于后续的写操作。 etcd 支持自动压缩历史版本。在启动参数中指定参数 “—auto-compaction”，其值以小时为单位。也就是 etcd 会自动压缩该值设置的时间窗口之前的历史版本。</p>
<h5 id="定期消除碎片化"><a href="#定期消除碎片化" class="headerlink" title="定期消除碎片化"></a>定期消除碎片化</h5><p>压缩历史版本，相当于离散地抹去 etcd 存储空间某些数据， etcd 存储空间中将会出现碎片。这些碎片无法被后台存储使用，却仍占据节点的存储空间。因此定期消除存储碎片，将释放碎片化的存储空间，重新调整整个存储空间。</p>
<h5 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h5><ul>
<li>备份方案<ul>
<li>etcd 备份：备份完整的集群信息，灾难恢复<ul>
<li>etcdctl snapshot save</li>
</ul>
</li>
<li>备份 Kubernetes event</li>
</ul>
</li>
<li>频度？<ul>
<li>时间间隔太长：<ul>
<li>能否接受 user data lost</li>
<li>如果有外部资源配置，如负载均衡等，能否接受数据丢失导致的 leak</li>
</ul>
</li>
<li>时间间隔太短：<ul>
<li>对 etcd 的影响<ul>
<li>做 snapshot 的时候， etcd 会锁住当前数据</li>
<li>并发的写操作需要开辟新的空间进行增量写，导致磁盘空间增长</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>如何保证备份的时效性，同时防止磁盘爆掉？<ul>
<li>Auto defrag</li>
</ul>
</li>
</ul>
<h5 id="优化运行参数"><a href="#优化运行参数" class="headerlink" title="优化运行参数"></a>优化运行参数</h5><p>当网络延迟和磁盘延迟固定的情况下，可以优化 etcd 运行参数来提升集群的工作效率。 etcd 基于 Raft 协议进行 Leader 选举，当 Leader 选定以后才能开始数据读写操作，因此频繁的 Leader 选举会导致数据读写性能显著降低。可以通过调整心跳周期（ Heatbeat Interval ）和选举超时时间 Election Timeout ），来降低 Leader 选举的可能性。</p>
<p>心跳周期是控制 Leader 以何种频度向 Follower 发起心跳通知。心跳通知除表明 Leader 活跃状态之外，还带有待写入数据信息， Follower 依据心跳信息进行数据写入，默认心跳周期是 100ms 。选举超时时间定义了当 Follower 多久没有收到 Leader 心跳，则重新发起选举，该参数的默认设置是 1000ms 。</p>
<p>如果 etcd 集群的不同实例部署在延迟较低的相同数据中心，通常使用默认配置即可。如果不同实例部署在多数据中心或者网络延迟较高的集群环境，则需要对心跳周期和选举超时时间进行调整。建议心跳周期参数推荐设置为接近 etcd 多个成员之间平均数据往返周期的最大值，一般是平均 RTT 的 0.55 - 1.5 倍。如果心跳周期设置得过低， etcd 会发送很多不必要的心跳信息，从而增加 CPU 和网络的负担。如果设置得过高，则会导致选举频繁超时。选举超时时间也需要根据 etcd 成员之间的平均 RTT 时间来设置。选举超时时间最少设置为 etcd 成员之间 RTT 时间的 10 倍，以便对网络波动。</p>
<p>心跳间隔和选举超时时间的值必须对同一个 etcd 集群的所有节点都生效，如果各个节点配置不同，就会导致集群成员之间协商结果不可预知而不稳定。</p>
<h5 id="etcd-备份存储"><a href="#etcd-备份存储" class="headerlink" title="etcd 备份存储"></a>etcd 备份存储</h5><p>etcd 的默认工作目录下会生成两个子目录： wal 和 snap 。 wal 是用于存放预写式日志，其最大的作用是记录整个数据变化的全部历程。所有数据的修改在提交前，都要先写入 wal 中。</p>
<p>snap 是用于存放快照数据。为防止 wal 文件过多， etcd 会定期（当 wal 中数据超过 10000 条记录时，由参数 “—snapshot-count” 设置）创建快照。当快照生成后 wal 中数据就可以被删除了。</p>
<p>如果数据遭到破坏或错误修改需要回滚到之前某个状态时，方法就有两个：一是从快照中恢复数据主体，但是未被拍入快照的数据会丢失；而是执行所有 WAL 中记录的修改操作，从最原始的数据恢复到数据损坏之前的状态，但恢复的时间较长。</p>
<h5 id="备份方案实践"><a href="#备份方案实践" class="headerlink" title="备份方案实践"></a>备份方案实践</h5><p>官方推荐 etcd 集群的备份方式是定期创建快照。和 etcd 内部定期创建快照的目的不同，该备份方式依赖外部程序定期创建快照，并将快照上传到网络存储设备以实现 etcd 数据的冗余备份。上传到网络设备的数据，都应进行了加密。即使当所有 etcd 实例都丢失了数据，也能允许 etcd 集群从一个已知的良好状态的时间点在任一地方进行恢复。根据集群对 etcd 备份粒度的要求，可适当调节备份的周期。在生产环境中实测，拍摄快照通常会影响集群当时的性能，因此不建议频繁创建快照。但是备份周期太长，就可能导致大量数据的丢失。</p>
<p>这里可以使用增量备份的方式。如图所示，备份程序每 30 分钟触发一次快照的拍摄。紧接着它从快照结束的版本（ Revision ）开始，监听 etcd 集群的事件，并每 10 秒钟将事件保存到文件中，并将快照和事件文件上传到网络存储设备中。 30 分钟的快照周期对集群性能影响甚微。当大灾难来临时，也至多丢失 10 秒的数据。至于数据修复，首先把数据从网络存储设备中下载下来，然后从快照中恢复大块数据，并在此基础上依次应用存储的所有事件。这样就可以将集群数据恢复到灾难发生前。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd备份方案实践.png" alt="Etcd备份方案实践"></p>
<h5 id="ResourceVersion"><a href="#ResourceVersion" class="headerlink" title="ResourceVersion"></a>ResourceVersion</h5><ul>
<li>单个对象的 resourceVersion<ul>
<li>对象的最后修改 resourceVersion</li>
</ul>
</li>
<li>List 对象的 resourceVersion<ul>
<li>生成 list response 时的 resourceVersion</li>
</ul>
</li>
<li>List 行为<ul>
<li>List 对象时，如果不加 resourceVersion ，意味着需要 Most Recent 数据，请求会击穿 APIServer 缓存，直接发送至 etcd</li>
</ul>
</li>
<li>APIServer 通过 Label 过滤对象查询时，过滤动作是在 APIServer 端， APIServer 需要向 etcd 发起全量查询请求</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ResourceVersion.png" alt="ResourceVersion"></p>
<h5 id="遭遇到的陷阱"><a href="#遭遇到的陷阱" class="headerlink" title="遭遇到的陷阱"></a>遭遇到的陷阱</h5><ul>
<li>频繁的 leader election</li>
<li>etcd 分裂</li>
<li>etcd 不响应</li>
<li>与 apiserver 之间的链路阻塞</li>
<li>磁盘暴涨</li>
</ul>
<h2 id="Kubernetes-控制平面组件-API-Server"><a href="#Kubernetes-控制平面组件-API-Server" class="headerlink" title="Kubernetes 控制平面组件 API Server"></a>Kubernetes 控制平面组件 API Server</h2><h3 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h3><p>kube-apiserver 是 Kubernetes 最重要的核心组件之一，主要提供以下的功能：</p>
<ul>
<li>提供集群管理的 REST API 接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的枢纽（其他模块通过 API Server 查询或修改数据，只有 API Server 才直接操作 etcd）</li>
</ul>
<h4 id="访问控制概览"><a href="#访问控制概览" class="headerlink" title="访问控制概览"></a>访问控制概览</h4><p>Kubernetes API的每个请求都会经过多阶段的访问控制之后才会被接受，这包括认证、授权以及准入控制（Admission Control）等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer访问控制概览.png" alt="APIServer访问控制概览"></p>
<h4 id="访问控制细节"><a href="#访问控制细节" class="headerlink" title="访问控制细节"></a>访问控制细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer访问控制细节.png" alt="APIServer访问控制细节"></p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>开启 TLS 时，所有的请求都需要首先认证。Kubernetes 支持多种认证机制，并支持同时开启多个认证插件（只要有一个认证通过即可）。如果认证成功，则用户的 username 会传入授权模块做进一步授权验证；而对于认证失败的请求则返回 HTTP 401。</p>
<h4 id="认证插件"><a href="#认证插件" class="headerlink" title="认证插件"></a>认证插件</h4><ul>
<li>X509证书<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module6/basic-auth/x509.MD">https://github.com/kibaamor/101/blob/master/module6/basic-auth/x509.MD</a></li>
<li>使用 X509 客户端证书只需要 API Server 启动时配置 <code>--client-ca-file=SOMEFILE</code>。在证书认证时，其 CN 域用作用户名，而组织机构域则用作 group 名。</li>
</ul>
</li>
<li>静态Token文件<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/basic-auth">https://github.com/kibaamor/101/tree/master/module6/basic-auth</a></li>
<li>使用静态 Token 文件认证只需要 API Server 启动时配置 <code>--token-auth-file=SOMEFILE</code>。</li>
<li>该文件为csv格式，每行至少包括三列 token,username,user id，<ul>
<li>token,user,uid,”group1,group2,group3”</li>
</ul>
</li>
</ul>
</li>
<li>引导Token<ul>
<li>为了支持平滑地启动引导新的集群，Kubernetes 包含了一种动态管理的持有者令牌类型， 称作启动引导令牌（Bootstrap Token）。</li>
<li>这些令牌以 Secret 的形式保存在 kube-system 名字空间中，可以被动态管理和创建。</li>
<li>控制器管理器包含的 TokenCleaner 控制器能够在启动引导令牌过期时将其删除。</li>
<li>在使用 kubeadm 部署 Kubernetes 时，可通过 kubeadm token list 命令查询。</li>
</ul>
</li>
<li>静态密码文件<ul>
<li>需要 API Server 启动时配置 <code>--basic-auth-file=SOMEFILE</code>，文件格式为 csv，每行至少三列 password, user, uid，后面是可选的 group 名<ul>
<li>password,user,uid,”group1,group2,group3”</li>
</ul>
</li>
</ul>
</li>
<li>ServiceAccount<ul>
<li>ServiceAccount 是 Kubernetes 自动生成的，并会自动挂载到容器的 <code>/run/secrets/kubernetes.io/serviceaccount</code> 目录中。</li>
</ul>
</li>
<li>OpenID<ul>
<li>OAuth 2.0的认证机制</li>
</ul>
</li>
<li>Webhook 令牌身份认证<ul>
<li>—authentication-token-webhook-config-file 指向一个配置文件，其中描述如何访问远程的Webhook 服务。</li>
<li>—authentication-token-webhook-cache-ttl 用来设定身份认证决定的缓存时间。默认时长为2 分钟。</li>
</ul>
</li>
<li>匿名请求<ul>
<li>如果使用 AlwaysAllow 以外的认证模式，则匿名请求默认开启，但可用 <code>--anonymous-auth=false</code> 禁止匿名请求。</li>
</ul>
</li>
</ul>
<h3 id="基于webhook的认证服务集成"><a href="#基于webhook的认证服务集成" class="headerlink" title="基于webhook的认证服务集成"></a>基于webhook的认证服务集成</h3><h4 id="构建符合Kubernetes规范的认证服务"><a href="#构建符合Kubernetes规范的认证服务" class="headerlink" title="构建符合Kubernetes规范的认证服务"></a>构建符合Kubernetes规范的认证服务</h4><p>需要依照 Kubernetes 规范，构建认证服务，用来认证 tokenreview request</p>
<p>构建认证服务需要满足如下Kubernetes的规范</p>
<p>URL： <a target="_blank" rel="noopener" href="https://authn.example.com/authenticate">https://authn.example.com/authenticate</a></p>
<p>Method： POST</p>
<p>Input:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
  <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"(BEARERTOKEN)"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Output:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"authenticated"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"janedoe@example.com"</span><span class="token punctuation">,</span>
      <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"42"</span><span class="token punctuation">,</span>
      <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"developers"</span><span class="token punctuation">,</span>
        <span class="token string">"qa"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="开发认证服务"><a href="#开发认证服务" class="headerlink" title="开发认证服务"></a>开发认证服务</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/authn-webhook">https://github.com/kibaamor/101/tree/master/module6/authn-webhook</a></p>
<p>解码认证请求</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">decoder <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token keyword">var</span> tr authentication<span class="token punctuation">.</span>TokenReview
err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Error]"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
    json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
        <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
            Authenticated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转发认证请求至认证服务器</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Check User</span>
ts <span class="token operator">:=</span> oauth2<span class="token punctuation">.</span><span class="token function">StaticTokenSource</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">{</span>AccessToken<span class="token punctuation">:</span> tr<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Token<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
tc <span class="token operator">:=</span> oauth2<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span>
client <span class="token operator">:=</span> github<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>tc<span class="token punctuation">)</span>
user<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Error]"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
    json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
        <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
            Authenticated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>认证结果返回给 API Server</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">)</span>
trs <span class="token operator">:=</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
    Authenticated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    User<span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>UserInfo<span class="token punctuation">{</span>
        Username<span class="token punctuation">:</span> <span class="token operator">*</span>user<span class="token punctuation">.</span>Login<span class="token punctuation">,</span>
        UID<span class="token punctuation">:</span>      <span class="token operator">*</span>user<span class="token punctuation">.</span>Login<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
    <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span>     trs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置认证服务"><a href="#配置认证服务" class="headerlink" title="配置认证服务"></a>配置认证服务</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Config"</span><span class="token punctuation">,</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
  <span class="token property">"preferences"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"clusters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"github-authn"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"http://192.168.34.2:3000/authenticate"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"users"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"authn-apiserver"</span><span class="token punctuation">,</span>
      <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"secret"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"contexts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"webhook"</span><span class="token punctuation">,</span>
      <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"github-authn"</span><span class="token punctuation">,</span>
        <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"authn-apiserver"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"current-context"</span><span class="token operator">:</span> <span class="token string">"webhook"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置-apiserver"><a href="#配置-apiserver" class="headerlink" title="配置 apiserver"></a>配置 apiserver</h4><p>可以是任何认证系统</p>
<ul>
<li>但在用户认证完成后，生成代表用户身份的 token</li>
<li>该 token 通常是有失效时间的</li>
<li>用户获取该 token 以后以后，将token配置进 kubeconfig</li>
</ul>
<p>修改 apiserver 设置，开启认证服务，apiserver 保证将所有收到的请求中的 token 信息，发给认证服务进行验证</p>
<pre><code>- --authentication-token-webhook-config-file，该文件描述如何访问认证服务
- --authentication-token-webhook-cache-ttl，默认 2 分钟
</code></pre><p>配置文件需要mount进Pod</p>
<p>配置文件中的服务器地址需要指向 authService</p>
<h4 id="生产系统中遇到的陷阱"><a href="#生产系统中遇到的陷阱" class="headerlink" title="生产系统中遇到的陷阱"></a>生产系统中遇到的陷阱</h4><p>基于 Keystone 的认证插件导致 Keystone 故障且无法恢复</p>
<p>Keystone 是企业关键服务</p>
<p>Kubernetes 以 Keystone 作为认证插件</p>
<p>Keystone 在出现故障后会抛出 401 错误</p>
<p>Kubernetes 发现 401 错误后会尝试重新认证</p>
<p>大多数 controller 都有指数级 back off，重试间隔越来越慢</p>
<p>但 gophercloud 针对过期 token 会一直 retry</p>
<p>大量的 request 积压在 Keystone 导致服务无法恢复</p>
<p>Kubernetes 成为压死企业认证服务的最后一根稻草</p>
<p>解决方案？</p>
<ul>
<li>Circuit break</li>
<li>Rate limit</li>
</ul>
<h3 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h3><h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>授权主要是用于对集群资源的访问控制，通过检查请求包含的相关属性值，与相对应的访问策略相比较，API 请求必须满足某些策略才能被处理。跟认证类似，Kubernetes 也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；对于授权失败的请求则返回 HTTP 403。</p>
<p>Kubernetes 授权仅处理以下的请求属性：</p>
<ul>
<li>user, group, extra</li>
<li>API、请求方法（如 get、post、update、patch 和 delete）和请求路径（如 /api）</li>
<li>请求资源和子资源</li>
<li>Namespace</li>
<li>API Group</li>
</ul>
<p>目前，Kubernetes 支持以下授权插件：</p>
<ul>
<li>ABAC</li>
<li>RBAC</li>
<li>Webhook</li>
<li>Node</li>
</ul>
<h4 id="RBAC-vs-ABAC"><a href="#RBAC-vs-ABAC" class="headerlink" title="RBAC vs ABAC"></a>RBAC vs ABAC</h4><p>ABAC（Attribute Based Access Control）本来是不错的概念，但是在 Kubernetes 中的实现比较难于管理和理解，而且需要对 Master 所在节点的 SSH 和文件系统权限，要使得对授权的变更成功生效，还需要重新启动 API Server。</p>
<p>而 RBAC 的授权策略可以利用 kubectl 或者 Kubernetes API 直接进行配置。RBAC 可以授权给用户，让用户有权进行授权管理，这样就可以无需接触节点，直接进行授权管理。RBAC 在 Kubernetes 中被映射为 API 资源和操作。</p>
<h4 id="RBAC-老图"><a href="#RBAC-老图" class="headerlink" title="RBAC 老图"></a>RBAC 老图</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RBAC老图.png" alt="RBAC老图"></p>
<h4 id="RBAC-新解"><a href="#RBAC-新解" class="headerlink" title="RBAC 新解"></a>RBAC 新解</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RBAC新解.png" alt="RBAC新解"></p>
<h4 id="Role-与-ClusterRole"><a href="#Role-与-ClusterRole" class="headerlink" title="Role 与 ClusterRole"></a>Role 与 ClusterRole</h4><p>Role（角色）是一系列权限的集合，例如一个角色可以包含读取 Pod 的权限和列出 Pod 的权限。</p>
<p>Role 只能用来给某个特定 namespace 中的资源作鉴权，对多 namespace 和集群级的资源或者是非资源类的 API（如/healthz）使用 ClusterRole。</p>
<blockquote>
<p>sub resource 可以单独控制权限（比如健康检查只能更新 status，不能更新 spec）</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Role示例</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span> <span class="token comment"># "" indicates the core API group</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span><span class="token punctuation">---</span>

<span class="token comment"># ClusterRole示例</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token comment"># "namespace" omitted since ClusterRoles are not namespaced</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>binding</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># RoleBinding示例（引用ClusterRole）</span>
<span class="token comment"># This role binding allows "dave" to read secrets in the "development"</span>
namespace.
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> development <span class="token comment"># This only grants permissions within the "development" namespace.</span>
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dave
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RoleBinding.png" alt="RoleBinding"></p>
<h4 id="账户／组的管理"><a href="#账户／组的管理" class="headerlink" title="账户／组的管理"></a>账户／组的管理</h4><p>角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。</p>
<p>它包含若干主体（用户、组或服务账户）的列表和对这些主体所获得的角色的引用。</p>
<p>组的概念：</p>
<ul>
<li>当与外部认证系统对接时，用户信息（UserInfo）可包含 Group 信息，授权可针对用户群组</li>
<li>当对 ServiceAccount 授权时，Group 代表某个 Namespace 下的所有 ServiceAccount</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/账户组的管理.png" alt="账户组的管理"></p>
<h4 id="针对群租授权"><a href="#针对群租授权" class="headerlink" title="针对群租授权"></a>针对群租授权</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets<span class="token punctuation">-</span>global
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> manager <span class="token comment"># 'name' 是区分大小写的</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io

<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets<span class="token punctuation">-</span>global
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>serviceaccounts<span class="token punctuation">:</span>qa
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="规划系统角色"><a href="#规划系统角色" class="headerlink" title="规划系统角色"></a>规划系统角色</h4><p>User</p>
<ul>
<li>管理员<ul>
<li>所有资源的所有权限？？</li>
</ul>
</li>
<li>普通用户<ul>
<li>是否有该用户创建的 namespace 下的所有 object 的操作权限？</li>
<li>对其他用户的 namespace 资源是否可读，是否可写？</li>
</ul>
</li>
</ul>
<p>SystemAccount</p>
<ul>
<li>SystemAccount 是开发者（kubernetes developer 或者 domain developer）创建应用后，应用于 apiserver 通讯需要的身份</li>
<li>用户可以创建自定的 ServiceAccount，kubernetes 也为每个 namespace 创建 default ServiceAccount</li>
<li>Default ServiceAccount 通常需要给定权限以后才能对 apiserver 做写操作</li>
</ul>
<h4 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h4><p>在 cluster 创建时，创建自定义的 clusterrole，比如 namespace-creator</p>
<p>Namespace-creator role 定义用户可操作的对象和对应的读写操作。</p>
<p>创建自定义的 namespace admission controller</p>
<ul>
<li>当 namespace 创建请求被处理时，获取当前用户信息并 annotate 到 namespace</li>
</ul>
<p>创建 RBAC controller</p>
<ul>
<li>Watch namespace 的创建事件</li>
<li>获取当前 namespace 的创建者信息</li>
<li>在当前 namespace 创建 rolebinding 对象，并将 namespace-creator 角色和用户绑定</li>
</ul>
<h4 id="与权限相关的其他最佳实践"><a href="#与权限相关的其他最佳实践" class="headerlink" title="与权限相关的其他最佳实践"></a>与权限相关的其他最佳实践</h4><p>ClusterRole 是非 namespace 绑定的，针对整个集群生效</p>
<p>通常需要创建一个管理员角色，并且绑定给开发运营团队成员</p>
<p>ThirdPartyResource 和 CustomResourceDefinition 是全局资源，普通用户创建 ThirdPartyResource 以后，需要管理员授予相应权限后才能真正操作该对象</p>
<p>针对所有的角色管理，建议创建 spec，用源代码驱动</p>
<blockquote>
<p>虽然可以通过edit操作来修改权限，但后期会导致权限管理混乱，可能会有很多临时创建出来的角色和角色绑定对象，重复绑定某一个资源权限</p>
</blockquote>
<p>权限是可以传递的，用户 A 可以将其对某对象的某操作，抽取成一个权限，并赋给用户 B</p>
<p>防止海量的角色和角色绑定对象，因为大量的对象会导致鉴权效率低，同时给 apiserver 增加负担<br>ServiceAccount 也需要授权的，否则你的 component 可能无法操作某对象</p>
<p>Tips：SSH 到 master 节点通过 insecure port 访问 apiserver 可绕过鉴权，当需要做管理操作又没有权限时可以使用（不推荐）</p>
<h4 id="运营过程中出现的陷阱"><a href="#运营过程中出现的陷阱" class="headerlink" title="运营过程中出现的陷阱"></a>运营过程中出现的陷阱</h4><p>案例1:</p>
<ul>
<li>研发人员为提高系统效率，将 update 方法修改为 patch</li>
<li>研发人员本地非安全测试环境测试通过</li>
<li>上生产，发现不 work</li>
<li>原因：忘记更新 rolebinding，对应的 serviceaccount 没有 patch 权限</li>
</ul>
<p>案例2:</p>
<ul>
<li>研发人员创建 CRD，并针对该 CRD 编程</li>
<li>上生产后不工作</li>
<li>原因，该 CRD 未授权，对应的组件 get 不到对应的 CRD 资源</li>
</ul>
<h3 id="准入"><a href="#准入" class="headerlink" title="准入"></a>准入</h3><h4 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h4><p>为资源增加自定义属性</p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在 namespace 的准入控制中，获取用户信息，并将用户信息更新的 namespace 的 annotation</li>
</ul>
<p>只有当 namespace 中有有效用户信息时，我们才可以在 namespace 创建时，自动绑定用户权限，namespace 才可用。</p>
<p>准入控制（Admission Control）在授权后对请求做进一步的验证或添加默认参数。不同于授权和认证只关心请求的用户和操作，准入控制还处理请求的内容，并且仅对创建、更新、删除或连接（如代理）等有效，而对读操作无效。</p>
<p>准入控制支持同时开启多个插件，它们依次调用，只有全部插件都通过的请求才可以放过进入系统。</p>
<h4 id="准入控制插件"><a href="#准入控制插件" class="headerlink" title="准入控制插件"></a>准入控制插件</h4><ul>
<li>AlwaysAdmit: 接受所有请求。</li>
<li>AlwaysPullImages: 总是拉取最新镜像。在多租户场景下非常有用。</li>
<li>DenyEscalatingExec: 禁止特权容器的 exec 和 attach 操作。</li>
<li>ImagePolicyWebhook: 通过 webhook 决定 image 策略，需要同时配置 <code>--admission-controlconfig-file</code></li>
<li>ServiceAccount：自动创建默认 ServiceAccount，并确保 Pod 引用的 ServiceAccount 已经存在</li>
<li>SecurityContextDeny：拒绝包含非法 SecurityContext 配置的容器</li>
<li>ResourceQuota：限制 Pod 的请求不会超过配额，需要在 namespace 中创建一个 ResourceQuota 对象</li>
<li>LimitRanger：为 Pod 设置默认资源请求和限制，需要在 namespac 中创建一个 LimitRange 对象</li>
<li>InitialResources：根据镜像的历史使用记录，为容器设置默认资源请求和限制</li>
<li>NamespaceLifecycle：确保处于 termination 状态的 namespace 不再接收新的对象创建请求，并拒绝请求不存在的 namespace</li>
<li>DefaultStorageClass：为 PVC 设置默认 StorageClass</li>
<li>DefaultTolerationSeconds：设置 Pod 的默认 forgiveness toleration 为 5 分钟</li>
<li>PodSecurityPolicy：使用 Pod Security Policies 时必须开启</li>
<li>NodeRestriction：限制 kubelet 仅可访问 node、endpoint、pod、service 以及 secret、configmap、PV 和PVC 等相关的资源</li>
</ul>
<h4 id="准入控制插件的开发"><a href="#准入控制插件的开发" class="headerlink" title="准入控制插件的开发"></a>准入控制插件的开发</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module6/mutatingwebhook/readme.MD">https://github.com/kibaamor/101/blob/master/module6/mutatingwebhook/readme.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/admission-controller-webhook-demo">https://github.com/kibaamor/admission-controller-webhook-demo</a></p>
<h5 id="准入控制插件-1"><a href="#准入控制插件-1" class="headerlink" title="准入控制插件"></a>准入控制插件</h5><p>除默认的准入控制插件以外，Kubernetes 预留了准入控制插件的扩展点，用户可自定义准入控制插件实现自定义准入功能</p>
<ul>
<li>MutatingWebhookConfiguration：变形插件，支持对准入对象的修改</li>
<li>ValidatingWebhookConfiguration：校验插件，只能对准入对象合法性进行校验，不能修改</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/准入控制插件.png" alt="准入控制插件"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># {{if eq .k8snode_validating "enabled"}}</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> admissionregistration.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MutatingWebhookConfiguration
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>mutating.webhook.k8s.io
<span class="token key atrule">webhooks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">clientConfig</span><span class="token punctuation">:</span>
  <span class="token key atrule">caBundle</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>.serverca_base64<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//admission.local.tess.io/apis/admission.k8s.io/v1alpha1/ns<span class="token punctuation">-</span>mutating
  <span class="token key atrule">failurePolicy</span><span class="token punctuation">:</span> Fail
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>mutating.webhook.k8s.io
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">""</span>
    <span class="token key atrule">apiVersions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'*'</span>
    <span class="token key atrule">operations</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> CREATE
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> nodes
  <span class="token key atrule">sideEffects</span><span class="token punctuation">:</span> Unknown
<span class="token comment"># {{end}}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配额管理"><a href="#配额管理" class="headerlink" title="配额管理"></a>配额管理</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/quota">https://github.com/kibaamor/101/tree/master/module6/quota</a></p>
<p>配额管理</p>
<ul>
<li>原因：资源有限，如何限定某个用户有多少资源？<br>方案：</li>
<li>预定义每个 Namespace 的 ResourceQuota，并把 spec 保存为 configmap<ul>
<li>用户可以创建多少个 Pod<ul>
<li>BestEffortPod</li>
<li>QoSPod</li>
</ul>
</li>
<li>用户可以创建多少个 service</li>
<li>用户可以创建多少个 ingress</li>
<li>用户可以创建多少个 service VIP</li>
</ul>
</li>
<li>创建 ResourceQuota Controller<ul>
<li>监控 namespace 创建事件，当 namespace 创建时，在该 namespace 创建对应的 ResourceQuota 对象</li>
</ul>
</li>
<li>apiserver 中开启 ResourceQuota 的 admission plugin</li>
</ul>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><h4 id="计数器固定窗口算法"><a href="#计数器固定窗口算法" class="headerlink" title="计数器固定窗口算法"></a>计数器固定窗口算法</h4><p>原理就是对一段固定时间窗口内的请求进行计数，如果请求数超过了阈值，则舍弃该请求；</p>
<p>如果没有达到设定的阈值，则接受该请求，且计数加 1 。</p>
<p>当时间窗口结束时，重置计数器为 0 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/计数器固定窗口算法.png" alt="计数器固定窗口算法"></p>
<h4 id="计数器滑动窗口算法"><a href="#计数器滑动窗口算法" class="headerlink" title="计数器滑动窗口算法"></a>计数器滑动窗口算法</h4><p>在固定窗口的基础上，将一个计时窗口分成了若干个小窗口，然后每个小窗口维护一个独立的计数器。</p>
<p>当请求的时间大于当前窗口的最大时间时，则将计时窗口向前平移一个小窗口。</p>
<p>平移时，将第一个小窗口的数据丢弃，然后将第二个小窗口设置为第一个小窗口，同时在最后面新增一个小窗口，将新的请求放在新增的小窗口中。</p>
<p>同时要保证整个窗口中所有小窗口的请求数目之后不能超过设定的阈值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/计数器滑动窗口算法.png" alt="计数器滑动窗口算法"></p>
<h4 id="漏斗算法"><a href="#漏斗算法" class="headerlink" title="漏斗算法"></a>漏斗算法</h4><p>漏斗算法的原理也很容易理解。请求来了之后会首先进到漏斗里，然后漏斗以恒定的速率将请求流出进行处理，从而起到平滑流量的作用。</p>
<p>当请求的流量过大时，漏斗达到最大容量时会溢出，此时请求被丢弃。</p>
<p>在系统看来，请求永远是以平滑的传输速率过来，从而起到了保护系统的作用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/漏斗算法.png" alt="漏斗算法"></p>
<h4 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h4><p>令牌桶算法是对漏斗算法的一种改进，除了能够起到限流的作用外，还允许一定程度的流量突发。</p>
<p>在令牌桶算法中，存在一个令牌桶，算法中存在一种机制以恒定的速率向令牌桶中放入令牌。</p>
<p>令牌桶也有一定的容量，如果满了令牌就无法放进去了。<br>当请求来时，会首先到令牌桶中去拿令牌，如果拿到了令牌，则该请求会被处理，并消耗掉拿到的令牌；</p>
<p>如果令牌桶为空，则该请求会被丢弃。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/令牌桶算法.png" alt="令牌桶算法.png"></p>
<h4 id="API-Server-中的限流"><a href="#API-Server-中的限流" class="headerlink" title="API Server 中的限流"></a>API Server 中的限流</h4><p>max-requests-inflight： 在给定时间内的最大 non-mutating 请求数<br>max-mutating-requests-inflight： 在给定时间内的最大 mutating 请求数，调整 apiserver 的流控 qos</p>
<p>代码 <code>staging/src/k8s.io/apiserver/pkg/server/filters/maxinflight.go:WithMaxInFlightLimit()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer中的限流.png" alt="APIServer中的限流"></p>
<h4 id="传统限流方法的局限性"><a href="#传统限流方法的局限性" class="headerlink" title="传统限流方法的局限性"></a>传统限流方法的局限性</h4><ul>
<li>粒度粗<ul>
<li>无法为不同用户，不同场景设置不通的限流</li>
</ul>
</li>
<li>单队列<ul>
<li>共享限流窗口/桶，一个坏用户可能会将整个系统堵塞，其他正常用户的请求无法被及时处理</li>
</ul>
</li>
<li>不公平<ul>
<li>正常用户的请求会被排到队尾，无法及时处理而饿死</li>
</ul>
</li>
<li>无优先级<ul>
<li>重要的系统指令一并被限流，系统故障难以恢复</li>
</ul>
</li>
</ul>
<h4 id="API-Priority-and-Fairness"><a href="#API-Priority-and-Fairness" class="headerlink" title="API Priority and Fairness"></a>API Priority and Fairness</h4><p>APF 以更细粒度的方式对请求进行分类和隔离。</p>
<ul>
<li>它还引入了空间有限的排队机制，因此在非常短暂的突发情况下，API 服务器不会拒绝任何请求。</li>
<li>通过使用公平排队技术从队列中分发请求，这样， 一个行为不佳的控制器就不会饿死其他控制器（即使优先级相同）。</li>
<li><p>APF的核心</p>
<ul>
<li>多等级</li>
<li>多队列</li>
</ul>
</li>
<li><p>APF 的实现依赖两个非常重要的资源 FlowSchema, PriorityLevelConfiguration</p>
</li>
<li>APF 对请求进行更细粒度的分类，每一个请求分类对应一个 FlowSchema (FS)</li>
<li>FS 内的请求又会根据 distinguisher 进一步划分为不同的 Flow.</li>
<li>FS 会设置一个优先级(Priority Level, PL)，不同优先级的并发资源是隔离的。所以不同优先级的资源不会相互排挤。特定优先级的请求可以被高优处理。</li>
<li>一个 PL 可以对应多个 FS，PL 中维护了一个 QueueSet，用于缓存不能及时处理的请求，请求不会因为超出 PL 的并发限制而被丢弃。</li>
<li>FS 中的每个 Flow 通过 shuffle sharding 算法从 QueueSet 选取特定的 queues 缓存请求。</li>
<li>每次从 QueueSet 中取请求执行时，会先应用 fair queuing 算法从 QueueSet 中选中一个 queue，然后从这个 queue 中取出 oldest 请求执行。所以即使是同一个 PL 内的请求，也不会出现一个 Flow 内的请求一直占用资源的不公平现象。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIPriorityAndFairness.png" alt="APIPriorityAndFairness"></p>
<h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><ul>
<li>传入的请求通过FlowSchema 按照其属性分类，并分配优先级。</li>
<li>每个优先级维护自定义的并发限制，加强了隔离度，这样不同优先级的请求，就不会相互饿死。</li>
<li>在同一个优先级内，公平排队算法可以防止来自不同flow 的请求相互饿死。</li>
<li>该算法将请求排队，通过排队机制，防止在平均负载较低时，通信量突增而导致请求失败。</li>
</ul>
<h5 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h5><ul>
<li>如果未启用 APF，API 服务器中的整体并发量将受到 kube-apiserver 的参数 <code>--maxrequests-inflight</code> 和 <code>--max-mutating-requests-inflight</code> 的限制。</li>
<li>启用 APF 后，将对这些参数定义的并发限制进行求和，然后将总和分配到一组可配置的优先级中。每个传入的请求都会分配一个优先级；</li>
<li>每个优先级都有各自的配置，设定允许分发的并发请求数。</li>
<li>例如，默认配置包括针对领导者选举请求、内置控制器请求和 Pod 请求都单独设置优先级。这表示即使异常的 Pod 向 API 服务器发送大量请求，也无法阻止领导者选举或内置控制器的操作执行成功。</li>
</ul>
<h5 id="排队"><a href="#排队" class="headerlink" title="排队"></a>排队</h5><ul>
<li>即使在同一优先级内，也可能存在大量不同的流量源。</li>
<li>在过载情况下，防止一个请求流饿死其他流是非常有价值的（尤其是在一个较为常见的场景中，一个有故障的客户端会疯狂地向 kube-apiserver 发送请求， 理想情况下，这个有故障的客户端不应对其他客户端产生太大的影响）。</li>
<li>公平排队算法在处理具有相同优先级的请求时，实现了上述场景。</li>
<li>每个请求都被分配到某个流中，该流由对应的 FlowSchema 的名字加上一个流区分项（Flow Distinguisher）来标识。</li>
<li>这里的流区分项可以是发出请求的用户、目标资源的名称空间或什么都不是。</li>
<li>系统尝试为不同流中具有相同优先级的请求赋予近似相等的权重。</li>
<li>将请求划分到流中之后，APF 功能将请求分配到队列中。</li>
<li>分配时使用一种称为混洗分片（Shuffle-Sharding） 的技术。该技术可以相对有效地利用队列隔离低强度流与高强度流。</li>
<li>排队算法的细节可针对每个优先等级进行调整，并允许管理员在内存占用、公平性（当总流量超标时，各个独立的流将都会取得进展）、突发流量的容忍度以及排队引发的额外延迟之间进行权衡。</li>
</ul>
<h5 id="豁免请求"><a href="#豁免请求" class="headerlink" title="豁免请求"></a>豁免请求</h5><p>某些特别重要的请求不受制于此特性施加的任何限制。这些豁免可防止不当的流控配置完全禁用 API 服务器。</p>
<h5 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h5><ul>
<li>system<ul>
<li>用于 system:nodes 组（即 kubelets）的请求； kubelets 必须能连上API 服务器，以便工作负载能够调度到其上。</li>
</ul>
</li>
<li>leader-election<ul>
<li>用于内置控制器的领导选举的请求（特别是来自 kube-system 名称空间中 system:kubecontroller-manager 和 system:kube-scheduler 用户和服务账号，针对 endpoints、configmaps 或leases 的请求）。</li>
<li>将这些请求与其他流量相隔离非常重要，因为领导者选举失败会导致控制器发生故障并重新启动，这反过来会导致新启动的控制器在同步信息时，流量开销更大。</li>
</ul>
</li>
<li>workload-high<ul>
<li>优先级用于内置控制器的请求。</li>
</ul>
</li>
<li>workload-low<ul>
<li>优先级适用于来自任何服务帐户的请求，通常包括来自Pods 中运行的控制器的所有请求。</li>
</ul>
</li>
<li>global-default<ul>
<li>优先级可处理所有其他流量，例如：非特权用户运行的交互式 kubectl 命令。</li>
</ul>
</li>
<li>exempt<ul>
<li>优先级的请求完全不受流控限制：它们总是立刻被分发。特殊的 exempt FlowSchema 把 system:masters 组的所有请求都归入该优先级组。</li>
</ul>
</li>
<li>catch-all<ul>
<li>优先级与特殊的 catch-all FlowSchema 结合使用，以确保每个请求都分类。</li>
<li>一般不应该依赖于 catch-all 的配置，而应适当地创建自己的 catch-all FlowSchema 和 PriorityLevelConfigurations（或使用默认安装的 global-default 配置）。</li>
<li>为了帮助捕获部分请求未分类的配置错误，强制要求 catch-all 优先级仅允许5个并发份额，并且不对请求进行排队，使得仅与 catch-all FlowSchema 匹配的流量被拒绝的可能性更高，并显示 HTTP 429 错误。</li>
</ul>
</li>
</ul>
<h5 id="PriorityLevelConfiguration"><a href="#PriorityLevelConfiguration" class="headerlink" title="PriorityLevelConfiguration"></a>PriorityLevelConfiguration</h5><p>一个 PriorityLevelConfiguration 表示单个隔离类型。</p>
<p>每个 PriorityLevelConfigurations 对未完成的请求数有各自的限制，对排队中的请求数也有限制。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PriorityLevelConfiguration.png" alt="PriorityLevelConfiguration"></p>
<h5 id="FlowSchema"><a href="#FlowSchema" class="headerlink" title="FlowSchema"></a>FlowSchema</h5><p>FlowSchema 匹配一些入站请求，并将它们分配给优先级。</p>
<p>每个入站请求都会对所有 FlowSchema 测试是否匹配， 首先从 matchingPrecedence 数值最低的匹配开始（我们认为这是逻辑上匹配度最高）， 然后依次进行，直到首个匹配出现</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlowSchema.png" alt="FlowSchema"></p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><ul>
<li>/debug/api_priority_and_fairness/dump_priority_levels —— 所有优先级及其当前状态的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_priority_levels</code></li>
<li>/debug/api_priority_and_fairness/dump_queues —— 所有队列及其当前状态的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_queues</code></li>
<li>/debug/api_priority_and_fairness/dump_requests ——当前正在队列中等待的所有请求的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_requests</code></li>
</ul>
<h3 id="高可用-API-Server"><a href="#高可用-API-Server" class="headerlink" title="高可用 API Server"></a>高可用 API Server</h3><h4 id="构建高可用的多副本apiserver"><a href="#构建高可用的多副本apiserver" class="headerlink" title="构建高可用的多副本apiserver"></a>构建高可用的多副本apiserver</h4><p>apiserver 是无状态的 Rest Server</p>
<p>无状态所以方便 Scale Up／down</p>
<p>负载均衡</p>
<ul>
<li>在多个 apiserver 实例之上，配置负载均衡</li>
<li>证书可能需要加上 Loadbalancer VIP 重新生成</li>
</ul>
<h4 id="预留充足的-CPU、内存资源"><a href="#预留充足的-CPU、内存资源" class="headerlink" title="预留充足的 CPU、内存资源"></a>预留充足的 CPU、内存资源</h4><p>随着集群中节点数量不断增多，APIServer 对 CPU 和内存的开销也不断增大。过少的 CPU 资源会降低其处理效率，过少的内存资源会导致 Pod 被 OOMKilled，直接导致服务不可用。在规划 APIServer 资源时，不能仅看当下需求，也要为未来预留充分。</p>
<h4 id="善用速率限制（RateLimit）"><a href="#善用速率限制（RateLimit）" class="headerlink" title="善用速率限制（RateLimit）"></a>善用速率限制（RateLimit）</h4><p>APIServer 的参数 <code>--max-requests-inflight</code> 和 <code>--max-mutating-requests-inflight</code> 支持在给定时间内限制并行处理读请求（包括 Get、List 和 Watch 操作）和写请求（包括 Create、Delete、Update 和 Patch 操作）的最大数量。当 APIServer 接收到的请求超过这两个参数设定的值时，再接收到的请求将会被直接拒绝。通过速率限制机制，可以有效地控 APIServer 内存的使用。如果该值配置过低，会经常出现请求超过限制的错误，如果配置过高，则 APIServer 可能会因为占用过多内存而被强制终止，因此需要根据实际的运行环境，结合实时用户请求数量和 APIServer 的资源配置进行调优。</p>
<p>客户端在接收到拒绝请求的返回值后，应等待一段时间再发起重试，无间隔的重试会加重 APIServer 的压力，导致性能进一步降低。针对并行处理请求数的过滤颗粒度太大，在请求数量比较多的场景，重要的消息可能会被拒绝掉，自 1.18 版本开始，社区引入了优先级和公平保证（Priority and Fairness）功能，以提供更细粒度地客户端请求控制。该功能支持将不同用户或不同类型的请求进行优先级归类，保证高优先级的请求总是能够更快得到处理，从而不受低优先级请求的影响。</p>
<h4 id="设置合适的缓存大小"><a href="#设置合适的缓存大小" class="headerlink" title="设置合适的缓存大小"></a>设置合适的缓存大小</h4><p>APIServer 与 etcd 之间基于 gRPC 协议进行通信，gRPC 协议保证了二者在大规模集群中的数据高速传输。gRPC 基于连接复用的 HTTP/2 协议，即针对相同分组的对象，APIServer 和 etcd 之间共享相同的 TCP 连接，不同请求由不同的 stream 传输。</p>
<p>一个 HTTP/2 连接有其 stream 配额，配额的大小限制了能支持的并发请求。APIServer 提供了集群对象的缓存机制，当客户端发起查询请求时，APIServer 默认会将其缓存直接返回给客户端。缓存区大小可以通过参数 <code>--watch-cache-sizes</code> 设置。针对访问请求比较多的对象，适当设置缓存的大小，极大降低对 etcd 的访问频率，节省了网络调用，降低了对 etcd 集群的读写压力，从而提高对象访问的性能。</p>
<p>但是 APIServer 也是允许客户端忽略缓存的，例如客户端请求中 ListOption 中没有设置 resourceVersion，这时 APIServer 直接从 etcd 拉取最新数据返回给客户端。客户端应尽量避免此操作，应在 ListOption 中设置 resourceVersion 为 0，APIServer 则将从缓存里面读取数据，而不会直接访问 etcd。</p>
<h4 id="客户端尽量使用长连接"><a href="#客户端尽量使用长连接" class="headerlink" title="客户端尽量使用长连接"></a>客户端尽量使用长连接</h4><p>当查询请求的返回数据较大且此类请求并发量较大时，容易引发 TCP 链路的阻塞，导致其他查询操作超时。因此基于 Kubernetes 开发组件时，例如某些 DaemonSet 和 Controller，如果要查询某类对象，应尽量通过长连接 ListWatch 监听对象变更，避免全量从 APIServer 获取资源。如果在同一应用程序中，如果有多个 Informer 监听 APIServer 资源变化，可以将这些Informer 合并，减少和 APIServer 的长连接数，从而降低对 APIServer 的压力。</p>
<h4 id="如何访问-APIServer"><a href="#如何访问-APIServer" class="headerlink" title="如何访问 APIServer"></a>如何访问 APIServer</h4><p>对外部客户（user/client/admin)，永远只通过 LoadBalancer 访问</p>
<p>只有当负载均衡出现故障时，管理员才切换到 apiserver IP 进行管理</p>
<p>内部客户端，优先访问 cluster IP？（是否一定如此？）</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何访问APIServer.png" alt="如何访问APIServer"></p>
<h4 id="搭建多租户的-Kubernetes-集群"><a href="#搭建多租户的-Kubernetes-集群" class="headerlink" title="搭建多租户的 Kubernetes 集群"></a>搭建多租户的 Kubernetes 集群</h4><p>授信</p>
<ul>
<li>认证：<ul>
<li>禁止匿名访问，只允许可信用户做操作。</li>
</ul>
</li>
<li>授权：<ul>
<li>基于授信的操作，防止多用户之间互相影响，比如普通用户删除 Kubernetes 核心服务，或者 A 用户删除或修改 B 用户的应用。</li>
</ul>
</li>
</ul>
<p>隔离</p>
<ul>
<li>可见行隔离：<ul>
<li>用户只关心自己的应用，无需看到其他用户的服务和部署。</li>
</ul>
</li>
<li>资源隔离：<ul>
<li>有些关键项目对资源需求较高，需要专有设备，不与其他人共享。</li>
</ul>
</li>
<li>应用访问隔离：<ul>
<li>用户创建的服务，按既定规则允许其他用户访问。</li>
</ul>
</li>
</ul>
<p>资源管理</p>
<ul>
<li>Quota 管理<ul>
<li>谁能用多少资源？</li>
</ul>
</li>
</ul>
<h5 id="认证-1"><a href="#认证-1" class="headerlink" title="认证"></a>认证</h5><p>与企业现有认证系统集成</p>
<ul>
<li>很多企业基于 Microsoft Active Directory 提供认证服务</li>
</ul>
<p>选择认证插件</p>
<ul>
<li>选择 webhook 作为认证插件（*以此为例展开）</li>
<li>也可以选择 Keystone 作为认证插件，以 Microsoft Ad 作为 backend 搭建 keystone 服务</li>
</ul>
<p>一旦认证完成，Kubernetes 即可获取当前用户信息（主要是用户名），并针对该用户做授权。授权和准入控制完成后，该用户的请求完成。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get apiservices v1. -oyaml
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  creationTimestamp: <span class="token string">"2024-05-02T13:50:21Z"</span>
  labels:
    kube-aggregator.kubernetes.io/automanaged: onstart
  name: v1.
  resourceVersion: <span class="token string">"5"</span>
  uid: 0510b743-30fc-4aab-96b9-cd9cc6d309d2
spec:
  groupPriorityMinimum: <span class="token number">18000</span>
  version: v1
  versionPriority: <span class="token number">1</span>
status:
  conditions:
  - lastTransitionTime: <span class="token string">"2024-05-02T13:50:21Z"</span>
    message: Local APIServices are always available
    reason: Local
    status: <span class="token string">"True"</span>
    type: Available<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h5><p>ABAC 有期局限性，针对每个 account 都需要做配置，并且需要重启 apiserver</p>
<p>RBAC 更灵活，更符合我们通常熟知的权限管理</p>
<h3 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a>apimachinery</h3><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/apimachinery">https://github.com/kubernetes/apimachinery</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/apimachinery">https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/apimachinery</a></p>
<p>包含了 kubernetes 核心 API 对象的定义。</p>
<h4 id="回顾-GKV"><a href="#回顾-GKV" class="headerlink" title="回顾 GKV"></a>回顾 GKV</h4><p>Group</p>
<p>Kind</p>
<p>Version</p>
<ul>
<li>Internel version 和 External version（还有一个 storage version）<ul>
<li>External version：面向用户。版本演进时，照顾版本的兼容性。（kubernetes 只承诺向前兼容 3 个版本）<ul>
<li><code>staging/src/k8s.io/api/core/v1/types.go</code> 中就是 core group 的 External version 的定义 </li>
</ul>
</li>
<li>Internal version：API Service 在存数据时会把数据先转成 Internal version<ul>
<li><code>pkg/apis/core/types.go</code> 中就是 core group 的 Internal version 的定义</li>
</ul>
</li>
<li>对比 External version 和 Internal version 的定义<ul>
<li>External version 的定义会有 json/patchStrategy/patchMergeKey/protobuf tag</li>
</ul>
</li>
</ul>
</li>
<li>版本转换</li>
</ul>
<h4 id="如何定义-Group"><a href="#如何定义-Group" class="headerlink" title="如何定义 Group"></a>如何定义 Group</h4><p><code>pkg/apis/core/register.go</code></p>
<p>定义 group</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> GroupName <span class="token operator">=</span> <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>定义 groupversion</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>APIVersionInternal<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>定义 SchemeBuilder</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
    SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
    AddToScheme <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>将对象加入SchemeBuild</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> scheme<span class="token punctuation">.</span><span class="token function">AddIgnoredConversionType</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>TypeMeta<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>TypeMeta<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>SchemeGroupVersion<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>PodList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="定义对象类型-types-go"><a href="#定义对象类型-types-go" class="headerlink" title="定义对象类型 types.go"></a>定义对象类型 types.go</h4><p>List</p>
<p>单一对象数据结构</p>
<ul>
<li>TypeMeta</li>
<li>ObjectMeta</li>
<li>Spec</li>
<li>Status</li>
</ul>
<h4 id="代码生成-Tags"><a href="#代码生成-Tags" class="headerlink" title="代码生成 Tags"></a>代码生成 Tags</h4><h5 id="Global-Tags"><a href="#Global-Tags" class="headerlink" title="Global Tags"></a>Global Tags</h5><p>定义在 doc.go 中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// +k8s:deepcopy-gen=package</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="Local-Tags"><a href="#Local-Tags" class="headerlink" title="Local Tags"></a>Local Tags</h5><p>定义在 types.go 中的每个对象里</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="token comment">// +genclient</span>
<span class="token comment">// +genclient:nonNamespaced</span>
<span class="token comment">// +genclient:noVerbs</span>
<span class="token comment">// +genclient:onlyVerbs=create,delete</span>
<span class="token comment">// +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch</span>
<span class="token comment">// +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="实现-etcd-storage"><a href="#实现-etcd-storage" class="headerlink" title="实现 etcd storage"></a>实现 etcd storage</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/configmap/storage/storage.go</span>

<span class="token comment">// NewREST returns a RESTStorage object that will work with ConfigMap objects.</span>
<span class="token keyword">func</span> <span class="token function">NewREST</span><span class="token punctuation">(</span>optsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>REST<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store <span class="token operator">:=</span> <span class="token operator">&amp;</span>genericregistry<span class="token punctuation">.</span>Store<span class="token punctuation">{</span>
        NewFunc<span class="token punctuation">:</span>                   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NewListFunc<span class="token punctuation">:</span>               <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>ConfigMapList<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        PredicateFunc<span class="token punctuation">:</span>             configmap<span class="token punctuation">.</span>Matcher<span class="token punctuation">,</span>
        DefaultQualifiedResource<span class="token punctuation">:</span>  api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"configmaps"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SingularQualifiedResource<span class="token punctuation">:</span> api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"configmap"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        CreateStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        UpdateStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        DeleteStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>

        TableConvertor<span class="token punctuation">:</span> printerstorage<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">{</span>TableGenerator<span class="token punctuation">:</span> printers<span class="token punctuation">.</span><span class="token function">NewTableGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>printersinternal<span class="token punctuation">.</span>AddHandlers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">:=</span> <span class="token operator">&amp;</span>generic<span class="token punctuation">.</span>StoreOptions<span class="token punctuation">{</span>
        RESTOptions<span class="token punctuation">:</span> optsGetter<span class="token punctuation">,</span>
        AttrFunc<span class="token punctuation">:</span>    configmap<span class="token punctuation">.</span>GetAttrs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>REST<span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="创建和更新对象时的业务逻辑-Strategy"><a href="#创建和更新对象时的业务逻辑-Strategy" class="headerlink" title="创建和更新对象时的业务逻辑 - Strategy"></a>创建和更新对象时的业务逻辑 - Strategy</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/configmap/strategy.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">PrepareForCreate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    configMap <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    <span class="token function">dropDisabledFields</span><span class="token punctuation">(</span>configMap<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">Validate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> field<span class="token punctuation">.</span>ErrorList <span class="token punctuation">{</span>
    cfg <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>

    <span class="token keyword">return</span> validation<span class="token punctuation">.</span><span class="token function">ValidateConfigMap</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">PrepareForUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> newObj<span class="token punctuation">,</span> oldObj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldConfigMap <span class="token operator">:=</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    newConfigMap <span class="token operator">:=</span> newObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    <span class="token function">dropDisabledFields</span><span class="token punctuation">(</span>newConfigMap<span class="token punctuation">,</span> oldConfigMap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">ValidateUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> newObj<span class="token punctuation">,</span> oldObj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> field<span class="token punctuation">.</span>ErrorList <span class="token punctuation">{</span>
    oldCfg<span class="token punctuation">,</span> newCfg <span class="token operator">:=</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span><span class="token punctuation">,</span> newObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>

    <span class="token keyword">return</span> validation<span class="token punctuation">.</span><span class="token function">ValidateConfigMapUpdate</span><span class="token punctuation">(</span>newCfg<span class="token punctuation">,</span> oldCfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="subresource"><a href="#subresource" class="headerlink" title="subresource"></a>subresource</h4><p>什么是 subresource，内嵌在 kubernetes 对象中，有独立的操作逻辑的属性集合，如 podstatus</p>
<p>subresource 可以单独的 listandwatch</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/pod/strategy.go</span>

statusStore<span class="token punctuation">.</span>UpdateStrategy <span class="token operator">=</span> pod<span class="token punctuation">.</span>StatusStrategy

<span class="token keyword">var</span> StatusStrategy <span class="token operator">=</span> podStatusStrategy<span class="token punctuation">{</span>Strategy<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>podStatusStrategy<span class="token punctuation">)</span> <span class="token function">PrepareForUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> old runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    newPod <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    oldPod <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    newPod<span class="token punctuation">.</span>Spec <span class="token operator">=</span> oldPod<span class="token punctuation">.</span>Spec
    newPod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">=</span> <span class="token boolean">nil</span>

    <span class="token comment">// don't allow the pods/status endpoint to touch owner references since old kubelets corrupt them in a way</span>
    <span class="token comment">// that breaks garbage collection</span>
    newPod<span class="token punctuation">.</span>OwnerReferences <span class="token operator">=</span> oldPod<span class="token punctuation">.</span>OwnerReferences
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="注册-APIGroup"><a href="#注册-APIGroup" class="headerlink" title="注册 APIGroup"></a>注册 APIGroup</h4><p>定义 Storage</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">configMapStorage <span class="token operator">:=</span> configmapstore<span class="token punctuation">.</span><span class="token function">NewREST</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">)</span>

restStorageMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span>
    <span class="token string">"configMaps"</span><span class="token punctuation">:</span> configMapStorage<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义对象的 StorageMap</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span><span class="token string">"v1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> restStorageMap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将对象注册至 APIServer（挂载handler）</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallLegacyAPIGroup</span><span class="token punctuation">(</span>genericapiserver<span class="token punctuation">.</span>DefaultLegacyAPIPrefix<span class="token punctuation">,</span> <span class="token operator">&amp;</span>apiGroupInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Error in registering group versions: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/code-generator">https://github.com/kubernetes/code-generator</a></p>
<p>deepcopy-gen</p>
<ul>
<li>为对象生成 DeepCopy 方法，用于创建对象副本</li>
</ul>
<p>client-gen</p>
<ul>
<li>创建 Clientset，用于操作对象的 CRUD</li>
</ul>
<p>informer-gen</p>
<ul>
<li>为对象创建 Informer 框架，用于监听对象变化</li>
</ul>
<p>lister-gen</p>
<ul>
<li>为对象构建 Lister 框架，用于为 Get 和 List 操作，构建客户端缓存</li>
</ul>
<p>coversion-gen</p>
<ul>
<li>为对象构建 Conversion 方法，用于内外版本转换以及不同版本号的转换</li>
</ul>
<h4 id="hack-update-codegen-sh"><a href="#hack-update-codegen-sh" class="headerlink" title="hack/update-codegen.sh"></a>hack/update-codegen.sh</h4><p>依赖</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">BUILD_TARGETS<span class="token operator">=</span><span class="token punctuation">(</span>
  vendor/k8s.io/code-generator/cmd/client-gen
  vendor/k8s.io/code-generator/cmd/lister-gen
  vendor/k8s.io/code-generator/cmd/informer-gen
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成命令</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token variable">$</span><span class="token punctuation">{</span>GOPATH<span class="token punctuation">}</span>/bin/deepcopy-gen --input-dirs <span class="token punctuation">{</span>versioned-package-pach<span class="token punctuation">}</span>
  -O zz_generated.deepcopy \
  --bounding-dirs <span class="token punctuation">{</span>output-package-path<span class="token punctuation">}</span> \
  --go-header-file <span class="token variable">$</span><span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>/hack/boilerplate.go.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="APIServer-代码走读"><a href="#APIServer-代码走读" class="headerlink" title="APIServer 代码走读"></a>APIServer 代码走读</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kube-apiserver-10d5695cbbb14387b60c6d622005583d">https://cncamp.notion.site/kube-apiserver-10d5695cbbb14387b60c6d622005583d</a></p>
<blockquote>
<p>建议先读 controller 的源码，比如 deployment controller 的源码</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">cmd<span class="token operator">/</span>kube<span class="token operator">-</span>apiserver<span class="token operator">/</span>app<span class="token operator">/</span>server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
completedOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>WatchCacheSizes<span class="token punctuation">,</span> err <span class="token operator">=</span> serveroptions<span class="token punctuation">.</span><span class="token function">WriteWatchCacheSizes</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span>
<span class="token function">Run</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        CreateKubeAPIServerConfig<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                genericapiserver<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">)</span> <span class="token comment">// create codec factory for encoding/decoding</span>
                controlplane<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// group version: enabled/disabled</span>
                storageFactoryConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">)</span>
                completedStorageFactoryConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// register access path in etcd for all k8s objects</span>
                    storageFactory<span class="token punctuation">.</span><span class="token function">AddCohabitatingResources</span><span class="token punctuation">(</span>networking<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"networkpolicies"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extensions<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"networkpolicies"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">ApplyWithStorageFactoryTo</span><span class="token punctuation">(</span>storageFactory<span class="token punctuation">,</span> genericConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    c<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    c<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token operator">&amp;</span>StorageFactoryRestOptionsFactory<span class="token punctuation">{</span>Options<span class="token punctuation">:</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> StorageFactory<span class="token punctuation">:</span> factory<span class="token punctuation">}</span>
<span class="token comment">// 认证</span>
                s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// clientcert, serviceaccount, bootstrap token, </span>
                    authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        <span class="token function">newWebhookTokenAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token comment">// webhook</span>
<span class="token comment">// 鉴权</span>
                <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    authorizationConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        rbacAuthorizer <span class="token operator">:=</span> rbac<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// if authorizer type is rbac</span>
<span class="token comment">// 准入</span>
                <span class="token function">buildServiceResolver</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>
                admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">{</span>webhookPluginInitializer<span class="token punctuation">,</span> kubePluginInitializer<span class="token punctuation">}</span>

            net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>ServerList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            utilwait<span class="token punctuation">.</span><span class="token function">PollImmediate</span><span class="token punctuation">(</span>etcdRetryInterval<span class="token punctuation">,</span> etcdRetryLimit<span class="token operator">*</span>etcdRetryInterval<span class="token punctuation">,</span> preflight<span class="token punctuation">.</span>EtcdConnection<span class="token punctuation">{</span>ServerList<span class="token punctuation">:</span> s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>ServerList<span class="token punctuation">}</span><span class="token punctuation">.</span>CheckEtcdServers<span class="token punctuation">)</span>
            capabilities<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// allow privillage?</span>
            config <span class="token operator">:=</span> <span class="token operator">&amp;</span>controlplane<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            apiextensionsConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span>delegateCheck<span class="token punctuation">)</span>
<span class="token comment">// 注册通用handler</span>
                <span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token comment">// register generic api handler e.g. index, profiling, metrics, flow control</span>
        <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">)</span>
            kubeAPIServerConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>
                m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span>controllerName<span class="token punctuation">,</span> bootstrapController<span class="token punctuation">.</span>PostStartHook<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        controlplane<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            async<span class="token punctuation">.</span><span class="token function">NewRunner</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>RunKubernetesNamespaces<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RunKubernetesService<span class="token punctuation">,</span> repairClusterIPs<span class="token punctuation">.</span>RunUntil<span class="token punctuation">,</span> repairNodePorts<span class="token punctuation">.</span>RunUntil<span class="token punctuation">)</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPreShutdownHookOrDie</span><span class="token punctuation">(</span>controllerName<span class="token punctuation">,</span> bootstrapController<span class="token punctuation">.</span>PreShutdownHook<span class="token punctuation">)</span>
<span class="token comment">// 注册core group API handler</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallLegacyAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// register handler for /api</span>
                    restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>appsrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">// 初始化对应group中对象的watch cache</span>
                    restStorageBuilder<span class="token punctuation">.</span><span class="token function">NewRESTStorage</span><span class="token punctuation">(</span>apiResourceConfigSource<span class="token punctuation">,</span> restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// trigger appsrest.StorageProvider</span>
                        p<span class="token punctuation">.</span><span class="token function">v1Storage</span><span class="token punctuation">(</span>apiResourceConfigSource<span class="token punctuation">,</span> restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            daemonsetstore<span class="token punctuation">.</span><span class="token function">NewREST</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                    opts<span class="token punctuation">,</span> err <span class="token operator">:=</span> options<span class="token punctuation">.</span>RESTOptions<span class="token punctuation">.</span><span class="token function">GetRESTOptions</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>DefaultQualifiedResource<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// etcd.go</span>
                                        ret<span class="token punctuation">.</span>Decorator <span class="token operator">=</span> genericregistry<span class="token punctuation">.</span><span class="token function">StorageWithCacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            cacherstorage<span class="token punctuation">.</span><span class="token function">NewCacherFromConfig</span><span class="token punctuation">(</span>cacherConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                                watchCache <span class="token operator">:=</span> <span class="token function">newWatchCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">// 注册API handler</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallAPIGroups</span><span class="token punctuation">(</span>apiGroupsInfo<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>  <span class="token comment">// register handler for /apis</span>
                        s<span class="token punctuation">.</span><span class="token function">installAPIResources</span><span class="token punctuation">(</span>APIGroupPrefix<span class="token punctuation">,</span> apiGroupInfo<span class="token punctuation">,</span> openAPIModels<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            apiGroupVersion<span class="token punctuation">.</span><span class="token function">InstallREST</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                discovery<span class="token punctuation">.</span><span class="token function">NewAPIVersionHandler</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> g<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> staticLister<span class="token punctuation">{</span>apiResources<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">,</span> kubeAPIServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>Informers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            apiServices <span class="token operator">:=</span> <span class="token function">apiServicesToRegister</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">,</span> autoRegistrationController<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            s<span class="token punctuation">.</span><span class="token function">installHealthz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">installLivez</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">installReadyz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        s<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// preparedGenericAPIServer.Run()</span>
            s<span class="token punctuation">.</span><span class="token function">NonBlockingRun</span><span class="token punctuation">(</span>delayedStopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">.</span>SecureServingInfo<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> s<span class="token punctuation">.</span>ShutdownTimeout<span class="token punctuation">,</span> internalStopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token function">RunServer</span><span class="token punctuation">(</span>secureServer<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Listener<span class="token punctuation">,</span> shutdownTimeout<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Kubernetes-控制平面组件：调度器和控制器"><a href="#Kubernetes-控制平面组件：调度器和控制器" class="headerlink" title="Kubernetes 控制平面组件：调度器和控制器"></a>Kubernetes 控制平面组件：调度器和控制器</h2><h3 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h3><h4 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kube-scheduler-0d45b37a5c9a46008aaf9f9e2088b3ce">kube-scheduler</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Framework manages the set of plugins in use by the scheduling framework.</span>
<span class="token comment">// Configured plugins are called at specified points in a scheduling context.</span>
<span class="token keyword">type</span> Framework <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    Handle
    <span class="token function">QueueSortFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> LessFunc
    <span class="token function">RunPreFilterPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunPostFilterPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> filteredNodeStatusMap NodeToStatusMap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PostFilterResult<span class="token punctuation">,</span> <span class="token operator">*</span>Status<span class="token punctuation">)</span>
    <span class="token function">RunPreBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunPostBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunReservePluginsUnreserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">WaitOnPermit</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">HasFilterPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">HasPostFilterPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">HasScorePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">ListPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Plugins
    <span class="token function">ProfileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token comment">// filter</span>
    g<span class="token punctuation">.</span><span class="token function">findNodesThatFitPod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> extenders<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 1.filter预处理阶段：遍历pod的所有initcontainer和主container，计算pod的总资源需求</span>
        s <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPreFilterPlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token comment">// e.g. computePodResourceRequest</span>
        <span class="token comment">// 2. filter阶段，遍历所有节点，过滤掉不符合资源需求的节点</span>
        g<span class="token punctuation">.</span><span class="token function">findNodesThatPassFilters</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> diagnosis<span class="token punctuation">,</span> allNodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            fwk<span class="token punctuation">.</span><span class="token function">RunFilterPluginsWithNominatedPods</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getPreFilterState</span><span class="token punctuation">(</span>cycleState<span class="token punctuation">)</span>
                insufficientResources <span class="token operator">:=</span> <span class="token function">fitsRequest</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> f<span class="token punctuation">.</span>ignoredResources<span class="token punctuation">,</span> f<span class="token punctuation">.</span>ignoredResourceGroups<span class="token punctuation">)</span>
        <span class="token comment">// 3. 处理扩展plugin</span>
        <span class="token function">findNodesThatPassExtenders</span><span class="token punctuation">(</span>extenders<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> feasibleNodes<span class="token punctuation">,</span> diagnosis<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">)</span>
        <span class="token comment">// score</span>
    <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> extenders<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> feasibleNodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 4. score，比如处理弱亲和性，将preferredAffinity语法进行解析</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span> <span class="token comment">// e.g. nodeAffinity</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 5. 为节点打分</span>
            f<span class="token punctuation">.</span><span class="token function">runScorePlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// e.g. noderesource fit</span>
        <span class="token comment">// 6. 处理扩展plugin</span>
        extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Prioritize</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
        <span class="token comment">// 7.选择节点</span>
        g<span class="token punctuation">.</span><span class="token function">selectHost</span><span class="token punctuation">(</span>priorityList<span class="token punctuation">)</span>
sched<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token comment">// 8.假定选中pod</span>
    sched<span class="token punctuation">.</span>SchedulerCache<span class="token punctuation">.</span><span class="token function">AssumePod</span><span class="token punctuation">(</span>assumed<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
fwk<span class="token punctuation">.</span><span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runReservePluginReserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// e.g. bindVolume。其实还没大用</span>
runPermitStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runPermitPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// empty hook</span>
fwk<span class="token punctuation">.</span><span class="token function">RunPreBindPlugins</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span> <span class="token comment">// 同 runReservePluginReserve</span>
        <span class="token comment">// bind</span>
        <span class="token comment">// 9.绑定pod</span>
sched<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runBindPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bp<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        b<span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">ClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"pods"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">VersionedParams</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">,</span> scheme<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SubResource</span><span class="token punctuation">(</span><span class="token string">"binding"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Body</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>kube-scheduler 负责分配调度 Pod 到集群内的节点上，它监听 kube-apiserver，查询还未分配 Node 的 Pod，然后根据调度策略为这些 Pod 分配节点（更新 Pod 的NodeName 字段）。</p>
<p>调度器需要充分考虑诸多的因素：</p>
<ul>
<li>公平调度</li>
<li>资源高效利用</li>
<li>Qos</li>
<li>affinity 和 anti-affinity</li>
<li>数据本地化（data locality）</li>
<li>内部负载干扰（inter-workload interfernece）</li>
<li>deadlines</li>
</ul>
<h4 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h4><p>kube-scheduler 调度分为两个阶段：</p>
<ul>
<li>predicate：过滤不符合条件的节点</li>
<li>priority：优先级排序，选择优先级最高的节点。</li>
</ul>
<h5 id="predicates-策略"><a href="#predicates-策略" class="headerlink" title="predicates 策略"></a>predicates 策略</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicates策略.png" alt="predicates策略"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicates策略2.png" alt="predicates策略2"></p>
<h5 id="predicates-plugin-工作原理"><a href="#predicates-plugin-工作原理" class="headerlink" title="predicates plugin 工作原理"></a>predicates plugin 工作原理</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicatesplugin工作原理.png" alt="predicatesplugin工作原理"></p>
<h5 id="priorities-策略"><a href="#priorities-策略" class="headerlink" title="priorities 策略"></a>priorities 策略</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/priorities策略.png" alt="priorities策略"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/priorities策略2.png" alt="priorities策略2"></p>
<h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul>
<li>CPU<ul>
<li>requests<ul>
<li>Kubernetes 调度 Pod 时，会判断当前节点正在运行的 Pod 的 CPU Request 的总和，再加上当前调度 Pod 的 CPU Request，计算其是否超过节点的 CPU 的可分配资源</li>
</ul>
</li>
<li>limits<ul>
<li>配置 cgroup 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
<li>内存<ul>
<li>requests<ul>
<li>判断节点的剩余内存是否满足 Pod 的内存请求量，以确定是否可以将 Pod 调度到该节点</li>
</ul>
</li>
<li>limits<ul>
<li>配置 cgroup 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>调度时只看 request。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get node -oyaml
apiVersion: v1
items:
- apiVersion: v1
  kind: Node
  <span class="token punctuation">..</span>.
  status:
    allocatable:
      cpu: <span class="token string">"12"</span>
      ephemeral-storage: 1055762868Ki
      hugepages-1Gi: <span class="token string">"0"</span>
      hugepages-2Mi: <span class="token string">"0"</span>
      memory: 65713368Ki
      pods: <span class="token string">"110"</span>
    capacity:
      cpu: <span class="token string">"12"</span>
      ephemeral-storage: 1055762868Ki
      hugepages-1Gi: <span class="token string">"0"</span>
      hugepages-2Mi: <span class="token string">"0"</span>
      memory: 65713368Ki
      pods: <span class="token string">"110"</span>
    <span class="token punctuation">..</span>.

<span class="token comment"># 获取某个容器的 cgroup 信息</span>
$ docker inspect 89bf4bbee272 -f <span class="token string">"{{.HostConfig.CgroupParent}}"</span>
/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed

$ <span class="token function">find</span> /sys/fs/cgroup -name <span class="token string">"pod8af0e85a28544808d52bb7c47ad824ed"</span>
/sys/fs/cgroup/systemd/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/misc/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/rdma/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/pids/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/hugetlb/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/net_prio/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/perf_event/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/net_cls/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/freezer/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/devices/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/memory/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/blkio/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpuacct/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpu/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpuset/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/unified/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi           <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> memory.limit_in_bytes = memory(1) * 1024 * 1024 * 1024
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1                <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> cpu.cfs_quota_us(100000) = cpu.cfs_period_us(100000) * cpu(1)
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m             <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> cpu.shares = int(cpu(100m) / 1000m * 1024) = 102<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以使用 LimitRange 来限制集群中资源的范围和设置默认的资源</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/2.limit-range.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/2.limit-range.yaml</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/policy/limit-range/">https://kubernetes.io/docs/concepts/policy/limit-range/</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mem<span class="token punctuation">-</span>limit<span class="token punctuation">-</span>range
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
      <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是在真实的场景中不太用 LimitRange，因为 LimitRange 会对所有的容器生效，包括 init container。</p>
<h5 id="磁盘资源需求"><a href="#磁盘资源需求" class="headerlink" title="磁盘资源需求"></a>磁盘资源需求</h5><p>容器临时存储（ephemeral storage）包含日志和可写层数据，可以通过定义 Pod Spec 中的 <code>limits.ephemeral-storage</code> 和 <code>requests.ephemeral-storage</code> 来申请。</p>
<p>Pod 调度完成后，计算节点对临时存储的限制不是基于 CGroup 的，而是由 kubelet 定时获取容器的日志和容器可写层的磁盘使用情况，如果超过限制，则会对 Pod 进行驱逐。</p>
<h5 id="Init-Container-的资源需求"><a href="#Init-Container-的资源需求" class="headerlink" title="Init Container 的资源需求"></a>Init Container 的资源需求</h5><ul>
<li>当 kube-scheduler 调度带有多个 init 容器的 Pod 时，只计算 <code>cpu.request</code> 最多的 init 容器，而不是计算所有的 init 容器总和。</li>
<li>由于多个 init 容器按顺序执行，并且执行完成立即退出，所以申请最多的资源 init 容器中的所需资源，即可满足所有 init 容器需求。</li>
<li>kube-scheduler 在计算该节点被占用的资源时，init 容器的资源依然会被纳入计算。因为 init 容器在特定情况下可能会被再次执行，比如由于更换镜像而引起 Sandbox 重建时。</li>
</ul>
<h4 id="把-Pod-调度到指定-Node-上"><a href="#把-Pod-调度到指定-Node-上" class="headerlink" title="把 Pod 调度到指定 Node 上"></a>把 Pod 调度到指定 Node 上</h4><p>可以通过 nodeSelector、nodeAffinity、podAffinity 以及 Taints 和 tolerations 等来将 Pod 调度到需求的 Node 上。</p>
<p>也可以通过设置 nodeName 参数，将 Pod 调度到指定 node 节点上。</p>
<p>比如，使用 nodeSelector，首先给 Node 加上标签：<code>kubectl label nodes &lt;your-node-name&gt; disktype=ssd</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get node --show-labels
NAME       STATUS   ROLES           AGE   VERSION   LABELS
minikube   Ready    control-plane   23h   v1.27.4   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>minikube,kubernetes.io/os<span class="token operator">=</span>linux,minikube.k8s.io/commit<span class="token operator">=</span>fd7ecd9c4599bef9f04c0986c4a0187f98a4396e,minikube.k8s.io/name<span class="token operator">=</span>minikube,minikube.k8s.io/primary<span class="token operator">=</span>true,minikube.k8s.io/updated_at<span class="token operator">=</span>2024_05_07T17_53_18_0700,minikube.k8s.io/version<span class="token operator">=</span>v1.31.2,node-role.kubernetes.io/control-plane<span class="token operator">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="token operator">=</span>

$ kubectl label nodes minikube <span class="token assign-left variable">disktype</span><span class="token operator">=</span>hdd
node/minikube labeled

$ kubectl get node --show-labels
NAME       STATUS   ROLES           AGE   VERSION   LABELS
minikube   Ready    control-plane   23h   v1.27.4   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,disktype<span class="token operator">=</span>hdd,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>minikube,kubernetes.io/os<span class="token operator">=</span>linux,minikube.k8s.io/commit<span class="token operator">=</span>fd7ecd9c4599bef9f04c0986c4a0187f98a4396e,minikube.k8s.io/name<span class="token operator">=</span>minikube,minikube.k8s.io/primary<span class="token operator">=</span>true,minikube.k8s.io/updated_at<span class="token operator">=</span>2024_05_07T17_53_18_0700,minikube.k8s.io/version<span class="token operator">=</span>v1.31.2,node-role.kubernetes.io/control-plane<span class="token operator">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，指定该 Pod 只想运行在带有 <code>disktype=ssd</code> 标签的 Node 上。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/4.node-selector.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/4.node-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/5.readme.MD">https://github.com/kibaamor/101/blob/master/module7/scheduling/5.readme.MD</a></p>
<p>NodeAffinity 目前支持两种：requiredDuringSchedulingIgnoredDuringExecution 和 preferredDuringSchedulingIgnoredDuringExecution，分别代表必须满足和优选条件。</p>
<blockquote>
<p>可以用 <code>NotIn</code> 等 operator 实现反亲和性。</p>
<p>requiredDuringSchedulingIgnoredDuringExecution 在调度器的 predicate 阶段起作用，preferredDuringSchedulingIgnoredDuringExecution 在调度器的 priority 阶段起作用，所以 preferredDuringSchedulingIgnoredDuringExecution 中有 weight 参数。</p>
</blockquote>
<p>比如下面的例子代表调度到包含标签 <code>Kubernetes.io/e2e-az-name</code> 并且值为 <code>e2e-az1</code> 或 <code>e2e-az2</code> 的 Node 上，并且优选还带有标签 <code>another-node-label-key=another-node-label-value</code> 的 Node 。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/e2e<span class="token punctuation">-</span>az<span class="token punctuation">-</span>name
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az1
            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az2
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>key
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>value
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_containers/pause<span class="token punctuation">:</span><span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/5.a.pod-anti-affinity.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/5.a.pod-anti-affinity.yaml</a></p>
<p>podAffinity 基于 Pod 的标签来选择 Node，仅调度到满足条件 Pod 所在的 Node 上，支持 PodAffinity 和 PodAntiAffinity。这个功能比较绕，以下面的例子为例：</p>
<p>如果一个 “Node 所在的 Zone 中包含至少一个带有 security=S1 标签且运行中的 Pod”，那么可以调度到该 Node，尽量不调度到 “包含至少一个带有 security=S2 标签且运行中 Pod” 的 Node 上。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchExpressons</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> security
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
          <span class="token key atrule">values</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> S1
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> failure<span class="token punctuation">-</span>domain.beta.kubernetes.io/zone
    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressons</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> security
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> S2
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_containers/pause<span class="token punctuation">:</span><span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Taints-和-Tolerations"><a href="#Taints-和-Tolerations" class="headerlink" title="Taints 和 Tolerations"></a>Taints 和 Tolerations</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/6.taint.MD">https://github.com/kibaamor/101/blob/master/module7/scheduling/6.taint.MD</a></p>
<p>Taints 和 Tolerations 用于保证 Pod 不被调度到不合适的 Node 上，其中 Taint 应用于 Node 上，而 Toleration 则应用于 Pod 上。</p>
<p>目前支持的 Taint 类型：</p>
<ul>
<li>NoSchedule：新的 Pod 不调度到该 Node 上，不影响正在运行的 Pod</li>
<li>PreferNoSchedule： soft 版的 NoSchedule，尽量不调度到该 Node 上</li>
<li>NoExecute：新的 Pod 不调度到该 Node 上，并且删除（evict）已在运行的 Pod。 Pod 可以增加一个时间（tolerationSeconds）</li>
</ul>
<p>然而，当 Pod 的 Tolerations 匹配 Node 的所有 Taints 的时候可以调度到该 Node 上；当 Pod 是已经运行的时候，也不会被删除（evicted）。另外对于 NoExecute，如果 Pod 增加一个 tolerationSeconds，则会在该时间之后才删除 Pod。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get po metrics-server-7746886d4f-l8gs7 -oyaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: <span class="token string">"2024-05-07T09:53:31Z"</span>
  generateName: metrics-server-7746886d4f-
  labels:
    k8s-app: metrics-server
    pod-template-hash: 7746886d4f
  name: metrics-server-7746886d4f-l8gs7
  namespace: kube-system
  ownerReferences:
  - apiVersion: apps/v1
    blockOwnerDeletion: <span class="token boolean">true</span>
    controller: <span class="token boolean">true</span>
    kind: ReplicaSet
    name: metrics-server-7746886d4f
    uid: 394b2480-e048-4b10-977d-aaeabcf57ca0
  resourceVersion: <span class="token string">"586"</span>
  uid: 2a18e607-3bd2-4b66-959c-6a41de9f9e53
spec:
  tolerations:
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: <span class="token number">300</span>
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: <span class="token number">300</span>
  <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果一个 Node 上有一个 key 为 <code>node.kubernetes.io/not-ready</code> 或者 <code>node.kubernetes.io/unreachable</code> 的 taint ，那么这个 Node 上面的 Pod 允许存活 300 秒后再被驱逐。</p>
<p>上面的这两个 toleration 是创建 Pod 时 kubernetes 自动加上的。如果一个节点发生故障，这个节点上面的 Pod 会被自动驱逐。其背后的机制就是如果一个 node 变为 <code>not-ready</code> 或者 <code>unreachable</code>，kubernetes 会自动的给该 node 加上对应的 taint。这也是 kubernetes 能做故障转移的秘密。</p>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/pkg-controller-nodelifecycle-node_lifecycle_controller-go-9e2888478bd84ad3bf9fd2c79da1481c">pkg/controller/nodelifecycle/node_lifecycle_controller.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">NewNodeLifecycleController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    nc <span class="token operator">:=</span> <span class="token operator">&amp;</span>Controller<span class="token punctuation">{</span>
        kubeClient<span class="token punctuation">:</span>                  kubeClient<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    podInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> nc<span class="token punctuation">.</span>runTaintManager <span class="token punctuation">{</span>
        nodeInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">go</span> nc<span class="token punctuation">.</span>taintManager<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> UpdateWorkerSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        tc<span class="token punctuation">.</span>nodeUpdateChannels <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>nodeUpdateChannels<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> nodeUpdateItem<span class="token punctuation">,</span> NodeUpdateChannelSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        tc<span class="token punctuation">.</span>podUpdateChannels <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>podUpdateChannels<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> podUpdateItem<span class="token punctuation">,</span> podUpdateChannelSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    item<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> tc<span class="token punctuation">.</span>nodeUpdateQueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    hash <span class="token operator">:=</span> <span class="token function">hash</span><span class="token punctuation">(</span>nodeUpdate<span class="token punctuation">.</span>nodeName<span class="token punctuation">,</span> UpdateWorkerSize<span class="token punctuation">)</span>
    tc<span class="token punctuation">.</span>nodeUpdateChannels<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> nodeUpdate<span class="token punctuation">:</span>

    item<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> tc<span class="token punctuation">.</span>podUpdateQueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// that pods are processed by the same worker as nodes</span>
    hash <span class="token operator">:=</span> <span class="token function">hash</span><span class="token punctuation">(</span>podUpdate<span class="token punctuation">.</span>nodeName<span class="token punctuation">,</span> UpdateWorkerSize<span class="token punctuation">)</span>
    <span class="token keyword">case</span> tc<span class="token punctuation">.</span>podUpdateChannels<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> podUpdate<span class="token punctuation">:</span> 

    <span class="token keyword">go</span> tc<span class="token punctuation">.</span><span class="token function">worker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> wg<span class="token punctuation">.</span>Done<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        tc<span class="token punctuation">.</span><span class="token function">handleNodeUpdate</span><span class="token punctuation">(</span>nodeUpdate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            taints <span class="token operator">:=</span> <span class="token function">getNoExecuteTaints</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Taints<span class="token punctuation">)</span>
            tc<span class="token punctuation">.</span>taintedNodes<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> taints
            pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span><span class="token function">getPodsAssignedToNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            tc<span class="token punctuation">.</span><span class="token function">processPodOnNode</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Tolerations<span class="token punctuation">,</span> taints<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                allTolerated<span class="token punctuation">,</span> usedTolerations <span class="token operator">:=</span> v1helper<span class="token punctuation">.</span><span class="token function">GetMatchingTolerations</span><span class="token punctuation">(</span>taints<span class="token punctuation">,</span> tolerations<span class="token punctuation">)</span>
                <span class="token comment">// toleration 不匹配，立即驱逐</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>allTolerated <span class="token punctuation">{</span>
                    tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                minTolerationTime <span class="token operator">:=</span> <span class="token function">getMinTolerationTime</span><span class="token punctuation">(</span>usedTolerations<span class="token punctuation">)</span>
                startTime <span class="token operator">:=</span> now
                triggerTime <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>minTolerationTime<span class="token punctuation">)</span>
                tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> triggerTime<span class="token punctuation">)</span>
        tc<span class="token punctuation">.</span><span class="token function">handlePodUpdate</span><span class="token punctuation">(</span>podUpdate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            tc<span class="token punctuation">.</span><span class="token function">processPodOnNode</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Tolerations<span class="token punctuation">,</span> taints<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    worker <span class="token operator">:=</span> <span class="token function">createWorker</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> createdAt<span class="token punctuation">,</span> fireAt<span class="token punctuation">,</span> q<span class="token punctuation">.</span><span class="token function">getWrappedWorkerFunc</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>clock<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        delay <span class="token operator">:=</span> fireAt<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>createdAt<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> delay <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                            <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                            <span class="token keyword">return</span> <span class="token boolean">nil</span>
                        <span class="token punctuation">}</span>
                        timer <span class="token operator">:=</span> clock<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

tm<span class="token punctuation">.</span>taintEvictionQueue <span class="token operator">=</span> <span class="token function">CreateWorkerQueue</span><span class="token punctuation">(</span><span class="token function">deletePodHandler</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> tm<span class="token punctuation">.</span>emitPodDeletionEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">//	delete pod</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="多租户-Kubernetes-集群计算资源隔离"><a href="#多租户-Kubernetes-集群计算资源隔离" class="headerlink" title="多租户 Kubernetes 集群计算资源隔离"></a>多租户 Kubernetes 集群计算资源隔离</h5><p>Kubernetes 集群一般是通用集群，可被所有用户共享，用户无需关心计算节点细节。</p>
<p>但往往某些自带计算资源的客户要求：</p>
<ul>
<li>带着计算资源加入 Kubernetes 集群</li>
<li>要求资源隔离</li>
</ul>
<p>实现方案：</p>
<ul>
<li>将要隔离的计算节点打上 Taints</li>
<li>在用户创建 Pod 时，定义 Tolerations 来指定要调度到 node taints</li>
</ul>
<p>该方案有漏洞吗？如何堵住？</p>
<ul>
<li>其他用户如果可以 get nodes 或者 pods，可以看到 taints 信息，也可以用相同的 tolerations 占用资源</li>
<li>不让用户 get node detail?</li>
<li>不让用户 get 别人的 pod detail？</li>
<li>企业内部，也可以通过规范管理，通过统计数据看谁占用了哪些 node</li>
<li>数据平面上的隔离还需要其他方案配合</li>
</ul>
<h5 id="来自生产系统的经验"><a href="#来自生产系统的经验" class="headerlink" title="来自生产系统的经验"></a>来自生产系统的经验</h5><ul>
<li>用户会忘记打 tolerance，导致 pod 无法调度，pending</li>
<li>新员工常犯的错误，通过聊天机器人的 Q&amp;A 解决</li>
<li>其他用户会 get node detail，查到 taints，偷用资源</li>
<li>通过 dashboard，能看到哪些用户的什么应用跑在哪些节点上</li>
<li>对于违规用户，批评教育为主</li>
</ul>
<h4 id="优先级调度"><a href="#优先级调度" class="headerlink" title="优先级调度"></a>优先级调度</h4><p>从 v1.8 开始，kube-scheduler 支持定义 Pod 的优先级，从而保证高优先级的 Pod 优先调度。开启方法为：</p>
<ul>
<li>apiserver 配置 <code>--feature-gates=PodPrioirity=true</code> 和 <code>--runtime-config=scheduling.k8s.io/v1alpha1=true</code></li>
<li>kube-scheduler 配置 <code>--feature-gates=PodPriority=true</code></li>
</ul>
<h5 id="PriorityClass"><a href="#PriorityClass" class="headerlink" title="PriorityClass"></a>PriorityClass</h5><p>在指定 Pod 的优先级之前需要先定义一个 PriorityClass（非 namespace 资源），如：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PriorityClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority
<span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
<span class="token key atrule">globalDefault</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"This priority class should be used for XYZ service pods only."</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为 pod 设置 Priority</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="多调度器"><a href="#多调度器" class="headerlink" title="多调度器"></a>多调度器</h4><p>如果默认的调度器不满足需求，还可以部署自定义的调度器。并且，在整个集群中还可以同时运行多个调度器实例，通过 <code>podSpec.schedulerName</code> 来选择使用哪一个调度器（默认使用内置的调度器）。</p>
<h4 id="来从生产环境的一些经验"><a href="#来从生产环境的一些经验" class="headerlink" title="来从生产环境的一些经验"></a>来从生产环境的一些经验</h4><ol>
<li><p>小集群</p>
<p> 100 个 node，并发创建 8000 个 Pod 的最大调度耗时大概是 2 分钟左右，发生过 node 删除后，scheduler cache 还有信息的情况，导致 Pod 调度失败。</p>
</li>
<li><p>放大效应</p>
<p> 当一个 node 出现问题所以 load 较小时，通常用户的 Pod 都会优先调度到该 Node 上，导致用户所有创建的新 Pod 都失败的情况。</p>
</li>
<li><p>应用炸弹</p>
<p> 存在危险的用户 Pod（比如 fork bomb），在调度到某个 node 上后，会因为打开文件句柄过多导致 node down 机，Pod 会被 evict 到其他节点，再对其他节点造成伤害，依次循环会导致整个 cluster 所有节点不可用。</p>
</li>
</ol>
<p>调度器可以说是运营过程中稳定性最好的组件之一，基本没有太大的维护 effort。</p>
<h3 id="Controller-Manager-1"><a href="#Controller-Manager-1" class="headerlink" title="Controller Manager"></a>Controller Manager</h3><h4 id="控制器的工作流程-1"><a href="#控制器的工作流程-1" class="headerlink" title="控制器的工作流程"></a>控制器的工作流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的工作流程.png" alt="控制器的工作流程"></p>
<h4 id="Informer-的内部机制-1"><a href="#Informer-的内部机制-1" class="headerlink" title="Informer 的内部机制"></a>Informer 的内部机制</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Informer的内部机制.png" alt="Informer的内部机制"></p>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/informer-framework-31ba746049ec472fb405e61482ed762f">informer framework</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">secretInformer <span class="token operator">:=</span> kubecoreinformers<span class="token punctuation">.</span><span class="token function">NewSecretInformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">NewFilteredSecretInformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>ListWatch<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Secret<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> indexers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            sharedIndexInformer <span class="token operator">:=</span> <span class="token operator">&amp;</span>sharedIndexInformer<span class="token punctuation">{</span>
                processor<span class="token punctuation">:</span>                       <span class="token operator">&amp;</span>sharedProcessor<span class="token punctuation">{</span>clock<span class="token punctuation">:</span> realClock<span class="token punctuation">}</span><span class="token punctuation">,</span>
                indexer<span class="token punctuation">:</span>                         <span class="token function">NewIndexer</span><span class="token punctuation">(</span>DeletionHandlingMetaNamespaceKeyFunc<span class="token punctuation">,</span> indexers<span class="token punctuation">)</span><span class="token punctuation">,</span>
                listerWatcher<span class="token punctuation">:</span>                   lw<span class="token punctuation">,</span>
                objectType<span class="token punctuation">:</span>                      exampleObject<span class="token punctuation">,</span>
                resyncCheckPeriod<span class="token punctuation">:</span>               defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
                defaultEventHandlerResyncPeriod<span class="token punctuation">:</span> defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
                cacheMutationDetector<span class="token punctuation">:</span>           <span class="token function">NewCacheMutationDetector</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%T"</span><span class="token punctuation">,</span> exampleObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                clock<span class="token punctuation">:</span>                           realClock<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>

secretInformer<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        listener <span class="token operator">:=</span> <span class="token function">newProcessListener</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> <span class="token function">determineResyncPeriod</span><span class="token punctuation">(</span>resyncPeriod<span class="token punctuation">,</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialBufferSize<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            ret <span class="token operator">:=</span> <span class="token operator">&amp;</span>processorListener<span class="token punctuation">{</span>
                nextCh<span class="token punctuation">:</span>                <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                addCh<span class="token punctuation">:</span>                 <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span>               handler<span class="token punctuation">,</span>
                pendingNotifications<span class="token punctuation">:</span>  <span class="token operator">*</span>buffer<span class="token punctuation">.</span><span class="token function">NewRingGrowing</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
                requestedResyncPeriod<span class="token punctuation">:</span> requestedResyncPeriod<span class="token punctuation">,</span>
                resyncPeriod<span class="token punctuation">:</span>          resyncPeriod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
            listener<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token keyword">for</span> next <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>nextCh <span class="token punctuation">{</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnUpdate</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">,</span> notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnAdd</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnDelete</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            listener<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token keyword">for</span> <span class="token punctuation">{</span>
                    <span class="token keyword">select</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> nextCh <span class="token operator">&lt;-</span> notification<span class="token punctuation">:</span>
                        notification<span class="token punctuation">,</span> ok <span class="token operator">=</span> p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">ReadOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">case</span> notificationToAdd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>addCh<span class="token punctuation">:</span>
                            p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">WriteOne</span><span class="token punctuation">(</span>notificationToAdd<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listener<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">{</span>newObj<span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                p<span class="token punctuation">.</span>addCh <span class="token operator">&lt;-</span> notification
        <span class="token punctuation">}</span>

<span class="token keyword">go</span> secretInformer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Stop<span class="token punctuation">)</span>
    fifo <span class="token operator">:=</span> <span class="token function">NewDeltaFIFOWithOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    cfg <span class="token operator">:=</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{</span>
            Queue<span class="token punctuation">:</span>            fifo<span class="token punctuation">,</span>
            ListerWatcher<span class="token punctuation">:</span>    s<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">,</span>
            ObjectType<span class="token punctuation">:</span>       s<span class="token punctuation">.</span>objectType<span class="token punctuation">,</span>
            FullResyncPeriod<span class="token punctuation">:</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">,</span>
            RetryOnError<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
            ShouldResync<span class="token punctuation">:</span>     s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>shouldResync<span class="token punctuation">,</span>
    
            Process<span class="token punctuation">:</span> s<span class="token punctuation">.</span>HandleDeltas<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>cacheMutationDetector<span class="token punctuation">.</span>Run<span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>run<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>controller <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        r <span class="token operator">:=</span> <span class="token function">NewReflector</span><span class="token punctuation">(</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ListerWatcher<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ObjectType<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>FullResyncPeriod<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Run<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            r<span class="token punctuation">.</span><span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                list <span class="token operator">:=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">syncWith</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">watchHandler</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resourceVersion<span class="token punctuation">,</span> resyncerrc<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>processLoop<span class="token operator">--</span><span class="token operator">&gt;</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token function">PopProcessFunc</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//HandleDeltas</span>
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>updateNotification<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>deleteNotification<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="控制器的协同工作原理-1"><a href="#控制器的协同工作原理-1" class="headerlink" title="控制器的协同工作原理"></a>控制器的协同工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的协同工作原理.png" alt="控制器的协同工作原理"></p>
<h4 id="通用-Controller"><a href="#通用-Controller" class="headerlink" title="通用 Controller"></a>通用 Controller</h4><ol>
<li>Job Controller：处理 Job</li>
<li>Pod AutoScaler：处理 Pod 的自动缩容/扩容</li>
<li>ReplicaSet：依据 ReplicaSet Spec 创建 Pod</li>
<li>Service Controller：为 LoadBalancer type 的 Service 创建 LB VIP</li>
<li>ServiceAccount Controller：确保 ServiceAccount 在当前 Namepsace 存在</li>
<li>StatefulSet Controller：处理 StatefulSet 中的 Pod</li>
<li>Volume Controller：依据 PV spec 创建 Volume</li>
<li>Resource Quota Controller：在用户使用资源之后，更新状态</li>
<li>Namespace Controller：保证 Namespace 删除时，该 Namespace 下的所有资源都先被删除</li>
<li>Replication Controller（后改名为 ReplicaSet）：创建 RC 后，负责创建 Pod</li>
<li>Node Controller（即 NodeLifeCycleController）：维护 Node 状态，处理 evict 请求等</li>
<li>Daemon Controller：依据 DaemonSet 创建 Pod</li>
<li>Deployment Controller：依据 Deployment spec 创建 ReplicaSet</li>
<li>Endpoint Controller：依据 Service spec 创建 Endpoint，依据 Pod ip 更新 Endpoint</li>
<li>Garbage Collector：处理级联删除，比如删除 Deployment 的同时删除 ReplicaSet 以及 Pod。（根据对象中的 ownerReferences 可以算出对象的依赖关系，可以使用 <code>kubectl delete daemonset nginx-ds --cascade=orphan</code> 来保留级联资源）</li>
<li>CronJob Controller：处理 CronJob</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/namespace_controller-go-04eb871906fa484ebb17c4a70442ecc8">namespace_controller.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">discoverResourcesFn <span class="token operator">:=</span> namespaceKubeClient<span class="token punctuation">.</span><span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServerPreferredNamespacedResources<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fetch all api resources</span>
    all<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ServerPreferredResources</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        serverGroupList<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">ServerGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        groupVersionResources<span class="token punctuation">,</span> failedGroups <span class="token operator">:=</span> <span class="token function">fetchGroupVersionResources</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> serverGroupList<span class="token punctuation">)</span>
        apiResourceList<span class="token punctuation">,</span> ok <span class="token operator">:=</span> groupVersionResources<span class="token punctuation">[</span>groupVersion<span class="token punctuation">]</span>

<span class="token function">NewNamespaceController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    namespaceController <span class="token operator">:=</span> <span class="token operator">&amp;</span>NamespaceController<span class="token punctuation">{</span>
        queue<span class="token punctuation">:</span>                      workqueue<span class="token punctuation">.</span><span class="token function">NewNamedRateLimitingQueue</span><span class="token punctuation">(</span><span class="token function">nsControllerRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"namespace"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        namespacedResourcesDeleter<span class="token punctuation">:</span> deletion<span class="token punctuation">.</span><span class="token function">NewNamespacedResourcesDeleter</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadataClient<span class="token punctuation">,</span> kubeClient<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> discoverResourcesFn<span class="token punctuation">,</span> finalizerToken<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    namespaceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                namespace <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
                namespaceController<span class="token punctuation">.</span><span class="token function">enqueueNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
<span class="token function">Run</span><span class="token punctuation">(</span>workers <span class="token builtin">int</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>nm<span class="token punctuation">.</span>worker<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            key<span class="token punctuation">,</span> quit <span class="token operator">:=</span> nm<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            err <span class="token operator">:=</span> nm<span class="token punctuation">.</span><span class="token function">syncNamespaceFromKey</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            namespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> nm<span class="token punctuation">.</span>lister<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            nm<span class="token punctuation">.</span>namespacedResourcesDeleter<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>namespace<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token comment">//func (d *namespacedResourcesDeleter) Delete(nsName string) error</span>
                namespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span>nsClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nsName<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> namespace<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span>
                <span class="token punctuation">}</span>
            d<span class="token punctuation">.</span><span class="token function">deleteAllContent</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                resources<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">discoverResourcesFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                gvrDeletionMetadata<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">deleteAllContentForGroupVersionResource</span><span class="token punctuation">(</span>gvr<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> namespaceDeletedAt<span class="token punctuation">)</span>
                deletableResources <span class="token operator">:=</span> discovery<span class="token punctuation">.</span><span class="token function">FilteredBy</span><span class="token punctuation">(</span>discovery<span class="token punctuation">.</span>SupportsAllVerbs<span class="token punctuation">{</span>Verbs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"delete"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resources<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h5><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#limitations">StatefulSets currently require a Headless Service to be responsible for the network identity of the Pods. You are responsible for creating this Service.</a></p>
<p>Stateful Set 需要配置一个 Headless Service 来一起使用。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/controller-manager/statefulset.yaml">https://github.com/kibaamor/101/blob/master/module7/controller-manager/statefulset.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 的更新策略也与 Deployment 不同。</p>
<p>Deployment 的更新策略：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 的更新策略：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 升级时会先升级编号小于等于 partition 的 Pod，等待人工确认后，并需要手动调整 partition 的值才会继续更新。</p>
<h5 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h5><p>每个 Node 一个 Pod</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/controller-manager/daemonset.yaml">https://github.com/kibaamor/101/blob/master/module7/controller-manager/daemonset.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ds
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Daemon Set 的更新策略用的是绝对值</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DaemonSet 与 Deployment 控制过程也不同：</p>
<ul>
<li>Deployment 是 Deployment -&gt; ReplicaSet -&gt; Pod</li>
<li>Daemon Set 是 Controller Revisions &lt;- <strong>Daemon Set</strong> -&gt; Pod </li>
</ul>
<blockquote>
<p>StatefulSet 和 DaemonSet 则是类似的。</p>
</blockquote>
<p>另外 DaemonSet 创建出来的 Pod 和普通 Deployment 创建出来的 Pod 的 Toleration 也不同：</p>
<p>普通 Deployment 创建出来的 Pod 的 Toleration：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而 DaemonSet 创建出来的 Pod 的 Toleration：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/disk<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/memory<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/pid<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unschedulable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Cloud-Controller-Manager"><a href="#Cloud-Controller-Manager" class="headerlink" title="Cloud Controller Manager"></a>Cloud Controller Manager</h4><p>什么时候需要 Cloud Controller Manager</p>
<p>Cloud Controller Manager 自 Kubernetes 1.6 开始，从 kube-controller-manager 中分离出来，主要是因为 Cloud Controller Manager 玩玩需要跟企业 Cloud 做深度集成，Release Cycle 跟 Kubernetes 相对独立。</p>
<p>与 Kubernetes 核心管理组件一起升级是一件费时费力的事。</p>
<p>通常 Cloud Controller Manager 需要：</p>
<ul>
<li>认证授权：企业 Cloud 往往需要认证信息，Kubernetes 需要与 Cloud API 通信，需要获取 Cloud 系统里的 ServiceAccount。</li>
<li>Cloud Controller Manager 本身作为一个用户态的 Component，需要在 Kubernetes 中有正确的 RBAC 设置，获得资源操作权限。</li>
<li>高可用：需要通过 Leader Election 来确保 Cloud Controller Manager 高可用。</li>
</ul>
<h4 id="Cloud-Controller-Manager-的配置"><a href="#Cloud-Controller-Manager-的配置" class="headerlink" title="Cloud Controller Manager 的配置"></a>Cloud Controller Manager 的配置</h4><p>Cloud Controller Manager 是从老版本的 API Server 分离出来的。</p>
<blockquote>
<p>kube-apiserver 和 kube-controller-manager 中一定不能指定 cloud-provider，否则会加载内置的 Cloud Controller Manager。</p>
<p>kubelet 要配置 <code>--cloud-provider=external</code></p>
</blockquote>
<p>Cloud Controller Manager 主要支持：</p>
<ol>
<li>Node Controller：访问 Cloud API，来更新 Node 状态；在 Cloud 删除该节点后，从 Kubernetes 删除 Node；</li>
<li>Service Controller：负责为 LoadBalancer 类型的服务配置 LB VIP；</li>
<li>Route Controller：在 Cloud 环境配置路由；</li>
<li>可以自定义任何需要的 Cloud Controller。</li>
</ol>
<h4 id="需要定制的-Cloud-Controller-Manager"><a href="#需要定制的-Cloud-Controller-Manager" class="headerlink" title="需要定制的 Cloud Controller Manager"></a>需要定制的 Cloud Controller Manager</h4><ul>
<li>Ingress Controller</li>
<li>Service Controller</li>
<li>自主研发的 Controller，比如之前提到的：<ul>
<li>RBAC Controller</li>
<li>Account Controller</li>
</ul>
</li>
</ul>
<h4 id="来自生产的经验"><a href="#来自生产的经验" class="headerlink" title="来自生产的经验"></a>来自生产的经验</h4><p>保护好 Controller Manager 的 kubeconfig：</p>
<ol>
<li>此 kubeconfig 拥有所有资源的所有操作权限，防止普通用户通过 <code>kubectl exec kube-controller-manager cat</code> 获取该文件</li>
<li>用户可能做任何你想象不到的操作，然后来找你 Support</li>
</ol>
<p>Pod Evict 后 IP 发生变化，但 Endpoint 中的 Address 更新失败：</p>
<ol>
<li>分析 Stacktrace 发现 Endpoint 在更新 LoadBalancer 时调用 gophercloud 连接 hang 住，导致 Endpoint Worker 线程全部卡死</li>
</ol>
<h4 id="确保-Scheduler-和-Controller-的高可用"><a href="#确保-Scheduler-和-Controller-的高可用" class="headerlink" title="确保 Scheduler 和 Controller 的高可用"></a>确保 Scheduler 和 Controller 的高可用</h4><p>Leaer Election</p>
<p>Kubernetes 提供基于 ConfigMap 和 Endpoint 的 Leader Election 类库</p>
<p>Kubernetes 采用 Leader Election 模式启动 Component 后，会创建对应 Endpoint，并把当前的 Leader 信息 annotate 到 Endpoint 上</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">control-plane.alpha.kubernetes.io/leader</span><span class="token punctuation">:</span> <span class="token string">'{"holderIdentity":"minikube","leaseDurationSeconds":15,"acquireTime":"2018-04-05T17:31:29Z","renewTime":"2018-04-05T17:31:29Z","leaderTransitions":0}'</span>
    <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token datetime number">2018-04-05T17:31:29Z</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
    <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"138930"</span>
    <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /api/v1/namespaces/kube<span class="token punctuation">-</span>system/endpoints/kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">uid</span><span class="token punctuation">:</span> 2d12578d<span class="token punctuation">-</span>38f7<span class="token punctuation">-</span>11e8<span class="token punctuation">-</span>8df0<span class="token punctuation">-</span><span class="token number">0800275259e5</span>
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span> <span class="token null important">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectrl -n kube-system get ep k8s.io-minikube-hostpath -oyaml
apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="token string">'{"holderIdentity":"minikube_0989f3d2-ce87-471a-a6b6-def44e83738c","leaseDurationSeconds":15,"acquireTime":"2024-05-10T07:34:27Z","renewTime":"2024-05-10T08:07:48Z","leaderTransitions":1}'</span>
    kubectl.kubernetes.io/last-applied-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"v1"</span>,<span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"Endpoints"</span>,<span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"annotations"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{</span><span class="token string">"addonmanager.kubernetes.io/mode"</span><span class="token builtin class-name">:</span><span class="token string">"Reconcile"</span><span class="token punctuation">}</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s.io-minikube-hostpath"</span>,<span class="token string">"namespace"</span><span class="token builtin class-name">:</span><span class="token string">"kube-system"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  creationTimestamp: <span class="token string">"2024-05-07T09:54:02Z"</span>
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
  name: k8s.io-minikube-hostpath
  namespace: kube-system
  resourceVersion: <span class="token string">"221393"</span>
  uid: 2a2100dd-4038-4658-adf7-553bc1c0596c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以通过下面的命令来获取</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get lease
NAME                                   HOLDER                                                                      AGE
apiserver-eqt674mfxb4j56mrjjkoe7b7ii   apiserver-eqt674mfxb4j56mrjjkoe7b7ii_619ab684-7564-4019-ae1f-a44bd256bcce   19m

$ kubectl -n kube-system get lease apiserver-eqt674mfxb4j56mrjjkoe7b7ii -oyaml
apiVersion: coordination.k8s.io/v1
kind: Lease
metadata:
  creationTimestamp: <span class="token string">"2024-05-10T14:53:36Z"</span>
  labels:
    apiserver.kubernetes.io/identity: kube-apiserver
    kubernetes.io/hostname: minikube
  name: apiserver-eqt674mfxb4j56mrjjkoe7b7ii
  namespace: kube-system
  resourceVersion: <span class="token string">"61178"</span>
  uid: f1b44c05-136f-491e-94c9-5bef5da4329a
spec:
  holderIdentity: apiserver-eqt674mfxb4j56mrjjkoe7b7ii_619ab684-7564-4019-ae1f-a44bd256bcce
  leaseDurationSeconds: <span class="token number">3600</span>
  renewTime: <span class="token string">"2024-05-10T15:13:28.775201Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LeaderElection.png" alt="LeaderElection"></p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kubelet-go-c3b5cf9bbf4b4e3098720f61efb15e0e">kubelet.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">NewKubeletCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
kubeletDeps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">UnsecuredDependencies</span><span class="token punctuation">(</span>kubeletServer<span class="token punctuation">,</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  plugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ProbeVolumePlugins</span><span class="token punctuation">(</span>featureGate<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">Run</span><span class="token punctuation">(</span>kubeletServer<span class="token punctuation">,</span> kubeletDeps<span class="token punctuation">,</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  <span class="token function">run</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> featureGate<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
    kubeDeps<span class="token punctuation">.</span>ContainerManager<span class="token punctuation">,</span> err <span class="token operator">=</span> cm<span class="token punctuation">.</span><span class="token function">NewContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// init runtime service(CRI), -container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///var/containerd/containerd.sock</span>
    kubelet<span class="token punctuation">.</span><span class="token function">PreInitRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      remote<span class="token punctuation">.</span><span class="token function">NewRemoteRuntimeService</span><span class="token punctuation">(</span>remoteRuntimeEndpoint<span class="token punctuation">,</span> kubeCfg<span class="token punctuation">.</span>RuntimeRequestTimeout<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
    <span class="token function">RunKubelet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> s<span class="token punctuation">.</span>RunOnce<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      <span class="token function">createAndInitKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        kubelet<span class="token punctuation">.</span><span class="token function">NewMainKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
          <span class="token function">makePodSourceConfig</span><span class="token punctuation">(</span>kubeCfg<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> bootstrapCheckpointPath<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            updatechannel <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">Channel</span><span class="token punctuation">(</span>kubetypes<span class="token punctuation">.</span>ApiserverSource<span class="token punctuation">)</span>
          klet <span class="token operator">:=</span> <span class="token operator">&amp;</span>Kubelet<span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token comment">//*******init volume plugins</span>
          runtime<span class="token punctuation">,</span> err <span class="token operator">:=</span> kuberuntime<span class="token punctuation">.</span><span class="token function">NewKubeGenericRuntimeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token function">NewInitializedVolumePluginMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            kvh<span class="token punctuation">.</span>volumePluginMgr<span class="token punctuation">.</span><span class="token function">InitPlugins</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> prober<span class="token punctuation">,</span> kvh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      <span class="token function">startKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        k<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>podCfg<span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
          <span class="token comment">//*******run volume manager, and reconcile function would attach volume for attachable plugin and mount volume</span>
          <span class="token keyword">go</span> kl<span class="token punctuation">.</span>volumeManager<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>kl<span class="token punctuation">.</span>sourcesReady<span class="token punctuation">,</span> wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            vm<span class="token punctuation">.</span>desiredStateOfWorldPopulator<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>sourcesReady<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              populatorLoop<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                dswp<span class="token punctuation">.</span><span class="token function">findAndAddNewPods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  dswp<span class="token punctuation">.</span><span class="token function">processPodVolumes</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> mountedVolumesForPod<span class="token punctuation">,</span> processedVolumesForFSResize<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    mounts<span class="token punctuation">,</span> devices <span class="token operator">:=</span> util<span class="token punctuation">.</span><span class="token function">GetPodVolumeNames</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                    dswp<span class="token punctuation">.</span><span class="token function">createVolumeSpec</span><span class="token punctuation">(</span>podVolume<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> mounts<span class="token punctuation">,</span> devices<span class="token punctuation">)</span>
                    dswp<span class="token punctuation">.</span>desiredStateOfWorld<span class="token punctuation">.</span><span class="token function">AddPodToVolume</span><span class="token punctuation">(</span>uniquePodName<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> volumeSpec<span class="token punctuation">,</span> podVolume<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> volumeGidValue<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      dsw<span class="token punctuation">.</span>volumesToMount<span class="token punctuation">[</span>volumeName<span class="token punctuation">]</span> <span class="token operator">=</span> volumeToMount<span class="token punctuation">{</span><span class="token punctuation">}</span>
            vm<span class="token punctuation">.</span>reconciler<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>	
              <span class="token function">reconciliationLoopFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">// reconcile every 100 ms</span>
                mountAttachVolumes<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  rc<span class="token punctuation">.</span>desiredStateOfWorld<span class="token punctuation">.</span><span class="token function">GetVolumesToMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  rc<span class="token punctuation">.</span>operationExecutor<span class="token punctuation">.</span><span class="token function">AttachVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>	<span class="token comment">// attachable plugin, e.g. 	CSI plugin</span>
                    operationGenerator<span class="token punctuation">.</span><span class="token function">GenerateAttachVolumeFunc</span><span class="token punctuation">(</span>volumeToAttach<span class="token punctuation">,</span> actualStateOfWorld<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  rc<span class="token punctuation">.</span>operationExecutor<span class="token punctuation">.</span><span class="token function">MountVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>  <span class="token comment">// volume need to mount, like ceph, configmap, emptyDir</span>
                    oe<span class="token punctuation">.</span>operationGenerator<span class="token punctuation">.</span><span class="token function">GenerateMapVolumeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      volumePlugin<span class="token punctuation">,</span> err <span class="token operator">:=</span> og<span class="token punctuation">.</span>volumePluginMgr<span class="token punctuation">.</span><span class="token function">FindPluginBySpec</span><span class="token punctuation">(</span>volumeToMount<span class="token punctuation">.</span>VolumeSpec<span class="token punctuation">)</span>
                      volumePlugin<span class="token punctuation">.</span><span class="token function">NewMounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      volumeMounter<span class="token punctuation">.</span><span class="token function">SetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          kl<span class="token punctuation">.</span><span class="token function">syncLoop</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> kl<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            kl<span class="token punctuation">.</span><span class="token function">syncLoopIteration</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> syncTicker<span class="token punctuation">.</span>C<span class="token punctuation">,</span> housekeepingTicker<span class="token punctuation">.</span>C<span class="token punctuation">,</span> plegCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              <span class="token comment">//*******handle pod creation event</span>
              handler<span class="token punctuation">.</span><span class="token function">HandlePodAdditions</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Pods<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                kl<span class="token punctuation">.</span>podManager<span class="token punctuation">.</span><span class="token function">AddPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                kl<span class="token punctuation">.</span><span class="token function">canAdmitPod</span><span class="token punctuation">(</span>activePods<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token comment">// check admit, if admit check fail, it will error out</span>
                kl<span class="token punctuation">.</span><span class="token function">dispatchWork</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> kubetypes<span class="token punctuation">.</span>SyncPodCreate<span class="token punctuation">,</span> mirrorPod<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  kl<span class="token punctuation">.</span>podWorkers<span class="token punctuation">.</span><span class="token function">UpdatePod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    p<span class="token punctuation">.</span><span class="token function">managePodLoop</span><span class="token punctuation">(</span>podUpdates<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      p<span class="token punctuation">.</span><span class="token function">syncPodFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                        kubelet<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">syncPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                          runnable <span class="token operator">:=</span> kl<span class="token punctuation">.</span><span class="token function">canRunPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span> <span class="token comment">// check soft admin, pod will be pending if check fails</span>
                          kl<span class="token punctuation">.</span>runtimeState<span class="token punctuation">.</span><span class="token function">networkErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// check network plugin status</span>
                          kl<span class="token punctuation">.</span>containerManager<span class="token punctuation">.</span><span class="token function">UpdateQOSCgroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                          kl<span class="token punctuation">.</span><span class="token function">makePodDataDirs</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                          kl<span class="token punctuation">.</span>volumeManager<span class="token punctuation">.</span><span class="token function">WaitForAttachAndMount</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                          <span class="token punctuation">(</span>kubeGenericRuntimeManager<span class="token punctuation">)</span>kl<span class="token punctuation">.</span>containerRuntime<span class="token punctuation">.</span><span class="token function">SyncPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                            m<span class="token punctuation">.</span><span class="token function">computePodActions</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> podStatus<span class="token punctuation">)</span> <span class="token comment">// create sandbox container?</span>
                            m<span class="token punctuation">.</span><span class="token function">createPodSandbox</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> podContainerChanges<span class="token punctuation">.</span>Attempt<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                              m<span class="token punctuation">.</span>osInterface<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>podSandboxConfig<span class="token punctuation">.</span>LogDirectory<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
                              <span class="token comment">//*******calling CRI</span>
                              m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">RunPodSandbox</span><span class="token punctuation">(</span>podSandboxConfig<span class="token punctuation">,</span> runtimeHandler<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span><span class="token comment">// k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go</span>
                                c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/RunPodSandbox"</span><span class="token punctuation">)</span> <span class="token comment">// call remote runtime service which is served by containerd</span>
                              <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"init container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                <span class="token function">startContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Containers<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                <span class="token function">startContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                  m<span class="token punctuation">.</span>imagePuller<span class="token punctuation">.</span><span class="token function">EnsureImageExists</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> pullSecrets<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.ImageService/PullImage"</span>
                                  m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">CreateContainer</span><span class="token punctuation">(</span>podSandboxID<span class="token punctuation">,</span> containerConfig<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/CreateContainer"</span><span class="token punctuation">)</span>
                                  m<span class="token punctuation">.</span>internalLifecycle<span class="token punctuation">.</span><span class="token function">PreStartContainer</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> containerID<span class="token punctuation">)</span> <span class="token comment">// set cpu set</span>
                                  m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">StartContainer</span><span class="token punctuation">(</span>containerID<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/StartContainer"</span><span class="token punctuation">)</span>

containerd
server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>service<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  runtime<span class="token punctuation">.</span><span class="token function">RegisterRuntimeServiceServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> instrumented<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      s<span class="token punctuation">.</span><span class="token function">RegisterService</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_RuntimeService_serviceDesc<span class="token punctuation">,</span> srv<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        Handler<span class="token punctuation">:</span>    _RuntimeService_RunPodSandbox_Handler<span class="token punctuation">,</span>	<span class="token comment">// api.pb.go</span>
        srv<span class="token punctuation">.</span><span class="token punctuation">(</span>RuntimeServiceServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RunPodSandbox</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">//"/runtime.v1alpha2.RuntimeService/RunPodSandbox"</span>
          <span class="token function">RunPodSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">// pkg/server/sandbox_run.go</span>
            sandboxstore<span class="token punctuation">.</span><span class="token function">NewSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">ensureImageExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">getSandboxRuntime</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">GetRuntimeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            netns<span class="token punctuation">.</span><span class="token function">NewNetNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">setupPodNetwork</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sandbox<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              c<span class="token punctuation">.</span>netPlugin<span class="token punctuation">.</span><span class="token function">Setup</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                network<span class="token punctuation">.</span><span class="token function">Attach</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  n<span class="token punctuation">.</span>cni<span class="token punctuation">.</span><span class="token function">AddNetworkList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> n<span class="token punctuation">.</span>config<span class="token punctuation">,</span> ns<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>ifName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    c<span class="token punctuation">.</span><span class="token function">addNetwork</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> list<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> list<span class="token punctuation">.</span>CNIVersion<span class="token punctuation">,</span> net<span class="token punctuation">,</span> result<span class="token punctuation">,</span> rt<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span><span class="token comment">// for each network plugin</span>
                      c<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">FindInPath</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Network<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
                      <span class="token function">buildOneConfig</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cniVersion<span class="token punctuation">,</span> net<span class="token punctuation">,</span> prevResult<span class="token punctuation">,</span> rt<span class="token punctuation">)</span>
                      invoke<span class="token punctuation">.</span><span class="token function">ExecPluginWithResult</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pluginPath<span class="token punctuation">,</span> newConf<span class="token punctuation">.</span>Bytes<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> rt<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>exec<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>sandboxRootDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>volatileSandboxRootDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">setupSandboxFiles</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
            container<span class="token punctuation">.</span><span class="token function">NewTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> containerdio<span class="token punctuation">.</span>NullIO<span class="token punctuation">,</span> taskOpts<span class="token operator">...</span><span class="token punctuation">)</span>
            task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">TaskService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                s<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  l<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                  rtime<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    b <span class="token operator">:=</span> <span class="token function">shimBinary</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Runtime<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdTTRPCAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>events<span class="token punctuation">,</span> m<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span>
                    b<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    shim<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"containerd.task.v2.Task"</span><span class="token punctuation">,</span> <span class="token string">"Create"</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">)</span>

  runtime<span class="token punctuation">.</span><span class="token function">RegisterImageServiceServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> instrumented<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubelet-架构"><a href="#kubelet-架构" class="headerlink" title="kubelet 架构"></a>kubelet 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet架构.png" alt="kubelet架构"></p>
<h4 id="kubelet-管理-Pod-的核心流程"><a href="#kubelet-管理-Pod-的核心流程" class="headerlink" title="kubelet 管理 Pod 的核心流程"></a>kubelet 管理 Pod 的核心流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet管理Pod的核心流程.png" alt="kubelet管理Pod的核心流程"></p>
<h4 id="kubelet-1"><a href="#kubelet-1" class="headerlink" title="kubelet"></a>kubelet</h4><p>每个节点上都运行一个 kubelet 服务进程，默认监听 10250 端口。</p>
<ul>
<li>接收并执行 master 发来的指令</li>
<li>管理 Pod 及 Pod 中的容器</li>
<li>每个 kubelet 进程会在 API Server 上注册节点自身信息，定期向 master 节点汇报节点的资源使用情况，并通过 cAdvisor 监控节点和容器的资源</li>
</ul>
<h4 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h4><p>节点管理主要是节点自注册和节点状态更新：</p>
<ul>
<li>kubelet 可以通过设置启动参数 <code>--register-node</code> 来确定是否向 API Server 注册自己</li>
<li>如果 kubelet 没有选择自注册模式，则需要用户自己配置 Node 资源信息，同时需要告知 kubelet 集群上的 API Server 的位置</li>
<li>kubelet 在启动时通过 API Server 注册节点信息，并定时向 API Server发送节点新消息，API Server 在接收到新消息后，将信息写入 etcd</li>
</ul>
<h4 id="Pod-管理"><a href="#Pod-管理" class="headerlink" title="Pod 管理"></a>Pod 管理</h4><p>获取 Pod 清单：</p>
<ul>
<li>文件：启动参数 <code>--config</code> 指定的配置目录下的文件（默认 <code>/etc/kubernetes/manifests</code>）。该文件每 20 秒重新检查一次（可配置）</li>
<li>HTTP endpoint（URL）：启动参数 <code>--manifest-url</code> 设置。每 20 秒检查一次这个端点（可配置）</li>
<li>API Server：通过 API Server 监听 etcd 目录，同步 Pod 清单</li>
<li>HTTP Server：kubelet 侦听 HTTP 请求，并响应简单的 API 以提交新的 Pod 清单</li>
</ul>
<h4 id="Pod-启动流程"><a href="#Pod-启动流程" class="headerlink" title="Pod 启动流程"></a>Pod 启动流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod启动流程.png" alt="Pod启动流程"></p>
<p>图中 RunPodSandbox 中 Sandbox 的意义：和 pause contain 有关。pod 不是直接启动的，而是先使用 pause 镜像启动 sandbox container 并设置好（共享 net、pid 等）后，再启动用户定义的 container。</p>
<h4 id="kubelet-启动-Pod-的流程"><a href="#kubelet-启动-Pod-的流程" class="headerlink" title="kubelet 启动 Pod 的流程"></a>kubelet 启动 Pod 的流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet启动Pod的流程.png" alt="kubelet启动Pod的流程"></p>
<h3 id="CRI"><a href="#CRI" class="headerlink" title="CRI"></a>CRI</h3><p>容器运行时（Container Runtime），运行于 Kubernetes（k8s）集群的每个节点中，负责容器的整个生命周期。其中 Docker 是目前应用最广的。随着容器云的发展，越来越多的容器运行时涌现。为了解决这些容器运行时和 Kubernetes 的集成问题，在 Kubernetes 1.5 版本中，社区推出了 CRI（Container Runtime Interface，容器运行时接口）以支持更多的容器运行时。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI.png" alt="CRI"></p>
<p>CRI 是 Kubernetes 定义的一组 gRPC 服务。kubelet 作为客户端，基于 gRPC 框架，通过 Socket 和容器运行时通信。它包括两类服务：镜像服务（Image Service）和运行时服务（Runtime Service）。镜像服务提供下载、检查和删除镜像的远程程序调用。运行时服务包括用于管理容器生命周期，以及与容器交互的调用（exec / attach / port-forward）的远程程序调用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI2.png" alt="CRI2"></p>
<h4 id="运行时的层级"><a href="#运行时的层级" class="headerlink" title="运行时的层级"></a>运行时的层级</h4><p>Dockershim，containerd 和 CRI-O 都是遵循 CRI 的容器运行时，我们称他们为 <strong>高层级运行时（High-Level Runtime）</strong> 。</p>
<p>OCI（Open Container Initiative，开发容器计划）定义了创建容器的格式和运行时的开源行业标准，包括镜像规范（Image Specification）和运行时规范（Runtime Specification）。</p>
<p>镜像规范定义了 OCI 镜像的标准。高层级运行时将会下载一个 OCI 镜像，并把它解压成 OCI 运行时文件系统包（filesystem bundle）。</p>
<p>运行时规范则描述了如何从 OCI 运行时文件系统包运行容器，并定义它的配置、运行环境和生命周期。如何为新容器设置命名空间（namespaces）和控制组（cgroups），以及挂载根文件系统等等操作，都是在这里定义的。它的一个参考实现就 runC。我们称其为 <strong>低层级运行时（Low-Level Runtime）</strong>。除 runC 以外，也有以后很多其他的运行时遵循 OCI 标准，例如 kata-runtime。</p>
<h4 id="CRI-1"><a href="#CRI-1" class="headerlink" title="CRI"></a>CRI</h4><p>容器运行时是真正起删和管理容器的组件。容器运行时可以分为高层和低层的运行时。高层运行时主要包括 Docker、containerd 和 CRI-O，低层的运行时，包含了 runC，kata 和 gVisor。低层运行时 kata 和 gVisor 都还处于小规模落地或者实验阶段，其生态成熟度和使用案例都比较欠缺，所以除非有特殊的需求，否则 runC 几乎是必然的选择。因此在对容器运行时的选择上，主要是聚焦于上层运行时的选择。</p>
<p>Docker 内部关于容器运行时功能的核心组件是 containerd，后来 containerd 也可以直接和 kubelet 通过 CRI 对接，独立在 Kubernetes 中使用。相对 Docker 而言，containerd 减少了 Docker 所需的处理模块 Dockerd 和 Docker-shim，并且对 Docker 支持的存储驱动进行了优化，因此在容器的创建启动停止和删除，以及对镜像的拉取上，都具有性能上的优势。架构的简化同时也带来了维护的便利。当然 Docker 也具有很多 containerd 不具有的功能，例如支持 zfs 存储驱动，支持对日志的大小和文件限制，在以 overlayfs2 做存储驱动的情况下，可以通过 xfs_quota 来对容器的可写层进行大小限制等。尽管如此，containerd 目前也基本上能够满足容器的众多管理需求，所以将它作为运行时的也越来越多。</p>
<p>kubelet 和运行时的关系：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet和运行时的关系.png" alt="kubelet和运行时的关系"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI3.png" alt="CRI3"></p>
<h4 id="开源运行时的比较"><a href="#开源运行时的比较" class="headerlink" title="开源运行时的比较"></a>开源运行时的比较</h4><p>Docker 的多层封装和调用，导致其在可维护性上略逊一筹，增加了线上问题的定位难度；几乎除了重启 Docker，我们就毫无他法了。</p>
<p>containerd 和 CRI-O 的方案比起 Docker 简洁很多。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/开源运行时的比较.png" alt="开源运行时的比较"></p>
<h4 id="Docker-和-containerd-的差异细节"><a href="#Docker-和-containerd-的差异细节" class="headerlink" title="Docker 和 containerd 的差异细节"></a>Docker 和 containerd 的差异细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Docker和containerd的差异细节.png" alt="Docker和containerd的差异细节"></p>
<blockquote>
<p>将 runtime 从 docker 切换到 containerd <a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/cri/docker2containerd.md">https://github.com/kibaamor/101/blob/master/module7/cri/docker2containerd.md</a></p>
</blockquote>
<h4 id="多种运行时性能比较"><a href="#多种运行时性能比较" class="headerlink" title="多种运行时性能比较"></a>多种运行时性能比较</h4><p>containerd 在各个方面都表现良好，除了启动容器这项。从总用时来看，containerd 的用时还是要比 CRI-O 要短的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多种运行时性能比较.png" alt="多种运行时性能比较"></p>
<h4 id="运行时优劣对比"><a href="#运行时优劣对比" class="headerlink" title="运行时优劣对比"></a>运行时优劣对比</h4><ol>
<li>功能性来讲，containerd 和 CRI-O 都符合 CRI 和 OCI 的标准</li>
<li>在稳定性上，containerd 略胜一筹</li>
<li>从性能上讲，containerd 胜出</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/运行时优劣对比.png" alt="运行时优劣对比"></p>
<h3 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h3><p><a target="_blank" rel="noopener" href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-2-a07f5bf0ff14">https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-2-a07f5bf0ff14</a></p>
<p>Kubernetes 网络模型设计的基础原则是：</p>
<ul>
<li>所有的 Pod 能够不通过 NAT 就能相互访问</li>
<li>所有的节点能够不通过 NAT 就能相互访问</li>
<li>容器内看见的 IP 地址和外部组件看到的容器 IP 是一样的</li>
</ul>
<p>Kubernetes 的集群里，IP 地址是以 Pod 为单位进行分配的，每个 Pod 都拥有一个独立的 IP 地址。一个 Pod 内部的所有容器共享一个网络栈，即宿主机上的一个网络命名空间，包括它们的 IP 地址、网络设备、配置等都是共享的。也就是说，Pod 里面的所有容器都能通过 <code>localhost:port</code> 来连接对方。在 Kubernetes 中，提供一个轻量的通用容器网络接口 CNI（Container Network Interface），专门用于设置和删除容器的网络连通性。容器运行时通过 CNI 调用网络插件来完成容器的网络设置。</p>
<h4 id="CNI-插件分类和常见插件"><a href="#CNI-插件分类和常见插件" class="headerlink" title="CNI 插件分类和常见插件"></a>CNI 插件分类和常见插件</h4><p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins">https://github.com/containernetworking/plugins</a></p>
<ul>
<li>IPAM（IP Allocation Manager）：IP 地址分配</li>
<li>主插件：网卡设置<ul>
<li>bridge：创建一个网桥，并把主机端口和容器端口插入网桥</li>
<li>ipvlan：为容器添加 ipvlan 网口</li>
<li>loopback：设置 loopback 网口</li>
</ul>
</li>
<li>Meta：附加功能<ul>
<li>portmap：设置主机端口和容器端口映射</li>
<li>bandwidth：利用 Linux Traffic Control 限流</li>
<li>firewall：通过 iptables 或 firewalld 为容器设置防火墙规则</li>
</ul>
</li>
</ul>
<h4 id="CNI-插件运行时机制"><a href="#CNI-插件运行时机制" class="headerlink" title="CNI 插件运行时机制"></a>CNI 插件运行时机制</h4><p>容器运行时在启动时会从 CNI 的配置目录中读取 Json 格式的配置文件，文件后缀为 “.conf”, “.conflist” 或 “.json”。如果配置目录中包含多个文件，一般情况下，会以名字排序选用第一个配置文件作为默认的网络配置，并加载获取其中指定的 CNI 插件名称和配置参数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件运行时机制.png" alt="CNI插件运行时机制"></p>
<h4 id="CNI-的运行机制"><a href="#CNI-的运行机制" class="headerlink" title="CNI 的运行机制"></a>CNI 的运行机制</h4><p>关于容器网络管理，容器运行时一般需要配置两个参数 <code>--cni-bin-dir</code> 和 <code>--cni-conf-dir</code>。有一种特殊情况，kubelet 内置的 Docker 作为容器运行时，是由 kubelet 来查找 CNI 插件的，运行插件来为容器设置网络，这两个参数应该配置在 kubelet 处：</p>
<ul>
<li><code>cni-bin-dir</code>：网络插件的可执行文件所在的目录。默认是<code>/opt/cni/bin</code>。</li>
<li><code>cni-conf-dir</code>：网络插件的配置文件所在目录。默认是<code>/etc/cni/net.d</code>。</li>
</ul>
<h4 id="CNI-插件设计考量"><a href="#CNI-插件设计考量" class="headerlink" title="CNI 插件设计考量"></a>CNI 插件设计考量</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件设计考量.png" alt="CNI插件设计考量"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件设计考量2.png" alt="CNI插件设计考量2"></p>
<h4 id="打通主机层网络"><a href="#打通主机层网络" class="headerlink" title="打通主机层网络"></a>打通主机层网络</h4><p>CNI 插件外，Kubernetes 还需要标准的 CNI 插件 lo，最低版本为 0.2.0 版本。网络插件除支持设置和清理 Pod 网络接口外，该插件还需要支持 Iptables。如果 kube-proxy 工作在 Iptables 模式，网络插件需要确保容器流量能使用 Iptables 转发。例如，如果网络插件将容器连接到 Linux 网桥，必须将 <code>net/bridge/bridge-nf-call-iptables</code> 参数 sysctl 设置为 1，网桥上数据包将遍历 Iptables 规则。如果插件不使用 Linux 桥接器（而是类似 Open vSwitch 或其他某种机制的插件），则赢确保容器流量被正确设置了路由。</p>
<h4 id="CNI-Plugin"><a href="#CNI-Plugin" class="headerlink" title="CNI Plugin"></a>CNI Plugin</h4><p>ContainerNetworking 组维护了一些 CNI 插件，包括网络接口创建的 bridge、ipvlan、loopback、macvlan、ptp、host-device 等，IP 地址分配的 DHCP、host-local 和 static，其他的 Flannel、tunning、portmap、firewall 等。</p>
<p>社区还有些第三方网络策略方面的插件，例如 Calico、Cilium 和 Weave 等。可用选项的多样性意味着大多数用户将能够找到适合当前需求和部署环境的 CNI 插件，并在情况变化时迅捷转换解决方案。</p>
<blockquote>
<p>目前最有前景的是 <a target="_blank" rel="noopener" href="https://github.com/cilium/cilium">https://github.com/cilium/cilium</a></p>
</blockquote>
<h4 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h4><p>Flannel 是由 CoreOS 开发的项目，是 CNI 插件早起的入门产品，简单易用。</p>
<p>Flannel 使用 Kubernetes 集群的现有 etcd 集群来存储其状态信息，从而不必提供专用的数据存储，只需要在每个节点上运行 flanneld 来守护进程。</p>
<p>每个节点都被分配一个子网，为该节点上的 Pod 分配 IP 地址。</p>
<p>同一个主机内的 Pod 可以使用网桥进行通信，而不同主机上的 Pod 将通过 flanneld 将其流量封装在 UDP 数据包中，以路由到适当的目的地。</p>
<p>封装方式默认和推荐的方法是使用 VXLAN，因为它具有良好的性能，并且比其他选项要少些人为干预。虽然使用 VXLAN 之类的技术封装的解决方案效果很好，但缺点就是该过程使流量跟踪变得困难。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlannelPlugin.png" alt="FlannelPlugin"></p>
<h4 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h4><p>Calico 以其性能、灵活性和网络策略而闻名，不仅涉及在主机和 Pod 之间提供网络连接，而且还涉及网络安全性和策略管理。</p>
<p>对于同网段通信，基于第 3 层，Calico 使用 BGP 路由协议在主机之间路由数据包，使用 BGP 路由协议也意味着数据包在主机之间移动时不需要包装在额外的封装层中。</p>
<p>对于跨网段通信，基于 IPinIP 使用虚拟网卡设备 tunl0，用一个 IP 数据包封装另一个 IP 数据包，外层 IP 数据包头的源地址为隧道入口设置的 IP 地址，目标地址为隧道出口设备的 IP 地址。</p>
<p>网络策略是 Calico 最受欢迎的功能之一，使用 ACLs 协议和 kube-proxy 来创建 iptables 过滤规则，从而实现隔离容器网络的目的。</p>
<p>此外，Calico 还可以与服务网格 Istio 集成，在服务网格层和网络基础结构层上解释和实施集群中工作负载的策略。这意味着你可以配置功能强大的规则，以描述 Pod 应该如何发送和接收流量，提高安全性及加强网络环境的控制。</p>
<p>Calico 属于完全分布式的横向扩展结构，允许开发人员和管理员快速和平稳地扩展部署规模。对于性能和功能（如网络策略）要求高的环境，Calico 是一个不错的选择。</p>
<h5 id="Calico-组件"><a href="#Calico-组件" class="headerlink" title="Calico 组件"></a>Calico 组件</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Calico组件.png" alt="Calico组件"></p>
<h5 id="Calico-初始化"><a href="#Calico-初始化" class="headerlink" title="Calico 初始化"></a>Calico 初始化</h5><p>配置和 CNI 二进制文件由 initContainer 推送</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> /opt/cni/bin/install
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_CONF_NAME
    <span class="token key atrule">value</span><span class="token punctuation">:</span> 10<span class="token punctuation">-</span>calico.conflist
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SLEEP
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NET_DIR
    <span class="token key atrule">value</span><span class="token punctuation">:</span> /etc/cni/net.d
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NETWORK_CONFIG
    <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
      <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> config
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_HOST
    <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.96.0.1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_PORT
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/calico/cni<span class="token punctuation">:</span>v3.20.1
  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Calico-配置一览"><a href="#Calico-配置一览" class="headerlink" title="Calico 配置一览"></a>Calico 配置一览</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">{</span>
  <span class="token key atrule">"name"</span><span class="token punctuation">:</span> <span class="token string">"k8s-pod-network"</span><span class="token punctuation">,</span>
  <span class="token key atrule">"cniVersion"</span><span class="token punctuation">:</span> <span class="token string">"0.3.1"</span><span class="token punctuation">,</span>
  <span class="token key atrule">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"datastore_type"</span><span class="token punctuation">:</span> <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"mtu"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token key atrule">"nodename_file_optional"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span>
      <span class="token key atrule">"log_level"</span><span class="token punctuation">:</span> <span class="token string">"Info"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"log_file_path"</span><span class="token punctuation">:</span> <span class="token string">"/var/log/calico/cni/cni.log"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"ipam"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico-ipam"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"assign_ipv4"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"asign_ipv6"</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"container_settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"allow_ip_forwarding"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"policy"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"k8s"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"kubernetes"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"k8s_api_root"</span><span class="token punctuation">:</span> <span class="token string">"https://10.96.0.1:443"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"kubeconfig"</span><span class="token punctuation">:</span> <span class="token string">"/etc/cni/net.d/calico-kubeconfig"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"bandwidth"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"bandwidth"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"portmap"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"snat"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
      <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"portMappings"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Calico-VXLAN"><a href="#Calico-VXLAN" class="headerlink" title="Calico VXLAN"></a>Calico VXLAN</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CalicoVXLAN.png" alt="CalicoVXLAN"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/cni/data-path.MD">https://github.com/kibaamor/101/blob/master/module7/cni/data-path.MD</a></p>
<h6 id="IPPool"><a href="#IPPool" class="headerlink" title="IPPool"></a>IPPool</h6><p>IPPool 用来定义一个集群的预定义 IP 段</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>ipv4<span class="token punctuation">-</span>ippool
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">blockSize</span><span class="token punctuation">:</span> <span class="token number">26</span> <span class="token comment"># 每个节点分多少个IP</span>
  <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 192.168.0.0/16
  <span class="token key atrule">ipipMode</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">natOutgoing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
  <span class="token key atrule">vxlanMode</span><span class="token punctuation">:</span> CrossSubnet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="IPAMBlock"><a href="#IPAMBlock" class="headerlink" title="IPAMBlock"></a>IPAMBlock</h5><p>IPAMBlock 用来定义每个主机预分配的 IP 段</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPAMBlock
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>119<span class="token punctuation">-</span>64<span class="token punctuation">-</span><span class="token number">26</span> <span class="token comment"># 最后的 26 就是 IPPool 里的 blockSize</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> host<span class="token punctuation">:</span>cadmin
  <span class="token key atrule">allocations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token null important">null</span>
  <span class="token punctuation">-</span> <span class="token number">0</span>
  <span class="token punctuation">-</span> <span class="token null important">null</span>
  <span class="token punctuation">-</span> <span class="token number">1</span>
  <span class="token punctuation">-</span> <span class="token number">2</span>
  <span class="token punctuation">-</span> <span class="token number">3</span>
  <span class="token key atrule">attributes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> vxlan<span class="token punctuation">-</span>tunnel<span class="token punctuation">-</span>addr<span class="token punctuation">-</span>cadmin
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">type</span><span class="token punctuation">:</span> vxlanTunnelAddress
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.6680d3883d6150e75ffbd031f86c689a97a5be0f260c6442b2bb46b567c2ca40
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>apiserver
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">pod</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>apisever<span class="token punctuation">-</span>77dffffcdf<span class="token punctuation">-</span>g2tcx
      <span class="token key atrule">timestamp</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>30 09<span class="token punctuation">:</span>46<span class="token punctuation">:</span>57.45651816 +0000 UTC
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.b10d7702bf334fc55a5e399a731ab3201ea9990a1e3bc79894abddd712646699
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>system
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">pod</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers<span class="token punctuation">-</span>bdd5f97c5<span class="token punctuation">-</span>554z5
      <span class="token key atrule">timestamp</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>30 09<span class="token punctuation">:</span>46<span class="token punctuation">:</span>57.502351346 +0000 UTC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="IPAMHandle"><a href="#IPAMHandle" class="headerlink" title="IPAMHandle"></a>IPAMHandle</h5><p>IPAMHandle 用来记录 IP 分配的具体细节（每个 Pod 一个）</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1kind<span class="token punctuation">:</span>IPAMHandle
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  name<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.8d756941d85c4998016b72c83f9c5a75512c82c052357daf0ec8e67365635d93
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">block</span><span class="token punctuation">:</span>
    192.168.119.64/26<span class="token punctuation">:</span><span class="token number">1</span>
  deleted<span class="token punctuation">:</span><span class="token boolean important">false</span>
  handlelD<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.8d75b941d85c4998016b72c83f9c5a75512c82c052357daf0ec8e67365635d93<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建-Pod-并查看-IP-配置情况"><a href="#创建-Pod-并查看-IP-配置情况" class="headerlink" title="创建 Pod 并查看 IP 配置情况"></a>创建 Pod 并查看 IP 配置情况</h5><p>容器 namespace</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ nsenter -t <span class="token number">720702</span> -n <span class="token function">ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
        valid lft forever preferred lft forever
<span class="token number">3</span>: ethO@if27: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER UP<span class="token operator">&gt;</span> mtu <span class="token number">1450</span> gdisc noqueue state UP groupdefault
    link/ether f2:86:d2:4f:1f:30 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet192.168.119.84/32 brd <span class="token number">192.168</span>.119.84 scope global eth0
      valid lft forever preferred lft forever

$ nsenter -t <span class="token number">720702</span>-n <span class="token function">ip</span> r
default via <span class="token number">169.254</span>.1.1 dev eth0
<span class="token number">169.254</span>.1.1 dev eth0 scope <span class="token function">link</span>

$ nsenter -t <span class="token number">720702</span> -n arp
Address     HWtype HWaddress            Flags Mask  Iface
<span class="token number">169.254</span>.1.1 ether  ee:ee:ee:ee:ee:ee    C           eth0
<span class="token number">10.0</span>.2.15   ether  ee:ee:ee:ee:ee:ee    C           eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主机 namespace</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> <span class="token function">link</span>
<span class="token number">27</span>: cali23a582ef038@if3:<span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER UP<span class="token operator">&gt;</span>mtu <span class="token number">1450</span> qdiscnoqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">9</span>
    inet6 fe80::ecee:eeff:feee:eeee/64 scope <span class="token function">link</span>
        valid lft forever preferred lft forever
        
$ <span class="token function">ip</span> route
<span class="token number">192.168</span>.119.84 dev cali23a582ef038scope <span class="token function">link</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CNI-Plugin-的对比"><a href="#CNI-Plugin-的对比" class="headerlink" title="CNI Plugin 的对比"></a>CNI Plugin 的对比</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNIPlugin的对比.png" alt="CNIPlugin的对比"></p>
<h3 id="CSI"><a href="#CSI" class="headerlink" title="CSI"></a>CSI</h3><h4 id="容器运行时存储"><a href="#容器运行时存储" class="headerlink" title="容器运行时存储"></a>容器运行时存储</h4><blockquote>
<p>容器运行时存储不建议写数据，甚至不建议写日志，它基于 OverlayFS ，它的主要目的是挂载 rootfs 以启动容器，读写性能其实不高。需要写数据时应该外挂存储。</p>
</blockquote>
<ul>
<li>除外挂存储卷外，容器启动后，运行时所需文件系统性能直接影响容器性能</li>
<li>早起的 Docker 采用 Device Mapper 作为容器运行时存储驱动，因为 OverlayFS 尚未合并进 Kernel</li>
<li>目前 Docker 和 containerd 都默认以 OverlayFS 作为运行时存储驱动</li>
<li>OverlayFS 目前已经有非常好的性能，与 DeviceMapper 相比优 20%，与操作主机文件性能几乎一致</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/容器运行时存储.png" alt="容器运行时存储"></p>
<h4 id="存储卷插件管理"><a href="#存储卷插件管理" class="headerlink" title="存储卷插件管理"></a>存储卷插件管理</h4><p>Kubernetes 支持以插件的形式来实现对不同存储的支持和扩展，这些扩展基于如下三种方式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/存储卷插件管理.png" alt="存储卷插件管理"></p>
<h4 id="out-of-tree-CSI-插件"><a href="#out-of-tree-CSI-插件" class="headerlink" title="out-of-tree CSI 插件"></a>out-of-tree CSI 插件</h4><p>CSI 通过 RPC 与存储驱动进行交互</p>
<p>在设计 CSI 的时候，Kubernetes 对 CSI 存储驱动和打包和部署要求很少，主要定义了 Kubernetes 的两个相关模块：</p>
<ul>
<li>kube-controller-manager:<ul>
<li>kube-controller-manager 模块用于感知 CSI 驱动存在</li>
<li>Kubernetes 的主控模块通过 Unix domain socket（而不是 CSI 驱动）或者其他方式进行直接地交互</li>
<li>Kubernetes 的主控模块只与 Kubernetes 相关的 API 进行交互</li>
<li>因此 CSI 驱动若有依赖于 Kubernetes API 的操作，例如卷的创建、卷的 attach、卷的快照等，需要在 CSI 驱动里面通过 Kubernetes 的 API，来触发相关的 CSI 操作</li>
</ul>
</li>
<li>kubelet：<ul>
<li>kubelet 模块用于与 CSI 驱动进行交互</li>
<li>kubelet 通过 Unix domain socket 向 CSI 驱动发起 CSI 调用（如 NodeStageVolume、NodePublishVolume 等），再发起 mount 卷和 umount 卷</li>
<li>kubelet 通过插件注册机制发现 CSI 驱动及用于和 CSI 驱动交互的 Unix Domain Socket</li>
<li>所有部署在 Kubernetes 集群中的 CSI 驱动都要通过 kubelet 的插件注册机制来注册自己</li>
</ul>
</li>
</ul>
<h4 id="CSI-驱动"><a href="#CSI-驱动" class="headerlink" title="CSI 驱动"></a>CSI 驱动</h4><p>CSI 的驱动一般包含 external-attacker、external-provisioner、external-resizer、external-snapshotter、node-driver-register、CSI driver 等模块，可以根据实际的存储类型和需求进行不同方式的部署。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CSI驱动.png" alt="CSI驱动"></p>
<h4 id="临时存储"><a href="#临时存储" class="headerlink" title="临时存储"></a>临时存储</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/emptydir/emptydir.yaml">https://github.com/kibaamor/101/blob/master/module7/csi/emptydir/emptydir.yaml</a></p>
<p>常见的临时存储主要就是 emptyDir 卷。</p>
<p>emptyDir 是一种经常被用户使用的卷类型，顾名思义，”卷”最初是空的。当 Pod 从节点上删除时，emptyDir 卷中的数据也会被永久删除。但当 Pod 的容器因为某些原因退出再重启时，emptyDir 卷内的数据并不会丢失。</p>
<p>默认情况下，emptyDir 卷存储在支持该节点所使用的存储介质上，可以是本地磁盘或者网络存储。</p>
<p>emptyDir 也可以通过将 emptyDir.medium 字段设置为 “Memory” 来通知 Kubernetes 为容器安装 tmpfs，此时数据被存储在内存中，速度相对于本地存储和网络存储快很多。但是在节点重启的时候，内存数据会被清楚；而如果存在磁盘上，则重启后数据依然存在。另外，使用 tmpfs 的内存也会计入容器的使用内存总量中，受系统的 cgroup 限制。</p>
<p>emptyDir 设计的初衷主要是给应用充当缓存空间，或者存储中间数据，用于快速恢复。然而，这并不是说满足以上需求的用户都被推荐使用 emptyDir，我们要根据用户业务的实际特点来判断是否使用 emptyDir。因为 emptyDir 的空间位于系统根盘，被所有容器共享，所以在磁盘的使用率较高时会触发 Pod 的 eviction 操作，从而影响业务的稳定。</p>
<h4 id="半持久化存储"><a href="#半持久化存储" class="headerlink" title="半持久化存储"></a>半持久化存储</h4><p>常见的半持久化存储主要是 hostPath 卷。hostPath 卷能将主机节点文件系统上的文件或目录挂载到指定 Pod 中。对普通用户而言一般不需要这样的卷，但是对很多需要获取节点系统信息的 Pod 而言，却是非常必要的。</p>
<p>例如，hostPath 的用法举例如下:</p>
<ul>
<li>某个 Pod 需要获取节点上所有 Pod 的 log，可以通过 hostPath 访问所有 Pod 的 stdout 输出存储目录，例如 /var/log/pods 路径。</li>
<li>某个 Pod 需要统计系统相关的信息，可以通过 hostPath 访问系统的 /proc 目录。</li>
</ul>
<p>使用 hostPath 的时候，除设置必需的 path 属性外，用户还可以有选择性地为 hostPath 卷指定类型支持类型包含目录、字符设备、块设备等。</p>
<h5 id="hostPath-卷需要注意"><a href="#hostPath-卷需要注意" class="headerlink" title="hostPath 卷需要注意"></a>hostPath 卷需要注意</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/hostpath/readme.MD">https://github.com/kibaamor/101/blob/master/module7/csi/hostpath/readme.MD</a></p>
<p>使用同一个目录的 Pod 可能会由于调度到不同的节点，导致目录中的内容有所不同。</p>
<p>Kubernetes 在调度时无法顾及由 hostPath 使用的资源。</p>
<p>Pod被删除后，如果没有特别处理，那么hostPath上写的数据会遗留到节点上，占用磁盘空间。</p>
<h4 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h4><p>支持持久化的存储是所有分布式系统所必备的特性。针对持久化存储，Kubernetes 引入了 StorageClass、Volume、PVC（Persistent Volume Claim）、PV（Persitent Volume）的概念，将存储独立于 Pod 的生命周期来进行管理。</p>
<p>Kuberntes 目前支持的持久化存储包含各种主流的块存储和文件存储，譬如 awsElasticBlockStore、azureDisk、cinder、NFS、cephfs、iscsi 等，在大类上可以将其分为网络存储和本地存储两种类型。</p>
<h5 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h5><p>StorageClass 用于指示存储的类型，不同的存储类型可以通过不同的 StorageClass 来为用户提供服务。</p>
<p>StorageClass 主要包含存储插件 provisioner、卷的创建和 mount 参数等字段。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Storageclass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterlD</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/fstype</span><span class="token punctuation">:</span> ext4
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>node
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">imageFeatures</span><span class="token punctuation">:</span> layering
  <span class="token key atrule">imageFormat</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">provisioner</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Delete
  <span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> immediate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h5><p>由用户创建，代表用户对存储需求的声明，主要包含需要的存储大小、存储卷的访问模式、StroageClass 等类型，其中存储卷的访问模式必须与存储的类型一致</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PVC.png" alt="PVC"></p>
<h5 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h5><p>由集群管理员提前创建，或者根据 PVC 的申请需求动态地创建，它代表系统后端的真实的存储空间，可以称之为卷空间。</p>
<h5 id="存储对象关系"><a href="#存储对象关系" class="headerlink" title="存储对象关系"></a>存储对象关系</h5><p>用户通过创建 PVC 来申请存储。控制器通过 PVC 的 StorageClass 和请求的大小声明来存储后端创建卷，进而创建 PV，Pod 通过指定 PVC 来引用存储。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/存储对象关系.png" alt="存储对象关系"></p>
<h4 id="独占的-Local-Volume"><a href="#独占的-Local-Volume" class="headerlink" title="独占的 Local Volume"></a>独占的 Local Volume</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/独占的LocalVolume.png" alt="独占的LocalVolume"></p>
<ul>
<li>创建 PV：通过 local-volume-provisioner Daemonset 创建本地存储的 PV。</li>
<li>创建 PVC：用户创建 PVC，由于它处于 pending 状态，所以 kube-controller-manager 并不会对该 PVC 做任何操作。</li>
<li>创建 Pod：用户创建 Pod。</li>
<li>Pod 挑选节点：kube-scheduler 开始调度 Pod，通过 PVC 的 <code>resources.request.storage</code> 和 <code>volumeMode</code> 选择满足条件的 PV，并且为 Pod 选择一个合适的节点。</li>
<li>更新 PV：kube-scheduler 将 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC，并且设置 annotation <code>pv.kubernetes.io/bound-by-controller</code> 的值为 <code>yes</code>。</li>
<li>PVC 和 PV 绑定：pv_controller 同步 PVC 和 PV 的状态，并将 PVC 和 PV 进行绑定。</li>
<li>监听 PVC 对象：kube-scheduler 等待 PVC 的状态变成 Bound 状态。</li>
<li>Pod 调度到节点：如果 PVC 的状态变为 Bound 则说明调度成功，而如果 PVC一直处于 pending 状态，超时后会再次进行调度。</li>
<li>Mount 卷启动容器：kubelet监听到有 Pod 已经调度到节点上，对本地存储进行 mount 操作，并启动容器。</li>
</ul>
<h4 id="Dynamic-Local-Volume"><a href="#Dynamic-Local-Volume" class="headerlink" title="Dynamic Local Volume"></a>Dynamic Local Volume</h4><p>CSI 驱动需要汇报节点上相关存储的资源信息，以便用于调度但是机器的厂家不同，汇报方式也不同。</p>
<p>例如，有的厂家的机器节点上具有 NVMe、SSD、HDD 等多种存储介质，希望将这些存储介质分别进行汇报。</p>
<p>这种需求有别于其他存储类型的 CSI 驱动对接口的需求，因此如何汇报节点的存储信息，以及如何让节点的存储信息应用于调度，目前并没有形成统一的意见。</p>
<p>集群管理员可以基于节点存储的实际情况对开源 CSI 驱动和调度进行一些代码修改，再进行部署和使用。</p>
<h5 id="Local-Dynamic-的挂载流程"><a href="#Local-Dynamic-的挂载流程" class="headerlink" title="Local Dynamic 的挂载流程"></a>Local Dynamic 的挂载流程</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LocalDynamic的挂载流程.png" alt="LocalDynamic的挂载流程"></p>
<ul>
<li>创建 PVC：用户创建 PVC，PVC 处于 pending 状态。</li>
<li>创建 Pod：用户创建 Pod。</li>
<li>Pod 选择节点：kube-scheduler 开始调度 Pod，通过 PVC 的 <code>pvc.spec.resources.request.storage</code> 等选择满足条件的节点。</li>
<li>更新 PVC：选择节点后，kube-scheduler 会给 PVC 添加包含节点信息的 annotation：<code>volume.kubernetes.io/selected-node:&lt;节点名字&gt;</code>。</li>
<li>创建卷：运行在节点上的容器 external-provisioner 监听到 PVC 带有该节点相关的 annotation，向相应的 CSI 驱动申请分配卷。</li>
<li>创建 PV：PVC 申请到所需的存储空间后，external-provisione 创建 PV，该 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC。</li>
<li>PVC 和 PV 绑定：kube-controller-manager 将 PVC 和 PV 进行绑定，状态修改为 Bound。</li>
<li>监听 PVC 状态：kube-scheduler 等待 PVC 变成 Bound 状态</li>
<li>Pod 调度到节点：当 PVC 的状态为 Bound 时，Pod 才算真正调度成功了。如果 PVC一直处于 Pending状态，超时后会再次进行调度。</li>
<li>Mount 卷：kubelet监听到有 Pod 已经调度到节点上，对本地存储进行 mount 操作。</li>
<li>启动容器：启动容器。</li>
</ul>
<h5 id="Local-Dynamic-的挑战"><a href="#Local-Dynamic-的挑战" class="headerlink" title="Local Dynamic 的挑战"></a>Local Dynamic 的挑战</h5><p>如果将磁盘空间作为一个存储池（例如 LVM）来动态分配，那么在分配出来的逻辑卷空间的使用上，可能会受到其他逻辑卷的 I/O 干扰，因为底层的物理卷可能是同一个。</p>
<p>如果 PV 后端的磁盘空间是一块独立的物理磁盘，则 I/O 就不会受到干扰。</p>
<h4 id="生产实践经验分享"><a href="#生产实践经验分享" class="headerlink" title="生产实践经验分享"></a>生产实践经验分享</h4><p>不同介质类型的磁盘，需要设置不同的 StorageClass，以便让用户做区分。StorageClass 需要设置磁盘介质的类型，以便用户了解该类存储的属性。</p>
<p>在本地存储的 PV 静态部署模式下，每个物理磁盘都尽量只创建一个 PV，而不是划分为多个分区来提供多个本地存储 PV，避免在使用时分区之间的 I/O 干扰。</p>
<p>本地存储需要配合磁盘检测来使用。当集群部署规模化后，每个集群的本地存储 PV 可能会超过几万个，如磁盘损坏将是频发事件。此时，需要在检测到磁盘损坏、丢盘等问题后，对节点的磁盘和相应的本地存储 PV 进行特定的处理例如触发告警、自动 cordon 节点、自动通知用户等。</p>
<p>对于提供本地存储节点的磁盘管理，需要做到灵活管理和自动化。节点磁盘的信息可以归一、集中化管理。在 local-volume-provisioner 中增加部署逻辑，当容器运行起来时，拉取该节点需要提供本地存储的磁盘信息，例如磁盘的设备路径，以 Filesystem 或 Block 的模式提供本地存储，或者是否需要加入某个 LVM 的虚拟组（VG）等 local-volume-provisioner 根据获取的磁盘信息对磁盘进行格式化，或者加入到某个 VG，从而形成对本地存储支持的自动化闭环。</p>
<h4 id="Rook"><a href="#Rook" class="headerlink" title="Rook"></a>Rook</h4><p>Rook 是一款云原生环境下的开源分布式存储编排系统，目前支持 Ceph、NFS、EdgeFS、Cassandra、CockroachDB 等存储系统。它实现了一个自动管理的、自动扩容的、自动修复的分布式存储服务。Rook 支持自动部署、启动、配置、分配、扩容/缩容、升级、迁移、灾难恢复、监控以及资源管理。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/rook/rook.md">https://github.com/kibaamor/101/blob/master/module7/csi/rook/rook.md</a></p>
<h5 id="Rook-架构"><a href="#Rook-架构" class="headerlink" title="Rook 架构"></a>Rook 架构</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Rook架构.png" alt="Rook架构"></p>
<h5 id="Rook-Operator"><a href="#Rook-Operator" class="headerlink" title="Rook Operator"></a>Rook Operator</h5><p>RookOperater 是 Rook 的大脑，以deployment 形式存在。</p>
<p>其利用 Kubernetes 的 controller-runtime 框架实现了 CRD，并进而接受 Kubernetes 创建资源的请求并创建相关资源（集群，pool，块存储服务，文件存储服务等）。<br>RookOperater 监控存储守护进程，来确保存储集群的健康。</p>
<p>监听 Rook Discovers 收集到的存储磁盘设备，并创建相应服务（Ceph 的话就是 OSD 了）。</p>
<h5 id="Rook-Discover"><a href="#Rook-Discover" class="headerlink" title="Rook Discover"></a>Rook Discover</h5><p>Rook Discover 是以 DaemonSet 形式部署在所有的存储机上的，其检测挂接到存储节点上的存储设备。把符合要求的存储设备记录下来，这样 RookOperate 感知到以后就可以基于该存储设备创建相应服务了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## discover device</span>
lsblk --all --noheadings --list --output KNAME
lsblk /dev/vdd --bytes --nodeps --pairs --paths --0utput SIZE,ROTA,RO,TYPE,PKNAME,NAME,KNAME
udevadm info --query<span class="token operator">=</span>property /dev/vdd$ lsblk --noheadings --pairs /dev/vdd

<span class="token comment">## discover ceph inventory</span>
ceph-volume inventory--format json
<span class="token keyword">if</span> device has ceph inv,device.cephVolumeData<span class="token operator">=</span>CvData
<span class="token comment">## put device info into configmap per node</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CSIDriver-发现"><a href="#CSIDriver-发现" class="headerlink" title="CSIDriver 发现"></a>CSIDriver 发现</h5><p>CSI 驱动发现：</p>
<p>如果一个 CSI 驱动创建 CSIDriver 对象，Kubernetes 用户可以通过 <code>get CSIDriver</code> 命令发现它们；</p>
<p>CSI 对象有如下特点：</p>
<ul>
<li>自定义的 Kubernetes逻辑；</li>
<li>Kubernetes 对存储卷有一些列操作，这些 CSIDriver 可以自定义支持哪些操作?</li>
</ul>
<h5 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a>Provisioner</h5><p>CSI external-provisioner 是一个监控 Kubernetes PVC 对象的 Sidecar 容器</p>
<p>当用户创建 PVC 后，Kubernetes 会监测 PVC 对应的 StorageClass，如果 StorageClass 中的 provisioner 与某插件匹配，该容器通过 CSI Endpoint（通常是 unixsocket）调用 CreateVolume 方法。</p>
<p>如果 CreateVolume 方法调用成功，则 Provisioner sidecar 创建 Kubernetes PV 对象。</p>
<h5 id="CSI-External-Provisioner"><a href="#CSI-External-Provisioner" class="headerlink" title="CSI External Provisioner"></a>CSI External Provisioner</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>csi<span class="token punctuation">-</span>address=$(ADDRESS)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>timeout=150s
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>retry<span class="token punctuation">-</span>interval<span class="token punctuation">-</span>start=500ms
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> name<span class="token punctuation">:</span>ADDRESS
      value<span class="token punctuation">:</span>unix<span class="token punctuation">:</span>///csi/csi<span class="token punctuation">-</span>provisioner.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/k8scsi/csi<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v1.6.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /csi
      <span class="token key atrule">name</span><span class="token punctuation">:</span> socket<span class="token punctuation">-</span>dir
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount
      <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>sa<span class="token punctuation">-</span>token<span class="token punctuation">-</span>mxv84
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeid=$(NODE ID)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>endpoint=$(CSI ENDPOINT)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>type=rbd
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>controllerserver=true
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>drivername=rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> name<span class="token punctuation">:</span>CSI ENDPOINT
      <span class="token key atrule">value</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///csi/csi<span class="token punctuation">-</span>provisioner.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/cephcsi/cephcsi<span class="token punctuation">:</span>v3.0.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>rbdplugin
  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span>
    <span class="token key atrule">medium</span><span class="token punctuation">:</span> Memory
    <span class="token key atrule">name</span><span class="token punctuation">:</span> socket<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Provisioner-代码"><a href="#Provisioner-代码" class="headerlink" title="Provisioner 代码"></a>Provisioner 代码</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go">controller<span class="token operator">/</span>controller<span class="token punctuation">.</span><span class="token keyword">go</span>
    syncClaim <span class="token operator">-</span><span class="token operator">&gt;</span>provisionClaimOperation<span class="token operator">-</span><span class="token operator">&gt;</span>provisioner<span class="token punctuation">.</span>Provision
        pkg<span class="token operator">/</span>operator<span class="token operator">/</span>ceph<span class="token operator">/</span>provisioner<span class="token operator">/</span>provisioner<span class="token punctuation">.</span><span class="token keyword">go</span>
            Provision<span class="token operator">-</span><span class="token operator">&gt;</span>createVolume
                ceph<span class="token punctuation">.</span>Createlmage
        
        pkg<span class="token operator">/</span>daemon<span class="token operator">/</span>ceph<span class="token operator">/</span>client<span class="token operator">/</span>image<span class="token punctuation">.</span><span class="token keyword">go</span>
        
        rbd create poolName<span class="token operator">/</span>name <span class="token operator">-</span>size sizeMB
volumeStore<span class="token punctuation">.</span>StoreVolume
    controller<span class="token operator">/</span>volume_store<span class="token punctuation">.</span><span class="token keyword">go</span>
        doSaveVolume
            client<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PersistentVolumes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Provisioner-log"><a href="#Provisioner-log" class="headerlink" title="Provisioner log"></a>Provisioner log</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">10816 10:17:32.535207   1 connection.go:153] connecting to unix:///csi/csiprovisioner.sock
10816 10:17:54.361911   1 volume store.go:97] Starting save volume queue
10816 10:17:54.461930   1 controller.go:1284] provision "default/mysql-pv-claim" class
"rook-ceph-block": started
10816 10:17:54.462078   1 controller.go:848] Started provisioner controller rook-ceph.rbd.csi.ceph.com csi-rbdplugin-provisioner-677577c77c-vwkzz ca5971ab-2293-4e529bc9-c490f7f50b07!
1081610:17:54.465752 1event.go:281] Event(v1.0bjectReference{Kind:"PersistentVolumeClaim", Namespace:"default"Name:"mysal-pv-claim",UlD:"24449707-6738-425c-ac88-de3c470cf91a",APIVersion:"y1"ResourceVersion:"45668", FieldPath:""): type:'Normal' reason: 'Provisioning' Externalprovisioner is provisioning volume for claim "default/mysql-pv-claim"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Rook-Agent"><a href="#Rook-Agent" class="headerlink" title="Rook Agent"></a>Rook Agent</h5><p>RookAgent 是以 Daemonset 形式部署在所有的存储机上的，其处理所有的存储操作，例如挂卸载存储卷以及格式化文件系统等。</p>
<h5 id="CSI-插件注册"><a href="#CSI-插件注册" class="headerlink" title="CSI 插件注册"></a>CSI 插件注册</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>V=0
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>csi<span class="token punctuation">-</span>address=/csi/csi.sock
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>registration<span class="token punctuation">-</span>path=/var/lib/kubelet/plugins/rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com/csi.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/k8scsi/csi<span class="token punctuation">-</span>node<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>registrar<span class="token punctuation">:</span>v1.2.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> driver<span class="token punctuation">-</span>registrar
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">securitycontext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /csi
    <span class="token key atrule">name</span><span class="token punctuation">:</span> plugin<span class="token punctuation">-</span>dir
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /registration
    <span class="token key atrule">name</span><span class="token punctuation">:</span> registration<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CSI-Driver"><a href="#CSI-Driver" class="headerlink" title="CSI Driver"></a>CSI Driver</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">apiVersion<span class="token punctuation">:</span>storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CSlDriver
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">attachRequired</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">podinfoOnMount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">volumeLifecycleModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Persistent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span> /var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com
csi.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeid=$(NODE ID)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>endpoint=$(CSI ENDPOINT)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>type=rbd
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeserver=true
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>drivername=rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>pidlimit=<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metricsport=9090
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metricspath=/metrics
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enablegrpcmetrics=true
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CSI ENDPOINT
    <span class="token key atrule">value</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///csi/csi.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/cephcsi/cephcsi<span class="token punctuation">:</span>v3.0.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>rbdplugin
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    allowPrivilegeEscalation<span class="token punctuation">:</span><span class="token boolean important">true</span>
    <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
      <span class="token key atrule">add</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> SYS_ADMIN
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    path<span class="token punctuation">:</span>/var/lib/kubelet/plugins/rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
    <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> plugin<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go">pkg<span class="token operator">/</span>daemon<span class="token operator">/</span>ceph<span class="token operator">/</span>agent<span class="token operator">/</span>agent<span class="token punctuation">.</span><span class="token keyword">go</span>
    flexvolume<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>context<span class="token punctuation">,</span> volumeAttachmentController<span class="token punctuation">,</span> volumeManager<span class="token punctuation">)</span>
    rpc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>flexvolumeController<span class="token punctuation">)</span>
    flexvolumeServer<span class="token punctuation">.</span>Start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h5><p>针对不同 ceph cluster，rook 启动一组管理组件，包括: mon, mgr, osd, mds, rgw。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CephCluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">cephVersion</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ceph/ceph<span class="token punctuation">:</span>v14.2.10
    <span class="token key atrule">dataDirHostPath</span><span class="token punctuation">:</span> /var/lib/rook
  <span class="token key atrule">mon</span><span class="token punctuation">:</span>
    count<span class="token punctuation">:</span><span class="token number">3</span>
    <span class="token key atrule">allowMultiplePerNode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">mgr</span><span class="token punctuation">:</span>
    <span class="token key atrule">modules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pg_autoscaler
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">dashboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token key atrule">useAllNodes</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">useAllDevices</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h5><p>-个 ceph cluster 可以有多个 pool 定义副本数量，故障域等多个属性。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> cephBlockPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">compressionMode</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">crushRoot</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">deviceClass</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">erasureCoded</span><span class="token punctuation">:</span>
    <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> <span class="token string">""</span>
    <span class="token key atrule">codingChunks</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">dataChunks</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">failureDomain</span><span class="token punctuation">:</span> host
  <span class="token key atrule">replicated</span><span class="token punctuation">:</span>
    <span class="token key atrule">requireSafeReplicaSize</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">targetSizeRatio</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">phase</span><span class="token punctuation">:</span> Ready<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Kubernetes-控制平面组件：生命周期管理和服务发现"><a href="#Kubernetes-控制平面组件：生命周期管理和服务发现" class="headerlink" title="Kubernetes 控制平面组件：生命周期管理和服务发现"></a>Kubernetes 控制平面组件：生命周期管理和服务发现</h2><h3 id="深入理解-Pod-的生命周期"><a href="#深入理解-Pod-的生命周期" class="headerlink" title="深入理解 Pod 的生命周期"></a>深入理解 Pod 的生命周期</h3><h4 id="如何优雅的管理-Pod-的完整生命周期"><a href="#如何优雅的管理-Pod-的完整生命周期" class="headerlink" title="如何优雅的管理 Pod 的完整生命周期"></a>如何优雅的管理 Pod 的完整生命周期</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何优雅的管理Pod的完整生命周期.png" alt="如何优雅的管理Pod的完整生命周期"></p>
<ul>
<li>Pending<br>  Pod 创建成功，但是还未调度（即未与 Node 绑定）</li>
<li>ContainerCreating<br>  Pod 成功被调度到某了 Node，等待 Node 创建对应的 Pod</li>
</ul>
<h4 id="Pod-状态机"><a href="#Pod-状态机" class="headerlink" title="Pod 状态机"></a>Pod 状态机</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod状态机.png" alt="Pod状态机"></p>
<h4 id="Pod-Phase"><a href="#Pod-Phase" class="headerlink" title="Pod Phase"></a>Pod Phase</h4><p>Pod Phase</p>
<ul>
<li>Pending</li>
<li>Running</li>
<li>Succeeded</li>
<li>Failed</li>
<li>Unknown</li>
</ul>
<p><code>kubectl get pod</code> 显示的状态信息是由 podstatus 的 conditions 和 phase 计算出来的</p>
<ul>
<li>查看 pod 细节 <code>kubectl get pod $podname -oyaml</code></li>
<li>查看 pod 相关事件 <code>kubectl describe pod</code></li>
</ul>
<h4 id="Pod-状态计算细节"><a href="#Pod-状态计算细节" class="headerlink" title="Pod 状态计算细节"></a>Pod 状态计算细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod状态计算细节.png" alt="Pod状态计算细节"></p>
<h4 id="如何确保-Pod-的高可用"><a href="#如何确保-Pod-的高可用" class="headerlink" title="如何确保 Pod 的高可用"></a>如何确保 Pod 的高可用</h4><p>避免容器进程被终止避免 Pod 被驱逐</p>
<ul>
<li>设置合理的 resources.memory limits 防止容器进程被 OOMKill</li>
<li>设置合理的 emptydir.sizeLimit 并且确保数据写入不超过 emptyDir 的限制，防止 Pod 被驱逐</li>
</ul>
<h4 id="Pod-的-QoS分类"><a href="#Pod-的-QoS分类" class="headerlink" title="Pod 的 QoS分类"></a>Pod 的 QoS分类</h4><ul>
<li>Guaranteed<ul>
<li>Pod 的每个容器都设置了资源 CPU 和内存需求</li>
<li>Limits 和 requests 的值完全一致</li>
</ul>
</li>
<li>Burstable<ul>
<li>至少一个容器指定了 CPU 或内存 request</li>
<li>Pod 的资源需求不符合 Gauranteed Qos 的条件，也就是 request 和 limits 不一致</li>
</ul>
</li>
<li>BestEffort<ul>
<li>Pod 中的所有容器都未指定 CPU 或内存资源需要 request</li>
</ul>
</li>
</ul>
<blockquote>
<p>仅配置 resources 中的 limits 的话，qos 会是 Guaranteed。</p>
<p>仅配置 resources 中的 requests 的话，qos 会是 Burstable。</p>
</blockquote>
<p>当计算节点检测到内存压力时，Kubernetes 会按 BestEffort -&gt; Burstable -&gt; Guaranteed 的顺序依次驱逐 Pod</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pod xxx <span class="token operator">|</span> <span class="token function">grep</span> qosClass
  qosClass: Burstable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>定义 Guaranteed 类型的资源需求来保护你的重要 Pod。</p>
<p>认真考量 Pod 需要的真实需求并设置 limit 和 resource，这有利于将集群资源利用率控制在合理范围并减少 Pod 被驱逐的现象。</p>
<p>尽量避免将生产 Pod 设置为 BestEffort，但是对测试环境来讲，BestEffort Pod 能确保大多数应用不会因为资源不足而处于 Pending 状态。</p>
<p>Burstable 适用于大多数场景。思考:为什么?</p>
<h4 id="PriorityClass-和-QosClass-之间的区别"><a href="#PriorityClass-和-QosClass-之间的区别" class="headerlink" title="PriorityClass 和 QosClass 之间的区别"></a>PriorityClass 和 QosClass 之间的区别</h4><p><a target="_blank" rel="noopener" href="https://medium.com/pareture/kubernetes-quality-of-service-qos-class-vs-priority-class-751d1c9f9f7c">Kubernetes Quality of Service (QoS) Class Vs Priority Class</a></p>
<p>PriorityClass 和 QosClass 属于两个不同的维度。</p>
<p>PriorityClass 是用来做资源调度时，判断谁的优先级高谁先抢占资源。</p>
<p>它的表现是，在所有的调度开始前，有一个 QueueSort 的步骤，把所有待调度的 Pod 按照优先级排序，高优先级的在前面，低优先级的排在后面。调度的时候，先调度高优先级的 Pod。</p>
<p>另外，PriorityClass 有一个是否抢占资源的属性，如果设置成”是”的话，当集群目前的资源不足时，调度器就会计算假如杀掉一些比当前待调度 Pod 优先级低的 Pod 后能否让待调度的 Pod 能成功运行，如果能的话，就会杀掉那些比当前待调度 Pod 优先级低的 Pod 以抢占它们的资源。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get priorityclasses system-node-critical -oyaml
apiVersion: scheduling.k8s.io/v1
description: Used <span class="token keyword">for</span> system critical pods that must not be moved from their current
  node.
kind: PriorityClass
metadata:
  creationTimestamp: <span class="token string">"2024-05-11T10:12:53Z"</span>
  generation: <span class="token number">1</span>
  name: system-node-critical
  resourceVersion: <span class="token string">"74"</span>
  uid: bafc6e25-24ed-4d64-8115-16ad31aace29
preemptionPolicy: PreemptLowerPriority
value: <span class="token number">2000001000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// PreemptionPolicy describes a policy for if/when to preempt a pod.</span>
<span class="token keyword">type</span> PreemptionPolicy <span class="token builtin">string</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// PreemptLowerPriority means that pod can preempt other pods with lower priority.</span>
    PreemptLowerPriority PreemptionPolicy <span class="token operator">=</span> <span class="token string">"PreemptLowerPriority"</span>
    <span class="token comment">// PreemptNever means that pod never preempts other pods with lower priority.</span>
    PreemptNever PreemptionPolicy <span class="token operator">=</span> <span class="token string">"Never"</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>QosClass 根据资源需求来决定 Kubernetes 需要对 Pod 做什么样的质量保证。当 Node 出现资源紧张的情况下，Node 会根据 QosClass 的优先级从低到高进行驱逐，这个时候与 PriorityClass 是无关的。</p>
<p>PriorityClass 是 Pod 调度时抢资源用的，QosClass 是资源不足驱逐时用的。</p>
<p>“QosClass 是决定怎么死，PriorityClass 决定怎么生”</p>
<h4 id="基于-Taint-的-Evictions"><a href="#基于-Taint-的-Evictions" class="headerlink" title="基于 Taint 的 Evictions"></a>基于 Taint 的 Evictions</h4><p>NotReady Node</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">taints</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:25:10Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:25:21Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> Noschedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:24:28Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:24:32Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>K8s 为 Pod 自动增加的 Toleration</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">900</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Existstoleration
  <span class="token key atrule">seconds</span><span class="token punctuation">:</span> <span class="token number">900</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>节点临时不可达</p>
<ul>
<li>网络分区 </li>
<li>kubelet, containerd 不工作</li>
<li><p>节点重启超过了 15 分钟</p>
</li>
<li><p>增大 tolerationSeconds 以避免被驱逐</p>
<ul>
<li>特别是依赖于本地存储状态的有状态应用</li>
</ul>
</li>
</ul>
<h4 id="健康检查探针"><a href="#健康检查探针" class="headerlink" title="健康检查探针"></a>健康检查探针</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/pods/graceful-start">https://github.com/kibaamor/101/tree/master/module8/pods/graceful-start</a></p>
<p>健康探针类型分为</p>
<ul>
<li>livenessProbe<ul>
<li>探活，当检查失败时，意味着该应用进程已经无法正常提供服务 kubelet 会终止该容器进程并按照 restartPolicy 决定是否重启</li>
<li>livenessProbe 不会重建 Pod，只会重起 containerd</li>
<li>livenessProbe 默认不配置时是成功的</li>
</ul>
</li>
<li>readinessProbe<ul>
<li>就绪状态检查，当检查失败时，意味着应用进程正在运行，但因为某些原因不能提供服务，Pod 状态会被标记为 NotReady</li>
<li>readinessProbe 默认不配置时是成功的，但如果配置了就不要成功后 service 才会转发流量给对应的 Pod</li>
<li>readinessProbe 失败时并不会重启 Container 或者 Pod，只是会不 Ready</li>
</ul>
</li>
<li>startupProbe<ul>
<li>在初始化阶段(Ready 之前)进行的健康检查，通常用来避免过于频繁的监测影响应用启动</li>
<li>startupProbe 成功后，livenessProbe 和 readinessProbe 才会介入</li>
</ul>
</li>
</ul>
<p>探测方法包括</p>
<ul>
<li>ExecAction：在容器内部运行指定命令，当返回码为 0 时，探测结果为成功</li>
<li>TCPSocketAction：由 kubelet 发起，通过 TCP 协议检查容器 IP 和端口，当端口可达时，探测结果为成功</li>
<li>HTTPGetAction：由 kubelet 发起，对 Pod 的 IP 和指定端口以及路径进行 HTTPGet 操作，当返回码为 200-400 之间时，探测结果为成功</li>
</ul>
<h4 id="探针属性"><a href="#探针属性" class="headerlink" title="探针属性"></a>探针属性</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/探针属性.png" alt="探针属性"></p>
<h4 id="ReadinessGates"><a href="#ReadinessGates" class="headerlink" title="ReadinessGates"></a>ReadinessGates</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/pods/graceful-start/readiness-gate.yaml">https://github.com/kibaamor/101/blob/master/module8/pods/graceful-start/readiness-gate.yaml</a></p>
<ul>
<li>Readiness 允许在 Kubernetes 自带的 Pod Conditions 之外引入自定义的就绪条件</li>
<li>新引入的 readinessGates condition 需要为 True 状态后，加上内置的 Conditions，Pod 才可以为就绪状态</li>
<li>该状态应该由某控制器修改</li>
</ul>
<h4 id="Post-start-和-Pre-Stop-Hook"><a href="#Post-start-和-Pre-Stop-Hook" class="headerlink" title="Post-start 和 Pre-Stop Hook"></a>Post-start 和 Pre-Stop Hook</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/pods/graceful-stop">https://github.com/kibaamor/101/tree/master/module8/pods/graceful-stop</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PostStart和PreStopHook.png" alt="PostStart和PreStopHook"></p>
<h4 id="terminationGracePeriodSeconds-的分解"><a href="#terminationGracePeriodSeconds-的分解" class="headerlink" title="terminationGracePeriodSeconds 的分解"></a>terminationGracePeriodSeconds 的分解</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/terminationGracePeriodSeconds的分解.png" alt="terminationGracePeriodSeconds的分解"></p>
<h4 id="Terminating-Pod-的误用"><a href="#Terminating-Pod-的误用" class="headerlink" title="Terminating Pod 的误用"></a>Terminating Pod 的误用</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> netperf<span class="token punctuation">:</span><span class="token number">0.1</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /netperf<span class="token punctuation">-</span>server.sh
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> netperf-server.sh
<span class="token comment">#!/bin/bashnetserver -D</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>bash /sh 会忽略 SIGTERM 信号量，因此 kilL -SIGTERM 会永远超时，若应用使用 bash/sh 作为 Entrypoint，则应避免过长的 grace period</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/TerminatingPod的误用.png" alt="TerminatingPod的误用"></p>
<h4 id="Terminating-Pod-的经验分享"><a href="#Terminating-Pod-的经验分享" class="headerlink" title="Terminating Pod 的经验分享"></a>Terminating Pod 的经验分享</h4><p><a target="_blank" rel="noopener" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a></p>
<p>terminationGracePeriodseconds 默认时长 30 秒</p>
<p>如果不关心 Pod 的终止时长，那么无需采取特殊措施</p>
<p>如果希望快速终止应用进程，那么可采取如下方案</p>
<ul>
<li>在 preStop script 中主动退出进程</li>
<li>在主容器进程中使用特定的初始化进程</li>
</ul>
<p>优雅的初始化进程应该</p>
<ul>
<li>正确处理系统信号量，将信号量转发给子进程</li>
<li>在主进程退出之前，需要先等待并确保所有子进程退出</li>
<li>监控并清理孤儿子进程</li>
</ul>
<h4 id="在-Kubernetes-上部署应用的挑战"><a href="#在-Kubernetes-上部署应用的挑战" class="headerlink" title="在 Kubernetes 上部署应用的挑战"></a>在 Kubernetes 上部署应用的挑战</h4><p>资源规划</p>
<ul>
<li>每个实例需要多少计算资源<ul>
<li>CPU/GPU?</li>
<li>Memory</li>
</ul>
</li>
<li>超售需求</li>
<li>每个实例需要多少存储资源<ul>
<li>大小</li>
<li>本地还是网盘</li>
<li>读写性能</li>
<li>Disk IO</li>
</ul>
</li>
<li>网络需求<ul>
<li>整个应用总体 QPS 和带宽</li>
</ul>
</li>
</ul>
<h4 id="存储带来的挑战"><a href="#存储带来的挑战" class="headerlink" title="存储带来的挑战"></a>存储带来的挑战</h4><p>多容器之间共享存储，最简方案是 emptyDir</p>
<p>带来的挑战：</p>
<ul>
<li>emptyDir 需要控制 size limt，否则无限扩张的应用会撑爆主机磁盘导致主机不可用进而导致大规模集群故障</li>
<li>emptyDir size limit 生效以后，kubelet 会定期对容器目录执行 du 操作，会导致些许的性能影响</li>
<li>size limit达到以后，Pod 会被驱逐，原 Pod 的日志配置等信息会消失</li>
</ul>
<h4 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h4><p>传入方式</p>
<ul>
<li>Environment Variables</li>
<li>Volume Mount</li>
</ul>
<p>数据来源</p>
<ul>
<li>ConfigMap</li>
<li>Secret</li>
<li>Downward AP</li>
</ul>
<h4 id="数据应该如何保存"><a href="#数据应该如何保存" class="headerlink" title="数据应该如何保存"></a>数据应该如何保存</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据应该如何保存.png" alt="数据应该如何保存"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据应该如何保存2.png" alt="数据应该如何保存2"></p>
<h4 id="容器应用可能面临的进程中断"><a href="#容器应用可能面临的进程中断" class="headerlink" title="容器应用可能面临的进程中断"></a>容器应用可能面临的进程中断</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/容器应用可能面临的进程中断.png" alt="容器应用可能面临的进程中断"></p>
<h4 id="高可用部署方式"><a href="#高可用部署方式" class="headerlink" title="高可用部署方式"></a>高可用部署方式</h4><p>多少实例</p>
<p>更新策略</p>
<ul>
<li>maxsurge</li>
<li>maxUnavailable（需要考虑 ResourceQuota 的限制）</li>
</ul>
<p>深入理解 PodTemplateHash 导致的应用的易变性</p>
<h4 id="课后作业-第一部分"><a href="#课后作业-第一部分" class="headerlink" title="课后作业(第一部分)"></a>课后作业(第一部分)</h4><p>现在你对 Kubernetes 的控制面板的工作机制是否有了深入的了解呢?</p>
<p>是否对如何构建一个优雅的云上应用有了深刻的认识，那么接下来用最近学过的知识把你之前编写的 http 以优雅的方式部署起来吧，你可能需要审视之前代码是否能满足优雅上云的需求。</p>
<p>作业要求:编写 Kubernetes 部署脚本将 httpserver 部署到 kubernetes 集群，以下是你可以思考的维度</p>
<ul>
<li>优雅启动</li>
<li>优雅终止</li>
<li>资源需求和 QoS 保证</li>
<li>探活</li>
<li>日常运维需求，日志等级</li>
<li>配置和代码分离</li>
</ul>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><h4 id="服务发布"><a href="#服务发布" class="headerlink" title="服务发布"></a>服务发布</h4><p>需要把服务发布至集群内部或者外部，服务的不同类型</p>
<ul>
<li>ClusterlP(Headless)</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>ExternalName</li>
</ul>
<p>证书管理和七层负载均衡的需求</p>
<p>需要gRPC负载均衡如何做?</p>
<p>DNS需求</p>
<p>与上下游服务的关系</p>
<h4 id="服务发布的挑战"><a href="#服务发布的挑战" class="headerlink" title="服务发布的挑战"></a>服务发布的挑战</h4><p>kube-dns</p>
<ul>
<li>DNS TTL 问题</li>
</ul>
<p>Service</p>
<ul>
<li>ClusterIP 只能对内</li>
<li>kube-proxy 支持的 iptables/ipvs 规模有限</li>
<li>IPVS 的性能和生产化问题 kube-proxy 的 drift 问题</li>
<li>频繁的 Pod 变动(specchange，failover，crashloop) 导致 LB 频繁变更</li>
<li>对外发布的 Service 需要与企业 ELB 集成</li>
<li>不支持 gRPC</li>
<li>不支持自定义 DNS 和高级路由功能</li>
</ul>
<p>Ingress</p>
<ul>
<li>Spec 的成熟度?</li>
</ul>
<p>其他可选方案?</p>
<h4 id="跨地域部署"><a href="#跨地域部署" class="headerlink" title="跨地域部署"></a>跨地域部署</h4><p>需要多少实例</p>
<p>如何控制失败域，部署在几个地区，AZ，集群?</p>
<p>如何进行精细的流量控制</p>
<p>如何做按地域的顺序更新</p>
<p>如何回滚</p>
<h3 id="微服务架构下的高可用挑战"><a href="#微服务架构下的高可用挑战" class="headerlink" title="微服务架构下的高可用挑战"></a>微服务架构下的高可用挑战</h3><h4 id="服务发现-1"><a href="#服务发现-1" class="headerlink" title="服务发现"></a>服务发现</h4><p>微服务架构是由一系列职责单一的细粒度服务构成的分布式网状结构服务之间通过轻量机制进行通信，这时候必然引入一个服务注册发现问题，也就是说服务提供方要注册通告服务地址，服务的调用方要能发现目标服务。</p>
<p>同时服务提供方一般以集群方式提供服务，也就引入了负载均衡和健康检查问题。</p>
<h5 id="互联网架构发展历程"><a href="#互联网架构发展历程" class="headerlink" title="互联网架构发展历程"></a>互联网架构发展历程</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/互联网架构发展历程.png" alt="互联网架构发展历程"></p>
<h5 id="理解网络包格式"><a href="#理解网络包格式" class="headerlink" title="理解网络包格式"></a>理解网络包格式</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/理解网络包格式.png" alt="理解网络包格式"></p>
<h5 id="集中式-LB-服务发现"><a href="#集中式-LB-服务发现" class="headerlink" title="集中式 LB 服务发现"></a>集中式 LB 服务发现</h5><ul>
<li>在服务消费者和服务提供者之间有一个独立的 LB。</li>
<li>LB 上有所有服务的地址映射表，通常由运维配置注册</li>
<li>当服务消费方调用某个目标服务时，它向 LB 发起请求，由 LB 以某种策略(比如 Round-Robin)做负载均衡后将请求转发到目标服务。</li>
<li>LB 一般具备健康检查能力，能自动摘除不健康的服务实例。</li>
<li>服务消费方通过 DNS 发现 LB，运维人员为服务配置一个 DNS 域名，这个域名指向 LB。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集中式LB服务发现.png" alt="集中式LB服务发现"></p>
<ul>
<li>集中式 LB 方案实现简单，在 LB 上也容易做集中式的访问控制，这一方案目前还是业界主流。</li>
<li>集中式 LB 的主要问题是单点问题，所有服务调用流量都经过 LB，当服务数量和调用量大的时候，LB 容易成为瓶颈，且一旦 LB 发生故障对整个系统的影响是灾难性的。</li>
<li>LB 在服务消费方和服务提供方之间增加了一跳( hop )，有一定性能开销。</li>
</ul>
<h5 id="进程内-LB-服务发现"><a href="#进程内-LB-服务发现" class="headerlink" title="进程内 LB 服务发现"></a>进程内 LB 服务发现</h5><ul>
<li>进程内 LB 方案将 LB 的功能以库的形式集成到服务消费方进程里头，该方案也被称为客户端负载方案。</li>
<li>服务注册表( Service Registry )配合支持服务自注册和自发现，服务提供方启动时，首先将服务地址注册到服务注册表(同时定期报心跳到服务注册表以表明服务的存活状态)</li>
<li>服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询(同时缓存并定期刷新)目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。</li>
<li>这一方案对服务注册表的可用性( Availability )要求很高，一般采用能满足高可用分布式一致的组件(例如 ZooKeeper,Consul,etcd 等)来实现。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/进程内LB服务发现.png" alt="进程内LB服务发现"></p>
<ul>
<li>进程内 LB 是一种分布式模式，LB和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。该方案以客户库( Client Library )的方式集成到服务调用方进程里头，如果企业内有多种不同的语言栈，就要配合开发多种不同的客户端，有一定的研发和维护成本。</li>
<li>一旦客户端跟随服务调用方发布到生产环境中，后续如果要对客户库进行升级势必要求服务调用方修改代码并重新发布，所以该方案的升级推广有不小的阻力。</li>
</ul>
<h5 id="独立-LB-进程服务发现"><a href="#独立-LB-进程服务发现" class="headerlink" title="独立 LB 进程服务发现"></a>独立 LB 进程服务发现</h5><ul>
<li>针对进程内 LB 模式的不足而提出的一种折中方案，原理和第二种方案基本类似。</li>
<li>不同之处是，将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程，主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。</li>
<li>LB 独立进程可以进一步与服务消费方进行解耦，以独立集群的形式提供高可用的负载均衡服务，</li>
<li>这种模式可以称之为真正的”软负载( Soft Load Balancing )”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/独立LB进程服务发现.png" alt="独立LB进程服务发现"></p>
<ul>
<li>独立 LB 进程也是一种分布式方案，没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方。</li>
<li>服务调用方和 LB 之间是进程间调用，性能好</li>
<li>简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。</li>
<li>不足是部署较复杂，环节多，出错调试排查问题不方便。</li>
</ul>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>系统的扩展可分为纵向(垂直)扩展和横向(水平)扩展</p>
<ul>
<li>纵向扩展，是从单机的角度通过增加硬件处理能力，比如 CPU 处理能力，内存容量，磁盘等方面，实现服务器处理能力的提升，不能满足大型分布式系统(网站)，大流量，高并发，海量数据的问题;</li>
<li>横向扩展，通过添加机器来满足大型网站服务的处理能力。比如:一台机器不能满足，则增加两台或者多台机器，共同承担访问压力，这就是典型的集群和负载均衡架构。</li>
</ul>
<p>负载均衡的作用(解决的问题)</p>
<ul>
<li>解决并发压力，提高应用处理性能，增加吞吐量，加强网络处理能力;</li>
<li>提供故障转移，实现高可用;</li>
<li>通过添加或减少服务器数量，提供网站伸缩性，扩展性;</li>
<li>安全防护，负载均衡设备上做一些过滤，黑白名单等处理。</li>
</ul>
<h5 id="DNS-负载均衡"><a href="#DNS-负载均衡" class="headerlink" title="DNS 负载均衡"></a>DNS 负载均衡</h5><p>最早的负载均衡技术，利用域名解析实现负载均衡，在 DNS 服务器，配置多个 A 记录，这些 A 记录对应的服务器构成集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DNS负载均衡.png" alt="DNS负载均衡"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DNS负载均衡的优缺点.png" alt="DNS负载均衡的优缺点"></p>
<h5 id="负载均衡技术概览"><a href="#负载均衡技术概览" class="headerlink" title="负载均衡技术概览"></a>负载均衡技术概览</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/负载均衡技术概览.png" alt="负载均衡技术概览"></p>
<h5 id="网络地址转换"><a href="#网络地址转换" class="headerlink" title="网络地址转换"></a>网络地址转换</h5><p>网络地址转换( NetworkAddress Translation，NAT )通常通过修改数据包的源地址( Source NAT )或目标地址( Destination NAT )来控制数据包的转发行为</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/网络地址转换.png" alt="网络地址转换"></p>
<h5 id="新建-TCP-连接"><a href="#新建-TCP-连接" class="headerlink" title="新建 TCP 连接"></a>新建 TCP 连接</h5><p>为记录原始客户端 IP 地址，负载均衡功能不仅需要进行数据包的源目标地址修改，同时要记录原始客户端 IP 地址，基于简单的 NAT 无法满足此需求，于是衍生出了基于传输层协议的负载均衡的<br>另一种方案—— TCP/UDPTermination 方案</p>
<blockquote>
<p>Proxy protocol</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/新建TCP连接.png" alt="新建TCP连接"></p>
<h5 id="链路层负载均衡"><a href="#链路层负载均衡" class="headerlink" title="链路层负载均衡"></a>链路层负载均衡</h5><p>在通信协议的数据链路层修改 MAC 地址进行负载均衡</p>
<p>数据分发时，不修改 IP 地址，只修改目标 MAC 地址，配置真实物理服务器集群所有机器虚拟 IP 和负载均衡服务器 IP 地址一致，达到不修改数据包的源地址和目标地址，进行数据分发的目的。</p>
<p>实际处理服务器 IP 和数据请求目的 IP 一致，不需要经过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。也称为直接路由模式( DR 模式)。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/链路层负载均衡.png" alt="链路层负载均衡"></p>
<h5 id="隧道技术"><a href="#隧道技术" class="headerlink" title="隧道技术"></a>隧道技术</h5><p>负载均衡中常用的隧道技术是 IP over IP，其原理是保持原始数据包 IP 头不变，在 IP 头外层增加额外的 IP 包头后转发给上游服务器。</p>
<p>上游服务器接收 IP 数据包，解开外层 IP 包头后，剩下的是原始数据包。</p>
<p>同样的，原始数据包中的目标 IP 地址要配置在上游服务器中，上游服务器处理完数据请求以后响应包通过网关直接返回给客户端。</p>
<h3 id="Service-对象"><a href="#Service-对象" class="headerlink" title="Service 对象"></a>Service 对象</h3><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/service">https://github.com/kibaamor/101/tree/master/module8/service</a></p>
<h4 id="Service对象"><a href="#Service对象" class="headerlink" title="Service对象"></a>Service对象</h4><p>Service selector</p>
<ul>
<li>Kubernetes 允许将 Pod 对象通过标签( Label )进行标记，并通过 Service Selector 定义基于 Pod 标签的过滤规则以便选择服务的上游应用实例</li>
</ul>
<p>Ports</p>
<ul>
<li>Ports 属性中定义了服务的端口、协议目标端口等信息</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Endpoint-对象"><a href="#Endpoint-对象" class="headerlink" title="Endpoint 对象"></a>Endpoint 对象</h4><blockquote>
<p>Q：为什么需要 endpoint 对象？</p>
<p>A：为不同的 port 发布不同的服务器，处理多个 pod 对多个 service 的情况，endpont 就作为 pod 和 service 的中间表。</p>
</blockquote>
<p>当 Service 的 selector 不为空时，Kubernetes EndpointController 会侦听服务创建事件，创建与 Service 同名的 Endpoint 对象</p>
<p>selector 能够选取的所有 PodIP 都会被配置到 addresses 属性中</p>
<ul>
<li>如果此时 selector 所对应的 filter 查询不到对应的 Pod，则 addresses 列表为空</li>
<li>默认配置下，如果此时对应的 Pod 为 not ready 状态，则对应的 PodIP 只会出现在 subsets 的 notReadyAddresses 属性中，这意味着对应的 Pod 还没准备好提供服务，不能作为流量转发的目标。</li>
<li>如果设置了 PublishNotReadyAdddress 为 true，则无论 Pod 是否就绪都会被加入 readyAddress list</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoint
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.1.1.21
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> minikube
      <span class="token key atrule">targetRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>5754944d6c<span class="token punctuation">-</span>hnw27
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
        <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"722191"</span>
        <span class="token key atrule">uid</span><span class="token punctuation">:</span> 8a3390ae<span class="token punctuation">-</span>2f8e<span class="token punctuation">-</span>47bf<span class="token punctuation">-</span>b8dd<span class="token punctuation">-</span>70fae7fb0d32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Endpointslice-对象"><a href="#Endpointslice-对象" class="headerlink" title="Endpointslice 对象"></a>Endpointslice 对象</h4><p>当某个 Service 对应的 backend Pod 较多时 Endpoint 对象就会因保存的地址信息过多而变得异常庞大</p>
<p>Pod 状态的变更会引起 Endpoint 的变更 Endpoint 的变更会被推送至所有节点，从而导致持续占用大量网络带宽</p>
<p>EndpointSlice 对象，用于对 Pod 较多的 Endpoint 进行切片，切片大小可以自定义</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> discovery.k8s.io/vlbeta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpointslice
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>abc
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/service-name</span><span class="token punctuation">:</span> example
<span class="token key atrule">addressType</span><span class="token punctuation">:</span> IPv4
<span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> http
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span> <span class="token string">"10.1.2.3"</span>
      <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
        ready<span class="token punctuation">:</span><span class="token boolean important">true</span>
      <span class="token key atrule">hostname</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">1</span>
      <span class="token key atrule">topology</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span>
        <span class="token key atrule">topology.kubernetes.io/zone</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west2<span class="token punctuation">-</span>a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="不定义-Selector-的-Service"><a href="#不定义-Selector-的-Service" class="headerlink" title="不定义 Selector 的 Service"></a>不定义 Selector 的 Service</h4><p>用户创建了 Service 但不定义 Selector</p>
<ul>
<li>Endpoint Controller 不会为该 Service 自动创建 Endpoint</li>
<li>用户可以手动创建一个与 Service 同名的 Endpoint 对象，并设置任意 IP 地址到 Address 属性</li>
<li>访问该服务的请求会被转发至目标地址</li>
</ul>
<p>通过该类型服务，可以为集群外的一组 Endpoint 创建服务</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/service-without-selector.yaml">https://github.com/kibaamor/101/blob/master/module8/service/service-without-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>without<span class="token punctuation">-</span>selector
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/endpoint-without-selector.yaml">https://github.com/kibaamor/101/blob/master/module8/service/endpoint-without-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>without<span class="token punctuation">-</span>selector
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 220.181.38.148
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Service、Endpoint-和-Pod-的对应关系"><a href="#Service、Endpoint-和-Pod-的对应关系" class="headerlink" title="Service、Endpoint 和 Pod 的对应关系"></a>Service、Endpoint 和 Pod 的对应关系</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service、Endpoint和Pod的对应关系.png" alt="Service、Endpoint和Pod的对应关系"></p>
<h4 id="Service类型"><a href="#Service类型" class="headerlink" title="Service类型"></a>Service类型</h4><ul>
<li><p>clusterIP</p>
<ul>
<li>Service 的默认类型，服务被发布至仅集群内部可见的虚拟 IP 地址上。</li>
<li>在 API Server 启动时，需要通过 <code>service-cluster-ip-range</code> 参数配置虚拟 IP 地址段， API Server 中有用于分配 IP 地址和端口的组件，当该组件捕获 Service 对象并创建事件时，会从配置的虚拟 IP 地址段中去一个有效的 IP 地址，分配给该 Service 对象。</li>
</ul>
</li>
<li><p>nodePort</p>
<ul>
<li>在 API Server 启动时，需要通过 <code>node-port-range</code> 参数配置 nodePort 的范围，同样的，API Server 组件会捕获 Service 对象并创建事件，即从配置好的 nodePort 范围取一个有效端口，分配给该 Service。</li>
<li>每个节点的 kube-proxy 会尝试在服务分配的 nodePort 上建立侦听器接收请求，并转发给服务对应的后端 Pod 实例。</li>
</ul>
</li>
<li><p>LoadBalancer</p>
<ul>
<li>企业数据中心一般会采购一些负载均衡器，作为外网请求进入数据中心内部的统一流量入口。</li>
<li>针对不同的基础架构云平台，Kubernertes Cloud Manager 提供支持不同供应商API的 Service Controller。如果需要在 Openstack 云平台上搭建 Kubernetes 集群，那么只需提供一份openstack.rc，Openstack Service Controller 即可通过调用 LBaaS API 完成负载均衡配置。</li>
</ul>
</li>
</ul>
<h4 id="其他类型服务"><a href="#其他类型服务" class="headerlink" title="其他类型服务"></a>其他类型服务</h4><p>Headless Service</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/headless-svc.yaml">https://github.com/kibaamor/101/blob/master/module8/service/headless-svc.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>headless
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ClusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Headless 服务是用户将 clusterIP 显示定义为 None 的服务，</li>
<li>无头的服务意味着 Kubernetes 不会为该服务分配统一入口，包括 clusterIP，nodePort 等</li>
</ul>
<p>ExternalName Service</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/service-external-name.yaml">https://github.com/kibaamor/101/blob/master/module8/service/service-external-name.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ExternalName
  <span class="token key atrule">externalName</span><span class="token punctuation">:</span> tencent.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>为一个服务创建别名</li>
</ul>
<p>Headless 和 externalName 服务的使用场景?我们随后讨论</p>
<h4 id="Service-Topology"><a href="#Service-Topology" class="headerlink" title="Service Topology"></a>Service Topology</h4><p>一个网络调用的延迟受客户端和服务器所处位置的影响，两者是否在同一节点、同一机架、同-可用区、同一数据中心，都会影响参与数据传输的设备数量</p>
<p>在分布式系统中，为保证系统的高可用，往往需要控制应用的错误域( FailureDomain )，比如通过反亲和性配置，将一个应用的多个副本部署在不同机架，甚至不同的数据中心</p>
<p>Kubernetes 提供通用标签来标记节点所处的物理位置，如:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">topology.kubernetes.io/zone</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west2<span class="token punctuation">-</span>a
<span class="token key atrule">failure-domain.beta.kubernetes.io/region</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west
<span class="token key atrule">failure-domain.tess.io/network-device</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west05<span class="token punctuation">-</span>ra053
<span class="token key atrule">failure-domain.tess.io/rack</span><span class="token punctuation">:</span> us_west02_02<span class="token punctuation">-</span>314_19_12
<span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Service 引入了 topologyKeys 属性，可以通过如下设置来控制流量</p>
<ul>
<li>当 topologyKeys 设置为 [“kubernetes.io/hostname”] 时，调用服务的客户端所在节点上如果有服务实例正在运行，则该实例处理请求，否则，调用失败。</li>
<li>当 topologyKeys 设置为 [“kubernetes.io/hostname”,”topology.kubernetes.io/zone”,”topology.kubernetes.io/region”] 时，若同一节点有对应的服务实例，则请求会优先转发至该实例。否则，顺序查找当前 zone 及当前 region 是否有服务实例，并将请求按顺序转发。</li>
<li>当 topologyKeys 设置为 [“topology.kubernetes.io/zone”,”*”] 时，请求会被优先转发至当前 zone 的服务实例。如果当前 zone 不存在服务实例，则请求会被转发至任意服务实例。</li>
</ul>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><h4 id="kube-proxy-1"><a href="#kube-proxy-1" class="headerlink" title="kube-proxy"></a>kube-proxy</h4><p>每台机器上都运行一个 kube-proxy 服务，它监听 API server 中 service 和 endpoint 的变化情况，并通过 iptables 等来为服务配置负载均衡(仅支持 TCP 和 UDP )。</p>
<p>kube-proxy 可以直接运行在物理机上，也可以以 static pod 或者 DaemonSet 的方式运行。</p>
<p>kube-proxy 当前支持一下几种实现</p>
<ul>
<li>userspace：最早的负载均衡方案，它在用户空间监听一个端口，所有服务通过 iptables 转发到这个端口，然后在其内部负载均衡到实际的 Pod。该方式最主要的问题是效率低，有明显的性能瓶颈</li>
<li>iptables：目前推荐的方案，完全以 iptables 规则的方式来实现 service 负载均衡。该方式最主要的问题是在服务多的时候产生太多的 iptables 规则，非增量式更新会引入一定的时<br>延，大规模情况下有明显的性能问题</li>
<li>ipvs：为解决 iptables 模式的性能问题，v1.8 新增了 ipvs 模式，采用增量式更新，并可以保证 service 更新期间连接保持不断开</li>
<li>winuserspace：同 userspace，但仅工作在 windows 上</li>
</ul>
<h4 id="Linux内核处理数据包：Netfilter-框架"><a href="#Linux内核处理数据包：Netfilter-框架" class="headerlink" title="Linux内核处理数据包：Netfilter 框架"></a>Linux内核处理数据包：Netfilter 框架</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Netfilter框架.png" alt="Netfilter框架"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35376521/article/details/126930679">tcpdump 和 iptables(netfilter) 处理数据包的先后顺序</a></p>
<p>结论</p>
<ul>
<li>进站的数据包先经过 tcpdump，再经过 iptables</li>
<li>出站的数据包先经过 iptables，再经过 tcpdump</li>
</ul>
<p>原理分析</p>
<ul>
<li>事实上tcpdump在链路层就已经捕获数据包 (从 tcpdump man page 得知)</li>
<li>而 iptables 工作在协议栈的网络层，原理上 tcpdump 就比 iptables 更接近网卡设备</li>
</ul>
</blockquote>
<h4 id="Netfilter-和-iptables"><a href="#Netfilter-和-iptables" class="headerlink" title="Netfilter 和 iptables"></a>Netfilter 和 iptables</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Netfilter和iptables.png" alt="Netfilter和iptables"></p>
<h4 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/iptables.png" alt="iptables"></p>
<h4 id="iptables-支持的锚点"><a href="#iptables-支持的锚点" class="headerlink" title="iptables 支持的锚点"></a>iptables 支持的锚点</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/iptables支持的锚点.png" alt="iptables支持的锚点"></p>
<h4 id="kube-proxy-工作原理"><a href="#kube-proxy-工作原理" class="headerlink" title="kube-proxy 工作原理"></a>kube-proxy 工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kube-proxy工作原理.png" alt="kube-proxy工作原理"></p>
<h4 id="Kubernetes-iptables-规则"><a href="#Kubernetes-iptables-规则" class="headerlink" title="Kubernetes iptables 规则"></a>Kubernetes iptables 规则</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetesiptables规则.png" alt="Kubernetesiptables规则"></p>
<h4 id="iptables-示例"><a href="#iptables-示例" class="headerlink" title="iptables 示例"></a>iptables 示例</h4><h5 id="ClusterIP-的-iptables-规则分析"><a href="#ClusterIP-的-iptables-规则分析" class="headerlink" title="ClusterIP 的 iptables 规则分析"></a>ClusterIP 的 iptables 规则分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-basic -owide
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
nginx-basic   ClusterIP   <span class="token number">10.96</span>.240.161   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    74m   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx

$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx -owide
NAME                                READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-77b4fdf86c-glrrd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.52   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-77b4fdf86c-k7mf4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.51   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-77b4fdf86c-wplrw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.50   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES

-A KUBE-SERVICES -d 10.96.240.161/32 -p tcp -m comment --comment "default/nginx-basic:http cluster IP" -m tcp --dport 80 -j KUBE-SVC-WWRFY3PZ7W3FGMQW

-A KUBE-SVC-WWRFY3PZ7W3FGMQW ! -s 10.244.0.0/16 -d 10.96.240.161/32 -p tcp -m comment --comment "default/nginx-basic:http cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.50:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-GDFWTYWRXAR6P5IV
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.51:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-KT26XBLI5UEBCGC6
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.52:80" -j KUBE-SEP-LEDXNGZ5TZMIGQDD

-A KUBE-SEP-GDFWTYWRXAR6P5IV -s 10.244.0.50/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-GDFWTYWRXAR6P5IV -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.50:80

-A KUBE-SEP-KT26XBLI5UEBCGC6 -s 10.244.0.51/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-KT26XBLI5UEBCGC6 -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.51:80

-A KUBE-SEP-LEDXNGZ5TZMIGQDD -s 10.244.0.52/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-LEDXNGZ5TZMIGQDD -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.52:80

-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING

-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000 # mark packet with 0x4000

-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN
-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0 # clear mark 0x4000
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully

-A FORWARD -m comment --comment "kubernetes forwarding rules" -j KUBE-FORWARD

-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -m mark --mark 0x4000/0x4000 -j ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man8/iptables-extensions.8.html">iptables-extensions(8) — Linux manual page</a></p>
</blockquote>
<h5 id="NodePort-的-iptables-分析"><a href="#NodePort-的-iptables-分析" class="headerlink" title="NodePort 的 iptables 分析"></a>NodePort 的 iptables 分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-service
NAME            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
nginx-service   NodePort   <span class="token number">10.97</span>.2.223   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30506/TCP   171m

$ kubectl get ep nginx-service
NAME            ENDPOINTS                                     AGE
nginx-service   <span class="token number">10.244</span>.0.10:80,10.244.0.11:80,10.244.0.9:80   171m

$ nft list chain <span class="token function">ip</span> nat KUBE-NODEPORTS
table <span class="token function">ip</span> nat <span class="token punctuation">{</span>
    chain KUBE-NODEPORTS <span class="token punctuation">{</span>
        meta l4proto tcp  tcp dport <span class="token number">30506</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-6IM33IEVEEV7U3GP
        meta l4proto tcp  tcp dport <span class="token number">31235</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-CG5I4G2RS3ZVWGLK
        meta l4proto tcp  tcp dport <span class="token number">31687</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-EDNDUDH2C75GIR6O
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES

-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS

-A KUBE-NODEPORTS -p tcp -m comment --comment "default/nginx-service:http" -j KUBE-EXT-6IM33IEVEEV7U3GP

-A KUBE-EXT-6IM33IEVEEV7U3GP -m comment --comment "masquerade traffic for default/nginx-service:http external destinations" -j KUBE-MARK-MASQ
-A KUBE-EXT-6IM33IEVEEV7U3GP -j KUBE-SVC-6IM33IEVEEV7U3GP

-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000

-A KUBE-SVC-6IM33IEVEEV7U3GP ! -s 10.244.0.0/16 -d 10.97.2.223/32 -p tcp -m comment --comment "default/nginx-service:http cluster IP" -j KUBE-MARK-MASQ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.10:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-UNA35ZJ3UYOAR4VQ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.11:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BSP7ITGKKKE54DZJ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.9:80" -j KUBE-SEP-5AGZ67ZS4PKMABRU

-A KUBE-SEP-UNA35ZJ3UYOAR4VQ -s 10.244.0.10/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-UNA35ZJ3UYOAR4VQ -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.10:80

-A KUBE-SEP-BSP7ITGKKKE54DZJ -s 10.244.0.11/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-BSP7ITGKKKE54DZJ -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.11:80

-A KUBE-SEP-5AGZ67ZS4PKMABRU -s 10.244.0.9/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-5AGZ67ZS4PKMABRU -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.9:80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md">https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/IPVS.png" alt="IPVS"></p>
<h4 id="IPVS-支持的锚点和核心函数"><a href="#IPVS-支持的锚点和核心函数" class="headerlink" title="IPVS 支持的锚点和核心函数"></a>IPVS 支持的锚点和核心函数</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/IPVS支持的锚点和核心函数.png" alt="IPVS支持的锚点和核心函数"></p>
<p>注意：PREROUTING 和 POSTROUTING 这个两个地方是没有 hook 的，所以 ipvs 不能像 iptables 那样在 PREROUTING 做 dnat 或者 在 POSTROUTING 做 dnat。</p>
<p>ipvs 的做法是在本机虚拟出一个新的网卡（一般叫 <code>kube-ipvs0</code>），然后把所有的 cluster ip 都绑定到这个网卡上，但是不接受 arp 的请求，所以依然不能 ping 通（ping 时会返回错误 <code>Destination Port Unreachable</code>）。随后当访问 cluster ip 时，kernel 就可以在 LOCAL_IN 做转发规则了。</p>
<p>因为 ipvs 在 POSTROUTING 是没有 hook 的，当需要做数据包转发 IP 伪装（IP 伪装指的是网络包从 pod 发出时，需要伪装成从 node 发出的，不然就可能收不到发回的数据包）时，即在数据包离开当前 Node 时需要进行处理，而由于 ipvs 在 POSTROUTING 是没有 hook 的，所以即使开启了 ipvs ，也需要通过配置一条 iptables 规则来完成 IP 伪装。</p>
<p>那么具体是如何用一条规则来完成 IP 伪装呢？通过使用 <code>ipset</code> 来完成。它会把那些一系列相同类型的 ip 归为一类来一起操作。</p>
<h5 id="ipvs-的分析"><a href="#ipvs-的分析" class="headerlink" title="ipvs 的分析"></a>ipvs 的分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-service
NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
nginx-service   ClusterIP   <span class="token number">10.96</span>.57.249   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    20m

$ kubectl get ep nginx-service
NAME            ENDPOINTS                     AGE
nginx-service   <span class="token number">10.244</span>.0.6:80,10.244.0.7:80   56m

$ ipvsadm -L -n
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.96</span>.57.249:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.6:53                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.7:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

$ <span class="token function">ip</span> addr show dev kube-ipvs0
<span class="token number">7</span>: kube-ipvs0: <span class="token operator">&lt;</span>BROADCAST,NOARP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default
    link/ether be:23:dc:d5:57:95 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.96</span>.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.96</span>.57.249/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.96</span>.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

$ <span class="token function">sudo</span> ipset -L
Name: KUBE-IPVS-IPS
Type: hash:ip
Revision: <span class="token number">5</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x70d2a064
Size <span class="token keyword">in</span> memory: <span class="token number">320</span>
References: <span class="token number">1</span>
Number of entries: <span class="token number">3</span>
Members:
<span class="token number">10.96</span>.0.1
<span class="token number">10.96</span>.57.249
<span class="token number">10.96</span>.0.10

Name: KUBE-CLUSTER-IP
Type: hash:ip,port
Revision: <span class="token number">6</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x9d4edeef
Size <span class="token keyword">in</span> memory: <span class="token number">440</span>
References: <span class="token number">3</span>
Number of entries: <span class="token number">5</span>
Members:
<span class="token number">10.96</span>.0.10,udp:53
<span class="token number">10.96</span>.0.10,tcp:53
<span class="token number">10.96</span>.57.249,tcp:80
<span class="token number">10.96</span>.0.1,tcp:443
<span class="token number">10.96</span>.0.10,tcp:9153

Name: KUBE-LOOP-BACK
Type: hash:ip,port,ip
Revision: <span class="token number">6</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x7a7e1a5a
Size <span class="token keyword">in</span> memory: <span class="token number">488</span>
References: <span class="token number">1</span>
Number of entries: <span class="token number">5</span>
Members:
<span class="token number">10.244</span>.0.5,tcp:9153,10.244.0.5
<span class="token number">10.244</span>.0.7,tcp:80,10.244.0.7
<span class="token number">10.244</span>.0.6,tcp:80,10.244.0.6
<span class="token number">10.244</span>.0.5,udp:53,10.244.0.5
<span class="token number">10.244</span>.0.5,tcp:53,10.244.0.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">*filter
-A INPUT -m comment --comment "kubernetes ipvs access filter" -j KUBE-IPVS-FILTER

-A KUBE-IPVS-FILTER -m set --match-set KUBE-CLUSTER-IP dst,dst -j RETURN
-A KUBE-IPVS-FILTER -m conntrack --ctstate NEW -m set --match-set KUBE-IPVS-IPS dst -j REJECT --reject-with icmp-port-unreachable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这也是为什么在 ipvs 模式下，ping cluster ip 会返回错误 <code>icmp-port-unreachable</code>。</p>
</blockquote>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">*nat
-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING
-A KUBE-LOAD-BALANCER -j KUBE-MARK-MASQ
-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
-A KUBE-POSTROUTING -m comment --comment "Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose" -m set --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE
-A KUBE-POSTROUTING -j RETURN
-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully
-A KUBE-SERVICES -s 127.0.0.0/8 -j RETURN
-A KUBE-SERVICES ! -s 10.244.0.0/16 -m comment --comment "Kubernetes service cluster ip + port for masquerade purpose" -m set --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ
-A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODE-PORT
-A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="调整-kube-proxy-使用-ipvs"><a href="#调整-kube-proxy-使用-ipvs" class="headerlink" title="调整 kube-proxy 使用 ipvs"></a>调整 kube-proxy 使用 ipvs</h4><blockquote>
<p>IPVS proxier will employ IPTABLES in doing packet filtering, SNAT or masquerade. Specifically, IPVS proxier will use ipset to store source or destination address of traffics that need DROP or do masquerade, to make sure the number of IPTABLES rules be constant, no matter how many services we have.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#when-ipvs-falls-back-to-iptables">When IPVS falls back to IPTABLES</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#run-kube-proxy-in-ipvs-mode">Run kube-proxy in IPVS mode</a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ minikube start --addons<span class="token operator">=</span>dashboard,metrics-server,ingress --cpus<span class="token operator">=</span><span class="token number">4</span> --memory<span class="token operator">=</span>8g --extra-config<span class="token operator">=</span>kube-proxy.proxy-mode<span class="token operator">=</span>ipvs --nodes<span class="token operator">=</span><span class="token number">2</span>

$ kubectl -n kube-system get configmap kube-proxy -oyaml <span class="token operator">|</span> <span class="token function">grep</span> mode
    mode: <span class="token string">"ipvs"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get configmap
NAME                                                   DATA   AGE
coredns                                                <span class="token number">1</span>      13m
extension-apiserver-authentication                     <span class="token number">6</span>      13m
kube-apiserver-legacy-service-account-token-tracking   <span class="token number">1</span>      13m
kube-proxy                                             <span class="token number">2</span>      13m
kube-root-ca.crt                                       <span class="token number">1</span>      12m
kubeadm-config                                         <span class="token number">1</span>      13m
kubelet-config                                         <span class="token number">1</span>      13m

$ kubectl -n kube-system edit configmap kube-proxy
<span class="token comment"># change mode from "" to "ipvs"</span>

$ kubectl -n kube-system get configmap kube-proxy -oyaml <span class="token operator">|</span> <span class="token function">grep</span> mode
    mode: <span class="token string">"ipvs"</span>

$ kubectl -n kube-system get pods
NAME                               READY   STATUS    RESTARTS      AGE
coredns-7db6d8ff4d-44mqh           <span class="token number">1</span>/1     Running   <span class="token number">0</span>             14m
etcd-minikube                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-apiserver-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-controller-manager-minikube   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-proxy-6s7hr                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             9m55s
kube-scheduler-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
storage-provisioner                <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>14m ago<span class="token punctuation">)</span>   15m

<span class="token comment"># delete kube-proxy pod to take effect</span>
$ kubectl -n kube-system delete pod kube-proxy-6s7hr
pod <span class="token string">"kube-proxy-6s7hr"</span> deleted

$ minikube <span class="token function">ssh</span>
$ <span class="token function">sudo</span> ipvsadm -L -n
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.96</span>.57.249:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.3:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.4:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>如果 kube-proxy 的模式配置的是使用 ipvs，但是一个节点并未安装 ipvs 模块，那么在这个节点会自动降级使用 iptables。</p>
</blockquote>
<h4 id="域名服务"><a href="#域名服务" class="headerlink" title="域名服务"></a>域名服务</h4><p>Kubernetes Service 通过虚拟 IP 地址或者节点端口为用户应用提供访问入口</p>
<p>然而这些 IP 地址和端口是动态分配的，如果用户重建一个服务，其分配的 clusterIP 和 nodePort，以及 LoadBalancerIP 都是会变化的，我们无法把一个可变的入口发布出去供他人访问</p>
<p>Kubernetes 提供了内置的域名服务，用户定义的服务会自动获得域名，而无论服务重建多少次，只要服务名不改变，其对应的域名就不会改变</p>
<h4 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h4><p>CoreDNS 包含一个内存态 DNS，以及与其他 controller 类似的控制器</p>
<p>CoreDNS 的实现原理是，控制器监听 Service 和 Endpoint 的变化并配置 DNS，客户端 Pod 在进行域名解析时，从 CoreDNS 中查询服务对应的地址记录</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CoreDNS.png" alt="CoreDNS"></p>
<h4 id="不同类型服务的-DNS-记录"><a href="#不同类型服务的-DNS-记录" class="headerlink" title="不同类型服务的 DNS 记录"></a>不同类型服务的 DNS 记录</h4><ul>
<li>普通 Service<ul>
<li>ClusterIP、nodePort、LoadBalancer 类型的 Service 都拥有 API Server 分配的 ClusterIP，CoreDNS 会为这些 Service 创建 FQDN 格式为 <code>$svcname.$namespace.svc.$clusterdomain:clusterIP</code> 的 A 记录及 PTR 记录，并为端口创建 SRV 记录。</li>
</ul>
</li>
<li>Headless Service<ul>
<li>顾名思义，无头，是用户在 Spec 显式指定 ClusterIP 为 None 的 Service，对于这类 Service，API Server 不会为其分配 ClusterIP。CoreDNS 为此类 Service 创建多条 A 记录，并且目标为每个就绪的 PodIP。</li>
<li>另外，每个 Pod 会拥有一个 FQDN 格式为 <code>$podname.$svcname.$namespace.svc.$clusterdomain</code> 的 A 记录指向 PodIP。</li>
</ul>
</li>
<li>ExternalName Service<ul>
<li>此类 Service 用来引用一个已经存在的域名，CoreDNS 会为该 Service 创建一个 CName 记录指向目标域名。</li>
</ul>
</li>
</ul>
<blockquote>
<p>从 ClusterIP 到 nodePort 到 LoadBalancer，后一个类型都包含前一个类型的内容。比如 NodePort 也会有一个 ClusterIP。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">dig</span> @10.96.0.10 nginx-headless-service.default.svc.cluster.local
<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> DiG <span class="token number">9.18</span>.24-1-Debian <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> @10.96.0.10 nginx-headless-service.default.svc.cluster.local
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token number">1</span> server found<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: .local is reserved <span class="token keyword">for</span> Multicast DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> You are currently testing what happens when an mDNS query is leaked to DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">&gt;&gt;</span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">20453</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">3</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: recursion requested but not available

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">1232</span>
<span class="token punctuation">;</span> COOKIE: 6958770a033fcd30 <span class="token punctuation">(</span>echoed<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>nginx-headless-service.default.svc.cluster.local. IN A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.13
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.12
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.14

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">10</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">10.96</span>.0.10<span class="token comment">#53(10.96.0.10) (UDP)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu May <span class="token number">16</span> <span class="token number">10</span>:29:47 UTC <span class="token number">2024</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">281</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Kubernetes-中的域名解析"><a href="#Kubernetes-中的域名解析" class="headerlink" title="Kubernetes 中的域名解析"></a>Kubernetes 中的域名解析</h4><p>Kubernetes Pod 有一个与 DNS 策略相关的属性 DNSPolicy，默认值是 ClusterFirst。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy">Pod’s DNS Policy</a></p>
</blockquote>
<p>Pod启动后的 <code>/etc/resolv.conf</code> 会被改写，所有的地址解析优先发送至 CoreDNS</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /etc/resolv.conf
search ns1.svc.cluster.local svc.cluster.local cluster.local
nameserver <span class="token number">192.168</span>.0.10
options ndots:4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ndots 的意思是如果待查询的域名中点 “.” 的数量小于 ndots 的数量，那么解析这个域名时就是尝试将 search 后配置的域名按顺序添加到带解析的域名后，直到成功。</p>
<p>比如：解析域名 nginx-service 时，因为域名中的点 “.” 的个数为 0，小于配置的 ndots 数，就会依次尝试解析域名 <code>nginx-service.ns1.svc.cluster.local</code>，<code>nginx-service.svc.cluster.local</code> 和 <code>nginx-service.cluster.local</code>。</p>
</blockquote>
<p>当 Pod 启动时，同一 Namespace 的所有 Service 都会以环境变量的形式设置到容器内（更准确的来说是能只用 service name 解析出同一 namespace 中的所有 service 的 IP）</p>
<p>影响?</p>
<h4 id="自定义-DNSPolicy"><a href="#自定义-DNSPolicy" class="headerlink" title="自定义 DNSPolicy"></a>自定义 DNSPolicy</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config">Pod’s DNS Config</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dns<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> <span class="token string">"None"</span>
  <span class="token key atrule">dnsConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">nameservers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 192.0.2.1 <span class="token comment"># this is an example</span>
    <span class="token key atrule">searches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ns1.svc.cluster<span class="token punctuation">-</span>domain.example
      <span class="token punctuation">-</span> my.dns.search.suffix
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ndots
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> edns0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CoreDNS-的配置"><a href="#CoreDNS-的配置" class="headerlink" title="CoreDNS 的配置"></a>CoreDNS 的配置</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">$ kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get configmap coredns <span class="token punctuation">-</span>oyaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    .:53 {
        log
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        hosts {
           192.168.49.1 host.minikube.internal
           fallthrough
        }
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2024-05-16T09:16:06Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"253"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> aabafb2b<span class="token punctuation">-</span>f121<span class="token punctuation">-</span>4a2f<span class="token punctuation">-</span>896b<span class="token punctuation">-</span>89be5142d4d5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="关于-DNS-的落地实践"><a href="#关于-DNS-的落地实践" class="headerlink" title="关于 DNS 的落地实践"></a>关于 DNS 的落地实践</h4><p>Kubernetes 作为企业基础架构的一部分，Kubernetes 服务也需要发布到企业 DNS，需要定制企业 DNS 控制器</p>
<ul>
<li>对于 Kubernetes 中的服务，在企业 DNS 同样创建 A/PTR/SRV records (通常解析地址是 LoadBalancer VIP)</li>
<li>针对 headless service，在 PodIP 可全局路由的前提下，按需创建 DNS records</li>
<li>Headless service 的 DNS 记录，应该按需创建，否则对企业 DNS 冲击过大</li>
</ul>
<p>服务在集群内通过 CoreDNS 寻址，在集群外通过企业 DNS 寻址，服务在集群内外有统一标识。</p>
<h4 id="Kubernetes-中的负载均衡技术"><a href="#Kubernetes-中的负载均衡技术" class="headerlink" title="Kubernetes 中的负载均衡技术"></a>Kubernetes 中的负载均衡技术</h4><p>基于 L4 的服务</p>
<ul>
<li>基于 iptables/ipvs 的分布式四层负载均衡技术</li>
<li>多种 Load Balancer Provider 提供与企业现有 ELB 的整合</li>
<li>kube-proxy 基于 iptables rules 为 Kubernetes 形成全局统一的 distributed load balancer</li>
<li>kube-proxy 是一种 mesh, InternalClient 无论通过 podip，nodeport 还是 LBVIP 都经由 kube-proxy 跳转至pod</li>
<li>属于 Kubernetes core</li>
</ul>
<p>基于L7的 Ingress</p>
<ul>
<li>基于七层应用层，提供更多功能</li>
<li>TLS termination</li>
<li>L7 path forwarding</li>
<li>URL/http header rewrite</li>
<li>与采用 7 层软件紧密相关</li>
</ul>
<h4 id="Service-中的-Ingress-的对比"><a href="#Service-中的-Ingress-的对比" class="headerlink" title="Service 中的 Ingress 的对比"></a>Service 中的 Ingress 的对比</h4><p>基于 L4 的服务</p>
<ul>
<li>每个应用独占 ELB，浪费资源</li>
<li>为每个服务动态创建 DNS 记录，频繁的 DNS 更新</li>
<li>支持 TCP 和 UDP，业务部门需要启动 HTTPS 服务，自己管理证书</li>
</ul>
<p>基于 L7 的 Ingress</p>
<ul>
<li>多个应用共享 ELB，节省资源</li>
<li>多个应用共享一个 Domain，可采用静态 DNS 配置</li>
<li>TLS termination 发生在 Ingress 层，可集中管理证书</li>
<li>更多复杂性，更多的网络 hop</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service中的Ingress的对比.png" alt="Service中的Ingress的对比"></p>
<h4 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h4><p>ingress</p>
<ul>
<li>Ingress 是一层代理</li>
<li>负责根据 hostname 和 path 将流量转发到不同的服务上，使得一个负载均衡器用于多个后台应用</li>
<li>Kubernetes Ingress Spec 是转发规则的集合</li>
</ul>
<p>ingress Controller</p>
<ul>
<li>确保实际状态( Actual )与期望状态( Desired )一致的 ControlLoop</li>
<li>Ingress Controller 确保</li>
<li>负载均衡配置</li>
<li>边缘路由配置</li>
<li>DNS 配置</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ingress.png" alt="ingress"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/ingress/ingress.MD">https://github.com/kibaamor/101/blob/master/module8/ingress/ingress.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://cert-manager.io/docs/configuration/ca/">https://cert-manager.io/docs/configuration/ca/</a></p>
<p><a target="_blank" rel="noopener" href="https://cert-manager.io/docs/configuration/selfsigned/">https://cert-manager.io/docs/configuration/selfsigned/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成 key 和 cert</span>
$ openssl req -x509 -nodes -days <span class="token number">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt <span class="token punctuation">\</span>
  -subj <span class="token string">'/CN=*/O=kiba'</span> <span class="token punctuation">\</span>
  -addext <span class="token string">'subjectAltName = DNS:kiba.zen'</span>
<span class="token comment"># OR</span>
$ mkcert -key-file tls.key -cert-file tls.crt -- kiba.zen

<span class="token comment"># 创建 secret</span>
$ kubectl create secret tls kiba-tls --cert<span class="token operator">=</span>./tls.crt --key<span class="token operator">=</span>./tls.key
secret/kiba-tls created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># filename: nginx.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kiba.zen
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kiba<span class="token punctuation">-</span>tls
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kiba.zen
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">service</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
              <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 nginx</span>
$ kubectl apply -f nginx.yaml
deployment.apps/nginx-deploy created
service/nginx-svc created
ingress.networking.k8s.io/nginx-ingress created

$ minikube <span class="token function">ip</span>
<span class="token number">192.168</span>.49.2

<span class="token comment"># 确保没有代理，https_proxy 和 HTTPS_PROXY 的值为空</span>
$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> <span class="token function">curl</span> --resolve <span class="token string">"kiba.zen:443:192.168.49.2"</span> --cacert ./tls.crt https://kiba.zen
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="传统应用网络拓扑"><a href="#传统应用网络拓扑" class="headerlink" title="传统应用网络拓扑"></a>传统应用网络拓扑</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/传统应用网络拓扑.png" alt="传统应用网络拓扑"></p>
<h4 id="三步构建-Ingress-Controller"><a href="#三步构建-Ingress-Controller" class="headerlink" title="三步构建 Ingress Controller"></a>三步构建 Ingress Controller</h4><p>复用 Kubernetes LoadBalancer 接口</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">GetLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>LoadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">EnsureLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Senvice<span class="token punctuation">,</span> members <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>LoadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">UpdateLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">,</span> members <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>oadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">EnsureLoadBalancerDeleted</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token builtin">error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义 Informer，监控 ingress，secret，service，endpoint 的变化，加入相应的队列</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">lbc<span class="token punctuation">.</span>ingLister<span class="token punctuation">.</span>Store<span class="token punctuation">,</span>lbc<span class="token punctuation">.</span>ingController <span class="token operator">=</span> framework<span class="token punctuation">.</span><span class="token function">Newinformer</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>Listwatch<span class="token punctuation">{</span>
        ListFunc<span class="token punctuation">:</span> <span class="token function">ingressListFunc</span><span class="token punctuation">(</span>lbc<span class="token punctuation">.</span>client<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">,</span>
        WatchFunc<span class="token punctuation">:</span> <span class="token function">ingressWatchFunc</span><span class="token punctuation">(</span>lbc<span class="token punctuation">.</span>client<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>extensions<span class="token punctuation">.</span>Ingress<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
        AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obi <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            lbc<span class="token punctuation">.</span>ingQueue<span class="token punctuation">.</span><span class="token function">enqueueing</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动 worker，遍历 ingress 队列</p>
<ul>
<li>为 Ingress Domain 创建 LoadBalancer service 依 赖service controller 创建 ingress vip</li>
<li>为 Ingress Domain 创建 DNS A record 并指向 Ingress VIP</li>
<li>更新 Ingress 状态</li>
</ul>
<h4 id="为什么需要构建-SLB-方案"><a href="#为什么需要构建-SLB-方案" class="headerlink" title="为什么需要构建 SLB 方案"></a>为什么需要构建 SLB 方案</h4><p>成本</p>
<ul>
<li>硬件 LB 价格昂贵</li>
<li>固定的 tech refresh 周期</li>
</ul>
<p>配置管理</p>
<ul>
<li>LB 设备的 onboard/offboard 由不同 team 管理</li>
<li>不同设备 API 不一样，不支持 L7 API</li>
<li>基于传统的 ssh 接口，效率低下</li>
<li>Flex up/down 以及 Migration 复杂</li>
</ul>
<p>部署模式</p>
<ul>
<li>1+1 模式</li>
<li>隔离性差</li>
</ul>
<h4 id="堪待解决的问题"><a href="#堪待解决的问题" class="headerlink" title="堪待解决的问题"></a>堪待解决的问题</h4><p>负载均衡配置</p>
<ul>
<li>7 层方案：Envoy vs. Nginx vs. Haproxy</li>
<li>4 层方案：抛弃传统 HLB 的支持，用 IPVS 取代</li>
</ul>
<p>边缘路由配置</p>
<ul>
<li>Ingress VIP 通过 BGP 协议发布给 TOR</li>
</ul>
<p>DNS 配置</p>
<ul>
<li>Ingress VIP 通过 BGP 协议发布给 TOR</li>
</ul>
<p>需要解决问题：如何让 domain 用户自定义后台应用的访问地址，如何优化访问路径</p>
<ul>
<li><p>L4 Provider</p>
<p>  IPVS 插件</p>
<ul>
<li>基于 IPAM 分配 VIP</li>
<li>将 VIP 绑定至 IPVS Directors</li>
<li>创建 IP tunnel</li>
<li>通过 BGP 发布 VIP 路由</li>
</ul>
</li>
<li><p>L7 Provider</p>
<ul>
<li>基于 Envoy 提供 L7 Path forwarding</li>
<li>可以提供 TLS Termination</li>
<li>基于 upstream 的 Istio 实现配置管理和热加载</li>
<li>基于 Istio 实现 Service Mesh</li>
</ul>
</li>
<li><p>DNS Provider</p>
<ul>
<li>创建 DNS 记录</li>
<li>为多个 Cluster 的 ingress VIP 生成相同的 DNS 记录实现 DNS 联邦</li>
</ul>
</li>
<li><p>Ingress Controller</p>
<ul>
<li>编排控制器</li>
<li>为 ingress 创建 service object，将 LB 配置委派给 service controller</li>
<li>创建 configmap 为每个 ingress 创建 envoy 配置</li>
<li>创建 L7 pod 的 deployment 加载 envoy 集群</li>
<li>生成 DNS 记录</li>
</ul>
</li>
</ul>
<h4 id="L4-集群架构"><a href="#L4-集群架构" class="headerlink" title="L4 集群架构"></a>L4 集群架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/L4集群架构.png" alt="L4集群架构"></p>
<h4 id="L7-集群架构"><a href="#L7-集群架构" class="headerlink" title="L7 集群架构"></a>L7 集群架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/L7集群架构.png" alt="L7集群架构"></p>
<h4 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据流.png" alt="数据流"></p>
<h4 id="跨大陆的互联网调用"><a href="#跨大陆的互联网调用" class="headerlink" title="跨大陆的互联网调用"></a>跨大陆的互联网调用</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/跨大陆的互联网调用.png" alt="跨大陆的互联网调用"></p>
<h4 id="互联网路径的不确定性"><a href="#互联网路径的不确定性" class="headerlink" title="互联网路径的不确定性"></a>互联网路径的不确定性</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/互联网路径的不确定性.png" alt="互联网路径的不确定性"></p>
<h4 id="边缘加速方案综述"><a href="#边缘加速方案综述" class="headerlink" title="边缘加速方案综述"></a>边缘加速方案综述</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/边缘加速方案综述.png" alt="边缘加速方案综述"></p>
<h4 id="边缘加速组件"><a href="#边缘加速组件" class="headerlink" title="边缘加速组件"></a>边缘加速组件</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/边缘加速组件.png" alt="边缘加速组件"></p>
<h4 id="对网络路径的优化"><a href="#对网络路径的优化" class="headerlink" title="对网络路径的优化"></a>对网络路径的优化</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/对网络路径的优化.png" alt="对网络路径的优化"></p>
<h4 id="不同方案的响应时间对比"><a href="#不同方案的响应时间对比" class="headerlink" title="不同方案的响应时间对比"></a>不同方案的响应时间对比</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/不同方案的响应时间对比.png" alt="不同方案的响应时间对比"></p>
<h4 id="课后作业-第二部分"><a href="#课后作业-第二部分" class="headerlink" title="课后作业(第二部分)"></a>课后作业(第二部分)</h4><p>除了将 httpServer 应用优雅的运行在 Kubernetes 之上，我们还应该考虑如何将服务发布给对内和对外的调用方。</p>
<p>来尝试用 Service，Ingress 将你的服务发布给集群外部的调用方吧</p>
<p>在第一部分的基础上提供更加完备的部署 spec，包括(不限于)</p>
<ul>
<li>Service</li>
<li>Ingress</li>
</ul>
<p>可以考虑的细节</p>
<ul>
<li>如何确保整个应用的高可用</li>
<li>如何通过证书保证 httpServer 的通讯安全</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/yun-yuan-sheng-xun-lian-ying-xue-xi-bi-ji/">https://kibazen.cn/yun-yuan-sheng-xun-lian-ying-xue-xi-bi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                    <span class="chip bg-color">极客时间</span>
                                </a>
                            
                                <a href="/tags/kubernetes/">
                                    <span class="chip bg-color">kubernetes</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/yun-yuan-sheng-xun-lian-ying-xue-xi-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/7.jpg" class="responsive-img" alt="《云原生训练营》学习笔记">
                        
                        <span class="card-title">《云原生训练营》学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-03-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                        <span class="chip bg-color">极客时间</span>
                    </a>
                    
                    <a href="/tags/kubernetes/">
                        <span class="chip bg-color">kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/ling-yu-qu-dong-she-ji-xiang-guan-de-ruan-jian-jia-gou/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/21.jpg" class="responsive-img" alt="领域驱动设计相关的软件架构">
                        
                        <span class="card-title">领域驱动设计相关的软件架构</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-11-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="post-category">
                                    软件工程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/">
                        <span class="chip bg-color">领域驱动设计</span>
                    </a>
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/">
                        <span class="chip bg-color">软件架构</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:5093911+kibaamor@users.noreply.github.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
