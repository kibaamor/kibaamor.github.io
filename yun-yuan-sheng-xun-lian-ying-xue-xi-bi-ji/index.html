<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="《云原生训练营》学习笔记, kiba, zen, amor, kibazen, kibaamor, 木叶, 木叶禅">
    <meta name="description" content="You are too concerned with what was and what will be">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>《云原生训练营》学习笔记 | 木叶禅</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="木叶禅" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">木叶禅</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/learn/" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>Learn</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/memo/" class="waves-effect waves-light">
      
      <i class="fas fa-sticky-note" style="zoom: 0.6;"></i>
      
      <span>Memo</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags/" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">木叶禅</div>
        <div class="logo-desc">
            
            You are too concerned with what was and what will be
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/learn/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			Learn
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/memo/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sticky-note"></i>
			
			Memo
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'f65e070788a2647953051a7a1b70ada7fd2b3f70cd4d93c977207f5b762987d4';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">《云原生训练营》学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                <span class="chip bg-color">极客时间</span>
                            </a>
                        
                            <a href="/tags/kubernetes/">
                                <span class="chip bg-color">kubernetes</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-03-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-09-02
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    113.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    476 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>课程资源： <a target="_blank" rel="noopener" href="https://github.com/kibaamor/101">https://github.com/kibaamor/101</a></p>
<p>代码走读：<a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/source-code-reading/readme.MD">https://github.com/kibaamor/101/blob/master/source-code-reading/readme.MD</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/golang-843c958dafc54f0aab4fa1e4527da78a">https://cncamp.notion.site/golang-843c958dafc54f0aab4fa1e4527da78a</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/kubernetes-8a9d48ee26284b3c8ddf9de4c62ea895">https://cncamp.notion.site/kubernetes-8a9d48ee26284b3c8ddf9de4c62ea895</a>, <a target="_blank" rel="noopener" href="https://cncamp.notion.site/mesh-adf426d889f0448faa1671f5e05c9f12">https://cncamp.notion.site/mesh-adf426d889f0448faa1671f5e05c9f12</a></p>
<p>iptables: <a target="_blank" rel="noopener" href="https://ipset.netfilter.org/iptables-extensions.man.html">https://ipset.netfilter.org/iptables-extensions.man.html</a></p>
<h2 id="Go-语言特性"><a href="#Go-语言特性" class="headerlink" title="Go 语言特性"></a>Go 语言特性</h2><h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><h4 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h4><ul>
<li>并发（concurrency）：两个或多个事件在同一时间间隔发生。</li>
<li>并行（parallellism）：两个或者多个事件在同一时刻发生。</li>
</ul>
<h2 id="Go-语言进阶"><a href="#Go-语言进阶" class="headerlink" title="Go 语言进阶"></a>Go 语言进阶</h2><h3 id="线程调度"><a href="#线程调度" class="headerlink" title="线程调度"></a>线程调度</h3><h4 id="深入理解-Go-语言线程调度"><a href="#深入理解-Go-语言线程调度" class="headerlink" title="深入理解 Go 语言线程调度"></a>深入理解 Go 语言线程调度</h4><ul>
<li>进程：资源分配的基本单位</li>
<li>线程：调度的基本单位</li>
<li>无论是线程还是进程，在 linux 中都以 task_struct 描述，从内核角度看，与进程无本质区别</li>
<li>Glibc 中的 pthread 库提供 NPTL（Native POSIX Threading Library）支持</li>
</ul>
<h4 id="进程切换开销"><a href="#进程切换开销" class="headerlink" title="进程切换开销"></a>进程切换开销</h4><ol>
<li>直接开销<ul>
<li>切换页表全局目录（PGD）</li>
<li>切换内核态堆栈</li>
<li>切换硬件上下文（进程恢复前，必须装入寄存器的数据统称为硬件上下文）</li>
<li>刷新TLB</li>
<li>系统调度器的代码执行</li>
</ul>
</li>
<li>间接开销<ul>
<li>CPU 缓存失效导致的进程需要到内存直接访问的IO 操作变多</li>
</ul>
</li>
</ol>
<h4 id="线程切换开销"><a href="#线程切换开销" class="headerlink" title="线程切换开销"></a>线程切换开销</h4><ul>
<li>线程本质上只是一批共享资源的进程，线程切换本质上依然需要内核进行进程切换。</li>
<li>一组线程因为共享内存资源，因此一个进程的所有线程共享虚拟地址空间，线程切换相比进程切换，<strong>主要节省了虚拟地址空间的切换</strong>。</li>
</ul>
<h4 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h4><p>Go 语言基于 GMP 模型实现用户态线程</p>
<ul>
<li>G：表示 goroutine，每个 goroutine 都有自己的栈空间，定时器，初始化的栈空间在2k 左右，空间会随着需求增长。</li>
<li>M：抽象化代表内核线程，记录内核线程栈信息，当 goroutine 调度到线程时，使用该 goroutine 自己的栈信息。</li>
<li>P：代表调度器，负责调度 goroutine，维护一个本地 goroutine 队列，M 从 P 上获得 goroutine 并执行，同时还负责部分内存的管理。</li>
</ul>
<h4 id="GMP模型细节"><a href="#GMP模型细节" class="headerlink" title="GMP模型细节"></a>GMP模型细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GMP模型细节.png" alt="GMP模型细节"></p>
<h4 id="G-所处的位置"><a href="#G-所处的位置" class="headerlink" title="G 所处的位置"></a>G 所处的位置</h4><ul>
<li>进程都有一个全局的 G 队列</li>
<li>每个 P 拥有自己的本地执行队列</li>
<li>有不在运行队列中的 G<ul>
<li>处于 channel 阻塞态的 G 被放在 sudog</li>
<li>脱离 P 绑定在 M 上的 G，如系统调用</li>
<li>为了复用，执行结束进入 P 的 gFree 列表中的 G</li>
</ul>
</li>
</ul>
<h4 id="Goroutine-创建过程"><a href="#Goroutine-创建过程" class="headerlink" title="Goroutine 创建过程"></a>Goroutine 创建过程</h4><ul>
<li>获取或者创建新的 Goroutine 结构体<ul>
<li>从处理器的 gFree 列表中查找空闲的 Goroutine</li>
<li>如果不存在空闲的 Goroutine，会通过 runtime.malg 创建一个栈大小足够的新结构体</li>
</ul>
</li>
<li>将函数传入的参数移到 Goroutine 的栈上</li>
<li>更新 Goroutine 调度相关的属性，更新状态为 _Grunnable</li>
<li>返回的 Goroutine 会存储到全局变量 allgs 中</li>
</ul>
<h4 id="将-Goroutine-放到运行队列上"><a href="#将-Goroutine-放到运行队列上" class="headerlink" title="将 Goroutine 放到运行队列上"></a>将 Goroutine 放到运行队列上</h4><blockquote>
<p>关键函数 <code>func runqput(pp *p, gp *g, next bool)</code></p>
</blockquote>
<ul>
<li>Goroutine 设置到处理器的 runnext 作为下一个处理器执行的任务</li>
<li>当处理器的本地运行队列已经没有剩余空间时，就会把本地队列中的前一半 Goroutine 和待加入的 Goroutine 一起打乱顺序后通过 <code>runtime.runqputslow</code> 添加到调度器持有的全局运行队列上</li>
</ul>
<h4 id="调度器行为"><a href="#调度器行为" class="headerlink" title="调度器行为"></a>调度器行为</h4><blockquote>
<p>关键函数 <code>func schedule()</code></p>
<p>可以参考的资料<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/586236582">《深入分析Go1.18 GMP调度器底层原理》</a></p>
</blockquote>
<ul>
<li>为了保证公平，当全局运行队列中有待执行的 Goroutine 时，通过 schedtick 保证有一定几率(1/61) 通过 <code>runtime.globrunqget</code> 从全局的运行队列中查找一个的 Goroutine 来运行</li>
<li>从处理器本地的运行队列中查找待执行的 Goroutine</li>
<li>如果前两种方法都没有找到 Goroutine，会通过 <code>runtime.findrunnable</code> 进行阻塞地查找 Goroutine</li>
<li>从本地运行队列、全局运行队列中查找</li>
<li>从网络轮询器中查找是否有 Goroutine 等待运行</li>
<li>通过 runtime.runqsteal 尝试从其他随机的处理器中窃取待运行的 Goroutine</li>
</ul>
<h5 id="源码走读"><a href="#源码走读" class="headerlink" title="源码走读"></a>源码走读</h5><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/scheduling-b32ff8b83f674741ba9c2ecfd592f997">scheduling</a></p>
<p>关于M和P的数量的问题答疑昨天群里陷入了讨论，我看了一下代码把调用关系列在了这个文档里</p>
<p><strong>设计考量</strong></p>
<ul>
<li>默认配置下，P的数量 = CPU个数，可通过GOMAXPROCS修改，上限是256</li>
<li>M数量是内核线程数量，M大于P，上限是10000</li>
<li>P的数量在调度器初始化的procresize中控制</li>
<li>当调度器进行调度，唤醒P的时候，会通过met获取idle m，如果获取不到，则创建新的M（也就是内核线程）</li>
<li>这样做的目的是，M可能陷入系统调用，而系统调用可能是阻塞的，比如磁盘读取，这个时候CPU是空闲的，创建新的M并与P关联，可以让更多的G被调度，充分利用CPU。</li>
</ul>
<p><strong>代码分析</strong></p>
<p><code>/usr/local/go/src/runtime/proc.go</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    sched<span class="token punctuation">.</span>maxmcount <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">// m count limit is 10000 by default</span>
    procs <span class="token operator">=</span> <span class="token function">atoi32</span><span class="token punctuation">(</span><span class="token function">gogetenv</span><span class="token punctuation">(</span><span class="token string">"GOMAXPROCS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">procresize</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        nallp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">,</span> nprocs<span class="token punctuation">)</span> <span class="token comment">// P count is read from environment variable GOMAXPROCS</span>
        pp<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// mget to associate p with idle m</span>

<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token function">startm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            nmp <span class="token operator">:=</span> <span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> nmp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">newm</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> _p_<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    mp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
                    mp<span class="token punctuation">.</span>g0 <span class="token operator">=</span> <span class="token function">malg</span><span class="token punctuation">(</span><span class="token number">8192</span> <span class="token operator">*</span> sys<span class="token punctuation">.</span>StackGuardMultiplier<span class="token punctuation">)</span> <span class="token comment">// g0 is the maintainer for the m, like create other G</span>
            <span class="token punctuation">}</span>
            nmp<span class="token punctuation">.</span>nextp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>
            <span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nmp<span class="token punctuation">.</span>park<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token function">semawakeup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp<span class="token punctuation">.</span>cond<span class="token punctuation">)</span> <span class="token comment">// wake up the kernel thread</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><h4 id="TCMalloc"><a href="#TCMalloc" class="headerlink" title="TCMalloc"></a>TCMalloc</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://goog-perftools.sourceforge.net/doc/tcmalloc.html">TCMalloc : Thread-Caching Malloc</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/TCMalloc.png" alt="TCMalloc"></p>
<ul>
<li>page: 内存页，一块 8K 大小的内存空间。Go 与操作系统之间的内存申请和释放，都是以 page 为单位的</li>
<li>span: 内存块，一个或多个连续的 page 组成一个 span</li>
<li>sizeclass: 空间规格，每个 span 都带有一个 sizeclass ，标记着该 span 中的 page 应该如何使用</li>
<li><p>object: 对象，用来存储一个变量数据内存空间，一个 span 在初始化时，会被切割成一堆等大的 object ；假设 object 的大小是 16B ，span 大小是 8K ，那么就会把 span 中的 page 就会被初始化 8K / 16B = 512 个 object 。所谓内存分配，就是分配一个object 出去</p>
</li>
<li><p>对象大小定义</p>
<ul>
<li>小对象大小：0~256KB</li>
<li>中对象大小：256KB~1MB</li>
<li>大对象大小：&gt;1MB</li>
</ul>
</li>
<li>小对象的分配流程<ul>
<li>ThreadCache -&gt; CentralCache -&gt; PageHeap，大部分时候，ThreadCache 缓存都是足够的，不需要去访问 CentralCache 和 PageHeap，无系统调用配合无锁分配，分配效率是非常高的</li>
</ul>
</li>
<li>中对象分配流程<ul>
<li>直接在 PageHeap 中选择适当的大小即可，128 Page 的 Span 所保存的最大内存就是 1MB</li>
</ul>
</li>
<li>大对象分配流程<ul>
<li>从 large span set 选择合适数量的页面组成 span，用来存储数据</li>
</ul>
</li>
</ul>
<h4 id="Go-语言内存分配"><a href="#Go-语言内存分配" class="headerlink" title="Go 语言内存分配"></a>Go 语言内存分配</h4><blockquote>
<p>关键函数 <code>func mallocgc</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/go1.22.1/src/runtime/malloc.go#L7">Go 语言的内存分配器是基于 TCMalloc 实现的</a>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coldnight/go-memory-allocator-visual-guide">Go 语言内存分配可视化指南（A visual guide to Go Memory Allocator from scratch (Golang)）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sobyte.net/post/2021-12/golang-memory-allocator/">Principle of memory allocator implementation in Go language</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Go语言内存分配.png" alt="Go语言内存分配"></p>
<ul>
<li><p>对象大小定义</p>
<ul>
<li>小（Small）对象：&lt;=32KB<ul>
<li>其中大小 &lt;16B 且不是指针的对象称为微（Tiny）对象</li>
</ul>
</li>
<li>大（Large）对象：&gt;32KB</li>
</ul>
</li>
<li><p>mcache：小对象的内存分配直接走</p>
<ul>
<li>size class 从 1 到 66，每个 class 两个 span （scan 和 noscan）</li>
<li>Span 大小是 8KB，按 span class 大小切分</li>
</ul>
</li>
<li>mcentral<ul>
<li>Span 内的所有内存块都被占用时，没有剩余空间继续分配对象，mcache 会向 mcentral 申请 1 个 span，mcache 拿到 span 后继续分配对象</li>
<li>当 mcentral 向 mcache 提供 span 时，如果没有符合条件的 span，mcentral 会向 mheap 申请 span</li>
</ul>
</li>
<li>mheap<ul>
<li>当 mheap 没有足够的内存时，mheap 会向 OS 申请内存</li>
<li>mheap 把 Span 组织成了树结构，而不是链表</li>
<li>然后把 Span 分配到 heapArena 进行管理，它包含地址映射和 span 是否包含指针等位图<ul>
<li>为了更高效的分配、回收和再利用内存</li>
</ul>
</li>
</ul>
</li>
<li>mspan<ul>
<li>allocBits<ul>
<li>记录了每块内存分配的情况</li>
</ul>
</li>
<li>gcmarkBits<ul>
<li>记录了每块内存的引用情况，标记阶段对每块内存进行标记，有对象引用的内存标记为 1，没有的标记为 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Go-语言-GC"><a href="#Go-语言-GC" class="headerlink" title="Go 语言 GC"></a>Go 语言 GC</h4><blockquote>
<p>Golang 的汇编看不懂时可以看 <a target="_blank" rel="noopener" href="https://go.dev/doc/asm">A Quick Guide to Go’s Assembler</a></p>
<p>可以参考的资料<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/02/gc1.html">《Golang 垃圾回收（一）概述》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/02/gc2.html">《golang 垃圾回收（二）屏障技术》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/03/gc3.html">《golang 垃圾回收（三）插入写屏障》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/2020/06/13/gc4.html">《golang 垃圾回收（四）删除写屏障》</a>、<a target="_blank" rel="noopener" href="https://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%86%99%E5%B1%8F%E9%9A%9C/2020/07/24/gc5.html">《golang 垃圾回收（五）混合写屏障》</a></p>
</blockquote>
<p>混合写屏障伪代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/runtime/mbarrier.go</span>

<span class="token comment">// Go uses a hybrid barrier that combines a Yuasa-style deletion</span>
<span class="token comment">// barrier—which shades the object whose reference is being</span>
<span class="token comment">// overwritten—with Dijkstra insertion barrier—which shades the object</span>
<span class="token comment">// whose reference is being written. The insertion part of the barrier</span>
<span class="token comment">// is necessary while the calling goroutine's stack is grey. In</span>
<span class="token comment">// pseudocode, the barrier is:</span>
<span class="token function">writePointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">shade</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span>    <span class="token comment">// 删除写屏障（Yuasa-style 屏障）</span>
    <span class="token keyword">if</span> current stack is grey<span class="token punctuation">:</span>
        <span class="token function">shade</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>  <span class="token comment">// 插入写屏障（Dijkstra屏障）</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> ptr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Go 实际实现为</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">writePointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">shade</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span>
    <span class="token function">shade</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
    <span class="token operator">*</span>slot <span class="token operator">=</span> ptr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="垃圾回收触发机制"><a href="#垃圾回收触发机制" class="headerlink" title="垃圾回收触发机制"></a>垃圾回收触发机制</h4><ul>
<li>内存分配量达到阀值触发 GC<ul>
<li>每次内存分配时都会检查当前内存分配量是否已达到阀值，如果达到阀值则立即启动 GC。<ul>
<li>阀值 = 上次 GC 内存分配量 * 内存增长率</li>
<li>内存增长率由环境变量 GOGC 控制，默认为 100，即每当内存扩大一倍时启动 GC。</li>
</ul>
</li>
</ul>
</li>
<li>定期触发 GC<ul>
<li>默认情况下，最长 2 分钟触发一次 GC，这个间隔在 <code>src/runtime/proc.go:forcegcperiod</code> 变量中被声明</li>
</ul>
</li>
<li>手动触发<ul>
<li>程序代码中也可以使用 <code>runtime.GC()</code> 来手动触发 GC。这主要用于 GC 性能测试和统计。</li>
</ul>
</li>
</ul>
<h3 id="动手编写一个-HTTP-Server"><a href="#动手编写一个-HTTP-Server" class="headerlink" title="动手编写一个 HTTP Server"></a>动手编写一个 HTTP Server</h3><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/http-server-socket-detail-e1f350d63c7c4d9f86ce140949bd90c2">http server socket detail</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            lc<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> network<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                sl<span class="token punctuation">.</span><span class="token function">listenTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> la<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">internetSocket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sl<span class="token punctuation">.</span>network<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"listen"</span><span class="token punctuation">,</span> sl<span class="token punctuation">.</span>ListenConfig<span class="token punctuation">.</span>Control<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        <span class="token function">socket</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> net<span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> ipv6only<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            <span class="token function">sysSocket</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> proto<span class="token punctuation">)</span> <span class="token comment">// syscall.Socket and return fd</span>
                            fd<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">newFD</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> family<span class="token punctuation">,</span> sotype<span class="token punctuation">,</span> net<span class="token punctuation">)</span> <span class="token comment">// fd.pfd.sysfd = sysfd(socket fd)</span>
                        fd<span class="token punctuation">.</span><span class="token function">listenStream</span><span class="token punctuation">(</span>laddr<span class="token punctuation">,</span> <span class="token function">listenerBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrlFn<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            syscall<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> lsa<span class="token punctuation">)</span> <span class="token comment">// bind socket with address</span>
                            <span class="token function">listenFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// syscall.Listen</span>
                            fd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                <span class="token function">runtime_pollServerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_poll_runtime.go</span>
                                    <span class="token function">poll_runtime_pollServerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll.go</span>
                                        <span class="token function">netpollGenericInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll_epoll.go</span>
                                                <span class="token function">epollcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                <span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
                                <span class="token function">runtime_pollOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                    <span class="token function">poll_runtime_pollOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll.go</span>
                                        <span class="token function">netpollopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// netpoll_epoll.go</span>
                                            <span class="token keyword">var</span> ev epollevent
                                            ev<span class="token punctuation">.</span>events <span class="token operator">=</span> _EPOLLIN <span class="token operator">|</span> _EPOLLOUT <span class="token operator">|</span> _EPOLLRDHUP <span class="token operator">|</span> _EPOLLET
                                            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> pd
                                            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
        srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// tcpsocket.go</span>
                l<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// return TCPConn which holds the connection fd</span>
                    fd <span class="token operator">:=</span> ln<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        fd<span class="token punctuation">.</span>pfd<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_unix.go syscall.Accept4</span>
                            <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> s<span class="token punctuation">,</span> rsa<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err
                            <span class="token punctuation">}</span>
                            <span class="token keyword">switch</span> err <span class="token punctuation">{</span>
                            <span class="token keyword">case</span> syscall<span class="token punctuation">.</span>EAGAIN<span class="token punctuation">:</span>
                                <span class="token keyword">if</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                        <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">netpollblock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span>gpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pdWait<span class="token punctuation">)</span>
                                            <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            <span class="token function">mcall</span><span class="token punctuation">(</span>park_m<span class="token punctuation">)</span> <span class="token comment">// put the go routine to park, schedule-&gt;findrunnable will wake it up</span>
                                <span class="token punctuation">}</span>

            <span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>connCtx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>c<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                req<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">readRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>bufr<span class="token punctuation">,</span> keepHostHeader<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>tp<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>r<span class="token punctuation">.</span><span class="token function">readLineSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>r<span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>b<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    b<span class="token punctuation">.</span>rd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>b<span class="token punctuation">.</span>w<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fd_unix.go Read implements io.Reader.</span>
                        <span class="token function">ignoringEINTRIO</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Read<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">)</span>  <span class="token comment">// syscall.Read</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// shedule parked go routine</span>
<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//proc.go</span>
        n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toRun<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                rg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// find related go routine of the epoll fd</span>
                toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token function">startIdle</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>startm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Linux-epoll"><a href="#Linux-epoll" class="headerlink" title="Linux epoll"></a>Linux epoll</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LinuxEpoll.png" alt="LinuxEpoll"></p>
<h4 id="HttpServer-的实现细节"><a href="#HttpServer-的实现细节" class="headerlink" title="HttpServer 的实现细节"></a>HttpServer 的实现细节</h4><p>Go 语言将协程与 fd 资源绑定</p>
<ul>
<li>一个 socket fd 与一个协程绑定</li>
<li>当 socket fd 未就绪时，将对应协程设置为 Gwaiting 状态，将 CPU 时间片让给其他协程</li>
<li>Go 语言 runtime 调度器进行调度唤醒协程时，检查 fd 是否就绪，如果就绪则将协程置为 Grunnable 并加入执行队列</li>
<li>协程被调度后处理 fd 数据</li>
</ul>
<h2 id="Docker-核心技术"><a href="#Docker-核心技术" class="headerlink" title="Docker 核心技术"></a>Docker 核心技术</h2><h3 id="理解Docker"><a href="#理解Docker" class="headerlink" title="理解Docker"></a>理解Docker</h3><h4 id="Linux-内核代码中-Namespace-的实现"><a href="#Linux-内核代码中-Namespace-的实现" class="headerlink" title="Linux 内核代码中 Namespace 的实现"></a>Linux 内核代码中 Namespace 的实现</h4><p>进程数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>

    <span class="token comment">/* Namespaces: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">nsproxy</span> <span class="token operator">*</span>nsproxy<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Namespace 数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/nsproxy.h</span>

<span class="token comment">/*
 * A structure to contain pointers to all per-process
 * namespaces - fs (mount), uts, network, sysvipc, etc.
 *
 * The pid namespace is an exception -- it's accessed using
 * task_active_pid_ns.  The pid namespace here is the
 * namespace that children will use.
 *
 * 'count' is the number of tasks holding a reference.
 * The count for each namespace, then, will be the number
 * of nsproxies pointing to it, not the number of tasks.
 *
 * The nsproxy is shared by tasks which share all namespaces.
 * As soon as a single namespace is cloned or unshared, the
 * nsproxy is copied.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">nsproxy</span> <span class="token punctuation">{</span>
    refcount_t count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">uts_namespace</span> <span class="token operator">*</span>uts_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_namespace</span> <span class="token operator">*</span>ipc_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mnt_namespace</span> <span class="token operator">*</span>mnt_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pid_namespace</span> <span class="token operator">*</span>pid_ns_for_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">time_namespace</span> <span class="token operator">*</span>time_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">time_namespace</span> <span class="token operator">*</span>time_ns_for_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cgroup_namespace</span> <span class="token operator">*</span>cgroup_ns<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Linux-对-Namespace-操作方法"><a href="#Linux-对-Namespace-操作方法" class="headerlink" title="Linux 对 Namespace 操作方法"></a>Linux 对 Namespace 操作方法</h4><h5 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h5><p>在创建新进程的系统调用时，可以通过 flags 参数指定需要新建的 Namespace 类型：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// CLONE_NEWCGROUP / CLONE_NEWIPC / CLONE_NEWNET / CLONE_NEWNS / CLONE_NEWPID / CLONE_NEWUSER / CLONE_NEWUTS</span>
<span class="token keyword">int</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>child_stack<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="setns"><a href="#setns" class="headerlink" title="setns"></a>setns</h5><p>该系统调用可以让调用进程加入某个已经存在的 Namespace 中：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Int <span class="token function">setns</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> nstype<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="unshare"><a href="#unshare" class="headerlink" title="unshare"></a>unshare</h5><p>该系统调用可以将调用进程移动到新的 Namespace 下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">unshare</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="关于-namespace-的常用操作"><a href="#关于-namespace-的常用操作" class="headerlink" title="关于 namespace 的常用操作"></a>关于 namespace 的常用操作</h4><ul>
<li>查看当前系统的 namespace：<code>lsns -t &lt;type&gt;</code></li>
<li>查看某进程的 namespace：<code>ls -la /proc/&lt;pid&gt;/ns/</code></li>
<li>查看某命令的 namespace: <code>sudo lsns | grep &lt;command name&gt;</code></li>
<li>进入某 namespace 运行命令：<code>nsenter -t &lt;pid&gt; -n ip addr</code></li>
<li>在新 network namespace 运行命令：<code>unshare -fn sleep 60</code></li>
</ul>
<h4 id="Linux-内核代码中-Cgroups-的实现"><a href="#Linux-内核代码中-Cgroups-的实现" class="headerlink" title="Linux 内核代码中 Cgroups 的实现"></a>Linux 内核代码中 Cgroups 的实现</h4><p>进程数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_CGROUPS</span></span>
    <span class="token comment">/* Control Group info protected by css_set_lock: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">css_set</span> __rcu <span class="token operator">*</span>cgroups<span class="token punctuation">;</span>
    <span class="token comment">/* cg_list protected by css_set_lock and tsk-&gt;alloc_lock: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> cg_list<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>css_set</code> 是 <code>cgroup_subsys_state</code> 对象的集合数据结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// include/linux/cgroup-defs.h</span>

<span class="token comment">/*
 * A css_set is a structure holding pointers to a set of
 * cgroup_subsys_state objects. This saves space in the task struct
 * object and speeds up fork()/exit(), since a single inc/dec and a
 * list_add()/del() can bump the reference count on the entire cgroup
 * set for a task.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">css_set</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * Set of subsystem states, one for each subsystem. This array is
    * immutable after creation apart from the init_css_set during
    * subsystem registration (at boot time).
    */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cgroup_subsys_state</span> <span class="token operator">*</span>subsys<span class="token punctuation">[</span>CGROUP_SUBSYS_COUNT<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="cgroups"><a href="#cgroups" class="headerlink" title="cgroups"></a>cgroups</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch-subsystems_and_tunable_parameters">Chapter 3. Subsystems and Tunable Parameters</a></p>
</blockquote>
<p>cgroups 实现了对资源的配额和度量</p>
<ul>
<li>blkio： 这个子系统设置限制每个块设备的输入输出控制。例如:磁盘，光盘以及 USB 等等。</li>
<li>CPU： 这个子系统使用调度程序为 cgroup 任务提供 CPU 的访问。</li>
<li>cpuacct： 产生 cgroup 任务的CPU 资源报告。</li>
<li>cpuset： 如果是多核心的 CPU，这个子系统会为 cgroup 任务分配单独的 CPU 和内存。</li>
<li>devices： 允许或拒绝 cgroup 任务对设备的访问。</li>
<li>freezer： 暂停和恢复 cgroup 任务。</li>
<li>memory： 设置每个 cgroup 的内存限制以及产生内存资源报告。</li>
<li>net_cls： 标记每个网络包以供 cgroup 方便使用。</li>
<li>ns： 名称空间子系统。</li>
<li>pid: 进程标识子系统。</li>
</ul>
<h4 id="CPU-子系统"><a href="#CPU-子系统" class="headerlink" title="CPU 子系统"></a>CPU 子系统</h4><ul>
<li>cpu.shares： 可出让的能获得 CPU 使用时间的相对值。<br>  <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/cpu-shares.png" alt="cpu-shares"></li>
<li>cpu.cfs_period_us：cfs_period_us 用来配置时间周期长度，单位为 us（微秒）。<br>  <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/cpu-period-quota.png" alt="cpu-period-quota"></li>
<li>cpu.cfs_quota_us：cfs_quota_us 用来配置当前 Cgroup 在 cfs_period_us 时间内最多能使用的 CPU 时间数，单位为 us（微秒）。</li>
<li>cpu.stat ： Cgroup 内的进程使用的 CPU 时间统计。</li>
<li>nr_periods ： 经过 cpu.cfs_period_us 的时间周期数量。</li>
<li>nr_throttled ： 在经过的周期内，有多少次因为进程在指定的时间周期内用光了配额时间而受到限制。</li>
<li>throttled_time ： Cgroup 中的进程被限制使用CPU 的总用时，单位是 ns（纳秒）</li>
</ul>
<h4 id="Linux-调度器"><a href="#Linux-调度器" class="headerlink" title="Linux 调度器"></a>Linux 调度器</h4><p>内核默认提供了 5 个调度器，Linux 内核使用 <code>struct sched_class</code> 来对调度器进行抽象：</p>
<ul>
<li>Stop 调度器，<code>stop_sched_class</code>：优先级最高的调度类，可以抢占其他所有进程，不能被其他进程抢占；</li>
<li>Deadline 调度器，<code>dl_sched_class</code>：使用红黑树，把进程按照绝对截止期限进行排序，选择最小进程进行调度运行；</li>
<li>RT 调度器， <code>rt_sched_class</code>：实时调度器，为每个优先级维护一个队列；</li>
<li>CFS 调度器， <code>cfs_sched_class</code>：完全公平调度器，采用完全公平调度算法，引入虚拟运行时间概念；</li>
<li>IDLE-Task 调度器， <code>idle_sched_class</code>：空闲调度器，每个 CPU 都会有一个 idle 线程，当没有其他进程可以调度时，调度运行 idle 线程。</li>
</ul>
<h4 id="CFS-调度器"><a href="#CFS-调度器" class="headerlink" title="CFS 调度器"></a>CFS 调度器</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/XiaoliBoy/p/10410686.html">Linux内核CFS调度器</a>, <a target="_blank" rel="noopener" href="http://www.wowotech.net/process_management/451.html">CFS调度器（5）-带宽控制</a></p>
</blockquote>
<p>CFS 是 Completely Fair Scheduler 简称，即完全公平调度器。</p>
<ul>
<li>CFS 实现的主要思想是维护为任务提供处理器时间方面的平衡，这意味着应给进程分配相当数量的处理器。</li>
<li>分给某个任务的时间失去平衡时，应给失去平衡的任务分配时间，让其执行。</li>
<li><p>CFS 通过虚拟运行时间（vruntime）来实现平衡，维护提供给某个任务的时间量。</p>
<p>  <code>vruntime = 实际运行时间 * 1024 / 进程权重</code></p>
</li>
<li><p>进程按照各自不同的速率在物理时钟节拍内前进，优先级高则权重大，其虚拟时钟比真实时钟跑得慢，但获得比较多的运行时间。</p>
</li>
</ul>
<h4 id="vruntime-红黑树"><a href="#vruntime-红黑树" class="headerlink" title="vruntime 红黑树"></a>vruntime 红黑树</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/vruntime红黑树.png" alt="vruntime红黑树"></p>
<h4 id="CFS进程调度"><a href="#CFS进程调度" class="headerlink" title="CFS进程调度"></a>CFS进程调度</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CFS进程调度.png" alt="CFS进程调度"></p>
<h4 id="cpuacct-子系统"><a href="#cpuacct-子系统" class="headerlink" title="cpuacct 子系统"></a>cpuacct 子系统</h4><p>用于统计 Cgroup 及其子 Cgroup 下进程的 CPU 的使用情况。</p>
<ul>
<li>cpuacct.usage</li>
</ul>
<p>包含该 Cgroup 及其子 Cgroup 下进程使用 CPU 的时间，单位是 ns（纳秒）。</p>
<ul>
<li>cpuacct.stat</li>
</ul>
<p>包含该 Cgroup 及其子 Cgroup 下进程使用的 CPU 时间，以及用户态和内核态的时间。</p>
<h4 id="Memory-子系统"><a href="#Memory-子系统" class="headerlink" title="Memory 子系统"></a>Memory 子系统</h4><ul>
<li><p>memory.usage_in_bytes</p>
<p>  cgroup 下进程使用的内存，包含 cgroup 及其子 cgroup 下的进程使用的内存</p>
</li>
<li><p>memory.max_usage_in_bytes</p>
<p>  cgroup 下进程使用内存的最大值，包含子 cgroup 的内存使用量。</p>
</li>
<li><p>memory.limit_in_bytes</p>
<p>  设置 Cgroup 下进程最多能使用的内存。如果设置为 -1，表示对该 cgroup 的内存使用不做限制。</p>
</li>
<li><p>memory.soft_limit_in_bytes</p>
<p>  这个限制并不会阻止进程使用超过限额的内存，只是在系统内存足够时，会优先回收超过限额的内存，使之向限定值靠拢。</p>
</li>
<li><p>memory.oom_control</p>
<p>  设置是否在 Cgroup 中使用 OOM（Out of Memory）Killer，默认为使用。当属于该 cgroup 的进程使用的内存超过最大的限定值时，会立刻被 OOM Killer 处理。</p>
</li>
</ul>
<h4 id="Cgroup-driver"><a href="#Cgroup-driver" class="headerlink" title="Cgroup driver"></a>Cgroup driver</h4><p>systemd:</p>
<ul>
<li>当操作系统使用 systemd 作为 init system 时，初始化进程生成一个根 cgroup 目录结构并作为 cgroup 管理器。</li>
<li>systemd 与 cgroup 紧密结合，并且为每个 systemd unit 分配 cgroup。</li>
</ul>
<p>cgroupfs:</p>
<ul>
<li>docker 默认用 cgroupfs 作为 cgroup 驱动。</li>
</ul>
<p>存在问题：</p>
<ul>
<li>在 systemd 作为 init system 的系统中，默认并存着两套 groupdriver。</li>
<li>这会使得系统中 Docker 和 kubelet 管理的进程被 cgroupfs 驱动管，而 systemd 拉起的服务由 systemd 驱动管，让 cgroup 管理混乱且容易在资源紧张时引发问题。</li>
</ul>
<p>因此 kubelet 会默认 —cgroup-driver=systemd，若运行时 cgroup 不一致时，kubelet 会报错。</p>
<h4 id="Cgroup-的使用"><a href="#Cgroup-的使用" class="headerlink" title="Cgroup 的使用"></a>Cgroup 的使用</h4><p>可以使用 <code>cgroup-tools</code> 来管理 Cgroup</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建一个名为 k 的 CPU 子系统</span>
$ cgcreate -g cpu:k

<span class="token comment"># 创建后的路径为</span>
$ <span class="token function">ls</span> /sys/fs/cgroup/cpu/k
cgroup.clone_children  cgroup.procs  cpu.cfs_burst_us  cpu.cfs_period_us  cpu.cfs_quota_us  cpu.idle  cpu.rt_period_us  cpu.rt_runtime_us  cpu.shares  cpu.stat  notify_on_release  tasks

<span class="token comment"># 获取 CPU 配额</span>
$ cgget -r cpu.cfs_period_us -r cpu.cfs_quota_us k
k:
cpu.cfs_period_us: <span class="token number">100000</span>
cpu.cfs_quota_us: -1

<span class="token comment"># 限制 CPU 使用率为 50%</span>
$ cgset -r cpu.cfs_quota_us<span class="token operator">=</span><span class="token number">50000</span> k

<span class="token comment"># 确认设置生效</span>
$ cgget -r cpu.cfs_period_us -r cpu.cfs_quota_us k
k:
cpu.cfs_period_us: <span class="token number">100000</span>
cpu.cfs_quota_us: <span class="token number">50000</span>

<span class="token comment"># 测试</span>
$ <span class="token function">top</span> -p <span class="token variable"><span class="token variable">$(</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'bash -c while : ; do : ; done'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span> -b -n <span class="token number">1</span>
<span class="token function">top</span> - <span class="token number">22</span>:48:54 up  <span class="token number">1</span>:25,  <span class="token number">2</span> users,  load average: <span class="token number">1.54</span>, <span class="token number">1.41</span>, <span class="token number">1.21</span>
Tasks:   <span class="token number">1</span> total,   <span class="token number">1</span> running,   <span class="token number">0</span> sleeping,   <span class="token number">0</span> stopped,   <span class="token number">0</span> zombie
%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  <span class="token number">8.4</span> us,  <span class="token number">0.8</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">86.8</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">4.0</span> si,  <span class="token number">0.0</span> st
MiB Mem <span class="token builtin class-name">:</span>   <span class="token number">7898.4</span> total,    <span class="token number">141.7</span> free,   <span class="token number">2822.3</span> used,   <span class="token number">4934.4</span> buff/cache
MiB Swap:   <span class="token number">2048.0</span> total,   <span class="token number">2042.7</span> free,      <span class="token number">5.3</span> used.   <span class="token number">4779.8</span> avail Mem

    PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  <span class="token number">33693</span> root      <span class="token number">20</span>   <span class="token number">0</span>    <span class="token number">4784</span>   <span class="token number">3224</span>   <span class="token number">2976</span> R  <span class="token number">53.3</span>   <span class="token number">0.0</span>   <span class="token number">4</span>:32.59 <span class="token function">bash</span>

<span class="token comment"># 删除 CPU 子系统 k</span>
$ cgdelete cpu:k<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h4><p>Union FS</p>
<ul>
<li>将不同目录挂载到同一个虚拟文件系统下（unite several directories into a single virtual filesystem）的文件系统</li>
<li>支持为每一个成员目录（类似 Git Branch）设定 readonly、readwrite 和 whiteout-able 权限</li>
<li>文件系统分层, 对 readonly 权限的 branch 可以逻辑上进行修改(增量地, 不影响 readonly 部分的)。</li>
<li>通常 Union FS 有两个用途, 一方面可以将多个 disk 挂到同一个目录下, 另一个更常用的就是将一个 readonly 的 branch 和一个 writeable 的 branch 联合在一起。</li>
</ul>
<h4 id="Docker-的文件系统"><a href="#Docker-的文件系统" class="headerlink" title="Docker 的文件系统"></a>Docker 的文件系统</h4><p>典型的 Linux 文件系统组成：</p>
<ul>
<li>Bootfs（boot file system）<ul>
<li>Bootloader - 引导加载 kernel，</li>
<li>Kernel - 当 kernel 被加载到内存中后 umount bootfs。</li>
</ul>
</li>
<li>rootfs （root file system）<ul>
<li>/dev，/proc，/bin，/etc 等标准目录和文件。</li>
<li>对于不同的 linux 发行版, bootfs 基本是一致的，但 rootfs 会有差别。</li>
</ul>
</li>
</ul>
<h4 id="Docker-启动"><a href="#Docker-启动" class="headerlink" title="Docker 启动"></a>Docker 启动</h4><p>Linux</p>
<ul>
<li>在启动后，首先将 rootfs 设置为 readonly, 进行一系列检查, 然后将其切换为 “readwrite” 供用户使用。</li>
</ul>
<p>Docker 启动</p>
<ul>
<li>初始化时也是将 rootfs 以 readonly 方式加载并检查，然而接下来利用 union mount 的方式将一个 readwrite 文件系统挂载在 readonly 的 rootfs 之上；</li>
<li>并且允许再次将下层的 FS（file system） 设定为 readonly 并且向上叠加。</li>
<li>这样一组 readonly 和一个 writeable 的结构构成一个 container 的运行时态, 每一个 FS 被称作一个 FS 层。</li>
</ul>
<h4 id="Docker-写操作"><a href="#Docker-写操作" class="headerlink" title="Docker 写操作"></a>Docker 写操作</h4><p>由于镜像具有共享特性，所以对容器可写层的操作需要依赖存储驱动提供的写时复制和用时分配机制，以此来支持对容器可写层的修改，进而提高对存储和内存资源的利用率。</p>
<ul>
<li>写时复制<ul>
<li>写时复制，即 Copy-on-Write。</li>
<li>一个镜像可以被多个容器使用，但是不需要在内存和磁盘上做多个拷贝。</li>
<li>在需要对镜像提供的文件进行修改时，该文件会从镜像的文件系统被复制到容器的可写层的文件系统进行修改，而镜像里面的文件不会改变。</li>
<li>不同容器对文件的修改都相互独立、互不影响。</li>
</ul>
</li>
<li>用时分配<ul>
<li>按需分配空间，而非提前分配，即当一个文件被创建出来后，才会分配空间。</li>
</ul>
</li>
</ul>
<h4 id="Docker-引擎架构"><a href="#Docker-引擎架构" class="headerlink" title="Docker 引擎架构"></a>Docker 引擎架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Docker引擎架构.png" alt="Docker引擎架构"></p>
<p>需要注意的是，在这个架构中，运行的 Docker 容器的父进程不是 Docker daemon ，这样就能避免重启 daemon 导致容器也必须重启。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker inspect c07 <span class="token operator">|</span> <span class="token function">grep</span> -i pid
            <span class="token string">"Pid"</span><span class="token builtin class-name">:</span> <span class="token number">5621</span>,
            <span class="token string">"PidMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"PidsLimit"</span><span class="token builtin class-name">:</span> null,

$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5621</span>
root        <span class="token number">5621</span>    <span class="token number">5600</span>  <span class="token number">0</span> <span class="token number">11</span>:45 pts/0    00:00:00 <span class="token function">zsh</span>

$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5600</span>
root        <span class="token number">5600</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">11</span>:45 ?        00:00:00 /snap/docker/2915/bin/containerd-shim-runc-v2 -namespace moby -id c07f841e7a66cb54f78f72445cb5baf7d479a3c27e8ea03966da1841e3605151 -address /run/snap.docker/containerd/containerd.sock

$ pstree -H <span class="token number">5600</span> -p -s -T
systemd<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>───containerd-shim<span class="token punctuation">(</span><span class="token number">5600</span><span class="token punctuation">)</span>───zsh<span class="token punctuation">(</span><span class="token number">5621</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h4><ul>
<li>Null(—net=None)<ul>
<li>把容器放入独立的网络空间但不做任何网络配置；</li>
<li>用户需要通过运行 docker network 命令来完成网络配置。</li>
</ul>
</li>
<li>Host<ul>
<li>使用主机网络名空间，复用主机网络。</li>
</ul>
</li>
<li>Container<ul>
<li>重用其他容器的网络。</li>
</ul>
</li>
<li>Bridge(—net=bridge)<ul>
<li>使用 Linux 网桥和 iptables 提供容器互联，Docker 在每台主机上创建一个名叫 docker0 的网桥，通过 veth pair 来连接该主机的每一个 EndPoint。</li>
</ul>
</li>
<li>Overlay(libnetwork, libkv)<ul>
<li>通过网络封包实现。</li>
</ul>
</li>
<li>Remote(work with remote drivers)<ul>
<li>Underlay：使用现有底层网络，为每一个容器配置可路由的网络 IP。</li>
<li>Overlay：通过网络封包实现。</li>
</ul>
</li>
</ul>
<h4 id="Null-模式"><a href="#Null-模式" class="headerlink" title="Null 模式"></a>Null 模式</h4><ol>
<li>Null 模式是一个空实现；</li>
<li>可以通过 Null 模式启动容器并在宿主机上通过命令为容器配置网络。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module3/setup-network.md">https://github.com/kibaamor/101/blob/master/module3/setup-network.md</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以后台的方式运行一个名为 nginx 的 nginx 容器，但不配置网络</span>
$ docker run --network<span class="token operator">=</span>none --name nginx -d nginx

<span class="token comment"># 获取刚刚运行的 nginx 容器中 nginx 进程在主机上的 Pid</span>
$ docker inspect -f <span class="token string">'{{.State.Pid}}'</span> nginx
<span class="token number">63648</span>

<span class="token comment"># 查看 nginx 容器的网络配置</span>
$ nsenter -t <span class="token number">63648</span> -n <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever

<span class="token comment"># 将 nginx 容器进程所使用的 network namespace 连接到 /var/run/netns，这样才能使用 ip netns 命令查看和修改</span>
<span class="token comment"># 创建目录</span>
$ <span class="token function">mkdir</span> -p /var/run/netns
<span class="token comment"># 链接</span>
$ <span class="token function">ln</span> -s /proc/63648/ns/net /var/run/netns/63648
<span class="token comment"># 确认链接成功</span>
$ <span class="token function">ip</span> netns list
<span class="token number">63648</span>

<span class="token comment"># 查看主机上网桥的配置</span>
$ brctl show
bridge name     bridge <span class="token function">id</span>               STP enabled     interfaces
docker0         <span class="token number">8000</span>.0242b3da2420       no

<span class="token comment"># 显示主机上 docker0 网口的 ip 信息</span>
$ <span class="token function">ip</span> address show dev docker0
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:b3:da:24:20 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:b3ff:feda:2420/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever

<span class="token comment"># 创建 veth pair</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> A <span class="token builtin class-name">type</span> veth peer name B

<span class="token comment"># 配置 A</span>
<span class="token comment"># 把 A 添加到网桥 docker0</span>
$ brctl addif docker0 A
<span class="token comment"># 启动 A</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A up

<span class="token comment"># 配置 B</span>
<span class="token comment"># 将 B 的 network namespace 移动到进程 63648 中</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B netns <span class="token number">63648</span>
<span class="token comment"># 将 B 改名为 eth0</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev B name eth0
<span class="token comment"># 启动 eth0</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 up
<span class="token comment"># 设置 eth0 的 IP 和子网掩码（根据 docker0 信息来）</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.17</span>.0.100/16 dev eth0
<span class="token comment"># 设置 eth0 的默认网关（即为 docker0 的 IP 地址）</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">63648</span> <span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">172.17</span>.0.1

<span class="token comment"># 测试能访问 nginx（如果失败，检查一下 HTTP_PROXY 等配置）</span>
$ <span class="token function">curl</span> <span class="token number">172.17</span>.0.100
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="默认模式-网桥和-NAT"><a href="#默认模式-网桥和-NAT" class="headerlink" title="默认模式 - 网桥和 NAT"></a>默认模式 - 网桥和 NAT</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DockerNAT.png" alt="DockerNAT"></p>
<h4 id="Underlay"><a href="#Underlay" class="headerlink" title="Underlay"></a>Underlay</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Underlay.png" alt="Underlay"></p>
<h4 id="Overlay"><a href="#Overlay" class="headerlink" title="Overlay"></a>Overlay</h4><ul>
<li>Docker overlay 网络驱动原生支持多主机网络；</li>
<li>Libnetwork 是一个内置的基于 VXLAN 的网络驱动。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/VXLAN.png" alt="VXLAN"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Flannel.png" alt="Flannel"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlannelPacketSample.png" alt="FlannelPacketSample"></p>
<h3 id="Dockerfile-的最佳实践"><a href="#Dockerfile-的最佳实践" class="headerlink" title="Dockerfile 的最佳实践"></a>Dockerfile 的最佳实践</h3><h4 id="回顾12-Factor-之进程"><a href="#回顾12-Factor-之进程" class="headerlink" title="回顾12 Factor 之进程"></a>回顾12 Factor 之进程</h4><ul>
<li>运行环境中，应用程序通常是以一个和多个<strong>进程</strong>运行的。<ul>
<li>12-Factor 应用的进程必须无状态（Stateless）且无共享（Share nothing）。</li>
</ul>
</li>
<li>任何需要持久化的数据都要存储在后端服务内，比如数据库。<ul>
<li>应在构建阶段将源代码编译成待执行应用。</li>
</ul>
</li>
<li>Session Sticky 是 12-Factor 极力反对的。<ul>
<li>Session 中的数据应该保存在诸如 Memcached 或 Redis 这样的带有过期时间的缓存中。</li>
</ul>
</li>
</ul>
<p><strong>Docker 遵循以上原则管理和构建应用。</strong></p>
<h4 id="理解构建上下文（Build-Context）"><a href="#理解构建上下文（Build-Context）" class="headerlink" title="理解构建上下文（Build Context）"></a>理解构建上下文（Build Context）</h4><ul>
<li>当运行docker build 命令时，当前工作目录被称为构建上下文。</li>
<li>docker build 默认查找当前目录的Dockerfile 作为构建输入，也可以通过 -f 指定Dockerfile。<ul>
<li><code>docker build -f ./Dockerfile</code></li>
</ul>
</li>
<li>当docker build 运行时，首先会把构建上下文传输给 docker daemon，把没用的文件包含在构建上下文时，会导致传输时间长，构建需要的资源多，构建出的镜像大等问题。<ul>
<li>试着到一个包含文件很多的目录运行下面的命令，会感受到差异；</li>
<li><code>docker build -f $GOPATH/src/github.com/cncamp/golang/httpserver/Dockerfile</code> ；</li>
<li><code>docker build $GOPATH/src/github.com/cncamp/golang/httpserver/</code>；</li>
<li>可以通过 <code>.dockerignore</code> 文件从编译上下文排除某些文件。</li>
</ul>
</li>
<li>因此需要确保构建上下文清晰，比如创建一个专门的目录放置 Dockerfile，并在目录中运行 <code>docker build</code>。</li>
</ul>
<h4 id="Build-Cache"><a href="#Build-Cache" class="headerlink" title="Build Cache"></a>Build Cache</h4><p>构建容器镜像时，Docker 依次读取 Dockerfile 中的指令，并按顺序依次执行构建指令。<br>Docker 读取指令后，会先判断缓存中是否有可用的已存镜像，只有已存镜像不存在时才会重新构建。</p>
<ul>
<li>通常 Docker 简单判断 Dockerfile 中的指令与镜像。</li>
<li>针对 ADD 和 COPY 指令，Docker 判断该镜像层每一个文件的内容并生成一个 checksum，与现存镜像比较时，Docker 比较的是二者的 checksum。</li>
<li>其他指令，比如 <code>RUN apt-get -y update</code>，Docker 简单比较与现存镜像中的指令字串是否一致。</li>
<li>当某一层 cache 失效以后，所有所有层级的 cache 均一并失效，后续指令都重新构建镜像。</li>
</ul>
<h4 id="Dockerfile-常用指令"><a href="#Dockerfile-常用指令" class="headerlink" title="Dockerfile 常用指令"></a>Dockerfile 常用指令</h4><ul>
<li><p>FROM：选择基础镜像，推荐alpine</p>
<p>  <code>FROM [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</code></p>
</li>
<li><p>LABELS：按标签组织项目</p>
<p>  LABEL multi.label1=”value1” multi.label2=”value2” other=”value3”</p>
<p>  配合label filter 可过滤镜像查询结果</p>
<p>  <code>docker images -f label=multi.label1="value1"</code></p>
</li>
<li><p>RUN：执行命令</p>
<p>  最常见的用法是 RUN apt-get update &amp;&amp; apt-get install，这两条命令应该永远用 &amp;&amp; 连接，如果分开执行，RUN apt-get update 构建层被缓存，可能会导致新 package 无法安装</p>
</li>
<li><p>CMD：容器镜像中包含应用的运行命令，需要带参数</p>
<p>  CMD [“executable”, “param1”, “param2”…]</p>
</li>
<li><p>EXPOSE：发布端口</p>
<p>  <code>EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]</code></p>
<ul>
<li><p>是镜像创建者和使用者的约定</p>
</li>
<li><p>在 docker run -P 时，docker 会自动映射 expose 的端口到主机大端口，如 0.0.0.0:32768-&gt;80/tcp</p>
</li>
</ul>
</li>
<li><p>ENV 设置环境变量</p>
<p>  <code>ENV &lt;key&gt;=&lt;value&gt;</code> …</p>
</li>
<li><p>ADD：从源地址（文件，目录或者URL）复制文件到目标路径</p>
<p>  <code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</code></p>
<p>  <code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</code> （路径中有空格时使用）</p>
<ul>
<li><p>ADD 支持 Go 风格的通配符，如 ADD check* /testdir/</p>
</li>
<li><p>src 如果是文件，则必须包含在编译上下文中，ADD 指令无法添加编译上下文之外的文件</p>
</li>
<li><p>src 如果是URL</p>
<ul>
<li>如果 dest 结尾没有 /，那么 dest 是目标文件名，如果 dest 结尾有 /，那么 dest 是目标目录名</li>
</ul>
</li>
<li><p>如果 src 是一个目录，则所有文件都会被复制至 dest</p>
</li>
<li><p><strong>如果 src 是一个本地压缩文件，则在 ADD 的同时完整解压操作</strong></p>
</li>
<li><p>如果 dest 不存在，则 ADD 指令会创建目标目录</p>
</li>
<li><p>应尽量减少通过 ADD URL 添加 remote 文件，建议使用 curl 或者 wget &amp;&amp; untar （维护起来理解成本高）</p>
</li>
</ul>
</li>
<li><p>COPY：从源地址（文件，目录或者URL）复制文件到目标路径</p>
<p>  <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</code></p>
<p>  <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</code> // 路径中有空格时使用</p>
<ul>
<li><p>COPY 的使用与 ADD 类似，但有如下区别</p>
<ul>
<li><p>COPY 只支持本地文件的复制，不支持URL</p>
</li>
<li><p><strong>COPY 不解压文件</strong></p>
</li>
<li><p>COPY 可以用于多阶段编译场景，可以用前一个临时镜像中拷贝文件</p>
<p>  COPY —from=build /bin/project /bin/project</p>
</li>
</ul>
</li>
<li><p>COPY 语义上更直白，复制本地文件时，优先使用 COPY</p>
</li>
</ul>
</li>
<li><p>ENTRYPOINT：定义可以执行的容器镜像入口命令</p>
<p>  ENTRYPOINT [“executable”, “param1”, “param2”] // docker run参数追加模式</p>
<p>  ENTRYPOINT command param1 param2 // docker run 参数替换模式</p>
<ul>
<li><p>docker run -entrypoint 可替换 Dockerfile 中定义的 ENTRYPOINT</p>
</li>
<li><p>ENTRYPOINT 的最佳实践是用 ENTRYPOINT 定义镜像主命令，并通过 CMD 定义主要参数，如下所示</p>
<p>  ENTRYPOINT [“s3cmd”]</p>
<p>  CMD [“—help”]</p>
</li>
</ul>
</li>
<li><p>VOLUME： 将指定目录定义为外挂存储卷，Dockerfile 中在该指令之后所有对同一目录的修改都无效</p>
<p>  VOLUME [“/data”]</p>
<p>  等价于docker run -v /data，可通过docker inspect 查看主机的mount point，<code>/var/lib/docker/volumes/&lt;containerid&gt;/_data</code></p>
</li>
<li><p>USER：切换运行镜像的用户和用户组，因安全性要求，越来越多的场景要求容器应用要以 non-root 身份运行</p>
<p>  <code>USER &lt;user&gt;[:&lt;group&gt;]</code></p>
</li>
<li><p>WORKDIR：等价于cd，切换工作目录</p>
<p>  WORKDIR /path/to/workdir</p>
</li>
<li><p>其他非常用指令</p>
<ul>
<li>ARG</li>
<li>ONBUILD</li>
<li>STOPSIGNAL</li>
<li>HEALTHCHECK</li>
<li>SHELL</li>
</ul>
</li>
</ul>
<h4 id="Dockerfile-最佳实践"><a href="#Dockerfile-最佳实践" class="headerlink" title="Dockerfile 最佳实践"></a>Dockerfile 最佳实践</h4><p><strong>目标：易管理、少漏洞、镜像小、层级少、利用缓存。</strong></p>
<ul>
<li>不要安装无效软件包。</li>
<li>应简化镜像中同时运行的进程数，理想状况下，每个镜像应该只有一个进程。</li>
<li>当无法避免同一镜像运行多进程时，应选择合理的初始化进程（init process）。</li>
<li>最小化层级数<ul>
<li>最新的 docker 只有 RUN，COPY，ADD 创建新层，其他指令创建临时层，不会增加镜像大小。<ul>
<li>比如 EXPOSE 指令就不会生成新层。</li>
</ul>
</li>
<li>多条RUN 命令可通过连接符连接成一条指令集以减少层数。</li>
<li>通过多段构建减少镜像层数。</li>
</ul>
</li>
<li>把多行参数按字母排序，可以减少可能出现的重复参数，并且提高可读性。</li>
<li>编写 dockerfile 的时候，应该把变更频率低的编译指令优先构建以便放在镜像底层以有效利用 build cache。</li>
<li>复制文件时，每个文件应独立复制，这确保某个文件变更时，只影响改文件对应的缓存。</li>
</ul>
<h4 id="多进程的容器镜像"><a href="#多进程的容器镜像" class="headerlink" title="多进程的容器镜像"></a>多进程的容器镜像</h4><ul>
<li>选择适当的 init 进程<ul>
<li>需要捕获 SIGTERM 信号并完成子进程的优雅终止</li>
<li>负责清理退出的子进程以避免僵尸进程</li>
</ul>
</li>
</ul>
<p>开源项目</p>
<p><a target="_blank" rel="noopener" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a></p>
<h4 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h4><p>创建私有镜像仓库</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/">https://distribution.github.io/distribution/</a></p>
<p> <code>docker run -d -p 5000:5000 registry</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://goharbor.io/">https://goharbor.io/</a></p>
</li>
</ol>
<h2 id="Kubernetes-架构原则和对象设计"><a href="#Kubernetes-架构原则和对象设计" class="headerlink" title="Kubernetes 架构原则和对象设计"></a>Kubernetes 架构原则和对象设计</h2><h3 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h3><h4 id="什么是云计算"><a href="#什么是云计算" class="headerlink" title="什么是云计算"></a>什么是云计算</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云计算.png" alt="云计算"></p>
<p>云计算是对所有计算资源、网络资源和存储资源的一种抽象。</p>
<p>怎么理解呢？</p>
<p>比如，有 5000 台机器。</p>
<ol>
<li>我们可以从网络上打通，把它们形成一个集群。</li>
<li>我们可以有一个用于控制的控制平面，把这些计算资源抽象出来。</li>
</ol>
<p>我们就能知道这 5000 个节点，每个节点上有多少 CPU、内存等。对于整个集群来说，我们也知道哪些节点是健康的，哪些节点是不健康的。谁能参与计算，谁不能参与计算等。这样我们就拥有了一个大的计算池。</p>
<p>上面是从云平台侧考虑的，做了资源的抽象。</p>
<p>另一方面，从业务的角度来说，业务也不用管作业实际部署在哪儿，只用告诉云平台某个业务需要多少实例，每个实例需要多少 CPU 和内存等资源信息即可。云平台会自动找合适节点来运行业务。</p>
<p>这就是云计算，对计算资源做一个抽象，让业务面向抽象的计算资源来部署应用。</p>
<h4 id="云计算平台的分类"><a href="#云计算平台的分类" class="headerlink" title="云计算平台的分类"></a>云计算平台的分类</h4><p>以 Openstack 为典型的<strong>虚拟化平台</strong></p>
<ul>
<li>虚拟机构建和业务代码部署分离。</li>
<li>可变的基础架构使后续维护风险变大。</li>
</ul>
<p>以谷歌 borg 为典型的<strong>基于进程的作业调度平台</strong></p>
<ul>
<li>技术的迭代引发 borg 的换代需求。</li>
<li>早期的隔离依靠 chroot jail 实现，一些不合理的设计需要在新产品中改进。<ul>
<li>对象之间的强依赖 job 和 task 是强包含关系，不利于重组。</li>
<li>所有容器共享 IP，会导致端口冲突，隔离困难等问题。</li>
<li>为超级用户添加复杂逻辑导致系统过于复杂。</li>
</ul>
</li>
</ul>
<h3 id="Kubernetes-架构基础"><a href="#Kubernetes-架构基础" class="headerlink" title="Kubernetes 架构基础"></a>Kubernetes 架构基础</h3><h4 id="Google-Borg"><a href="#Google-Borg" class="headerlink" title="Google Borg"></a>Google Borg</h4><blockquote>
<p>建议对原论文</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GoogleBorg.png" alt="GoogleBorg"></p>
<p>特性</p>
<ul>
<li>物理资源利用率高。</li>
<li>服务器共享，在进程级别做隔离。</li>
<li>应用高可用，故障恢复时间短。</li>
<li>调度策略灵活。</li>
<li>应用接入和使用方便，提供了完备的 Job 描述语言，服务发现，实时状态监控和诊断工具。</li>
</ul>
<p>优势</p>
<ul>
<li>对外隐藏底层资源管理和调度、故障处理等。</li>
<li>实现应用的高可靠和高可用。</li>
<li>足够弹性，支持应用跑在成千上万的机器上。</li>
</ul>
<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><ul>
<li><p>Workload</p>
<ul>
<li>prod：在线任务，长期运行、对延时敏感、面向终端用户等，比如 Gmail, Google Docs,Web Search 服务等。</li>
<li>non-prod ： 离线任务，也称为批处理任务（Batch），比如一些分布式计算服务等。</li>
</ul>
</li>
<li><p>Cell</p>
<blockquote>
<p>相当于一个集群</p>
</blockquote>
<ul>
<li>一个 Cell 上跑一个<strong>集群</strong>管理系统 Borg。</li>
<li>通过定义 Cell 可以让 Borg 对服务器资源进行统一抽象，作为用户就无需知道自己的应用跑在哪台机器上，也不用关心资源分配、程序安装、依赖管理、健康检查及故障恢复等。</li>
</ul>
</li>
<li><p>Job 和 Task</p>
<blockquote>
<p>相当于 k8s 中的 pod 和 container</p>
</blockquote>
<ul>
<li>用户以 Job 的形式提交应用部署请求。一个 Job 包含一个或多个相同的 Task，每个 Task 运行相同的应用程序，Task 数量就是应用的副本数。</li>
<li>每个 Job 可以定义属性、元信息和优先级，优先级涉及到抢占式调度过程。</li>
</ul>
</li>
<li><p>Naming</p>
<ul>
<li>Borg 的服务发现通过 BNS （ Borg NameService）来实现。</li>
<li>50.jfoo.ubar.cc.borg.google.com 可表示在一个名为 cc 的 Cell 中由用户 uBar 部署的一个名为 jFoo 的 Job下的第 50 个 Task。</li>
</ul>
</li>
</ul>
<h4 id="Borg-架构"><a href="#Borg-架构" class="headerlink" title="Borg 架构"></a>Borg 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Borg架构.png" alt="Borg架构"></p>
<h4 id="应用高可用"><a href="#应用高可用" class="headerlink" title="应用高可用"></a>应用高可用</h4><ul>
<li>被抢占的 non-prod 任务放回 pending queue，等待重新调度。</li>
<li>多副本应用跨故障域部署。所谓故障域有大有小，比如相同机器、相同机架或相同电源插座等，一挂全挂。</li>
<li>对于类似服务器或操作系统升级的维护操作，避免大量服务器同时进行。</li>
<li>支持幂等性，支持客户端重复操作。</li>
<li>当服务器状态变为不可用时，要控制重新调度任务的速率。因为 Borg 无法区分是节点故障还是出现了短暂的网络分区，如果是后者，静静地等待网络恢复更利于保障服务可用性。</li>
<li>当某种”任务 @ 服务器”的组合出现故障时，下次重新调度时需避免这种组合再次出现，因为极大可能会再次出现相同故障。</li>
<li>记录详细的内部信息，便于故障排查和分析。</li>
<li>保障应用高可用的关键性设计原则：无论何种原因，即使 Borgmaster 或者 Borglet 挂掉、失联，都不能杀掉正在运行的服务（Task）。</li>
</ul>
<h4 id="Borg-系统自身高可用"><a href="#Borg-系统自身高可用" class="headerlink" title="Borg 系统自身高可用"></a>Borg 系统自身高可用</h4><ul>
<li>Borgmaster 组件多副本设计。</li>
<li>采用一些简单的和底层（low-level）的工具来部署 Borg 系统实例，避免引入过多的外部依赖。</li>
<li>每个 Cell 的 Borg 均独立部署，避免不同 Borg 系统相互影响。</li>
</ul>
<h4 id="资源利用率"><a href="#资源利用率" class="headerlink" title="资源利用率"></a>资源利用率</h4><ul>
<li>通过将在线任务（prod）和离线任务（non-prod，Batch）混合部署，空闲时，离线任务可以充分利用计算资源；繁忙时，在线任务通过抢占的方式保证优先得到执行，合理地利用资源。</li>
<li>98% 的服务器实现了混部。</li>
<li>90% 的服务器中跑了超过25 个 Task 和 4500 个线程。</li>
<li>在一个中等规模的 Cell 里，在线任务和离线任务独立部署比混合部署所需的服务器数量多出约20%-30%。</li>
</ul>
<p>可以简单算一笔账，Google 的服务器数量在千万级别，按 20% 算也是百万级别，大概能省下的服务器采购费用就是百亿级别了，这还不包括省下的机房等基础设施和电费等费用。</p>
<h4 id="Brog-调度原理"><a href="#Brog-调度原理" class="headerlink" title="Brog 调度原理"></a>Brog 调度原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Brog调度原理.png" alt="Brog调度原理"></p>
<h4 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h4><p>安全性隔离：</p>
<ul>
<li>早期采用 Chroot jail，后期版本基于 Namespace。</li>
</ul>
<p>性能隔离：</p>
<ul>
<li>采用基于 Cgroup 的容器技术实现。</li>
<li>在线任务（prod）是延时敏感（latency-sensitive）型的，优先级高，而离线任务（non-prod，Batch）优先级低。</li>
<li>Borg 通过不同优先级之间的抢占式调度来优先保障在线任务的性能，牺牲离线任务。</li>
<li>Borg 将资源类型分成两类：</li>
<li>可压榨的（compressible），CPU 是可压榨资源，资源耗尽不会终止进程；</li>
<li>不可压榨的（non-compressible），内存是不可压榨资源，资源耗尽进程会被终止。</li>
</ul>
<h4 id="什么是Kubernetes（K8s）"><a href="#什么是Kubernetes（K8s）" class="headerlink" title="什么是Kubernetes（K8s）"></a>什么是Kubernetes（K8s）</h4><p>Kubernetes 是谷歌开源的容器集群管理系统，是 Google 多年大规模容器管理技术 Borg 的开源版本，主要功能包括：</p>
<ul>
<li>基于容器的应用部署、维护和滚动升级；</li>
<li>负载均衡和服务发现；</li>
<li>跨机器和跨地区的集群调度；</li>
<li>自动伸缩；</li>
<li>无状态服务和有状态服务；</li>
<li>插件机制保证扩展性。</li>
</ul>
<h4 id="命令式（-Imperative）vs-声明式（-Declarative）"><a href="#命令式（-Imperative）vs-声明式（-Declarative）" class="headerlink" title="命令式（ Imperative）vs 声明式（ Declarative）"></a>命令式（ Imperative）vs 声明式（ Declarative）</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/命令式和声明式.png" alt="命令式和声明式"></p>
<h4 id="声明式（Declaritive）系统规范"><a href="#声明式（Declaritive）系统规范" class="headerlink" title="声明式（Declaritive）系统规范"></a>声明式（Declaritive）系统规范</h4><p>命令式：</p>
<ul>
<li>我要你做什么，怎么做，请严格按照我说的做。</li>
</ul>
<p>声明式：</p>
<ul>
<li>我需要你帮我做点事，但是我只告诉你我需要你做什么，不是你应该怎么做。</li>
<li>直接声明：我直接告诉你我需要什么。</li>
<li>间接声明：我不直接告诉你我的需求，我会把我的需求放在特定的地方，请在方便的时候拿出来处理。</li>
</ul>
<p>幂等性：</p>
<ul>
<li>状态固定，每次我要你做事，请给我返回相同结果。</li>
</ul>
<p>面向对象的：</p>
<ul>
<li>把一切抽象成对象。</li>
</ul>
<h4 id="Kubernetes：声明式系统"><a href="#Kubernetes：声明式系统" class="headerlink" title="Kubernetes：声明式系统"></a>Kubernetes：声明式系统</h4><p>Kubernetes 的所有管理能力构建在对象抽象的基础上，核心对象包括：</p>
<ul>
<li>Node：计算节点的抽象，用来描述计算节点的资源抽象、健康状态等。</li>
<li>Namespace：资源隔离的基本单位，可以简单理解为文件系统中的目录结构。</li>
<li>Pod：用来描述应用实例，包括镜像地址、资源需求等。Kubernetes 中最核心的对象，也是打通应用和基础架构的秘密武器。</li>
<li>Service：服务如何将应用发布成服务，本质上是负载均衡和域名服务的声明。</li>
</ul>
<h4 id="Kubernetes-架构"><a href="#Kubernetes-架构" class="headerlink" title="Kubernetes 架构"></a>Kubernetes 架构</h4><p>Kubernetes 采用与 Borg 类似的架构</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/k8s架构.png" alt="k8s架构"></p>
<p>主要组件</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/k8s主要组件.png" alt="k8s主要组件"></p>
<h4 id="Kubernetes-的主节点（Master-Node）"><a href="#Kubernetes-的主节点（Master-Node）" class="headerlink" title="Kubernetes 的主节点（Master Node）"></a>Kubernetes 的主节点（Master Node）</h4><ol>
<li><p>API 服务器（API Server）</p>
<blockquote>
<p>API Server 的主要作用是对请求做认证、鉴权以及准入（验证请求内容的合法性），无其他逻辑。</p>
</blockquote>
<p> 这是Kubernetes 控制面板中唯一带有用户可访问API 以及用户可交互的组件。API 服务器会暴露一个RESTful 的Kubernetes API 并使用JSON 格式的清单文件（manifest files）。</p>
</li>
<li><p>群的数据存储（Cluster Data Store）</p>
<p> Kubernetes 使用 “etcd” 。这是一个强大的、稳定的、高可用的键值存储， 被 Kubernetes 用于长久储存所有的API 对象。</p>
</li>
<li><p>控制管理器（Controller Manager）</p>
<p> 被称为 “kube-controller manager”，它运行着所有处理集群日常任务的控制器。包括了节点控制器、副本控制器、端点（endpoint）控制器以及服务账户等。</p>
</li>
<li><p>调度器（Scheduler）</p>
<p> 调度器会监控新建的 pods（一组或一个容器）并将其分配给节点。</p>
</li>
</ol>
<h4 id="Kubernetes-的工作节点（Worker-Node）"><a href="#Kubernetes-的工作节点（Worker-Node）" class="headerlink" title="Kubernetes 的工作节点（Worker Node）"></a>Kubernetes 的工作节点（Worker Node）</h4><ol>
<li><p>Kubelet</p>
<p> 负责调度到对应节点的 Pod 的生命周期管理，执行任务并将 Pod 状态报告给主节点的渠道，通过容器运行时（拉取镜像、启动和停止容器等）来运行这些容器。它还会定期执行被请求的容器的健康探测程序。</p>
</li>
<li><p>Kube-proxy</p>
<p> 它负责节点的网络，在主机上维护网络规则并执行连接转发。它还负责对正在服务的 pods 进行负载平衡。</p>
</li>
</ol>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd.png" alt="etcd"></p>
<h4 id="直接访问-etcd-的数据"><a href="#直接访问-etcd-的数据" class="headerlink" title="直接访问 etcd 的数据"></a>直接访问 etcd 的数据</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动一个 minikube 集群</span>
$ minikube start

<span class="token comment"># 获取 kube-system 中所有 pods</span>
$ kubectl -n kube-system get pods
NAME                               READY   STATUS    RESTARTS       AGE
coredns-7db6d8ff4d-z2rlw           <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
etcd-minikube                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-apiserver-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-controller-manager-minikube   <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-proxy-m5fjm                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
kube-scheduler-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h10m
storage-provisioner                <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>4h9m ago<span class="token punctuation">)</span>   4h10m

<span class="token comment"># 进入集群 etcd 所在的容器</span>
$ kubectl -n kube-system <span class="token builtin class-name">exec</span> -it etcd-minikube /bin/sh

$ <span class="token builtin class-name">alias</span> <span class="token assign-left variable">etcdctl</span><span class="token operator">=</span><span class="token string">"etcdctl --endpoints https://localhost:2379 --cacert=/var/lib/minikube/certs/etcd/ca.crt --cert=/var/lib/minikube/certs/etcd/server.crt --key=/var/lib/minikube/certs/etcd/server.key"</span>

<span class="token comment"># 查看 etcd 中的数据</span>
$ etcdctl get --prefix / --keys-only

<span class="token comment"># 监听 default 命名空间中名为 nginx-svc 的 service 的变化</span>
$ etcdctl <span class="token function">watch</span> --prefix /registry/services/specs/default/nginx-svc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="APIServer"><a href="#APIServer" class="headerlink" title="APIServer"></a>APIServer</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer.png" alt="APIServer"></p>
<h4 id="APIServer-展开"><a href="#APIServer-展开" class="headerlink" title="APIServer 展开"></a>APIServer 展开</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer展开.png" alt="APIServer展开"></p>
<h4 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h4><ul>
<li>Controller Manager 是集群的大脑，是确保整个集群动起来的关键；</li>
<li>作用是确保 Kubernetes 遵循声明式系统规范，确保系统的真实状态（Actual State）与用户定义的期望状态（Desired State）一致；</li>
<li>Controller Manager 是多个控制器的组合，每个 Controller 事实上都是一个 control loop，负责侦听其管控的对象，当对象发生变更时完成配置；</li>
<li>Controller 配置失败通常会触发自动重试，整个集群会在控制器不断重试的机制下确保最终一致性（ Eventual Consistency）。</li>
</ul>
<h4 id="控制器的工作流程"><a href="#控制器的工作流程" class="headerlink" title="控制器的工作流程"></a>控制器的工作流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的工作流程.png" alt="控制器的工作流程"></p>
<h4 id="Informer-的内部机制"><a href="#Informer-的内部机制" class="headerlink" title="Informer 的内部机制"></a>Informer 的内部机制</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Informer的内部机制.png" alt="Informer的内部机制"></p>
<h4 id="控制器的协同工作原理"><a href="#控制器的协同工作原理" class="headerlink" title="控制器的协同工作原理"></a>控制器的协同工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的协同工作原理.png" alt="控制器的协同工作原理"></p>
<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Scheduler.png" alt="Scheduler"></p>
<h4 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubelet.png" alt="Kubelet"></p>
<h4 id="Kube-Proxy"><a href="#Kube-Proxy" class="headerlink" title="Kube-Proxy"></a>Kube-Proxy</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kube-Proxy.png" alt="Kube-Proxy"></p>
<h4 id="推荐的-Add-ons"><a href="#推荐的-Add-ons" class="headerlink" title="推荐的 Add-ons"></a>推荐的 Add-ons</h4><ul>
<li>kube-dns：负责为整个集群提供 DNS 服务；</li>
<li>Ingress Controller：为服务提供外网入口；</li>
<li>MetricsServer：提供资源监控；</li>
<li>Dashboard：提供GUI；</li>
<li>Fluentd-Elasticsearch：提供集群日志采集、存储与查询。</li>
</ul>
<h3 id="了解-kubectl"><a href="#了解-kubectl" class="headerlink" title="了解 kubectl"></a>了解 kubectl</h3><h4 id="Kubectl-命令和-kubeconfig"><a href="#Kubectl-命令和-kubeconfig" class="headerlink" title="Kubectl 命令和 kubeconfig"></a>Kubectl 命令和 kubeconfig</h4><ul>
<li>kubectl 是一个 Kubernetes 的命令行工具，它允许 Kubernetes 用户以命令行的方式与 Kubernetes 交互，其默认读取配置文件 ~/.kube/config。</li>
<li>kubectl 会将接收到的用户请求转化为 rest 调用以 rest client 的形式与 apiserver 通讯。</li>
<li>apiserver 的地址，用户信息等配置在 kubeconfig。</li>
</ul>
<p>可以在命令后加 <code>-v 9</code> 来开启详细的日志，如 <code>kubectl get namespace default -v 9</code>。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">certificate-authority</span><span class="token punctuation">:</span> /home/k/.minikube/ca.crt
    <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">extension</span><span class="token punctuation">:</span>
        <span class="token key atrule">last-update</span><span class="token punctuation">:</span> Thu<span class="token punctuation">,</span> 02 May 2024 21<span class="token punctuation">:</span>50<span class="token punctuation">:</span>24 CST
        <span class="token key atrule">provider</span><span class="token punctuation">:</span> minikube.sigs.k8s.io
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.33.0
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster_info
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">32774</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> minikube
    <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">extension</span><span class="token punctuation">:</span>
        <span class="token key atrule">last-update</span><span class="token punctuation">:</span> Thu<span class="token punctuation">,</span> 02 May 2024 21<span class="token punctuation">:</span>50<span class="token punctuation">:</span>24 CST
        <span class="token key atrule">provider</span><span class="token punctuation">:</span> minikube.sigs.k8s.io
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.33.0
      <span class="token key atrule">name</span><span class="token punctuation">:</span> context_info
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
    <span class="token key atrule">user</span><span class="token punctuation">:</span> minikube
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> minikube
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">preferences</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minikube
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token key atrule">client-certificate</span><span class="token punctuation">:</span> /home/k/.minikube/profiles/minikube/client.crt
    <span class="token key atrule">client-key</span><span class="token punctuation">:</span> /home/k/.minikube/profiles/minikube/client.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubectl-常用命令"><a href="#kubectl-常用命令" class="headerlink" title="kubectl 常用命令"></a>kubectl 常用命令</h4><p><strong>kubectl get po -oyaml -w</strong></p>
<ul>
<li>kubectl 可查看对象。</li>
<li>-oyaml 输出详细信息为 yaml 格式。</li>
<li>-w watch 该对象的后续变化。</li>
<li>-owide 以详细列表的格式查看对象。</li>
</ul>
<p><strong>kubectl describe 展示资源的详细信息和相关 Event。</strong></p>
<p><strong>kubectl exec 提供进入运行容器的通道，可以进入容器进行 debug 操作。</strong></p>
<p><strong>Kubectl logs 可查看 pod 的标准输入（stdout, stderr），与 tail 用法类似。</strong></p>
<h3 id="深入理解-Kubernetes"><a href="#深入理解-Kubernetes" class="headerlink" title="深入理解 Kubernetes"></a>深入理解 Kubernetes</h3><h4 id="云计算的传统分类"><a href="#云计算的传统分类" class="headerlink" title="云计算的传统分类"></a>云计算的传统分类</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云计算的传统分类.png" alt="云计算的传统分类"></p>
<h4 id="Kubernetes-生态系统"><a href="#Kubernetes-生态系统" class="headerlink" title="Kubernetes 生态系统"></a>Kubernetes 生态系统</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes生态系统.png" alt="Kubernetes生态系统"></p>
<h4 id="Kubernetes-设计理念"><a href="#Kubernetes-设计理念" class="headerlink" title="Kubernetes 设计理念"></a>Kubernetes 设计理念</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes设计理念.png" alt="Kubernetes设计理念"></p>
<h4 id="Kubernetes-Master"><a href="#Kubernetes-Master" class="headerlink" title="Kubernetes Master"></a>Kubernetes Master</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/KubernetesMaster.png" alt="KubernetesMaster"></p>
<h4 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h4><ul>
<li>核心层：Kubernetes 最核心的功能，对外提供 API 构建高层的应用，对内提供插件式应用执行环境。</li>
<li>应用层：部署（无状态应用、有状态应用、批处理任务、集群应用等）和路由（服务发现、DNS 解析等）。</li>
<li>管理层：系统度量（如基础设施、容器和网络的度量）、自动化（如自动扩展、动态 Provision 等）、策略管理（RBAC、Quota、PSP、NetworkPolicy 等）。</li>
<li>接口层：Kubectl 命令行工具、客户端 SDK 以及集群联邦。</li>
<li>生态系统：在接口层之上的庞大容器集群管理调度的生态系统，可以划分为两个范畴：<ul>
<li>Kubernetes 外部：日志、监控、配置管理、CI、CD、Workflow、FaaS、OTS 应用、ChatOps 等；</li>
<li>Kubernetes 内部：CRI、CNI、CVI、镜像仓库、Cloud Provider、集群自身的配置和管理等。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分层架构一.png" alt="分层架构一"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分层架构二.png" alt="分层架构二"></p>
<h4 id="API-设计原则"><a href="#API-设计原则" class="headerlink" title="API 设计原则"></a>API 设计原则</h4><ul>
<li>所有 API 都应是声明式的<ul>
<li>相对于命令式操作，声明式操作对于重复操作的效果是稳定的，这对于容易出现数据丢失或重复的分布式环境来说是很重要的。</li>
<li>声明式操作更易被用户使用，可以使系统向用户隐藏实现的细节，同时也保留了系统未来持续优化的可能性。</li>
<li>此外，声明式的 API 还隐含了所有的 API 对象都是名词性质的，例如 Service、Volume 这些 API 都是名词，这些名词描述了用户所期望得到的一个目标对象。</li>
</ul>
</li>
<li>API 对象是彼此互补而且可组合的<ul>
<li>这实际上鼓励 API 对象尽量实现面向对象设计时的要求，即”高内聚，松耦合”，对业务相关的概念有一个合适的分解，提高分解出来的对象的可重用性。</li>
</ul>
</li>
<li>高层 API 以操作意图为基础设计<ul>
<li>如何能够设计好 API，跟如何能用面向对象的方法设计好应用系统有相通的地方，高层设计一定是从业务出发，而不是过早的从技术实现出发。</li>
<li>因此，针对 Kubernetes 的高层 API 设计，一定是以 Kubernetes 的业务为基础出发，也就是以系统调度管理容器的操作意图为基础设计。</li>
</ul>
</li>
<li>低层 API 根据高层 API 的控制需要设计<ul>
<li>设计实现低层 API 的目的，是为了被高层 API 使用，考虑减少冗余、提高重用性的目的，低层 API 的设计也要以需求为基础，要尽量抵抗受技术实现影响的诱惑。</li>
</ul>
</li>
<li>尽量避免简单封装，不要有在外部 API 无法显式知道的内部隐藏的机制<ul>
<li>简单的封装，实际没有提供新的功能，反而增加了对所封装 API 的依赖性。</li>
<li>例如 StatefulSet 和 ReplicaSet，本来就是两种 Pod 集合，那么 Kubernetes 就用不同 API 对象来定义它们，而不会说只用同一个 ReplicaSet，内部通过特殊的算法再来区分这个 ReplicaSet 是有状态的还是无状态。</li>
</ul>
</li>
<li>API 操作复杂度与对象数量成正比<ul>
<li>API 的操作复杂度不能超过 O(N)，否则系统就不具备水平伸缩性了。</li>
</ul>
</li>
<li>API 对象状态不能依赖于网络连接状态<ul>
<li>由于众所周知，在分布式环境下，网络连接断开是经常发生的事情，因此要保证 API 对象状态能应对网络的不稳定，API 对象的状态就不能依赖于网络连接状态。</li>
</ul>
</li>
<li>尽量避免让操作机制依赖于全局状态<ul>
<li>因为在分布式系统中要保证全局状态的同步是非常困难的。</li>
</ul>
</li>
</ul>
<h4 id="Kubernetes-如何通过对象的组合完成业务描述"><a href="#Kubernetes-如何通过对象的组合完成业务描述" class="headerlink" title="Kubernetes 如何通过对象的组合完成业务描述"></a>Kubernetes 如何通过对象的组合完成业务描述</h4><blockquote>
<p>引用依赖：一个对象中有个属性的名字指向了另一个对象。</p>
<p>基于命名规范：Deployment 根据 PodTemplate 的 hash 值来作为 Replicaset 名字的一部分，这个关系是写在代码中的。</p>
<p>基于标签：根据标签来筛选。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes如何通过对象的组合完成业务描述.png" alt="Kubernetes如何通过对象的组合完成业务描述"></p>
<h4 id="架构设计原则"><a href="#架构设计原则" class="headerlink" title="架构设计原则"></a>架构设计原则</h4><ul>
<li>只有 APIServer 可以直接访问 etcd 存储，其他服务必须通过 Kubernetes API 来访问集群状态；</li>
<li>单节点故障不应该影响集群的状态；</li>
<li>在没有新请求的情况下，所有组件应该在故障恢复后继续执行上次最后收到的请求（比如网络分区或服务重启等）；</li>
<li>所有组件都应该在内存中保持所需要的状态，APIServer 将状态写入 etcd 存储，而其他组件则通过 API Server 更新并监听所有的变化；</li>
<li>优先使用事件监听而不是轮询。</li>
</ul>
<h4 id="引导（Bootstrapping）原则"><a href="#引导（Bootstrapping）原则" class="headerlink" title="引导（Bootstrapping）原则"></a>引导（Bootstrapping）原则</h4><ul>
<li>Self-hosting 是目标。</li>
<li>减少依赖，特别是稳态运行的依赖。</li>
<li>通过分层的原则管理依赖。</li>
<li>循环依赖问题的原则：<ul>
<li>同时还接受其他方式的数据输入（比如本地文件等），这样在其他服务不可用时还可以手动配置引导服务；</li>
<li>状态应该是可恢复或可重新发现的；</li>
<li>支持简单的启动临时实例来创建稳态运行所需要的状态，使用分布式锁或文件锁等来协调不同状态的切换（通常称为 pivoting 技术）；</li>
<li>自动重启异常退出的服务，比如副本或者进程管理器等。</li>
</ul>
</li>
</ul>
<h4 id="核心技术概念和-API-对象"><a href="#核心技术概念和-API-对象" class="headerlink" title="核心技术概念和 API 对象"></a>核心技术概念和 API 对象</h4><p>API 对象是 Kubernetes 集群中的管理操作单元。</p>
<p>Kubernetes 集群系统每支持一项新功能，引入一项新技术，一定会新引入对应的API 对象，支持对该功能的管理操作。</p>
<p>每个 API 对象都有四大类属性：</p>
<ul>
<li>TypeMeta</li>
<li>MetaData</li>
<li>Spec</li>
<li>Status</li>
</ul>
<h4 id="TypeMeta"><a href="#TypeMeta" class="headerlink" title="TypeMeta"></a>TypeMeta</h4><p>Kubernetes对象的最基本定义，它通过引入 GKV（Group，Kind，Version）模型定义了一个对象的类型。</p>
<ol>
<li>Group<br> Kubernetes 定义了非常多的对象，如何将这些对象进行归类是一门学问，将对象依据其功能范围归入不同的分组，比如把支撑最基本功能的对象归入 core 组，把与应用部署有关的对象归入 apps 组，会使这些对象的可维护性和可理解性更高。</li>
<li>Kind<br> 定义一个对象的基本类型，比如 Node、Pod、Deployment 等。</li>
<li>Version<br> 社区每个季度会推出一个 Kubernetes 版本，随着 Kubernetes 版本的演进，对象从创建之初到能够完全生产化就绪的版本是不断变化的。与软件版本类似，通常社区提出一个模型定义以后，随着该对象不断成熟，其版本可能会从 v1alpha1 到 v1alpha2，或者到 v1beta1，最终变成生产就绪版本 v1。</li>
</ol>
<h4 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h4><p>Metadata 中有两个最重要的属性：Namespace 和 Name，分别定义了对象的 Namespace 归属及名字，这两个属性唯一定义了某个对象实例。</p>
<ol>
<li><p>Label</p>
<p> 顾名思义就是给对象打标签，一个对象可以有任意对标签，其存在形式是键值对。Label 定义了对象的可识别属性，Kubernetes API 支持以 Label 作为过滤条件查询对象。</p>
</li>
<li><p>Annotation</p>
<p> Annotation 与 Label 一样用键值对来定义，但 Annotation 是作为属性扩展，更多面向于系统管理员和开发人员，因此需要像其他属性一样做合理归类。</p>
</li>
<li><p>Finalizer</p>
<p> Finalizer 本质上是一个资源锁，Kubernetes 在接收某对象的删除请求时，会检查 Finalizer 是否为空，如果不为空则只对其做逻辑删除，即只会更新对象中的 metadata.deletionTimestamp 字段。</p>
<p> 主要用于避免某个资源控制器意外终止，而无法监听到对应资源删除事件的情况。一旦某个资源设置了 Finalizer，那么这个资源删除时将不会消除，需要删除资源上的 Finalizer 后这个资源才会真正的删除，这就给了对应资源控制器处理的机会。</p>
</li>
<li><p>ResourceVersion</p>
<p> ResourceVersion 可以被看作一种乐观锁，每个对象在任意时刻都有其 ResourceVersion，当 Kubernetes 对象被客户端读取以后，ResourceVersion 信息也被一并读取。此机制确保了分布式系统中任意多线程能够无锁并发访问对象，极大提升了系统的整体效率。</p>
</li>
</ol>
<h5 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h5><ul>
<li>Label 是识别 Kubernetes 对象的标签，以 key/value 的方式附加到对象上。</li>
<li>key 最长不能超过 63 字节，value 可以为空，也可以是不超过 253 字节的字符串。</li>
<li>Label 不提供唯一性，并且实际上经常是很多对象（如 Pods）都使用相同的 label 来标志具体的应用。</li>
<li>Label 定义好后其他对象可以使用 Label Selector 来选择一组相同 label 的对象</li>
<li>Label Selector 支持以下几种方式：<ul>
<li>等式，如 app=nginx 和 env!=production；</li>
<li>集合，如 env in (production, qa)；</li>
<li>多个 label（它们之间是 AND 关系），如 app=nginx,env=test。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Label.png" alt="Label"></p>
<blockquote>
<p>图片来源：<a target="_blank" rel="noopener" href="https://draveness.me/kubernetes-object-intro/">https://draveness.me/kubernetes-object-intro/</a></p>
</blockquote>
<h5 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h5><ul>
<li>Annotations 是 key/value 形式附加于对象的注解。</li>
<li>不同于 Labels 用于标志和选择对象，Annotations 则是用来记录一些附加信息，用来辅助应用部署、安全策略以及调度策略等。</li>
<li>比如 deployment 使用 annotations 来记录 rolling update 的状态。</li>
</ul>
<h5 id="Spec-和-Status"><a href="#Spec-和-Status" class="headerlink" title="Spec 和 Status"></a>Spec 和 Status</h5><ul>
<li>Spec 和 Status 才是对象的核心。</li>
<li>Spec 是用户的期望状态，由创建对象的用户端来定义。</li>
<li>Status 是对象的实际状态，由对应的控制器收集实际状态并更新。</li>
<li>与 TypeMeta 和 Metadata 等通用属性不同，Spec 和 Status 是每个对象独有的。</li>
</ul>
<h4 id="常用Kubernetes-对象及其分组"><a href="#常用Kubernetes-对象及其分组" class="headerlink" title="常用Kubernetes 对象及其分组"></a>常用Kubernetes 对象及其分组</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/常用Kubernetes对象及其分组.png" alt="常用Kubernetes对象及其分组"></p>
<h3 id="核心对象概览"><a href="#核心对象概览" class="headerlink" title="核心对象概览"></a>核心对象概览</h3><h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><ul>
<li>Node 是 Pod 真正运行的主机，可以物理机，也可以是虚拟机。</li>
<li>为了管理 Pod，每个 Node 节点上至少要运行 container runtime（比如Docker 或者Rkt）、Kubelet 和 Kube-proxy 服务。</li>
</ul>
<h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h4><p>Namespace 是对一组资源和对象的抽象集合，比如可以用来将系统内部的对象划分为不同的项目组或用户组。</p>
<p>常见的 pods, services, replication controllers 和 deployments 等都是属于某一个 Namespace 的（默认是 default），而 Node, persistentVolumes 等则不属于任何 Namespace。</p>
<h4 id="什么是-Pod"><a href="#什么是-Pod" class="headerlink" title="什么是 Pod"></a>什么是 Pod</h4><ul>
<li>Pod 是一组紧密关联的容器集合，它们共享 PID、IPC、Network 和 UTS namespace，是 Kubernetes 调度的基本单位。</li>
<li>Pod 的设计理念是支持多个容器在一个 Pod 中共享网络和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。</li>
<li>同一个 Pod 中的不同容器可共享资源：<ul>
<li>共享网络 Namespace；</li>
<li>可通过挂载存储卷共享存储；</li>
<li>共享 Security Context。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.15</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="如何通过Pod-对象定义支撑应用运行"><a href="#如何通过Pod-对象定义支撑应用运行" class="headerlink" title="如何通过Pod 对象定义支撑应用运行"></a>如何通过Pod 对象定义支撑应用运行</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何通过Pod对象定义支撑应用运行.png" alt="如何通过Pod对象定义支撑应用运行"></p>
<h4 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h4><ul>
<li>通过存储卷可以将外挂存储挂载到 Pod 内部使用。</li>
<li>存储卷定义包括两个部分: Volume 和 VolumeMounts。<ul>
<li>Volume：定义 Pod 可以使用的存储卷来源；</li>
<li>VolumeMounts：定义存储卷如何 Mount 到容器内部。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>volume
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.15</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Pod-网络"><a href="#Pod-网络" class="headerlink" title="Pod 网络"></a>Pod 网络</h4><p>Pod 的多个容器是共享网络 Namespace 的，这意味着：</p>
<ul>
<li>同一个 Pod 中的不同容器可以彼此通过 Loopback 地址访问：<ul>
<li>在第一个容器中起了一个服务 <a target="_blank" rel="noopener" href="http://127.0.0.1">http://127.0.0.1</a> 。</li>
<li>在第二个容器内，是可以通过 httpGet <a target="_blank" rel="noopener" href="http://172.0.0.1">http://172.0.0.1</a> 访问到该地址的。</li>
</ul>
</li>
<li>这种方法常用于不同容器的互相协作。</li>
</ul>
<h4 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h4><p>Kubernetes 通过 Cgroups 提供容器资源管理的功能，可以限制每个容器的 CPU 和内存使用，比如对于刚才创建的 deployment，可以通过下面的命令限制 nginx 容器最多只用 50% 的CPU 和 128MB 的内存：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">set</span> resources deployment nginx-app -c<span class="token operator">=</span>nginx --limits<span class="token operator">=</span>cpu<span class="token operator">=</span>500m,memory<span class="token operator">=</span>128Mi
deployment <span class="token string">"nginx"</span> resource requirements updated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>等同于在每个 Pod 中设置 resources limits</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"500m"</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"128Mi"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h4><p>Kubernetes 作为一个面向应用的集群管理工具，需要确保容器在部署后确实处在正常的运行状态。</p>
<ol>
<li>探针类型：</li>
</ol>
<ul>
<li>LivenessProbe<ul>
<li>探测应用是否处于健康状态，如果不健康则删除并重新创建容器。</li>
</ul>
</li>
<li>ReadinessProbe<ul>
<li>探测应用是否就绪并且处于正常服务状态，如果不正常则不会接收来自 Kubernetes Service 的流量。</li>
</ul>
</li>
<li>StartupProbe<ul>
<li>探测应用是否启动完成，如果在 <code>failureThreshold * periodSeconds</code> 周期内未就绪，则会应用进程会被重启。</li>
</ul>
</li>
</ul>
<ol>
<li>探活方式：</li>
</ol>
<ul>
<li>Exec</li>
<li>TCP socket</li>
<li>HTTP</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/健康检查spec.png" alt="健康检查spec"></p>
<h4 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><ul>
<li>ConfigMap 用来将非机密性的数据保存到键值对中。</li>
<li>使用时， Pods 可以将其用作环境变量、命令行参数或者存储卷中的配置文件。</li>
<li>ConfigMap 将环境配置信息和容器镜像解耦，便于应用配置的修改。</li>
</ul>
<h4 id="密钥对象（Secret）"><a href="#密钥对象（Secret）" class="headerlink" title="密钥对象（Secret）"></a>密钥对象（Secret）</h4><ul>
<li>Secret 是用来保存和传递密码、密钥、认证凭证这些敏感信息的对象。</li>
<li>使用 Secret 的好处是可以避免把敏感信息明文写在配置文件里。</li>
<li>Kubernetes 集群中配置和使用服务不可避免的要用到各种敏感信息实现登录、认证等功能，例\如访问 AWS 存储的用户名密码。</li>
<li>为了避免将类似的敏感信息明文写在所有需要使用的配置文件中，可以将这些信息存入一个 Secret 对象，而在配置文件中通过 Secret 对象引用这些敏感信息。</li>
<li>这种方式的好处包括：意图明确，避免重复，减少暴漏机会。</li>
</ul>
<h4 id="用户（User-Account）-amp-服务帐户（Service-Account）"><a href="#用户（User-Account）-amp-服务帐户（Service-Account）" class="headerlink" title="用户（User Account）&amp; 服务帐户（Service Account）"></a>用户（User Account）&amp; 服务帐户（Service Account）</h4><ul>
<li>顾名思义，用户帐户为人提供账户标识，而服务账户为计算机进程和 Kubernetes 集群中运行的 Pod 提供账户标识。</li>
<li>用户帐户和服务帐户的一个区别是作用范围：<ul>
<li>用户帐户对应的是人的身份，人的身份与服务的 Namespace 无关，所以用户账户是跨 Namespace 的；</li>
<li>而服务帐户对应的是一个运行中程序的身份，与特定 Namespace 是相关的。</li>
</ul>
</li>
</ul>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p>Service 是应用服务的抽象，通过 labels 为应用提供负载均衡和服务发现。匹配 labels 的 Pod IP 和端口列表组成 <code>endpoints</code>，由 Kube-proxy 负责将服务 IP 负载均衡到这些 endpoints 上。</p>
<p>每个 Service 都会自动分配一个 cluster IP（仅在集群内部可访问的虚拟地址）和 DNS 名，其他容器可以通过该地址或 DNS 来访问服务，而不需要了解后端容器的运行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service.png" alt="Service"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8078</span> <span class="token comment"># the port that this service should serve on</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token comment"># the container on each pod to connect to, can be a name</span>
    <span class="token comment"># (e.g. 'www') or a number (e.g. 80)</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="副本集（Replica-Set）"><a href="#副本集（Replica-Set）" class="headerlink" title="副本集（Replica Set）"></a>副本集（Replica Set）</h4><ul>
<li>Pod 只是单个应用实例的抽象，要构建高可用应用，通常需要构建多个同样的副本，提供同一个服务。</li>
<li>Kubernetes 为此抽象出副本集 ReplicaSet，其允许用户定义 Pod 的副本数，每一个 Pod 都会被当作一个无状态的成员进行管理，Kubernetes 保证总是有用户期望的数量的 Pod 正常运行。</li>
<li>当某个副本宕机以后，控制器将会创建一个新的副本。</li>
<li>当因业务负载发生变更而需要调整扩缩容时，可以方便地调整副本数量。</li>
</ul>
<p>RS 创建出来的名字分为三个部分，如：<code>nginx-deploy-59dc7f9d89-k9rj9</code></p>
<ol>
<li>第一个部分 <code>nginx-deploy</code> 是 deployment 的名字。</li>
<li>第二个部分 <code>59dc7f9d89</code> 是配置字符串的 hash 值。</li>
<li>第三个部分 <code>k9rj9</code> 是随机值，因为是无状态的，所以给任何值都是可以的。</li>
</ol>
<h4 id="部署（Deployment）"><a href="#部署（Deployment）" class="headerlink" title="部署（Deployment）"></a>部署（Deployment）</h4><ul>
<li>部署表示用户对 Kubernetes 集群的一次更新操作。</li>
<li>部署是一个比 RS 应用模式更广的 API 对象，可以是创建一个新的服务，更新一个新的服务，也可以是滚动升级一个服务。</li>
<li>滚动升级一个服务，实际是创建一个新的 RS，然后逐渐将新 RS 中副本数增加到理想状态，将旧 RS 中的副本数减小到 0 的复合操作。</li>
<li>这样一个复合操作用一个 RS 是不太好描述的，所以用一个更通用的 Deployment 来描述。</li>
<li>以 Kubernetes 的发展方向，未来对所有长期伺服型的的业务的管理，都会通过 Deployment 来管理。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Deployment.png" alt="Deployment"></p>
<h4 id="有状态服务集（StatefulSet）"><a href="#有状态服务集（StatefulSet）" class="headerlink" title="有状态服务集（StatefulSet）"></a>有状态服务集（StatefulSet）</h4><ul>
<li>对于 StatefulSet 中的 Pod，每个 Pod 挂载自己独立的存储，如果一个 Pod 出现故障，从其他节点启动一个同样名字的 Pod，要挂载上原来 Pod 的存储继续以它的状态提供服务。</li>
<li>适合于 StatefulSet 的业务包括数据库服务 MySQL 和 PostgreSQL，集群化管理服务 ZooKeeper、etcd 等有状态服务。</li>
<li>使用 StatefulSet，Pod 仍然可以通过漂移到不同节点提供高可用，而存储也可以通过外挂的存储来提供高可靠性，StatefulSet 做的只是将确定的 Pod 与确定的存储关联起来保证状态的连续性。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/StatefulSet.png" alt="StatefulSet"></p>
<h4 id="Statefulset-与Deployment-的差异"><a href="#Statefulset-与Deployment-的差异" class="headerlink" title="Statefulset 与Deployment 的差异"></a>Statefulset 与Deployment 的差异</h4><ul>
<li>身份标识<ul>
<li>StatefulSet Controller 为每个 Pod 编号，序号从 0 开始。</li>
</ul>
</li>
<li>数据存储<ul>
<li>StatefulSet 允许用户定义volumeClaimTemplates，Pod 被创建的同时，Kubernetes 会以 volumeClaimTemplates 中定义的模板创建存储卷，并挂载给Pod。</li>
</ul>
</li>
<li>StatefulSet 的升级策略不同<ul>
<li>onDelete</li>
<li>滚动升级</li>
<li>分片升级</li>
</ul>
</li>
</ul>
<h4 id="任务（Job）"><a href="#任务（Job）" class="headerlink" title="任务（Job）"></a>任务（Job）</h4><ul>
<li>Job 是 Kubernetes 用来控制批处理型任务的 API 对象。</li>
<li>Job 管理的 Pod 根据用户的设置把任务成功完成后就自动退出。</li>
<li>成功完成的标志根据不同的 spec.completions 策略而不同：<ul>
<li>单 Pod 型任务有一个 Pod 成功就标志完成；</li>
<li>定数成功型任务保证有 N 个任务全部成功；</li>
<li>工作队列型任务根据应用确认的全局成功而标志成功。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Job.png" alt="Job"></p>
<h4 id="后台支撑服务集（DaemonSet）"><a href="#后台支撑服务集（DaemonSet）" class="headerlink" title="后台支撑服务集（DaemonSet）"></a>后台支撑服务集（DaemonSet）</h4><ul>
<li>长期伺服型和批处理型服务的核心在业务应用，可能有些节点运行多个同类业务的 Pod，有些节点上又没有这类 Pod 运行；</li>
<li>而后台支撑型服务的核心关注点在 Kubernetes 集群中的节点（物理机或虚拟机），要保证每个节点上都有一个此类 Pod 运行。</li>
<li>节点可能是所有集群节点也可能是通过 nodeSelector 选定的一些特定节点。</li>
<li>典型的后台支撑型服务包括存储、日志和监控等在每个节点上支撑 Kubernetes 集群运行的服务。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DaemonSet.png" alt="DaemonSet"></p>
<h4 id="存储-PV-和-PVC"><a href="#存储-PV-和-PVC" class="headerlink" title="存储 PV 和 PVC"></a>存储 PV 和 PVC</h4><ul>
<li>PersistentVolume（PV）是集群中的一块存储卷，可以由管理员手动设置，或当用户创建 PersistentVolumeClaim（PVC）时根据 StorageClass 动态设置。</li>
<li>PV 和 PVC 与 Pod 生命周期无关。也就是说，当 Pod 中的容器重新启动、Pod 重新调度或者删除时，PV 和 PVC 不会受到影响，Pod 存储于 PV 里的数据得以保留。</li>
<li>对于不同的使用场景，用户通常需要不同属性（例如性能、访问模式等）的 PV。</li>
</ul>
<h4 id="CustomResourceDefinition"><a href="#CustomResourceDefinition" class="headerlink" title="CustomResourceDefinition"></a>CustomResourceDefinition</h4><ul>
<li>CRD 就像数据库的开放式表结构，允许用户自定义 Schema。</li>
<li>有了这种开放式设计，用户可以基于 CRD 定义一切需要的模型，满足不同业务的需求。</li>
<li>社区鼓励基于 CRD 的业务抽象，众多主流的扩展应用都是基于 CRD 构建的，比如 Istio、Knative。</li>
<li>甚至基于 CRD 推出了 Operator Mode 和 Operator SDK，可以以极低的开发成本定义新对象，并构建新对象的控制器。</li>
</ul>
<h2 id="Kubernetes-控制平面组件-etcd"><a href="#Kubernetes-控制平面组件-etcd" class="headerlink" title="Kubernetes 控制平面组件 etcd"></a>Kubernetes 控制平面组件 etcd</h2><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/etcd-apiserver-ca58297a3d6f4b2c813ced100724a463">etcd在apiserver中的使用</a></p>
<h3 id="etcd-1"><a href="#etcd-1" class="headerlink" title="etcd"></a>etcd</h3><p>Etcd是 CoreOS 基于 Raft 开发的分布式 key value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）。</p>
<p>在分布式系统中，如何管理节点间的状态一直是一个难题，etcd 像是专门为集群环境的服务发现和注册而设计，它提供了数据 TTL 失效、数据改变监视、多值、目录监听、分布式锁原子操作等功能，可以方便的跟踪并管理集群节点的状态。</p>
<ul>
<li>键值对存储：将数据存储在分层组织的目录中，如同在标准文件系统中</li>
<li>监测变更：监测特定的键或目录以进行更改，并对值的更改做出反应</li>
<li>简单 curl 可访问的用户的 API HTTP+JSON</li>
<li>安全 : 可选的 SSL 客户端证书认证</li>
<li>快速 : 单实例每秒 1000 次写操作， 2000+ 次读操作</li>
<li>可靠 : 使用 Raft 算法保证一致性</li>
</ul>
<h4 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h4><ul>
<li>基本的 key value 存储</li>
<li>监听机制</li>
<li>key 的过期及续约机制，用于监控和服务发现</li>
<li>原子 Compare And Swap 和 Compare And Delete ，用于分布式锁和 leader 选举</li>
</ul>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li>也可以用于键值对存储，应用程序可以读取和写入 etcd 中的数据</li>
<li>etcd 比较多的应用场景是用于服务注册与发现</li>
<li>基于监听机制的分布式异步系统</li>
</ul>
<h4 id="键值对存储"><a href="#键值对存储" class="headerlink" title="键值对存储"></a>键值对存储</h4><p>etcd 是一个 <strong>键值存储</strong> 的组件，其他的应用都是基于其键值存储的功能展开。</p>
<ul>
<li>采用 kv 型数据存储，一般情况下比关系型数据库快。</li>
<li>支持动态存储（内存）以及静态存储（磁盘）。</li>
<li>分布式存储，可集成为多节点集群。</li>
<li>存储方式，采用类似目录结构。（B+tree）</li>
<li>只有叶子节点才能真正存储数据，相当于文件。</li>
<li>叶子节点的父节点一定是目录，目录不能存储数据。</li>
</ul>
<h4 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h4><ul>
<li>强一致性、高可用的服务存储目录。<ul>
<li>基于 Raft 算法的 etcd 天生就是这样一个强一致性、高可用的服务存储目录。</li>
</ul>
</li>
<li>一种注册服务和服务健康状况的机制。<ul>
<li>用户可以在 etcd 中注册服务，并且对注册的服务配置 key TTL 定时保持服务的心跳以达到监控健康状态的效果。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd服务注册与发现.png" alt="etcd服务注册与发现"></p>
<h4 id="消息发布与订阅"><a href="#消息发布与订阅" class="headerlink" title="消息发布与订阅"></a>消息发布与订阅</h4><ul>
<li>在分布式系统中，最适用的一种组件间通信方式就是消息发布与订阅。</li>
<li>即构建一个配置共享中心，数据提供者在这个配置中心发布消息，而消息使用者则订阅他们关心的主题，一旦主题有消息发布，就会实时通知订阅者。</li>
<li>通过这种方式可以做到分布式系统配置的集中式管理与动态更新。</li>
<li>应用中用到的一些配置信息放到 etcd 上进行集中管理。</li>
<li>应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候， etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd消息发布与订阅.png" alt="etcd消息发布与订阅"></p>
<h4 id="etcd-练习"><a href="#etcd-练习" class="headerlink" title="etcd 练习"></a>etcd 练习</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cncamp/101/blob/master/module5/1.etcd-member-list.MD">etcd 的安装</a></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">查看集群成员状态
$ etcdctl member list <span class="token function">write</span> <span class="token assign-left variable">out</span><span class="token operator">=</span>table
+------------------+---------+----------+---------------------------+---------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>   NAME   <span class="token operator">|</span>        PEER ADDRS         <span class="token operator">|</span>       CLIENT ADDRS        <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+----------+---------------------------+---------------------------+------------+
<span class="token operator">|</span> aec36adc501070cc <span class="token operator">|</span> started <span class="token operator">|</span> minikube <span class="token operator">|</span> https://192.168.49.2:2380 <span class="token operator">|</span> https://192.168.49.2:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+----------+---------------------------+---------------------------+------------+

<span class="token comment"># 写</span>
$ etcdctl put /a b
OK

<span class="token comment"># 读</span>
$ etcdctl get /a
/a
b

$ etcdctl get /a -wjson
<span class="token punctuation">{</span>
  <span class="token string">"header"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"cluster_id"</span><span class="token builtin class-name">:</span> <span class="token number">18038207397139143000</span>,
    <span class="token string">"member_id"</span><span class="token builtin class-name">:</span> <span class="token number">12593026477526643000</span>,
    <span class="token string">"revision"</span><span class="token builtin class-name">:</span> <span class="token number">23279</span>,              // 全局唯一的 revision， 每当 etcd 中有数据修改时，这个记录就会 +1
    <span class="token string">"raft_term"</span><span class="token builtin class-name">:</span> <span class="token number">4</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"kvs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token string">"L2E="</span>,
      <span class="token string">"create_revision"</span><span class="token builtin class-name">:</span> <span class="token number">11164</span>,     // key 创建时 revision 的值
      <span class="token string">"mod_revision"</span><span class="token builtin class-name">:</span> <span class="token number">11164</span>,        // key 上次修改时 revision 的值
      <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token string">"Yg=="</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"count"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment"># 按 key 的前缀查询数据</span>
$ etcdctl get --prefix /
$ etcdctl get --prefix / --keys-only --debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="核心：TTL-amp-CAS"><a href="#核心：TTL-amp-CAS" class="headerlink" title="核心：TTL &amp; CAS"></a>核心：TTL &amp; CAS</h4><p>TTL（time to live）指的是给一个 key 设置一个有效期，到期后这个 key 就会被自动删掉，这在很多分布式锁的实现上都会用到，可以保证锁的实时有效性。<br>Atomic Compare and Swap（CAS）指的是在对 key 进行赋值的时候，客户端需要提供一些条件，当这些条件满足后，才能赋值成功。这些条件包括：</p>
<ul>
<li>prevExist key 当前赋值前是否存在</li>
<li>prevValue key 当前赋值前的值</li>
<li>prevIndex key 当前赋值前的 Index</li>
</ul>
<p>这样的话，key 的设置是有前提的，需要知道这个 key 当前的具体情况才可以对其设置。</p>
<h3 id="Raft-协议"><a href="#Raft-协议" class="headerlink" title="Raft 协议"></a>Raft 协议</h3><h4 id="Raft-协议概览"><a href="#Raft-协议概览" class="headerlink" title="Raft 协议概览"></a>Raft 协议概览</h4><p>Raft 协议基于 quorum 机制，即大多数同意原则，任何的变更都需超过半数的成员确认</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Raft协议概览.png" alt="Raft协议概览"></p>
<h4 id="理解-Raft-协议"><a href="#理解-Raft-协议" class="headerlink" title="理解 Raft 协议"></a>理解 Raft 协议</h4><p><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p>
<h4 id="learner"><a href="#learner" class="headerlink" title="learner"></a>learner</h4><p>Raft 4.2.1 引入的新角色</p>
<p>当出现一个 etcd 集群 需要增加节点 时 ，新节点与 Leader 的数据差异较大，需要较多数据同步才能跟上 leader 的最新的数据。</p>
<p>此时 Leader 的网络带宽很可能被用尽，进而使得 leader 无法正常保持心跳。</p>
<p>进而导致 follower 重新发起投票 。</p>
<p>进而可能引发 etcd 集群不可用 。</p>
<p>Learner 角色只接收数据而不参与投票 ，因此增加 learner 节点时，集群的 quorum 不变 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdLearner.png" alt="EtcdLearner"></p>
<h4 id="etcd-基于-Raft-的一致性"><a href="#etcd-基于-Raft-的一致性" class="headerlink" title="etcd 基于 Raft 的一致性"></a>etcd 基于 Raft 的一致性</h4><p>选举方法</p>
<ul>
<li>初始启动时，节点处于 follower 状态并被设定一个 election timeout ，如果在这一时间周期内没有收到来自 leader 的 heartbeat ，节点将发起选举：将自己切换为 candidate 之后，向集群中其它 follower 节点发送请求，询问其是否选举自己成为 leader 。</li>
<li>当收到来自集群中过半数节点的接受投票后，节点即成为 leader ，开始接收保存 client 的数据并向其它的 follower 节点同步日志。如果没有达成一致，则 candidate 随机选择一个等待间隔（ 150ms ~ 300ms ）再次发起投票，得到集群中半数以上 follower 接受的 candidate 将成为 leader</li>
<li>leader 节点依靠定时向 follower 发送 heartbeat 来保持其地位。</li>
<li>任何时候如果其它 follower 在 election timeout 期间都没有收到来自 leader 的 heartbeat ，同样会将自己的状态切换为 candidate 并发起选举。每成功选举一次，新 leader 的任期（ Term ）都会比之前 leader 的任期大 1 。</li>
</ul>
<h4 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h4><p>当接 Leader 收到客户端的日志（事务请求）后先把该日志追加到本地的 Log 中，然后通过 heartbeat 把该 Entry 同步给其他 Follower Follower 接收到日志后记录日志然后向 Leader 发送 ACK ，当 Leader 收到大多数（ n/2+1 Follower 的 ACK 信息后将该日志设置为已提交并追加到本地磁盘中，通知客户端并在下个 heartbeat 中 Leader 将通知所有的 Follower 将该日志存储在自己的本地磁盘中。</p>
<h4 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h4><p>安全性是用于保证每个节点都执行相同序列的安全机制，如当某个 Follower 在当前 Leader commit Log 时变得不可用了，稍后可能该 Follower 又会被选举为 Leader ，这时新 Leader 可能会用新的 Log 覆盖先前已 committed 的 Log ，这就是导致节点执行不同序列 Safety 就是用于保证选举出来的 Leader 一定包含先前 committed Log 的机制；</p>
<p>选举安全性（Election Safety ）：每个任期（Term）只能选举出一个 Leader</p>
<p>Leader完整性（ Leader Completeness ）：指 Leader 日志的完整性，当 Log 在任期 Term1 被 Commit 后，那么以后任期 Term2 、 Term3… 等的 Leader 必须包含该 Log Raft 在选举阶段就使用 Term 的判断用于保证完整性：当请求投票的该 Candidate 的 Term 较大或 Term 相同 Index 更大则投票，否则拒绝该请求。</p>
<h4 id="失效处理"><a href="#失效处理" class="headerlink" title="失效处理"></a>失效处理</h4><ol>
<li>Leader 失效：其他没有收到 heartbeat 的节点会发起新的选举，而当 Leader 恢复后由于步进数小会自动成为 follower （日志也会被新 leader 的日志覆盖）</li>
<li>follower 节点不可用： follower 节点不可用的情况相对容易解决。因为集群中的日志内容始终是从 leader 节点同步的，只要这一节点再次加入集群时重新从 leader 节点处制日志即可。</li>
<li>多个 candidate ：冲突后 candidate 将随机选择一个等待间隔（ 150ms ~ 300ms ）再次发起投票，得到集群中半数以上 follower 接受的 candidate 将成为 leader</li>
</ol>
<h4 id="wal-日志"><a href="#wal-日志" class="headerlink" title="wal 日志"></a>wal 日志</h4><p>wal 日志是二进制的，解析出来后是以上数据结构 LogEntry 。其中第一个字段 type ，只有两种。一种是 0 表示 Normal 1 表示 ConfChange ConfChange 表示 Etcd 本身的配置变更同步，比如有新的节点加入等）。第二个字段是 term ，每个 term 代表一个主节点的任期，每次主节点变更 term 就会变化。第三个字段是 index ，这个序号是严格有序递增的，代表变更序号。第四个字段是二进制的 data ，将 raft request 对象的 pb 结构整个保存下。 etcd 源码下有个 tools/etcd dump logs ，可以将 wal 日志 dump 成文本查看，可以协助分析 Raft 协议。</p>
<p>Raft 协议本身不关心应用数据，也就是 data 中的部分，一致性都通过同步 wal 日志来实现，每个节点将从主节点收到的 data apply 到本地的存储， Raft 只关心日志的同步状态，如果本地存储实现的有 bug ，比如没有正确的将 data apply 到本地，也可能会导致数据不一致。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdLogEntry.png" alt="EtcdLogEntry"></p>
<h4 id="etcd-v3-存储"><a href="#etcd-v3-存储" class="headerlink" title="etcd v3 存储"></a>etcd v3 存储</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdV3存储.png" alt="EtcdV3存储"></p>
<h4 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h4><p>etcd v3 store 分为两部分，一部分是内存中的索引， kvindex ，是基于 Google 开源的一个 Golang 的 btree 实现的，另外一部分是后端存储。按照它的设计， backend 可以对接多种存储，当前使用的 boltdb 。 boltdb 是一个单机的支持事务的 kv 存储， etcd 的事务是基于 boltdb 的事务实现的。 etcd 在 boltdb 中存储的 key 是 reversion value 是 etcd 自己的 key value 组合，也就是说 etcd 会在 boltdb 中把每个版本都保存下，从而实现了多版本机制。</p>
<p>reversion 主要由两部分组成，第一部分 main rev ，每次事务进行加一，第二部分 sub rev ，同一个事务中的每次操作加一。</p>
<p>etcd 提供了命令和设置选项来控制 compact ，同时支持 put 操作的参数来精确控制某个 key 的历史版本数。</p>
<p>内存 kvindex 保存的就是 key 和 reversion 之前的映射关系，用来加速查询。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd存储机制.png" alt="Etcd存储机制"></p>
<blockquote>
<ol>
<li><p>每个 Etcd node 都有这些模块。</p>
</li>
<li><p>只有 Leader 能写，即使是 Follower 收到写请求，在做完 “预检查” 后，也会把请求转给 Leader。</p>
</li>
<li><p>Leader 收到请求后，先把修改放到 <code>unstable</code>，等收到超过半数的 Node 确认后移动到 <code>committed</code>，最后把修改应用到内存中的 MVCC 模块后才会挪到 <code>applied</code>。</p>
</li>
<li><p>只有存在在 MVCC 模块中的数据才能被客户端查询到。</p>
</li>
</ol>
</blockquote>
<h4 id="Watch-机制"><a href="#Watch-机制" class="headerlink" title="Watch 机制"></a>Watch 机制</h4><p>etcd v3 的 watch 机制支持 watch 某个固定的 key ，也支持 watch 一个范围（可以用于模拟目录的结构的 watch ），所以 watchGroup 包含两种 watcher ，一种是 key watchers ，数据结构是每个 key 对应一组 watcher ，另外一种是 range watchers, 数据结构是一个 IntervalTree ，方便通过区间查找到对应的 watcher 。</p>
<p>同时，每个 WatchableStore 包含两种 watcherGroup ，一种是 synced ，一种是 unsynced 前者表示该 group 的 watcher 数据都已经同步完毕，在等待新的变更，后者表示该 group 的 watcher 数据同步落后于当前最新变更，还在追赶。</p>
<p>当 etcd 收到客户端的 watch 请求，如果请求携带了 revision 参数，则比较请求的 revision 和 store 当前的 revision ，如果大于当前 revision ，则放入 synced 组中，否则放入 unsynced 组。同时 etcd 会启动一个后台的 goroutine 持续同步 unsynced 的 watcher ，然后将其迁移到 synced 组。也就是这种机制下， etcd v3 支持从任意版本开始 watch ，没有 v2 的 1000 条历史 event 表限制的问题（当然这是指没有 compact 的情况下）</p>
<h4 id="etcd-重要参数"><a href="#etcd-重要参数" class="headerlink" title="etcd 重要参数"></a>etcd 重要参数</h4><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">成员相关参数
  --name 'default'
    Human-readable name for this member.
  --data-dir '${name}.etcd'
    Path to the data directory.
  --listen-peer-urls 'http://localhost:2380'
    List of URLs to listen on for peer traffic.
  --listen-client-urls 'http://localhost:2379'
    List of URLs to listen on for client grpc traffic and http as long as --listen-client-http-urls is not specified.

集群相关参数
  --initial-advertise-peer-urls 'http://localhost:2380'
    List of this member's peer URLs to advertise to the rest of the cluster.
  --initial-cluster 'default=http://localhost:2380'
    Initial cluster configuration for bootstrapping.
  --initial-cluster-state 'new'
    Initial cluster state ('new' when bootstrapping a new cluster or 'existing' when adding new members to an existing cluster).
    After successful initialization (bootstrapping or adding), flag is ignored on restarts.
  --initial-cluster-token 'etcd-cluster'
    Initial cluster token for the etcd cluster during bootstrap.
    Specifying this can protect you from unintended cross-cluster interaction when running multiple clusters.
  --advertise-client-urls 'http://localhost:2379'
    List of this member's client URLs to advertise to the public.
    The client URLs advertised should be accessible to machines that talk to etcd cluster. etcd client libraries parse these URLs to connect to the cluster.

安全相关参数
  --cert-file ''
    Path to the client server TLS cert file.
  --key-file ''
    Path to the client server TLS key file.
  --client-crl-file ''
    Path to the client certificate revocation list file.
  --trusted-ca-file ''
    Path to the client server TLS trusted CA cert file.
  --peer-cert-file ''
    Path to the peer server TLS cert file.
  --peer-key-file ''
    Path to the peer server TLS key file.
  --peer-trusted-ca-file ''
    Path to the peer server TLS trusted CA file.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="灾备"><a href="#灾备" class="headerlink" title="灾备"></a>灾备</h4><p>创建 Snapshot：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcdctl snapshot save snapshot.db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>恢复数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcdctl snapshot restore snapshot.db <span class="token punctuation">\</span>
    --name infra2 <span class="token punctuation">\</span>
    --data-dir<span class="token operator">=</span>/tmp/etcd/infra2 <span class="token punctuation">\</span>
    --initial-cluster <span class="token assign-left variable">infra0</span><span class="token operator">=</span>http://127.0.0.1:3380,infra1<span class="token operator">=</span>http://127.0.0.1:4380,infra2<span class="token operator">=</span>http://127.0.0.1:5380 <span class="token punctuation">\</span>
    --initial-cluster-token etcd-cluster-1 <span class="token punctuation">\</span>
    --initial-advertise-peer-urls http://127.0.0.1:5380<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="容量管理"><a href="#容量管理" class="headerlink" title="容量管理"></a>容量管理</h4><ul>
<li>单个对象不建议超过 1.5M</li>
<li>默认容量 2G</li>
<li>不建议超过 8G</li>
</ul>
<h4 id="Alarm-amp-Disarm-Alarm"><a href="#Alarm-amp-Disarm-Alarm" class="headerlink" title="Alarm &amp; Disarm Alarm"></a>Alarm &amp; Disarm Alarm</h4><p>设置 etcd 存储大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcd --quota-backend-bytes<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token variable">))</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>写爆磁盘</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token operator">|</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put key <span class="token operator">||</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 endpoint 状态</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --write-out<span class="token operator">=</span>table endpoint status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 alarm</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl alarm list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>清理碎片</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl defrag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>清理 alarm</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl alarm disarm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="碎片整理"><a href="#碎片整理" class="headerlink" title="碎片整理"></a>碎片整理</h4><p>Keep one hour of history</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">etcd --auto-compaction-retention<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Compact up to revision 3</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ etcdctl compact <span class="token number">3</span>
$ etcdctl defrag
Finished defragmenting etcd member<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:2379<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="高可用-etcd-解决方案"><a href="#高可用-etcd-解决方案" class="headerlink" title="高可用 etcd 解决方案"></a>高可用 etcd 解决方案</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cncamp/101/tree/master/module5/etcd-ha-demo">https://github.com/cncamp/101/tree/master/module5/etcd-ha-demo</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/EtcdOperator.png" alt="EtcdOperator"></p>
<p>etcd operator: coreos 开源的 ，基于 kubernetes CRD 完成 etcd 集群配置。 Archived</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/etcd-operator">https://github.com/coreos/etcd-operator</a></p>
<p>Etcd statefulset Helm chart: Bitnami (powered by vmware )</p>
<p><a target="_blank" rel="noopener" href="https://bitnami.com/stack/etcd/helm">https://bitnami.com/stack/etcd/helm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/bitnami/charts/blob/master/bitnami/etcd">https://github.com/bitnami/charts/blob/master/bitnami/etcd</a></p>
<h4 id="Kubernetes-如何使用-etcd"><a href="#Kubernetes-如何使用-etcd" class="headerlink" title="Kubernetes 如何使用 etcd"></a>Kubernetes 如何使用 etcd</h4><p>etcd 是 kubernetes 的后端存储</p>
<p>对于每一个 kubernetes Object ，都有对应的 storage.go 负责对象的存储操作 <code>pkg/registry/core/pod/storage/storage.go</code></p>
<p>API server 启动脚本中指定 etcd servers 集群</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> etcd
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2379</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>data<span class="token punctuation">-</span>dir=/var/lib/etcd
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>cluster=cadmin=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.key
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2379</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2381</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.34.2<span class="token punctuation">:</span><span class="token number">2380</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>name=cadmin
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.key
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>snapshot<span class="token punctuation">-</span>count=10000
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>早期 API server 对 etcd 做简单的 Ping check ，现在已经改为真实的 etcd api call</p>
<h4 id="etcd-在集群中所处的位置"><a href="#etcd-在集群中所处的位置" class="headerlink" title="etcd 在集群中所处的位置"></a>etcd 在集群中所处的位置</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/etcd在集群中所处的位置.png" alt="etcd在集群中所处的位置"></p>
<h4 id="集群的高可用拓扑"><a href="#集群的高可用拓扑" class="headerlink" title="集群的高可用拓扑"></a>集群的高可用拓扑</h4><h5 id="堆叠式-etcd-集群的高可用拓扑"><a href="#堆叠式-etcd-集群的高可用拓扑" class="headerlink" title="堆叠式 etcd 集群的高可用拓扑"></a>堆叠式 etcd 集群的高可用拓扑</h5><p>这种拓扑将相同节点上的控制平面和 etcd 成员耦合在一起。优点在于建立起来非常容易，并且对副本的管理也更容易。但是，堆叠式存在耦合失败的风险。如果一个节点发生故障，则 etcd 成员和控制平面实例都会丢失，并且集群冗余也会受到损害。可以通过添加更多控制平面节点来减轻这种风险。因此为实现集群高可用应该至少运行三个堆叠的 Master 节点。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/堆叠式etcd集群的高可用拓扑.png" alt="堆叠式etcd集群的高可用拓扑"></p>
<h5 id="外部-etcd-集群的高可用拓扑"><a href="#外部-etcd-集群的高可用拓扑" class="headerlink" title="外部 etcd 集群的高可用拓扑"></a>外部 etcd 集群的高可用拓扑</h5><p>该拓扑将控制平面和 etcd 成员解耦。如果丢失一个 Master 节点，对 etcd 成员的影响较小，并且不会像堆叠式拓扑那样对集群冗余产生太大影响。但是，此拓扑所需的主机数量是堆叠式拓扑的两倍。具有此拓扑的群集至少需要三个主机用于控制平面节点，三个主机用于 etcd 集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/外部etcd集群的高可用拓扑.png" alt="外部etcd集群的高可用拓扑"></p>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="etcd-集群高可用"><a href="#etcd-集群高可用" class="headerlink" title="etcd 集群高可用"></a>etcd 集群高可用</h5><p>多少个 peer 最适合？</p>
<ul>
<li>1 个？ 3 个？ 5 个？</li>
<li>保证高可用是首要目标</li>
<li>所有写操作都要经过 leader</li>
<li>peer 多了是否能提升集群并读操作的并发能力？<ul>
<li>apiserver 的配置只连本地的 etcd peer</li>
<li>apiserver 的配置指定所有 etcd peers ，但只有当前连接的 etcd member 异常，apiserver 才会换目标</li>
</ul>
</li>
<li>需要动态 flex up 吗？</li>
</ul>
<p>保证 apiserver 和 etcd 之间的高效性通讯</p>
<ul>
<li>apiserver 和 etcd 部署在同一节点</li>
<li>apiserver 和 etcd 之间的通讯基于 gRPC<ul>
<li>针对每一个 object apiserver 和 etcd 之间的 Connection —&gt; stream 共享</li>
<li>http2 的特性<ul>
<li>Stream quota</li>
<li>带来的问题？对于大规模集群，会造成链路阻塞</li>
<li>10000 个 pod ，一次 list 操作需要返回的数据可能超过 100M</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="etcd-存储规划"><a href="#etcd-存储规划" class="headerlink" title="etcd 存储规划"></a>etcd 存储规划</h5><ul>
<li>本地 vs 远程？<ul>
<li>Remote Storage<ul>
<li>优势是假设永远可用，现实真是如此吗？</li>
<li>劣势是 IO 效率，可能带来的问题？</li>
</ul>
</li>
<li>最佳实践：<ul>
<li>Local SSD</li>
<li>利用 local volume 分配空间</li>
</ul>
</li>
</ul>
</li>
<li>多少空间？<ul>
<li>与集群规模相关</li>
</ul>
</li>
</ul>
<p>思考：为什么每个 member 的 DB size 不一致？</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd各个DB大小不同.png" alt="Etcd各个DB大小不同"></p>
<h5 id="etcd-2"><a href="#etcd-2" class="headerlink" title="etcd"></a>etcd</h5><p>安全性</p>
<ul>
<li>peer 和 peer 之间的通讯加密<ul>
<li>是否有需求<ul>
<li>TLS 的额外开销</li>
<li>运营复杂度增加</li>
</ul>
</li>
</ul>
</li>
<li>数据加密<ul>
<li>是否有需求</li>
<li>Kubernetes 提供了针对 secret 的加密 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</a></li>
</ul>
</li>
</ul>
<p>事件分离</p>
<ul>
<li>对于大规模集群，大量的事件会对 etcd 造成压力</li>
<li>API server 启动脚本中指定 etcd servers 集群</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ks <span class="token builtin class-name">exec</span> -it kube-apiserver-minikube -- kube-apiserver --help
  --etcd-servers-overrides strings
    Per-resource etcd servers overrides, comma separated. The individual override format: group/resource<span class="token comment">#servers, where servers are URLs, semicolon separated. Note that this applies only to resources compiled into this server binary.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如何监控</p>
<h5 id="减少网络延迟"><a href="#减少网络延迟" class="headerlink" title="减少网络延迟"></a>减少网络延迟</h5><ul>
<li>数据中心内的 RTT 大概是数毫秒，国内的典型 RTT 约为 50ms ，两大洲之间的 RTT 可能慢至 400ms 。因此建议 etcd 集群尽量同地域部署。</li>
<li>当客户端到 Leader 的并发连接数量过多，可能会导致其他 Follower 节点发往 Leader 的请求因为网络拥塞而被延迟处理。在 Follower 节点上，可能会看到这样的错误：<ul>
<li>dropped MsgProp to 247ae21ff9436b2d since streamMsg’s sending buffer is full</li>
</ul>
</li>
<li>可以在节点上通过流量控制工具（ Traffic Control ）提高 etcd 成员之间发送数据的优先级来避免。</li>
</ul>
<h5 id="减少磁盘-I-O-延迟"><a href="#减少磁盘-I-O-延迟" class="headerlink" title="减少磁盘 I/O 延迟"></a>减少磁盘 I/O 延迟</h5><p>对于磁盘延迟，典型的旋转磁盘写延迟约为 10 毫秒。对于 SSD Solid State Drives ，固态硬盘），延迟通常低于 1 毫秒。 HDD Hard Disk Drive ，硬盘驱动器）或者网盘在大量数据读写操作的情况下延时会不稳定。因此强烈建议使用 SSD 。</p>
<p>同时为了降低其他应用程序的 I/O 操作对 etcd 的干扰，建议将 etcd 的数据存放在单独的磁盘内。也可以将不同类型的对象存储在不同的若干个 etcd 集群中，比如将频繁变更的 event 对象从主 etcd 集群中分离出来，以保证主集群的高性能。在 APIServer 处这是可以通过参数配置的。这些 etcd 集群最好也分别能有一块单独的存储磁盘。</p>
<p>如果不可避免地， etcd 和其他的业务共享存储磁盘，那么就需要通过下面 ionice 命令对 etcd 服务设置更高的磁盘 I/O 优先级，尽可能避免其他进程的影响。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ionice -c2 -n0 -p <span class="token string">'pgrep etcd'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="保持合理的日志文件大小"><a href="#保持合理的日志文件大小" class="headerlink" title="保持合理的日志文件大小"></a>保持合理的日志文件大小</h5><p>etcd 以日志的形式保存数据，无论是数据创建还是修改，它都将操作追加到日志文件，因此日志文件大小会随着数据修改次数而线性增长。</p>
<p>当 Kubernetes 集群规模较大时，其对 etcd 集群中的数据更改也会很频繁，集群日记文件会迅速增长。</p>
<p>为了有效降低日志文件大小，etcd 会以固定周期创建快照保存系统的当前状态，并移除旧日志文件。另外当修改次数累积到一定的数量（默认是 10000 ，通过参数 “—snapshot-count” 指定）， etcd 也会创建快照文件。</p>
<p>如果 etcd 的内存使用和磁盘使用过高，可以先分析是否数据写入频度过大导致快照频度过高，确认后可通过调低快照触发的阈值来降低其对内存和磁盘的使用。</p>
<h5 id="设置合理的存储配额"><a href="#设置合理的存储配额" class="headerlink" title="设置合理的存储配额"></a>设置合理的存储配额</h5><p>存储空间的配额用于控制 etcd 数据空间的大小。合理的存储配额可保证集群操作的可靠性。如果没有存储配额，也就是 etcd 可以利用整个磁盘空间， etcd 的性能会因为存储空间的持续增长而严重下降，甚至有耗完集群磁盘空间导致不可预测集群行为的风险。如果设置的存储配额太小，一旦其中一个节点的后台数据库的存储空间超出了存储配额， etcd 就会触发集群范围的告警，并将集群置于只接受读和删除请求的维护模式。只有在释放足够的空间、消除后端数据库的碎片和清除存储配额告警之后，集群才能恢复正常操作。</p>
<h5 id="自动压缩历史版本"><a href="#自动压缩历史版本" class="headerlink" title="自动压缩历史版本"></a>自动压缩历史版本</h5><p>etcd 会为每个键都保存了历史版本。为了避免出现性能问题或存储空间消耗完导致写不进去的问题，这些历史版本需要进行周期性地压缩。压缩历史版本就是丢弃该键给定版本之前的所有信息，节省出来的空间可以用于后续的写操作。 etcd 支持自动压缩历史版本。在启动参数中指定参数 “—auto-compaction”，其值以小时为单位。也就是 etcd 会自动压缩该值设置的时间窗口之前的历史版本。</p>
<h5 id="定期消除碎片化"><a href="#定期消除碎片化" class="headerlink" title="定期消除碎片化"></a>定期消除碎片化</h5><p>压缩历史版本，相当于离散地抹去 etcd 存储空间某些数据， etcd 存储空间中将会出现碎片。这些碎片无法被后台存储使用，却仍占据节点的存储空间。因此定期消除存储碎片，将释放碎片化的存储空间，重新调整整个存储空间。</p>
<h5 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h5><ul>
<li>备份方案<ul>
<li>etcd 备份：备份完整的集群信息，灾难恢复<ul>
<li>etcdctl snapshot save</li>
</ul>
</li>
<li>备份 Kubernetes event</li>
</ul>
</li>
<li>频度？<ul>
<li>时间间隔太长：<ul>
<li>能否接受 user data lost</li>
<li>如果有外部资源配置，如负载均衡等，能否接受数据丢失导致的 leak</li>
</ul>
</li>
<li>时间间隔太短：<ul>
<li>对 etcd 的影响<ul>
<li>做 snapshot 的时候， etcd 会锁住当前数据</li>
<li>并发的写操作需要开辟新的空间进行增量写，导致磁盘空间增长</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>如何保证备份的时效性，同时防止磁盘爆掉？<ul>
<li>Auto defrag</li>
</ul>
</li>
</ul>
<h5 id="优化运行参数"><a href="#优化运行参数" class="headerlink" title="优化运行参数"></a>优化运行参数</h5><p>当网络延迟和磁盘延迟固定的情况下，可以优化 etcd 运行参数来提升集群的工作效率。 etcd 基于 Raft 协议进行 Leader 选举，当 Leader 选定以后才能开始数据读写操作，因此频繁的 Leader 选举会导致数据读写性能显著降低。可以通过调整心跳周期（ Heatbeat Interval ）和选举超时时间 Election Timeout ），来降低 Leader 选举的可能性。</p>
<p>心跳周期是控制 Leader 以何种频度向 Follower 发起心跳通知。心跳通知除表明 Leader 活跃状态之外，还带有待写入数据信息， Follower 依据心跳信息进行数据写入，默认心跳周期是 100ms 。选举超时时间定义了当 Follower 多久没有收到 Leader 心跳，则重新发起选举，该参数的默认设置是 1000ms 。</p>
<p>如果 etcd 集群的不同实例部署在延迟较低的相同数据中心，通常使用默认配置即可。如果不同实例部署在多数据中心或者网络延迟较高的集群环境，则需要对心跳周期和选举超时时间进行调整。建议心跳周期参数推荐设置为接近 etcd 多个成员之间平均数据往返周期的最大值，一般是平均 RTT 的 0.55 - 1.5 倍。如果心跳周期设置得过低， etcd 会发送很多不必要的心跳信息，从而增加 CPU 和网络的负担。如果设置得过高，则会导致选举频繁超时。选举超时时间也需要根据 etcd 成员之间的平均 RTT 时间来设置。选举超时时间最少设置为 etcd 成员之间 RTT 时间的 10 倍，以便对网络波动。</p>
<p>心跳间隔和选举超时时间的值必须对同一个 etcd 集群的所有节点都生效，如果各个节点配置不同，就会导致集群成员之间协商结果不可预知而不稳定。</p>
<h5 id="etcd-备份存储"><a href="#etcd-备份存储" class="headerlink" title="etcd 备份存储"></a>etcd 备份存储</h5><p>etcd 的默认工作目录下会生成两个子目录： wal 和 snap 。 wal 是用于存放预写式日志，其最大的作用是记录整个数据变化的全部历程。所有数据的修改在提交前，都要先写入 wal 中。</p>
<p>snap 是用于存放快照数据。为防止 wal 文件过多， etcd 会定期（当 wal 中数据超过 10000 条记录时，由参数 “—snapshot-count” 设置）创建快照。当快照生成后 wal 中数据就可以被删除了。</p>
<p>如果数据遭到破坏或错误修改需要回滚到之前某个状态时，方法就有两个：一是从快照中恢复数据主体，但是未被拍入快照的数据会丢失；而是执行所有 WAL 中记录的修改操作，从最原始的数据恢复到数据损坏之前的状态，但恢复的时间较长。</p>
<h5 id="备份方案实践"><a href="#备份方案实践" class="headerlink" title="备份方案实践"></a>备份方案实践</h5><p>官方推荐 etcd 集群的备份方式是定期创建快照。和 etcd 内部定期创建快照的目的不同，该备份方式依赖外部程序定期创建快照，并将快照上传到网络存储设备以实现 etcd 数据的冗余备份。上传到网络设备的数据，都应进行了加密。即使当所有 etcd 实例都丢失了数据，也能允许 etcd 集群从一个已知的良好状态的时间点在任一地方进行恢复。根据集群对 etcd 备份粒度的要求，可适当调节备份的周期。在生产环境中实测，拍摄快照通常会影响集群当时的性能，因此不建议频繁创建快照。但是备份周期太长，就可能导致大量数据的丢失。</p>
<p>这里可以使用增量备份的方式。如图所示，备份程序每 30 分钟触发一次快照的拍摄。紧接着它从快照结束的版本（ Revision ）开始，监听 etcd 集群的事件，并每 10 秒钟将事件保存到文件中，并将快照和事件文件上传到网络存储设备中。 30 分钟的快照周期对集群性能影响甚微。当大灾难来临时，也至多丢失 10 秒的数据。至于数据修复，首先把数据从网络存储设备中下载下来，然后从快照中恢复大块数据，并在此基础上依次应用存储的所有事件。这样就可以将集群数据恢复到灾难发生前。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Etcd备份方案实践.png" alt="Etcd备份方案实践"></p>
<h5 id="ResourceVersion"><a href="#ResourceVersion" class="headerlink" title="ResourceVersion"></a>ResourceVersion</h5><ul>
<li>单个对象的 resourceVersion<ul>
<li>对象的最后修改 resourceVersion</li>
</ul>
</li>
<li>List 对象的 resourceVersion<ul>
<li>生成 list response 时的 resourceVersion</li>
</ul>
</li>
<li>List 行为<ul>
<li>List 对象时，如果不加 resourceVersion ，意味着需要 Most Recent 数据，请求会击穿 APIServer 缓存，直接发送至 etcd</li>
</ul>
</li>
<li>APIServer 通过 Label 过滤对象查询时，过滤动作是在 APIServer 端， APIServer 需要向 etcd 发起全量查询请求</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ResourceVersion.png" alt="ResourceVersion"></p>
<h5 id="遭遇到的陷阱"><a href="#遭遇到的陷阱" class="headerlink" title="遭遇到的陷阱"></a>遭遇到的陷阱</h5><ul>
<li>频繁的 leader election</li>
<li>etcd 分裂</li>
<li>etcd 不响应</li>
<li>与 apiserver 之间的链路阻塞</li>
<li>磁盘暴涨</li>
</ul>
<h2 id="Kubernetes-控制平面组件-API-Server"><a href="#Kubernetes-控制平面组件-API-Server" class="headerlink" title="Kubernetes 控制平面组件 API Server"></a>Kubernetes 控制平面组件 API Server</h2><h3 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h3><p>kube-apiserver 是 Kubernetes 最重要的核心组件之一，主要提供以下的功能：</p>
<ul>
<li>提供集群管理的 REST API 接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的枢纽（其他模块通过 API Server 查询或修改数据，只有 API Server 才直接操作 etcd）</li>
</ul>
<h4 id="访问控制概览"><a href="#访问控制概览" class="headerlink" title="访问控制概览"></a>访问控制概览</h4><p>Kubernetes API的每个请求都会经过多阶段的访问控制之后才会被接受，这包括认证、授权以及准入控制（Admission Control）等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer访问控制概览.png" alt="APIServer访问控制概览"></p>
<h4 id="访问控制细节"><a href="#访问控制细节" class="headerlink" title="访问控制细节"></a>访问控制细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer访问控制细节.png" alt="APIServer访问控制细节"></p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>开启 TLS 时，所有的请求都需要首先认证。Kubernetes 支持多种认证机制，并支持同时开启多个认证插件（只要有一个认证通过即可）。如果认证成功，则用户的 username 会传入授权模块做进一步授权验证；而对于认证失败的请求则返回 HTTP 401。</p>
<h4 id="认证插件"><a href="#认证插件" class="headerlink" title="认证插件"></a>认证插件</h4><ul>
<li>X509证书<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module6/basic-auth/x509.MD">https://github.com/kibaamor/101/blob/master/module6/basic-auth/x509.MD</a></li>
<li>使用 X509 客户端证书只需要 API Server 启动时配置 <code>--client-ca-file=SOMEFILE</code>。在证书认证时，其 CN 域用作用户名，而组织机构域则用作 group 名。</li>
</ul>
</li>
<li>静态Token文件<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/basic-auth">https://github.com/kibaamor/101/tree/master/module6/basic-auth</a></li>
<li>使用静态 Token 文件认证只需要 API Server 启动时配置 <code>--token-auth-file=SOMEFILE</code>。</li>
<li>该文件为csv格式，每行至少包括三列 token,username,user id，<ul>
<li>token,user,uid,”group1,group2,group3”</li>
</ul>
</li>
</ul>
</li>
<li>引导Token<ul>
<li>为了支持平滑地启动引导新的集群，Kubernetes 包含了一种动态管理的持有者令牌类型， 称作启动引导令牌（Bootstrap Token）。</li>
<li>这些令牌以 Secret 的形式保存在 kube-system 名字空间中，可以被动态管理和创建。</li>
<li>控制器管理器包含的 TokenCleaner 控制器能够在启动引导令牌过期时将其删除。</li>
<li>在使用 kubeadm 部署 Kubernetes 时，可通过 kubeadm token list 命令查询。</li>
</ul>
</li>
<li>静态密码文件<ul>
<li>需要 API Server 启动时配置 <code>--basic-auth-file=SOMEFILE</code>，文件格式为 csv，每行至少三列 password, user, uid，后面是可选的 group 名<ul>
<li>password,user,uid,”group1,group2,group3”</li>
</ul>
</li>
</ul>
</li>
<li>ServiceAccount<ul>
<li>ServiceAccount 是 Kubernetes 自动生成的，并会自动挂载到容器的 <code>/run/secrets/kubernetes.io/serviceaccount</code> 目录中。</li>
</ul>
</li>
<li>OpenID<ul>
<li>OAuth 2.0的认证机制</li>
</ul>
</li>
<li>Webhook 令牌身份认证<ul>
<li>—authentication-token-webhook-config-file 指向一个配置文件，其中描述如何访问远程的Webhook 服务。</li>
<li>—authentication-token-webhook-cache-ttl 用来设定身份认证决定的缓存时间。默认时长为2 分钟。</li>
</ul>
</li>
<li>匿名请求<ul>
<li>如果使用 AlwaysAllow 以外的认证模式，则匿名请求默认开启，但可用 <code>--anonymous-auth=false</code> 禁止匿名请求。</li>
</ul>
</li>
</ul>
<h3 id="基于webhook的认证服务集成"><a href="#基于webhook的认证服务集成" class="headerlink" title="基于webhook的认证服务集成"></a>基于webhook的认证服务集成</h3><h4 id="构建符合Kubernetes规范的认证服务"><a href="#构建符合Kubernetes规范的认证服务" class="headerlink" title="构建符合Kubernetes规范的认证服务"></a>构建符合Kubernetes规范的认证服务</h4><p>需要依照 Kubernetes 规范，构建认证服务，用来认证 tokenreview request</p>
<p>构建认证服务需要满足如下Kubernetes的规范</p>
<p>URL： <a target="_blank" rel="noopener" href="https://authn.example.com/authenticate">https://authn.example.com/authenticate</a></p>
<p>Method： POST</p>
<p>Input:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
  <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"(BEARERTOKEN)"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Output:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"authenticated"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"janedoe@example.com"</span><span class="token punctuation">,</span>
      <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"42"</span><span class="token punctuation">,</span>
      <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"developers"</span><span class="token punctuation">,</span>
        <span class="token string">"qa"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="开发认证服务"><a href="#开发认证服务" class="headerlink" title="开发认证服务"></a>开发认证服务</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/authn-webhook">https://github.com/kibaamor/101/tree/master/module6/authn-webhook</a></p>
<p>解码认证请求</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">decoder <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token keyword">var</span> tr authentication<span class="token punctuation">.</span>TokenReview
err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Error]"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
    json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
        <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
            Authenticated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转发认证请求至认证服务器</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Check User</span>
ts <span class="token operator">:=</span> oauth2<span class="token punctuation">.</span><span class="token function">StaticTokenSource</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">{</span>AccessToken<span class="token punctuation">:</span> tr<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Token<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
tc <span class="token operator">:=</span> oauth2<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span>
client <span class="token operator">:=</span> github<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>tc<span class="token punctuation">)</span>
user<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"[Error]"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
    json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
        <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
            Authenticated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>认证结果返回给 API Server</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">)</span>
trs <span class="token operator">:=</span> authentication<span class="token punctuation">.</span>TokenReviewStatus<span class="token punctuation">{</span>
    Authenticated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    User<span class="token punctuation">:</span> authentication<span class="token punctuation">.</span>UserInfo<span class="token punctuation">{</span>
        Username<span class="token punctuation">:</span> <span class="token operator">*</span>user<span class="token punctuation">.</span>Login<span class="token punctuation">,</span>
        UID<span class="token punctuation">:</span>      <span class="token operator">*</span>user<span class="token punctuation">.</span>Login<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
    <span class="token string">"apiVersion"</span><span class="token punctuation">:</span> <span class="token string">"authentication.k8s.io/v1beta1"</span><span class="token punctuation">,</span>
    <span class="token string">"kind"</span><span class="token punctuation">:</span>       <span class="token string">"TokenReview"</span><span class="token punctuation">,</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span>     trs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置认证服务"><a href="#配置认证服务" class="headerlink" title="配置认证服务"></a>配置认证服务</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Config"</span><span class="token punctuation">,</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
  <span class="token property">"preferences"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"clusters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"github-authn"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"http://192.168.34.2:3000/authenticate"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"users"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"authn-apiserver"</span><span class="token punctuation">,</span>
      <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"secret"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"contexts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"webhook"</span><span class="token punctuation">,</span>
      <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"github-authn"</span><span class="token punctuation">,</span>
        <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"authn-apiserver"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"current-context"</span><span class="token operator">:</span> <span class="token string">"webhook"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置-apiserver"><a href="#配置-apiserver" class="headerlink" title="配置 apiserver"></a>配置 apiserver</h4><p>可以是任何认证系统</p>
<ul>
<li>但在用户认证完成后，生成代表用户身份的 token</li>
<li>该 token 通常是有失效时间的</li>
<li>用户获取该 token 以后以后，将token配置进 kubeconfig</li>
</ul>
<p>修改 apiserver 设置，开启认证服务，apiserver 保证将所有收到的请求中的 token 信息，发给认证服务进行验证</p>
<pre><code>- --authentication-token-webhook-config-file，该文件描述如何访问认证服务
- --authentication-token-webhook-cache-ttl，默认 2 分钟
</code></pre><p>配置文件需要mount进Pod</p>
<p>配置文件中的服务器地址需要指向 authService</p>
<h4 id="生产系统中遇到的陷阱"><a href="#生产系统中遇到的陷阱" class="headerlink" title="生产系统中遇到的陷阱"></a>生产系统中遇到的陷阱</h4><p>基于 Keystone 的认证插件导致 Keystone 故障且无法恢复</p>
<p>Keystone 是企业关键服务</p>
<p>Kubernetes 以 Keystone 作为认证插件</p>
<p>Keystone 在出现故障后会抛出 401 错误</p>
<p>Kubernetes 发现 401 错误后会尝试重新认证</p>
<p>大多数 controller 都有指数级 back off，重试间隔越来越慢</p>
<p>但 gophercloud 针对过期 token 会一直 retry</p>
<p>大量的 request 积压在 Keystone 导致服务无法恢复</p>
<p>Kubernetes 成为压死企业认证服务的最后一根稻草</p>
<p>解决方案？</p>
<ul>
<li>Circuit break</li>
<li>Rate limit</li>
</ul>
<h3 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h3><h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>授权主要是用于对集群资源的访问控制，通过检查请求包含的相关属性值，与相对应的访问策略相比较，API 请求必须满足某些策略才能被处理。跟认证类似，Kubernetes 也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；对于授权失败的请求则返回 HTTP 403。</p>
<p>Kubernetes 授权仅处理以下的请求属性：</p>
<ul>
<li>user, group, extra</li>
<li>API、请求方法（如 get、post、update、patch 和 delete）和请求路径（如 /api）</li>
<li>请求资源和子资源</li>
<li>Namespace</li>
<li>API Group</li>
</ul>
<p>目前，Kubernetes 支持以下授权插件：</p>
<ul>
<li>ABAC</li>
<li>RBAC</li>
<li>Webhook</li>
<li>Node</li>
</ul>
<h4 id="RBAC-vs-ABAC"><a href="#RBAC-vs-ABAC" class="headerlink" title="RBAC vs ABAC"></a>RBAC vs ABAC</h4><p>ABAC（Attribute Based Access Control）本来是不错的概念，但是在 Kubernetes 中的实现比较难于管理和理解，而且需要对 Master 所在节点的 SSH 和文件系统权限，要使得对授权的变更成功生效，还需要重新启动 API Server。</p>
<p>而 RBAC 的授权策略可以利用 kubectl 或者 Kubernetes API 直接进行配置。RBAC 可以授权给用户，让用户有权进行授权管理，这样就可以无需接触节点，直接进行授权管理。RBAC 在 Kubernetes 中被映射为 API 资源和操作。</p>
<h4 id="RBAC-老图"><a href="#RBAC-老图" class="headerlink" title="RBAC 老图"></a>RBAC 老图</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RBAC老图.png" alt="RBAC老图"></p>
<h4 id="RBAC-新解"><a href="#RBAC-新解" class="headerlink" title="RBAC 新解"></a>RBAC 新解</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RBAC新解.png" alt="RBAC新解"></p>
<h4 id="Role-与-ClusterRole"><a href="#Role-与-ClusterRole" class="headerlink" title="Role 与 ClusterRole"></a>Role 与 ClusterRole</h4><p>Role（角色）是一系列权限的集合，例如一个角色可以包含读取 Pod 的权限和列出 Pod 的权限。</p>
<p>Role 只能用来给某个特定 namespace 中的资源作鉴权，对多 namespace 和集群级的资源或者是非资源类的 API（如/healthz）使用 ClusterRole。</p>
<blockquote>
<p>sub resource 可以单独控制权限（比如健康检查只能更新 status，不能更新 spec）</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Role示例</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span> <span class="token comment"># "" indicates the core API group</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span><span class="token punctuation">---</span>

<span class="token comment"># ClusterRole示例</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token comment"># "namespace" omitted since ClusterRoles are not namespaced</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>binding</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># RoleBinding示例（引用ClusterRole）</span>
<span class="token comment"># This role binding allows "dave" to read secrets in the "development"</span>
namespace.
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> development <span class="token comment"># This only grants permissions within the "development" namespace.</span>
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dave
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/RoleBinding.png" alt="RoleBinding"></p>
<h4 id="账户／组的管理"><a href="#账户／组的管理" class="headerlink" title="账户／组的管理"></a>账户／组的管理</h4><p>角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。</p>
<p>它包含若干主体（用户、组或服务账户）的列表和对这些主体所获得的角色的引用。</p>
<p>组的概念：</p>
<ul>
<li>当与外部认证系统对接时，用户信息（UserInfo）可包含 Group 信息，授权可针对用户群组</li>
<li>当对 ServiceAccount 授权时，Group 代表某个 Namespace 下的所有 ServiceAccount</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/账户组的管理.png" alt="账户组的管理"></p>
<h4 id="针对群租授权"><a href="#针对群租授权" class="headerlink" title="针对群租授权"></a>针对群租授权</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets<span class="token punctuation">-</span>global
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> manager <span class="token comment"># 'name' 是区分大小写的</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io

<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>secrets<span class="token punctuation">-</span>global
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>serviceaccounts<span class="token punctuation">:</span>qa
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="规划系统角色"><a href="#规划系统角色" class="headerlink" title="规划系统角色"></a>规划系统角色</h4><p>User</p>
<ul>
<li>管理员<ul>
<li>所有资源的所有权限？？</li>
</ul>
</li>
<li>普通用户<ul>
<li>是否有该用户创建的 namespace 下的所有 object 的操作权限？</li>
<li>对其他用户的 namespace 资源是否可读，是否可写？</li>
</ul>
</li>
</ul>
<p>SystemAccount</p>
<ul>
<li>SystemAccount 是开发者（kubernetes developer 或者 domain developer）创建应用后，应用于 apiserver 通讯需要的身份</li>
<li>用户可以创建自定的 ServiceAccount，kubernetes 也为每个 namespace 创建 default ServiceAccount</li>
<li>Default ServiceAccount 通常需要给定权限以后才能对 apiserver 做写操作</li>
</ul>
<h4 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h4><p>在 cluster 创建时，创建自定义的 clusterrole，比如 namespace-creator</p>
<p>Namespace-creator role 定义用户可操作的对象和对应的读写操作。</p>
<p>创建自定义的 namespace admission controller</p>
<ul>
<li>当 namespace 创建请求被处理时，获取当前用户信息并 annotate 到 namespace</li>
</ul>
<p>创建 RBAC controller</p>
<ul>
<li>Watch namespace 的创建事件</li>
<li>获取当前 namespace 的创建者信息</li>
<li>在当前 namespace 创建 rolebinding 对象，并将 namespace-creator 角色和用户绑定</li>
</ul>
<h4 id="与权限相关的其他最佳实践"><a href="#与权限相关的其他最佳实践" class="headerlink" title="与权限相关的其他最佳实践"></a>与权限相关的其他最佳实践</h4><p>ClusterRole 是非 namespace 绑定的，针对整个集群生效</p>
<p>通常需要创建一个管理员角色，并且绑定给开发运营团队成员</p>
<p>ThirdPartyResource 和 CustomResourceDefinition 是全局资源，普通用户创建 ThirdPartyResource 以后，需要管理员授予相应权限后才能真正操作该对象</p>
<p>针对所有的角色管理，建议创建 spec，用源代码驱动</p>
<blockquote>
<p>虽然可以通过edit操作来修改权限，但后期会导致权限管理混乱，可能会有很多临时创建出来的角色和角色绑定对象，重复绑定某一个资源权限</p>
</blockquote>
<p>权限是可以传递的，用户 A 可以将其对某对象的某操作，抽取成一个权限，并赋给用户 B</p>
<p>防止海量的角色和角色绑定对象，因为大量的对象会导致鉴权效率低，同时给 apiserver 增加负担<br>ServiceAccount 也需要授权的，否则你的 component 可能无法操作某对象</p>
<p>Tips：SSH 到 master 节点通过 insecure port 访问 apiserver 可绕过鉴权，当需要做管理操作又没有权限时可以使用（不推荐）</p>
<h4 id="运营过程中出现的陷阱"><a href="#运营过程中出现的陷阱" class="headerlink" title="运营过程中出现的陷阱"></a>运营过程中出现的陷阱</h4><p>案例1:</p>
<ul>
<li>研发人员为提高系统效率，将 update 方法修改为 patch</li>
<li>研发人员本地非安全测试环境测试通过</li>
<li>上生产，发现不 work</li>
<li>原因：忘记更新 rolebinding，对应的 serviceaccount 没有 patch 权限</li>
</ul>
<p>案例2:</p>
<ul>
<li>研发人员创建 CRD，并针对该 CRD 编程</li>
<li>上生产后不工作</li>
<li>原因，该 CRD 未授权，对应的组件 get 不到对应的 CRD 资源</li>
</ul>
<h3 id="准入"><a href="#准入" class="headerlink" title="准入"></a>准入</h3><h4 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h4><p>为资源增加自定义属性</p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在 namespace 的准入控制中，获取用户信息，并将用户信息更新的 namespace 的 annotation</li>
</ul>
<p>只有当 namespace 中有有效用户信息时，我们才可以在 namespace 创建时，自动绑定用户权限，namespace 才可用。</p>
<p>准入控制（Admission Control）在授权后对请求做进一步的验证或添加默认参数。不同于授权和认证只关心请求的用户和操作，准入控制还处理请求的内容，并且仅对创建、更新、删除或连接（如代理）等有效，而对读操作无效。</p>
<p>准入控制支持同时开启多个插件，它们依次调用，只有全部插件都通过的请求才可以放过进入系统。</p>
<h4 id="准入控制插件"><a href="#准入控制插件" class="headerlink" title="准入控制插件"></a>准入控制插件</h4><ul>
<li>AlwaysAdmit: 接受所有请求。</li>
<li>AlwaysPullImages: 总是拉取最新镜像。在多租户场景下非常有用。</li>
<li>DenyEscalatingExec: 禁止特权容器的 exec 和 attach 操作。</li>
<li>ImagePolicyWebhook: 通过 webhook 决定 image 策略，需要同时配置 <code>--admission-controlconfig-file</code></li>
<li>ServiceAccount：自动创建默认 ServiceAccount，并确保 Pod 引用的 ServiceAccount 已经存在</li>
<li>SecurityContextDeny：拒绝包含非法 SecurityContext 配置的容器</li>
<li>ResourceQuota：限制 Pod 的请求不会超过配额，需要在 namespace 中创建一个 ResourceQuota 对象</li>
<li>LimitRanger：为 Pod 设置默认资源请求和限制，需要在 namespac 中创建一个 LimitRange 对象</li>
<li>InitialResources：根据镜像的历史使用记录，为容器设置默认资源请求和限制</li>
<li>NamespaceLifecycle：确保处于 termination 状态的 namespace 不再接收新的对象创建请求，并拒绝请求不存在的 namespace</li>
<li>DefaultStorageClass：为 PVC 设置默认 StorageClass</li>
<li>DefaultTolerationSeconds：设置 Pod 的默认 forgiveness toleration 为 5 分钟</li>
<li>PodSecurityPolicy：使用 Pod Security Policies 时必须开启</li>
<li>NodeRestriction：限制 kubelet 仅可访问 node、endpoint、pod、service 以及 secret、configmap、PV 和PVC 等相关的资源</li>
</ul>
<h4 id="准入控制插件的开发"><a href="#准入控制插件的开发" class="headerlink" title="准入控制插件的开发"></a>准入控制插件的开发</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module6/mutatingwebhook/readme.MD">https://github.com/kibaamor/101/blob/master/module6/mutatingwebhook/readme.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/admission-controller-webhook-demo">https://github.com/kibaamor/admission-controller-webhook-demo</a></p>
<h5 id="准入控制插件-1"><a href="#准入控制插件-1" class="headerlink" title="准入控制插件"></a>准入控制插件</h5><p>除默认的准入控制插件以外，Kubernetes 预留了准入控制插件的扩展点，用户可自定义准入控制插件实现自定义准入功能</p>
<ul>
<li>MutatingWebhookConfiguration：变形插件，支持对准入对象的修改</li>
<li>ValidatingWebhookConfiguration：校验插件，只能对准入对象合法性进行校验，不能修改</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/准入控制插件.png" alt="准入控制插件"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># {{if eq .k8snode_validating "enabled"}}</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> admissionregistration.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MutatingWebhookConfiguration
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>mutating.webhook.k8s.io
<span class="token key atrule">webhooks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">clientConfig</span><span class="token punctuation">:</span>
  <span class="token key atrule">caBundle</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>.serverca_base64<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//admission.local.tess.io/apis/admission.k8s.io/v1alpha1/ns<span class="token punctuation">-</span>mutating
  <span class="token key atrule">failurePolicy</span><span class="token punctuation">:</span> Fail
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ns<span class="token punctuation">-</span>mutating.webhook.k8s.io
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">""</span>
    <span class="token key atrule">apiVersions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'*'</span>
    <span class="token key atrule">operations</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> CREATE
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> nodes
  <span class="token key atrule">sideEffects</span><span class="token punctuation">:</span> Unknown
<span class="token comment"># {{end}}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配额管理"><a href="#配额管理" class="headerlink" title="配额管理"></a>配额管理</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module6/quota">https://github.com/kibaamor/101/tree/master/module6/quota</a></p>
<p>配额管理</p>
<ul>
<li>原因：资源有限，如何限定某个用户有多少资源？<br>方案：</li>
<li>预定义每个 Namespace 的 ResourceQuota，并把 spec 保存为 configmap<ul>
<li>用户可以创建多少个 Pod<ul>
<li>BestEffortPod</li>
<li>QoSPod</li>
</ul>
</li>
<li>用户可以创建多少个 service</li>
<li>用户可以创建多少个 ingress</li>
<li>用户可以创建多少个 service VIP</li>
</ul>
</li>
<li>创建 ResourceQuota Controller<ul>
<li>监控 namespace 创建事件，当 namespace 创建时，在该 namespace 创建对应的 ResourceQuota 对象</li>
</ul>
</li>
<li>apiserver 中开启 ResourceQuota 的 admission plugin</li>
</ul>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><h4 id="计数器固定窗口算法"><a href="#计数器固定窗口算法" class="headerlink" title="计数器固定窗口算法"></a>计数器固定窗口算法</h4><p>原理就是对一段固定时间窗口内的请求进行计数，如果请求数超过了阈值，则舍弃该请求；</p>
<p>如果没有达到设定的阈值，则接受该请求，且计数加 1 。</p>
<p>当时间窗口结束时，重置计数器为 0 。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/计数器固定窗口算法.png" alt="计数器固定窗口算法"></p>
<h4 id="计数器滑动窗口算法"><a href="#计数器滑动窗口算法" class="headerlink" title="计数器滑动窗口算法"></a>计数器滑动窗口算法</h4><p>在固定窗口的基础上，将一个计时窗口分成了若干个小窗口，然后每个小窗口维护一个独立的计数器。</p>
<p>当请求的时间大于当前窗口的最大时间时，则将计时窗口向前平移一个小窗口。</p>
<p>平移时，将第一个小窗口的数据丢弃，然后将第二个小窗口设置为第一个小窗口，同时在最后面新增一个小窗口，将新的请求放在新增的小窗口中。</p>
<p>同时要保证整个窗口中所有小窗口的请求数目之后不能超过设定的阈值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/计数器滑动窗口算法.png" alt="计数器滑动窗口算法"></p>
<h4 id="漏斗算法"><a href="#漏斗算法" class="headerlink" title="漏斗算法"></a>漏斗算法</h4><p>漏斗算法的原理也很容易理解。请求来了之后会首先进到漏斗里，然后漏斗以恒定的速率将请求流出进行处理，从而起到平滑流量的作用。</p>
<p>当请求的流量过大时，漏斗达到最大容量时会溢出，此时请求被丢弃。</p>
<p>在系统看来，请求永远是以平滑的传输速率过来，从而起到了保护系统的作用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/漏斗算法.png" alt="漏斗算法"></p>
<h4 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h4><p>令牌桶算法是对漏斗算法的一种改进，除了能够起到限流的作用外，还允许一定程度的流量突发。</p>
<p>在令牌桶算法中，存在一个令牌桶，算法中存在一种机制以恒定的速率向令牌桶中放入令牌。</p>
<p>令牌桶也有一定的容量，如果满了令牌就无法放进去了。<br>当请求来时，会首先到令牌桶中去拿令牌，如果拿到了令牌，则该请求会被处理，并消耗掉拿到的令牌；</p>
<p>如果令牌桶为空，则该请求会被丢弃。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/令牌桶算法.png" alt="令牌桶算法"></p>
<h4 id="API-Server-中的限流"><a href="#API-Server-中的限流" class="headerlink" title="API Server 中的限流"></a>API Server 中的限流</h4><p>max-requests-inflight： 在给定时间内的最大 non-mutating 请求数<br>max-mutating-requests-inflight： 在给定时间内的最大 mutating 请求数，调整 apiserver 的流控 qos</p>
<p>代码 <code>staging/src/k8s.io/apiserver/pkg/server/filters/maxinflight.go:WithMaxInFlightLimit()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIServer中的限流.png" alt="APIServer中的限流"></p>
<h4 id="传统限流方法的局限性"><a href="#传统限流方法的局限性" class="headerlink" title="传统限流方法的局限性"></a>传统限流方法的局限性</h4><ul>
<li>粒度粗<ul>
<li>无法为不同用户，不同场景设置不通的限流</li>
</ul>
</li>
<li>单队列<ul>
<li>共享限流窗口/桶，一个坏用户可能会将整个系统堵塞，其他正常用户的请求无法被及时处理</li>
</ul>
</li>
<li>不公平<ul>
<li>正常用户的请求会被排到队尾，无法及时处理而饿死</li>
</ul>
</li>
<li>无优先级<ul>
<li>重要的系统指令一并被限流，系统故障难以恢复</li>
</ul>
</li>
</ul>
<h4 id="API-Priority-and-Fairness"><a href="#API-Priority-and-Fairness" class="headerlink" title="API Priority and Fairness"></a>API Priority and Fairness</h4><p>APF 以更细粒度的方式对请求进行分类和隔离。</p>
<ul>
<li>它还引入了空间有限的排队机制，因此在非常短暂的突发情况下，API 服务器不会拒绝任何请求。</li>
<li>通过使用公平排队技术从队列中分发请求，这样， 一个行为不佳的控制器就不会饿死其他控制器（即使优先级相同）。</li>
<li><p>APF的核心</p>
<ul>
<li>多等级</li>
<li>多队列</li>
</ul>
</li>
<li><p>APF 的实现依赖两个非常重要的资源 FlowSchema, PriorityLevelConfiguration</p>
</li>
<li>APF 对请求进行更细粒度的分类，每一个请求分类对应一个 FlowSchema (FS)</li>
<li>FS 内的请求又会根据 distinguisher 进一步划分为不同的 Flow.</li>
<li>FS 会设置一个优先级(Priority Level, PL)，不同优先级的并发资源是隔离的。所以不同优先级的资源不会相互排挤。特定优先级的请求可以被高优处理。</li>
<li>一个 PL 可以对应多个 FS，PL 中维护了一个 QueueSet，用于缓存不能及时处理的请求，请求不会因为超出 PL 的并发限制而被丢弃。</li>
<li>FS 中的每个 Flow 通过 shuffle sharding 算法从 QueueSet 选取特定的 queues 缓存请求。</li>
<li>每次从 QueueSet 中取请求执行时，会先应用 fair queuing 算法从 QueueSet 中选中一个 queue，然后从这个 queue 中取出 oldest 请求执行。所以即使是同一个 PL 内的请求，也不会出现一个 Flow 内的请求一直占用资源的不公平现象。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/APIPriorityAndFairness.png" alt="APIPriorityAndFairness"></p>
<h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><ul>
<li>传入的请求通过FlowSchema 按照其属性分类，并分配优先级。</li>
<li>每个优先级维护自定义的并发限制，加强了隔离度，这样不同优先级的请求，就不会相互饿死。</li>
<li>在同一个优先级内，公平排队算法可以防止来自不同flow 的请求相互饿死。</li>
<li>该算法将请求排队，通过排队机制，防止在平均负载较低时，通信量突增而导致请求失败。</li>
</ul>
<h5 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h5><ul>
<li>如果未启用 APF，API 服务器中的整体并发量将受到 kube-apiserver 的参数 <code>--maxrequests-inflight</code> 和 <code>--max-mutating-requests-inflight</code> 的限制。</li>
<li>启用 APF 后，将对这些参数定义的并发限制进行求和，然后将总和分配到一组可配置的优先级中。每个传入的请求都会分配一个优先级；</li>
<li>每个优先级都有各自的配置，设定允许分发的并发请求数。</li>
<li>例如，默认配置包括针对领导者选举请求、内置控制器请求和 Pod 请求都单独设置优先级。这表示即使异常的 Pod 向 API 服务器发送大量请求，也无法阻止领导者选举或内置控制器的操作执行成功。</li>
</ul>
<h5 id="排队"><a href="#排队" class="headerlink" title="排队"></a>排队</h5><ul>
<li>即使在同一优先级内，也可能存在大量不同的流量源。</li>
<li>在过载情况下，防止一个请求流饿死其他流是非常有价值的（尤其是在一个较为常见的场景中，一个有故障的客户端会疯狂地向 kube-apiserver 发送请求， 理想情况下，这个有故障的客户端不应对其他客户端产生太大的影响）。</li>
<li>公平排队算法在处理具有相同优先级的请求时，实现了上述场景。</li>
<li>每个请求都被分配到某个流中，该流由对应的 FlowSchema 的名字加上一个流区分项（Flow Distinguisher）来标识。</li>
<li>这里的流区分项可以是发出请求的用户、目标资源的名称空间或什么都不是。</li>
<li>系统尝试为不同流中具有相同优先级的请求赋予近似相等的权重。</li>
<li>将请求划分到流中之后，APF 功能将请求分配到队列中。</li>
<li>分配时使用一种称为混洗分片（Shuffle-Sharding） 的技术。该技术可以相对有效地利用队列隔离低强度流与高强度流。</li>
<li>排队算法的细节可针对每个优先等级进行调整，并允许管理员在内存占用、公平性（当总流量超标时，各个独立的流将都会取得进展）、突发流量的容忍度以及排队引发的额外延迟之间进行权衡。</li>
</ul>
<h5 id="豁免请求"><a href="#豁免请求" class="headerlink" title="豁免请求"></a>豁免请求</h5><p>某些特别重要的请求不受制于此特性施加的任何限制。这些豁免可防止不当的流控配置完全禁用 API 服务器。</p>
<h5 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h5><ul>
<li>system<ul>
<li>用于 system:nodes 组（即 kubelets）的请求； kubelets 必须能连上API 服务器，以便工作负载能够调度到其上。</li>
</ul>
</li>
<li>leader-election<ul>
<li>用于内置控制器的领导选举的请求（特别是来自 kube-system 名称空间中 system:kubecontroller-manager 和 system:kube-scheduler 用户和服务账号，针对 endpoints、configmaps 或leases 的请求）。</li>
<li>将这些请求与其他流量相隔离非常重要，因为领导者选举失败会导致控制器发生故障并重新启动，这反过来会导致新启动的控制器在同步信息时，流量开销更大。</li>
</ul>
</li>
<li>workload-high<ul>
<li>优先级用于内置控制器的请求。</li>
</ul>
</li>
<li>workload-low<ul>
<li>优先级适用于来自任何服务帐户的请求，通常包括来自Pods 中运行的控制器的所有请求。</li>
</ul>
</li>
<li>global-default<ul>
<li>优先级可处理所有其他流量，例如：非特权用户运行的交互式 kubectl 命令。</li>
</ul>
</li>
<li>exempt<ul>
<li>优先级的请求完全不受流控限制：它们总是立刻被分发。特殊的 exempt FlowSchema 把 system:masters 组的所有请求都归入该优先级组。</li>
</ul>
</li>
<li>catch-all<ul>
<li>优先级与特殊的 catch-all FlowSchema 结合使用，以确保每个请求都分类。</li>
<li>一般不应该依赖于 catch-all 的配置，而应适当地创建自己的 catch-all FlowSchema 和 PriorityLevelConfigurations（或使用默认安装的 global-default 配置）。</li>
<li>为了帮助捕获部分请求未分类的配置错误，强制要求 catch-all 优先级仅允许5个并发份额，并且不对请求进行排队，使得仅与 catch-all FlowSchema 匹配的流量被拒绝的可能性更高，并显示 HTTP 429 错误。</li>
</ul>
</li>
</ul>
<h5 id="PriorityLevelConfiguration"><a href="#PriorityLevelConfiguration" class="headerlink" title="PriorityLevelConfiguration"></a>PriorityLevelConfiguration</h5><p>一个 PriorityLevelConfiguration 表示单个隔离类型。</p>
<p>每个 PriorityLevelConfigurations 对未完成的请求数有各自的限制，对排队中的请求数也有限制。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PriorityLevelConfiguration.png" alt="PriorityLevelConfiguration"></p>
<h5 id="FlowSchema"><a href="#FlowSchema" class="headerlink" title="FlowSchema"></a>FlowSchema</h5><p>FlowSchema 匹配一些入站请求，并将它们分配给优先级。</p>
<p>每个入站请求都会对所有 FlowSchema 测试是否匹配， 首先从 matchingPrecedence 数值最低的匹配开始（我们认为这是逻辑上匹配度最高）， 然后依次进行，直到首个匹配出现</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlowSchema.png" alt="FlowSchema"></p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><ul>
<li>/debug/api_priority_and_fairness/dump_priority_levels —— 所有优先级及其当前状态的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_priority_levels</code></li>
<li>/debug/api_priority_and_fairness/dump_queues —— 所有队列及其当前状态的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_queues</code></li>
<li>/debug/api_priority_and_fairness/dump_requests ——当前正在队列中等待的所有请求的列表。<code>kubectl get --raw /debug/api_priority_and_fairness/dump_requests</code></li>
</ul>
<h3 id="高可用-API-Server"><a href="#高可用-API-Server" class="headerlink" title="高可用 API Server"></a>高可用 API Server</h3><h4 id="构建高可用的多副本apiserver"><a href="#构建高可用的多副本apiserver" class="headerlink" title="构建高可用的多副本apiserver"></a>构建高可用的多副本apiserver</h4><p>apiserver 是无状态的 Rest Server</p>
<p>无状态所以方便 Scale Up／down</p>
<p>负载均衡</p>
<ul>
<li>在多个 apiserver 实例之上，配置负载均衡</li>
<li>证书可能需要加上 Loadbalancer VIP 重新生成</li>
</ul>
<h4 id="预留充足的-CPU、内存资源"><a href="#预留充足的-CPU、内存资源" class="headerlink" title="预留充足的 CPU、内存资源"></a>预留充足的 CPU、内存资源</h4><p>随着集群中节点数量不断增多，APIServer 对 CPU 和内存的开销也不断增大。过少的 CPU 资源会降低其处理效率，过少的内存资源会导致 Pod 被 OOMKilled，直接导致服务不可用。在规划 APIServer 资源时，不能仅看当下需求，也要为未来预留充分。</p>
<h4 id="善用速率限制（RateLimit）"><a href="#善用速率限制（RateLimit）" class="headerlink" title="善用速率限制（RateLimit）"></a>善用速率限制（RateLimit）</h4><p>APIServer 的参数 <code>--max-requests-inflight</code> 和 <code>--max-mutating-requests-inflight</code> 支持在给定时间内限制并行处理读请求（包括 Get、List 和 Watch 操作）和写请求（包括 Create、Delete、Update 和 Patch 操作）的最大数量。当 APIServer 接收到的请求超过这两个参数设定的值时，再接收到的请求将会被直接拒绝。通过速率限制机制，可以有效地控 APIServer 内存的使用。如果该值配置过低，会经常出现请求超过限制的错误，如果配置过高，则 APIServer 可能会因为占用过多内存而被强制终止，因此需要根据实际的运行环境，结合实时用户请求数量和 APIServer 的资源配置进行调优。</p>
<p>客户端在接收到拒绝请求的返回值后，应等待一段时间再发起重试，无间隔的重试会加重 APIServer 的压力，导致性能进一步降低。针对并行处理请求数的过滤颗粒度太大，在请求数量比较多的场景，重要的消息可能会被拒绝掉，自 1.18 版本开始，社区引入了优先级和公平保证（Priority and Fairness）功能，以提供更细粒度地客户端请求控制。该功能支持将不同用户或不同类型的请求进行优先级归类，保证高优先级的请求总是能够更快得到处理，从而不受低优先级请求的影响。</p>
<h4 id="设置合适的缓存大小"><a href="#设置合适的缓存大小" class="headerlink" title="设置合适的缓存大小"></a>设置合适的缓存大小</h4><p>APIServer 与 etcd 之间基于 gRPC 协议进行通信，gRPC 协议保证了二者在大规模集群中的数据高速传输。gRPC 基于连接复用的 HTTP/2 协议，即针对相同分组的对象，APIServer 和 etcd 之间共享相同的 TCP 连接，不同请求由不同的 stream 传输。</p>
<p>一个 HTTP/2 连接有其 stream 配额，配额的大小限制了能支持的并发请求。APIServer 提供了集群对象的缓存机制，当客户端发起查询请求时，APIServer 默认会将其缓存直接返回给客户端。缓存区大小可以通过参数 <code>--watch-cache-sizes</code> 设置。针对访问请求比较多的对象，适当设置缓存的大小，极大降低对 etcd 的访问频率，节省了网络调用，降低了对 etcd 集群的读写压力，从而提高对象访问的性能。</p>
<p>但是 APIServer 也是允许客户端忽略缓存的，例如客户端请求中 ListOption 中没有设置 resourceVersion，这时 APIServer 直接从 etcd 拉取最新数据返回给客户端。客户端应尽量避免此操作，应在 ListOption 中设置 resourceVersion 为 0，APIServer 则将从缓存里面读取数据，而不会直接访问 etcd。</p>
<h4 id="客户端尽量使用长连接"><a href="#客户端尽量使用长连接" class="headerlink" title="客户端尽量使用长连接"></a>客户端尽量使用长连接</h4><p>当查询请求的返回数据较大且此类请求并发量较大时，容易引发 TCP 链路的阻塞，导致其他查询操作超时。因此基于 Kubernetes 开发组件时，例如某些 DaemonSet 和 Controller，如果要查询某类对象，应尽量通过长连接 ListWatch 监听对象变更，避免全量从 APIServer 获取资源。如果在同一应用程序中，如果有多个 Informer 监听 APIServer 资源变化，可以将这些Informer 合并，减少和 APIServer 的长连接数，从而降低对 APIServer 的压力。</p>
<h4 id="如何访问-APIServer"><a href="#如何访问-APIServer" class="headerlink" title="如何访问 APIServer"></a>如何访问 APIServer</h4><p>对外部客户（user/client/admin)，永远只通过 LoadBalancer 访问</p>
<p>只有当负载均衡出现故障时，管理员才切换到 apiserver IP 进行管理</p>
<p>内部客户端，优先访问 cluster IP？（是否一定如此？）</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何访问APIServer.png" alt="如何访问APIServer"></p>
<h4 id="搭建多租户的-Kubernetes-集群"><a href="#搭建多租户的-Kubernetes-集群" class="headerlink" title="搭建多租户的 Kubernetes 集群"></a>搭建多租户的 Kubernetes 集群</h4><p>授信</p>
<ul>
<li>认证：<ul>
<li>禁止匿名访问，只允许可信用户做操作。</li>
</ul>
</li>
<li>授权：<ul>
<li>基于授信的操作，防止多用户之间互相影响，比如普通用户删除 Kubernetes 核心服务，或者 A 用户删除或修改 B 用户的应用。</li>
</ul>
</li>
</ul>
<p>隔离</p>
<ul>
<li>可见行隔离：<ul>
<li>用户只关心自己的应用，无需看到其他用户的服务和部署。</li>
</ul>
</li>
<li>资源隔离：<ul>
<li>有些关键项目对资源需求较高，需要专有设备，不与其他人共享。</li>
</ul>
</li>
<li>应用访问隔离：<ul>
<li>用户创建的服务，按既定规则允许其他用户访问。</li>
</ul>
</li>
</ul>
<p>资源管理</p>
<ul>
<li>Quota 管理<ul>
<li>谁能用多少资源？</li>
</ul>
</li>
</ul>
<h5 id="认证-1"><a href="#认证-1" class="headerlink" title="认证"></a>认证</h5><p>与企业现有认证系统集成</p>
<ul>
<li>很多企业基于 Microsoft Active Directory 提供认证服务</li>
</ul>
<p>选择认证插件</p>
<ul>
<li>选择 webhook 作为认证插件（*以此为例展开）</li>
<li>也可以选择 Keystone 作为认证插件，以 Microsoft Ad 作为 backend 搭建 keystone 服务</li>
</ul>
<p>一旦认证完成，Kubernetes 即可获取当前用户信息（主要是用户名），并针对该用户做授权。授权和准入控制完成后，该用户的请求完成。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get apiservices v1. -oyaml
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  creationTimestamp: <span class="token string">"2024-05-02T13:50:21Z"</span>
  labels:
    kube-aggregator.kubernetes.io/automanaged: onstart
  name: v1.
  resourceVersion: <span class="token string">"5"</span>
  uid: 0510b743-30fc-4aab-96b9-cd9cc6d309d2
spec:
  groupPriorityMinimum: <span class="token number">18000</span>
  version: v1
  versionPriority: <span class="token number">1</span>
status:
  conditions:
  - lastTransitionTime: <span class="token string">"2024-05-02T13:50:21Z"</span>
    message: Local APIServices are always available
    reason: Local
    status: <span class="token string">"True"</span>
    type: Available<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h5><p>ABAC 有期局限性，针对每个 account 都需要做配置，并且需要重启 apiserver</p>
<p>RBAC 更灵活，更符合我们通常熟知的权限管理</p>
<h3 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a>apimachinery</h3><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/apimachinery">https://github.com/kubernetes/apimachinery</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/apimachinery">https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/apimachinery</a></p>
<p>包含了 kubernetes 核心 API 对象的定义。</p>
<h4 id="回顾-GKV"><a href="#回顾-GKV" class="headerlink" title="回顾 GKV"></a>回顾 GKV</h4><p>Group</p>
<p>Kind</p>
<p>Version</p>
<ul>
<li>Internel version 和 External version（还有一个 storage version）<ul>
<li>External version：面向用户。版本演进时，照顾版本的兼容性。（kubernetes 只承诺向前兼容 3 个版本）<ul>
<li><code>staging/src/k8s.io/api/core/v1/types.go</code> 中就是 core group 的 External version 的定义 </li>
</ul>
</li>
<li>Internal version：API Service 在存数据时会把数据先转成 Internal version<ul>
<li><code>pkg/apis/core/types.go</code> 中就是 core group 的 Internal version 的定义</li>
</ul>
</li>
<li>对比 External version 和 Internal version 的定义<ul>
<li>External version 的定义会有 json/patchStrategy/patchMergeKey/protobuf tag</li>
</ul>
</li>
</ul>
</li>
<li>版本转换</li>
</ul>
<h4 id="如何定义-Group"><a href="#如何定义-Group" class="headerlink" title="如何定义 Group"></a>如何定义 Group</h4><p><code>pkg/apis/core/register.go</code></p>
<p>定义 group</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> GroupName <span class="token operator">=</span> <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>定义 groupversion</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>APIVersionInternal<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>定义 SchemeBuilder</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
    SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
    AddToScheme <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>将对象加入SchemeBuild</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> scheme<span class="token punctuation">.</span><span class="token function">AddIgnoredConversionType</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>TypeMeta<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>TypeMeta<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>SchemeGroupVersion<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Pod<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>PodList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="定义对象类型-types-go"><a href="#定义对象类型-types-go" class="headerlink" title="定义对象类型 types.go"></a>定义对象类型 types.go</h4><p>List</p>
<p>单一对象数据结构</p>
<ul>
<li>TypeMeta</li>
<li>ObjectMeta</li>
<li>Spec</li>
<li>Status</li>
</ul>
<h4 id="代码生成-Tags"><a href="#代码生成-Tags" class="headerlink" title="代码生成 Tags"></a>代码生成 Tags</h4><h5 id="Global-Tags"><a href="#Global-Tags" class="headerlink" title="Global Tags"></a>Global Tags</h5><p>定义在 doc.go 中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// +k8s:deepcopy-gen=package</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="Local-Tags"><a href="#Local-Tags" class="headerlink" title="Local Tags"></a>Local Tags</h5><p>定义在 types.go 中的每个对象里</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="token comment">// +genclient</span>
<span class="token comment">// +genclient:nonNamespaced</span>
<span class="token comment">// +genclient:noVerbs</span>
<span class="token comment">// +genclient:onlyVerbs=create,delete</span>
<span class="token comment">// +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch</span>
<span class="token comment">// +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="实现-etcd-storage"><a href="#实现-etcd-storage" class="headerlink" title="实现 etcd storage"></a>实现 etcd storage</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/configmap/storage/storage.go</span>

<span class="token comment">// NewREST returns a RESTStorage object that will work with ConfigMap objects.</span>
<span class="token keyword">func</span> <span class="token function">NewREST</span><span class="token punctuation">(</span>optsGetter generic<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>REST<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store <span class="token operator">:=</span> <span class="token operator">&amp;</span>genericregistry<span class="token punctuation">.</span>Store<span class="token punctuation">{</span>
        NewFunc<span class="token punctuation">:</span>                   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        NewListFunc<span class="token punctuation">:</span>               <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> runtime<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>ConfigMapList<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        PredicateFunc<span class="token punctuation">:</span>             configmap<span class="token punctuation">.</span>Matcher<span class="token punctuation">,</span>
        DefaultQualifiedResource<span class="token punctuation">:</span>  api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"configmaps"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SingularQualifiedResource<span class="token punctuation">:</span> api<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"configmap"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        CreateStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        UpdateStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
        DeleteStrategy<span class="token punctuation">:</span> configmap<span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>

        TableConvertor<span class="token punctuation">:</span> printerstorage<span class="token punctuation">.</span>TableConvertor<span class="token punctuation">{</span>TableGenerator<span class="token punctuation">:</span> printers<span class="token punctuation">.</span><span class="token function">NewTableGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>printersinternal<span class="token punctuation">.</span>AddHandlers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">:=</span> <span class="token operator">&amp;</span>generic<span class="token punctuation">.</span>StoreOptions<span class="token punctuation">{</span>
        RESTOptions<span class="token punctuation">:</span> optsGetter<span class="token punctuation">,</span>
        AttrFunc<span class="token punctuation">:</span>    configmap<span class="token punctuation">.</span>GetAttrs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>REST<span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="创建和更新对象时的业务逻辑-Strategy"><a href="#创建和更新对象时的业务逻辑-Strategy" class="headerlink" title="创建和更新对象时的业务逻辑 - Strategy"></a>创建和更新对象时的业务逻辑 - Strategy</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/configmap/strategy.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">PrepareForCreate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    configMap <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    <span class="token function">dropDisabledFields</span><span class="token punctuation">(</span>configMap<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">Validate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> field<span class="token punctuation">.</span>ErrorList <span class="token punctuation">{</span>
    cfg <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>

    <span class="token keyword">return</span> validation<span class="token punctuation">.</span><span class="token function">ValidateConfigMap</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">PrepareForUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> newObj<span class="token punctuation">,</span> oldObj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldConfigMap <span class="token operator">:=</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    newConfigMap <span class="token operator">:=</span> newObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>
    <span class="token function">dropDisabledFields</span><span class="token punctuation">(</span>newConfigMap<span class="token punctuation">,</span> oldConfigMap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token function">ValidateUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> newObj<span class="token punctuation">,</span> oldObj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> field<span class="token punctuation">.</span>ErrorList <span class="token punctuation">{</span>
    oldCfg<span class="token punctuation">,</span> newCfg <span class="token operator">:=</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span><span class="token punctuation">,</span> newObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>ConfigMap<span class="token punctuation">)</span>

    <span class="token keyword">return</span> validation<span class="token punctuation">.</span><span class="token function">ValidateConfigMapUpdate</span><span class="token punctuation">(</span>newCfg<span class="token punctuation">,</span> oldCfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="subresource"><a href="#subresource" class="headerlink" title="subresource"></a>subresource</h4><p>什么是 subresource，内嵌在 kubernetes 对象中，有独立的操作逻辑的属性集合，如 podstatus</p>
<p>subresource 可以单独的 listandwatch</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pkg/registry/core/pod/strategy.go</span>

statusStore<span class="token punctuation">.</span>UpdateStrategy <span class="token operator">=</span> pod<span class="token punctuation">.</span>StatusStrategy

<span class="token keyword">var</span> StatusStrategy <span class="token operator">=</span> podStatusStrategy<span class="token punctuation">{</span>Strategy<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>podStatusStrategy<span class="token punctuation">)</span> <span class="token function">PrepareForUpdate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> old runtime<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    newPod <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    oldPod <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    newPod<span class="token punctuation">.</span>Spec <span class="token operator">=</span> oldPod<span class="token punctuation">.</span>Spec
    newPod<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">=</span> <span class="token boolean">nil</span>

    <span class="token comment">// don't allow the pods/status endpoint to touch owner references since old kubelets corrupt them in a way</span>
    <span class="token comment">// that breaks garbage collection</span>
    newPod<span class="token punctuation">.</span>OwnerReferences <span class="token operator">=</span> oldPod<span class="token punctuation">.</span>OwnerReferences
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="注册-APIGroup"><a href="#注册-APIGroup" class="headerlink" title="注册 APIGroup"></a>注册 APIGroup</h4><p>定义 Storage</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">configMapStorage <span class="token operator">:=</span> configmapstore<span class="token punctuation">.</span><span class="token function">NewREST</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">)</span>

restStorageMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span>
    <span class="token string">"configMaps"</span><span class="token punctuation">:</span> configMapStorage<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义对象的 StorageMap</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span><span class="token string">"v1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> restStorageMap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将对象注册至 APIServer（挂载handler）</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallLegacyAPIGroup</span><span class="token punctuation">(</span>genericapiserver<span class="token punctuation">.</span>DefaultLegacyAPIPrefix<span class="token punctuation">,</span> <span class="token operator">&amp;</span>apiGroupInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Error in registering group versions: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/code-generator">https://github.com/kubernetes/code-generator</a></p>
<p>deepcopy-gen</p>
<ul>
<li>为对象生成 DeepCopy 方法，用于创建对象副本</li>
</ul>
<p>client-gen</p>
<ul>
<li>创建 Clientset，用于操作对象的 CRUD</li>
</ul>
<p>informer-gen</p>
<ul>
<li>为对象创建 Informer 框架，用于监听对象变化</li>
</ul>
<p>lister-gen</p>
<ul>
<li>为对象构建 Lister 框架，用于为 Get 和 List 操作，构建客户端缓存</li>
</ul>
<p>coversion-gen</p>
<ul>
<li>为对象构建 Conversion 方法，用于内外版本转换以及不同版本号的转换</li>
</ul>
<h4 id="hack-update-codegen-sh"><a href="#hack-update-codegen-sh" class="headerlink" title="hack/update-codegen.sh"></a>hack/update-codegen.sh</h4><p>依赖</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">BUILD_TARGETS<span class="token operator">=</span><span class="token punctuation">(</span>
  vendor/k8s.io/code-generator/cmd/client-gen
  vendor/k8s.io/code-generator/cmd/lister-gen
  vendor/k8s.io/code-generator/cmd/informer-gen
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成命令</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token variable">$</span><span class="token punctuation">{</span>GOPATH<span class="token punctuation">}</span>/bin/deepcopy-gen --input-dirs <span class="token punctuation">{</span>versioned-package-pach<span class="token punctuation">}</span>
  -O zz_generated.deepcopy \
  --bounding-dirs <span class="token punctuation">{</span>output-package-path<span class="token punctuation">}</span> \
  --go-header-file <span class="token variable">$</span><span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>/hack/boilerplate.go.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="APIServer-代码走读"><a href="#APIServer-代码走读" class="headerlink" title="APIServer 代码走读"></a>APIServer 代码走读</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kube-apiserver-10d5695cbbb14387b60c6d622005583d">https://cncamp.notion.site/kube-apiserver-10d5695cbbb14387b60c6d622005583d</a></p>
<blockquote>
<p>建议先读 controller 的源码，比如 deployment controller 的源码</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">cmd<span class="token operator">/</span>kube<span class="token operator">-</span>apiserver<span class="token operator">/</span>app<span class="token operator">/</span>server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">NewAPIServerCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
completedOptions<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>WatchCacheSizes<span class="token punctuation">,</span> err <span class="token operator">=</span> serveroptions<span class="token punctuation">.</span><span class="token function">WriteWatchCacheSizes</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span>
<span class="token function">Run</span><span class="token punctuation">(</span>completedOptions<span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">CreateServerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        CreateKubeAPIServerConfig<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span> proxyTransport<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                genericapiserver<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">)</span> <span class="token comment">// create codec factory for encoding/decoding</span>
                controlplane<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// group version: enabled/disabled</span>
                storageFactoryConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">)</span>
                completedStorageFactoryConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// register access path in etcd for all k8s objects</span>
                    storageFactory<span class="token punctuation">.</span><span class="token function">AddCohabitatingResources</span><span class="token punctuation">(</span>networking<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"networkpolicies"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extensions<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"networkpolicies"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">ApplyWithStorageFactoryTo</span><span class="token punctuation">(</span>storageFactory<span class="token punctuation">,</span> genericConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    c<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    c<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token operator">&amp;</span>StorageFactoryRestOptionsFactory<span class="token punctuation">{</span>Options<span class="token punctuation">:</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> StorageFactory<span class="token punctuation">:</span> factory<span class="token punctuation">}</span>
<span class="token comment">// 认证</span>
                s<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// clientcert, serviceaccount, bootstrap token, </span>
                    authenticatorConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        <span class="token function">newWebhookTokenAuthenticator</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token comment">// webhook</span>
<span class="token comment">// 鉴权</span>
                <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    authorizationConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        rbacAuthorizer <span class="token operator">:=</span> rbac<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// if authorizer type is rbac</span>
<span class="token comment">// 准入</span>
                <span class="token function">buildServiceResolver</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>
                admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">{</span>webhookPluginInitializer<span class="token punctuation">,</span> kubePluginInitializer<span class="token punctuation">}</span>

            net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>ServerList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            utilwait<span class="token punctuation">.</span><span class="token function">PollImmediate</span><span class="token punctuation">(</span>etcdRetryInterval<span class="token punctuation">,</span> etcdRetryLimit<span class="token operator">*</span>etcdRetryInterval<span class="token punctuation">,</span> preflight<span class="token punctuation">.</span>EtcdConnection<span class="token punctuation">{</span>ServerList<span class="token punctuation">:</span> s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>ServerList<span class="token punctuation">}</span><span class="token punctuation">.</span>CheckEtcdServers<span class="token punctuation">)</span>
            capabilities<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// allow privillage?</span>
            config <span class="token operator">:=</span> <span class="token operator">&amp;</span>controlplane<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">createAPIExtensionsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">createAPIExtensionsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            apiextensionsConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span>delegateCheck<span class="token punctuation">)</span>
<span class="token comment">// 注册通用handler</span>
                <span class="token function">installAPI</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token comment">// register generic api handler e.g. index, profiling, metrics, flow control</span>
        <span class="token function">CreateKubeAPIServer</span><span class="token punctuation">(</span>kubeAPIServerConfig<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">)</span>
            kubeAPIServerConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>
                m<span class="token punctuation">.</span><span class="token function">InstallLegacyAPI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> legacyRESTStorageProvider<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHookOrDie</span><span class="token punctuation">(</span>controllerName<span class="token punctuation">,</span> bootstrapController<span class="token punctuation">.</span>PostStartHook<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        controlplane<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            async<span class="token punctuation">.</span><span class="token function">NewRunner</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>RunKubernetesNamespaces<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RunKubernetesService<span class="token punctuation">,</span> repairClusterIPs<span class="token punctuation">.</span>RunUntil<span class="token punctuation">,</span> repairNodePorts<span class="token punctuation">.</span>RunUntil<span class="token punctuation">)</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPreShutdownHookOrDie</span><span class="token punctuation">(</span>controllerName<span class="token punctuation">,</span> bootstrapController<span class="token punctuation">.</span>PreShutdownHook<span class="token punctuation">)</span>
<span class="token comment">// 注册core group API handler</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallLegacyAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// register handler for /api</span>
                    restStorageProviders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>RESTStorageProvider<span class="token punctuation">{</span>appsrest<span class="token punctuation">.</span>StorageProvider<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                m<span class="token punctuation">.</span><span class="token function">InstallAPIs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">.</span>APIResourceConfigSource<span class="token punctuation">,</span> c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">,</span> restStorageProviders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">// 初始化对应group中对象的watch cache</span>
                    restStorageBuilder<span class="token punctuation">.</span><span class="token function">NewRESTStorage</span><span class="token punctuation">(</span>apiResourceConfigSource<span class="token punctuation">,</span> restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// trigger appsrest.StorageProvider</span>
                        p<span class="token punctuation">.</span><span class="token function">v1Storage</span><span class="token punctuation">(</span>apiResourceConfigSource<span class="token punctuation">,</span> restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            daemonsetstore<span class="token punctuation">.</span><span class="token function">NewREST</span><span class="token punctuation">(</span>restOptionsGetter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                store<span class="token punctuation">.</span><span class="token function">CompleteWithOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                    opts<span class="token punctuation">,</span> err <span class="token operator">:=</span> options<span class="token punctuation">.</span>RESTOptions<span class="token punctuation">.</span><span class="token function">GetRESTOptions</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>DefaultQualifiedResource<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// etcd.go</span>
                                        ret<span class="token punctuation">.</span>Decorator <span class="token operator">=</span> genericregistry<span class="token punctuation">.</span><span class="token function">StorageWithCacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                            cacherstorage<span class="token punctuation">.</span><span class="token function">NewCacherFromConfig</span><span class="token punctuation">(</span>cacherConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                                watchCache <span class="token operator">:=</span> <span class="token function">newWatchCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">// 注册API handler</span>
                    m<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallAPIGroups</span><span class="token punctuation">(</span>apiGroupsInfo<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>  <span class="token comment">// register handler for /apis</span>
                        s<span class="token punctuation">.</span><span class="token function">installAPIResources</span><span class="token punctuation">(</span>APIGroupPrefix<span class="token punctuation">,</span> apiGroupInfo<span class="token punctuation">,</span> openAPIModels<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                            apiGroupVersion<span class="token punctuation">.</span><span class="token function">InstallREST</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span>GoRestfulContainer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                                discovery<span class="token punctuation">.</span><span class="token function">NewAPIVersionHandler</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> g<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">,</span> staticLister<span class="token punctuation">{</span>apiResources<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">,</span> kubeAPIServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">,</span> apiExtensionsServer<span class="token punctuation">.</span>Informers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            apiServices <span class="token operator">:=</span> <span class="token function">apiServicesToRegister</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">,</span> autoRegistrationController<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            s<span class="token punctuation">.</span><span class="token function">installHealthz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">installLivez</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">installReadyz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    prepared<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        s<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// preparedGenericAPIServer.Run()</span>
            s<span class="token punctuation">.</span><span class="token function">NonBlockingRun</span><span class="token punctuation">(</span>delayedStopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">.</span>SecureServingInfo<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> s<span class="token punctuation">.</span>ShutdownTimeout<span class="token punctuation">,</span> internalStopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token function">RunServer</span><span class="token punctuation">(</span>secureServer<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Listener<span class="token punctuation">,</span> shutdownTimeout<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Kubernetes-控制平面组件：调度器和控制器"><a href="#Kubernetes-控制平面组件：调度器和控制器" class="headerlink" title="Kubernetes 控制平面组件：调度器和控制器"></a>Kubernetes 控制平面组件：调度器和控制器</h2><h3 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h3><h4 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kube-scheduler-0d45b37a5c9a46008aaf9f9e2088b3ce">kube-scheduler</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Framework manages the set of plugins in use by the scheduling framework.</span>
<span class="token comment">// Configured plugins are called at specified points in a scheduling context.</span>
<span class="token keyword">type</span> Framework <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    Handle
    <span class="token function">QueueSortFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> LessFunc
    <span class="token function">RunPreFilterPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunPostFilterPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> filteredNodeStatusMap NodeToStatusMap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PostFilterResult<span class="token punctuation">,</span> <span class="token operator">*</span>Status<span class="token punctuation">)</span>
    <span class="token function">RunPreBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunPostBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunReservePluginsUnreserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">WaitOnPermit</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">RunBindPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Status
    <span class="token function">HasFilterPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">HasPostFilterPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">HasScorePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">ListPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Plugins
    <span class="token function">ProfileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token comment">// filter</span>
    g<span class="token punctuation">.</span><span class="token function">findNodesThatFitPod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> extenders<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 1.filter预处理阶段：遍历pod的所有initcontainer和主container，计算pod的总资源需求</span>
        s <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPreFilterPlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token comment">// e.g. computePodResourceRequest</span>
        <span class="token comment">// 2. filter阶段，遍历所有节点，过滤掉不符合资源需求的节点</span>
        g<span class="token punctuation">.</span><span class="token function">findNodesThatPassFilters</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> diagnosis<span class="token punctuation">,</span> allNodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            fwk<span class="token punctuation">.</span><span class="token function">RunFilterPluginsWithNominatedPods</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getPreFilterState</span><span class="token punctuation">(</span>cycleState<span class="token punctuation">)</span>
                insufficientResources <span class="token operator">:=</span> <span class="token function">fitsRequest</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> f<span class="token punctuation">.</span>ignoredResources<span class="token punctuation">,</span> f<span class="token punctuation">.</span>ignoredResourceGroups<span class="token punctuation">)</span>
        <span class="token comment">// 3. 处理扩展plugin</span>
        <span class="token function">findNodesThatPassExtenders</span><span class="token punctuation">(</span>extenders<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> feasibleNodes<span class="token punctuation">,</span> diagnosis<span class="token punctuation">.</span>NodeToStatusMap<span class="token punctuation">)</span>
        <span class="token comment">// score</span>
    <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> extenders<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> feasibleNodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 4. score，比如处理弱亲和性，将preferredAffinity语法进行解析</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span> <span class="token comment">// e.g. nodeAffinity</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token comment">// 5. 为节点打分</span>
            f<span class="token punctuation">.</span><span class="token function">runScorePlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// e.g. noderesource fit</span>
        <span class="token comment">// 6. 处理扩展plugin</span>
        extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Prioritize</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
        <span class="token comment">// 7.选择节点</span>
        g<span class="token punctuation">.</span><span class="token function">selectHost</span><span class="token punctuation">(</span>priorityList<span class="token punctuation">)</span>
sched<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token comment">// 8.假定选中pod</span>
    sched<span class="token punctuation">.</span>SchedulerCache<span class="token punctuation">.</span><span class="token function">AssumePod</span><span class="token punctuation">(</span>assumed<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
fwk<span class="token punctuation">.</span><span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runReservePluginReserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// e.g. bindVolume。其实还没大用</span>
runPermitStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>schedulingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runPermitPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span> <span class="token comment">// empty hook</span>
fwk<span class="token punctuation">.</span><span class="token function">RunPreBindPlugins</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span> <span class="token comment">// 同 runReservePluginReserve</span>
        <span class="token comment">// bind</span>
        <span class="token comment">// 9.绑定pod</span>
sched<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>bindingCycleCtx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    f<span class="token punctuation">.</span><span class="token function">runBindPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bp<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        b<span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">ClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespace</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"pods"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">VersionedParams</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">,</span> scheme<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SubResource</span><span class="token punctuation">(</span><span class="token string">"binding"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Body</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>kube-scheduler 负责分配调度 Pod 到集群内的节点上，它监听 kube-apiserver，查询还未分配 Node 的 Pod，然后根据调度策略为这些 Pod 分配节点（更新 Pod 的NodeName 字段）。</p>
<p>调度器需要充分考虑诸多的因素：</p>
<ul>
<li>公平调度</li>
<li>资源高效利用</li>
<li>Qos</li>
<li>affinity 和 anti-affinity</li>
<li>数据本地化（data locality）</li>
<li>内部负载干扰（inter-workload interfernece）</li>
<li>deadlines</li>
</ul>
<h4 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h4><p>kube-scheduler 调度分为两个阶段：</p>
<ul>
<li>predicate：过滤不符合条件的节点</li>
<li>priority：优先级排序，选择优先级最高的节点。</li>
</ul>
<h5 id="predicates-策略"><a href="#predicates-策略" class="headerlink" title="predicates 策略"></a>predicates 策略</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicates策略.png" alt="predicates策略"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicates策略2.png" alt="predicates策略2"></p>
<h5 id="predicates-plugin-工作原理"><a href="#predicates-plugin-工作原理" class="headerlink" title="predicates plugin 工作原理"></a>predicates plugin 工作原理</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/predicatesplugin工作原理.png" alt="predicatesplugin工作原理"></p>
<h5 id="priorities-策略"><a href="#priorities-策略" class="headerlink" title="priorities 策略"></a>priorities 策略</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/priorities策略.png" alt="priorities策略"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/priorities策略2.png" alt="priorities策略2"></p>
<h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul>
<li>CPU<ul>
<li>requests<ul>
<li>Kubernetes 调度 Pod 时，会判断当前节点正在运行的 Pod 的 CPU Request 的总和，再加上当前调度 Pod 的 CPU Request，计算其是否超过节点的 CPU 的可分配资源</li>
</ul>
</li>
<li>limits<ul>
<li>配置 cgroup 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
<li>内存<ul>
<li>requests<ul>
<li>判断节点的剩余内存是否满足 Pod 的内存请求量，以确定是否可以将 Pod 调度到该节点</li>
</ul>
</li>
<li>limits<ul>
<li>配置 cgroup 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>调度时只看 request。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get node -oyaml
apiVersion: v1
items:
- apiVersion: v1
  kind: Node
  <span class="token punctuation">..</span>.
  status:
    allocatable:
      cpu: <span class="token string">"12"</span>
      ephemeral-storage: 1055762868Ki
      hugepages-1Gi: <span class="token string">"0"</span>
      hugepages-2Mi: <span class="token string">"0"</span>
      memory: 65713368Ki
      pods: <span class="token string">"110"</span>
    capacity:
      cpu: <span class="token string">"12"</span>
      ephemeral-storage: 1055762868Ki
      hugepages-1Gi: <span class="token string">"0"</span>
      hugepages-2Mi: <span class="token string">"0"</span>
      memory: 65713368Ki
      pods: <span class="token string">"110"</span>
    <span class="token punctuation">..</span>.

<span class="token comment"># 获取某个容器的 cgroup 信息</span>
$ docker inspect 89bf4bbee272 -f <span class="token string">"{{.HostConfig.CgroupParent}}"</span>
/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed

$ <span class="token function">find</span> /sys/fs/cgroup -name <span class="token string">"pod8af0e85a28544808d52bb7c47ad824ed"</span>
/sys/fs/cgroup/systemd/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/misc/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/rdma/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/pids/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/hugetlb/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/net_prio/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/perf_event/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/net_cls/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/freezer/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/devices/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/memory/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/blkio/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpuacct/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpu/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/cpuset/system.slice/docker-2c68f760293681c1dcbffc164ad491d870ab0318521cbcfa9898d74132cee75b.scope/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed
/sys/fs/cgroup/unified/kubepods/burstable/pod8af0e85a28544808d52bb7c47ad824ed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi           <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> memory.limit_in_bytes = memory(1) * 1024 * 1024 * 1024
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1                <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> cpu.cfs_quota_us(100000) = cpu.cfs_period_us(100000) * cpu(1)
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m             <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> cpu.shares = int(cpu(100m) / 1000m * 1024) = 102<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以使用 LimitRange 来限制集群中资源的范围和设置默认的资源</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/2.limit-range.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/2.limit-range.yaml</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/policy/limit-range/">https://kubernetes.io/docs/concepts/policy/limit-range/</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mem<span class="token punctuation">-</span>limit<span class="token punctuation">-</span>range
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
      <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是在真实的场景中不太用 LimitRange，因为 LimitRange 会对所有的容器生效，包括 init container。</p>
<h5 id="磁盘资源需求"><a href="#磁盘资源需求" class="headerlink" title="磁盘资源需求"></a>磁盘资源需求</h5><p>容器临时存储（ephemeral storage）包含日志和可写层数据，可以通过定义 Pod Spec 中的 <code>limits.ephemeral-storage</code> 和 <code>requests.ephemeral-storage</code> 来申请。</p>
<p>Pod 调度完成后，计算节点对临时存储的限制不是基于 CGroup 的，而是由 kubelet 定时获取容器的日志和容器可写层的磁盘使用情况，如果超过限制，则会对 Pod 进行驱逐。</p>
<h5 id="Init-Container-的资源需求"><a href="#Init-Container-的资源需求" class="headerlink" title="Init Container 的资源需求"></a>Init Container 的资源需求</h5><ul>
<li>当 kube-scheduler 调度带有多个 init 容器的 Pod 时，只计算 <code>cpu.request</code> 最多的 init 容器，而不是计算所有的 init 容器总和。</li>
<li>由于多个 init 容器按顺序执行，并且执行完成立即退出，所以申请最多的资源 init 容器中的所需资源，即可满足所有 init 容器需求。</li>
<li>kube-scheduler 在计算该节点被占用的资源时，init 容器的资源依然会被纳入计算。因为 init 容器在特定情况下可能会被再次执行，比如由于更换镜像而引起 Sandbox 重建时。</li>
</ul>
<h4 id="把-Pod-调度到指定-Node-上"><a href="#把-Pod-调度到指定-Node-上" class="headerlink" title="把 Pod 调度到指定 Node 上"></a>把 Pod 调度到指定 Node 上</h4><p>可以通过 nodeSelector、nodeAffinity、podAffinity 以及 Taints 和 tolerations 等来将 Pod 调度到需求的 Node 上。</p>
<p>也可以通过设置 nodeName 参数，将 Pod 调度到指定 node 节点上。</p>
<p>比如，使用 nodeSelector，首先给 Node 加上标签：<code>kubectl label nodes &lt;your-node-name&gt; disktype=ssd</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get node --show-labels
NAME       STATUS   ROLES           AGE   VERSION   LABELS
minikube   Ready    control-plane   23h   v1.27.4   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>minikube,kubernetes.io/os<span class="token operator">=</span>linux,minikube.k8s.io/commit<span class="token operator">=</span>fd7ecd9c4599bef9f04c0986c4a0187f98a4396e,minikube.k8s.io/name<span class="token operator">=</span>minikube,minikube.k8s.io/primary<span class="token operator">=</span>true,minikube.k8s.io/updated_at<span class="token operator">=</span>2024_05_07T17_53_18_0700,minikube.k8s.io/version<span class="token operator">=</span>v1.31.2,node-role.kubernetes.io/control-plane<span class="token operator">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="token operator">=</span>

$ kubectl label nodes minikube <span class="token assign-left variable">disktype</span><span class="token operator">=</span>hdd
node/minikube labeled

$ kubectl get node --show-labels
NAME       STATUS   ROLES           AGE   VERSION   LABELS
minikube   Ready    control-plane   23h   v1.27.4   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,disktype<span class="token operator">=</span>hdd,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>minikube,kubernetes.io/os<span class="token operator">=</span>linux,minikube.k8s.io/commit<span class="token operator">=</span>fd7ecd9c4599bef9f04c0986c4a0187f98a4396e,minikube.k8s.io/name<span class="token operator">=</span>minikube,minikube.k8s.io/primary<span class="token operator">=</span>true,minikube.k8s.io/updated_at<span class="token operator">=</span>2024_05_07T17_53_18_0700,minikube.k8s.io/version<span class="token operator">=</span>v1.31.2,node-role.kubernetes.io/control-plane<span class="token operator">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，指定该 Pod 只想运行在带有 <code>disktype=ssd</code> 标签的 Node 上。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/4.node-selector.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/4.node-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/5.readme.MD">https://github.com/kibaamor/101/blob/master/module7/scheduling/5.readme.MD</a></p>
<p>NodeAffinity 目前支持两种：requiredDuringSchedulingIgnoredDuringExecution 和 preferredDuringSchedulingIgnoredDuringExecution，分别代表必须满足和优选条件。</p>
<blockquote>
<p>可以用 <code>NotIn</code> 等 operator 实现反亲和性。</p>
<p>requiredDuringSchedulingIgnoredDuringExecution 在调度器的 predicate 阶段起作用，preferredDuringSchedulingIgnoredDuringExecution 在调度器的 priority 阶段起作用，所以 preferredDuringSchedulingIgnoredDuringExecution 中有 weight 参数。</p>
</blockquote>
<p>比如下面的例子代表调度到包含标签 <code>Kubernetes.io/e2e-az-name</code> 并且值为 <code>e2e-az1</code> 或 <code>e2e-az2</code> 的 Node 上，并且优选还带有标签 <code>another-node-label-key=another-node-label-value</code> 的 Node 。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/e2e<span class="token punctuation">-</span>az<span class="token punctuation">-</span>name
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az1
            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az2
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>key
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>value
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_containers/pause<span class="token punctuation">:</span><span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/5.a.pod-anti-affinity.yaml">https://github.com/kibaamor/101/blob/master/module7/scheduling/5.a.pod-anti-affinity.yaml</a></p>
<p>podAffinity 基于 Pod 的标签来选择 Node，仅调度到满足条件 Pod 所在的 Node 上，支持 PodAffinity 和 PodAntiAffinity。这个功能比较绕，以下面的例子为例：</p>
<p>如果一个 “Node 所在的 Zone 中包含至少一个带有 security=S1 标签且运行中的 Pod”，那么可以调度到该 Node，尽量不调度到 “包含至少一个带有 security=S2 标签且运行中 Pod” 的 Node 上。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchExpressons</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> security
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
          <span class="token key atrule">values</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> S1
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> failure<span class="token punctuation">-</span>domain.beta.kubernetes.io/zone
    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExection</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressons</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> security
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> S2
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_containers/pause<span class="token punctuation">:</span><span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Taints-和-Tolerations"><a href="#Taints-和-Tolerations" class="headerlink" title="Taints 和 Tolerations"></a>Taints 和 Tolerations</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/scheduling/6.taint.MD">https://github.com/kibaamor/101/blob/master/module7/scheduling/6.taint.MD</a></p>
<p>Taints 和 Tolerations 用于保证 Pod 不被调度到不合适的 Node 上，其中 Taint 应用于 Node 上，而 Toleration 则应用于 Pod 上。</p>
<p>目前支持的 Taint 类型：</p>
<ul>
<li>NoSchedule：新的 Pod 不调度到该 Node 上，不影响正在运行的 Pod</li>
<li>PreferNoSchedule： soft 版的 NoSchedule，尽量不调度到该 Node 上</li>
<li>NoExecute：新的 Pod 不调度到该 Node 上，并且删除（evict）已在运行的 Pod。 Pod 可以增加一个时间（tolerationSeconds）</li>
</ul>
<p>然而，当 Pod 的 Tolerations 匹配 Node 的所有 Taints 的时候可以调度到该 Node 上；当 Pod 是已经运行的时候，也不会被删除（evicted）。另外对于 NoExecute，如果 Pod 增加一个 tolerationSeconds，则会在该时间之后才删除 Pod。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get po metrics-server-7746886d4f-l8gs7 -oyaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: <span class="token string">"2024-05-07T09:53:31Z"</span>
  generateName: metrics-server-7746886d4f-
  labels:
    k8s-app: metrics-server
    pod-template-hash: 7746886d4f
  name: metrics-server-7746886d4f-l8gs7
  namespace: kube-system
  ownerReferences:
  - apiVersion: apps/v1
    blockOwnerDeletion: <span class="token boolean">true</span>
    controller: <span class="token boolean">true</span>
    kind: ReplicaSet
    name: metrics-server-7746886d4f
    uid: 394b2480-e048-4b10-977d-aaeabcf57ca0
  resourceVersion: <span class="token string">"586"</span>
  uid: 2a18e607-3bd2-4b66-959c-6a41de9f9e53
spec:
  tolerations:
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: <span class="token number">300</span>
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: <span class="token number">300</span>
  <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果一个 Node 上有一个 key 为 <code>node.kubernetes.io/not-ready</code> 或者 <code>node.kubernetes.io/unreachable</code> 的 taint ，那么这个 Node 上面的 Pod 允许存活 300 秒后再被驱逐。</p>
<p>上面的这两个 toleration 是创建 Pod 时 kubernetes 自动加上的。如果一个节点发生故障，这个节点上面的 Pod 会被自动驱逐。其背后的机制就是如果一个 node 变为 <code>not-ready</code> 或者 <code>unreachable</code>，kubernetes 会自动的给该 node 加上对应的 taint。这也是 kubernetes 能做故障转移的秘密。</p>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/pkg-controller-nodelifecycle-node_lifecycle_controller-go-9e2888478bd84ad3bf9fd2c79da1481c">pkg/controller/nodelifecycle/node_lifecycle_controller.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">NewNodeLifecycleController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    nc <span class="token operator">:=</span> <span class="token operator">&amp;</span>Controller<span class="token punctuation">{</span>
        kubeClient<span class="token punctuation">:</span>                  kubeClient<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    podInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> nc<span class="token punctuation">.</span>runTaintManager <span class="token punctuation">{</span>
        nodeInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">go</span> nc<span class="token punctuation">.</span>taintManager<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> UpdateWorkerSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        tc<span class="token punctuation">.</span>nodeUpdateChannels <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>nodeUpdateChannels<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> nodeUpdateItem<span class="token punctuation">,</span> NodeUpdateChannelSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        tc<span class="token punctuation">.</span>podUpdateChannels <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>podUpdateChannels<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> podUpdateItem<span class="token punctuation">,</span> podUpdateChannelSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    item<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> tc<span class="token punctuation">.</span>nodeUpdateQueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    hash <span class="token operator">:=</span> <span class="token function">hash</span><span class="token punctuation">(</span>nodeUpdate<span class="token punctuation">.</span>nodeName<span class="token punctuation">,</span> UpdateWorkerSize<span class="token punctuation">)</span>
    tc<span class="token punctuation">.</span>nodeUpdateChannels<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> nodeUpdate<span class="token punctuation">:</span>

    item<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> tc<span class="token punctuation">.</span>podUpdateQueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// that pods are processed by the same worker as nodes</span>
    hash <span class="token operator">:=</span> <span class="token function">hash</span><span class="token punctuation">(</span>podUpdate<span class="token punctuation">.</span>nodeName<span class="token punctuation">,</span> UpdateWorkerSize<span class="token punctuation">)</span>
    <span class="token keyword">case</span> tc<span class="token punctuation">.</span>podUpdateChannels<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> podUpdate<span class="token punctuation">:</span> 

    <span class="token keyword">go</span> tc<span class="token punctuation">.</span><span class="token function">worker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> wg<span class="token punctuation">.</span>Done<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        tc<span class="token punctuation">.</span><span class="token function">handleNodeUpdate</span><span class="token punctuation">(</span>nodeUpdate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            taints <span class="token operator">:=</span> <span class="token function">getNoExecuteTaints</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Taints<span class="token punctuation">)</span>
            tc<span class="token punctuation">.</span>taintedNodes<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> taints
            pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span><span class="token function">getPodsAssignedToNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            tc<span class="token punctuation">.</span><span class="token function">processPodOnNode</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Tolerations<span class="token punctuation">,</span> taints<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                allTolerated<span class="token punctuation">,</span> usedTolerations <span class="token operator">:=</span> v1helper<span class="token punctuation">.</span><span class="token function">GetMatchingTolerations</span><span class="token punctuation">(</span>taints<span class="token punctuation">,</span> tolerations<span class="token punctuation">)</span>
                <span class="token comment">// toleration 不匹配，立即驱逐</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>allTolerated <span class="token punctuation">{</span>
                    tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                minTolerationTime <span class="token operator">:=</span> <span class="token function">getMinTolerationTime</span><span class="token punctuation">(</span>usedTolerations<span class="token punctuation">)</span>
                startTime <span class="token operator">:=</span> now
                triggerTime <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>minTolerationTime<span class="token punctuation">)</span>
                tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> triggerTime<span class="token punctuation">)</span>
        tc<span class="token punctuation">.</span><span class="token function">handlePodUpdate</span><span class="token punctuation">(</span>podUpdate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            tc<span class="token punctuation">.</span><span class="token function">processPodOnNode</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Tolerations<span class="token punctuation">,</span> taints<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                tc<span class="token punctuation">.</span>taintEvictionQueue<span class="token punctuation">.</span><span class="token function">AddWork</span><span class="token punctuation">(</span><span class="token function">NewWorkArgs</span><span class="token punctuation">(</span>podNamespacedName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> podNamespacedName<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    worker <span class="token operator">:=</span> <span class="token function">createWorker</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> createdAt<span class="token punctuation">,</span> fireAt<span class="token punctuation">,</span> q<span class="token punctuation">.</span><span class="token function">getWrappedWorkerFunc</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>clock<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        delay <span class="token operator">:=</span> fireAt<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>createdAt<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> delay <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                            <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                            <span class="token keyword">return</span> <span class="token boolean">nil</span>
                        <span class="token punctuation">}</span>
                        timer <span class="token operator">:=</span> clock<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

tm<span class="token punctuation">.</span>taintEvictionQueue <span class="token operator">=</span> <span class="token function">CreateWorkerQueue</span><span class="token punctuation">(</span><span class="token function">deletePodHandler</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> tm<span class="token punctuation">.</span>emitPodDeletionEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">//	delete pod</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="多租户-Kubernetes-集群计算资源隔离"><a href="#多租户-Kubernetes-集群计算资源隔离" class="headerlink" title="多租户 Kubernetes 集群计算资源隔离"></a>多租户 Kubernetes 集群计算资源隔离</h5><p>Kubernetes 集群一般是通用集群，可被所有用户共享，用户无需关心计算节点细节。</p>
<p>但往往某些自带计算资源的客户要求：</p>
<ul>
<li>带着计算资源加入 Kubernetes 集群</li>
<li>要求资源隔离</li>
</ul>
<p>实现方案：</p>
<ul>
<li>将要隔离的计算节点打上 Taints</li>
<li>在用户创建 Pod 时，定义 Tolerations 来指定要调度到 node taints</li>
</ul>
<p>该方案有漏洞吗？如何堵住？</p>
<ul>
<li>其他用户如果可以 get nodes 或者 pods，可以看到 taints 信息，也可以用相同的 tolerations 占用资源</li>
<li>不让用户 get node detail?</li>
<li>不让用户 get 别人的 pod detail？</li>
<li>企业内部，也可以通过规范管理，通过统计数据看谁占用了哪些 node</li>
<li>数据平面上的隔离还需要其他方案配合</li>
</ul>
<h5 id="来自生产系统的经验"><a href="#来自生产系统的经验" class="headerlink" title="来自生产系统的经验"></a>来自生产系统的经验</h5><ul>
<li>用户会忘记打 tolerance，导致 pod 无法调度，pending</li>
<li>新员工常犯的错误，通过聊天机器人的 Q&amp;A 解决</li>
<li>其他用户会 get node detail，查到 taints，偷用资源</li>
<li>通过 dashboard，能看到哪些用户的什么应用跑在哪些节点上</li>
<li>对于违规用户，批评教育为主</li>
</ul>
<h4 id="优先级调度"><a href="#优先级调度" class="headerlink" title="优先级调度"></a>优先级调度</h4><p>从 v1.8 开始，kube-scheduler 支持定义 Pod 的优先级，从而保证高优先级的 Pod 优先调度。开启方法为：</p>
<ul>
<li>apiserver 配置 <code>--feature-gates=PodPrioirity=true</code> 和 <code>--runtime-config=scheduling.k8s.io/v1alpha1=true</code></li>
<li>kube-scheduler 配置 <code>--feature-gates=PodPriority=true</code></li>
</ul>
<h5 id="PriorityClass"><a href="#PriorityClass" class="headerlink" title="PriorityClass"></a>PriorityClass</h5><p>在指定 Pod 的优先级之前需要先定义一个 PriorityClass（非 namespace 资源），如：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PriorityClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority
<span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
<span class="token key atrule">globalDefault</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"This priority class should be used for XYZ service pods only."</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为 pod 设置 Priority</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="多调度器"><a href="#多调度器" class="headerlink" title="多调度器"></a>多调度器</h4><p>如果默认的调度器不满足需求，还可以部署自定义的调度器。并且，在整个集群中还可以同时运行多个调度器实例，通过 <code>podSpec.schedulerName</code> 来选择使用哪一个调度器（默认使用内置的调度器）。</p>
<h4 id="来从生产环境的一些经验"><a href="#来从生产环境的一些经验" class="headerlink" title="来从生产环境的一些经验"></a>来从生产环境的一些经验</h4><ol>
<li><p>小集群</p>
<p> 100 个 node，并发创建 8000 个 Pod 的最大调度耗时大概是 2 分钟左右，发生过 node 删除后，scheduler cache 还有信息的情况，导致 Pod 调度失败。</p>
</li>
<li><p>放大效应</p>
<p> 当一个 node 出现问题所以 load 较小时，通常用户的 Pod 都会优先调度到该 Node 上，导致用户所有创建的新 Pod 都失败的情况。</p>
</li>
<li><p>应用炸弹</p>
<p> 存在危险的用户 Pod（比如 fork bomb），在调度到某个 node 上后，会因为打开文件句柄过多导致 node down 机，Pod 会被 evict 到其他节点，再对其他节点造成伤害，依次循环会导致整个 cluster 所有节点不可用。</p>
</li>
</ol>
<p>调度器可以说是运营过程中稳定性最好的组件之一，基本没有太大的维护 effort。</p>
<h3 id="Controller-Manager-1"><a href="#Controller-Manager-1" class="headerlink" title="Controller Manager"></a>Controller Manager</h3><h4 id="控制器的工作流程-1"><a href="#控制器的工作流程-1" class="headerlink" title="控制器的工作流程"></a>控制器的工作流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的工作流程.png" alt="控制器的工作流程"></p>
<h4 id="Informer-的内部机制-1"><a href="#Informer-的内部机制-1" class="headerlink" title="Informer 的内部机制"></a>Informer 的内部机制</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Informer的内部机制.png" alt="Informer的内部机制"></p>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/informer-framework-31ba746049ec472fb405e61482ed762f">informer framework</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">secretInformer <span class="token operator">:=</span> kubecoreinformers<span class="token punctuation">.</span><span class="token function">NewSecretInformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">NewFilteredSecretInformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>ListWatch<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Secret<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> indexers<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            sharedIndexInformer <span class="token operator">:=</span> <span class="token operator">&amp;</span>sharedIndexInformer<span class="token punctuation">{</span>
                processor<span class="token punctuation">:</span>                       <span class="token operator">&amp;</span>sharedProcessor<span class="token punctuation">{</span>clock<span class="token punctuation">:</span> realClock<span class="token punctuation">}</span><span class="token punctuation">,</span>
                indexer<span class="token punctuation">:</span>                         <span class="token function">NewIndexer</span><span class="token punctuation">(</span>DeletionHandlingMetaNamespaceKeyFunc<span class="token punctuation">,</span> indexers<span class="token punctuation">)</span><span class="token punctuation">,</span>
                listerWatcher<span class="token punctuation">:</span>                   lw<span class="token punctuation">,</span>
                objectType<span class="token punctuation">:</span>                      exampleObject<span class="token punctuation">,</span>
                resyncCheckPeriod<span class="token punctuation">:</span>               defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
                defaultEventHandlerResyncPeriod<span class="token punctuation">:</span> defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
                cacheMutationDetector<span class="token punctuation">:</span>           <span class="token function">NewCacheMutationDetector</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%T"</span><span class="token punctuation">,</span> exampleObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                clock<span class="token punctuation">:</span>                           realClock<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>

secretInformer<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        listener <span class="token operator">:=</span> <span class="token function">newProcessListener</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> <span class="token function">determineResyncPeriod</span><span class="token punctuation">(</span>resyncPeriod<span class="token punctuation">,</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialBufferSize<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            ret <span class="token operator">:=</span> <span class="token operator">&amp;</span>processorListener<span class="token punctuation">{</span>
                nextCh<span class="token punctuation">:</span>                <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                addCh<span class="token punctuation">:</span>                 <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span>               handler<span class="token punctuation">,</span>
                pendingNotifications<span class="token punctuation">:</span>  <span class="token operator">*</span>buffer<span class="token punctuation">.</span><span class="token function">NewRingGrowing</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
                requestedResyncPeriod<span class="token punctuation">:</span> requestedResyncPeriod<span class="token punctuation">,</span>
                resyncPeriod<span class="token punctuation">:</span>          resyncPeriod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
            listener<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token keyword">for</span> next <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>nextCh <span class="token punctuation">{</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnUpdate</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">,</span> notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnAdd</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
                    p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnDelete</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            listener<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token keyword">for</span> <span class="token punctuation">{</span>
                    <span class="token keyword">select</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> nextCh <span class="token operator">&lt;-</span> notification<span class="token punctuation">:</span>
                        notification<span class="token punctuation">,</span> ok <span class="token operator">=</span> p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">ReadOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">case</span> notificationToAdd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>addCh<span class="token punctuation">:</span>
                            p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">WriteOne</span><span class="token punctuation">(</span>notificationToAdd<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listener<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">{</span>newObj<span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                p<span class="token punctuation">.</span>addCh <span class="token operator">&lt;-</span> notification
        <span class="token punctuation">}</span>

<span class="token keyword">go</span> secretInformer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Stop<span class="token punctuation">)</span>
    fifo <span class="token operator">:=</span> <span class="token function">NewDeltaFIFOWithOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    cfg <span class="token operator">:=</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{</span>
            Queue<span class="token punctuation">:</span>            fifo<span class="token punctuation">,</span>
            ListerWatcher<span class="token punctuation">:</span>    s<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">,</span>
            ObjectType<span class="token punctuation">:</span>       s<span class="token punctuation">.</span>objectType<span class="token punctuation">,</span>
            FullResyncPeriod<span class="token punctuation">:</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">,</span>
            RetryOnError<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
            ShouldResync<span class="token punctuation">:</span>     s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>shouldResync<span class="token punctuation">,</span>
    
            Process<span class="token punctuation">:</span> s<span class="token punctuation">.</span>HandleDeltas<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>cacheMutationDetector<span class="token punctuation">.</span>Run<span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>run<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>controller <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        r <span class="token operator">:=</span> <span class="token function">NewReflector</span><span class="token punctuation">(</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ListerWatcher<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ObjectType<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">,</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>FullResyncPeriod<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Run<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            r<span class="token punctuation">.</span><span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                list <span class="token operator">:=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">syncWith</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">watchHandler</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resourceVersion<span class="token punctuation">,</span> resyncerrc<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>processLoop<span class="token operator">--</span><span class="token operator">&gt;</span>
            c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token function">PopProcessFunc</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//HandleDeltas</span>
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>updateNotification<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">)</span>
                    s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>deleteNotification<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="控制器的协同工作原理-1"><a href="#控制器的协同工作原理-1" class="headerlink" title="控制器的协同工作原理"></a>控制器的协同工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的协同工作原理.png" alt="控制器的协同工作原理"></p>
<h4 id="通用-Controller"><a href="#通用-Controller" class="headerlink" title="通用 Controller"></a>通用 Controller</h4><ol>
<li>Job Controller：处理 Job</li>
<li>Pod AutoScaler：处理 Pod 的自动缩容/扩容</li>
<li>ReplicaSet：依据 ReplicaSet Spec 创建 Pod</li>
<li>Service Controller：为 LoadBalancer type 的 Service 创建 LB VIP</li>
<li>ServiceAccount Controller：确保 ServiceAccount 在当前 Namepsace 存在</li>
<li>StatefulSet Controller：处理 StatefulSet 中的 Pod</li>
<li>Volume Controller：依据 PV spec 创建 Volume</li>
<li>Resource Quota Controller：在用户使用资源之后，更新状态</li>
<li>Namespace Controller：保证 Namespace 删除时，该 Namespace 下的所有资源都先被删除</li>
<li>Replication Controller（后改名为 ReplicaSet）：创建 RC 后，负责创建 Pod</li>
<li>Node Controller（即 NodeLifeCycleController）：维护 Node 状态，处理 evict 请求等</li>
<li>Daemon Controller：依据 DaemonSet 创建 Pod</li>
<li>Deployment Controller：依据 Deployment spec 创建 ReplicaSet</li>
<li>Endpoint Controller：依据 Service spec 创建 Endpoint，依据 Pod ip 更新 Endpoint</li>
<li>Garbage Collector：处理级联删除，比如删除 Deployment 的同时删除 ReplicaSet 以及 Pod。（根据对象中的 ownerReferences 可以算出对象的依赖关系，可以使用 <code>kubectl delete daemonset nginx-ds --cascade=orphan</code> 来保留级联资源）</li>
<li>CronJob Controller：处理 CronJob</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/namespace_controller-go-04eb871906fa484ebb17c4a70442ecc8">namespace_controller.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">discoverResourcesFn <span class="token operator">:=</span> namespaceKubeClient<span class="token punctuation">.</span><span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServerPreferredNamespacedResources<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// fetch all api resources</span>
    all<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ServerPreferredResources</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        serverGroupList<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">ServerGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        groupVersionResources<span class="token punctuation">,</span> failedGroups <span class="token operator">:=</span> <span class="token function">fetchGroupVersionResources</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> serverGroupList<span class="token punctuation">)</span>
        apiResourceList<span class="token punctuation">,</span> ok <span class="token operator">:=</span> groupVersionResources<span class="token punctuation">[</span>groupVersion<span class="token punctuation">]</span>

<span class="token function">NewNamespaceController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    namespaceController <span class="token operator">:=</span> <span class="token operator">&amp;</span>NamespaceController<span class="token punctuation">{</span>
        queue<span class="token punctuation">:</span>                      workqueue<span class="token punctuation">.</span><span class="token function">NewNamedRateLimitingQueue</span><span class="token punctuation">(</span><span class="token function">nsControllerRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"namespace"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        namespacedResourcesDeleter<span class="token punctuation">:</span> deletion<span class="token punctuation">.</span><span class="token function">NewNamespacedResourcesDeleter</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Namespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadataClient<span class="token punctuation">,</span> kubeClient<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> discoverResourcesFn<span class="token punctuation">,</span> finalizerToken<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    namespaceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                namespace <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
                namespaceController<span class="token punctuation">.</span><span class="token function">enqueueNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
<span class="token function">Run</span><span class="token punctuation">(</span>workers <span class="token builtin">int</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>nm<span class="token punctuation">.</span>worker<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            key<span class="token punctuation">,</span> quit <span class="token operator">:=</span> nm<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            err <span class="token operator">:=</span> nm<span class="token punctuation">.</span><span class="token function">syncNamespaceFromKey</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            namespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> nm<span class="token punctuation">.</span>lister<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            nm<span class="token punctuation">.</span>namespacedResourcesDeleter<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>namespace<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token comment">//func (d *namespacedResourcesDeleter) Delete(nsName string) error</span>
                namespace<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span>nsClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nsName<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> namespace<span class="token punctuation">.</span>DeletionTimestamp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span>
                <span class="token punctuation">}</span>
            d<span class="token punctuation">.</span><span class="token function">deleteAllContent</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                resources<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">discoverResourcesFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                gvrDeletionMetadata<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">deleteAllContentForGroupVersionResource</span><span class="token punctuation">(</span>gvr<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> namespaceDeletedAt<span class="token punctuation">)</span>
                deletableResources <span class="token operator">:=</span> discovery<span class="token punctuation">.</span><span class="token function">FilteredBy</span><span class="token punctuation">(</span>discovery<span class="token punctuation">.</span>SupportsAllVerbs<span class="token punctuation">{</span>Verbs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"delete"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resources<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h5><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#limitations">StatefulSets currently require a Headless Service to be responsible for the network identity of the Pods. You are responsible for creating this Service.</a></p>
<p>Stateful Set 需要配置一个 Headless Service 来一起使用。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/controller-manager/statefulset.yaml">https://github.com/kibaamor/101/blob/master/module7/controller-manager/statefulset.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 的更新策略也与 Deployment 不同。</p>
<p>Deployment 的更新策略：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 的更新策略：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Stateful Set 升级时会先升级编号小于等于 partition 的 Pod，等待人工确认后，并需要手动调整 partition 的值才会继续更新。</p>
<h5 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h5><p>每个 Node 一个 Pod</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/controller-manager/daemonset.yaml">https://github.com/kibaamor/101/blob/master/module7/controller-manager/daemonset.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ds
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Daemon Set 的更新策略用的是绝对值</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DaemonSet 与 Deployment 控制过程也不同：</p>
<ul>
<li>Deployment 是 Deployment -&gt; ReplicaSet -&gt; Pod</li>
<li>Daemon Set 是 Controller Revisions &lt;- <strong>Daemon Set</strong> -&gt; Pod </li>
</ul>
<blockquote>
<p>StatefulSet 和 DaemonSet 则是类似的。</p>
</blockquote>
<p>另外 DaemonSet 创建出来的 Pod 和普通 Deployment 创建出来的 Pod 的 Toleration 也不同：</p>
<p>普通 Deployment 创建出来的 Pod 的 Toleration：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而 DaemonSet 创建出来的 Pod 的 Toleration：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/disk<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/memory<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/pid<span class="token punctuation">-</span>pressure
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unschedulable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Cloud-Controller-Manager"><a href="#Cloud-Controller-Manager" class="headerlink" title="Cloud Controller Manager"></a>Cloud Controller Manager</h4><p>什么时候需要 Cloud Controller Manager</p>
<p>Cloud Controller Manager 自 Kubernetes 1.6 开始，从 kube-controller-manager 中分离出来，主要是因为 Cloud Controller Manager 玩玩需要跟企业 Cloud 做深度集成，Release Cycle 跟 Kubernetes 相对独立。</p>
<p>与 Kubernetes 核心管理组件一起升级是一件费时费力的事。</p>
<p>通常 Cloud Controller Manager 需要：</p>
<ul>
<li>认证授权：企业 Cloud 往往需要认证信息，Kubernetes 需要与 Cloud API 通信，需要获取 Cloud 系统里的 ServiceAccount。</li>
<li>Cloud Controller Manager 本身作为一个用户态的 Component，需要在 Kubernetes 中有正确的 RBAC 设置，获得资源操作权限。</li>
<li>高可用：需要通过 Leader Election 来确保 Cloud Controller Manager 高可用。</li>
</ul>
<h4 id="Cloud-Controller-Manager-的配置"><a href="#Cloud-Controller-Manager-的配置" class="headerlink" title="Cloud Controller Manager 的配置"></a>Cloud Controller Manager 的配置</h4><p>Cloud Controller Manager 是从老版本的 API Server 分离出来的。</p>
<blockquote>
<p>kube-apiserver 和 kube-controller-manager 中一定不能指定 cloud-provider，否则会加载内置的 Cloud Controller Manager。</p>
<p>kubelet 要配置 <code>--cloud-provider=external</code></p>
</blockquote>
<p>Cloud Controller Manager 主要支持：</p>
<ol>
<li>Node Controller：访问 Cloud API，来更新 Node 状态；在 Cloud 删除该节点后，从 Kubernetes 删除 Node；</li>
<li>Service Controller：负责为 LoadBalancer 类型的服务配置 LB VIP；</li>
<li>Route Controller：在 Cloud 环境配置路由；</li>
<li>可以自定义任何需要的 Cloud Controller。</li>
</ol>
<h4 id="需要定制的-Cloud-Controller-Manager"><a href="#需要定制的-Cloud-Controller-Manager" class="headerlink" title="需要定制的 Cloud Controller Manager"></a>需要定制的 Cloud Controller Manager</h4><ul>
<li>Ingress Controller</li>
<li>Service Controller</li>
<li>自主研发的 Controller，比如之前提到的：<ul>
<li>RBAC Controller</li>
<li>Account Controller</li>
</ul>
</li>
</ul>
<h4 id="来自生产的经验"><a href="#来自生产的经验" class="headerlink" title="来自生产的经验"></a>来自生产的经验</h4><p>保护好 Controller Manager 的 kubeconfig：</p>
<ol>
<li>此 kubeconfig 拥有所有资源的所有操作权限，防止普通用户通过 <code>kubectl exec kube-controller-manager cat</code> 获取该文件</li>
<li>用户可能做任何你想象不到的操作，然后来找你 Support</li>
</ol>
<p>Pod Evict 后 IP 发生变化，但 Endpoint 中的 Address 更新失败：</p>
<ol>
<li>分析 Stacktrace 发现 Endpoint 在更新 LoadBalancer 时调用 gophercloud 连接 hang 住，导致 Endpoint Worker 线程全部卡死</li>
</ol>
<h4 id="确保-Scheduler-和-Controller-的高可用"><a href="#确保-Scheduler-和-Controller-的高可用" class="headerlink" title="确保 Scheduler 和 Controller 的高可用"></a>确保 Scheduler 和 Controller 的高可用</h4><p>Leaer Election</p>
<p>Kubernetes 提供基于 ConfigMap 和 Endpoint 的 Leader Election 类库</p>
<p>Kubernetes 采用 Leader Election 模式启动 Component 后，会创建对应 Endpoint，并把当前的 Leader 信息 annotate 到 Endpoint 上</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">control-plane.alpha.kubernetes.io/leader</span><span class="token punctuation">:</span> <span class="token string">'{"holderIdentity":"minikube","leaseDurationSeconds":15,"acquireTime":"2018-04-05T17:31:29Z","renewTime":"2018-04-05T17:31:29Z","leaderTransitions":0}'</span>
    <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token datetime number">2018-04-05T17:31:29Z</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
    <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"138930"</span>
    <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /api/v1/namespaces/kube<span class="token punctuation">-</span>system/endpoints/kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">uid</span><span class="token punctuation">:</span> 2d12578d<span class="token punctuation">-</span>38f7<span class="token punctuation">-</span>11e8<span class="token punctuation">-</span>8df0<span class="token punctuation">-</span><span class="token number">0800275259e5</span>
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span> <span class="token null important">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectrl -n kube-system get ep k8s.io-minikube-hostpath -oyaml
apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="token string">'{"holderIdentity":"minikube_0989f3d2-ce87-471a-a6b6-def44e83738c","leaseDurationSeconds":15,"acquireTime":"2024-05-10T07:34:27Z","renewTime":"2024-05-10T08:07:48Z","leaderTransitions":1}'</span>
    kubectl.kubernetes.io/last-applied-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"v1"</span>,<span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"Endpoints"</span>,<span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"annotations"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"labels"</span>:<span class="token punctuation">{</span><span class="token string">"addonmanager.kubernetes.io/mode"</span><span class="token builtin class-name">:</span><span class="token string">"Reconcile"</span><span class="token punctuation">}</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"k8s.io-minikube-hostpath"</span>,<span class="token string">"namespace"</span><span class="token builtin class-name">:</span><span class="token string">"kube-system"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  creationTimestamp: <span class="token string">"2024-05-07T09:54:02Z"</span>
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
  name: k8s.io-minikube-hostpath
  namespace: kube-system
  resourceVersion: <span class="token string">"221393"</span>
  uid: 2a2100dd-4038-4658-adf7-553bc1c0596c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以通过下面的命令来获取</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get lease
NAME                                   HOLDER                                                                      AGE
apiserver-eqt674mfxb4j56mrjjkoe7b7ii   apiserver-eqt674mfxb4j56mrjjkoe7b7ii_619ab684-7564-4019-ae1f-a44bd256bcce   19m

$ kubectl -n kube-system get lease apiserver-eqt674mfxb4j56mrjjkoe7b7ii -oyaml
apiVersion: coordination.k8s.io/v1
kind: Lease
metadata:
  creationTimestamp: <span class="token string">"2024-05-10T14:53:36Z"</span>
  labels:
    apiserver.kubernetes.io/identity: kube-apiserver
    kubernetes.io/hostname: minikube
  name: apiserver-eqt674mfxb4j56mrjjkoe7b7ii
  namespace: kube-system
  resourceVersion: <span class="token string">"61178"</span>
  uid: f1b44c05-136f-491e-94c9-5bef5da4329a
spec:
  holderIdentity: apiserver-eqt674mfxb4j56mrjjkoe7b7ii_619ab684-7564-4019-ae1f-a44bd256bcce
  leaseDurationSeconds: <span class="token number">3600</span>
  renewTime: <span class="token string">"2024-05-10T15:13:28.775201Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LeaderElection.png" alt="LeaderElection"></p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/kubelet-go-c3b5cf9bbf4b4e3098720f61efb15e0e">kubelet.go</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">NewKubeletCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
kubeletDeps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">UnsecuredDependencies</span><span class="token punctuation">(</span>kubeletServer<span class="token punctuation">,</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  plugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ProbeVolumePlugins</span><span class="token punctuation">(</span>featureGate<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">Run</span><span class="token punctuation">(</span>kubeletServer<span class="token punctuation">,</span> kubeletDeps<span class="token punctuation">,</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  <span class="token function">run</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> featureGate<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
    kubeDeps<span class="token punctuation">.</span>ContainerManager<span class="token punctuation">,</span> err <span class="token operator">=</span> cm<span class="token punctuation">.</span><span class="token function">NewContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// init runtime service(CRI), -container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///var/containerd/containerd.sock</span>
    kubelet<span class="token punctuation">.</span><span class="token function">PreInitRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      remote<span class="token punctuation">.</span><span class="token function">NewRemoteRuntimeService</span><span class="token punctuation">(</span>remoteRuntimeEndpoint<span class="token punctuation">,</span> kubeCfg<span class="token punctuation">.</span>RuntimeRequestTimeout<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
    <span class="token function">RunKubelet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> s<span class="token punctuation">.</span>RunOnce<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      <span class="token function">createAndInitKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        kubelet<span class="token punctuation">.</span><span class="token function">NewMainKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
          <span class="token function">makePodSourceConfig</span><span class="token punctuation">(</span>kubeCfg<span class="token punctuation">,</span> kubeDeps<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> bootstrapCheckpointPath<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            updatechannel <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">Channel</span><span class="token punctuation">(</span>kubetypes<span class="token punctuation">.</span>ApiserverSource<span class="token punctuation">)</span>
          klet <span class="token operator">:=</span> <span class="token operator">&amp;</span>Kubelet<span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token comment">//*******init volume plugins</span>
          runtime<span class="token punctuation">,</span> err <span class="token operator">:=</span> kuberuntime<span class="token punctuation">.</span><span class="token function">NewKubeGenericRuntimeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token function">NewInitializedVolumePluginMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            kvh<span class="token punctuation">.</span>volumePluginMgr<span class="token punctuation">.</span><span class="token function">InitPlugins</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> prober<span class="token punctuation">,</span> kvh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      <span class="token function">startKubelet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        k<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>podCfg<span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
          <span class="token comment">//*******run volume manager, and reconcile function would attach volume for attachable plugin and mount volume</span>
          <span class="token keyword">go</span> kl<span class="token punctuation">.</span>volumeManager<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>kl<span class="token punctuation">.</span>sourcesReady<span class="token punctuation">,</span> wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            vm<span class="token punctuation">.</span>desiredStateOfWorldPopulator<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>sourcesReady<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              populatorLoop<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                dswp<span class="token punctuation">.</span><span class="token function">findAndAddNewPods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  dswp<span class="token punctuation">.</span><span class="token function">processPodVolumes</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> mountedVolumesForPod<span class="token punctuation">,</span> processedVolumesForFSResize<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    mounts<span class="token punctuation">,</span> devices <span class="token operator">:=</span> util<span class="token punctuation">.</span><span class="token function">GetPodVolumeNames</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                    dswp<span class="token punctuation">.</span><span class="token function">createVolumeSpec</span><span class="token punctuation">(</span>podVolume<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> mounts<span class="token punctuation">,</span> devices<span class="token punctuation">)</span>
                    dswp<span class="token punctuation">.</span>desiredStateOfWorld<span class="token punctuation">.</span><span class="token function">AddPodToVolume</span><span class="token punctuation">(</span>uniquePodName<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> volumeSpec<span class="token punctuation">,</span> podVolume<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> volumeGidValue<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      dsw<span class="token punctuation">.</span>volumesToMount<span class="token punctuation">[</span>volumeName<span class="token punctuation">]</span> <span class="token operator">=</span> volumeToMount<span class="token punctuation">{</span><span class="token punctuation">}</span>
            vm<span class="token punctuation">.</span>reconciler<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>	
              <span class="token function">reconciliationLoopFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">// reconcile every 100 ms</span>
                mountAttachVolumes<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  rc<span class="token punctuation">.</span>desiredStateOfWorld<span class="token punctuation">.</span><span class="token function">GetVolumesToMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  rc<span class="token punctuation">.</span>operationExecutor<span class="token punctuation">.</span><span class="token function">AttachVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>	<span class="token comment">// attachable plugin, e.g. 	CSI plugin</span>
                    operationGenerator<span class="token punctuation">.</span><span class="token function">GenerateAttachVolumeFunc</span><span class="token punctuation">(</span>volumeToAttach<span class="token punctuation">,</span> actualStateOfWorld<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  rc<span class="token punctuation">.</span>operationExecutor<span class="token punctuation">.</span><span class="token function">MountVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>  <span class="token comment">// volume need to mount, like ceph, configmap, emptyDir</span>
                    oe<span class="token punctuation">.</span>operationGenerator<span class="token punctuation">.</span><span class="token function">GenerateMapVolumeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      volumePlugin<span class="token punctuation">,</span> err <span class="token operator">:=</span> og<span class="token punctuation">.</span>volumePluginMgr<span class="token punctuation">.</span><span class="token function">FindPluginBySpec</span><span class="token punctuation">(</span>volumeToMount<span class="token punctuation">.</span>VolumeSpec<span class="token punctuation">)</span>
                      volumePlugin<span class="token punctuation">.</span><span class="token function">NewMounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      volumeMounter<span class="token punctuation">.</span><span class="token function">SetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          kl<span class="token punctuation">.</span><span class="token function">syncLoop</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> kl<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
            kl<span class="token punctuation">.</span><span class="token function">syncLoopIteration</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> syncTicker<span class="token punctuation">.</span>C<span class="token punctuation">,</span> housekeepingTicker<span class="token punctuation">.</span>C<span class="token punctuation">,</span> plegCh<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              <span class="token comment">//*******handle pod creation event</span>
              handler<span class="token punctuation">.</span><span class="token function">HandlePodAdditions</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Pods<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                kl<span class="token punctuation">.</span>podManager<span class="token punctuation">.</span><span class="token function">AddPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                kl<span class="token punctuation">.</span><span class="token function">canAdmitPod</span><span class="token punctuation">(</span>activePods<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token comment">// check admit, if admit check fail, it will error out</span>
                kl<span class="token punctuation">.</span><span class="token function">dispatchWork</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> kubetypes<span class="token punctuation">.</span>SyncPodCreate<span class="token punctuation">,</span> mirrorPod<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  kl<span class="token punctuation">.</span>podWorkers<span class="token punctuation">.</span><span class="token function">UpdatePod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    p<span class="token punctuation">.</span><span class="token function">managePodLoop</span><span class="token punctuation">(</span>podUpdates<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      p<span class="token punctuation">.</span><span class="token function">syncPodFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                        kubelet<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token function">syncPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                          runnable <span class="token operator">:=</span> kl<span class="token punctuation">.</span><span class="token function">canRunPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span> <span class="token comment">// check soft admin, pod will be pending if check fails</span>
                          kl<span class="token punctuation">.</span>runtimeState<span class="token punctuation">.</span><span class="token function">networkErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// check network plugin status</span>
                          kl<span class="token punctuation">.</span>containerManager<span class="token punctuation">.</span><span class="token function">UpdateQOSCgroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                          kl<span class="token punctuation">.</span><span class="token function">makePodDataDirs</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                          kl<span class="token punctuation">.</span>volumeManager<span class="token punctuation">.</span><span class="token function">WaitForAttachAndMount</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span>
                          <span class="token punctuation">(</span>kubeGenericRuntimeManager<span class="token punctuation">)</span>kl<span class="token punctuation">.</span>containerRuntime<span class="token punctuation">.</span><span class="token function">SyncPod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                            m<span class="token punctuation">.</span><span class="token function">computePodActions</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> podStatus<span class="token punctuation">)</span> <span class="token comment">// create sandbox container?</span>
                            m<span class="token punctuation">.</span><span class="token function">createPodSandbox</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> podContainerChanges<span class="token punctuation">.</span>Attempt<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                              m<span class="token punctuation">.</span>osInterface<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>podSandboxConfig<span class="token punctuation">.</span>LogDirectory<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
                              <span class="token comment">//*******calling CRI</span>
                              m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">RunPodSandbox</span><span class="token punctuation">(</span>podSandboxConfig<span class="token punctuation">,</span> runtimeHandler<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span><span class="token comment">// k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go</span>
                                c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/RunPodSandbox"</span><span class="token punctuation">)</span> <span class="token comment">// call remote runtime service which is served by containerd</span>
                              <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"init container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                <span class="token function">startContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Containers<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                <span class="token function">startContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                  m<span class="token punctuation">.</span>imagePuller<span class="token punctuation">.</span><span class="token function">EnsureImageExists</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> pullSecrets<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.ImageService/PullImage"</span>
                                  m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">CreateContainer</span><span class="token punctuation">(</span>podSandboxID<span class="token punctuation">,</span> containerConfig<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/CreateContainer"</span><span class="token punctuation">)</span>
                                  m<span class="token punctuation">.</span>internalLifecycle<span class="token punctuation">.</span><span class="token function">PreStartContainer</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> containerID<span class="token punctuation">)</span> <span class="token comment">// set cpu set</span>
                                  m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">StartContainer</span><span class="token punctuation">(</span>containerID<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                                    c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/runtime.v1alpha2.RuntimeService/StartContainer"</span><span class="token punctuation">)</span>

containerd
server<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>service<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
  runtime<span class="token punctuation">.</span><span class="token function">RegisterRuntimeServiceServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> instrumented<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
      s<span class="token punctuation">.</span><span class="token function">RegisterService</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_RuntimeService_serviceDesc<span class="token punctuation">,</span> srv<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
        Handler<span class="token punctuation">:</span>    _RuntimeService_RunPodSandbox_Handler<span class="token punctuation">,</span>	<span class="token comment">// api.pb.go</span>
        srv<span class="token punctuation">.</span><span class="token punctuation">(</span>RuntimeServiceServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RunPodSandbox</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">//"/runtime.v1alpha2.RuntimeService/RunPodSandbox"</span>
          <span class="token function">RunPodSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span> <span class="token comment">// pkg/server/sandbox_run.go</span>
            sandboxstore<span class="token punctuation">.</span><span class="token function">NewSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">ensureImageExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">getSandboxRuntime</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">GetRuntimeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            netns<span class="token punctuation">.</span><span class="token function">NewNetNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">setupPodNetwork</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sandbox<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              c<span class="token punctuation">.</span>netPlugin<span class="token punctuation">.</span><span class="token function">Setup</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                network<span class="token punctuation">.</span><span class="token function">Attach</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  n<span class="token punctuation">.</span>cni<span class="token punctuation">.</span><span class="token function">AddNetworkList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> n<span class="token punctuation">.</span>config<span class="token punctuation">,</span> ns<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>ifName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    c<span class="token punctuation">.</span><span class="token function">addNetwork</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> list<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> list<span class="token punctuation">.</span>CNIVersion<span class="token punctuation">,</span> net<span class="token punctuation">,</span> result<span class="token punctuation">,</span> rt<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span><span class="token comment">// for each network plugin</span>
                      c<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">FindInPath</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Network<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
                      <span class="token function">buildOneConfig</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cniVersion<span class="token punctuation">,</span> net<span class="token punctuation">,</span> prevResult<span class="token punctuation">,</span> rt<span class="token punctuation">)</span>
                      invoke<span class="token punctuation">.</span><span class="token function">ExecPluginWithResult</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pluginPath<span class="token punctuation">,</span> newConf<span class="token punctuation">.</span>Bytes<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> rt<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>exec<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">NewContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>sandboxRootDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>volatileSandboxRootDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">setupSandboxFiles</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
            container<span class="token punctuation">.</span><span class="token function">NewTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> containerdio<span class="token punctuation">.</span>NullIO<span class="token punctuation">,</span> taskOpts<span class="token operator">...</span><span class="token punctuation">)</span>
            task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
              c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">TaskService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                s<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                  l<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                  rtime<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ContainerID<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                    b <span class="token operator">:=</span> <span class="token function">shimBinary</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Runtime<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>containerdTTRPCAddress<span class="token punctuation">,</span> m<span class="token punctuation">.</span>events<span class="token punctuation">,</span> m<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span>
                    b<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    shim<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;&gt;</span>
                      c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"containerd.task.v2.Task"</span><span class="token punctuation">,</span> <span class="token string">"Create"</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">)</span>

  runtime<span class="token punctuation">.</span><span class="token function">RegisterImageServiceServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> instrumented<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="kubelet-架构"><a href="#kubelet-架构" class="headerlink" title="kubelet 架构"></a>kubelet 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet架构.png" alt="kubelet架构"></p>
<h4 id="kubelet-管理-Pod-的核心流程"><a href="#kubelet-管理-Pod-的核心流程" class="headerlink" title="kubelet 管理 Pod 的核心流程"></a>kubelet 管理 Pod 的核心流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet管理Pod的核心流程.png" alt="kubelet管理Pod的核心流程"></p>
<h4 id="kubelet-1"><a href="#kubelet-1" class="headerlink" title="kubelet"></a>kubelet</h4><p>每个节点上都运行一个 kubelet 服务进程，默认监听 10250 端口。</p>
<ul>
<li>接收并执行 master 发来的指令</li>
<li>管理 Pod 及 Pod 中的容器</li>
<li>每个 kubelet 进程会在 API Server 上注册节点自身信息，定期向 master 节点汇报节点的资源使用情况，并通过 cAdvisor 监控节点和容器的资源</li>
</ul>
<h4 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h4><p>节点管理主要是节点自注册和节点状态更新：</p>
<ul>
<li>kubelet 可以通过设置启动参数 <code>--register-node</code> 来确定是否向 API Server 注册自己</li>
<li>如果 kubelet 没有选择自注册模式，则需要用户自己配置 Node 资源信息，同时需要告知 kubelet 集群上的 API Server 的位置</li>
<li>kubelet 在启动时通过 API Server 注册节点信息，并定时向 API Server发送节点新消息，API Server 在接收到新消息后，将信息写入 etcd</li>
</ul>
<h4 id="Pod-管理"><a href="#Pod-管理" class="headerlink" title="Pod 管理"></a>Pod 管理</h4><p>获取 Pod 清单：</p>
<ul>
<li>文件：启动参数 <code>--config</code> 指定的配置目录下的文件（默认 <code>/etc/kubernetes/manifests</code>）。该文件每 20 秒重新检查一次（可配置）</li>
<li>HTTP endpoint（URL）：启动参数 <code>--manifest-url</code> 设置。每 20 秒检查一次这个端点（可配置）</li>
<li>API Server：通过 API Server 监听 etcd 目录，同步 Pod 清单</li>
<li>HTTP Server：kubelet 侦听 HTTP 请求，并响应简单的 API 以提交新的 Pod 清单</li>
</ul>
<h4 id="Pod-启动流程"><a href="#Pod-启动流程" class="headerlink" title="Pod 启动流程"></a>Pod 启动流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod启动流程.png" alt="Pod启动流程"></p>
<p>图中 RunPodSandbox 中 Sandbox 的意义：和 pause contain 有关。pod 不是直接启动的，而是先使用 pause 镜像启动 sandbox container 并设置好（共享 net、pid 等）后，再启动用户定义的 container。</p>
<h4 id="kubelet-启动-Pod-的流程"><a href="#kubelet-启动-Pod-的流程" class="headerlink" title="kubelet 启动 Pod 的流程"></a>kubelet 启动 Pod 的流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet启动Pod的流程.png" alt="kubelet启动Pod的流程"></p>
<h3 id="CRI"><a href="#CRI" class="headerlink" title="CRI"></a>CRI</h3><p>容器运行时（Container Runtime），运行于 Kubernetes（k8s）集群的每个节点中，负责容器的整个生命周期。其中 Docker 是目前应用最广的。随着容器云的发展，越来越多的容器运行时涌现。为了解决这些容器运行时和 Kubernetes 的集成问题，在 Kubernetes 1.5 版本中，社区推出了 CRI（Container Runtime Interface，容器运行时接口）以支持更多的容器运行时。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI.png" alt="CRI"></p>
<p>CRI 是 Kubernetes 定义的一组 gRPC 服务。kubelet 作为客户端，基于 gRPC 框架，通过 Socket 和容器运行时通信。它包括两类服务：镜像服务（Image Service）和运行时服务（Runtime Service）。镜像服务提供下载、检查和删除镜像的远程程序调用。运行时服务包括用于管理容器生命周期，以及与容器交互的调用（exec / attach / port-forward）的远程程序调用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI2.png" alt="CRI2"></p>
<h4 id="运行时的层级"><a href="#运行时的层级" class="headerlink" title="运行时的层级"></a>运行时的层级</h4><p>Dockershim，containerd 和 CRI-O 都是遵循 CRI 的容器运行时，我们称他们为 <strong>高层级运行时（High-Level Runtime）</strong> 。</p>
<p>OCI（Open Container Initiative，开发容器计划）定义了创建容器的格式和运行时的开源行业标准，包括镜像规范（Image Specification）和运行时规范（Runtime Specification）。</p>
<p>镜像规范定义了 OCI 镜像的标准。高层级运行时将会下载一个 OCI 镜像，并把它解压成 OCI 运行时文件系统包（filesystem bundle）。</p>
<p>运行时规范则描述了如何从 OCI 运行时文件系统包运行容器，并定义它的配置、运行环境和生命周期。如何为新容器设置命名空间（namespaces）和控制组（cgroups），以及挂载根文件系统等等操作，都是在这里定义的。它的一个参考实现就 runC。我们称其为 <strong>低层级运行时（Low-Level Runtime）</strong>。除 runC 以外，也有以后很多其他的运行时遵循 OCI 标准，例如 kata-runtime。</p>
<h4 id="CRI-1"><a href="#CRI-1" class="headerlink" title="CRI"></a>CRI</h4><p>容器运行时是真正起删和管理容器的组件。容器运行时可以分为高层和低层的运行时。高层运行时主要包括 Docker、containerd 和 CRI-O，低层的运行时，包含了 runC，kata 和 gVisor。低层运行时 kata 和 gVisor 都还处于小规模落地或者实验阶段，其生态成熟度和使用案例都比较欠缺，所以除非有特殊的需求，否则 runC 几乎是必然的选择。因此在对容器运行时的选择上，主要是聚焦于上层运行时的选择。</p>
<p>Docker 内部关于容器运行时功能的核心组件是 containerd，后来 containerd 也可以直接和 kubelet 通过 CRI 对接，独立在 Kubernetes 中使用。相对 Docker 而言，containerd 减少了 Docker 所需的处理模块 Dockerd 和 Docker-shim，并且对 Docker 支持的存储驱动进行了优化，因此在容器的创建启动停止和删除，以及对镜像的拉取上，都具有性能上的优势。架构的简化同时也带来了维护的便利。当然 Docker 也具有很多 containerd 不具有的功能，例如支持 zfs 存储驱动，支持对日志的大小和文件限制，在以 overlayfs2 做存储驱动的情况下，可以通过 xfs_quota 来对容器的可写层进行大小限制等。尽管如此，containerd 目前也基本上能够满足容器的众多管理需求，所以将它作为运行时的也越来越多。</p>
<p>kubelet 和运行时的关系：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kubelet和运行时的关系.png" alt="kubelet和运行时的关系"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CRI3.png" alt="CRI3"></p>
<h4 id="开源运行时的比较"><a href="#开源运行时的比较" class="headerlink" title="开源运行时的比较"></a>开源运行时的比较</h4><p>Docker 的多层封装和调用，导致其在可维护性上略逊一筹，增加了线上问题的定位难度；几乎除了重启 Docker，我们就毫无他法了。</p>
<p>containerd 和 CRI-O 的方案比起 Docker 简洁很多。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/开源运行时的比较.png" alt="开源运行时的比较"></p>
<h4 id="Docker-和-containerd-的差异细节"><a href="#Docker-和-containerd-的差异细节" class="headerlink" title="Docker 和 containerd 的差异细节"></a>Docker 和 containerd 的差异细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Docker和containerd的差异细节.png" alt="Docker和containerd的差异细节"></p>
<blockquote>
<p>将 runtime 从 docker 切换到 containerd <a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/cri/docker2containerd.md">https://github.com/kibaamor/101/blob/master/module7/cri/docker2containerd.md</a></p>
</blockquote>
<h4 id="多种运行时性能比较"><a href="#多种运行时性能比较" class="headerlink" title="多种运行时性能比较"></a>多种运行时性能比较</h4><p>containerd 在各个方面都表现良好，除了启动容器这项。从总用时来看，containerd 的用时还是要比 CRI-O 要短的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多种运行时性能比较.png" alt="多种运行时性能比较"></p>
<h4 id="运行时优劣对比"><a href="#运行时优劣对比" class="headerlink" title="运行时优劣对比"></a>运行时优劣对比</h4><ol>
<li>功能性来讲，containerd 和 CRI-O 都符合 CRI 和 OCI 的标准</li>
<li>在稳定性上，containerd 略胜一筹</li>
<li>从性能上讲，containerd 胜出</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/运行时优劣对比.png" alt="运行时优劣对比"></p>
<h3 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h3><p><a target="_blank" rel="noopener" href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-2-a07f5bf0ff14">https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-2-a07f5bf0ff14</a></p>
<p>Kubernetes 网络模型设计的基础原则是：</p>
<ul>
<li>所有的 Pod 能够不通过 NAT 就能相互访问</li>
<li>所有的节点能够不通过 NAT 就能相互访问</li>
<li>容器内看见的 IP 地址和外部组件看到的容器 IP 是一样的</li>
</ul>
<p>Kubernetes 的集群里，IP 地址是以 Pod 为单位进行分配的，每个 Pod 都拥有一个独立的 IP 地址。一个 Pod 内部的所有容器共享一个网络栈，即宿主机上的一个网络命名空间，包括它们的 IP 地址、网络设备、配置等都是共享的。也就是说，Pod 里面的所有容器都能通过 <code>localhost:port</code> 来连接对方。在 Kubernetes 中，提供一个轻量的通用容器网络接口 CNI（Container Network Interface），专门用于设置和删除容器的网络连通性。容器运行时通过 CNI 调用网络插件来完成容器的网络设置。</p>
<h4 id="CNI-插件分类和常见插件"><a href="#CNI-插件分类和常见插件" class="headerlink" title="CNI 插件分类和常见插件"></a>CNI 插件分类和常见插件</h4><p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins">https://github.com/containernetworking/plugins</a></p>
<ul>
<li>IPAM（IP Allocation Manager）：IP 地址分配</li>
<li>主插件：网卡设置<ul>
<li>bridge：创建一个网桥，并把主机端口和容器端口插入网桥</li>
<li>ipvlan：为容器添加 ipvlan 网口</li>
<li>loopback：设置 loopback 网口</li>
</ul>
</li>
<li>Meta：附加功能<ul>
<li>portmap：设置主机端口和容器端口映射</li>
<li>bandwidth：利用 Linux Traffic Control 限流</li>
<li>firewall：通过 iptables 或 firewalld 为容器设置防火墙规则</li>
</ul>
</li>
</ul>
<h4 id="CNI-插件运行时机制"><a href="#CNI-插件运行时机制" class="headerlink" title="CNI 插件运行时机制"></a>CNI 插件运行时机制</h4><p>容器运行时在启动时会从 CNI 的配置目录中读取 Json 格式的配置文件，文件后缀为 “.conf”, “.conflist” 或 “.json”。如果配置目录中包含多个文件，一般情况下，会以名字排序选用第一个配置文件作为默认的网络配置，并加载获取其中指定的 CNI 插件名称和配置参数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件运行时机制.png" alt="CNI插件运行时机制"></p>
<h4 id="CNI-的运行机制"><a href="#CNI-的运行机制" class="headerlink" title="CNI 的运行机制"></a>CNI 的运行机制</h4><p>关于容器网络管理，容器运行时一般需要配置两个参数 <code>--cni-bin-dir</code> 和 <code>--cni-conf-dir</code>。有一种特殊情况，kubelet 内置的 Docker 作为容器运行时，是由 kubelet 来查找 CNI 插件的，运行插件来为容器设置网络，这两个参数应该配置在 kubelet 处：</p>
<ul>
<li><code>cni-bin-dir</code>：网络插件的可执行文件所在的目录。默认是<code>/opt/cni/bin</code>。</li>
<li><code>cni-conf-dir</code>：网络插件的配置文件所在目录。默认是<code>/etc/cni/net.d</code>。</li>
</ul>
<h4 id="CNI-插件设计考量"><a href="#CNI-插件设计考量" class="headerlink" title="CNI 插件设计考量"></a>CNI 插件设计考量</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件设计考量.png" alt="CNI插件设计考量"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNI插件设计考量2.png" alt="CNI插件设计考量2"></p>
<h4 id="打通主机层网络"><a href="#打通主机层网络" class="headerlink" title="打通主机层网络"></a>打通主机层网络</h4><p>CNI 插件外，Kubernetes 还需要标准的 CNI 插件 lo，最低版本为 0.2.0 版本。网络插件除支持设置和清理 Pod 网络接口外，该插件还需要支持 Iptables。如果 kube-proxy 工作在 Iptables 模式，网络插件需要确保容器流量能使用 Iptables 转发。例如，如果网络插件将容器连接到 Linux 网桥，必须将 <code>net/bridge/bridge-nf-call-iptables</code> 参数 sysctl 设置为 1，网桥上数据包将遍历 Iptables 规则。如果插件不使用 Linux 桥接器（而是类似 Open vSwitch 或其他某种机制的插件），则赢确保容器流量被正确设置了路由。</p>
<h4 id="CNI-Plugin"><a href="#CNI-Plugin" class="headerlink" title="CNI Plugin"></a>CNI Plugin</h4><p>ContainerNetworking 组维护了一些 CNI 插件，包括网络接口创建的 bridge、ipvlan、loopback、macvlan、ptp、host-device 等，IP 地址分配的 DHCP、host-local 和 static，其他的 Flannel、tunning、portmap、firewall 等。</p>
<p>社区还有些第三方网络策略方面的插件，例如 Calico、Cilium 和 Weave 等。可用选项的多样性意味着大多数用户将能够找到适合当前需求和部署环境的 CNI 插件，并在情况变化时迅捷转换解决方案。</p>
<blockquote>
<p>目前最有前景的是 <a target="_blank" rel="noopener" href="https://github.com/cilium/cilium">https://github.com/cilium/cilium</a></p>
</blockquote>
<h4 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h4><p>Flannel 是由 CoreOS 开发的项目，是 CNI 插件早起的入门产品，简单易用。</p>
<p>Flannel 使用 Kubernetes 集群的现有 etcd 集群来存储其状态信息，从而不必提供专用的数据存储，只需要在每个节点上运行 flanneld 来守护进程。</p>
<p>每个节点都被分配一个子网，为该节点上的 Pod 分配 IP 地址。</p>
<p>同一个主机内的 Pod 可以使用网桥进行通信，而不同主机上的 Pod 将通过 flanneld 将其流量封装在 UDP 数据包中，以路由到适当的目的地。</p>
<p>封装方式默认和推荐的方法是使用 VXLAN，因为它具有良好的性能，并且比其他选项要少些人为干预。虽然使用 VXLAN 之类的技术封装的解决方案效果很好，但缺点就是该过程使流量跟踪变得困难。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FlannelPlugin.png" alt="FlannelPlugin"></p>
<h4 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h4><p>Calico 以其性能、灵活性和网络策略而闻名，不仅涉及在主机和 Pod 之间提供网络连接，而且还涉及网络安全性和策略管理。</p>
<p>对于同网段通信，基于第 3 层，Calico 使用 BGP 路由协议在主机之间路由数据包，使用 BGP 路由协议也意味着数据包在主机之间移动时不需要包装在额外的封装层中。</p>
<p>对于跨网段通信，基于 IPinIP 使用虚拟网卡设备 tunl0，用一个 IP 数据包封装另一个 IP 数据包，外层 IP 数据包头的源地址为隧道入口设置的 IP 地址，目标地址为隧道出口设备的 IP 地址。</p>
<p>网络策略是 Calico 最受欢迎的功能之一，使用 ACLs 协议和 kube-proxy 来创建 iptables 过滤规则，从而实现隔离容器网络的目的。</p>
<p>此外，Calico 还可以与服务网格 Istio 集成，在服务网格层和网络基础结构层上解释和实施集群中工作负载的策略。这意味着你可以配置功能强大的规则，以描述 Pod 应该如何发送和接收流量，提高安全性及加强网络环境的控制。</p>
<p>Calico 属于完全分布式的横向扩展结构，允许开发人员和管理员快速和平稳地扩展部署规模。对于性能和功能（如网络策略）要求高的环境，Calico 是一个不错的选择。</p>
<h5 id="Calico-组件"><a href="#Calico-组件" class="headerlink" title="Calico 组件"></a>Calico 组件</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Calico组件.png" alt="Calico组件"></p>
<h5 id="Calico-初始化"><a href="#Calico-初始化" class="headerlink" title="Calico 初始化"></a>Calico 初始化</h5><p>配置和 CNI 二进制文件由 initContainer 推送</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> /opt/cni/bin/install
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_CONF_NAME
    <span class="token key atrule">value</span><span class="token punctuation">:</span> 10<span class="token punctuation">-</span>calico.conflist
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SLEEP
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NET_DIR
    <span class="token key atrule">value</span><span class="token punctuation">:</span> /etc/cni/net.d
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NETWORK_CONFIG
    <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
      <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> config
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_HOST
    <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.96.0.1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_PORT
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/calico/cni<span class="token punctuation">:</span>v3.20.1
  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Calico-配置一览"><a href="#Calico-配置一览" class="headerlink" title="Calico 配置一览"></a>Calico 配置一览</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">{</span>
  <span class="token key atrule">"name"</span><span class="token punctuation">:</span> <span class="token string">"k8s-pod-network"</span><span class="token punctuation">,</span>
  <span class="token key atrule">"cniVersion"</span><span class="token punctuation">:</span> <span class="token string">"0.3.1"</span><span class="token punctuation">,</span>
  <span class="token key atrule">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"datastore_type"</span><span class="token punctuation">:</span> <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"mtu"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token key atrule">"nodename_file_optional"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span>
      <span class="token key atrule">"log_level"</span><span class="token punctuation">:</span> <span class="token string">"Info"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"log_file_path"</span><span class="token punctuation">:</span> <span class="token string">"/var/log/calico/cni/cni.log"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"ipam"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico-ipam"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"assign_ipv4"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"asign_ipv6"</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"container_settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"allow_ip_forwarding"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"policy"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"k8s"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token key atrule">"kubernetes"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"k8s_api_root"</span><span class="token punctuation">:</span> <span class="token string">"https://10.96.0.1:443"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"kubeconfig"</span><span class="token punctuation">:</span> <span class="token string">"/etc/cni/net.d/calico-kubeconfig"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"bandwidth"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"bandwidth"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"portmap"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"snat"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
      <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"portMappings"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Calico-VXLAN"><a href="#Calico-VXLAN" class="headerlink" title="Calico VXLAN"></a>Calico VXLAN</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CalicoVXLAN.png" alt="CalicoVXLAN"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/cni/data-path.MD">https://github.com/kibaamor/101/blob/master/module7/cni/data-path.MD</a></p>
<h6 id="IPPool"><a href="#IPPool" class="headerlink" title="IPPool"></a>IPPool</h6><p>IPPool 用来定义一个集群的预定义 IP 段</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>ipv4<span class="token punctuation">-</span>ippool
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">blockSize</span><span class="token punctuation">:</span> <span class="token number">26</span> <span class="token comment"># 每个节点分多少个IP</span>
  <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 192.168.0.0/16
  <span class="token key atrule">ipipMode</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">natOutgoing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
  <span class="token key atrule">vxlanMode</span><span class="token punctuation">:</span> CrossSubnet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="IPAMBlock"><a href="#IPAMBlock" class="headerlink" title="IPAMBlock"></a>IPAMBlock</h5><p>IPAMBlock 用来定义每个主机预分配的 IP 段</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPAMBlock
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>119<span class="token punctuation">-</span>64<span class="token punctuation">-</span><span class="token number">26</span> <span class="token comment"># 最后的 26 就是 IPPool 里的 blockSize</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> host<span class="token punctuation">:</span>cadmin
  <span class="token key atrule">allocations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token null important">null</span>
  <span class="token punctuation">-</span> <span class="token number">0</span>
  <span class="token punctuation">-</span> <span class="token null important">null</span>
  <span class="token punctuation">-</span> <span class="token number">1</span>
  <span class="token punctuation">-</span> <span class="token number">2</span>
  <span class="token punctuation">-</span> <span class="token number">3</span>
  <span class="token key atrule">attributes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> vxlan<span class="token punctuation">-</span>tunnel<span class="token punctuation">-</span>addr<span class="token punctuation">-</span>cadmin
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">type</span><span class="token punctuation">:</span> vxlanTunnelAddress
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.6680d3883d6150e75ffbd031f86c689a97a5be0f260c6442b2bb46b567c2ca40
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>apiserver
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">pod</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>apisever<span class="token punctuation">-</span>77dffffcdf<span class="token punctuation">-</span>g2tcx
      <span class="token key atrule">timestamp</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>30 09<span class="token punctuation">:</span>46<span class="token punctuation">:</span>57.45651816 +0000 UTC
  <span class="token punctuation">-</span> <span class="token key atrule">handle_id</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.b10d7702bf334fc55a5e399a731ab3201ea9990a1e3bc79894abddd712646699
    <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>system
      <span class="token key atrule">node</span><span class="token punctuation">:</span> cadmin
      <span class="token key atrule">pod</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers<span class="token punctuation">-</span>bdd5f97c5<span class="token punctuation">-</span>554z5
      <span class="token key atrule">timestamp</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>30 09<span class="token punctuation">:</span>46<span class="token punctuation">:</span>57.502351346 +0000 UTC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="IPAMHandle"><a href="#IPAMHandle" class="headerlink" title="IPAMHandle"></a>IPAMHandle</h5><p>IPAMHandle 用来记录 IP 分配的具体细节（每个 Pod 一个）</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> crd.projectcalico.org/v1kind<span class="token punctuation">:</span>IPAMHandle
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  name<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.8d756941d85c4998016b72c83f9c5a75512c82c052357daf0ec8e67365635d93
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">block</span><span class="token punctuation">:</span>
    192.168.119.64/26<span class="token punctuation">:</span><span class="token number">1</span>
  deleted<span class="token punctuation">:</span><span class="token boolean important">false</span>
  handlelD<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>network.8d75b941d85c4998016b72c83f9c5a75512c82c052357daf0ec8e67365635d93<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建-Pod-并查看-IP-配置情况"><a href="#创建-Pod-并查看-IP-配置情况" class="headerlink" title="创建 Pod 并查看 IP 配置情况"></a>创建 Pod 并查看 IP 配置情况</h5><p>容器 namespace</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ nsenter -t <span class="token number">720702</span> -n <span class="token function">ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
        valid lft forever preferred lft forever
<span class="token number">3</span>: ethO@if27: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER UP<span class="token operator">&gt;</span> mtu <span class="token number">1450</span> gdisc noqueue state UP groupdefault
    link/ether f2:86:d2:4f:1f:30 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet192.168.119.84/32 brd <span class="token number">192.168</span>.119.84 scope global eth0
      valid lft forever preferred lft forever

$ nsenter -t <span class="token number">720702</span>-n <span class="token function">ip</span> r
default via <span class="token number">169.254</span>.1.1 dev eth0
<span class="token number">169.254</span>.1.1 dev eth0 scope <span class="token function">link</span>

$ nsenter -t <span class="token number">720702</span> -n arp
Address     HWtype HWaddress            Flags Mask  Iface
<span class="token number">169.254</span>.1.1 ether  ee:ee:ee:ee:ee:ee    C           eth0
<span class="token number">10.0</span>.2.15   ether  ee:ee:ee:ee:ee:ee    C           eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主机 namespace</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> <span class="token function">link</span>
<span class="token number">27</span>: cali23a582ef038@if3:<span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER UP<span class="token operator">&gt;</span>mtu <span class="token number">1450</span> qdiscnoqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">9</span>
    inet6 fe80::ecee:eeff:feee:eeee/64 scope <span class="token function">link</span>
        valid lft forever preferred lft forever
        
$ <span class="token function">ip</span> route
<span class="token number">192.168</span>.119.84 dev cali23a582ef038scope <span class="token function">link</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CNI-Plugin-的对比"><a href="#CNI-Plugin-的对比" class="headerlink" title="CNI Plugin 的对比"></a>CNI Plugin 的对比</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CNIPlugin的对比.png" alt="CNIPlugin的对比"></p>
<h3 id="CSI"><a href="#CSI" class="headerlink" title="CSI"></a>CSI</h3><h4 id="容器运行时存储"><a href="#容器运行时存储" class="headerlink" title="容器运行时存储"></a>容器运行时存储</h4><blockquote>
<p>容器运行时存储不建议写数据，甚至不建议写日志，它基于 OverlayFS ，它的主要目的是挂载 rootfs 以启动容器，读写性能其实不高。需要写数据时应该外挂存储。</p>
</blockquote>
<ul>
<li>除外挂存储卷外，容器启动后，运行时所需文件系统性能直接影响容器性能</li>
<li>早起的 Docker 采用 Device Mapper 作为容器运行时存储驱动，因为 OverlayFS 尚未合并进 Kernel</li>
<li>目前 Docker 和 containerd 都默认以 OverlayFS 作为运行时存储驱动</li>
<li>OverlayFS 目前已经有非常好的性能，与 DeviceMapper 相比优 20%，与操作主机文件性能几乎一致</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/容器运行时存储.png" alt="容器运行时存储"></p>
<h4 id="存储卷插件管理"><a href="#存储卷插件管理" class="headerlink" title="存储卷插件管理"></a>存储卷插件管理</h4><p>Kubernetes 支持以插件的形式来实现对不同存储的支持和扩展，这些扩展基于如下三种方式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/存储卷插件管理.png" alt="存储卷插件管理"></p>
<h4 id="out-of-tree-CSI-插件"><a href="#out-of-tree-CSI-插件" class="headerlink" title="out-of-tree CSI 插件"></a>out-of-tree CSI 插件</h4><p>CSI 通过 RPC 与存储驱动进行交互</p>
<p>在设计 CSI 的时候，Kubernetes 对 CSI 存储驱动和打包和部署要求很少，主要定义了 Kubernetes 的两个相关模块：</p>
<ul>
<li>kube-controller-manager:<ul>
<li>kube-controller-manager 模块用于感知 CSI 驱动存在</li>
<li>Kubernetes 的主控模块通过 Unix domain socket（而不是 CSI 驱动）或者其他方式进行直接地交互</li>
<li>Kubernetes 的主控模块只与 Kubernetes 相关的 API 进行交互</li>
<li>因此 CSI 驱动若有依赖于 Kubernetes API 的操作，例如卷的创建、卷的 attach、卷的快照等，需要在 CSI 驱动里面通过 Kubernetes 的 API，来触发相关的 CSI 操作</li>
</ul>
</li>
<li>kubelet：<ul>
<li>kubelet 模块用于与 CSI 驱动进行交互</li>
<li>kubelet 通过 Unix domain socket 向 CSI 驱动发起 CSI 调用（如 NodeStageVolume、NodePublishVolume 等），再发起 mount 卷和 umount 卷</li>
<li>kubelet 通过插件注册机制发现 CSI 驱动及用于和 CSI 驱动交互的 Unix Domain Socket</li>
<li>所有部署在 Kubernetes 集群中的 CSI 驱动都要通过 kubelet 的插件注册机制来注册自己</li>
</ul>
</li>
</ul>
<h4 id="CSI-驱动"><a href="#CSI-驱动" class="headerlink" title="CSI 驱动"></a>CSI 驱动</h4><p>CSI 的驱动一般包含 external-attacker、external-provisioner、external-resizer、external-snapshotter、node-driver-register、CSI driver 等模块，可以根据实际的存储类型和需求进行不同方式的部署。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CSI驱动.png" alt="CSI驱动"></p>
<h4 id="临时存储"><a href="#临时存储" class="headerlink" title="临时存储"></a>临时存储</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/emptydir/emptydir.yaml">https://github.com/kibaamor/101/blob/master/module7/csi/emptydir/emptydir.yaml</a></p>
<p>常见的临时存储主要就是 emptyDir 卷。</p>
<p>emptyDir 是一种经常被用户使用的卷类型，顾名思义，”卷”最初是空的。当 Pod 从节点上删除时，emptyDir 卷中的数据也会被永久删除。但当 Pod 的容器因为某些原因退出再重启时，emptyDir 卷内的数据并不会丢失。</p>
<p>默认情况下，emptyDir 卷存储在支持该节点所使用的存储介质上，可以是本地磁盘或者网络存储。</p>
<p>emptyDir 也可以通过将 emptyDir.medium 字段设置为 “Memory” 来通知 Kubernetes 为容器安装 tmpfs，此时数据被存储在内存中，速度相对于本地存储和网络存储快很多。但是在节点重启的时候，内存数据会被清楚；而如果存在磁盘上，则重启后数据依然存在。另外，使用 tmpfs 的内存也会计入容器的使用内存总量中，受系统的 cgroup 限制。</p>
<p>emptyDir 设计的初衷主要是给应用充当缓存空间，或者存储中间数据，用于快速恢复。然而，这并不是说满足以上需求的用户都被推荐使用 emptyDir，我们要根据用户业务的实际特点来判断是否使用 emptyDir。因为 emptyDir 的空间位于系统根盘，被所有容器共享，所以在磁盘的使用率较高时会触发 Pod 的 eviction 操作，从而影响业务的稳定。</p>
<h4 id="半持久化存储"><a href="#半持久化存储" class="headerlink" title="半持久化存储"></a>半持久化存储</h4><p>常见的半持久化存储主要是 hostPath 卷。hostPath 卷能将主机节点文件系统上的文件或目录挂载到指定 Pod 中。对普通用户而言一般不需要这样的卷，但是对很多需要获取节点系统信息的 Pod 而言，却是非常必要的。</p>
<p>例如，hostPath 的用法举例如下:</p>
<ul>
<li>某个 Pod 需要获取节点上所有 Pod 的 log，可以通过 hostPath 访问所有 Pod 的 stdout 输出存储目录，例如 /var/log/pods 路径。</li>
<li>某个 Pod 需要统计系统相关的信息，可以通过 hostPath 访问系统的 /proc 目录。</li>
</ul>
<p>使用 hostPath 的时候，除设置必需的 path 属性外，用户还可以有选择性地为 hostPath 卷指定类型支持类型包含目录、字符设备、块设备等。</p>
<h5 id="hostPath-卷需要注意"><a href="#hostPath-卷需要注意" class="headerlink" title="hostPath 卷需要注意"></a>hostPath 卷需要注意</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/hostpath/readme.MD">https://github.com/kibaamor/101/blob/master/module7/csi/hostpath/readme.MD</a></p>
<p>使用同一个目录的 Pod 可能会由于调度到不同的节点，导致目录中的内容有所不同。</p>
<p>Kubernetes 在调度时无法顾及由 hostPath 使用的资源。</p>
<p>Pod被删除后，如果没有特别处理，那么hostPath上写的数据会遗留到节点上，占用磁盘空间。</p>
<h4 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h4><p>支持持久化的存储是所有分布式系统所必备的特性。针对持久化存储，Kubernetes 引入了 StorageClass、Volume、PVC（Persistent Volume Claim）、PV（Persitent Volume）的概念，将存储独立于 Pod 的生命周期来进行管理。</p>
<p>Kuberntes 目前支持的持久化存储包含各种主流的块存储和文件存储，譬如 awsElasticBlockStore、azureDisk、cinder、NFS、cephfs、iscsi 等，在大类上可以将其分为网络存储和本地存储两种类型。</p>
<h5 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h5><p>StorageClass 用于指示存储的类型，不同的存储类型可以通过不同的 StorageClass 来为用户提供服务。</p>
<p>StorageClass 主要包含存储插件 provisioner、卷的创建和 mount 参数等字段。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Storageclass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterlD</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/controller-expand-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/fstype</span><span class="token punctuation">:</span> ext4
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>node
  <span class="token key atrule">csi.storage.k8s.io/node-stage-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">csi.storage.k8s.io/provisioner-secret-namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">imageFeatures</span><span class="token punctuation">:</span> layering
  <span class="token key atrule">imageFormat</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">provisioner</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Delete
  <span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> immediate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h5><p>由用户创建，代表用户对存储需求的声明，主要包含需要的存储大小、存储卷的访问模式、StroageClass 等类型，其中存储卷的访问模式必须与存储的类型一致</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PVC.png" alt="PVC"></p>
<h5 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h5><p>由集群管理员提前创建，或者根据 PVC 的申请需求动态地创建，它代表系统后端的真实的存储空间，可以称之为卷空间。</p>
<h5 id="存储对象关系"><a href="#存储对象关系" class="headerlink" title="存储对象关系"></a>存储对象关系</h5><p>用户通过创建 PVC 来申请存储。控制器通过 PVC 的 StorageClass 和请求的大小声明来存储后端创建卷，进而创建 PV，Pod 通过指定 PVC 来引用存储。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/存储对象关系.png" alt="存储对象关系"></p>
<h4 id="独占的-Local-Volume"><a href="#独占的-Local-Volume" class="headerlink" title="独占的 Local Volume"></a>独占的 Local Volume</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/独占的LocalVolume.png" alt="独占的LocalVolume"></p>
<ul>
<li>创建 PV：通过 local-volume-provisioner Daemonset 创建本地存储的 PV。</li>
<li>创建 PVC：用户创建 PVC，由于它处于 pending 状态，所以 kube-controller-manager 并不会对该 PVC 做任何操作。</li>
<li>创建 Pod：用户创建 Pod。</li>
<li>Pod 挑选节点：kube-scheduler 开始调度 Pod，通过 PVC 的 <code>resources.request.storage</code> 和 <code>volumeMode</code> 选择满足条件的 PV，并且为 Pod 选择一个合适的节点。</li>
<li>更新 PV：kube-scheduler 将 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC，并且设置 annotation <code>pv.kubernetes.io/bound-by-controller</code> 的值为 <code>yes</code>。</li>
<li>PVC 和 PV 绑定：pv_controller 同步 PVC 和 PV 的状态，并将 PVC 和 PV 进行绑定。</li>
<li>监听 PVC 对象：kube-scheduler 等待 PVC 的状态变成 Bound 状态。</li>
<li>Pod 调度到节点：如果 PVC 的状态变为 Bound 则说明调度成功，而如果 PVC一直处于 pending 状态，超时后会再次进行调度。</li>
<li>Mount 卷启动容器：kubelet监听到有 Pod 已经调度到节点上，对本地存储进行 mount 操作，并启动容器。</li>
</ul>
<h4 id="Dynamic-Local-Volume"><a href="#Dynamic-Local-Volume" class="headerlink" title="Dynamic Local Volume"></a>Dynamic Local Volume</h4><p>CSI 驱动需要汇报节点上相关存储的资源信息，以便用于调度但是机器的厂家不同，汇报方式也不同。</p>
<p>例如，有的厂家的机器节点上具有 NVMe、SSD、HDD 等多种存储介质，希望将这些存储介质分别进行汇报。</p>
<p>这种需求有别于其他存储类型的 CSI 驱动对接口的需求，因此如何汇报节点的存储信息，以及如何让节点的存储信息应用于调度，目前并没有形成统一的意见。</p>
<p>集群管理员可以基于节点存储的实际情况对开源 CSI 驱动和调度进行一些代码修改，再进行部署和使用。</p>
<h5 id="Local-Dynamic-的挂载流程"><a href="#Local-Dynamic-的挂载流程" class="headerlink" title="Local Dynamic 的挂载流程"></a>Local Dynamic 的挂载流程</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/LocalDynamic的挂载流程.png" alt="LocalDynamic的挂载流程"></p>
<ul>
<li>创建 PVC：用户创建 PVC，PVC 处于 pending 状态。</li>
<li>创建 Pod：用户创建 Pod。</li>
<li>Pod 选择节点：kube-scheduler 开始调度 Pod，通过 PVC 的 <code>pvc.spec.resources.request.storage</code> 等选择满足条件的节点。</li>
<li>更新 PVC：选择节点后，kube-scheduler 会给 PVC 添加包含节点信息的 annotation：<code>volume.kubernetes.io/selected-node:&lt;节点名字&gt;</code>。</li>
<li>创建卷：运行在节点上的容器 external-provisioner 监听到 PVC 带有该节点相关的 annotation，向相应的 CSI 驱动申请分配卷。</li>
<li>创建 PV：PVC 申请到所需的存储空间后，external-provisione 创建 PV，该 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC。</li>
<li>PVC 和 PV 绑定：kube-controller-manager 将 PVC 和 PV 进行绑定，状态修改为 Bound。</li>
<li>监听 PVC 状态：kube-scheduler 等待 PVC 变成 Bound 状态</li>
<li>Pod 调度到节点：当 PVC 的状态为 Bound 时，Pod 才算真正调度成功了。如果 PVC一直处于 Pending状态，超时后会再次进行调度。</li>
<li>Mount 卷：kubelet监听到有 Pod 已经调度到节点上，对本地存储进行 mount 操作。</li>
<li>启动容器：启动容器。</li>
</ul>
<h5 id="Local-Dynamic-的挑战"><a href="#Local-Dynamic-的挑战" class="headerlink" title="Local Dynamic 的挑战"></a>Local Dynamic 的挑战</h5><p>如果将磁盘空间作为一个存储池（例如 LVM）来动态分配，那么在分配出来的逻辑卷空间的使用上，可能会受到其他逻辑卷的 I/O 干扰，因为底层的物理卷可能是同一个。</p>
<p>如果 PV 后端的磁盘空间是一块独立的物理磁盘，则 I/O 就不会受到干扰。</p>
<h4 id="生产实践经验分享"><a href="#生产实践经验分享" class="headerlink" title="生产实践经验分享"></a>生产实践经验分享</h4><p>不同介质类型的磁盘，需要设置不同的 StorageClass，以便让用户做区分。StorageClass 需要设置磁盘介质的类型，以便用户了解该类存储的属性。</p>
<p>在本地存储的 PV 静态部署模式下，每个物理磁盘都尽量只创建一个 PV，而不是划分为多个分区来提供多个本地存储 PV，避免在使用时分区之间的 I/O 干扰。</p>
<p>本地存储需要配合磁盘检测来使用。当集群部署规模化后，每个集群的本地存储 PV 可能会超过几万个，如磁盘损坏将是频发事件。此时，需要在检测到磁盘损坏、丢盘等问题后，对节点的磁盘和相应的本地存储 PV 进行特定的处理例如触发告警、自动 cordon 节点、自动通知用户等。</p>
<p>对于提供本地存储节点的磁盘管理，需要做到灵活管理和自动化。节点磁盘的信息可以归一、集中化管理。在 local-volume-provisioner 中增加部署逻辑，当容器运行起来时，拉取该节点需要提供本地存储的磁盘信息，例如磁盘的设备路径，以 Filesystem 或 Block 的模式提供本地存储，或者是否需要加入某个 LVM 的虚拟组（VG）等 local-volume-provisioner 根据获取的磁盘信息对磁盘进行格式化，或者加入到某个 VG，从而形成对本地存储支持的自动化闭环。</p>
<h4 id="Rook"><a href="#Rook" class="headerlink" title="Rook"></a>Rook</h4><p>Rook 是一款云原生环境下的开源分布式存储编排系统，目前支持 Ceph、NFS、EdgeFS、Cassandra、CockroachDB 等存储系统。它实现了一个自动管理的、自动扩容的、自动修复的分布式存储服务。Rook 支持自动部署、启动、配置、分配、扩容/缩容、升级、迁移、灾难恢复、监控以及资源管理。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module7/csi/rook/rook.md">https://github.com/kibaamor/101/blob/master/module7/csi/rook/rook.md</a></p>
<h5 id="Rook-架构"><a href="#Rook-架构" class="headerlink" title="Rook 架构"></a>Rook 架构</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Rook架构.png" alt="Rook架构"></p>
<h5 id="Rook-Operator"><a href="#Rook-Operator" class="headerlink" title="Rook Operator"></a>Rook Operator</h5><p>RookOperater 是 Rook 的大脑，以deployment 形式存在。</p>
<p>其利用 Kubernetes 的 controller-runtime 框架实现了 CRD，并进而接受 Kubernetes 创建资源的请求并创建相关资源（集群，pool，块存储服务，文件存储服务等）。<br>RookOperater 监控存储守护进程，来确保存储集群的健康。</p>
<p>监听 Rook Discovers 收集到的存储磁盘设备，并创建相应服务（Ceph 的话就是 OSD 了）。</p>
<h5 id="Rook-Discover"><a href="#Rook-Discover" class="headerlink" title="Rook Discover"></a>Rook Discover</h5><p>Rook Discover 是以 DaemonSet 形式部署在所有的存储机上的，其检测挂接到存储节点上的存储设备。把符合要求的存储设备记录下来，这样 RookOperate 感知到以后就可以基于该存储设备创建相应服务了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## discover device</span>
lsblk --all --noheadings --list --output KNAME
lsblk /dev/vdd --bytes --nodeps --pairs --paths --0utput SIZE,ROTA,RO,TYPE,PKNAME,NAME,KNAME
udevadm info --query<span class="token operator">=</span>property /dev/vdd$ lsblk --noheadings --pairs /dev/vdd

<span class="token comment">## discover ceph inventory</span>
ceph-volume inventory--format json
<span class="token keyword">if</span> device has ceph inv,device.cephVolumeData<span class="token operator">=</span>CvData
<span class="token comment">## put device info into configmap per node</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CSIDriver-发现"><a href="#CSIDriver-发现" class="headerlink" title="CSIDriver 发现"></a>CSIDriver 发现</h5><p>CSI 驱动发现：</p>
<p>如果一个 CSI 驱动创建 CSIDriver 对象，Kubernetes 用户可以通过 <code>get CSIDriver</code> 命令发现它们；</p>
<p>CSI 对象有如下特点：</p>
<ul>
<li>自定义的 Kubernetes逻辑；</li>
<li>Kubernetes 对存储卷有一些列操作，这些 CSIDriver 可以自定义支持哪些操作?</li>
</ul>
<h5 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a>Provisioner</h5><p>CSI external-provisioner 是一个监控 Kubernetes PVC 对象的 Sidecar 容器</p>
<p>当用户创建 PVC 后，Kubernetes 会监测 PVC 对应的 StorageClass，如果 StorageClass 中的 provisioner 与某插件匹配，该容器通过 CSI Endpoint（通常是 unixsocket）调用 CreateVolume 方法。</p>
<p>如果 CreateVolume 方法调用成功，则 Provisioner sidecar 创建 Kubernetes PV 对象。</p>
<h5 id="CSI-External-Provisioner"><a href="#CSI-External-Provisioner" class="headerlink" title="CSI External Provisioner"></a>CSI External Provisioner</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>csi<span class="token punctuation">-</span>address=$(ADDRESS)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>timeout=150s
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>retry<span class="token punctuation">-</span>interval<span class="token punctuation">-</span>start=500ms
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> name<span class="token punctuation">:</span>ADDRESS
      value<span class="token punctuation">:</span>unix<span class="token punctuation">:</span>///csi/csi<span class="token punctuation">-</span>provisioner.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/k8scsi/csi<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v1.6.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /csi
      <span class="token key atrule">name</span><span class="token punctuation">:</span> socket<span class="token punctuation">-</span>dir
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount
      <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>sa<span class="token punctuation">-</span>token<span class="token punctuation">-</span>mxv84
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeid=$(NODE ID)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>endpoint=$(CSI ENDPOINT)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>type=rbd
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>controllerserver=true
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>drivername=rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> name<span class="token punctuation">:</span>CSI ENDPOINT
      <span class="token key atrule">value</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///csi/csi<span class="token punctuation">-</span>provisioner.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/cephcsi/cephcsi<span class="token punctuation">:</span>v3.0.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>rbdplugin
  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span>
    <span class="token key atrule">medium</span><span class="token punctuation">:</span> Memory
    <span class="token key atrule">name</span><span class="token punctuation">:</span> socket<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Provisioner-代码"><a href="#Provisioner-代码" class="headerlink" title="Provisioner 代码"></a>Provisioner 代码</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go">controller<span class="token operator">/</span>controller<span class="token punctuation">.</span><span class="token keyword">go</span>
    syncClaim <span class="token operator">-</span><span class="token operator">&gt;</span>provisionClaimOperation<span class="token operator">-</span><span class="token operator">&gt;</span>provisioner<span class="token punctuation">.</span>Provision
        pkg<span class="token operator">/</span>operator<span class="token operator">/</span>ceph<span class="token operator">/</span>provisioner<span class="token operator">/</span>provisioner<span class="token punctuation">.</span><span class="token keyword">go</span>
            Provision<span class="token operator">-</span><span class="token operator">&gt;</span>createVolume
                ceph<span class="token punctuation">.</span>Createlmage
        
        pkg<span class="token operator">/</span>daemon<span class="token operator">/</span>ceph<span class="token operator">/</span>client<span class="token operator">/</span>image<span class="token punctuation">.</span><span class="token keyword">go</span>
        
        rbd create poolName<span class="token operator">/</span>name <span class="token operator">-</span>size sizeMB
volumeStore<span class="token punctuation">.</span>StoreVolume
    controller<span class="token operator">/</span>volume_store<span class="token punctuation">.</span><span class="token keyword">go</span>
        doSaveVolume
            client<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PersistentVolumes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Provisioner-log"><a href="#Provisioner-log" class="headerlink" title="Provisioner log"></a>Provisioner log</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">10816 10:17:32.535207   1 connection.go:153] connecting to unix:///csi/csiprovisioner.sock
10816 10:17:54.361911   1 volume store.go:97] Starting save volume queue
10816 10:17:54.461930   1 controller.go:1284] provision "default/mysql-pv-claim" class
"rook-ceph-block": started
10816 10:17:54.462078   1 controller.go:848] Started provisioner controller rook-ceph.rbd.csi.ceph.com csi-rbdplugin-provisioner-677577c77c-vwkzz ca5971ab-2293-4e529bc9-c490f7f50b07!
1081610:17:54.465752 1event.go:281] Event(v1.0bjectReference{Kind:"PersistentVolumeClaim", Namespace:"default"Name:"mysal-pv-claim",UlD:"24449707-6738-425c-ac88-de3c470cf91a",APIVersion:"y1"ResourceVersion:"45668", FieldPath:""): type:'Normal' reason: 'Provisioning' Externalprovisioner is provisioning volume for claim "default/mysql-pv-claim"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Rook-Agent"><a href="#Rook-Agent" class="headerlink" title="Rook Agent"></a>Rook Agent</h5><p>RookAgent 是以 Daemonset 形式部署在所有的存储机上的，其处理所有的存储操作，例如挂卸载存储卷以及格式化文件系统等。</p>
<h5 id="CSI-插件注册"><a href="#CSI-插件注册" class="headerlink" title="CSI 插件注册"></a>CSI 插件注册</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>V=0
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>csi<span class="token punctuation">-</span>address=/csi/csi.sock
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>registration<span class="token punctuation">-</span>path=/var/lib/kubelet/plugins/rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com/csi.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/k8scsi/csi<span class="token punctuation">-</span>node<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>registrar<span class="token punctuation">:</span>v1.2.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> driver<span class="token punctuation">-</span>registrar
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">securitycontext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /csi
    <span class="token key atrule">name</span><span class="token punctuation">:</span> plugin<span class="token punctuation">-</span>dir
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /registration
    <span class="token key atrule">name</span><span class="token punctuation">:</span> registration<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CSI-Driver"><a href="#CSI-Driver" class="headerlink" title="CSI Driver"></a>CSI Driver</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">apiVersion<span class="token punctuation">:</span>storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CSlDriver
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">attachRequired</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">podinfoOnMount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">volumeLifecycleModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Persistent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span> /var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com
csi.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeid=$(NODE ID)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>endpoint=$(CSI ENDPOINT)
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>V=0
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>type=rbd
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>nodeserver=true
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>drivername=rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>pidlimit=<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metricsport=9090
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metricspath=/metrics
  <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enablegrpcmetrics=true
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CSI ENDPOINT
    <span class="token key atrule">value</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///csi/csi.sock
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/cephcsi/cephcsi<span class="token punctuation">:</span>v3.0.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> csi<span class="token punctuation">-</span>rbdplugin
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    allowPrivilegeEscalation<span class="token punctuation">:</span><span class="token boolean important">true</span>
    <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
      <span class="token key atrule">add</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> SYS_ADMIN
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    path<span class="token punctuation">:</span>/var/lib/kubelet/plugins/rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
    <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> plugin<span class="token punctuation">-</span>dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go">pkg<span class="token operator">/</span>daemon<span class="token operator">/</span>ceph<span class="token operator">/</span>agent<span class="token operator">/</span>agent<span class="token punctuation">.</span><span class="token keyword">go</span>
    flexvolume<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>context<span class="token punctuation">,</span> volumeAttachmentController<span class="token punctuation">,</span> volumeManager<span class="token punctuation">)</span>
    rpc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>flexvolumeController<span class="token punctuation">)</span>
    flexvolumeServer<span class="token punctuation">.</span>Start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h5><p>针对不同 ceph cluster，rook 启动一组管理组件，包括: mon, mgr, osd, mds, rgw。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CephCluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">cephVersion</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ceph/ceph<span class="token punctuation">:</span>v14.2.10
    <span class="token key atrule">dataDirHostPath</span><span class="token punctuation">:</span> /var/lib/rook
  <span class="token key atrule">mon</span><span class="token punctuation">:</span>
    count<span class="token punctuation">:</span><span class="token number">3</span>
    <span class="token key atrule">allowMultiplePerNode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">mgr</span><span class="token punctuation">:</span>
    <span class="token key atrule">modules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pg_autoscaler
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">dashboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token key atrule">useAllNodes</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">useAllDevices</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h5><p>-个 ceph cluster 可以有多个 pool 定义副本数量，故障域等多个属性。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> cephBlockPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">compressionMode</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">crushRoot</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">deviceClass</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">erasureCoded</span><span class="token punctuation">:</span>
    <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> <span class="token string">""</span>
    <span class="token key atrule">codingChunks</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">dataChunks</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">failureDomain</span><span class="token punctuation">:</span> host
  <span class="token key atrule">replicated</span><span class="token punctuation">:</span>
    <span class="token key atrule">requireSafeReplicaSize</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">targetSizeRatio</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">phase</span><span class="token punctuation">:</span> Ready<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Kubernetes-控制平面组件：生命周期管理和服务发现"><a href="#Kubernetes-控制平面组件：生命周期管理和服务发现" class="headerlink" title="Kubernetes 控制平面组件：生命周期管理和服务发现"></a>Kubernetes 控制平面组件：生命周期管理和服务发现</h2><h3 id="深入理解-Pod-的生命周期"><a href="#深入理解-Pod-的生命周期" class="headerlink" title="深入理解 Pod 的生命周期"></a>深入理解 Pod 的生命周期</h3><h4 id="如何优雅的管理-Pod-的完整生命周期"><a href="#如何优雅的管理-Pod-的完整生命周期" class="headerlink" title="如何优雅的管理 Pod 的完整生命周期"></a>如何优雅的管理 Pod 的完整生命周期</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何优雅的管理Pod的完整生命周期.png" alt="如何优雅的管理Pod的完整生命周期"></p>
<ul>
<li>Pending<br>  Pod 创建成功，但是还未调度（即未与 Node 绑定）</li>
<li>ContainerCreating<br>  Pod 成功被调度到某了 Node，等待 Node 创建对应的 Pod</li>
</ul>
<h4 id="Pod-状态机"><a href="#Pod-状态机" class="headerlink" title="Pod 状态机"></a>Pod 状态机</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod状态机.png" alt="Pod状态机"></p>
<h4 id="Pod-Phase"><a href="#Pod-Phase" class="headerlink" title="Pod Phase"></a>Pod Phase</h4><p>Pod Phase</p>
<ul>
<li>Pending</li>
<li>Running</li>
<li>Succeeded</li>
<li>Failed</li>
<li>Unknown</li>
</ul>
<p><code>kubectl get pod</code> 显示的状态信息是由 podstatus 的 conditions 和 phase 计算出来的</p>
<ul>
<li>查看 pod 细节 <code>kubectl get pod $podname -oyaml</code></li>
<li>查看 pod 相关事件 <code>kubectl describe pod</code></li>
</ul>
<h4 id="Pod-状态计算细节"><a href="#Pod-状态计算细节" class="headerlink" title="Pod 状态计算细节"></a>Pod 状态计算细节</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod状态计算细节.png" alt="Pod状态计算细节"></p>
<h4 id="如何确保-Pod-的高可用"><a href="#如何确保-Pod-的高可用" class="headerlink" title="如何确保 Pod 的高可用"></a>如何确保 Pod 的高可用</h4><p>避免容器进程被终止避免 Pod 被驱逐</p>
<ul>
<li>设置合理的 resources.memory limits 防止容器进程被 OOMKill</li>
<li>设置合理的 emptydir.sizeLimit 并且确保数据写入不超过 emptyDir 的限制，防止 Pod 被驱逐</li>
</ul>
<h4 id="Pod-的-QoS分类"><a href="#Pod-的-QoS分类" class="headerlink" title="Pod 的 QoS分类"></a>Pod 的 QoS分类</h4><ul>
<li>Guaranteed<ul>
<li>Pod 的每个容器都设置了资源 CPU 和内存需求</li>
<li>Limits 和 requests 的值完全一致</li>
</ul>
</li>
<li>Burstable<ul>
<li>至少一个容器指定了 CPU 或内存 request</li>
<li>Pod 的资源需求不符合 Gauranteed Qos 的条件，也就是 request 和 limits 不一致</li>
</ul>
</li>
<li>BestEffort<ul>
<li>Pod 中的所有容器都未指定 CPU 或内存资源需要 request</li>
</ul>
</li>
</ul>
<blockquote>
<p>仅配置 resources 中的 limits 的话，qos 会是 Guaranteed。</p>
<p>仅配置 resources 中的 requests 的话，qos 会是 Burstable。</p>
</blockquote>
<p>当计算节点检测到内存压力时，Kubernetes 会按 BestEffort -&gt; Burstable -&gt; Guaranteed 的顺序依次驱逐 Pod</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pod xxx <span class="token operator">|</span> <span class="token function">grep</span> qosClass
  qosClass: Burstable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>定义 Guaranteed 类型的资源需求来保护你的重要 Pod。</p>
<p>认真考量 Pod 需要的真实需求并设置 limit 和 resource，这有利于将集群资源利用率控制在合理范围并减少 Pod 被驱逐的现象。</p>
<p>尽量避免将生产 Pod 设置为 BestEffort，但是对测试环境来讲，BestEffort Pod 能确保大多数应用不会因为资源不足而处于 Pending 状态。</p>
<p>Burstable 适用于大多数场景。思考:为什么?</p>
<h4 id="PriorityClass-和-QosClass-之间的区别"><a href="#PriorityClass-和-QosClass-之间的区别" class="headerlink" title="PriorityClass 和 QosClass 之间的区别"></a>PriorityClass 和 QosClass 之间的区别</h4><p><a target="_blank" rel="noopener" href="https://medium.com/pareture/kubernetes-quality-of-service-qos-class-vs-priority-class-751d1c9f9f7c">Kubernetes Quality of Service (QoS) Class Vs Priority Class</a></p>
<p>PriorityClass 和 QosClass 属于两个不同的维度。</p>
<p>PriorityClass 是用来做资源调度时，判断谁的优先级高谁先抢占资源。</p>
<p>它的表现是，在所有的调度开始前，有一个 QueueSort 的步骤，把所有待调度的 Pod 按照优先级排序，高优先级的在前面，低优先级的排在后面。调度的时候，先调度高优先级的 Pod。</p>
<p>另外，PriorityClass 有一个是否抢占资源的属性，如果设置成”是”的话，当集群目前的资源不足时，调度器就会计算假如杀掉一些比当前待调度 Pod 优先级低的 Pod 后能否让待调度的 Pod 能成功运行，如果能的话，就会杀掉那些比当前待调度 Pod 优先级低的 Pod 以抢占它们的资源。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get priorityclasses system-node-critical -oyaml
apiVersion: scheduling.k8s.io/v1
description: Used <span class="token keyword">for</span> system critical pods that must not be moved from their current
  node.
kind: PriorityClass
metadata:
  creationTimestamp: <span class="token string">"2024-05-11T10:12:53Z"</span>
  generation: <span class="token number">1</span>
  name: system-node-critical
  resourceVersion: <span class="token string">"74"</span>
  uid: bafc6e25-24ed-4d64-8115-16ad31aace29
preemptionPolicy: PreemptLowerPriority
value: <span class="token number">2000001000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// PreemptionPolicy describes a policy for if/when to preempt a pod.</span>
<span class="token keyword">type</span> PreemptionPolicy <span class="token builtin">string</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// PreemptLowerPriority means that pod can preempt other pods with lower priority.</span>
    PreemptLowerPriority PreemptionPolicy <span class="token operator">=</span> <span class="token string">"PreemptLowerPriority"</span>
    <span class="token comment">// PreemptNever means that pod never preempts other pods with lower priority.</span>
    PreemptNever PreemptionPolicy <span class="token operator">=</span> <span class="token string">"Never"</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>QosClass 根据资源需求来决定 Kubernetes 需要对 Pod 做什么样的质量保证。当 Node 出现资源紧张的情况下，Node 会根据 QosClass 的优先级从低到高进行驱逐，这个时候与 PriorityClass 是无关的。</p>
<p>PriorityClass 是 Pod 调度时抢资源用的，QosClass 是资源不足驱逐时用的。</p>
<p>“QosClass 是决定怎么死，PriorityClass 决定怎么生”</p>
<h4 id="基于-Taint-的-Evictions"><a href="#基于-Taint-的-Evictions" class="headerlink" title="基于 Taint 的 Evictions"></a>基于 Taint 的 Evictions</h4><p>NotReady Node</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">taints</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:25:10Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:25:21Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> Noschedule
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:24:28Z"</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">timeAdded</span><span class="token punctuation">:</span> <span class="token string">"2020-07-09T11:24:32Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>K8s 为 Pod 自动增加的 Toleration</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
  <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">900</span>
<span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
  <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Existstoleration
  <span class="token key atrule">seconds</span><span class="token punctuation">:</span> <span class="token number">900</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>节点临时不可达</p>
<ul>
<li>网络分区 </li>
<li>kubelet, containerd 不工作</li>
<li><p>节点重启超过了 15 分钟</p>
</li>
<li><p>增大 tolerationSeconds 以避免被驱逐</p>
<ul>
<li>特别是依赖于本地存储状态的有状态应用</li>
</ul>
</li>
</ul>
<h4 id="健康检查探针"><a href="#健康检查探针" class="headerlink" title="健康检查探针"></a>健康检查探针</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/pods/graceful-start">https://github.com/kibaamor/101/tree/master/module8/pods/graceful-start</a></p>
<p>健康探针类型分为</p>
<ul>
<li>livenessProbe<ul>
<li>探活，当检查失败时，意味着该应用进程已经无法正常提供服务 kubelet 会终止该容器进程并按照 restartPolicy 决定是否重启</li>
<li>livenessProbe 不会重建 Pod，只会重起 containerd</li>
<li>livenessProbe 默认不配置时是成功的</li>
</ul>
</li>
<li>readinessProbe<ul>
<li>就绪状态检查，当检查失败时，意味着应用进程正在运行，但因为某些原因不能提供服务，Pod 状态会被标记为 NotReady</li>
<li>readinessProbe 默认不配置时是成功的，但如果配置了就不要成功后 service 才会转发流量给对应的 Pod</li>
<li>readinessProbe 失败时并不会重启 Container 或者 Pod，只是会不 Ready</li>
</ul>
</li>
<li>startupProbe<ul>
<li>在初始化阶段(Ready 之前)进行的健康检查，通常用来避免过于频繁的监测影响应用启动</li>
<li>startupProbe 成功后，livenessProbe 和 readinessProbe 才会介入</li>
</ul>
</li>
</ul>
<p>探测方法包括</p>
<ul>
<li>ExecAction：在容器内部运行指定命令，当返回码为 0 时，探测结果为成功</li>
<li>TCPSocketAction：由 kubelet 发起，通过 TCP 协议检查容器 IP 和端口，当端口可达时，探测结果为成功</li>
<li>HTTPGetAction：由 kubelet 发起，对 Pod 的 IP 和指定端口以及路径进行 HTTPGet 操作，当返回码为 200-400 之间时，探测结果为成功</li>
</ul>
<h4 id="探针属性"><a href="#探针属性" class="headerlink" title="探针属性"></a>探针属性</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/探针属性.png" alt="探针属性"></p>
<h4 id="ReadinessGates"><a href="#ReadinessGates" class="headerlink" title="ReadinessGates"></a>ReadinessGates</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/pods/graceful-start/readiness-gate.yaml">https://github.com/kibaamor/101/blob/master/module8/pods/graceful-start/readiness-gate.yaml</a></p>
<ul>
<li>Readiness 允许在 Kubernetes 自带的 Pod Conditions 之外引入自定义的就绪条件</li>
<li>新引入的 readinessGates condition 需要为 True 状态后，加上内置的 Conditions，Pod 才可以为就绪状态</li>
<li>该状态应该由某控制器修改</li>
</ul>
<h4 id="Post-start-和-Pre-Stop-Hook"><a href="#Post-start-和-Pre-Stop-Hook" class="headerlink" title="Post-start 和 Pre-Stop Hook"></a>Post-start 和 Pre-Stop Hook</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/pods/graceful-stop">https://github.com/kibaamor/101/tree/master/module8/pods/graceful-stop</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PostStart和PreStopHook.png" alt="PostStart和PreStopHook"></p>
<h4 id="terminationGracePeriodSeconds-的分解"><a href="#terminationGracePeriodSeconds-的分解" class="headerlink" title="terminationGracePeriodSeconds 的分解"></a>terminationGracePeriodSeconds 的分解</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/terminationGracePeriodSeconds的分解.png" alt="terminationGracePeriodSeconds的分解"></p>
<h4 id="Terminating-Pod-的误用"><a href="#Terminating-Pod-的误用" class="headerlink" title="Terminating Pod 的误用"></a>Terminating Pod 的误用</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> netperf<span class="token punctuation">:</span><span class="token number">0.1</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /netperf<span class="token punctuation">-</span>server.sh
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> netperf-server.sh
<span class="token comment">#!/bin/bashnetserver -D</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>bash /sh 会忽略 SIGTERM 信号量，因此 kilL -SIGTERM 会永远超时，若应用使用 bash/sh 作为 Entrypoint，则应避免过长的 grace period</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/TerminatingPod的误用.png" alt="TerminatingPod的误用"></p>
<h4 id="Terminating-Pod-的经验分享"><a href="#Terminating-Pod-的经验分享" class="headerlink" title="Terminating Pod 的经验分享"></a>Terminating Pod 的经验分享</h4><p><a target="_blank" rel="noopener" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a></p>
<p>terminationGracePeriodseconds 默认时长 30 秒</p>
<p>如果不关心 Pod 的终止时长，那么无需采取特殊措施</p>
<p>如果希望快速终止应用进程，那么可采取如下方案</p>
<ul>
<li>在 preStop script 中主动退出进程</li>
<li>在主容器进程中使用特定的初始化进程</li>
</ul>
<p>优雅的初始化进程应该</p>
<ul>
<li>正确处理系统信号量，将信号量转发给子进程</li>
<li>在主进程退出之前，需要先等待并确保所有子进程退出</li>
<li>监控并清理孤儿子进程</li>
</ul>
<h4 id="在-Kubernetes-上部署应用的挑战"><a href="#在-Kubernetes-上部署应用的挑战" class="headerlink" title="在 Kubernetes 上部署应用的挑战"></a>在 Kubernetes 上部署应用的挑战</h4><p>资源规划</p>
<ul>
<li>每个实例需要多少计算资源<ul>
<li>CPU/GPU?</li>
<li>Memory</li>
</ul>
</li>
<li>超售需求</li>
<li>每个实例需要多少存储资源<ul>
<li>大小</li>
<li>本地还是网盘</li>
<li>读写性能</li>
<li>Disk IO</li>
</ul>
</li>
<li>网络需求<ul>
<li>整个应用总体 QPS 和带宽</li>
</ul>
</li>
</ul>
<h4 id="存储带来的挑战"><a href="#存储带来的挑战" class="headerlink" title="存储带来的挑战"></a>存储带来的挑战</h4><p>多容器之间共享存储，最简方案是 emptyDir</p>
<p>带来的挑战：</p>
<ul>
<li>emptyDir 需要控制 size limt，否则无限扩张的应用会撑爆主机磁盘导致主机不可用进而导致大规模集群故障</li>
<li>emptyDir size limit 生效以后，kubelet 会定期对容器目录执行 du 操作，会导致些许的性能影响</li>
<li>size limit达到以后，Pod 会被驱逐，原 Pod 的日志配置等信息会消失</li>
</ul>
<h4 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h4><p>传入方式</p>
<ul>
<li>Environment Variables</li>
<li>Volume Mount</li>
</ul>
<p>数据来源</p>
<ul>
<li>ConfigMap</li>
<li>Secret</li>
<li>Downward AP</li>
</ul>
<h4 id="数据应该如何保存"><a href="#数据应该如何保存" class="headerlink" title="数据应该如何保存"></a>数据应该如何保存</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据应该如何保存.png" alt="数据应该如何保存"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据应该如何保存2.png" alt="数据应该如何保存2"></p>
<h4 id="容器应用可能面临的进程中断"><a href="#容器应用可能面临的进程中断" class="headerlink" title="容器应用可能面临的进程中断"></a>容器应用可能面临的进程中断</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/容器应用可能面临的进程中断.png" alt="容器应用可能面临的进程中断"></p>
<h4 id="高可用部署方式"><a href="#高可用部署方式" class="headerlink" title="高可用部署方式"></a>高可用部署方式</h4><p>多少实例</p>
<p>更新策略</p>
<ul>
<li>maxsurge</li>
<li>maxUnavailable（需要考虑 ResourceQuota 的限制）</li>
</ul>
<p>深入理解 PodTemplateHash 导致的应用的易变性</p>
<h4 id="课后作业-第一部分"><a href="#课后作业-第一部分" class="headerlink" title="课后作业(第一部分)"></a>课后作业(第一部分)</h4><p>现在你对 Kubernetes 的控制面板的工作机制是否有了深入的了解呢?</p>
<p>是否对如何构建一个优雅的云上应用有了深刻的认识，那么接下来用最近学过的知识把你之前编写的 http 以优雅的方式部署起来吧，你可能需要审视之前代码是否能满足优雅上云的需求。</p>
<p>作业要求:编写 Kubernetes 部署脚本将 httpserver 部署到 kubernetes 集群，以下是你可以思考的维度</p>
<ul>
<li>优雅启动</li>
<li>优雅终止</li>
<li>资源需求和 QoS 保证</li>
<li>探活</li>
<li>日常运维需求，日志等级</li>
<li>配置和代码分离</li>
</ul>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><h4 id="服务发布"><a href="#服务发布" class="headerlink" title="服务发布"></a>服务发布</h4><p>需要把服务发布至集群内部或者外部，服务的不同类型</p>
<ul>
<li>ClusterlP(Headless)</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>ExternalName</li>
</ul>
<p>证书管理和七层负载均衡的需求</p>
<p>需要gRPC负载均衡如何做?</p>
<p>DNS需求</p>
<p>与上下游服务的关系</p>
<h4 id="服务发布的挑战"><a href="#服务发布的挑战" class="headerlink" title="服务发布的挑战"></a>服务发布的挑战</h4><p>kube-dns</p>
<ul>
<li>DNS TTL 问题</li>
</ul>
<p>Service</p>
<ul>
<li>ClusterIP 只能对内</li>
<li>kube-proxy 支持的 iptables/ipvs 规模有限</li>
<li>IPVS 的性能和生产化问题 kube-proxy 的 drift 问题</li>
<li>频繁的 Pod 变动(specchange，failover，crashloop) 导致 LB 频繁变更</li>
<li>对外发布的 Service 需要与企业 ELB 集成</li>
<li>不支持 gRPC</li>
<li>不支持自定义 DNS 和高级路由功能</li>
</ul>
<p>Ingress</p>
<ul>
<li>Spec 的成熟度?</li>
</ul>
<p>其他可选方案?</p>
<h4 id="跨地域部署"><a href="#跨地域部署" class="headerlink" title="跨地域部署"></a>跨地域部署</h4><p>需要多少实例</p>
<p>如何控制失败域，部署在几个地区，AZ，集群?</p>
<p>如何进行精细的流量控制</p>
<p>如何做按地域的顺序更新</p>
<p>如何回滚</p>
<h3 id="微服务架构下的高可用挑战"><a href="#微服务架构下的高可用挑战" class="headerlink" title="微服务架构下的高可用挑战"></a>微服务架构下的高可用挑战</h3><h4 id="服务发现-1"><a href="#服务发现-1" class="headerlink" title="服务发现"></a>服务发现</h4><p>微服务架构是由一系列职责单一的细粒度服务构成的分布式网状结构服务之间通过轻量机制进行通信，这时候必然引入一个服务注册发现问题，也就是说服务提供方要注册通告服务地址，服务的调用方要能发现目标服务。</p>
<p>同时服务提供方一般以集群方式提供服务，也就引入了负载均衡和健康检查问题。</p>
<h5 id="互联网架构发展历程"><a href="#互联网架构发展历程" class="headerlink" title="互联网架构发展历程"></a>互联网架构发展历程</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/互联网架构发展历程.png" alt="互联网架构发展历程"></p>
<h5 id="理解网络包格式"><a href="#理解网络包格式" class="headerlink" title="理解网络包格式"></a>理解网络包格式</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/理解网络包格式.png" alt="理解网络包格式"></p>
<h5 id="集中式-LB-服务发现"><a href="#集中式-LB-服务发现" class="headerlink" title="集中式 LB 服务发现"></a>集中式 LB 服务发现</h5><ul>
<li>在服务消费者和服务提供者之间有一个独立的 LB。</li>
<li>LB 上有所有服务的地址映射表，通常由运维配置注册</li>
<li>当服务消费方调用某个目标服务时，它向 LB 发起请求，由 LB 以某种策略(比如 Round-Robin)做负载均衡后将请求转发到目标服务。</li>
<li>LB 一般具备健康检查能力，能自动摘除不健康的服务实例。</li>
<li>服务消费方通过 DNS 发现 LB，运维人员为服务配置一个 DNS 域名，这个域名指向 LB。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集中式LB服务发现.png" alt="集中式LB服务发现"></p>
<ul>
<li>集中式 LB 方案实现简单，在 LB 上也容易做集中式的访问控制，这一方案目前还是业界主流。</li>
<li>集中式 LB 的主要问题是单点问题，所有服务调用流量都经过 LB，当服务数量和调用量大的时候，LB 容易成为瓶颈，且一旦 LB 发生故障对整个系统的影响是灾难性的。</li>
<li>LB 在服务消费方和服务提供方之间增加了一跳( hop )，有一定性能开销。</li>
</ul>
<h5 id="进程内-LB-服务发现"><a href="#进程内-LB-服务发现" class="headerlink" title="进程内 LB 服务发现"></a>进程内 LB 服务发现</h5><ul>
<li>进程内 LB 方案将 LB 的功能以库的形式集成到服务消费方进程里头，该方案也被称为客户端负载方案。</li>
<li>服务注册表( Service Registry )配合支持服务自注册和自发现，服务提供方启动时，首先将服务地址注册到服务注册表(同时定期报心跳到服务注册表以表明服务的存活状态)</li>
<li>服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询(同时缓存并定期刷新)目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。</li>
<li>这一方案对服务注册表的可用性( Availability )要求很高，一般采用能满足高可用分布式一致的组件(例如 ZooKeeper,Consul,etcd 等)来实现。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/进程内LB服务发现.png" alt="进程内LB服务发现"></p>
<ul>
<li>进程内 LB 是一种分布式模式，LB和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。该方案以客户库( Client Library )的方式集成到服务调用方进程里头，如果企业内有多种不同的语言栈，就要配合开发多种不同的客户端，有一定的研发和维护成本。</li>
<li>一旦客户端跟随服务调用方发布到生产环境中，后续如果要对客户库进行升级势必要求服务调用方修改代码并重新发布，所以该方案的升级推广有不小的阻力。</li>
</ul>
<h5 id="独立-LB-进程服务发现"><a href="#独立-LB-进程服务发现" class="headerlink" title="独立 LB 进程服务发现"></a>独立 LB 进程服务发现</h5><ul>
<li>针对进程内 LB 模式的不足而提出的一种折中方案，原理和第二种方案基本类似。</li>
<li>不同之处是，将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程，主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。</li>
<li>LB 独立进程可以进一步与服务消费方进行解耦，以独立集群的形式提供高可用的负载均衡服务，</li>
<li>这种模式可以称之为真正的”软负载( Soft Load Balancing )”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/独立LB进程服务发现.png" alt="独立LB进程服务发现"></p>
<ul>
<li>独立 LB 进程也是一种分布式方案，没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方。</li>
<li>服务调用方和 LB 之间是进程间调用，性能好</li>
<li>简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。</li>
<li>不足是部署较复杂，环节多，出错调试排查问题不方便。</li>
</ul>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>系统的扩展可分为纵向(垂直)扩展和横向(水平)扩展</p>
<ul>
<li>纵向扩展，是从单机的角度通过增加硬件处理能力，比如 CPU 处理能力，内存容量，磁盘等方面，实现服务器处理能力的提升，不能满足大型分布式系统(网站)，大流量，高并发，海量数据的问题;</li>
<li>横向扩展，通过添加机器来满足大型网站服务的处理能力。比如:一台机器不能满足，则增加两台或者多台机器，共同承担访问压力，这就是典型的集群和负载均衡架构。</li>
</ul>
<p>负载均衡的作用(解决的问题)</p>
<ul>
<li>解决并发压力，提高应用处理性能，增加吞吐量，加强网络处理能力;</li>
<li>提供故障转移，实现高可用;</li>
<li>通过添加或减少服务器数量，提供网站伸缩性，扩展性;</li>
<li>安全防护，负载均衡设备上做一些过滤，黑白名单等处理。</li>
</ul>
<h5 id="DNS-负载均衡"><a href="#DNS-负载均衡" class="headerlink" title="DNS 负载均衡"></a>DNS 负载均衡</h5><p>最早的负载均衡技术，利用域名解析实现负载均衡，在 DNS 服务器，配置多个 A 记录，这些 A 记录对应的服务器构成集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DNS负载均衡.png" alt="DNS负载均衡"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DNS负载均衡的优缺点.png" alt="DNS负载均衡的优缺点"></p>
<h5 id="负载均衡技术概览"><a href="#负载均衡技术概览" class="headerlink" title="负载均衡技术概览"></a>负载均衡技术概览</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/负载均衡技术概览.png" alt="负载均衡技术概览"></p>
<h5 id="网络地址转换"><a href="#网络地址转换" class="headerlink" title="网络地址转换"></a>网络地址转换</h5><p>网络地址转换( NetworkAddress Translation，NAT )通常通过修改数据包的源地址( Source NAT )或目标地址( Destination NAT )来控制数据包的转发行为</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/网络地址转换.png" alt="网络地址转换"></p>
<h5 id="新建-TCP-连接"><a href="#新建-TCP-连接" class="headerlink" title="新建 TCP 连接"></a>新建 TCP 连接</h5><p>为记录原始客户端 IP 地址，负载均衡功能不仅需要进行数据包的源目标地址修改，同时要记录原始客户端 IP 地址，基于简单的 NAT 无法满足此需求，于是衍生出了基于传输层协议的负载均衡的<br>另一种方案—— TCP/UDPTermination 方案</p>
<blockquote>
<p>Proxy protocol</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/新建TCP连接.png" alt="新建TCP连接"></p>
<h5 id="链路层负载均衡"><a href="#链路层负载均衡" class="headerlink" title="链路层负载均衡"></a>链路层负载均衡</h5><p>在通信协议的数据链路层修改 MAC 地址进行负载均衡</p>
<p>数据分发时，不修改 IP 地址，只修改目标 MAC 地址，配置真实物理服务器集群所有机器虚拟 IP 和负载均衡服务器 IP 地址一致，达到不修改数据包的源地址和目标地址，进行数据分发的目的。</p>
<p>实际处理服务器 IP 和数据请求目的 IP 一致，不需要经过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。也称为直接路由模式( DR 模式)。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/链路层负载均衡.png" alt="链路层负载均衡"></p>
<h5 id="隧道技术"><a href="#隧道技术" class="headerlink" title="隧道技术"></a>隧道技术</h5><p>负载均衡中常用的隧道技术是 IP over IP，其原理是保持原始数据包 IP 头不变，在 IP 头外层增加额外的 IP 包头后转发给上游服务器。</p>
<p>上游服务器接收 IP 数据包，解开外层 IP 包头后，剩下的是原始数据包。</p>
<p>同样的，原始数据包中的目标 IP 地址要配置在上游服务器中，上游服务器处理完数据请求以后响应包通过网关直接返回给客户端。</p>
<h3 id="Service-对象"><a href="#Service-对象" class="headerlink" title="Service 对象"></a>Service 对象</h3><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module8/service">https://github.com/kibaamor/101/tree/master/module8/service</a></p>
<h4 id="Service对象"><a href="#Service对象" class="headerlink" title="Service对象"></a>Service对象</h4><p>Service selector</p>
<ul>
<li>Kubernetes 允许将 Pod 对象通过标签( Label )进行标记，并通过 Service Selector 定义基于 Pod 标签的过滤规则以便选择服务的上游应用实例</li>
</ul>
<p>Ports</p>
<ul>
<li>Ports 属性中定义了服务的端口、协议目标端口等信息</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Endpoint-对象"><a href="#Endpoint-对象" class="headerlink" title="Endpoint 对象"></a>Endpoint 对象</h4><blockquote>
<p>Q：为什么需要 endpoint 对象？</p>
<p>A：为不同的 port 发布不同的服务器，处理多个 pod 对多个 service 的情况，endpont 就作为 pod 和 service 的中间表。</p>
</blockquote>
<p>当 Service 的 selector 不为空时，Kubernetes EndpointController 会侦听服务创建事件，创建与 Service 同名的 Endpoint 对象</p>
<p>selector 能够选取的所有 PodIP 都会被配置到 addresses 属性中</p>
<ul>
<li>如果此时 selector 所对应的 filter 查询不到对应的 Pod，则 addresses 列表为空</li>
<li>默认配置下，如果此时对应的 Pod 为 not ready 状态，则对应的 PodIP 只会出现在 subsets 的 notReadyAddresses 属性中，这意味着对应的 Pod 还没准备好提供服务，不能作为流量转发的目标。</li>
<li>如果设置了 PublishNotReadyAdddress 为 true，则无论 Pod 是否就绪都会被加入 readyAddress list</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoint
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.1.1.21
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> minikube
      <span class="token key atrule">targetRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>5754944d6c<span class="token punctuation">-</span>hnw27
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
        <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"722191"</span>
        <span class="token key atrule">uid</span><span class="token punctuation">:</span> 8a3390ae<span class="token punctuation">-</span>2f8e<span class="token punctuation">-</span>47bf<span class="token punctuation">-</span>b8dd<span class="token punctuation">-</span>70fae7fb0d32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Endpointslice-对象"><a href="#Endpointslice-对象" class="headerlink" title="Endpointslice 对象"></a>Endpointslice 对象</h4><p>当某个 Service 对应的 backend Pod 较多时 Endpoint 对象就会因保存的地址信息过多而变得异常庞大</p>
<p>Pod 状态的变更会引起 Endpoint 的变更 Endpoint 的变更会被推送至所有节点，从而导致持续占用大量网络带宽</p>
<p>EndpointSlice 对象，用于对 Pod 较多的 Endpoint 进行切片，切片大小可以自定义</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> discovery.k8s.io/vlbeta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpointslice
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>abc
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/service-name</span><span class="token punctuation">:</span> example
<span class="token key atrule">addressType</span><span class="token punctuation">:</span> IPv4
<span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> http
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span> <span class="token string">"10.1.2.3"</span>
      <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
        ready<span class="token punctuation">:</span><span class="token boolean important">true</span>
      <span class="token key atrule">hostname</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span><span class="token number">1</span>
      <span class="token key atrule">topology</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span>
        <span class="token key atrule">topology.kubernetes.io/zone</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west2<span class="token punctuation">-</span>a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="不定义-Selector-的-Service"><a href="#不定义-Selector-的-Service" class="headerlink" title="不定义 Selector 的 Service"></a>不定义 Selector 的 Service</h4><p>用户创建了 Service 但不定义 Selector</p>
<ul>
<li>Endpoint Controller 不会为该 Service 自动创建 Endpoint</li>
<li>用户可以手动创建一个与 Service 同名的 Endpoint 对象，并设置任意 IP 地址到 Address 属性</li>
<li>访问该服务的请求会被转发至目标地址</li>
</ul>
<p>通过该类型服务，可以为集群外的一组 Endpoint 创建服务</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/service-without-selector.yaml">https://github.com/kibaamor/101/blob/master/module8/service/service-without-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>without<span class="token punctuation">-</span>selector
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/endpoint-without-selector.yaml">https://github.com/kibaamor/101/blob/master/module8/service/endpoint-without-selector.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>without<span class="token punctuation">-</span>selector
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 220.181.38.148
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Service、Endpoint-和-Pod-的对应关系"><a href="#Service、Endpoint-和-Pod-的对应关系" class="headerlink" title="Service、Endpoint 和 Pod 的对应关系"></a>Service、Endpoint 和 Pod 的对应关系</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service、Endpoint和Pod的对应关系.png" alt="Service、Endpoint和Pod的对应关系"></p>
<h4 id="Service类型"><a href="#Service类型" class="headerlink" title="Service类型"></a>Service类型</h4><ul>
<li><p>clusterIP</p>
<ul>
<li>Service 的默认类型，服务被发布至仅集群内部可见的虚拟 IP 地址上。</li>
<li>在 API Server 启动时，需要通过 <code>service-cluster-ip-range</code> 参数配置虚拟 IP 地址段， API Server 中有用于分配 IP 地址和端口的组件，当该组件捕获 Service 对象并创建事件时，会从配置的虚拟 IP 地址段中去一个有效的 IP 地址，分配给该 Service 对象。</li>
</ul>
</li>
<li><p>nodePort</p>
<ul>
<li>在 API Server 启动时，需要通过 <code>node-port-range</code> 参数配置 nodePort 的范围，同样的，API Server 组件会捕获 Service 对象并创建事件，即从配置好的 nodePort 范围取一个有效端口，分配给该 Service。</li>
<li>每个节点的 kube-proxy 会尝试在服务分配的 nodePort 上建立侦听器接收请求，并转发给服务对应的后端 Pod 实例。</li>
</ul>
</li>
<li><p>LoadBalancer</p>
<ul>
<li>企业数据中心一般会采购一些负载均衡器，作为外网请求进入数据中心内部的统一流量入口。</li>
<li>针对不同的基础架构云平台，Kubernertes Cloud Manager 提供支持不同供应商API的 Service Controller。如果需要在 Openstack 云平台上搭建 Kubernetes 集群，那么只需提供一份openstack.rc，Openstack Service Controller 即可通过调用 LBaaS API 完成负载均衡配置。</li>
</ul>
</li>
</ul>
<h4 id="其他类型服务"><a href="#其他类型服务" class="headerlink" title="其他类型服务"></a>其他类型服务</h4><p>Headless Service</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/headless-svc.yaml">https://github.com/kibaamor/101/blob/master/module8/service/headless-svc.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>headless
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ClusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Headless 服务是用户将 clusterIP 显示定义为 None 的服务，</li>
<li>无头的服务意味着 Kubernetes 不会为该服务分配统一入口，包括 clusterIP，nodePort 等</li>
</ul>
<p>ExternalName Service</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/service/service-external-name.yaml">https://github.com/kibaamor/101/blob/master/module8/service/service-external-name.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ExternalName
  <span class="token key atrule">externalName</span><span class="token punctuation">:</span> tencent.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>为一个服务创建别名</li>
</ul>
<p>Headless 和 externalName 服务的使用场景?我们随后讨论</p>
<h4 id="Service-Topology"><a href="#Service-Topology" class="headerlink" title="Service Topology"></a>Service Topology</h4><p>一个网络调用的延迟受客户端和服务器所处位置的影响，两者是否在同一节点、同一机架、同-可用区、同一数据中心，都会影响参与数据传输的设备数量</p>
<p>在分布式系统中，为保证系统的高可用，往往需要控制应用的错误域( FailureDomain )，比如通过反亲和性配置，将一个应用的多个副本部署在不同机架，甚至不同的数据中心</p>
<p>Kubernetes 提供通用标签来标记节点所处的物理位置，如:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">topology.kubernetes.io/zone</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west2<span class="token punctuation">-</span>a
<span class="token key atrule">failure-domain.beta.kubernetes.io/region</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west
<span class="token key atrule">failure-domain.tess.io/network-device</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>west05<span class="token punctuation">-</span>ra053
<span class="token key atrule">failure-domain.tess.io/rack</span><span class="token punctuation">:</span> us_west02_02<span class="token punctuation">-</span>314_19_12
<span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Service 引入了 topologyKeys 属性，可以通过如下设置来控制流量</p>
<ul>
<li>当 topologyKeys 设置为 [“kubernetes.io/hostname”] 时，调用服务的客户端所在节点上如果有服务实例正在运行，则该实例处理请求，否则，调用失败。</li>
<li>当 topologyKeys 设置为 [“kubernetes.io/hostname”,”topology.kubernetes.io/zone”,”topology.kubernetes.io/region”] 时，若同一节点有对应的服务实例，则请求会优先转发至该实例。否则，顺序查找当前 zone 及当前 region 是否有服务实例，并将请求按顺序转发。</li>
<li>当 topologyKeys 设置为 [“topology.kubernetes.io/zone”,”*”] 时，请求会被优先转发至当前 zone 的服务实例。如果当前 zone 不存在服务实例，则请求会被转发至任意服务实例。</li>
</ul>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><h4 id="kube-proxy-1"><a href="#kube-proxy-1" class="headerlink" title="kube-proxy"></a>kube-proxy</h4><p>每台机器上都运行一个 kube-proxy 服务，它监听 API server 中 service 和 endpoint 的变化情况，并通过 iptables 等来为服务配置负载均衡(仅支持 TCP 和 UDP )。</p>
<p>kube-proxy 可以直接运行在物理机上，也可以以 static pod 或者 DaemonSet 的方式运行。</p>
<p>kube-proxy 当前支持一下几种实现</p>
<ul>
<li>userspace：最早的负载均衡方案，它在用户空间监听一个端口，所有服务通过 iptables 转发到这个端口，然后在其内部负载均衡到实际的 Pod。该方式最主要的问题是效率低，有明显的性能瓶颈</li>
<li>iptables：目前推荐的方案，完全以 iptables 规则的方式来实现 service 负载均衡。该方式最主要的问题是在服务多的时候产生太多的 iptables 规则，非增量式更新会引入一定的时<br>延，大规模情况下有明显的性能问题</li>
<li>ipvs：为解决 iptables 模式的性能问题，v1.8 新增了 ipvs 模式，采用增量式更新，并可以保证 service 更新期间连接保持不断开</li>
<li>winuserspace：同 userspace，但仅工作在 windows 上</li>
</ul>
<h4 id="Linux内核处理数据包：Netfilter-框架"><a href="#Linux内核处理数据包：Netfilter-框架" class="headerlink" title="Linux内核处理数据包：Netfilter 框架"></a>Linux内核处理数据包：Netfilter 框架</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Netfilter框架.png" alt="Netfilter框架"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35376521/article/details/126930679">tcpdump 和 iptables(netfilter) 处理数据包的先后顺序</a></p>
<p>结论</p>
<ul>
<li>进站的数据包先经过 tcpdump，再经过 iptables</li>
<li>出站的数据包先经过 iptables，再经过 tcpdump</li>
</ul>
<p>原理分析</p>
<ul>
<li>事实上tcpdump在链路层就已经捕获数据包 (从 tcpdump man page 得知)</li>
<li>而 iptables 工作在协议栈的网络层，原理上 tcpdump 就比 iptables 更接近网卡设备</li>
</ul>
</blockquote>
<h4 id="Netfilter-和-iptables"><a href="#Netfilter-和-iptables" class="headerlink" title="Netfilter 和 iptables"></a>Netfilter 和 iptables</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Netfilter和iptables.png" alt="Netfilter和iptables"></p>
<h4 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/iptables.png" alt="iptables"></p>
<h4 id="iptables-支持的锚点"><a href="#iptables-支持的锚点" class="headerlink" title="iptables 支持的锚点"></a>iptables 支持的锚点</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/iptables支持的锚点.png" alt="iptables支持的锚点"></p>
<h4 id="kube-proxy-工作原理"><a href="#kube-proxy-工作原理" class="headerlink" title="kube-proxy 工作原理"></a>kube-proxy 工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/kube-proxy工作原理.png" alt="kube-proxy工作原理"></p>
<h4 id="Kubernetes-iptables-规则"><a href="#Kubernetes-iptables-规则" class="headerlink" title="Kubernetes iptables 规则"></a>Kubernetes iptables 规则</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetesiptables规则.png" alt="Kubernetesiptables规则"></p>
<h4 id="iptables-示例"><a href="#iptables-示例" class="headerlink" title="iptables 示例"></a>iptables 示例</h4><h5 id="ClusterIP-的-iptables-规则分析"><a href="#ClusterIP-的-iptables-规则分析" class="headerlink" title="ClusterIP 的 iptables 规则分析"></a>ClusterIP 的 iptables 规则分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-basic -owide
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
nginx-basic   ClusterIP   <span class="token number">10.96</span>.240.161   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    74m   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx

$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx -owide
NAME                                READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-77b4fdf86c-glrrd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.52   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-77b4fdf86c-k7mf4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.51   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-77b4fdf86c-wplrw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.0.50   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES

-A KUBE-SERVICES -d 10.96.240.161/32 -p tcp -m comment --comment "default/nginx-basic:http cluster IP" -m tcp --dport 80 -j KUBE-SVC-WWRFY3PZ7W3FGMQW

-A KUBE-SVC-WWRFY3PZ7W3FGMQW ! -s 10.244.0.0/16 -d 10.96.240.161/32 -p tcp -m comment --comment "default/nginx-basic:http cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.50:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-GDFWTYWRXAR6P5IV
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.51:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-KT26XBLI5UEBCGC6
-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment "default/nginx-basic:http -&gt; 10.244.0.52:80" -j KUBE-SEP-LEDXNGZ5TZMIGQDD

-A KUBE-SEP-GDFWTYWRXAR6P5IV -s 10.244.0.50/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-GDFWTYWRXAR6P5IV -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.50:80

-A KUBE-SEP-KT26XBLI5UEBCGC6 -s 10.244.0.51/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-KT26XBLI5UEBCGC6 -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.51:80

-A KUBE-SEP-LEDXNGZ5TZMIGQDD -s 10.244.0.52/32 -m comment --comment "default/nginx-basic:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-LEDXNGZ5TZMIGQDD -p tcp -m comment --comment "default/nginx-basic:http" -m tcp -j DNAT --to-destination 10.244.0.52:80

-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING

-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000 # mark packet with 0x4000

-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN
-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0 # clear mark 0x4000
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully

-A FORWARD -m comment --comment "kubernetes forwarding rules" -j KUBE-FORWARD

-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -m mark --mark 0x4000/0x4000 -j ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man8/iptables-extensions.8.html">iptables-extensions(8) — Linux manual page</a></p>
</blockquote>
<h5 id="NodePort-的-iptables-分析"><a href="#NodePort-的-iptables-分析" class="headerlink" title="NodePort 的 iptables 分析"></a>NodePort 的 iptables 分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-service
NAME            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
nginx-service   NodePort   <span class="token number">10.97</span>.2.223   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30506/TCP   171m

$ kubectl get ep nginx-service
NAME            ENDPOINTS                                     AGE
nginx-service   <span class="token number">10.244</span>.0.10:80,10.244.0.11:80,10.244.0.9:80   171m

$ nft list chain <span class="token function">ip</span> nat KUBE-NODEPORTS
table <span class="token function">ip</span> nat <span class="token punctuation">{</span>
    chain KUBE-NODEPORTS <span class="token punctuation">{</span>
        meta l4proto tcp  tcp dport <span class="token number">30506</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-6IM33IEVEEV7U3GP
        meta l4proto tcp  tcp dport <span class="token number">31235</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-CG5I4G2RS3ZVWGLK
        meta l4proto tcp  tcp dport <span class="token number">31687</span> counter packets <span class="token number">0</span> bytes <span class="token number">0</span> jump KUBE-EXT-EDNDUDH2C75GIR6O
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES

-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS

-A KUBE-NODEPORTS -p tcp -m comment --comment "default/nginx-service:http" -j KUBE-EXT-6IM33IEVEEV7U3GP

-A KUBE-EXT-6IM33IEVEEV7U3GP -m comment --comment "masquerade traffic for default/nginx-service:http external destinations" -j KUBE-MARK-MASQ
-A KUBE-EXT-6IM33IEVEEV7U3GP -j KUBE-SVC-6IM33IEVEEV7U3GP

-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000

-A KUBE-SVC-6IM33IEVEEV7U3GP ! -s 10.244.0.0/16 -d 10.97.2.223/32 -p tcp -m comment --comment "default/nginx-service:http cluster IP" -j KUBE-MARK-MASQ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.10:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-UNA35ZJ3UYOAR4VQ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.11:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BSP7ITGKKKE54DZJ
-A KUBE-SVC-6IM33IEVEEV7U3GP -m comment --comment "default/nginx-service:http -&gt; 10.244.0.9:80" -j KUBE-SEP-5AGZ67ZS4PKMABRU

-A KUBE-SEP-UNA35ZJ3UYOAR4VQ -s 10.244.0.10/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-UNA35ZJ3UYOAR4VQ -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.10:80

-A KUBE-SEP-BSP7ITGKKKE54DZJ -s 10.244.0.11/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-BSP7ITGKKKE54DZJ -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.11:80

-A KUBE-SEP-5AGZ67ZS4PKMABRU -s 10.244.0.9/32 -m comment --comment "default/nginx-service:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-5AGZ67ZS4PKMABRU -p tcp -m comment --comment "default/nginx-service:http" -m tcp -j DNAT --to-destination 10.244.0.9:80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md">https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/IPVS.png" alt="IPVS"></p>
<h4 id="IPVS-支持的锚点和核心函数"><a href="#IPVS-支持的锚点和核心函数" class="headerlink" title="IPVS 支持的锚点和核心函数"></a>IPVS 支持的锚点和核心函数</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/IPVS支持的锚点和核心函数.png" alt="IPVS支持的锚点和核心函数"></p>
<p>注意：PREROUTING 和 POSTROUTING 这个两个地方是没有 hook 的，所以 ipvs 不能像 iptables 那样在 PREROUTING 做 dnat 或者 在 POSTROUTING 做 dnat。</p>
<p>ipvs 的做法是在本机虚拟出一个新的网卡（一般叫 <code>kube-ipvs0</code>），然后把所有的 cluster ip 都绑定到这个网卡上，但是不接受 arp 的请求，所以依然不能 ping 通（ping 时会返回错误 <code>Destination Port Unreachable</code>）。随后当访问 cluster ip 时，kernel 就可以在 LOCAL_IN 做转发规则了。</p>
<p>因为 ipvs 在 POSTROUTING 是没有 hook 的，当需要做数据包转发 IP 伪装（IP 伪装指的是网络包从 pod 发出时，需要伪装成从 node 发出的，不然就可能收不到发回的数据包）时，即在数据包离开当前 Node 时需要进行处理，而由于 ipvs 在 POSTROUTING 是没有 hook 的，所以即使开启了 ipvs ，也需要通过配置一条 iptables 规则来完成 IP 伪装。</p>
<p>那么具体是如何用一条规则来完成 IP 伪装呢？通过使用 <code>ipset</code> 来完成。它会把那些一系列相同类型的 ip 归为一类来一起操作。</p>
<h5 id="ipvs-的分析"><a href="#ipvs-的分析" class="headerlink" title="ipvs 的分析"></a>ipvs 的分析</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc nginx-service
NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
nginx-service   ClusterIP   <span class="token number">10.96</span>.57.249   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    20m

$ kubectl get ep nginx-service
NAME            ENDPOINTS                     AGE
nginx-service   <span class="token number">10.244</span>.0.6:80,10.244.0.7:80   56m

$ ipvsadm -L -n
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.96</span>.57.249:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.6:53                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.7:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

$ <span class="token function">ip</span> addr show dev kube-ipvs0
<span class="token number">7</span>: kube-ipvs0: <span class="token operator">&lt;</span>BROADCAST,NOARP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default
    link/ether be:23:dc:d5:57:95 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.96</span>.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.96</span>.57.249/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.96</span>.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

$ <span class="token function">sudo</span> ipset -L
Name: KUBE-IPVS-IPS
Type: hash:ip
Revision: <span class="token number">5</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x70d2a064
Size <span class="token keyword">in</span> memory: <span class="token number">320</span>
References: <span class="token number">1</span>
Number of entries: <span class="token number">3</span>
Members:
<span class="token number">10.96</span>.0.1
<span class="token number">10.96</span>.57.249
<span class="token number">10.96</span>.0.10

Name: KUBE-CLUSTER-IP
Type: hash:ip,port
Revision: <span class="token number">6</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x9d4edeef
Size <span class="token keyword">in</span> memory: <span class="token number">440</span>
References: <span class="token number">3</span>
Number of entries: <span class="token number">5</span>
Members:
<span class="token number">10.96</span>.0.10,udp:53
<span class="token number">10.96</span>.0.10,tcp:53
<span class="token number">10.96</span>.57.249,tcp:80
<span class="token number">10.96</span>.0.1,tcp:443
<span class="token number">10.96</span>.0.10,tcp:9153

Name: KUBE-LOOP-BACK
Type: hash:ip,port,ip
Revision: <span class="token number">6</span>
Header: family inet hashsize <span class="token number">1024</span> maxelem <span class="token number">65536</span> bucketsize <span class="token number">12</span> initval 0x7a7e1a5a
Size <span class="token keyword">in</span> memory: <span class="token number">488</span>
References: <span class="token number">1</span>
Number of entries: <span class="token number">5</span>
Members:
<span class="token number">10.244</span>.0.5,tcp:9153,10.244.0.5
<span class="token number">10.244</span>.0.7,tcp:80,10.244.0.7
<span class="token number">10.244</span>.0.6,tcp:80,10.244.0.6
<span class="token number">10.244</span>.0.5,udp:53,10.244.0.5
<span class="token number">10.244</span>.0.5,tcp:53,10.244.0.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">*filter
-A INPUT -m comment --comment "kubernetes ipvs access filter" -j KUBE-IPVS-FILTER

-A KUBE-IPVS-FILTER -m set --match-set KUBE-CLUSTER-IP dst,dst -j RETURN
-A KUBE-IPVS-FILTER -m conntrack --ctstate NEW -m set --match-set KUBE-IPVS-IPS dst -j REJECT --reject-with icmp-port-unreachable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这也是为什么在 ipvs 模式下，ping cluster ip 会返回错误 <code>icmp-port-unreachable</code>。</p>
</blockquote>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">*nat
-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING
-A KUBE-LOAD-BALANCER -j KUBE-MARK-MASQ
-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
-A KUBE-POSTROUTING -m comment --comment "Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose" -m set --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE
-A KUBE-POSTROUTING -j RETURN
-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully
-A KUBE-SERVICES -s 127.0.0.0/8 -j RETURN
-A KUBE-SERVICES ! -s 10.244.0.0/16 -m comment --comment "Kubernetes service cluster ip + port for masquerade purpose" -m set --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ
-A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODE-PORT
-A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="调整-kube-proxy-使用-ipvs"><a href="#调整-kube-proxy-使用-ipvs" class="headerlink" title="调整 kube-proxy 使用 ipvs"></a>调整 kube-proxy 使用 ipvs</h4><blockquote>
<p>IPVS proxier will employ IPTABLES in doing packet filtering, SNAT or masquerade. Specifically, IPVS proxier will use ipset to store source or destination address of traffics that need DROP or do masquerade, to make sure the number of IPTABLES rules be constant, no matter how many services we have.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#when-ipvs-falls-back-to-iptables">When IPVS falls back to IPTABLES</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#run-kube-proxy-in-ipvs-mode">Run kube-proxy in IPVS mode</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kube-system get configmap
NAME                                                   DATA   AGE
coredns                                                <span class="token number">1</span>      13m
extension-apiserver-authentication                     <span class="token number">6</span>      13m
kube-apiserver-legacy-service-account-token-tracking   <span class="token number">1</span>      13m
kube-proxy                                             <span class="token number">2</span>      13m
kube-root-ca.crt                                       <span class="token number">1</span>      12m
kubeadm-config                                         <span class="token number">1</span>      13m
kubelet-config                                         <span class="token number">1</span>      13m

$ kubectl -n kube-system edit configmap kube-proxy
<span class="token comment"># change mode from "" to "ipvs"</span>

$ kubectl -n kube-system get configmap kube-proxy -oyaml <span class="token operator">|</span> <span class="token function">grep</span> mode
    mode: <span class="token string">"ipvs"</span>

$ kubectl -n kube-system get pods
NAME                               READY   STATUS    RESTARTS      AGE
coredns-7db6d8ff4d-44mqh           <span class="token number">1</span>/1     Running   <span class="token number">0</span>             14m
etcd-minikube                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-apiserver-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-controller-manager-minikube   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
kube-proxy-6s7hr                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             9m55s
kube-scheduler-minikube            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             15m
storage-provisioner                <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>14m ago<span class="token punctuation">)</span>   15m

<span class="token comment"># delete kube-proxy pod to take effect</span>
$ kubectl -n kube-system delete pod kube-proxy-6s7hr
pod <span class="token string">"kube-proxy-6s7hr"</span> deleted

$ minikube <span class="token function">ssh</span>
$ <span class="token function">sudo</span> ipvsadm -L -n
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.96</span>.57.249:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.3:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.0.4:80                Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>如果 kube-proxy 的模式配置的是使用 ipvs，但是一个节点并未安装 ipvs 模块，那么在这个节点会自动降级使用 iptables。</p>
</blockquote>
<h4 id="域名服务"><a href="#域名服务" class="headerlink" title="域名服务"></a>域名服务</h4><p>Kubernetes Service 通过虚拟 IP 地址或者节点端口为用户应用提供访问入口</p>
<p>然而这些 IP 地址和端口是动态分配的，如果用户重建一个服务，其分配的 clusterIP 和 nodePort，以及 LoadBalancerIP 都是会变化的，我们无法把一个可变的入口发布出去供他人访问</p>
<p>Kubernetes 提供了内置的域名服务，用户定义的服务会自动获得域名，而无论服务重建多少次，只要服务名不改变，其对应的域名就不会改变</p>
<h4 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h4><p>CoreDNS 包含一个内存态 DNS，以及与其他 controller 类似的控制器</p>
<p>CoreDNS 的实现原理是，控制器监听 Service 和 Endpoint 的变化并配置 DNS，客户端 Pod 在进行域名解析时，从 CoreDNS 中查询服务对应的地址记录</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CoreDNS.png" alt="CoreDNS"></p>
<h4 id="不同类型服务的-DNS-记录"><a href="#不同类型服务的-DNS-记录" class="headerlink" title="不同类型服务的 DNS 记录"></a>不同类型服务的 DNS 记录</h4><ul>
<li>普通 Service<ul>
<li>ClusterIP、nodePort、LoadBalancer 类型的 Service 都拥有 API Server 分配的 ClusterIP，CoreDNS 会为这些 Service 创建 FQDN 格式为 <code>$svcname.$namespace.svc.$clusterdomain:clusterIP</code> 的 A 记录及 PTR 记录，并为端口创建 SRV 记录。</li>
</ul>
</li>
<li>Headless Service<ul>
<li>顾名思义，无头，是用户在 Spec 显式指定 ClusterIP 为 None 的 Service，对于这类 Service，API Server 不会为其分配 ClusterIP。CoreDNS 为此类 Service 创建多条 A 记录，并且目标为每个就绪的 PodIP。</li>
<li>另外，每个 Pod 会拥有一个 FQDN 格式为 <code>$podname.$svcname.$namespace.svc.$clusterdomain</code> 的 A 记录指向 PodIP。</li>
</ul>
</li>
<li>ExternalName Service<ul>
<li>此类 Service 用来引用一个已经存在的域名，CoreDNS 会为该 Service 创建一个 CName 记录指向目标域名。</li>
</ul>
</li>
</ul>
<blockquote>
<p>从 ClusterIP 到 nodePort 到 LoadBalancer，后一个类型都包含前一个类型的内容。比如 NodePort 也会有一个 ClusterIP。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">dig</span> @10.96.0.10 nginx-headless-service.default.svc.cluster.local
<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> DiG <span class="token number">9.18</span>.24-1-Debian <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> @10.96.0.10 nginx-headless-service.default.svc.cluster.local
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token number">1</span> server found<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: .local is reserved <span class="token keyword">for</span> Multicast DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> You are currently testing what happens when an mDNS query is leaked to DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">&gt;&gt;</span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">20453</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">3</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: recursion requested but not available

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">1232</span>
<span class="token punctuation">;</span> COOKIE: 6958770a033fcd30 <span class="token punctuation">(</span>echoed<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>nginx-headless-service.default.svc.cluster.local. IN A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.13
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.12
nginx-headless-service.default.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.0.14

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">10</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">10.96</span>.0.10<span class="token comment">#53(10.96.0.10) (UDP)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu May <span class="token number">16</span> <span class="token number">10</span>:29:47 UTC <span class="token number">2024</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">281</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Kubernetes-中的域名解析"><a href="#Kubernetes-中的域名解析" class="headerlink" title="Kubernetes 中的域名解析"></a>Kubernetes 中的域名解析</h4><p>Kubernetes Pod 有一个与 DNS 策略相关的属性 DNSPolicy，默认值是 ClusterFirst。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy">Pod’s DNS Policy</a></p>
</blockquote>
<p>Pod启动后的 <code>/etc/resolv.conf</code> 会被改写，所有的地址解析优先发送至 CoreDNS</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /etc/resolv.conf
search ns1.svc.cluster.local svc.cluster.local cluster.local
nameserver <span class="token number">192.168</span>.0.10
options ndots:4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ndots 的意思是如果待查询的域名中点 “.” 的数量小于 ndots 的数量，那么解析这个域名时就是尝试将 search 后配置的域名按顺序添加到带解析的域名后，直到成功。</p>
<p>比如：解析域名 nginx-service 时，因为域名中的点 “.” 的个数为 0，小于配置的 ndots 数，就会依次尝试解析域名 <code>nginx-service.ns1.svc.cluster.local</code>，<code>nginx-service.svc.cluster.local</code> 和 <code>nginx-service.cluster.local</code>。</p>
</blockquote>
<p>当 Pod 启动时，同一 Namespace 的所有 Service 都会以环境变量的形式设置到容器内（更准确的来说是能只用 service name 解析出同一 namespace 中的所有 service 的 IP）</p>
<p>影响?</p>
<h4 id="自定义-DNSPolicy"><a href="#自定义-DNSPolicy" class="headerlink" title="自定义 DNSPolicy"></a>自定义 DNSPolicy</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config">Pod’s DNS Config</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dns<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> <span class="token string">"None"</span>
  <span class="token key atrule">dnsConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">nameservers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 192.0.2.1 <span class="token comment"># this is an example</span>
    <span class="token key atrule">searches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ns1.svc.cluster<span class="token punctuation">-</span>domain.example
      <span class="token punctuation">-</span> my.dns.search.suffix
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ndots
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> edns0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CoreDNS-的配置"><a href="#CoreDNS-的配置" class="headerlink" title="CoreDNS 的配置"></a>CoreDNS 的配置</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">$ kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get configmap coredns <span class="token punctuation">-</span>oyaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    .:53 {
        log
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        hosts {
           192.168.49.1 host.minikube.internal
           fallthrough
        }
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2024-05-16T09:16:06Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"253"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> aabafb2b<span class="token punctuation">-</span>f121<span class="token punctuation">-</span>4a2f<span class="token punctuation">-</span>896b<span class="token punctuation">-</span>89be5142d4d5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="关于-DNS-的落地实践"><a href="#关于-DNS-的落地实践" class="headerlink" title="关于 DNS 的落地实践"></a>关于 DNS 的落地实践</h4><p>Kubernetes 作为企业基础架构的一部分，Kubernetes 服务也需要发布到企业 DNS，需要定制企业 DNS 控制器</p>
<ul>
<li>对于 Kubernetes 中的服务，在企业 DNS 同样创建 A/PTR/SRV records (通常解析地址是 LoadBalancer VIP)</li>
<li>针对 headless service，在 PodIP 可全局路由的前提下，按需创建 DNS records</li>
<li>Headless service 的 DNS 记录，应该按需创建，否则对企业 DNS 冲击过大</li>
</ul>
<p>服务在集群内通过 CoreDNS 寻址，在集群外通过企业 DNS 寻址，服务在集群内外有统一标识。</p>
<h4 id="Kubernetes-中的负载均衡技术"><a href="#Kubernetes-中的负载均衡技术" class="headerlink" title="Kubernetes 中的负载均衡技术"></a>Kubernetes 中的负载均衡技术</h4><p>基于 L4 的服务</p>
<ul>
<li>基于 iptables/ipvs 的分布式四层负载均衡技术</li>
<li>多种 Load Balancer Provider 提供与企业现有 ELB 的整合</li>
<li>kube-proxy 基于 iptables rules 为 Kubernetes 形成全局统一的 distributed load balancer</li>
<li>kube-proxy 是一种 mesh, InternalClient 无论通过 podip，nodeport 还是 LBVIP 都经由 kube-proxy 跳转至pod</li>
<li>属于 Kubernetes core</li>
</ul>
<p>基于L7的 Ingress</p>
<ul>
<li>基于七层应用层，提供更多功能</li>
<li>TLS termination</li>
<li>L7 path forwarding</li>
<li>URL/http header rewrite</li>
<li>与采用 7 层软件紧密相关</li>
</ul>
<h4 id="Service-中的-Ingress-的对比"><a href="#Service-中的-Ingress-的对比" class="headerlink" title="Service 中的 Ingress 的对比"></a>Service 中的 Ingress 的对比</h4><p>基于 L4 的服务</p>
<ul>
<li>每个应用独占 ELB，浪费资源</li>
<li>为每个服务动态创建 DNS 记录，频繁的 DNS 更新</li>
<li>支持 TCP 和 UDP，业务部门需要启动 HTTPS 服务，自己管理证书</li>
</ul>
<p>基于 L7 的 Ingress</p>
<ul>
<li>多个应用共享 ELB，节省资源</li>
<li>多个应用共享一个 Domain，可采用静态 DNS 配置</li>
<li>TLS termination 发生在 Ingress 层，可集中管理证书</li>
<li>更多复杂性，更多的网络 hop</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Service中的Ingress的对比.png" alt="Service中的Ingress的对比"></p>
<h4 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h4><p>ingress</p>
<ul>
<li>Ingress 是一层代理</li>
<li>负责根据 hostname 和 path 将流量转发到不同的服务上，使得一个负载均衡器用于多个后台应用</li>
<li>Kubernetes Ingress Spec 是转发规则的集合</li>
</ul>
<p>ingress Controller</p>
<ul>
<li>确保实际状态( Actual )与期望状态( Desired )一致的 ControlLoop</li>
<li>Ingress Controller 确保</li>
<li>负载均衡配置</li>
<li>边缘路由配置</li>
<li>DNS 配置</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ingress.png" alt="ingress"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module8/ingress/ingress.MD">https://github.com/kibaamor/101/blob/master/module8/ingress/ingress.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://cert-manager.io/docs/configuration/ca/">https://cert-manager.io/docs/configuration/ca/</a></p>
<p><a target="_blank" rel="noopener" href="https://cert-manager.io/docs/configuration/selfsigned/">https://cert-manager.io/docs/configuration/selfsigned/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成 key 和 cert</span>
$ openssl req -x509 -nodes -days <span class="token number">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt <span class="token punctuation">\</span>
  -subj <span class="token string">'/CN=*/O=kiba'</span> <span class="token punctuation">\</span>
  -addext <span class="token string">'subjectAltName = DNS:kiba.zen'</span>
<span class="token comment"># OR</span>
$ mkcert -key-file tls.key -cert-file tls.crt -- kiba.zen

<span class="token comment"># 创建 secret</span>
$ kubectl create secret tls kiba-tls --cert<span class="token operator">=</span>./tls.crt --key<span class="token operator">=</span>./tls.key
secret/kiba-tls created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># filename: nginx.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kiba.zen
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kiba<span class="token punctuation">-</span>tls
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kiba.zen
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">service</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
              <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 nginx</span>
$ kubectl apply -f nginx.yaml
deployment.apps/nginx-deploy created
service/nginx-svc created
ingress.networking.k8s.io/nginx-ingress created

$ minikube <span class="token function">ip</span>
<span class="token number">192.168</span>.49.2

<span class="token comment"># 确保没有代理，https_proxy 和 HTTPS_PROXY 的值为空</span>
$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> <span class="token function">curl</span> --resolve <span class="token string">"kiba.zen:443:192.168.49.2"</span> --cacert ./tls.crt https://kiba.zen
<span class="token comment"># OR</span>
$ <span class="token function">curl</span> --noproxy <span class="token string">'*'</span> --resolve <span class="token string">"kiba.zen:443:192.168.49.2"</span> --cacert ./tls.crt https://kiba.zen
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="传统应用网络拓扑"><a href="#传统应用网络拓扑" class="headerlink" title="传统应用网络拓扑"></a>传统应用网络拓扑</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/传统应用网络拓扑.png" alt="传统应用网络拓扑"></p>
<h4 id="三步构建-Ingress-Controller"><a href="#三步构建-Ingress-Controller" class="headerlink" title="三步构建 Ingress Controller"></a>三步构建 Ingress Controller</h4><p>复用 Kubernetes LoadBalancer 接口</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">GetLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>LoadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">EnsureLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Senvice<span class="token punctuation">,</span> members <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>LoadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">UpdateLoadBalancer</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">,</span> members <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>api<span class="token punctuation">.</span>oadBalancerStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">EnsureLoadBalancerDeleted</span><span class="token punctuation">(</span>clusterName <span class="token builtin">string</span><span class="token punctuation">,</span> service <span class="token operator">*</span>api<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token builtin">error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义 Informer，监控 ingress，secret，service，endpoint 的变化，加入相应的队列</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">lbc<span class="token punctuation">.</span>ingLister<span class="token punctuation">.</span>Store<span class="token punctuation">,</span>lbc<span class="token punctuation">.</span>ingController <span class="token operator">=</span> framework<span class="token punctuation">.</span><span class="token function">Newinformer</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>cache<span class="token punctuation">.</span>Listwatch<span class="token punctuation">{</span>
        ListFunc<span class="token punctuation">:</span> <span class="token function">ingressListFunc</span><span class="token punctuation">(</span>lbc<span class="token punctuation">.</span>client<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">,</span>
        WatchFunc<span class="token punctuation">:</span> <span class="token function">ingressWatchFunc</span><span class="token punctuation">(</span>lbc<span class="token punctuation">.</span>client<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>extensions<span class="token punctuation">.</span>Ingress<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
        AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obi <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            lbc<span class="token punctuation">.</span>ingQueue<span class="token punctuation">.</span><span class="token function">enqueueing</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动 worker，遍历 ingress 队列</p>
<ul>
<li>为 Ingress Domain 创建 LoadBalancer service 依 赖service controller 创建 ingress vip</li>
<li>为 Ingress Domain 创建 DNS A record 并指向 Ingress VIP</li>
<li>更新 Ingress 状态</li>
</ul>
<h4 id="为什么需要构建-SLB-Soft-Load-Balancer-方案"><a href="#为什么需要构建-SLB-Soft-Load-Balancer-方案" class="headerlink" title="为什么需要构建 SLB(Soft Load Balancer) 方案"></a>为什么需要构建 SLB(Soft Load Balancer) 方案</h4><p>成本</p>
<ul>
<li>硬件 LB 价格昂贵</li>
<li>固定的 tech refresh 周期</li>
</ul>
<p>配置管理</p>
<ul>
<li>LB 设备的 onboard/offboard 由不同 team 管理</li>
<li>不同设备 API 不一样，不支持 L7 API</li>
<li>基于传统的 ssh 接口，效率低下</li>
<li>Flex up/down 以及 Migration 复杂</li>
</ul>
<p>部署模式</p>
<ul>
<li>1+1 模式</li>
<li>隔离性差</li>
</ul>
<h4 id="堪待解决的问题"><a href="#堪待解决的问题" class="headerlink" title="堪待解决的问题"></a>堪待解决的问题</h4><p>负载均衡配置</p>
<ul>
<li>7 层方案：Envoy vs. Nginx vs. Haproxy</li>
<li>4 层方案：抛弃传统 HLB(Hardware Load Balancer) 的支持，用 IPVS 取代</li>
</ul>
<p>边缘路由配置</p>
<ul>
<li>Ingress VIP 通过 BGP 协议发布给 TOR (Top-of-rack)</li>
</ul>
<p>DNS 配置</p>
<ul>
<li>Ingress VIP 通过 BGP 协议发布给 TOR (Top-of-rack)</li>
</ul>
<p>需要解决问题：如何让 domain 用户自定义后台应用的访问地址，如何优化访问路径</p>
<ul>
<li><p>L4 Provider</p>
<p>  IPVS 插件</p>
<ul>
<li>基于 IPAM 分配 VIP</li>
<li>将 VIP 绑定至 IPVS Directors</li>
<li>创建 IP tunnel</li>
<li>通过 BGP 发布 VIP 路由</li>
</ul>
</li>
<li><p>L7 Provider</p>
<ul>
<li>基于 Envoy 提供 L7 Path forwarding</li>
<li>可以提供 TLS Termination</li>
<li>基于 upstream 的 Istio 实现配置管理和热加载</li>
<li>基于 Istio 实现 Service Mesh</li>
</ul>
</li>
<li><p>DNS Provider</p>
<ul>
<li>创建 DNS 记录</li>
<li>为多个 Cluster 的 ingress VIP 生成相同的 DNS 记录实现 DNS 联邦</li>
</ul>
</li>
<li><p>Ingress Controller</p>
<ul>
<li>编排控制器</li>
<li>为 ingress 创建 service object，将 LB 配置委派给 service controller</li>
<li>创建 configmap 为每个 ingress 创建 envoy 配置</li>
<li>创建 L7 pod 的 deployment 加载 envoy 集群</li>
<li>生成 DNS 记录</li>
</ul>
</li>
</ul>
<h4 id="L4-集群架构"><a href="#L4-集群架构" class="headerlink" title="L4 集群架构"></a>L4 集群架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/L4集群架构.png" alt="L4集群架构"></p>
<h4 id="L7-集群架构"><a href="#L7-集群架构" class="headerlink" title="L7 集群架构"></a>L7 集群架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/L7集群架构.png" alt="L7集群架构"></p>
<h4 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据流.png" alt="数据流"></p>
<h4 id="跨大陆的互联网调用"><a href="#跨大陆的互联网调用" class="headerlink" title="跨大陆的互联网调用"></a>跨大陆的互联网调用</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/跨大陆的互联网调用.png" alt="跨大陆的互联网调用"></p>
<h4 id="互联网路径的不确定性"><a href="#互联网路径的不确定性" class="headerlink" title="互联网路径的不确定性"></a>互联网路径的不确定性</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/互联网路径的不确定性.png" alt="互联网路径的不确定性"></p>
<h4 id="边缘加速方案综述"><a href="#边缘加速方案综述" class="headerlink" title="边缘加速方案综述"></a>边缘加速方案综述</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/边缘加速方案综述.png" alt="边缘加速方案综述"></p>
<h4 id="边缘加速组件"><a href="#边缘加速组件" class="headerlink" title="边缘加速组件"></a>边缘加速组件</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/边缘加速组件.png" alt="边缘加速组件"></p>
<blockquote>
<p>POP 指边缘的小的数据中心。</p>
</blockquote>
<h4 id="对网络路径的优化"><a href="#对网络路径的优化" class="headerlink" title="对网络路径的优化"></a>对网络路径的优化</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/对网络路径的优化.png" alt="对网络路径的优化"></p>
<h4 id="不同方案的响应时间对比"><a href="#不同方案的响应时间对比" class="headerlink" title="不同方案的响应时间对比"></a>不同方案的响应时间对比</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/不同方案的响应时间对比.png" alt="不同方案的响应时间对比"></p>
<h4 id="课后作业-第二部分"><a href="#课后作业-第二部分" class="headerlink" title="课后作业(第二部分)"></a>课后作业(第二部分)</h4><p>除了将 httpServer 应用优雅的运行在 Kubernetes 之上，我们还应该考虑如何将服务发布给对内和对外的调用方。</p>
<p>来尝试用 Service，Ingress 将你的服务发布给集群外部的调用方吧</p>
<p>在第一部分的基础上提供更加完备的部署 spec，包括(不限于)</p>
<ul>
<li>Service</li>
<li>Ingress</li>
</ul>
<p>可以考虑的细节</p>
<ul>
<li>如何确保整个应用的高可用</li>
<li>如何通过证书保证 httpServer 的通讯安全</li>
</ul>
<h2 id="生产化集群的管理"><a href="#生产化集群的管理" class="headerlink" title="生产化集群的管理"></a>生产化集群的管理</h2><h3 id="计算节点相关"><a href="#计算节点相关" class="headerlink" title="计算节点相关"></a>计算节点相关</h3><h4 id="生产化集群的考量"><a href="#生产化集群的考量" class="headerlink" title="生产化集群的考量"></a>生产化集群的考量</h4><p>计算节点:</p>
<ul>
<li>如何批量安装和升级计算节点的操作系统?</li>
<li>如何管理配置计算节点的网络信息?</li>
<li>如何管理不同 SKU(Stock Keeping Unit) 的计算节点?</li>
<li>如何快速下架故障的计算节点?</li>
<li>如何快速扩缩集群的规模?</li>
</ul>
<p>控制平面:</p>
<ul>
<li>如何在主节点上下载、安装和升级控制平面组件及其所需的配置文件?</li>
<li>如何确保集群所需的其他插件，例如 CoreDNS、监控系统等部署完成?</li>
<li>如何准备控制平面组件的各种安全证书?</li>
<li>如何快速升级或回滚控制平面组件的版本?</li>
</ul>
<h3 id="操作系统选择"><a href="#操作系统选择" class="headerlink" title="操作系统选择"></a>操作系统选择</h3><h4 id="操作系统的评估与选择"><a href="#操作系统的评估与选择" class="headerlink" title="操作系统的评估与选择"></a>操作系统的评估与选择</h4><p>通用操作系统</p>
<ul>
<li>Ubuntu</li>
<li>CentOs</li>
<li>Fedora</li>
</ul>
<p>专为容器优化的操作系统</p>
<ul>
<li>最小化操作系统<ul>
<li>CoreOS</li>
<li>RedHat Atomic</li>
<li>Snappy Ubuntu core</li>
<li>RancherOS</li>
</ul>
</li>
</ul>
<p>操作系统评估和选型的标准</p>
<ul>
<li>是否有生态系统</li>
<li>成熟度</li>
<li>内核版本</li>
<li>对运行时的支持</li>
<li>Init System</li>
<li>包管理和系统升级</li>
<li>安全</li>
</ul>
<h4 id="生态系统与成熟度"><a href="#生态系统与成熟度" class="headerlink" title="生态系统与成熟度"></a>生态系统与成熟度</h4><p>容器优化操作系统的优势</p>
<p>原子级升级和回退更高的安全性</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/生态系统与成熟度.png" alt="生态系统与成熟度"></p>
<h4 id="云原生的原则"><a href="#云原生的原则" class="headerlink" title="云原生的原则"></a>云原生的原则</h4><p>可变基础设施的风险</p>
<ul>
<li>在灾难发生的时候，难以重新构建服务。持续过多的手工操作，缺乏记录，会导致很难由标准初始化后的服务器来重新构建起等效的服务。</li>
<li>在服务运行过程中，持续的修改服务器，就犹如程序中的可变变量的值发生变化而引入的状态不一致的并发风险。这些对于服务器的修改，同样会引入中间状态，从而导致不可预知的问题。</li>
</ul>
<p>不可变基础设施 (immutable infrastructure)</p>
<ul>
<li>不可变的容器镜像</li>
<li>不可变的主机操作系统</li>
</ul>
<h4 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h4><p>由 Red Hat 支持的软件包安装系统</p>
<p>多种 Distro</p>
<ul>
<li>Fedora</li>
<li>CentOS</li>
<li>RHEL</li>
</ul>
<p>优势</p>
<ul>
<li>不可变操作系统，面向容器优化的基础设施<ul>
<li>灵活和安全性较好</li>
<li>只有 /etc 和 /var 可以修改，其他目录均为只读</li>
</ul>
</li>
<li>基于 rpm-ostree 管理系统包<ul>
<li>rpm-ostree 是一个开源项目，使得生产系统中构建镜像非常简单</li>
<li>支持操作系统升级和回滚的原子操作</li>
</ul>
</li>
</ul>
<h4 id="最小化主机操作系统"><a href="#最小化主机操作系统" class="headerlink" title="最小化主机操作系统"></a>最小化主机操作系统</h4><p>原则:</p>
<ul>
<li>最小化主机操作系统。</li>
<li>只安装必要的工具<ul>
<li>必要:支持系统运行的最小工具集</li>
<li>任何调试工具，比如性能排查，网络排查工具，均可以后期以容器形式运行。</li>
</ul>
</li>
<li>意义<ul>
<li>性能</li>
<li>稳定性</li>
<li>安全保障</li>
</ul>
</li>
</ul>
<h4 id="操作系统构建流程"><a href="#操作系统构建流程" class="headerlink" title="操作系统构建流程"></a>操作系统构建流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/操作系统构建流程.png" alt="操作系统构建流程"></p>
<h4 id="ostree"><a href="#ostree" class="headerlink" title="ostree"></a>ostree</h4><p>提供一个共享库(libostree)和一些列命令行</p>
<p>提供与 git 命令行一致的体验，可以提交或者下载一个完整的可启动的文件系统树</p>
<p>提供将 ostree 部署进 bootloader 的机制</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ostreedev/ostree/blob/main/src/boot/dracut/module-setup.sh">https://github.com/ostreedev/ostree/blob/main/src/boot/dracut/module-setup.sh</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dracut_install /usr/lib/ostree/ostree-prepare-root
    <span class="token keyword">for</span> <span class="token for-or-select variable">r</span> <span class="token keyword">in</span> /usr/lib /etc<span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token builtin class-name">test</span> -f <span class="token string">"<span class="token variable">$r</span>/ostree/prepare-root.conf"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            inst_simple <span class="token string">"<span class="token variable">$r</span>/ostree/prepare-root.conf"</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    <span class="token keyword">if</span> <span class="token builtin class-name">test</span> -f <span class="token string">"/etc/ostree/initramfs-root-binding.key"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        inst_simple <span class="token string">"/etc/ostree/initramfs-root-binding.key"</span>
    <span class="token keyword">fi</span>
    inst_simple <span class="token string">"<span class="token variable">${systemdsystemunitdir}</span>/ostree-prepare-root.service"</span>
    <span class="token function">mkdir</span> -p <span class="token string">"<span class="token variable">${initdir}</span><span class="token variable">${systemdsystemconfdir}</span>/initrd-root-fs.target.wants"</span>
    ln_r <span class="token string">"<span class="token variable">${systemdsystemunitdir}</span>/ostree-prepare-root.service"</span> <span class="token punctuation">\</span>
        <span class="token string">"<span class="token variable">${systemdsystemconfdir}</span>/initrd-root-fs.target.wants/ostree-prepare-root.service"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="构建-ostree"><a href="#构建-ostree" class="headerlink" title="构建 ostree"></a>构建 ostree</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/构建ostree.png" alt="构建ostree"></p>
<p>rpm-ostree</p>
<ul>
<li>基于 treefile 将 rpm 包构建成为 ostree</li>
<li>管理 ostree 以及 bootloader 配置</li>
</ul>
<p>treefile</p>
<ul>
<li>refer: 分支名(版本，cpu 架构)</li>
<li>repo: rpm package repositories</li>
<li>packages: 待安装组件</li>
</ul>
<p>将 rpm 构建成 ostree</p>
<ul>
<li><code>rpm-ostree compose tree --unified-core --cachedir=cache --repo=./build-repo/path/to/treefile.json</code></li>
</ul>
<h5 id="加载-ostree"><a href="#加载-ostree" class="headerlink" title="加载 ostree"></a>加载 ostree</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/加载ostree.png" alt="加载ostree"></p>
<p>初始化项目</p>
<ul>
<li><code>ostree admin os-init centos-atomic-host</code></li>
</ul>
<p>导入 ostree repo</p>
<ul>
<li><code>ostree remote add atomic http://ostree.svr/ostree</code></li>
</ul>
<p>拉取ostree</p>
<ul>
<li><code>ostree pull atomic centos-atomic-host/8/x86 64/standard</code></li>
</ul>
<p>部署 os</p>
<ul>
<li><code>ostree admin deploy --os=centos-atomic-hostcentos-atomic-host/8/x86_64/standard --karg='root=/dev/atomicos/root</code></li>
</ul>
<h5 id="操作系统加载"><a href="#操作系统加载" class="headerlink" title="操作系统加载"></a>操作系统加载</h5><p>物理机</p>
<ul>
<li>物理机通常需要通过 foreman 启动，foreman 通过 pxe boot，并加载 kickstart</li>
<li>kickstart 通过 ostree deploy 即可完成操作系统的部署</li>
</ul>
<p>虚拟机</p>
<ul>
<li>需要通过镜像工具将 ostree 构建成 qcow2 格式，vhd，raw 等模式</li>
</ul>
<h4 id="生产环境遭遇过的陷阱"><a href="#生产环境遭遇过的陷阱" class="headerlink" title="生产环境遭遇过的陷阱"></a>生产环境遭遇过的陷阱</h4><p>cloud-init 0.7.7 bug</p>
<ul>
<li>阻止 node 在初始化过程中的静态网络配置</li>
</ul>
<p>Docker 1.9.1 bug</p>
<ul>
<li>当 docker 实例日志快速输出时，会发生内存泄漏</li>
</ul>
<p>Kernel panic in 4.4.6</p>
<ul>
<li>Cgroup 创建和销毁过程中，会产生kernel panic</li>
</ul>
<p>rootfs 分区太小</p>
<ul>
<li>rootfs 无空间会导致 docker 无法启动<ul>
<li>导致 rootfs 占满的情况<ul>
<li>CICD 中的 Maven build 会把下载的 lib 放在 /tmp</li>
<li>用户 Docker logs 日志过快，导致一个 log rotation 周期内日志文件撑爆硬盘</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>需要定制化的操作系统参数</p>
<ul>
<li>比如 Elasticsearch 需要 max_map_count &gt;= 262144，但操作系统默认值为 65535，我们需要在创建 Node 的时候就 apply 这个配置</li>
</ul>
<h3 id="节点资源管理"><a href="#节点资源管理" class="headerlink" title="节点资源管理"></a>节点资源管理</h3><h4 id="NUMA-Node"><a href="#NUMA-Node" class="headerlink" title="NUMA Node"></a>NUMA Node</h4><p>Non-Uniform Memory Access是一种内存访问方式，是为多处理器计算机设计的内存架构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/NUMANode.png" alt="NUMANode"></p>
<h4 id="节点资源管理-1"><a href="#节点资源管理-1" class="headerlink" title="节点资源管理"></a>节点资源管理</h4><p>状态汇报</p>
<p>资源预留</p>
<p>防止节点资源耗尽的防御机制驱逐</p>
<p>容器和系统资源的配置</p>
<h4 id="状态上报"><a href="#状态上报" class="headerlink" title="状态上报"></a>状态上报</h4><p>kubelet 周期性地向 APIServer 进行汇报，并更新节点的相关健康和资源使用信息</p>
<ul>
<li>节点基础信息，包括 IP 地址、操作系统、内核、运行时、kubelet、kube-proxy版本信息。</li>
<li>节点资源信息包括 CPU、内存、HugePage、临时存储、GPU 等注册设备，以及这些资源中可以分配给容器使用的部分。</li>
<li>调度器在为 Pod 选择节点时会将机器的状态信息作为依据。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/状态上报.png" alt="状态上报"></p>
<h5 id="Lease"><a href="#Lease" class="headerlink" title="Lease"></a>Lease</h5><p>在早期版本 kubelet 的状态上报直接更新 node 对象，而上报的信息包含状态信息和资源信息，因此需要传输的数据包较大，给 APIServer 和 etcd 造成的压力较大。</p>
<p>后引入 Lease 对象用来保存健康信息，在默认 40s 的 nodeLeaseDurationSeconds 周期内，若 Lease 对象没有被更新，则对应节点可以被判定为不健康。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> coordination.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Lease
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-08-19T02:50:09Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8snode
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>node<span class="token punctuation">-</span>lease
  <span class="token key atrule">ownerReferences</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apiVersion<span class="token punctuation">:</span>v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Node
    <span class="token key atrule">name</span><span class="token punctuation">:</span> k8snode
    <span class="token key atrule">uid</span><span class="token punctuation">:</span> 58679942<span class="token punctuation">-</span>e2dd<span class="token punctuation">-</span>4ead<span class="token punctuation">-</span>aada<span class="token punctuation">-</span>385f099d5f56
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"1293702"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 1bf51951<span class="token punctuation">-</span>b832<span class="token punctuation">-</span>49da<span class="token punctuation">-</span>8708<span class="token punctuation">-</span>4b224b1ec3ed
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">holderIdentity</span><span class="token punctuation">:</span> k8snode
  <span class="token key atrule">leaseDurationSeconds</span><span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token key atrule">renewTime</span><span class="token punctuation">:</span> <span class="token string">"2021-09-08T01:34:16.489589Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="资源预留"><a href="#资源预留" class="headerlink" title="资源预留"></a>资源预留</h4><p>计算节点除用户容器外，还存在很多支撑系统运行的基础服务，譬如 systemd、journald、sshd、dockerd、Containerd、kubelet 等。</p>
<p>为了使服务进程能够正常运行，要确保它们在任何时候都可以获取足够的系统资源，所以我们要为这些系统进程预留资源。</p>
<p>kubelet 可以通过众多启动参数为系统预留 CPU、内存、PID 等资源，比如 SystemReserved、KubeReserved 等。</p>
<h5 id="Capacity-和-Allocatable"><a href="#Capacity-和-Allocatable" class="headerlink" title="Capacity 和 Allocatable"></a>Capacity 和 Allocatable</h5><p>容量资源 (Capacity) 是指 kubelet 获取的计算节点当前的资源信息。</p>
<ul>
<li>CPU 是从 /proc/cpuinfo 文件中获取的节点 CPU 核数;</li>
<li>memory 是从 /proc/memoryinfo 中获取的节点内存大小;</li>
<li>ephemeral-storage 是指节点根分区的大小。</li>
</ul>
<p>资源可分配额 (Allocatable) 是用户 Pod 可用的资源，是资源容量减去分配给系统的资源的剩余部分。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">allocatable</span><span class="token punctuation">:</span>
  <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"24"</span>
  <span class="token key atrule">ephemeral-storage</span><span class="token punctuation">:</span> 205838Mi
  <span class="token key atrule">memory</span><span class="token punctuation">:</span> 177304536Ki
  <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">"110"</span>
<span class="token key atrule">capacity</span><span class="token punctuation">:</span>
  <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"24"</span>
  <span class="token key atrule">ephemeral-storage</span><span class="token punctuation">:</span> 205838Mi
  <span class="token key atrule">memory</span><span class="token punctuation">:</span> 179504088Ki
  <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">"110"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/节点的资源容量.png" alt="节点的资源容量"></p>
<h5 id="节点磁盘管理"><a href="#节点磁盘管理" class="headerlink" title="节点磁盘管理"></a>节点磁盘管理</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module9/node/readme.MD">https://github.com/kibaamor/101/blob/master/module9/node/readme.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/#eviction-signals">https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/#eviction-signals</a></p>
<p>系统分区 nodefs</p>
<ul>
<li>工作目录和容器日志</li>
<li>The node’s main filesystem, used for local disk volumes, emptyDir volumes not backed by memory, log storage, and more. For example, nodefs contains /var/lib/kubelet/.</li>
</ul>
<p>容器运行时分区 imagefs</p>
<ul>
<li>用户镜像和容器可写层</li>
<li>容器运行时分区是可选的，可以合并到系统分区中</li>
<li>An optional filesystem that container runtimes use to store container images and container writable layers.</li>
</ul>
<h4 id="驱逐管理"><a href="#驱逐管理" class="headerlink" title="驱逐管理"></a>驱逐管理</h4><p>kubelet 会在系统资源不够时中止一些容器进程，以空出系统资源，保证节点的稳定性。</p>
<p>但由 kubelet 发起的驱逐只停止 Pod 的所有容器进程，并不会直接删除Pod（便于查看原因）。</p>
<ul>
<li>Pod 的 status.phase 会被标记为 Failed</li>
<li>status.reason 会被设置为 Evicted</li>
<li>status.message 则会记录被驱逐的原因</li>
</ul>
<h5 id="资源可用额监控"><a href="#资源可用额监控" class="headerlink" title="资源可用额监控"></a>资源可用额监控</h5><p>kubelet 依赖内嵌的开源软件 cAdvisor，周期性检查节点资源使用情况</p>
<p>CPU 是可压缩资源，根据不同进程分配时间配额和权重，CPU 可被多个进程竞相使用</p>
<p>驱逐策略是基于磁盘和内存资源用量进行的，因为两者属于不可压缩的资源，当此类资源使用耗尽时将无法再申请</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/资源可用额监控.png" alt="资源可用额监控"></p>
<h5 id="驱逐策略"><a href="#驱逐策略" class="headerlink" title="驱逐策略"></a>驱逐策略</h5><p>kubelet 获得节点的可用额信息后，会结合节点的容量信息来判断当前节点运行的 Pod 是否满足驱逐条件。</p>
<p>驱逐条件可以是绝对值或百分比，当监资源的可使用额少于设定的数值或百分比时，kubelet 就会发起驱逐操作。</p>
<p>kubelet 参数 evictionMinimumReclaim 可以设置每次回收的资源的最小值，以防止小资源的多次回收。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/驱逐策略.png" alt="驱逐策略"></p>
<h5 id="基于内存压力的驱逐"><a href="#基于内存压力的驱逐" class="headerlink" title="基于内存压力的驱逐"></a>基于内存压力的驱逐</h5><p>memory.avaiable 表示当前系统的可用内存情况。<br>kubelet 默认设置了 memory.avaiable&lt;100Mi 的硬驱逐条件</p>
<p>当 kubelet 检测到当前节点可用内存资源紧张并满足驱逐条件时，会将节点的 MemoryPressure 状态设置为 True，调度器会阻止 BestEffortPod 调度到内存承压的节点。</p>
<p>kubelet 启动对内存不足的驱逐操作时，会依照如下的顺序选取目标 Pod:</p>
<ol>
<li>判断 Pod 所有容器的内存使用量总和是否超出了请求的内存量，超出请求资源的 Pod 会成为备选目标</li>
<li>查询 Pod 的调度优先级，低优先级的 Pod 被优先驱逐</li>
<li>计算 Pod 所有容器的内存使用量和 Pod 请求的内存量的差值，差值越小，越不容易被驱逐</li>
</ol>
<h5 id="基于磁盘压力的驱逐"><a href="#基于磁盘压力的驱逐" class="headerlink" title="基于磁盘压力的驱逐"></a>基于磁盘压力的驱逐</h5><p>以下任何一项满足驱逐条件时，它会将节点的 DiskPressure 状态设置为 True，调度器不会再调度任何 Pod 到该节点上</p>
<ul>
<li>nodefs.available</li>
<li>nodefs.inodesFree</li>
<li>imagefs.available</li>
<li>imagefs.inodesFree</li>
</ul>
<p>驱逐行为</p>
<ul>
<li>有容器运行时分区<ul>
<li>nodefs 达到驱逐阈值，那么 kubelet 删除已经退出的容器</li>
<li>imagefs 达到驱逐阈值，那么 kubelet 删除所有未使用的镜像</li>
</ul>
</li>
<li>无容器运行时分区<ul>
<li>kubelet 同时删除未运行的容器和未使用的镜像</li>
</ul>
</li>
</ul>
<p>回收已经退出的容器和未使用的镜像后，如果节点依然满足驱逐条件，kubelet 就会开始驱逐正在运行的 Pod，进一步释放磁盘空间。</p>
<ul>
<li>判断 Pod 的磁盘使用量是否超过请求的大小，超出请求资源的 Pod 会成为备选目标</li>
<li>查询Pod的调度优先级，低优先级的 Pod 优先驱逐</li>
<li>根据磁盘使用超过请求的数量进行排序，差值越小，越不容易被驱逐</li>
</ul>
<h4 id="容器和资源配置"><a href="#容器和资源配置" class="headerlink" title="容器和资源配置"></a>容器和资源配置</h4><h5 id="CPU-CGroup-配置"><a href="#CPU-CGroup-配置" class="headerlink" title="CPU CGroup 配置"></a>CPU CGroup 配置</h5><p>针对不同 QoS Class 的 Pod，Kubneretes 按如下 Hierarchy 组织 cgroup 中的 CPU 子系统</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CPUCGroup层级.png" alt="CPUCGroup层级"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/CPUCGroup配置.png" alt="CPUCGroup配置"></p>
<blockquote>
<p>实际测试发现：burstable 容器的 cpu.cfs_quota_us 如果没配就是 -1，如果配置了就是实际的值。</p>
</blockquote>
<h5 id="内存-CGroup-配置"><a href="#内存-CGroup-配置" class="headerlink" title="内存 CGroup 配置"></a>内存 CGroup 配置</h5><p>针对不同 QoS Class 的Pod，Kubneretes 按如下 Hierarchy 组织 cgroup 中的 Memory 子系统</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/内存CGroup层级.png" alt="内存CGroup层级"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/内存CGroup配置.png" alt="内存CGroup配置"></p>
<blockquote>
<p>实际测试发现：burstable 容器的 memory.limit_in_bytes 如果没配就是 9223372036854771712（即未限制），如果配置了就是实际的值。。 </p>
</blockquote>
<h5 id="OOM-Killer-行为"><a href="#OOM-Killer-行为" class="headerlink" title="OOM Killer 行为"></a>OOM Killer 行为</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module9/oom_score/oom_score.md">https://github.com/kibaamor/101/blob/master/module9/oom_score/oom_score.md</a></p>
<p>系统的 OOM Killer 可能会采取 OOM 的方式来中止某些容器的进程，进行必要的内存回收操作</p>
<p>而系统根据进程的 oom_score 来进行优先级排序，选择待终止的进程，且进程的 oom_score 越高，越容易被终止</p>
<p>进程的 oom_score 是根据当前进程使用的内存占节点总内存的比例值乘以 10，再加上 oom_score_adj 综合得到的</p>
<p>而容器进程的 oom_score_adj 正是 kubelet 根据 memory.request 进行设置的</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/oom_score_adj.png" alt="oom_score_adj"></p>
<h4 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h4><p>节点上需要通过运行 logrotate 的定时任务对系统服务日志进行 rotate 清理，以防止系统服务日志占用大量的磁盘空间。</p>
<ul>
<li>logrotate 的执行周期不能过长，以防日志短时间内大量增长，</li>
<li>同时配置日志的 rotate 条件，在日志不占用太多空间的情况下，保证有足够的日志可供查看，</li>
<li>Docker<ul>
<li>除了基于系统 loarotate 管理日志，还可以依赖 Docker 自带的日志管理功能来设置容器日志的数量和每个日志文件的大小。</li>
<li>Docker 写入数据之前会对日志大小进行检查和 rotate 操作，确保日志文件不会超过配置的数量和大小。</li>
</ul>
</li>
<li>Containerd<ul>
<li>日志的管理是通过 kubelet 定期(默认为10s)执行 <code>du</code> 命令，来检查容器日志的数量和文件的大小的。</li>
<li>每个容器日志的大小和可以保留的文件个数，可以通过 kubelet 的配置参数 <code>container-log-max-size</code> 和 <code>container-log-max-files</code> 进行调整。</li>
</ul>
</li>
</ul>
<h4 id="Docker卷管理"><a href="#Docker卷管理" class="headerlink" title="Docker卷管理"></a>Docker卷管理</h4><p>在构建容器镜像时，可以在 Dockerfile 中通过 VOLUME 指令声明一个存储卷，目前 Kubernetes 尚未将其纳入管控范围，不建议使用。</p>
<p>如果容器进程在可写层或 emptyDir 卷进行大量读写操作，就会导致磁盘 I/O 过高，从而影响其他容器进程甚至系统进程。</p>
<p>Docker 和 Containerd 运行时都基于 CGroupv1 。对于块设备，只支持对 Direct I/O 限速，而对于 Buffer I/O 还不具备有效的支持。因此，针对设备限速的问题，目前还没有完美的解决方案对于有特殊 I/O 需求的容器，建议使用独立的磁盘空间。</p>
<h4 id="网络资源"><a href="#网络资源" class="headerlink" title="网络资源"></a>网络资源</h4><p>由网络插件通过 LinuxTraffic control 为 Pod 限制带宽</p>
<p>可利用 CNI 社区提供的 bandwidth 插件</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/ingress-bandwidth</span><span class="token punctuation">:</span> 10MB
    <span class="token key atrule">kubernetes.io/egress-bandwidth</span><span class="token punctuation">:</span> 10MB
<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="进程数"><a href="#进程数" class="headerlink" title="进程数"></a>进程数</h4><p>kubelet 默认不限制 Pod 可以创建的子进程数量，但可以通过启动参数 podPidsLimit 开启限制，还可以由 reserved 参数为系统进程预留进程数。</p>
<ul>
<li>kubelet 通过系统调用周期性地获取当前系统的 PID 的使用量，并读取 <code>/proc/sys/kernel/pid_max</code> 获取系统支持的 PID 上限。</li>
<li>如果当前的可用进程数少于设定阈值，那么 kubelet 会将节点对象的 PIDPressure 标记为 True</li>
<li>kube-scheduler 在进行调度时，会从备选节点中对处于 NodeUnderPIDPressure 状态的节点进行过滤。</li>
</ul>
<h3 id="节点异常检测"><a href="#节点异常检测" class="headerlink" title="节点异常检测"></a>节点异常检测</h3><h4 id="Kubernetes集群可能存在的问题"><a href="#Kubernetes集群可能存在的问题" class="headerlink" title="Kubernetes集群可能存在的问题"></a>Kubernetes集群可能存在的问题</h4><p>基础架构守护程序问题: NTP服务关闭;</p>
<p>硬件问题: CPU，内存或磁盘损坏;</p>
<p>内核问题: 内核死锁，文件系统损坏;</p>
<p>容器运行时问题: 运行时守护程序无响应</p>
<p>…</p>
<p>当 kubernetes 中节点发生上述问题，在整个集群中，k8s 服务组件并不会感知以上问题，就会导致 pod 仍会调度至问题节点。</p>
<h4 id="node-problem-detector"><a href="#node-problem-detector" class="headerlink" title="node-problem-detector"></a>node-problem-detector</h4><p>为了解决这个问题，社区引入了守护进程 node-problem-detector，从各个守护进程收集节点问题，并使它们对上游层可见。</p>
<p>Kubernetes 节点诊断的工具，可以将节点的异常，例如</p>
<ul>
<li>Runtime 无响应</li>
<li>Linux Kernel 无响应</li>
<li>网络异常</li>
<li>文件描述符异常</li>
<li>硬件问题如 CPU，内存或者磁盘故障</li>
</ul>
<h4 id="故障分类"><a href="#故障分类" class="headerlink" title="故障分类"></a>故障分类</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/故障分类.png" alt="故障分类"></p>
<h4 id="问题汇报手段"><a href="#问题汇报手段" class="headerlink" title="问题汇报手段"></a>问题汇报手段</h4><p>node-problem-detector 通过设置 NodeCondition 或者创建 Event 对象来汇报问题</p>
<ul>
<li>NodeCondition: 针对永久性故障，会通过设置 Nodecondition 来改变节点状态</li>
<li>Event: 临时故障通过 Event 来提醒相关对象，比如通知当前节点运行的所有 Pod</li>
</ul>
<h4 id="上手实践"><a href="#上手实践" class="headerlink" title="上手实践"></a>上手实践</h4><p>代码 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/node-problem-detector">https://github.com/kubernetes/node-problem-detector</a></p>
<p>安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm repo <span class="token function">add</span> deliveryhero https://charts.deliveryhero.io
helm <span class="token function">install</span> deliveryhero/node-problem-detector<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="使用插件-pod-启用-NPD"><a href="#使用插件-pod-启用-NPD" class="headerlink" title="使用插件 pod 启用 NPD"></a>使用插件 pod 启用 NPD</h4><p>如果你使用的是自定义集群引导解决方案，不需要覆盖默认配置，可以利用插件 Pod 进一步自动化部署。</p>
<p>创建 node-strick-detector.yaml，并在控制平面节点上保存配置到插件 Pod 的目录 <code>/etc/kubernetes/addons/node-problem-detector</code>。</p>
<h4 id="NPD-的异常处理行为"><a href="#NPD-的异常处理行为" class="headerlink" title="NPD 的异常处理行为"></a>NPD 的异常处理行为</h4><p>NPD 只负责获取异常事件，并修改 node condition，不会对节点状态和调度产生影响</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">lastHeartbeatTime</span><span class="token punctuation">:</span> <span class="token string">"2021-11-06T15:44:46Z"</span>
<span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2021-11-06T15:29:43Z"</span>
<span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">'kernel: INFO: task docker:20744 blocked for more than 120 seconds.'</span>
<span class="token key atrule">reason</span><span class="token punctuation">:</span> DockerHung
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> KernelDeadlock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要自定义控制器，监听 NPD 汇报的 condition，taint node，阻止 pod 调度到故障节点</p>
<p>问题修复后，重启 NPD Pod 来清理错误事件</p>
<h3 id="常用节点问题排查手段"><a href="#常用节点问题排查手段" class="headerlink" title="常用节点问题排查手段"></a>常用节点问题排查手段</h3><h4 id="ssh-到内网节点"><a href="#ssh-到内网节点" class="headerlink" title="ssh 到内网节点"></a>ssh 到内网节点</h4><p>创建一个支持 ssh 的 pod</p>
<p>并通过负载均衡器转发 ssh 请求</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module9/node-problem-detector/ssh-pod.yaml">https://github.com/kibaamor/101/blob/master/module9/node-problem-detector/ssh-pod.yaml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ssh
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> ssh
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> ssh
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alpine
          <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
          <span class="token key atrule">stdin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> cadmin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><p>针对使用 systemd 拉起的服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">journalctl -afu kubelet-S <span class="token string">"2019-08-26 15:00:00"</span>
<span class="token comment"># -u unit，对应的 systemd 拉起的组件，如 kubelet</span>
<span class="token comment"># -f follow，跟踪最新日志</span>
<span class="token comment"># -a show all，显示所有日志列</span>
<span class="token comment"># -S since，从某一时间开始 -S "2019-08-26 15:00:00"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于标准的容器日志</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl logs -f -c <span class="token operator">&lt;</span>containername<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>podname<span class="token operator">&gt;</span>
kubectl logs -f --all-containers <span class="token operator">&lt;</span>podname<span class="token operator">&gt;</span>
kubectl logs -f -c <span class="token operator">&lt;</span>podname<span class="token operator">&gt;</span> --previous<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果容器日志被 shell 转储到文件，则需通过 <code>exec kubectl exec -it xxx --tail -f /path/to/log</code></p>
<h3 id="基于-extended-resource-扩展节点资源"><a href="#基于-extended-resource-扩展节点资源" class="headerlink" title="基于 extended resource 扩展节点资源"></a>基于 extended resource 扩展节点资源</h3><h4 id="扩展资源"><a href="#扩展资源" class="headerlink" title="扩展资源"></a>扩展资源</h4><p>扩展资源是 kubernetes.io 域名之外的标准资源名称。它们使得集群管理员能够颁布非 Kubernetes 内置资源，而用户可以使用他们。</p>
<p>自定义扩展资源无法使用 kubernetes.io 作为资源域名</p>
<h4 id="管理扩展资源"><a href="#管理扩展资源" class="headerlink" title="管理扩展资源"></a>管理扩展资源</h4><p>节点级扩展资源</p>
<ul>
<li>节点级扩展资源绑定到节点</li>
</ul>
<p>设备插件管理的资源</p>
<ul>
<li>发布在各节点上由设备插件所管理的资源，如GPU，智能网卡等</li>
</ul>
<h4 id="为节点配置资源"><a href="#为节点配置资源" class="headerlink" title="为节点配置资源"></a>为节点配置资源</h4><p>集群操作员可以向 API 服务器提交 PATCH HTTP 请求，以在集群中节点的 status.capacity 中为其配置可用数量。</p>
<p>完成此操作后，节点的 status.capacity 字段中将包含新资源。</p>
<p>kubelet 会异步地对 status.allocatable 字段执行自动更新操作，使之包含新资源</p>
<p>调度器在评估 Pod 是否适合在某节点上执行时会使用节点的 status.allocatable 值，在更新节点容量使之包含新资源之后和请求该资源的第一个 Pod 被调度到该节点之间，可能会有短暂的延迟。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module9/extended-resource/extended-resource.MD">https://github.com/kibaamor/101/blob/master/module9/extended-resource/extended-resource.MD</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> --key admin.key --cert admin.crt --header <span class="token string">"Content-Type: application/json-patch+json"</span> <span class="token punctuation">\</span>
--request PATCH -k <span class="token punctuation">\</span>
--data <span class="token string">'[{"op": "add", "path": "/status/capacity/cncamp.com~1reclaimed-cpu", "value": "2"}]'</span> <span class="token punctuation">\</span>
https://192.168.34.2:6443/api/v1/nodes/cadmin/status<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用扩展资源"><a href="#使用扩展资源" class="headerlink" title="使用扩展资源"></a>使用扩展资源</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cncamp.com/reclaimed-cpu</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">reguests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cncamp.com/reclaimed-cpu</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ minikube <span class="token function">cp</span> ~/.minikube/profiles/minikube/client.key /home/docker/client.key

$ minikube <span class="token function">cp</span> ~/.minikube/profiles/minikube/client.crt /home/docker/client.crt

$ kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   107m

$ minikube <span class="token function">ssh</span>

$ <span class="token function">curl</span> <span class="token punctuation">\</span>
    --key /home/docker/client.key <span class="token punctuation">\</span>
    --cert /home/docker/client.crt <span class="token punctuation">\</span>
    --header <span class="token string">"Content-Type: application/json-patch+json"</span> <span class="token punctuation">\</span>
    --request PATCH <span class="token punctuation">\</span>
    --data <span class="token string">'[{"op": "add", "path": "/status/capacity/minikube~1reclaimed-cpu", "value": "2"}]'</span> <span class="token punctuation">\</span>
    https://10.96.0.1:443/api/v1/nodes/minikube/status

$ kubectl get node minikube -oyaml
<span class="token punctuation">..</span>.
status:
  allocatable:
    cpu: <span class="token string">"12"</span>
    ephemeral-storage: 1055762868Ki
    hugepages-1Gi: <span class="token string">"0"</span>
    hugepages-2Mi: <span class="token string">"0"</span>
    memory: 65713372Ki
    minikube/reclaimed-cpu: <span class="token string">"2"</span>
    pods: <span class="token string">"110"</span>
  capacity:
    cpu: <span class="token string">"12"</span>
    ephemeral-storage: 1055762868Ki
    hugepages-1Gi: <span class="token string">"0"</span>
    hugepages-2Mi: <span class="token string">"0"</span>
    memory: 65713372Ki
    minikube/reclaimed-cpu: <span class="token string">"2"</span>
    pods: <span class="token string">"110"</span>
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="集群层面的扩展资源"><a href="#集群层面的扩展资源" class="headerlink" title="集群层面的扩展资源"></a>集群层面的扩展资源</h4><p>可选择由默认调度器管理资源，默认调度器像管理其他资源一样管理扩展资源</p>
<ul>
<li>Request 与 Limit 必须一致，因为 Kubernetes 无法确保扩展资源的超售</li>
</ul>
<p>更常见的场景是，由调度器扩展程序 (SchedulerExtenders) 管理，这些程序处理资源消耗和资源配额</p>
<p>修改调度器策略配置 ignoredByScheduler 字段可配置调度器不要检查自定义资源</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Policy"</span><span class="token punctuation">,</span>
  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"V1"</span><span class="token punctuation">,</span>
  <span class="token property">"extenders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"urlPrefix"</span><span class="token operator">:</span> <span class="token string">"&lt;extender-endpoint&gt;"</span><span class="token punctuation">,</span>
      <span class="token property">"bindVerb"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"managedResources"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"example.com/foo"</span><span class="token punctuation">,</span>
          <span class="token property">"ignoredByScheduler"</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>扩展资源的一个应用：对于有波峰波谷的应用，在波谷时把闲置资源声明成扩展资源，这样就能让其他应用调度到节点上来使用闲置的资源。</p>
<h3 id="构建和管理高可用集群"><a href="#构建和管理高可用集群" class="headerlink" title="构建和管理高可用集群"></a>构建和管理高可用集群</h3><h4 id="Kubernetes-高可用层级"><a href="#Kubernetes-高可用层级" class="headerlink" title="Kubernetes 高可用层级"></a>Kubernetes 高可用层级</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes高可用层级.png" alt="Kubernetes高可用层级"></p>
<h4 id="高可用的数据中心"><a href="#高可用的数据中心" class="headerlink" title="高可用的数据中心"></a>高可用的数据中心</h4><p>多地部署</p>
<p>每个数据中心需要划分成具有独立供电、制冷、网络设备的高可用区</p>
<p>每个高可用区管理独立的硬件资产，包括机架、计算节点、存储、负载均衡器、防火墙等硬件设备</p>
<h4 id="Node-的生命周期管理"><a href="#Node-的生命周期管理" class="headerlink" title="Node 的生命周期管理"></a>Node 的生命周期管理</h4><p>运营 Kubernetes 集群，不仅仅是集群搭建那么简单，运营需要对集群中所有节点的完整申明周期负责。</p>
<ul>
<li>集群搭建</li>
<li>集群扩容/缩容</li>
<li>集群销毁(很少)</li>
<li>无论是集群搭建还是扩容，核心是 Node 的生命周期管理<ul>
<li>Onboard<ul>
<li>物理资产上架</li>
<li>操作系统安装</li>
<li>网络配置</li>
<li>Kubernetes 组件安装</li>
<li>创建 Node 对象</li>
</ul>
</li>
<li>故障处理<ul>
<li>临时故障?重启大法好</li>
<li>永久故障?机器下架</li>
</ul>
</li>
<li>Offboard<ul>
<li>删除 Node 对象</li>
<li>物理资产下架，送修/报废</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="主机管理"><a href="#主机管理" class="headerlink" title="主机管理"></a>主机管理</h4><p>选定哪个版本的系统内核、哪个发行版、安装哪些工具集、主机网络如何规划等。</p>
<p>日常的主机镜像升级更新也可能是造成服务不可用的因素之一。</p>
<ul>
<li>主机镜像更新可以通过 A/B 系统 OTA(OverThe Air) 升级方式进行。<ul>
<li>分别使用 A、B 两个存储空间，共享一份用户数据。在升级过程中，OTA 更新即往其中一个存储空间写入升级包，同时保证了另一个系统可以正常运行，而不会打断用户。如果 OTA 失败，那么设备会启动到 OTA 之前的磁盘分区，并且仍然可以使用。</li>
</ul>
</li>
</ul>
<h4 id="生产化集群管理"><a href="#生产化集群管理" class="headerlink" title="生产化集群管理"></a>生产化集群管理</h4><p>如何设定单个集群规模</p>
<ul>
<li>社区声明单一集群可支持 5000 节点，在如此规模的集群中，大规模部署应用是有诸多挑战的。应该更多还是更少?如何权衡?</li>
</ul>
<p>如何根据地域划分集群</p>
<ul>
<li>不同地域的计算节点划分到同一集群</li>
<li>将同一地域的节点划分到同一集群</li>
</ul>
<p>如何规划集群的网络</p>
<ul>
<li>企业办公环境、测试环境、预生产环境和生产环境应如何进行网络分离</li>
<li>不同租户之间应如何进行网络隔离</li>
</ul>
<p>如何自动化搭建集群</p>
<ul>
<li>如何自动化搭建和升级集群，包括自动化部署控制平面和数据平面的核心组件</li>
<li>如何与企业的公共服务集成</li>
</ul>
<h4 id="企业公共服务"><a href="#企业公共服务" class="headerlink" title="企业公共服务"></a>企业公共服务</h4><p>需要与企业认证平台集成，这样企业用户就能通过统一认证平台接入 Kubernetes 集群，而无须重新设计和管理一套用户系统。</p>
<p>集成企业的域名服务、负载均衡服务，提供集群服务对企业外发布的访问入口</p>
<p>在与企业的公共服务集成时，需要考虑它们的服务是否可靠</p>
<p>对于不能异步调用的请求，采用同步调用需要设置合理的超时时间</p>
<p>过长的超时时间，会延迟结果等待时间，导致整体的链路调用时间延长，从而降低整体的 TPS</p>
<p>有些失败是短暂的、偶然的(比如网络抖动)，进行重试即可。而有些失败是必然的，重试反而会造成调用请求量放大，加重对调用系统的负担</p>
<h4 id="控制平面的高可用保证"><a href="#控制平面的高可用保证" class="headerlink" title="控制平面的高可用保证"></a>控制平面的高可用保证</h4><p>针对大规模的集群，应该为控制平面组件划分单独节点，减少业务容器对控制平面容器或守护进程的干扰和资源抢占</p>
<p>控制平面所在的节点，应确保在不同机架上，以防止因为某些机架的交换机或电源出问题，造成所有的控制面节点都无法工作</p>
<p>保证控制平面的每个组件有足够的 CPU、内存和磁盘资源，过于严苛的资源限制会导致系统效率低下，降低集群可用性</p>
<p>应尽可能地减少或消除外部依赖。在 Kubneretes 初期版本中存在较多 Cloud Provider API 的调用，导致在运营过程中，当 Cloud Provider API 出现故障时，会使得 Kubernetes 集群也无法正常工作。</p>
<p>应尽可能地将控制平面和数据平面解耦，确保控制平面组件出现故障时，将业务影响降到最低。</p>
<p>Kubernetes 还有一些核心插件，是以普通的 Pod 形式加载运行的，可能会被调度到任意工作节点，与普通应用竞争资源。这些插件是否正常运行也决定了集群的可用性。</p>
<h4 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/高可用集群.png" alt="高可用集群"></p>
<h4 id="集群安装方法比较"><a href="#集群安装方法比较" class="headerlink" title="集群安装方法比较"></a>集群安装方法比较</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群安装方法比较.png" alt="集群安装方法比较"></p>
<h4 id="用-Kubeadmin-搭建集群"><a href="#用-Kubeadmin-搭建集群" class="headerlink" title="用 Kubeadmin 搭建集群"></a>用 Kubeadmin 搭建集群</h4><p><a target="_blank" rel="noopener" href="https://medium.com/@rabbi.cse.sust.bd/kubernetes-cluster-setup-on-ubuntu-24-04-lts-server-c17be85e49d1">Kubernetes Cluster Setup on Ubuntu 24.04 LTS Server</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">Creating sample user</a></p>
<p>测试时使用了的是下面的这些电脑（Ubuntu 24.04 Server）：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Server Role</th>
<th style="text-align:center">Host Name</th>
<th style="text-align:center">Configuration</th>
<th style="text-align:center">IP Address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Master</td>
<td style="text-align:center">ubuntu2404-1</td>
<td style="text-align:center">8GB Ram, 4vcpus</td>
<td style="text-align:center">172.31.203.100</td>
</tr>
<tr>
<td style="text-align:center">Worker</td>
<td style="text-align:center">ubuntu2404-2</td>
<td style="text-align:center">8GB Ram, 4vcpus</td>
<td style="text-align:center">172.31.203.101</td>
</tr>
<tr>
<td style="text-align:center">Worker</td>
<td style="text-align:center">ubuntu2404-3</td>
<td style="text-align:center">8GB Ram, 4vcpus</td>
<td style="text-align:center">172.31.203.102</td>
</tr>
</tbody>
</table>
</div>
<p>计划使用的 POD CIDR 网段是 <code>10.244.0.0/16</code>。</p>
<h5 id="安装容器运行时-containerd"><a href="#安装容器运行时-containerd" class="headerlink" title="安装容器运行时 containerd"></a>安装容器运行时 containerd</h5><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Add Docker's official GPG key:</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> gpg
<span class="token function">sudo</span> <span class="token function">install</span> -m 0755 -d /etc/apt/keyrings
<span class="token function">sudo</span> <span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
<span class="token function">sudo</span> <span class="token function">chmod</span> a+r /etc/apt/keyrings/docker.asc

<span class="token comment"># Add the repository to Apt sources:</span>
<span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
  <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">.</span> /etc/os-release <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$VERSION_CODENAME</span>"</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token punctuation">\</span>
  <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null
<span class="token function">sudo</span> <span class="token function">apt-get</span> update

<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> containerd.io

<span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/containerd
<span class="token function">sudo</span> containerd config default <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/containerd/config.toml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd</a></p>
<p>需要确认生成的配置文件 <code>/etc/containerd/config.toml</code> 中部分字段的内容如下：</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd</span><span class="token punctuation">]</span>
  <span class="token key property">snapshotter</span> <span class="token punctuation">=</span> <span class="token string">"overlayfs"</span>
<span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options</span><span class="token punctuation">]</span>
  <span class="token key property">SystemdCgroup</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>另外，可以通过修改配置文件中 <code>sandbox_image</code> 字段的值来调整 pause 镜像的地址。</p>
</blockquote>
<p>重启 contained</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart containerd
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> containerd
systemctl status containerd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="关闭交换分区"><a href="#关闭交换分区" class="headerlink" title="关闭交换分区"></a>关闭交换分区</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> swapoff -a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后编辑文件 <code>/etc/fstab</code> ，永久的关闭 Swap</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">/swap.img  none    swap    sw  0   0
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#/swap.img  none    swap    sw  0   0</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="确认每个节点的-MAC-地址和-product-uuid-都是唯一的以及端口-6443-未被使用"><a href="#确认每个节点的-MAC-地址和-product-uuid-都是唯一的以及端口-6443-未被使用" class="headerlink" title="确认每个节点的 MAC 地址和 product_uuid 都是唯一的以及端口 6443 未被使用"></a>确认每个节点的 MAC 地址和 product_uuid 都是唯一的以及端口 6443 未被使用</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> <span class="token function">link</span> show dev eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc mq state UP mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether 00:15:5d:a0:01:07 brd ff:ff:ff:ff:ff:ff

$ <span class="token function">sudo</span> <span class="token function">cat</span> /sys/class/dmi/id/product_uuid
1b653aa4-67b4-473b-8626-37b9cf1140ab

$ <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">6443</span> -v
nc: connect to <span class="token number">127.0</span>.0.1 port <span class="token number">6443</span> <span class="token punctuation">(</span>tcp<span class="token punctuation">)</span> failed: Connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="加载内核模块和配置-sysctl"><a href="#加载内核模块和配置-sysctl" class="headerlink" title="加载内核模块和配置 sysctl"></a>加载内核模块和配置 sysctl</h5><p>加载内核模块</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> modprobe overlay
<span class="token function">sudo</span> modprobe br_netfilter

<span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/k8s.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
overlay
br_netfilter
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 sysctl</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/kubernetes.conf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF</span>

<span class="token function">sudo</span> sysctl --system

<span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">"echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf"</span>

<span class="token function">sudo</span> sysctl -p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>确实配置生效</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> lsmod <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^(overlay|br_netfilter)'</span>
br_netfilter           <span class="token number">32768</span>  <span class="token number">0</span>
overlay               <span class="token number">212992</span>  <span class="token number">22</span>

$ <span class="token function">cat</span> /proc/sys/net/ipv4/ip_forward
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="安装Kubeadm、Kubectl和Kubelet"><a href="#安装Kubeadm、Kubectl和Kubelet" class="headerlink" title="安装Kubeadm、Kubectl和Kubelet"></a>安装Kubeadm、Kubectl和Kubelet</h5><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> -p -m <span class="token number">755</span> /etc/apt/keyrings

<span class="token function">curl</span> -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

<span class="token builtin class-name">echo</span> <span class="token string">'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /'</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/kubernetes.list

<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl
<span class="token function">sudo</span> apt-mark hold kubelet kubeadm kubectl

<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h5><p>Kubernetes 使用与电脑默认网关关联的网络接口上的 IP。也就是使用命令 <code>ip route show</code> 输出中以 <code>default via</code> 开头的行包含的网口。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> route show
default via <span class="token number">172.31</span>.192.1 dev eth0 proto static
<span class="token number">10.244</span>.17.128/26 via <span class="token number">172.31</span>.203.100 dev eth0 proto <span class="token number">80</span> onlink<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果命令 <code>ip route show</code> 的输出像上面那样，则 Kubernetes 使用网口 <code>eth0</code>，即 IP 地址为 <code>172.31.203.101</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> address show dev eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc mq state UP group default qlen <span class="token number">1000</span>
    link/ether 00:15:5d:a0:01:08 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.31</span>.203.101/20 brd <span class="token number">172.31</span>.207.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::215:5dff:fea0:108/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="初始化控制平面节点"><a href="#初始化控制平面节点" class="headerlink" title="初始化控制平面节点"></a>初始化控制平面节点</h5><blockquote>
<p>本小节的内容仅在 Master 节点执行。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用网段 10.244.0.0/16</span>
$ <span class="token function">sudo</span> kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 --cri-socket<span class="token operator">=</span>/var/run/containerd/containerd.sock --v<span class="token operator">=</span><span class="token number">5</span>
<span class="token punctuation">..</span>.
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.203.100:6443 --token pl635t.48ykxo7y0xv7r5my <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:54259333f53f52e6304d0cabfe0ec3f4e85333295a9d48f8161752d4ff0c64c5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 kubectl 命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="安装-Pod-使用的网络插件-calico"><a href="#安装-Pod-使用的网络插件-calico" class="headerlink" title="安装 Pod 使用的网络插件 calico"></a>安装 Pod 使用的网络插件 calico</h5><blockquote>
<p>本小节的内容仅在 Master 节点执行。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
<span class="token function">wget</span> https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>因为之前安装 Kubernetes 集群是使用的 Pod CIDR 网段不是默认的 <code>192.168.0.0/16</code>，所以需要修改 <code>custom-resources.yaml</code>。</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">       cidr: 192.168.0.0/16
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       cidr: 10.244.0.0/16</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后再继续安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create -f ./custom-resources.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>确认安装成功</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods -n calico-system
NAME                                       READY   STATUS    RESTARTS      AGE
calico-kube-controllers-67d57d8448-p9jcx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10h
calico-node-2b2c2                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>10h ago<span class="token punctuation">)</span>   10h
calico-node-lcmn6                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10h
calico-node-npzmt                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10h
calico-typha-7bc67d4678-fc2f6              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10h
calico-typha-7bc67d4678-ks8gm              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10h
csi-node-driver-rzw2b                      <span class="token number">2</span>/2     Running   <span class="token number">0</span>             10h
csi-node-driver-tnst9                      <span class="token number">2</span>/2     Running   <span class="token number">0</span>             10h
csi-node-driver-wcglz                      <span class="token number">2</span>/2     Running   <span class="token number">0</span>             10h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="配置从节点加入集群"><a href="#配置从节点加入集群" class="headerlink" title="配置从节点加入集群"></a>配置从节点加入集群</h5><blockquote>
<p>本小节的内容仅在 Worker 节点执行。</p>
</blockquote>
<p>执行在安装 Master 节点时提示的加入集群的命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.203.100:6443 --token pl635t.48ykxo7y0xv7r5my <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:54259333f53f52e6304d0cabfe0ec3f4e85333295a9d48f8161752d4ff0c64c5
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this node <span class="token function">join</span> the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="确认集群状态"><a href="#确认集群状态" class="headerlink" title="确认集群状态"></a>确认集群状态</h5><blockquote>
<p>本小节的内容仅在 Master 节点执行。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl cluster-info
Kubernetes control plane is running at https://172.31.203.100:6443
CoreDNS is running at https://172.31.203.100:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">'kubectl cluster-info dump'</span><span class="token builtin class-name">.</span>

$ kubectl get nodes -o wide
NAME           STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION     CONTAINER-RUNTIME
ubuntu2404-1   Ready    control-plane   11h   v1.30.1   <span class="token number">172.31</span>.203.100   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        Ubuntu <span class="token number">24.04</span> LTS   <span class="token number">6.8</span>.0-31-generic   containerd://1.6.32
ubuntu2404-2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          10h   v1.30.1   <span class="token number">172.31</span>.203.101   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        Ubuntu <span class="token number">24.04</span> LTS   <span class="token number">6.8</span>.0-31-generic   containerd://1.6.32
ubuntu2404-3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          10h   v1.30.1   <span class="token number">172.31</span>.203.102   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        Ubuntu <span class="token number">24.04</span> LTS   <span class="token number">6.8</span>.0-31-generic   containerd://1.6.32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="安装-Kubernetes-Dashboard"><a href="#安装-Kubernetes-Dashboard" class="headerlink" title="安装 Kubernetes Dashboard"></a>安装 Kubernetes Dashboard</h5><blockquote>
<p>本小节的内容仅在 Master 节点执行。</p>
</blockquote>
<p>安装 Helm</p>
<p><a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://baltocdn.com/helm/signing.asc <span class="token operator">|</span> gpg --dearmor <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /usr/share/keyrings/helm.gpg <span class="token operator">&gt;</span> /dev/null
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https --yes
<span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/helm-stable-debian.list
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> helm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装 Dashboard</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ helm repo <span class="token function">add</span> kubernetes-dashboard https://kubernetes.github.io/dashboard/

$ helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard
Release <span class="token string">"kubernetes-dashboard"</span> does not exist. Installing it now.
NAME: kubernetes-dashboard
LAST DEPLOYED: Mon May <span class="token number">27</span> <span class="token number">13</span>:13:39 <span class="token number">2024</span>
NAMESPACE: kubernetes-dashboard
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
*************************************************************************************************
*** PLEASE BE PATIENT: Kubernetes Dashboard may need a few minutes to get up and become ready ***
*************************************************************************************************

Congratulations<span class="token operator">!</span> You have just installed Kubernetes Dashboard <span class="token keyword">in</span> your cluster.

To access Dashboard run:
  kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy <span class="token number">8443</span>:443

NOTE: In <span class="token keyword">case</span> port-forward <span class="token builtin class-name">command</span> does not work, <span class="token function">make</span> sure that kong <span class="token function">service</span> name is correct.
      Check the services <span class="token keyword">in</span> Kubernetes Dashboard namespace using:
        kubectl -n kubernetes-dashboard get svc

Dashboard will be available at:
  https://localhost:8443<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为 Kubernetes Dashboard 开启端口转发</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> kubectl -n kubernetes-dashboard port-forward --address <span class="token number">0.0</span>.0.0 svc/kubernetes-dashboard-kong-proxy <span class="token number">8443</span>:443 <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>/dev/null <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后访问 Master 节点（172.31.203.100）的 8443 端口即可访问到 Kubernetes Dashboard。</p>
<p><a target="_blank" rel="noopener" href="https://172.31.203.100:8443/">https://172.31.203.100:8443/</a></p>
<h5 id="创建一个用于访问-dashboard-的账号"><a href="#创建一个用于访问-dashboard-的账号" class="headerlink" title="创建一个用于访问 dashboard 的账号"></a>创建一个用于访问 dashboard 的账号</h5><blockquote>
<p>本小节的内容仅在 Master 节点执行。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-an-api-token-for-a-serviceaccount">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-an-api-token-for-a-serviceaccount</a></p>
<p>创建 Service Account</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>绑定用户到 cluster-admin</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取一个用于临时访问 Kubernetes Dashboard 的 Bearer Token</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n kubernetes-dashboard create token admin-user
eyJhbGciOiJSUzI1NiIsImtpZCI6IjFsdnJlVk84Z1BOckwzQ2NyTHVxeUZWeUhpZjNHRUxDQjg3c3MxRUV1TmsifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzE2ODI0ODY0LCJpYXQiOjE3MTY4MjEyNjQsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiNzA1NGI0MWEtMWI3OC00NDlmLWJkZDQtNjAxODdhYzBkYmU5Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiMWEwYWNmM2EtMzFiOC00ZTFlLTgxNzMtODg2NDY2MGE4NmM2In19LCJuYmYiOjE3MTY4MjEyNjQsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.IyoiZzuXQE-5P1OEPWwIWjI5dbHDe0BbdUjXaP1ML3137eTX-sOR__hs2cyv_1MwGLbUXipRl7NLDTY2qF359rcd4UZC5wjJKZE7WEVf8DQJgr1X4SiTYdmFeRp-JKb27oO7_jwWGlGJb1nY8t7exdvqSzbXWiuwDdc2Z52cXwP5n3sGErFXmchdZDV7Ims-1vF3_g_tKzxUBRe2bu0jfrQEqbUv_hLiEX7Ke1n6URGi1znEIs6tfSnhEOZ40JWvb5w0-bf1tx4qGFfhhVdzB16xMLGQNs4vrfekMvwXfzNNt5qTk2PX4olU9TG4OZofAWSCDAyJSLuYIXOtQUXn-g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>为 admin-user 创建一个长期有效的 Bearer Token</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/service-account.name</span><span class="token punctuation">:</span> <span class="token string">"admin-user"</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> kubernetes.io/service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取长期有效的 Token</p>
<blockquote>
<p>需要使用临时 Token 访问过一次 Dashboard 后才能获取到长期有效的 Token。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get secret admin-user -n kubernetes-dashboard -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">".data.token"</span><span class="token punctuation">}</span> <span class="token operator">|</span> base64 -d
eyJhbGciOiJSUzI1NiIsImtpZCI6IjFsdnJlVk84Z1BOckwzQ2NyTHVxeUZWeUhpZjNHRUxDQjg3c3MxRUV1TmsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIxYTBhY2YzYS0zMWI4LTRlMWUtODE3My04ODY0NjYwYTg2YzYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.dkfNd1OyFYq0SdzC_mdgA7BT7ODQDfpAeBFC4XXN-O0kRT9qywnIkHckXMCfpZvFU3veIO4HoXuEOattlf1Hg3NtchtiUReonIb2h90feVNxnUqp1b6iy1JohRhQi-VpE8-b5L80BRy1AP-ovMLAdg61g9F5FBQ9tQPJu8CRnc64CXBmFS-VL7Wi-7yXkhSRB1MDvmT7FQW12gkpQ1R2LrMoRjX65TcFkWw89SibvOfLLwsZ1XJRBK_CGhSi55mebiEWOrFkg-dAQibMoDMKFp_yCvV2oz4vX-r3Ni_mQS7nvDKECFqYgVXPMSdUbX5HdCZxKlgZdHuokzBEsjoOzw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="用-Kubespray-搭建高可用集群搭建"><a href="#用-Kubespray-搭建高可用集群搭建" class="headerlink" title="用 Kubespray 搭建高可用集群搭建"></a>用 Kubespray 搭建高可用集群搭建</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/用Kubespray搭建高可用集群搭建.png" alt="用Kubespray搭建高可用集群搭建"></p>
<h4 id="练习：使用-Kubespray-安装集群"><a href="#练习：使用-Kubespray-安装集群" class="headerlink" title="练习：使用 Kubespray 安装集群"></a>练习：使用 Kubespray 安装集群</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/Install-HA-cluster-using-kubespray-e398756229a649b8adc7338788df4672">https://cncamp.notion.site/Install-HA-cluster-using-kubespray-e398756229a649b8adc7338788df4672</a></p>
<h4 id="基于声明式-API-管理集群"><a href="#基于声明式-API-管理集群" class="headerlink" title="基于声明式 API 管理集群"></a>基于声明式 API 管理集群</h4><p>集群管理不仅仅包括集群搭建，还有更多功能需要支持</p>
<ul>
<li>集群扩缩容</li>
<li>节点健康检查和自动修复</li>
<li>Kubernetes 升级</li>
<li>操作系统升级</li>
</ul>
<p>云原生场景中集群应该按照我们的期望的状态运行，这意味着我们应该将集群管理建立在声明式 API 的基础之上</p>
<h4 id="Kubernetes-Cluster-API"><a href="#Kubernetes-Cluster-API" class="headerlink" title="Kubernetes Cluster API"></a>Kubernetes Cluster API</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/KubernetesClusterAPI.png" alt="KubernetesClusterAPI"></p>
<h4 id="参与角色"><a href="#参与角色" class="headerlink" title="参与角色"></a>参与角色</h4><p>管理集群</p>
<ul>
<li>管理 workload 集群的集群，用来存放 Cluster API 对象的地方</li>
</ul>
<p>Workload 集群</p>
<ul>
<li>真正开放给用户用来运行应用的集群，由管理集群管理</li>
</ul>
<p>Infrastructure provider</p>
<ul>
<li>提供不同云的基础架构管理，包括计算节点，网络等。目前流行的公有云多与 Cluster API 集成了。</li>
</ul>
<p>Bootstrap provider</p>
<ul>
<li>证书生成</li>
<li>控制面组件安装和初始化，监控节点的创建</li>
<li>将主节点和计算节点加入集群</li>
</ul>
<p>Control plane</p>
<ul>
<li>Kubernetes 控制平面组件</li>
</ul>
<h4 id="涉及模型"><a href="#涉及模型" class="headerlink" title="涉及模型"></a>涉及模型</h4><p>Machine</p>
<ul>
<li>计算节点，用来描述可以运行 Kubernetes 组件的机器对象(注意与 Kubernetes Node )的差异</li>
<li>一个新 Machine 被创建以后，对应的控制器会创建一个计算节点，安装好操作系统并更新 Machine 的状态</li>
<li>当一个 Machine 被删除后，对应的控制器会删除掉该节点并回收计算资源。</li>
<li>当 Machine 属性被更新以后(比如 Kubernetes 版本更新)，对应的控制器会删除旧节点并创建新书点</li>
</ul>
<p>Machine Immutability(In-place Upgrade vs. Replace)</p>
<ul>
<li>不可变基础架构</li>
</ul>
<p>MachineDeployment</p>
<ul>
<li>提供针对 Machine 和 MachineSet 的声明式更新，类似于 Kubernetes Deployment</li>
</ul>
<p>MachineSet</p>
<ul>
<li>维护一个稳定的机器集合，类似 Kubernetes ReplicaSet</li>
</ul>
<p>MachineHealthcheck</p>
<ul>
<li>定义节点应该被标记为不可用的条件</li>
</ul>
<h4 id="用-cluster-api-管理集群"><a href="#用-cluster-api-管理集群" class="headerlink" title="用 cluster api 管理集群"></a>用 cluster api 管理集群</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">### create host cluster</span>
./create cluster.sh

<span class="token comment">### generate cluster specs</span>
<span class="token builtin class-name">cd</span> cluster-api
./generate_workload_cluster.sh

<span class="token comment">### replace image repository</span>
<span class="token function">vi</span> capi-quickstart.yaml
replace KubeadmConfigTemplate

<span class="token comment">### apply cluster spec</span>
kubectl apply-f capi-quickstart.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> bootstrap.cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmConfigTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">joinConfiguration</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
          <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
            <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
            <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%
          <span class="token key atrule">clusterconfiguration</span><span class="token punctuation">:</span>
            <span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google containers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="用-kind-和-cluster-API-搭建集群"><a href="#用-kind-和-cluster-API-搭建集群" class="headerlink" title="用 kind 和 cluster API 搭建集群"></a>用 kind 和 cluster API 搭建集群</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module9/kind/readme.MD">https://github.com/kibaamor/101/blob/master/module9/kind/readme.MD</a></p>
<p><a href="mailto:https://medium.com/@dipendra.chaudhary/kubernetes-74a5d6bd4bdb">https://medium.com/@dipendra.chaudhary/kubernetes-74a5d6bd4bdb</a></p>
<p><a target="_blank" rel="noopener" href="https://cluster-api.sigs.k8s.io/user/quick-start.html#install-andor-configure-a-kubernetes-cluster">https://cluster-api.sigs.k8s.io/user/quick-start.html#install-andor-configure-a-kubernetes-cluster</a></p>
<h5 id="创建管理集群"><a href="#创建管理集群" class="headerlink" title="创建管理集群"></a>创建管理集群</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&gt;</span> cluster-mgmt.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  ipFamily: dual
nodes:
- role: control-plane
  extraMounts:
  - hostPath: /var/run/docker.sock
    containerPath: /var/run/docker.sock
EOF</span>

$ kind create cluster --config cluster-mgmt.yaml --name mgmt
Creating cluster <span class="token string">"mgmt"</span> <span class="token punctuation">..</span>.
 ✓ Ensuring node image <span class="token punctuation">(</span>kindest/node:v1.30.0<span class="token punctuation">)</span> 🖼
 ✓ Preparing nodes 📦
 ✓ Writing configuration 📜
 ✓ Starting control-plane 🕹️
 ✓ Installing CNI 🔌
 ✓ Installing StorageClass 💾
Set kubectl context to <span class="token string">"kind-mgmt"</span>
You can now use your cluster with:

kubectl cluster-info --context kind-mgmt

Have a question, bug, or feature request? Let us know<span class="token operator">!</span> https://kind.sigs.k8s.io/<span class="token comment">#community 🙂</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="创建工作集群"><a href="#创建工作集群" class="headerlink" title="创建工作集群"></a>创建工作集群</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">CLUSTER_TOPOLOGY</span><span class="token operator">=</span>true

$ clusterctl init --infrastructure docker --target-namespace capi-docker
Fetching providers
Installing cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.14.5"</span>
Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.7.2"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.7.2"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.7.2"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-docker"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.7.2"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capd-system"</span>

Your management cluster has been initialized successfully<span class="token operator">!</span>

You can now create your first workload cluster by running the following:

  clusterctl generate cluster <span class="token punctuation">[</span>name<span class="token punctuation">]</span> --kubernetes-version <span class="token punctuation">[</span>version<span class="token punctuation">]</span> <span class="token operator">|</span> kubectl apply -f -

<span class="token comment"># 确定所有的资源都ready</span>
$ kubectl -n capi-docker get all -owide

<span class="token comment"># 建议 kubernetes-version 使用的版本与 kind create cluster 时输出的 kindest/node 版本相同</span>
$ clusterctl generate cluster capi-quickstart --flavor development <span class="token punctuation">\</span>
  --kubernetes-version v1.30.0 <span class="token punctuation">\</span>
  --control-plane-machine-count<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
  --worker-machine-count<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
  --target-namespace capi-docker <span class="token punctuation">\</span>
  <span class="token operator">&gt;</span> capi-quickstart.yaml

$ kubectl apply -f capi-quickstart.yaml
clusterclass.cluster.x-k8s.io/quick-start created
dockerclustertemplate.infrastructure.cluster.x-k8s.io/quick-start-cluster created
kubeadmcontrolplanetemplate.controlplane.cluster.x-k8s.io/quick-start-control-plane created
dockermachinetemplate.infrastructure.cluster.x-k8s.io/quick-start-control-plane created
dockermachinetemplate.infrastructure.cluster.x-k8s.io/quick-start-default-worker-machinetemplate created
dockermachinepooltemplate.infrastructure.cluster.x-k8s.io/quick-start-default-worker-machinepooltemplate created
kubeadmconfigtemplate.bootstrap.cluster.x-k8s.io/quick-start-default-worker-bootstraptemplate created

$ kubectl get cluster
NAME              CLUSTERCLASS   PHASE         AGE   VERSION
capi-quickstart   quick-start    Provisioned   25s   v1.30.0

<span class="token comment"># controlplane 还未 ready 是因为还未安装 CNI 插件</span>
$ kubectl get kubeadmcontrolplane
NAME                    CLUSTER           INITIALIZED   API SERVER AVAILABLE   REPLICAS   READY   UPDATED   UNAVAILABLE   AGE   VERSION
capi-quickstart-xrg9s   capi-quickstart   <span class="token boolean">true</span>                                 <span class="token number">1</span>                  <span class="token number">1</span>         <span class="token number">1</span>             99s   v1.30.0

<span class="token comment"># 获取 workload 集群的kubeconfig</span>
$ clusterctl get kubeconfig capi-quickstart <span class="token operator">&gt;</span> capi-quickstart.kubeconfig

<span class="token comment"># 确认没有代理</span>
$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> kubectl --kubeconfig ./capi-quickstart.kubeconfig get nodes
NAME                                     STATUS     ROLES           AGE   VERSION
capi-quickstart-md-0-6c9b6-wcx8l-8qsql   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          93m   v1.30.0
capi-quickstart-worker-6g0j6q            NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          93m   v1.30.0
capi-quickstart-xrg9s-4xcdb              NotReady   control-plane   93m   v1.30.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="安装-CNI-插件"><a href="#安装-CNI-插件" class="headerlink" title="安装 CNI 插件"></a>安装 CNI 插件</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> kubectl --kubeconfig<span class="token operator">=</span>./capi-quickstart.kubeconfig create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
deployment.apps/tigera-operator created

$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> kubectl --kubeconfig<span class="token operator">=</span>./capi-quickstart.kubeconfig create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml
installation.operator.tigera.io/default created
apiserver.operator.tigera.io/default created

$ <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span> kubectl --kubeconfig<span class="token operator">=</span>./capi-quickstart.kubeconfig get nodes
NAME                                     STATUS   ROLES           AGE   VERSION
capi-quickstart-md-0-6c9b6-wcx8l-8qsql   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          97m   v1.30.0
capi-quickstart-worker-6g0j6q            Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          97m   v1.30.0
capi-quickstart-xrg9s-4xcdb              Ready    control-plane   97m   v1.30.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KubeadmControlPlane"><a href="#KubeadmControlPlane" class="headerlink" title="KubeadmControlPlane"></a>KubeadmControlPlane</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> controlplane.cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmControlPlane
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">kubeadmConfigspec</span><span class="token punctuation">:</span>

  <span class="token key atrule">clusterConfiguration</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiserver</span><span class="token punctuation">:</span>
      <span class="token key atrule">certSANs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> localhost
      <span class="token punctuation">-</span> 127.0.0.1
    <span class="token key atrule">controllerManager</span><span class="token punctuation">:</span>
      <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span>
        <span class="token key atrule">enable-hostpath-provisioner</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">etcd</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">networking</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token key atrule">joinConfiguration</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
        <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/containerd/containerd.sock
        <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
          <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
          <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%

    <span class="token key atrule">initConfiguration</span><span class="token punctuation">:</span>
      <span class="token key atrule">localAPlEndpoint</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
        <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/containerd/containerd.sock
        <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
          <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
          <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%

    <span class="token key atrule">machineTemplate</span><span class="token punctuation">:</span>
      <span class="token key atrule">infrastructureRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
        <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
      metadata<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">rolloutStrategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.22.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="MachineDeployment"><a href="#MachineDeployment" class="headerlink" title="MachineDeployment"></a>MachineDeployment</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MachineDeployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  name<span class="token punctuation">:</span>capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Rollingupdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster.x-k8s.io/cluster-name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart
        <span class="token key atrule">cluster.x-k8s.io/deployment-name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">bootstrap</span><span class="token punctuation">:</span>
        <span class="token key atrule">configRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> bootstrap.cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmconfigTemplate
          <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
          <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
        <span class="token key atrule">clusterName</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart
        <span class="token key atrule">infrastructureRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha4
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
          <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
          <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.22.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="MachineHealthCheck"><a href="#MachineHealthCheck" class="headerlink" title="MachineHealthCheck"></a>MachineHealthCheck</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cluster.x<span class="token punctuation">-</span>k8s.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MachineHealthCheck
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart<span class="token punctuation">-</span>node<span class="token punctuation">-</span>unhealthy<span class="token punctuation">-</span>5m
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterName</span><span class="token punctuation">:</span> capi<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">maxUnhealthy</span><span class="token punctuation">:</span> 40% <span class="token comment"># 自动修复节点数的上限，默认行为是替换该节点，云提供商可自定义</span>
  <span class="token key atrule">nodeStartupTimeout</span><span class="token punctuation">:</span> 10m
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># 健康检查的目标节点</span>
      <span class="token key atrule">nodepool</span><span class="token punctuation">:</span> nodepool<span class="token punctuation">-</span><span class="token number">0</span>
  <span class="token key atrule">unhealthyConditions</span><span class="token punctuation">:</span> <span class="token comment"># 认定节点不健康的条件</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready
    <span class="token key atrule">status</span><span class="token punctuation">:</span> Unknown
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 300s
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"False"</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 300s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="日常运营中的节点问题归类"><a href="#日常运营中的节点问题归类" class="headerlink" title="日常运营中的节点问题归类"></a>日常运营中的节点问题归类</h4><p>可自动修复的问题</p>
<ul>
<li>计算节点 down<ul>
<li>Ping不通</li>
<li>TCP probe 失败</li>
<li>节点上的所有应用都不可达</li>
</ul>
</li>
</ul>
<p>不可自动修复的问题</p>
<ul>
<li>文件系统坏</li>
<li>磁盘阵列故障</li>
<li>网盘挂载问题</li>
<li>其他硬件故障</li>
<li>Kernel出错，core dumps</li>
</ul>
<p>其他问题</p>
<ul>
<li>软件Bug</li>
<li>进程锁死，或者 memory/CPU 竞争问题</li>
<li>Kubernetes 组件出问题<ul>
<li>Kubelet/Kube-proxy/Docker/Salt</li>
</ul>
</li>
</ul>
<h4 id="故障监测和自动恢复"><a href="#故障监测和自动恢复" class="headerlink" title="故障监测和自动恢复"></a>故障监测和自动恢复</h4><p>当创建 Compute 节点时，允许定义 LivenessProbe</p>
<ul>
<li>当 livenessProbe 失败时，ComputeNode 的 ProbePassed 设置为 false</li>
</ul>
<p>在 Prometheus 中，已经有 Node level 的 alert，抓取 Prometheus 中的 alert</p>
<p>设定自动恢复规则</p>
<ul>
<li>大多数情况下，重启大法好(人人都是 Restartoperator)</li>
<li>如果重启不行就重装。(reprovision)</li>
<li>重装不行就重修。(breakfix)</li>
</ul>
<h3 id="Cluster-Autoscaler"><a href="#Cluster-Autoscaler" class="headerlink" title="Cluster Autoscaler"></a>Cluster Autoscaler</h3><h4 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h4><p>扩容</p>
<ul>
<li>由于资源不足，pod 调度失败，即有 pod 一直处于 Pending 状态</li>
</ul>
<p>缩容</p>
<ul>
<li>node 的资源利用率较低时，持续 10 分钟低于 50%</li>
<li>此 node 上存在的 pod 都能被重新调度到其他 node 上运行</li>
</ul>
<h4 id="Cluster-Autoscaler-架构"><a href="#Cluster-Autoscaler-架构" class="headerlink" title="Cluster Autoscaler 架构"></a>Cluster Autoscaler 架构</h4><p>Autoscaler: 核心模块，负责整体扩缩容功能</p>
<p>Estimator: 负责评估计算扩容节点</p>
<p>Simulator: 负责模拟调度，计算缩容节点</p>
<p>Cloud-Provider: 与云交互进行节点的增删操作，每个支持 CA 的主流厂商都实现自己的 plugin 实现动态缩放</p>
<h4 id="ClusterAutoscaler-架构"><a href="#ClusterAutoscaler-架构" class="headerlink" title="ClusterAutoscaler 架构"></a>ClusterAutoscaler 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ClusterAutoscaler架构.png" alt="ClusterAutoscaler架构"></p>
<h4 id="ClusterAutoscaler-的扩展机制"><a href="#ClusterAutoscaler-的扩展机制" class="headerlink" title="ClusterAutoscaler 的扩展机制"></a>ClusterAutoscaler 的扩展机制</h4><p>为了自动创建和初始化 Node，Cluster Autoscaler 要求 Node 必须属于某个 Node Group，比如</p>
<ul>
<li>GCE/GKE 中的 Managed instance groups(MIG)</li>
<li>AWS 中的 Autoscaling Groups</li>
<li>Cluster API Node</li>
</ul>
<p>当集群中有多个 Node Group 时，可以通过 <code>--expander=&lt;option&gt;</code> 选项配置选择 Node Group 的策略，支持如下四种方式</p>
<ul>
<li>random: 随机选择</li>
<li>most-pods: 选择容量最大(可以创建最多 Pod)的 Node Group</li>
<li>least-waste: 以最小浪费原则选择，即选择有最少可用资源的 Node Group</li>
<li>price: 选择最便宜的 Node Group</li>
</ul>
<h4 id="附加资料"><a href="#附加资料" class="headerlink" title="附加资料"></a>附加资料</h4><p>代码走读 <a target="_blank" rel="noopener" href="https://cncamp.notion.site/CA-204f3767ba8d4ed0a464d2ea6ac2abca">https://cncamp.notion.site/CA-204f3767ba8d4ed0a464d2ea6ac2abca</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">buildAutoscaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    core<span class="token punctuation">.</span><span class="token function">NewAutoscaler</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>
    autoscaler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        a<span class="token punctuation">.</span>clusterStateRegistry<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            csr<span class="token punctuation">.</span>cloudProviderNodeInstancesCache<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>csr<span class="token punctuation">.</span>interrupt<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                cache<span class="token punctuation">.</span>cloudProvider<span class="token punctuation">.</span><span class="token function">NodeGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// load provider specified group</span>
                    nodeGroupInstances<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodeGroup<span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                        cache<span class="token punctuation">.</span><span class="token function">updateCacheEntryLocked</span><span class="token punctuation">(</span>nodeGroup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cloudProviderNodeInstancesCacheEntry<span class="token punctuation">{</span>nodeGroupInstances<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token comment">// interval 10s</span>
        autoscaler<span class="token punctuation">.</span><span class="token function">RunOnce</span><span class="token punctuation">(</span>loopStart<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            unschedulablePodLister <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">UnschedulablePodLister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// phase != succeeded and != failed</span>
            scheduledPodLister <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">ScheduledPodLister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            pdbLister <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">PodDisruptionBudgetLister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            allNodes<span class="token punctuation">,</span> readyNodes<span class="token punctuation">,</span> typedErr <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">obtainNodeLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Get nodes and pods currently living on cluster</span>
            <span class="token comment">// Update cluster resource usage metrics</span>
            coresTotal<span class="token punctuation">,</span> memoryTotal <span class="token operator">:=</span> <span class="token function">calculateCoresMemoryTotal</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span>
            daemonsets<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>ListerRegistry<span class="token punctuation">.</span><span class="token function">DaemonSetLister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            err <span class="token operator">=</span> a<span class="token punctuation">.</span>AutoscalingContext<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                cache<span class="token punctuation">.</span>cloudProvider<span class="token punctuation">.</span><span class="token function">NodeGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// load provider specified group</span>
                nodeGroupInstances<span class="token punctuation">,</span> err <span class="token operator">:=</span> nodeGroup<span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            a<span class="token punctuation">.</span><span class="token function">initializeClusterSnapshot</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">,</span> nonExpendableScheduledPods<span class="token punctuation">)</span> <span class="token comment">// exclude low priority pods</span>
            a<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>TemplateNodeInfoProvider<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token function">processNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    simulator<span class="token punctuation">.</span><span class="token function">BuildNodeInfoForNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> podsForNodes<span class="token punctuation">)</span> <span class="token comment">// simulate scheduled pods right after node is created</span>
                    sanitizedNodeInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">SanitizeNodeInfo</span><span class="token punctuation">(</span>nodeInfo<span class="token punctuation">,</span> id<span class="token punctuation">,</span> ignoredTaints<span class="token punctuation">)</span> <span class="token comment">// modify node name</span>
                    a<span class="token punctuation">.</span><span class="token function">updateClusterState</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">,</span> nodeInfosForGroups<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span>
            a<span class="token punctuation">.</span><span class="token function">updateClusterState</span><span class="token punctuation">(</span>allNodes<span class="token punctuation">,</span> nodeInfosForGroups<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span>
            <span class="token function">ScaleUp</span><span class="token punctuation">(</span>autoscalingContext<span class="token punctuation">,</span> a<span class="token punctuation">.</span>processors<span class="token punctuation">,</span> a<span class="token punctuation">.</span>clusterStateRegistry<span class="token punctuation">,</span> unschedulablePodsToHelp<span class="token punctuation">,</span> readyNodes<span class="token punctuation">,</span> daemonsets<span class="token punctuation">,</span> nodeInfosForGroups<span class="token punctuation">,</span> a<span class="token punctuation">.</span>ignoredTaints<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token comment">// filter out virtual kubelet</span>
                nodesFromNotAutoscaledGroups<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">FilterOutNodesFromNotAutoscaledGroups</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> context<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">)</span>
                <span class="token function">computeScaleUpResourcesLeftLimits</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> processors<span class="token punctuation">,</span> nodeGroups<span class="token punctuation">,</span> nodeInfos<span class="token punctuation">,</span> nodesFromNotAutoscaledGroups<span class="token punctuation">,</span> resourceLimiter<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token function">calculateScaleUpCoresMemoryTotal</span><span class="token punctuation">(</span>nodeGroups<span class="token punctuation">,</span> nodeInfos<span class="token punctuation">,</span> nodesFromNotAutoscaledGroups<span class="token punctuation">)</span> <span class="token comment">// sum totoal cpu and mem resource of the node group</span>
                    <span class="token function">calculateScaleUpCustomResourcesTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// sum allocable gpu of the node group</span>
                clusterStateRegistry<span class="token punctuation">.</span><span class="token function">GetUpcomingNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    newNodes <span class="token operator">:=</span> ar<span class="token punctuation">.</span>CurrentTarget <span class="token operator">-</span> <span class="token punctuation">(</span>readiness<span class="token punctuation">.</span>Ready <span class="token operator">+</span> readiness<span class="token punctuation">.</span>Unready <span class="token operator">+</span> readiness<span class="token punctuation">.</span>LongUnregistered<span class="token punctuation">)</span>
                upcomingNodes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>upcomingNodes<span class="token punctuation">,</span> nodeTemplate<span class="token punctuation">)</span> <span class="token comment">// build node template for each node group</span>
                <span class="token function">computeScaleUpResourcesDelta</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> processors<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> nodeGroup<span class="token punctuation">,</span> resourceLimiter<span class="token punctuation">)</span>
                context<span class="token punctuation">.</span>ExpanderStrategy<span class="token punctuation">.</span><span class="token function">BestOption</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> nodeInfos<span class="token punctuation">)</span> <span class="token comment">// different strategy, e.g.leastwaste, mostpods, priceBased</span>
                processors<span class="token punctuation">.</span>NodeGroupManager<span class="token punctuation">.</span><span class="token function">CreateNodeGroup</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bestOption<span class="token punctuation">.</span>NodeGroup<span class="token punctuation">)</span>
                <span class="token comment">// calculate node numbers</span>
                newNodes<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">applyScaleUpResourcesLimits</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> processors<span class="token punctuation">,</span> newNodes<span class="token punctuation">,</span> scaleUpResourcesLeft<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> bestOption<span class="token punctuation">.</span>NodeGroup<span class="token punctuation">,</span> resourceLimiter<span class="token punctuation">)</span>
                <span class="token comment">// find similar group</span>
                processors<span class="token punctuation">.</span>NodeGroupSetProcessor<span class="token punctuation">.</span><span class="token function">FindSimilarNodeGroups</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bestOption<span class="token punctuation">.</span>NodeGroup<span class="token punctuation">,</span> nodeInfos<span class="token punctuation">)</span>
                processors<span class="token punctuation">.</span>NodeGroupSetProcessor<span class="token punctuation">.</span><span class="token function">BalanceScaleUpBetweenGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">executeScaleUp</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> clusterStateRegistry<span class="token punctuation">,</span> info<span class="token punctuation">,</span> gpu<span class="token punctuation">.</span><span class="token function">GetGpuTypeForMetrics</span><span class="token punctuation">(</span>gpuLabel<span class="token punctuation">,</span> availableGPUTypes<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>
                    info<span class="token punctuation">.</span>Group<span class="token punctuation">.</span><span class="token function">IncreaseSize</span><span class="token punctuation">(</span>increase<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ClusterAPI 与 ClusterAutoscaler 的整合</p>
<p><a target="_blank" rel="noopener" href="https://cluster-api.sigs.k8s.io/tasks/cluster-autoscaler.html">https://cluster-api.sigs.k8s.io/tasks/cluster-autoscaler.html</a></p>
<h3 id="集群管理实践案例分享"><a href="#集群管理实践案例分享" class="headerlink" title="集群管理实践案例分享"></a>集群管理实践案例分享</h3><p><a target="_blank" rel="noopener" href="https://saltproject.io/">https://saltproject.io/</a></p>
<h4 id="集群管理实践案例分享-1"><a href="#集群管理实践案例分享-1" class="headerlink" title="集群管理实践案例分享"></a>集群管理实践案例分享</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群管理实践案例分享.png" alt="集群管理实践案例分享"></p>
<h4 id="声明式集群配置"><a href="#声明式集群配置" class="headerlink" title="声明式集群配置"></a>声明式集群配置</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/声明式集群配置.png" alt="声明式集群配置"></p>
<h4 id="声明式扩容"><a href="#声明式扩容" class="headerlink" title="声明式扩容"></a>声明式扩容</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/声明式扩容.png" alt="声明式扩容"></p>
<h4 id="声明式持续发布"><a href="#声明式持续发布" class="headerlink" title="声明式持续发布"></a>声明式持续发布</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/声明式持续发布.png" alt="声明式持续发布"></p>
<h4 id="自定义插件-声明式集群管理对象"><a href="#自定义插件-声明式集群管理对象" class="headerlink" title="自定义插件 - 声明式集群管理对象"></a>自定义插件 - 声明式集群管理对象</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/声明式集群管理对象.png" alt="声明式集群管理对象"></p>
<h3 id="多租户集群管理"><a href="#多租户集群管理" class="headerlink" title="多租户集群管理"></a>多租户集群管理</h3><h4 id="租户"><a href="#租户" class="headerlink" title="租户"></a>租户</h4><p>租户是指一组拥有访问特定软件资源权限的用户集合，在多租户环境中，它还包括共享的应用服务、数据和各项配置等</p>
<p>多租户集群必须将租户彼此隔离，以最大限度地减少租户与租户、租户与集群之间的影响</p>
<p>集群须在租户之间公平地分配集群资源。通过多租户共享集群资源，可以有效地降低集群管理成本，提高整体集群的资源利用率</p>
<h4 id="认证-实现多租户的基础"><a href="#认证-实现多租户的基础" class="headerlink" title="认证 - 实现多租户的基础"></a>认证 - 实现多租户的基础</h4><p>租户管理首先需要识别访问的用户是谁，因此用户身份认证是多租户的基础</p>
<p>权限控制，如允许合法登录的用户访问、拒绝非法登录的用户访问或提供有限的匿名访问</p>
<p>Kubernetes 可管理两类用户</p>
<ul>
<li>用来标识和管理系统组件的 ServiceAccount</li>
<li>外部用户的认证，需要通过 Kubernetes 的认证扩展来对接企业、供应商的认证服务，为用户验证、操作授权、资源隔离等提供基础</li>
</ul>
<h4 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h4><p>除认证、授权这些基础条件外，还要能够保证用户的工作负载彼此之间有尽可能安全的隔离，减少用户工作负载之间的影响。通常从权限、网络、数据三个方面对不同用户进行隔离</p>
<ul>
<li>权限隔离<ul>
<li>普通用户的容器默认不具有 priviledqed、sys admin、net admin 等高级管理权限，以阻止对宿主机及其他用户的容器进行读取、写入等操作。</li>
</ul>
</li>
<li>网络隔离<ul>
<li>不同的 Pod，运行在不同的 Network Namespace 中，拥有独立的网络协议。Pod 之间只能通过容器开放的端口进行通信，不能通过其他方式进行访问。</li>
</ul>
</li>
<li>数据隔离<ul>
<li>容器之间利用 Namespace 进行隔离，在第 2 章中我们已经对不同的 Namespace 进行了详细描述。不同 Pod 的容器，运行在不同的 MNT、UTS、PID、IPC Namespace 上，相互之间无法访问对方的文件系统、进程、IPC等信息；同一个Pod的容器，其 mnt、PID Namespace 也不共享。</li>
</ul>
</li>
</ul>
<h4 id="租户隔离手段"><a href="#租户隔离手段" class="headerlink" title="租户隔离手段"></a>租户隔离手段</h4><p>Namespace: Namespace 属于且仅属于一个租户</p>
<p>权限定义: 定义内容包括命名空间中的 Role 与 RoleBinding 。这些资源表示目前租户在归属于自己的命名空间中定义了什么权限授权给了哪些租户的成员。</p>
<p>Pod 安全策略: 特殊权限指集群级的特定资源定义 —— PodSecurityPolicy。它定义了一系列工作负载与基础设施之间，工作负载与工作负载之间的关联关系，并通过命名空间的 RoleBinding 完成授权。</p>
<p>网络策略: 基础设施层面为保障租户网络的隔离机制提供了一系列默认策略，以及租户自己定制的用于租户应用彼此访问的策略。</p>
<p>Pod、Service、PersistentVolumeClaim 等命名空间资源: 这些定义表示租户的应用落地到 Kubernetes 中的实体。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/租户隔离手段.png" alt="租户隔离手段"></p>
<h4 id="权限隔离"><a href="#权限隔离" class="headerlink" title="权限隔离"></a>权限隔离</h4><p>基于 Namespace 的权限隔离</p>
<ul>
<li>创建一个 namespace-admin ClusterRole，拥有所有对象的所有权限</li>
<li>为用户开辟新 namespace，并在该 namespace 创建 rolebinding 绑定 namespace-admin ClusterRole，用户即可拥有当前 namespace 所有对象操作权限</li>
</ul>
<p>自动化解决方案</p>
<ul>
<li>当 Namespace 创建时，通过 mutatingwebhook 将 namespace 变形，将用户信息记录至 namespace annotation</li>
<li>创建一个控制器，监控 namespace，创建 rolebinding 为该用户绑定 namespace-admin 的权限</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/权限隔离.png" alt="权限隔离"></p>
<h4 id="Quota-管理"><a href="#Quota-管理" class="headerlink" title="Quota 管理"></a>Quota 管理</h4><p>开启 ResourceQuota 准入插件。</p>
<p>在用户 namespace 创建 ResourceQuota 对象进行限额配置。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>gos<span class="token punctuation">-</span>limit<span class="token punctuation">-</span>requests
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">limits.cpu</span><span class="token punctuation">:</span> <span class="token number">8</span>
    <span class="token key atrule">limits.memory</span><span class="token punctuation">:</span> 24Gi
    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">requests.cpu</span><span class="token punctuation">:</span> <span class="token number">4</span>
    <span class="token key atrule">requests.memory</span><span class="token punctuation">:</span> 12Gi
  <span class="token key atrule">scopes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> NotBestEffort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Quota管理.png" alt="Quota管理"></p>
<h4 id="节点资源隔离"><a href="#节点资源隔离" class="headerlink" title="节点资源隔离"></a>节点资源隔离</h4><p>通过为节点设置不同 taint 来识别不同租户的计算资源。</p>
<p>不同租户在创建 Pod 时，增加 Toleration 关键字，确保其能调度至某个 taint 的节点。</p>
<h4 id="练习：基于-Cluster-API-搭建一个集群"><a href="#练习：基于-Cluster-API-搭建一个集群" class="headerlink" title="练习：基于 Cluster API 搭建一个集群"></a>练习：基于 Cluster API 搭建一个集群</h4><h2 id="Kubernetes-的生产化运维"><a href="#Kubernetes-的生产化运维" class="headerlink" title="Kubernetes 的生产化运维"></a>Kubernetes 的生产化运维</h2><h3 id="镜像仓库-1"><a href="#镜像仓库-1" class="headerlink" title="镜像仓库"></a>镜像仓库</h3><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像仓库.png" alt="镜像仓库"></p>
<p>镜像仓库(Docker Registry)负责存储、管理和分发镜像。</p>
<p>镜像仓库管理多个 Repository，Repository 通过命名来区分。 每个 Repository 包含一个或多个镜像，镜像通过镜像名称和标签( Tag )来区分。</p>
<p>客户端拉取镜像时，要指定三要素:</p>
<ul>
<li>镜像仓库：要从哪一个镜像仓库拉取镜像，通常通过 DNS 或 IP 地址来确定一个镜像仓库，如 <hub.docker.com></hub.docker.com></li>
<li>Repository：组织名，如 cncamp</li>
<li>镜像名称+标签：如 nginx:latest</li>
</ul>
<h4 id="镜像仓库遵循-OCI-的-Distribution-Spec"><a href="#镜像仓库遵循-OCI-的-Distribution-Spec" class="headerlink" title="镜像仓库遵循 OCI 的 Distribution Spec"></a>镜像仓库遵循 OCI 的 Distribution Spec</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像仓库遵循OCI的DistributionSpec.png" alt="镜像仓库遵循OCI的DistributionSpec"></p>
<h4 id="数据和块文件"><a href="#数据和块文件" class="headerlink" title="数据和块文件"></a>数据和块文件</h4><p>镜像由元数据和块文件两部分组成，镜像仓库的核心职能就是管理这两项数据。</p>
<p>元数据:</p>
<ul>
<li>元数据用于描述一个镜像的核心信息，包含镜像的镜像仓库、仓库、标签、校验码、文件层镜像构建描述等信息。</li>
<li>通过这些信息，可以从抽象层面完整地描述一个镜像:它是如何构建出来的、运行过什么构建命令、构建的每一个文件层的校验码、打的标签、镜像的校验码等。</li>
</ul>
<p>块文件(blob)</p>
<ul>
<li>块文件是组成镜像的联合文件层的实体，每一个块文件是一个文件层，内部包含对应文件层的变更。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/数据和块文件.png" alt="数据和块文件"></p>
<h4 id="镜像仓库-2"><a href="#镜像仓库-2" class="headerlink" title="镜像仓库"></a>镜像仓库</h4><p>公有镜像仓库优势</p>
<ul>
<li>开放:任何开发者都可以上传、分享镜像到公有镜像仓库中。</li>
<li>便捷:开发者可以非常方便地搜索、拉取其他开发者的镜像，避免重复造轮子。</li>
<li>免运维:开发者只需要关注应用开发，不必关心镜像仓库的更新、升级、维护等。</li>
<li>成本低:企业或开发者不需要购买硬件、解决方案来搭建镜像仓库，也不需要团队来维护。</li>
</ul>
<p>私有镜像仓库优势</p>
<ul>
<li>隐私性:企业的代码和数据是企业的私有资产，不允许随意共享到公共平台。</li>
<li>敏感性:企业的镜像会包含一些敏感信息，如密钥信息、令牌信息等。这些敏感信息严禁暴露到企业外部,网络连通性:企业的网络结构多种多样，并非所有环境都可以访问互联网，</li>
<li>安全性:而在企业环境中，若使用一些含有漏洞的依赖包，则会引入安全隐患。</li>
</ul>
<h4 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h4><p>Harbor是VMware开源的企业级镜像仓库，目前已是CNCF的毕业项目。它拥有完整的仓库管理镜像管理、基于角色的权限控制、镜像安全扫描集成、镜像签名等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Harbor.png" alt="Harbor"></p>
<h5 id="Harbor-提供的服务"><a href="#Harbor-提供的服务" class="headerlink" title="Harbor 提供的服务"></a>Harbor 提供的服务</h5><p>Harbor 核心服务: 提供 Harbor 的核心管理服务 API，包括仓库管理、认证管理、授权管理配置管理、项目管理、配额管理、签名管理、副本管理等。</p>
<p>Harbor Portal: Harbor 的 Web 界面。</p>
<p>Reqistry: Registry 负责接收客户端的 pull/push 请求，其核心为 docker/Distribution。</p>
<p>副本控制器: Harbor 可以以主从模式来部署镜像仓库，副本控制器将镜像从主镜像服务分发到从镜像服务。</p>
<p>日志收集器:收集各模块的日志。</p>
<p>垃圾回收控制器:回收日常操作中删除镜像记录后遗留在块存储中的孤立块文件。</p>
<h5 id="Harbor-架构"><a href="#Harbor-架构" class="headerlink" title="Harbor 架构"></a>Harbor 架构</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Harbor架构.png" alt="Harbor架构"></p>
<h5 id="Harbor-安装"><a href="#Harbor-安装" class="headerlink" title="Harbor 安装"></a>Harbor 安装</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm repo <span class="token function">add</span> harbor https://helm.goharbor.io
helm fetch harbor/harbor --untar
k create ns harbor
helm install-n harbor harbor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Harbor-Demo-Server"><a href="#Harbor-Demo-Server" class="headerlink" title="Harbor Demo Server"></a>Harbor Demo Server</h5><p>Demo Server</p>
<ul>
<li>2 天清理一次数据</li>
<li>不能 push 超过 100Mb 的镜像</li>
<li>不能使用管理功能</li>
</ul>
<p>Portal</p>
<p><a target="_blank" rel="noopener" href="https://demo.goharbor.io/harbor/projects">https://demo.goharbor.io/harbor/projects</a></p>
<p>镜像使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker login demo.goharbor.io
docker build -t demo.goharbor.io/your-project/test-image
docker push demo.goharbor.io/your-project/test-image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="Harbor-高可用架构"><a href="#Harbor-高可用架构" class="headerlink" title="Harbor 高可用架构"></a>Harbor 高可用架构</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Harbor高可用架构.png" alt="Harbor高可用架构"></p>
<h5 id="Harbor-的用户管理"><a href="#Harbor-的用户管理" class="headerlink" title="Harbor 的用户管理"></a>Harbor 的用户管理</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Harbor的用户管理.png" alt="Harbor的用户管理"></p>
<h5 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h5><p>镜像删除时，blob 文件不会被删除。(你能想起来为什么吗)</p>
<p>需要通过垃圾回收机制来删除不用的 blob，进而回收存储空间。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/harbor垃圾回收.png" alt="harbor垃圾回收"></p>
<h4 id="本地镜像加速-Dragonfly"><a href="#本地镜像加速-Dragonfly" class="headerlink" title="本地镜像加速 Dragonfly"></a>本地镜像加速 Dragonfly</h4><p>Dragonfly 是一款基于 P2P 的智能镜像和文件分发工具</p>
<p>它旨在提高文件传输的效率和速率，最大限度地利用网络带宽，尤其是在分发大量数据时</p>
<ul>
<li>应用分发</li>
<li>缓存分发</li>
<li>日志分发</li>
<li>镜像分发</li>
</ul>
<p>优势</p>
<ul>
<li>基于 P2P 的文件分发</li>
<li>非侵入式支持所有类型的容器技术</li>
<li>机器级别的限速</li>
<li>被动式 CDN</li>
<li>高度一致性磁盘保护和高效 IO</li>
<li>高性能</li>
<li>自动隔离异常</li>
<li>对文件源无压力</li>
<li>支持标准 HTTP 头文件</li>
<li>有效的 Registry 鉴权并发控制</li>
<li>简单易用</li>
</ul>
<h5 id="镜像下载流程"><a href="#镜像下载流程" class="headerlink" title="镜像下载流程"></a>镜像下载流程</h5><p>dfget proxy 也称为 dfdaemon，会拦截来自 docker pull或 docker push 的 HTTP 请求，然后使用 dfget 来处理那些跟镜像分层相关的请求。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像下载流程.png" alt="镜像下载流程"></p>
<p>每个文件会被分成多个分块，并在对等节点之间传输</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像下载流程2.png" alt="镜像下载流程2"></p>
<h3 id="镜像安全"><a href="#镜像安全" class="headerlink" title="镜像安全"></a>镜像安全</h3><h4 id="镜像安全的最佳实践"><a href="#镜像安全的最佳实践" class="headerlink" title="镜像安全的最佳实践"></a>镜像安全的最佳实践</h4><p>构建指令问题</p>
<ul>
<li>避免在构建竟像时添加密钥，Token 等敏感信息(配置与代码应分离)</li>
</ul>
<p>应用依赖问题</p>
<ul>
<li>应尽量避免安装不必要的依赖</li>
<li>确保依赖无安全风险，，一些长时间不更新的基础镜像的可能面临安全风险，比如基于 openssl1.0，只支持 tls1.0 等</li>
</ul>
<p>文件问题</p>
<ul>
<li>在构建镜像时，除应用本身外，还会添加应用需要的配置文件、模板等，在添加这些文件时，会无意间添加一些包含敏感信息或不符合安全策略的文件到镜像中。</li>
<li>当镜像中存在文件问题时，需要通过引入该文件的构建指令行进行修复，而不是通过追加一条删除指令来修复</li>
</ul>
<h4 id="镜像扫描-Vulnerability-Scanning"><a href="#镜像扫描-Vulnerability-Scanning" class="headerlink" title="镜像扫描(Vulnerability Scanning)"></a>镜像扫描(Vulnerability Scanning)</h4><p>镜像扫描通过扫描工具或扫描服务对镜像进行扫描，来确定镜像是否安全</p>
<ul>
<li>分析构建指令、应用、文件、依赖包</li>
<li>查询CVE库、安全策略</li>
<li>检测镜像是否安全，是否符合企业的安全标准</li>
</ul>
<h4 id="镜像策略准入控制"><a href="#镜像策略准入控制" class="headerlink" title="镜像策略准入控制"></a>镜像策略准入控制</h4><p>镜像准入控制是在部署 Pod、更新 Pod 时，对 Pod 中的所有镜像进行安全验证以放行或拦截对Pod的操作:</p>
<ul>
<li>放行: Pod 中所有的镜像都安全，允许此次的操作，Pod 成功被创建或更新。</li>
<li>拦截: Pod 中的镜像未扫描，或已经扫描但存在安全漏洞，或不符合安全策略，Pod 无法被创建或更新。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像策略准入控制.png" alt="镜像策略准入控制"></p>
<h4 id="扫描镜像"><a href="#扫描镜像" class="headerlink" title="扫描镜像"></a>扫描镜像</h4><ol>
<li>镜像扫描服务从镜像仓库拉取镜像。</li>
<li>解析镜像的元数据。</li>
<li>解压镜像的每一个文件层。</li>
<li>提取每一层所包含的依赖包、可运行程序、文件列表、文件内容扫描</li>
<li>将扫描结果与 CVE 字典、安全策略字典进行匹配，以确认最终镜像是否安全</li>
</ol>
<h4 id="镜像扫描服务"><a href="#镜像扫描服务" class="headerlink" title="镜像扫描服务"></a>镜像扫描服务</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/镜像扫描服务.png" alt="镜像扫描服务"></p>
<h5 id="Clair-架构"><a href="#Clair-架构" class="headerlink" title="Clair 架构"></a>Clair 架构</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Clair架构.png" alt="Clair架构"></p>
<h4 id="课后练习"><a href="#课后练习" class="headerlink" title="课后练习"></a>课后练习</h4><p>将 Nginx 容器镜像上传至 Harbor Demo server 并运行在测试环境中。</p>
<h3 id="基于-Kubernetes-的-DevOps"><a href="#基于-Kubernetes-的-DevOps" class="headerlink" title="基于 Kubernetes 的 DevOps"></a>基于 Kubernetes 的 DevOps</h3><h4 id="传统运维模式"><a href="#传统运维模式" class="headerlink" title="传统运维模式"></a>传统运维模式</h4><ul>
<li>缺乏一致性环境</li>
<li>平台与应用部署相互割裂</li>
<li>缺乏工具链支持</li>
<li>缺乏统一的灰度发布管理</li>
<li>缺乏统一监控能力和持续运维能力</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/传统运维模式.png" alt="传统运维模式"></p>
<h4 id="建立持续交付的服务体系"><a href="#建立持续交付的服务体系" class="headerlink" title="建立持续交付的服务体系"></a>建立持续交付的服务体系</h4><p>传统的开发运维模式下，存在的问题:</p>
<ul>
<li>从需求到版本上线中间是个黑箱子，风险不可控;</li>
<li>开发设计时未过多考虑运维，导致后续部署及维护的困难:</li>
<li>开发各自为政，烟囱式开发，未考虑共享重用、联调，开发的资产积累不能快速交移到运维手中;</li>
</ul>
<p>应对这样的问题，我们通常倡导的解决之道是:运维前移，统一运维，建立持续交付服务体系。</p>
<h4 id="基于-Docker-的开发模式驱动持续集成"><a href="#基于-Docker-的开发模式驱动持续集成" class="headerlink" title="基于 Docker 的开发模式驱动持续集成"></a>基于 Docker 的开发模式驱动持续集成</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于Docker的开发模式驱动持续集成.png" alt="基于Docker的开发模式驱动持续集成"></p>
<h4 id="DevOps-流程定义"><a href="#DevOps-流程定义" class="headerlink" title="DevOps 流程定义"></a>DevOps 流程定义</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DevOps流程定义.png" alt="DevOps流程定义"></p>
<h4 id="Dev-和-ops-的边界定义"><a href="#Dev-和-ops-的边界定义" class="headerlink" title="Dev 和 ops 的边界定义"></a>Dev 和 ops 的边界定义</h4><p>Programming vs.Engineering</p>
<ul>
<li>Programming 更多的是系统设计和编码实现</li>
<li>Engineering 包含更大范围概念，除了功能层面的实现，还需为运维服务</li>
</ul>
<h4 id="定义production-readiness"><a href="#定义production-readiness" class="headerlink" title="定义production readiness"></a>定义production readiness</h4><p>Function ready vs. production ready</p>
<ul>
<li>Function Ready 只是交付的软件产品从功能层面满足需求定义</li>
<li>ProductionReady 除了功能就绪还包含<ul>
<li>LnP 测试通过，满足性能需求</li>
<li>用户手册完成，用户可按照用户手册使用既定功能</li>
<li>管理手册完成，运维人员可以依照管理手册部署，升级产品并解决现网问题</li>
<li>监控，包括<ul>
<li>组件健康状态检查(UP)</li>
<li>性能指标(Metrics)</li>
<li>基于性能指标，定义 alertrule，在系统故障或缓慢时，发送告警信息给运维人员 Assertion，定期测试某功能并检查结果，比如每小时创建 service，测试 vip 连通性</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="单体架构下的人员配置"><a href="#单体架构下的人员配置" class="headerlink" title="单体架构下的人员配置"></a>单体架构下的人员配置</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/单体架构下的人员配置.png" alt="单体架构下的人员配置"></p>
<h4 id="微服务架构下的人员配置"><a href="#微服务架构下的人员配置" class="headerlink" title="微服务架构下的人员配置"></a>微服务架构下的人员配置</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/微服务架构下的人员配置.png" alt="微服务架构下的人员配置"></p>
<h4 id="Devops-下的人员划分"><a href="#Devops-下的人员划分" class="headerlink" title="Devops 下的人员划分"></a>Devops 下的人员划分</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Devops下的人员划分.png" alt="Devops下的人员划分"></p>
<h4 id="此组织结构的优缺点"><a href="#此组织结构的优缺点" class="headerlink" title="此组织结构的优缺点"></a>此组织结构的优缺点</h4><p>优势</p>
<ul>
<li>一个架构师负责整个产品的规划，使得产品更规范，产品进化不同的 Program 由不同 PO 负责端到端，从需求到生产系统部署，保证 solution 质量研发和运营统一，一个最大的作用是研发可以深刻理解现网痛苦，对功能需求的设计，和优先级定义有极大帮助。</li>
<li>Function ready vs. production ready</li>
<li>Programming vs.Engineering</li>
<li>更具连续性</li>
</ul>
<p>问题</p>
<ul>
<li>传统运营和开发的冲突并非消失，而是转变为了运营经理和架构以及 PO(Project Owner) 之间的冲突。</li>
<li>运营轮值导致生产系统权责不明确</li>
<li>轮值期间期待不出故障</li>
<li>对于出现的故障缺少端对端的跟踪，可能问题还没处理结束，已经要交接给下一个人了</li>
<li>对于生产系统的积累问题，如故障节点，无人专职处理，导致比较多的故障节点堆积</li>
<li>对于生产系统的配置，无统一规划，每个人可能用不同的配置达到相同的目的</li>
<li>Dev 自主权过高导致 Dev 可以偷偷加功能并部署到生产</li>
</ul>
<h4 id="我眼中理想的-DevOps"><a href="#我眼中理想的-DevOps" class="headerlink" title="我眼中理想的 DevOps"></a>我眼中理想的 DevOps</h4><p>Dev 和 Ops 需要责权划分，可以有 overlap，同时做部署，同时做计划，但 Dev 应侧重功能开发，Ops 偏重生产系统运维</p>
<p>Ops 参与到版本规划流程中，并为一个功能能不能 release 和 deploy 把关</p>
<ul>
<li><p>Dev</p>
<ul>
<li>Plan</li>
<li>Code</li>
<li>Build</li>
<li>Test</li>
<li>Release</li>
<li>Deploy</li>
</ul>
</li>
<li><p>Ops</p>
<ul>
<li>Deploy</li>
<li>Operate</li>
<li>Monitor<br>Plan</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DevOps.png" alt="DevOps"></p>
<h4 id="产品愿景"><a href="#产品愿景" class="headerlink" title="产品愿景"></a>产品愿景</h4><p>产品愿景的定义有多个目的:</p>
<ul>
<li>统一团队思想，让团队成员知道我们要往哪里去，这有助于让团队专注于交付产品价值。</li>
<li>长期愿景往往是有野心的，能对团队成员起到激励作用，比如”业界尖端技术”往往能刺激团队成员努力自我提升。</li>
<li>该愿景应该是团队成员的共识，是所有人的共同理想，</li>
<li>愿景要产生真正的价值，是真正建立在对当前业务痛点的充分理解基础之上的，</li>
</ul>
<p>例如：</p>
<ul>
<li>长期愿景：基于业界尖端技术打造下一代流量管理平台</li>
<li>产品价值：<ul>
<li>节省时间成本，负载均衡上架时间从数月降低到分钟级</li>
<li>移除供应商依赖问题，出现生产系统故障不再依赖供应商上门调试</li>
<li>构建一套统一模型管理所有业务场景，降低系统集成成本</li>
<li>全自动化，减少手工操作，降低维护人力成本</li>
<li>故障检测和根因分析能力，快速定位故障，提升可用性</li>
</ul>
</li>
</ul>
<h4 id="产品路线图定义"><a href="#产品路线图定义" class="headerlink" title="产品路线图定义"></a>产品路线图定义</h4><p>而项目执行需要有明确时间线的近期目标，因此需要将产品价值转化成可控的产品需求。产品需求的输入包括新功能和当前产品的功能缺陷等，产品经理需要与核心团队一道定义近期(比如2-3个季度)的产品核心功能，并定义近期产品版本需要包含的功能。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/产品路线图定义.png" alt="产品路线图定义"></p>
<h4 id="敏捷开发"><a href="#敏捷开发" class="headerlink" title="敏捷开发"></a>敏捷开发</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/敏捷开发.png" alt="敏捷开发"></p>
<h4 id="Devops-流程概览"><a href="#Devops-流程概览" class="headerlink" title="Devops 流程概览"></a>Devops 流程概览</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Devops流程概览.png" alt="Devops流程概览"></p>
<h4 id="代码分支管理"><a href="#代码分支管理" class="headerlink" title="代码分支管理"></a>代码分支管理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/代码分支管理.png" alt="代码分支管理"></p>
<h4 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/持续集成.png" alt="持续集成"></p>
<h4 id="持续部署"><a href="#持续部署" class="headerlink" title="持续部署"></a>持续部署</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/持续部署.png" alt="持续部署"></p>
<h4 id="GitOps"><a href="#GitOps" class="headerlink" title="GitOps"></a>GitOps</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GitOps.png" alt="GitOps"></p>
<h3 id="基于-GitHub-Action-的自动化流水线"><a href="#基于-GitHub-Action-的自动化流水线" class="headerlink" title="基于 GitHub Action 的自动化流水线"></a>基于 GitHub Action 的自动化流水线</h3><h4 id="基于公共-GitHub-的-action-构建流水线"><a href="#基于公共-GitHub-的-action-构建流水线" class="headerlink" title="基于公共 GitHub 的 action 构建流水线"></a>基于公共 GitHub 的 action 构建流水线</h4><p>低成本</p>
<ul>
<li>GitHub 目前为项目提供免费构建流水线，可满足日常构建需求</li>
</ul>
<p>免运维</p>
<ul>
<li>无需自己构建流水线，GitHub 提供小量构建请求</li>
</ul>
<p>易构建</p>
<ul>
<li>GitHub action 非常容易构建，只需点击几次按钮，即可完成</li>
<li>GitHub 提供了一系列内建 action，社区有大量可复用的 action</li>
</ul>
<p>易集成</p>
<ul>
<li>无需配置 GitHub Webhook 即可完成与 PR 的联动</li>
</ul>
<h4 id="Action-的创建"><a href="#Action-的创建" class="headerlink" title="Action 的创建"></a>Action 的创建</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GithubAction的创建.png" alt="GithubAction的创建"></p>
<h4 id="Action-细节"><a href="#Action-细节" class="headerlink" title="Action 细节"></a>Action 细节</h4><p><a target="_blank" rel="noopener" href="https://github.com/cncamp/golang/blob/master/.github/workflows/go.yml">https://github.com/cncamp/golang/blob/master/.github/workflows/go.yml</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> master <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>

  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Go
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>go@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">go-version</span><span class="token punctuation">:</span> <span class="token number">1.17</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build
      <span class="token key atrule">run</span><span class="token punctuation">:</span> go build <span class="token punctuation">-</span>v ./<span class="token punctuation">...</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test
      <span class="token key atrule">run</span><span class="token punctuation">:</span> go test <span class="token punctuation">-</span>v ./<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="基于-Jenkins-的自动化流水线"><a href="#基于-Jenkins-的自动化流水线" class="headerlink" title="基于 Jenkins 的自动化流水线"></a>基于 Jenkins 的自动化流水线</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于Jenkins的自动化流水线.png" alt="基于Jenkins的自动化流水线"></p>
<h4 id="Kubernetes-CI-amp-CD-完整流程"><a href="#Kubernetes-CI-amp-CD-完整流程" class="headerlink" title="Kubernetes CI&amp;CD 完整流程"></a>Kubernetes CI&amp;CD 完整流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/KubernetesCICD完整流程.png" alt="KubernetesCICD完整流程"></p>
<h4 id="持续集成容器化"><a href="#持续集成容器化" class="headerlink" title="持续集成容器化"></a>持续集成容器化</h4><p>最主要解决的问题是保证CI构建环境和开发构建环境的统一。</p>
<p>使用容器作为标准的构建环境，将代码库作为 Volume 挂载进构建容器。</p>
<p>由于构建结果是 Docker 镜像，所以要在构建容器中执行”docker build”命令，需要注意 DIND(docker in docker) 的问题，</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/持续集成容器化.png" alt="持续集成容器化"></p>
<h4 id="基于-Kubernetes-的持续集成"><a href="#基于-Kubernetes-的持续集成" class="headerlink" title="基于 Kubernetes 的持续集成"></a>基于 Kubernetes 的持续集成</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于Kubernetes的持续集成.png" alt="基于Kubernetes的持续集成"></p>
<h4 id="Docker-in-Docker-问题展开"><a href="#Docker-in-Docker-问题展开" class="headerlink" title="Docker in Docker 问题展开"></a>Docker in Docker 问题展开</h4><h5 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h5><p>docker in docker</p>
<p>早期尝试</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jpetazzo/dind">https://github.com/jpetazzo/dind</a></p>
<p>官方支持</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/_/docker/">https://hub.docker.com/_/docker/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run --privileged -d docker:dind<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可能引入的问题: <a target="_blank" rel="noopener" href="https://ipetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">https://ipetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/</a></p>
<p>if your use case really absolutely mandates Docker-in-Docker, have a look at <a target="_blank" rel="noopener" href="https://github.com/nestybox/sysbox">sysbox</a>, it might be what you need.</p>
<h5 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h5><p>mount host docker.socket</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>思考:可能引入的问题?</p>
<h5 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h5><p>Kaniko</p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoogleContainerTools/kaniko">https://github.com/GoogleContainerTools/kaniko</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> -e <span class="token string">'FROM alpine <span class="token entity" title="\n">\n</span>RUN echo "created from standard input"'</span> <span class="token operator">&gt;</span> Dockerfile <span class="token operator">|</span> <span class="token function">tar</span> -cf - Dockerfile <span class="token operator">|</span> <span class="token function">gzip</span> -9 <span class="token operator">|</span> docker run <span class="token punctuation">\</span>
  --interactive -v <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/workspace gcr.io/kaniko-project/executor:latest <span class="token punctuation">\</span>
  --context tar://stdin <span class="token punctuation">\</span>
  --destination<span class="token operator">=</span>cncamp/echoimage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="构建基于-Kubernetes-的-Jenkins-Pipeline"><a href="#构建基于-Kubernetes-的-Jenkins-Pipeline" class="headerlink" title="构建基于 Kubernetes 的 Jenkins Pipeline"></a>构建基于 Kubernetes 的 Jenkins Pipeline</h4><ol>
<li><p>Image准备: 基于Jenkins官方Image安装自定义插件</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/ienkinsci/kubernetes-plugin">https://github.com/ienkinsci/kubernetes-plugin</a><br> 默认安装kubernete plugin</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ienkinsci/docker-inlp-slave">https://github.com/ienkinsci/docker-inlp-slave</a><br> 如果需要做 docker build，则需要自定义 Dockerfile，安装 docker binary，并且把 host 的 docker.socket mount 进 container</li>
</ol>
</li>
<li><p>Jenkins 配置的保存</p>
<ol>
<li>需要创建 PVC，以便保证在 jenkins master pod 出错时，新的 kubernetes pod 可以 mount 同样的工作目录保证配置不丢失</li>
<li>可以通过 jenkins scm plugin 把 jenkins 配置保存至GitHub</li>
</ol>
</li>
<li><p>创建 Kubernetes spec</p>
</li>
</ol>
<h4 id="jenkins-的配置"><a href="#jenkins-的配置" class="headerlink" title="jenkins 的配置"></a>jenkins 的配置</h4><p>Cloud provider 配置</p>
<ul>
<li>在 jenkins System config 选择点击 Cloud，并选择 kubernetes</li>
<li>创建 Kubernetes ServiceAccount，并在 kubernetes 对应的 namespace 授予 namespace admin 权限</li>
<li>指定 Jenkins slave 的 image</li>
<li>按需指定 volume mount，如需在 slave container 内部执行 docker 命令，则需要 mount/var/run/docker.sock</li>
</ul>
<h4 id="创建-jenkins-Job"><a href="#创建-jenkins-Job" class="headerlink" title="创建 jenkins Job"></a>创建 jenkins Job</h4><p>Git integration</p>
<ul>
<li>Jenkins webhook on Github</li>
<li>Git review/merge Bot</li>
</ul>
<p>Build job</p>
<ul>
<li>Git clone code</li>
<li>Build binary</li>
<li>Build Docker image</li>
<li>Push Docker image to hub</li>
</ul>
<p>Testing</p>
<ul>
<li>UT/UT Coverage</li>
<li>E2E<ul>
<li>Conformance</li>
<li>Conformance Slow</li>
</ul>
</li>
<li>LnP</li>
</ul>
<h4 id="Jenkins-练习"><a href="#Jenkins-练习" class="headerlink" title="Jenkins 练习"></a>Jenkins 练习</h4><p>创建 Jenkins Master</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectlapply-fjenkins.yaml
kubectl apply -f sa.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>等待 Jenkins-0 pod 运行，查看日志查找 root 密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectllogs -f jenkins-0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 Jenkins Service 的 NodePort，登录 Jenkins console</p>
<p><code>http://192.168.34.2:&lt;nodePort&gt;</code></p>
<p>输入 root 密码并创建管理员用户，登录</p>
<p>安装Kubernetes插件</p>
<ul>
<li>菜单 ManageJenkins-&gt;Manage Plugins-&gt;Available</li>
<li>查找并安装 Kubernetes<ul>
<li>选择 Kubernetes，点击 install without restart</li>
</ul>
</li>
<li>等待安装完成</li>
</ul>
<p>配置 Cloud Provider</p>
<ul>
<li>菜单 Managejenkins-&gt;Manage Node and Cloud-&gt;Configure Cloud</li>
<li>Add a new cloud:Kubernetes<ul>
<li>Kubernetes URL: <a target="_blank" rel="noopener" href="https://kubernetes.default">https://kubernetes.default</a></li>
<li>Kubernetes Namespace: default</li>
<li>Credentials: Add-&gt;Jenkins-&gt;Kind: Kubernetes Service Account</li>
<li>Test connection</li>
<li>Jenkins URL: <a target="_blank" rel="noopener" href="http://Jenkins">http://Jenkins</a></li>
</ul>
</li>
<li>PodTemplate<ul>
<li>Labels: inlp-slave</li>
<li>Add Container // 新版本 Jenkins 会默认用社区镜像启动 jnlp slave，可以通过定义同名容器覆盖<ul>
<li>Name: jnlp</li>
<li>Image: cncamp/inbound-agent2</li>
<li>command: “”</li>
<li>Arguments to pass to the command: <code>${computer.jnlpmac} ${computer.name}</code></li>
</ul>
</li>
</ul>
</li>
<li>save</li>
</ul>
<p>create a job and tes</p>
<ul>
<li>Dashboard-&gt;Create a job-&gt;Freestyle project</li>
<li>Restrict where this project can be run<ul>
<li>LabelExpression: inlp-slave</li>
</ul>
</li>
<li>Build-&gt;Add build step-&gt;Execute shell<ul>
<li>echo hello world</li>
</ul>
</li>
<li>Build Now</li>
<li>查看 jenkins slave pod: <code>kubectl get pod</code></li>
<li>查看job log</li>
</ul>
<h3 id="Tekton"><a href="#Tekton" class="headerlink" title="Tekton"></a>Tekton</h3><h4 id="Jenkins-的不足"><a href="#Jenkins-的不足" class="headerlink" title="Jenkins 的不足"></a>Jenkins 的不足</h4><p>基于脚本的 Job 配置复用率不足。</p>
<ul>
<li>Jenkins 等工具的流水线作业通常基于大量不可复用的脚本语言，如何提高代码复用率</li>
</ul>
<p>代码调试困难</p>
<ul>
<li>如何让流水线作业的配置更好地适应云原生场景的需求越来越急迫</li>
</ul>
<h4 id="基于声明式-API-的流水线-Tekton"><a href="#基于声明式-API-的流水线-Tekton" class="headerlink" title="基于声明式 API 的流水线-Tekton"></a>基于声明式 API 的流水线-Tekton</h4><p>自定义: Tekton 对象是高度自定义的，可扩展性极强。平台工程师可预定义可重用模块以详细的模块目录提供，开发人员可在其他项目中直接引用。</p>
<p>可重用: Tekton 对象的可重用性强，组件只需一次定义，即可被组织内的任何人在任何流水线都可重用。使得开发人员无需重复造轮子即可构建复杂流水线。</p>
<p>可扩展性: Tekton 组件目录(TektonCatalog)是一个社区驱动的 Tekton 组件的存储仓库，任何用户可以直接从社区获取成熟的组件并在此之上构建复杂流水线，也就是当你要构建一个流水线时，很可能你需要的所有代码和配置都可以从 Tekton Catalog 直接拿下来复用，而无需重复开发</p>
<p>标准化: Tekton 作为 Kubernetes 集群的扩展安装和运行，并使用业界公认的 Kubernetes 资源模型 Tekton 作业以 Kubernetes 容器形态执行。</p>
<p>规模化支持: 只需增加 Kubernetes 节点，即可增加作业处理能力。Tekton 的能力可依照集群规模随意扩充，无需重新定义资源分配需求或者重新定义流水线。</p>
<h4 id="Tekton-核心组件"><a href="#Tekton-核心组件" class="headerlink" title="Tekton 核心组件"></a>Tekton 核心组件</h4><p>Pipeline: 对象定义了一个流水线作业，一个 Pipeline 对象由一个或数个 Task 对象组成。</p>
<p>Task: 一个可独立运行的任务，如获取代码，编译，或者推送镜像等等，当流水线被运行时，Kubernetes 会为每个 Task 创建一个 Pod。一个 Task 由多个 Step 组成，每个 Step 体现为这个 Pod 中的一个容器。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Tekton核心组件.png" alt="Tekton核心组件"></p>
<h4 id="输入输出资源"><a href="#输入输出资源" class="headerlink" title="输入输出资源"></a>输入输出资源</h4><p>Pipeline 和 Task 对象可以接收 git reposity，pull request 等资源作为输入，可以将 Image, Kubernetes Cluster，Storage，CloudEvent 等对象作为输出</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/输入输出资源.png" alt="输入输出资源"></p>
<h4 id="事件触发的自动化流水线"><a href="#事件触发的自动化流水线" class="headerlink" title="事件触发的自动化流水线"></a>事件触发的自动化流水线</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/事件触发的自动化流水线.png" alt="事件触发的自动化流水线"></p>
<h4 id="EventListener"><a href="#EventListener" class="headerlink" title="EventListener"></a>EventListener</h4><p>事件监听器，该对象核心属性是 interceptors 拦截器，该拦截器可监听多种类型的事件，比如监听来自 GitLab 的 Push 事件。</p>
<p>当该 EventListener 对象被创建以后，Tekton 控制器会为该 EventListener 创建 Kubernetes Pod 和 Service，并启动一个 HTTP 服务以监听 Push 事件。</p>
<p>当用户在 GitLab 项目中设置 webhook 并填写该 EventListener 的服务地址以后，任何人针对被管理项目发起的 Push 操作，都会被 EventListener 捕获。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> triggers.tekton.dev/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> EventListener
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>listener
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  serviceAccountName<span class="token punctuation">:</span>cncampgitlab<span class="token punctuation">-</span>sa
  <span class="token key atrule">triggers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>push<span class="token punctuation">-</span>events<span class="token punctuation">-</span>trigger
  <span class="token key atrule">interceptors</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ref</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab
    <span class="token key atrule">params</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secretRef
     <span class="token key atrule">value</span><span class="token punctuation">:</span>
     <span class="token key atrule">secretName</span><span class="token punctuation">:</span> cncamp<span class="token punctuation">-</span>gitlab<span class="token punctuation">-</span>secret
     <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> secretToken
    <span class="token punctuation">-</span> name<span class="token punctuation">:</span>eventTypes
      <span class="token key atrule">value</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> Push Hook
  <span class="token key atrule">bindings</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ref</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>binding
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">ref</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>triggertemplate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="TriggerTemplate"><a href="#TriggerTemplate" class="headerlink" title="TriggerTemplate"></a>TriggerTemplate</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> triggers.tekton.dev/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> TriggerTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>triggertemplate
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">params</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitrevision
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitrepositoryurl
  <span class="token key atrule">resourcetemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> PipelineRun
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> tekton.dev/v1beta1
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">generateName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>pipeline<span class="token punctuation">-</span>run<span class="token punctuation">-</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> cncamp<span class="token punctuation">-</span>gitlab<span class="token punctuation">-</span>sa
      <span class="token key atrule">pipelinespec</span><span class="token punctuation">:</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> checkout
          <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>checkout
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
              <span class="token key atrule">resource</span><span class="token punctuation">:</span> source
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
          <span class="token key atrule">type</span><span class="token punctuation">:</span> git
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
        <span class="token key atrule">resourceSpec</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> git
          <span class="token key atrule">params</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> revision
            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(tt.params.gitrevision)
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> url
            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(tt.params.gitrepositoryurl)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="GitLab-webhook"><a href="#GitLab-webhook" class="headerlink" title="GitLab webhook"></a>GitLab webhook</h5><p>只需在 GitLab 中的被管理项目中设置一个 Webhook，以确保该项目中的事件通知会发送至 EventListener 的服务地址即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GitLabWebhook.png" alt="GitLabWebhook"></p>
<h3 id="Argocd"><a href="#Argocd" class="headerlink" title="Argocd"></a>Argocd</h3><p>ArgoCD 是用于 Kubernetes 的声明性 GitOps 连续交付工具。</p>
<p>为什么选择 Argo CD?</p>
<p>应用程序定义，配置和环境应为声明性的，并受版本控制。</p>
<p>应用程序部署和生命周期管理应该是自动化的，可审核的且易于理解的。</p>
<h4 id="argo-cd-架构"><a href="#argo-cd-架构" class="headerlink" title="argo cd 架构"></a>argo cd 架构</h4><p>Argo CD 被实现为 kubernetes 控制器，该控制器连续监视正在运行的应用程序，并将当前的活动状态与所需的目标状态(在Git存储库中指定)进行比较。</p>
<p>其活动状态偏离目标状态的已部署应用程序被标记为 OutOfSync。</p>
<p>Argo CD 报告并可视化差异，同时提供了自动或手动将实时状态同步回所需目标状态的功能。</p>
<p>在 Git 存储库中对所需目标状态所做的任何修改都可以自动应用并反映在指定的目标环境中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/argocd架构.png" alt="argocd架构"></p>
<h4 id="安装-argocd"><a href="#安装-argocd" class="headerlink" title="安装 argocd"></a>安装 argocd</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>确保 argocd-serverservice 类型为 NodePort</p>
<p>访问 argocd 控制台</p>
<ul>
<li>用户名: admin</li>
<li>密码: <code>kget secret -n argocd argocd-initial-admin-secret -oyaml</code></li>
</ul>
<h4 id="argocd-的适用场景"><a href="#argocd-的适用场景" class="headerlink" title="argocd 的适用场景"></a>argocd 的适用场景</h4><ol>
<li>低成本的 Gitops 利器</li>
<li>多集群管理<ol>
<li>不同目的集群: 测试，集成，预生产，生产</li>
<li>多生产集群管理</li>
</ol>
</li>
</ol>
<h3 id="监控和日志"><a href="#监控和日志" class="headerlink" title="监控和日志"></a>监控和日志</h3><h4 id="数据系统构建"><a href="#数据系统构建" class="headerlink" title="数据系统构建"></a>数据系统构建</h4><p>日志收集与分析</p>
<p>监控系统构建</p>
<h4 id="日志系统的价值"><a href="#日志系统的价值" class="headerlink" title="日志系统的价值"></a>日志系统的价值</h4><p>分布式系统的日志查看比较复杂，因为多对节点的系统，要先找到正确的节点，才能看到想看的日志。日志系统把整个集群的日志汇总在一起，方便查看</p>
<p>因为节点上的日志滚动机制，如果有应用打印太多日志，如果没有日志系统，会导致关键日志丢失。</p>
<p>日志系统的重要意义在于解决，节点出错导致不可访问，进而丢失日志的情况，</p>
<h4 id="常用数据系统构建模式"><a href="#常用数据系统构建模式" class="headerlink" title="常用数据系统构建模式"></a>常用数据系统构建模式</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/常用数据系统构建模式.png" alt="常用数据系统构建模式"></p>
<h4 id="日志收集系统-Loki"><a href="#日志收集系统-Loki" class="headerlink" title="日志收集系统 Loki"></a>日志收集系统 Loki</h4><p>Grafana Loki 是可以组成功能齐全的日志记录堆栈的一组组件，</p>
<ul>
<li>与其他日志记录系统不同，Loki 是基于仅索引有关日志的元数据的想法而构建的:标签。</li>
<li>日志数据本身被压缩并存储在对象存储(例如 S3 或 GCS )中的块中，甚至存储在文件系统本地。</li>
<li>小索引和高度压缩的块简化了操作，并大大降低了 Loki 的成本。</li>
</ul>
<h4 id="基于-Loki-的日志收集系统"><a href="#基于-Loki-的日志收集系统" class="headerlink" title="基于 Loki 的日志收集系统"></a>基于 Loki 的日志收集系统</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于Loki的日志收集系统.png" alt="基于Loki的日志收集系统"></p>
<h4 id="Loki-stack-子系统"><a href="#Loki-stack-子系统" class="headerlink" title="Loki-stack 子系统"></a>Loki-stack 子系统</h4><p>Promtail</p>
<ul>
<li>将容器日志发送到 Loki 或者 Grafana 服务上的日志收集工具</li>
<li>发现采集目标以及给日志流添加上 Label，然后发送给 Loki</li>
<li>Promtail 的服务发现是基于 Prometheus 的服务发现机制实现的，可以查看configmap lokipromtail了解细节</li>
</ul>
<p>Loki</p>
<ul>
<li>Loki 是可以水平扩展、高可用以及支持多租户的日志聚合系统</li>
<li>使用和 Prometheus 相同的服务发现机制，将标签添加到日志流中而不是构建全文索引</li>
<li>Promtail 接收到的日志和应用的 metrics 指标就具有相同的标签集</li>
</ul>
<p>Grafana</p>
<ul>
<li>Grafana 是一个用于监控和可视化观测的开源平台，支持非常丰富的数据源</li>
<li>在 Loki 技术栈中它专门用来展示来自 Prometheus 和 Loki 等数据源的时间序列数据</li>
<li>允许进行查询、可视化、报警等操作，可以用于创建、探索和共享数据 Dashboard</li>
</ul>
<h4 id="Loki-架构"><a href="#Loki-架构" class="headerlink" title="Loki 架构"></a>Loki 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Loki架构.png" alt="Loki架构"></p>
<h4 id="Loki-组件"><a href="#Loki-组件" class="headerlink" title="Loki 组件"></a>Loki 组件</h4><p>Distributor(分配器)</p>
<ul>
<li>分配器服务负责处理客户端写入的日志。</li>
<li>一旦分配器接收到日志数据，它就会把它们分成若干批次，并将它们并行地发送到多个采集器去。</li>
<li>分配器通过 RPC 和采集器进行通信。</li>
<li>它们是无状态的，基于一致性哈希，我们可以根据实际需要对他们进行扩缩容。</li>
</ul>
<p>Ingester(采集器)</p>
<ul>
<li>采集器服务负责将日志数据写入长期存储的后端(DvnamoDB、S3、Cassandra 等等)</li>
<li>采集器会校验采集的日志是否乱序。</li>
<li>采集器验证接收到的日志行是按照时间戳递增的顺序接收的，否则日志行将被拒绝并返回错误。</li>
</ul>
<p>Querier(查询器)</p>
<ul>
<li>查询器服务负责处理 LogQL 查询语句来评估存储在长期存储中的日志数据</li>
</ul>
<h4 id="安装-Loki-stack"><a href="#安装-Loki-stack" class="headerlink" title="安装 Loki stack"></a>安装 Loki stack</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module10/loki-stack/readme.MD">https://github.com/kibaamor/101/blob/master/module10/loki-stack/readme.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/grafana/helm-charts/blob/main/charts/loki-stack/README.md">https://github.com/grafana/helm-charts/blob/main/charts/loki-stack/README.md</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm repo <span class="token function">add</span> grafana https://grafana.github.io/helm-charts

helm repo update

kubectl create namespace loki-stack

helm upgrade --install --namespace<span class="token operator">=</span>loki-stack --set grafana.enabled<span class="token operator">=</span>true,prometheus.enabled<span class="token operator">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span class="token operator">=</span>false,prometheus.server.persistentVolume.enabled<span class="token operator">=</span>false loki grafana/loki-stack

kubectl get secret --namespace loki-stack loki-grafana -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"{.data.admin-password}"</span> <span class="token operator">|</span> base64 --decode <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span>

kubectl port-forward --namespace loki-stack service/loki-grafana <span class="token number">3000</span>:80
<span class="token comment"># username: admin</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在-Kubernetes-集群中的日志系统"><a href="#在-Kubernetes-集群中的日志系统" class="headerlink" title="在 Kubernetes 集群中的日志系统"></a>在 Kubernetes 集群中的日志系统</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/在Kubernetes集群中的日志系统.png" alt="在Kubernetes集群中的日志系统"></p>
<h4 id="在生产中的问题"><a href="#在生产中的问题" class="headerlink" title="在生产中的问题"></a>在生产中的问题</h4><p>利用率低</p>
<ul>
<li>日志大多数目的是给管理员做问题分析用的，但管理员更多的是登陆到节点或者 pod 里做分析，因为日志分析只是整个分析过程中的一部分，所以很多时候顺手就把日志看了</li>
</ul>
<p>Beats 出现过锁住文件系统，docker container 无法删除的情况</p>
<p>与监控系统相比，日志系统的重要度稍低</p>
<p>出现过多次因为日志滚动太快而使得日志收集占用太大网络带宽的情况</p>
<h4 id="监控系统"><a href="#监控系统" class="headerlink" title="监控系统"></a>监控系统</h4><p>为什么监控，监控什么内容?</p>
<ul>
<li>对自己系统的运行状态了如指掌，有问题及时发现，而不让用户先发现我们系统不能使用。</li>
<li>我们也需要知道我们的服务运行情况。例如，slowsql 处于什么水平，平均响应时间超过 200ms 的占比有百分之多少?</li>
</ul>
<p>我们为什么需要监控我们的服务?</p>
<ul>
<li>需要监控工具来提醒我服务出现了故障，比如通过监控服务的负载来决定扩容或缩容。如果机器普遍负载不高，则可以考虑是否缩减一下机器规模，如果数据库经常维持在一个高位水平，则可以考虑一下是否可以进行拆库处理，优化一下架构。</li>
<li>监控还可以帮助进行内部统制，尤其是对安全比较敏感的行业比如证券银行等。比如服务器受到攻击时我们需要分析事件，找到根本原因，识别类似攻击，发现没有发现的被攻的系统，甚完成取证等工作</li>
</ul>
<p>监控目的</p>
<ul>
<li>减少宕机时间</li>
<li>扩展和性能管理</li>
<li>资源计划</li>
<li>识别异常事件</li>
<li>故障排除、分析</li>
</ul>
<h4 id="在-Kubernetes-集群中的监控系统"><a href="#在-Kubernetes-集群中的监控系统" class="headerlink" title="在 Kubernetes 集群中的监控系统"></a>在 Kubernetes 集群中的监控系统</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/在Kubernetes集群中的监控系统.png" alt="在Kubernetes集群中的监控系统"></p>
<p>每个节点的 kubelet(集成了 cAdvisor)会收集当前节点 host 上所有信息，包括 cpu、内存、磁盘等。Prometheus 会 pull 这些信息，给每个节点打上标签来区分不同的节点。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">HELP container cpu system seconds total Cumulative system cpu time consumed in seconds.
# TYPE container cpu system seconds total counter
container_cpu_system_seconds_total{id="/"} 735292
container_cpu_system_seconds_total{id="/system.slice"} 710067.82
container_cpu_system_seconds_total{id="/system.slice/atd.service"} 0.04
container_cpu_system_seconds_total{id="/system.slice/auditd.service"} 652.29
container_cpu_system_seconds_total{id="/system.slice/cloud-config.seryice"} 0
container_cpu_system_seconds_total{id=""/system.slice/cloud-final.service"} 0
container_cpu_system_seconds_total{id="/system.slice/cloud-init-local.service"} 0
container_cpu_system_seconds_totalfid="/system,slice/cloud-init.seryice"} 0
container_cpu_system_seconds_total{id="/system.slice/crond.service"} 4267.6
container_cpu_system_seconds_totallid="/system.slice/dbus.service"} 3.44
container_cpu_system_seconds_total{id="/system,slice/dm-event.service"} 428.39
container_cpu_system_seconds_total{id="/system.slice/docker.seryice"} 55096.24
container_cpu_svstem_seconds_totallid="/system,slice/dracut-shutdown,service"} 0
container_cpu_system_seconds_total{id="/system,slice/fedora-autorelabel-mark.service"} 0
container_cpu_system_seconds_total{id="/system,slice/fedora-import-state.service"} 0
container_cpu_svstem_seconds_totallid"/svstem,slice/fedora-readonly.seryice"} 0
container_cpu_system_seconds_totalfid="/system,slice/assproxy,seryice"} 27.07
container_cpu_system_seconds_total{id="/system.slice/iscsi-shutdown.service"} 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在-Kubernetes-中汇报指标"><a href="#在-Kubernetes-中汇报指标" class="headerlink" title="在 Kubernetes 中汇报指标"></a>在 Kubernetes 中汇报指标</h4><p>应用 Pod 需要声明上报指标端口和地址</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    prometheus.io/scrape<span class="token punctuation">:</span>"true
<span class="token key atrule">name</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span><span class="token number">0</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3100</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应用启动时，需要注册 metrics</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span>promhttp<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>sever<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注册指标</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RegisterMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    registerMetricOnce<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>APiServerRequests<span class="token punctuation">)</span>
        prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>WorkQueueSize<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码中输出指标</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">metrics<span class="token punctuation">.</span><span class="token function">AddAPServerRequest</span><span class="token punctuation">(</span>controllerName<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>CoreAPlGroup<span class="token punctuation">,</span> constants<span class="token punctuation">.</span>SecretResourceconstants<span class="token punctuation">.</span>Get<span class="token punctuation">,</span> cn<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Kubernetes-集群中的监控系统"><a href="#Kubernetes-集群中的监控系统" class="headerlink" title="Kubernetes 集群中的监控系统"></a>Kubernetes 集群中的监控系统</h4><p>Kubernetes 的 controlpanel，包括各种 controller 都原生的暴露 Prometheus 格式的 metrics。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes集群中的监控系统.png" alt="Kubernetes集群中的监控系统"></p>
<h4 id="Prometheus-中的指标类型"><a href="#Prometheus-中的指标类型" class="headerlink" title="Prometheus 中的指标类型"></a>Prometheus 中的指标类型</h4><p>Counter 计数器</p>
<ul>
<li>Counter 类型代表一种样本数据单调递增的指标，即只增不减，除非监控系统发生了重置。</li>
</ul>
<p>Gauge 仪表盘</p>
<ul>
<li>Guage 类型代表一种样本数据可以任意变化的指标，即可增可减。</li>
</ul>
<p>Histogram 直方图</p>
<ul>
<li>Histogram 在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶 bucket 中，后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图</li>
<li>样本的值分布在 bucket 中的数量，命名为 <code>&lt;basename&gt;_bucket{le="&lt;上边界&gt;"}</code></li>
<li>所有样本值的大小总和，命名为 <code>&lt;basename&gt;_sum</code></li>
<li>样本总数，命名为 <code>&lt;basename&gt;_count</code>。值和 <code>&lt;basename&gt;_bucket{le="+inf"}</code> 相同</li>
</ul>
<p>Summary 摘要</p>
<ul>
<li>与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算</li>
<li>它们都包含了 <code>basename&gt;_sum</code> 和 <code>&lt;basename&gt;_count</code> 指标</li>
<li>Histogram 需要通过 <code>&lt;basename&gt;_bucket</code> 来计算分位数，而 Summary 则直接存储了分位数的值。</li>
</ul>
<h4 id="Prometheus-QueryLanguage"><a href="#Prometheus-QueryLanguage" class="headerlink" title="Prometheus QueryLanguage"></a>Prometheus QueryLanguage</h4><p><code>histogram_quantile(0.95, sum(httpserver_execution_latency_seconds_bucket[5m])) by (le))</code></p>
<ul>
<li>Histogram 是直方图，<code>httpserver_execution_latency_seconds_bucket</code> 是直方图指标 ，是将 httpserver 处理请求的时间放入不同的桶内，其表达的是落在不同时长区间的响应次数</li>
<li><code>by (le)</code> 是将采集的数据按桶的上边界分组</li>
<li><code>rate(httpserver_execution_latency_seconds_bucket[5m])</code>，计算的是五分钟内的变化率</li>
<li><code>Sum()</code> 是将所有指标的变化率总计</li>
<li><code>0.95</code> 是取 95 分位</li>
</ul>
<p>综上：上述表达式计算的是 httpserver 处理请求时，95% 的请求在五分钟内，在不同响应时间区间的处理的数量的变化情况</p>
<h4 id="Grafana-Dashboard"><a href="#Grafana-Dashboard" class="headerlink" title="Grafana Dashboard"></a>Grafana Dashboard</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/GrafanaDashboard.png" alt="GrafanaDashboard"></p>
<h4 id="开启告警"><a href="#开启告警" class="headerlink" title="开启告警"></a>开启告警</h4><p>修改 Prometheus 配置文件 prometheus.yml，添加以下配置:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">rule files</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> /etc/prometheus/rules/<span class="token important">*.rules</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在目录 /etc/prometheus/rules/ 下创建告警文件 hoststats-alert.rules 内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hostStatsAlert
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> hostCpuUsageAlert
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> sum(avg without (cpu)(irate(node_cpu<span class="token punctuation">{</span>mode<span class="token tag">!='idle'</span><span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span>))) by (instance) <span class="token punctuation">&gt;</span> 0.85
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> High
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Instance {{$labels.instance}} CPU usgae high"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"{{ $labels.instance }} CPU usage above 85% (current value: {{ $value }})"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="构建支撑生产的监控系统"><a href="#构建支撑生产的监控系统" class="headerlink" title="构建支撑生产的监控系统"></a>构建支撑生产的监控系统</h4><p>Metrics</p>
<ul>
<li>收集数据</li>
</ul>
<p>Alert</p>
<ul>
<li>创建告警规则，如果告警规则被触发，则按不同眼中程度来告警</li>
</ul>
<p>Assertion</p>
<ul>
<li>以一定时间间隔，模拟客户行为，操作 kubernetes 对象，并断言成功，如果不成功则按眼中程度告警</li>
</ul>
<h4 id="来自生产系统的经验分享"><a href="#来自生产系统的经验分享" class="headerlink" title="来自生产系统的经验分享"></a>来自生产系统的经验分享</h4><p>Prometheus 需要大内存和存储</p>
<ul>
<li>最初 prometheus 经常发生 OOM kill</li>
<li>在提高指定的资源以后，如果发生 crash 或者重启，prometheus 需要 30 分钟以上的时间来读取数据进行初始化</li>
</ul>
<p>Prometheus 是运营生产系统过程中最重要的模块</p>
<ul>
<li>如果 prometheus down 机，则没有任何数据和告警，管理员两眼一黑，什么都不知道了</li>
</ul>
<h4 id="课后练习-1"><a href="#课后练习-1" class="headerlink" title="课后练习"></a>课后练习</h4><ol>
<li>为 HTTPServer 添加 0-2 秒的随机延时</li>
<li>为 HTTPServer 项目添加延时 Metric</li>
<li>将 HTTPServer 部署至测试集群，并完成 Prometheus 配置</li>
<li>从 Promethus 界面中查询延时指标数据</li>
<li>(可选)创建一个 Grafana Dashboard 展现延时分配情况</li>
</ol>
<h2 id="将应用迁移至-Kubernetes-平台"><a href="#将应用迁移至-Kubernetes-平台" class="headerlink" title="将应用迁移至 Kubernetes 平台"></a>将应用迁移至 Kubernetes 平台</h2><h3 id="应用接入最佳实践"><a href="#应用接入最佳实践" class="headerlink" title="应用接入最佳实践"></a>应用接入最佳实践</h3><h4 id="应用容器化"><a href="#应用容器化" class="headerlink" title="应用容器化"></a>应用容器化</h4><h5 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h5><p>稳定性、可用性、性能、安全</p>
<p>从多维度思考高可用的问题</p>
<ul>
<li><p>单个实例视角</p>
<ul>
<li>资源需求</li>
<li>配置管理</li>
<li>数据保存</li>
<li>日志和指标收集</li>
</ul>
</li>
<li><p>应用视角</p>
<ul>
<li>冗余部署</li>
<li>部署多少个实例</li>
<li>负载均衡</li>
<li>健康检查</li>
<li>服务发现</li>
<li>监控</li>
<li>故障转移</li>
<li>扩缩容</li>
</ul>
</li>
<li><p>安全视角</p>
<ul>
<li>镜像安全</li>
<li>应用安全</li>
<li>数据安全</li>
<li>通讯安全</li>
</ul>
</li>
</ul>
<h5 id="应用容器化的思考"><a href="#应用容器化的思考" class="headerlink" title="应用容器化的思考"></a>应用容器化的思考</h5><p>应用本身</p>
<ul>
<li>启动速度</li>
<li>健康检查</li>
<li>启动参数</li>
</ul>
<p>Dockerfile</p>
<ul>
<li><p>用什么基础镜像</p>
<ul>
<li>基础镜像越小越好</li>
</ul>
</li>
<li><p>需要装什么 Utility</p>
<ul>
<li>lib 越少越好?</li>
</ul>
</li>
<li><p>多少个进程</p>
<ul>
<li>主次要分清楚，哪个是决定状态的主程序</li>
<li>Fork bomb 的危害</li>
</ul>
</li>
<li><p>代码(应用程序)和配置分离</p>
<ul>
<li><p>配置如何管理</p>
<ul>
<li>环境变量</li>
<li>配置文件</li>
</ul>
</li>
</ul>
</li>
<li><p>分层的控制</p>
</li>
<li><p>Entrypoint</p>
</li>
</ul>
<p>思考：GOMAXPROCS 会如何设置？</p>
<h5 id="容器额外开销和风险"><a href="#容器额外开销和风险" class="headerlink" title="容器额外开销和风险"></a>容器额外开销和风险</h5><p>Log driver</p>
<ul>
<li>Blocking mode</li>
<li>Non blocking mode</li>
</ul>
<p>共用 kernel 所以</p>
<ul>
<li>系统参数配置共享</li>
<li>进程数共享 - Fork bomb</li>
<li>fd 数共享</li>
<li>主机磁盘共享</li>
</ul>
<h5 id="容器化应用的资源监控"><a href="#容器化应用的资源监控" class="headerlink" title="容器化应用的资源监控"></a>容器化应用的资源监控</h5><p>容器中看到的资源是主机资源</p>
<ul>
<li>Top</li>
<li>Java <code>runtime.GetAvailableProcesses()</code></li>
<li><code>cat /proc/cpuinfo</code></li>
<li><code>cat /proc/meminfo</code></li>
<li><code>df -k</code></li>
</ul>
<p>解决方案</p>
<ul>
<li><p>查询 <code>/proc/1/cgroup</code> 是否包含 <code>kubepods</code> 关键字(docker 关键字不可靠)。</p>
<ul>
<li><code>11:cpu,cpuacct:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod521722c3 85a8 11e9 87fc 3cfdfe57c998.slice/9568cc0d8ae182395e1ce172e2cac723c4781a999e89e0f9f10d33af079a56e9</code></li>
</ul>
</li>
<li><p>包含此关键字，则表明是运行在 Kubernetes 之上。</p>
</li>
</ul>
<h5 id="内存开销"><a href="#内存开销" class="headerlink" title="内存开销"></a>内存开销</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配额</span>
$ <span class="token function">cat</span> /sys/fs/cgroup/memory/memory.limit_in_bytes
<span class="token number">36854771712</span>

<span class="token comment"># 用量</span>
$ <span class="token function">cat</span> /sys/fs/cgroup/memory/memory.usage_in_bytes
<span class="token number">448450560</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配额，分配的CPU个数 = quota/period，quota = -1 代表 besteffort</span>
$ <span class="token function">cat</span> /sys/fs/cgroup/cpu/cpu.cfs_quota_us
-1
$ <span class="token function">cat</span> /sys/fs/cgroup/cpu/cpu.cfs_period_us
<span class="token number">100000</span>

<span class="token comment"># 用量 (按CPU区分)</span>
$ <span class="token function">cat</span> /sys/fs/cgroup/cpuacct/cpuacct.usage_percpu
<span class="token number">8081106980</span> <span class="token number">4323359623</span> <span class="token number">4636995549</span> <span class="token number">3325343025</span> <span class="token number">4953653066</span> <span class="token number">3540876400</span> <span class="token number">5181477709</span> <span class="token number">4144887674</span> <span class="token number">10399151669</span> <span class="token number">2410161200</span> <span class="token number">8233879500</span> <span class="token number">3909704000</span> <span class="token number">6805757900</span> <span class="token number">2647133700</span> <span class="token number">7813652536</span> <span class="token number">2739789424</span>
$ <span class="token function">cat</span> /sys/fs/cgroup/cpuacct/cpuacct.usage
<span class="token number">83905685155</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h5><p>lxcfs</p>
<ul>
<li>通过 so 挂载的方式，使容器获得正确的资源信息</li>
</ul>
<p>Kata</p>
<ul>
<li>VM 中跑 container</li>
</ul>
<p>Virtlet</p>
<ul>
<li>直接启动 VM</li>
</ul>
<h5 id="对应用造成的影响"><a href="#对应用造成的影响" class="headerlink" title="对应用造成的影响"></a>对应用造成的影响</h5><p>Java</p>
<ul>
<li>Concurrent GC Thread;</li>
<li>Heap Size;</li>
<li>线程数不可控。</li>
</ul>
<p>Node.js</p>
<ul>
<li>多线程模式启动的 Thread 数量过多，导致 OOM Kill。</li>
</ul>
<h4 id="将应用迁移至-Kubernetes"><a href="#将应用迁移至-Kubernetes" class="headerlink" title="将应用迁移至 Kubernetes"></a>将应用迁移至 Kubernetes</h4><h5 id="Pod-spec"><a href="#Pod-spec" class="headerlink" title="Pod spec"></a>Pod spec</h5><p>初始化需求(init container)</p>
<p>需要几个主 container</p>
<p>权限?Privilege 和 Securitycontext(PSP)</p>
<p>共享哪些 Namespace(PID,IPC, NET, UTS, MNT)</p>
<p>配置管理</p>
<p>优雅终止</p>
<p>健康检查</p>
<ul>
<li>Liveness Probe</li>
<li>Readiness Probe</li>
</ul>
<p>DNS 策略以及对 resolv.conf 的影响imagePullPolicylmage 拉取策略</p>
<h5 id="Probe-误用会造成严重后果"><a href="#Probe-误用会造成严重后果" class="headerlink" title="Probe 误用会造成严重后果"></a>Probe 误用会造成严重后果</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Probe误用会造成严重后果.png" alt="Probe误用会造成严重后果"></p>
<p>probe 其实就是通过 entrypoint fork 一个进程来执行的，probe 脚本的父进程是 entrypoint。脚本超时后 kubernetes 就会把进程强制杀死，被杀死的进程需要等待父进程（即 entrypoint）清理（waitpid/wait）后才会释放资源。如果entrypoint 不具备清理子进程的能力就会出现僵尸进程。</p>
<h5 id="如何防止-PID-泄露"><a href="#如何防止-PID-泄露" class="headerlink" title="如何防止 PID 泄露"></a>如何防止 PID 泄露</h5><p>单进程容器</p>
<p>合理的处理多进程容器</p>
<ul>
<li>容器的初始化进程必须负责清理 fork 出来的所有子进程</li>
<li><p>开源方案</p>
<ul>
<li>Tini <a target="_blank" rel="noopener" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a></li>
<li>采用 Tini 作为容器的初始化进程 (PID=1) 容器中僵尸进程的父进程会被置为 1</li>
</ul>
</li>
</ul>
<p>如果不采用特殊初始化进程</p>
<ul>
<li>建议采用 HTTPCheck 作为 Probe</li>
<li>为 exec Probe 设置合理的超时时间</li>
</ul>
<h5 id="在-Kubernetes-上部署应用的挑战-1"><a href="#在-Kubernetes-上部署应用的挑战-1" class="headerlink" title="在 Kubernetes 上部署应用的挑战"></a>在 Kubernetes 上部署应用的挑战</h5><p>资源规划</p>
<ul>
<li><p>每个实例需要多少计算资源</p>
<ul>
<li>CPU/GPU?</li>
<li>Memory</li>
</ul>
</li>
<li><p>超售需求</p>
</li>
<li><p>每个实例需要多少存储资源</p>
<ul>
<li>大小</li>
<li>本地还是网盘</li>
<li>读写性能</li>
<li>DiskIO</li>
</ul>
</li>
<li><p>网络需求</p>
<ul>
<li>整个应用总体 OPS 和带宽</li>
</ul>
</li>
</ul>
<h5 id="Pod-的数据管理"><a href="#Pod-的数据管理" class="headerlink" title="Pod 的数据管理"></a>Pod 的数据管理</h5><ul>
<li>local-ssd：独占的本地磁盘，独占IO，固定大小，读写性能高。</li>
<li>Local-dynamic：基于LVM，动态分配空间，效率低。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Pod的数据管理.png" alt="Pod的数据管理"></p>
<h5 id="我的数据应该保存在哪里"><a href="#我的数据应该保存在哪里" class="headerlink" title="我的数据应该保存在哪里"></a>我的数据应该保存在哪里</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/我的数据应该保存在哪里.png" alt="我的数据应该保存在哪里"></p>
<h5 id="应用配置-1"><a href="#应用配置-1" class="headerlink" title="应用配置"></a>应用配置</h5><p>传入方式</p>
<ul>
<li>Environment Variables</li>
<li>Volume Mount</li>
</ul>
<p>数据来源</p>
<ul>
<li>Configmap</li>
<li>Secret</li>
<li>Downward API</li>
</ul>
<h5 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h5><p>需要多少实例?</p>
<p>如何控制失败域，部署在几个地区，AZ，集群?</p>
<p>如何进行精细的流量控制?</p>
<p>如何做按地域的顺序更新?</p>
<p>如何回滚?</p>
<h5 id="如何应对基础架构的影响"><a href="#如何应对基础架构的影响" class="headerlink" title="如何应对基础架构的影响"></a>如何应对基础架构的影响</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/如何应对基础架构的影响.png" alt="如何应对基础架构的影响"></p>
<h5 id="PodDisruptionBudget"><a href="#PodDisruptionBudget" class="headerlink" title="PodDisruptionBudget"></a>PodDisruptionBudget</h5><p>PDB 是为了自主中断时保障应用的高可用。</p>
<p>在使用 PDB 时，你需要弄清楚你的应用类型以及你想要的应对措施:</p>
<ul>
<li><p>无状态应用:</p>
<ul>
<li>目标:至少有60%的副本 Available。</li>
<li>方案:创建 PDB Object，指定 minAvailable为 60%，或者 maxUnavailable 为 40%。</li>
</ul>
</li>
<li><p>单实例的有状态应用:</p>
<ul>
<li>目标:终止这个实例之前必须提前通知客户并取得同意。</li>
<li>方案:创建 PDB Object，并设置 maxUnavailable 为 0。</li>
</ul>
</li>
<li><p>多实例的有状态应用:</p>
<ul>
<li>目标最少可用的实例数不能少于某个数 N，例如 etcd。</li>
<li>方案:设置 maxUnavailable=1或者 minAvailable=N，分别允许每次只删除一个实例和每次删除 expected_replicas - minAvailable 个实例。</li>
</ul>
</li>
</ul>
<blockquote>
<p>PDB 仅在主动驱逐时有效，当 node 出现 memory_presure 等时是无效的。</p>
</blockquote>
<h5 id="基础架构与应用团队的约束"><a href="#基础架构与应用团队的约束" class="headerlink" title="基础架构与应用团队的约束"></a>基础架构与应用团队的约束</h5><p>基础架构团队在移除一个节点时，应遵循如下流程：</p>
<ol>
<li><code>将node置为不可调度</code>kubectl cordon <node name="">`</node></li>
<li>执行 node drain 排空节点，将其上运行的Pod平滑迁移至其他节点 <code>kubectl drain &lt;node name&gt;</code></li>
</ol>
<p>应用开发人员针对敏感应用，可定义 PDB 来确保应用不会被意外中断</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> zk<span class="token punctuation">-</span>pdb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> zookeeper<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="测试-PodDisruptionBudget"><a href="#测试-PodDisruptionBudget" class="headerlink" title="测试 PodDisruptionBudget"></a>测试 PodDisruptionBudget</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module11/drain-node/drain.MD">https://github.com/kibaamor/101/blob/master/module11/drain-node/drain.MD</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/scheduling-eviction/api-eviction/">https://kubernetes.io/docs/concepts/scheduling-eviction/api-eviction/</a></p>
<p>部署文件</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pdb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试过程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl apply -f <span class="token builtin class-name">.</span>
deployment.apps/nginx-deployment created
poddisruptionbudget.policy/nginx-pdb created

$ kubectl get pdb
NAME        MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
nginx-pdb   <span class="token number">1</span>               N/A               <span class="token number">1</span>                     102s

$ kubectl scale deployment nginx-deployment --replicas <span class="token number">1</span>
deployment.apps/nginx-deployment scaled

$ kubectl get pdb
NAME        MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
nginx-pdb   <span class="token number">1</span>               N/A               <span class="token number">0</span>                     4m11s

$ kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-bf5d5cf98-54d9q   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16m

$ <span class="token function">cat</span> eviction.json
<span class="token punctuation">{</span>
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"policy/v1"</span>,
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Eviction"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"nginx-deployment-bf5d5cf98-54d9q"</span>,
    <span class="token string">"namespace"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

$ <span class="token function">curl</span> -H <span class="token string">'Content-type: application/json'</span> <span class="token punctuation">\</span>
  --cacert ~/.minikube/ca.crt <span class="token punctuation">\</span>
  --key ~/.minikube/profiles/minikube/client.key <span class="token punctuation">\</span>
  --cert ~/.minikube/profiles/minikube/client.crt <span class="token punctuation">\</span>
  https://127.0.0.1:32779/api/v1/namespaces/default/pods/nginx-deployment-bf5d5cf98-54d9q/eviction <span class="token punctuation">\</span>
  -d @eviction.json
<span class="token punctuation">{</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"Cannot evict pod as it would violate the pod's disruption budget."</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"TooManyRequests"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"causes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"DisruptionBudget"</span>,
        <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"The disruption budget nginx-pdb needs 1 healthy pods and has 1 currently"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">429</span>
<span class="token punctuation">}</span>

$ kubectl scale deployment nginx-deployment --replicas <span class="token number">2</span>
deployment.apps/nginx-deployment scaled

$ kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-bf5d5cf98-54d9q   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20m
nginx-deployment-bf5d5cf98-v4p9b   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104s

$ <span class="token function">curl</span> -H <span class="token string">'Content-type: application/json'</span> <span class="token punctuation">\</span>
  --cacert ~/.minikube/ca.crt <span class="token punctuation">\</span>
  --key ~/.minikube/profiles/minikube/client.key <span class="token punctuation">\</span>
  --cert ~/.minikube/profiles/minikube/client.crt <span class="token punctuation">\</span>
  https://127.0.0.1:32779/api/v1/namespaces/default/pods/nginx-deployment-bf5d5cf98-54d9q/eviction <span class="token punctuation">\</span>
  -d @eviction.json
<span class="token punctuation">{</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Success"</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">201</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h5><p>多少实例</p>
<p>更新策略</p>
<ul>
<li>Maxsurge</li>
<li>MaxUnavailable(需要考虑 ResourceQuota 的限制)</li>
</ul>
<p>深入理解 PodTemplateHash 导致的应用的易变性</p>
<h5 id="服务发布-1"><a href="#服务发布-1" class="headerlink" title="服务发布"></a>服务发布</h5><p>需要把服务发布至集群内部或者外部，服务的不同类型:</p>
<ul>
<li>Clusterlp(Headless)</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>ExternalName</li>
</ul>
<p>证书管理和七层负载均衡的需求</p>
<p>需要 RPC 负载均衡如何做?</p>
<p>DNS 需求</p>
<p>与上下游服务的关系</p>
<h5 id="服务发布的挑战-1"><a href="#服务发布的挑战-1" class="headerlink" title="服务发布的挑战"></a>服务发布的挑战</h5><p>kube-dns</p>
<ul>
<li>DNS TTL 问题</li>
</ul>
<p>Service</p>
<ul>
<li>ClusterlP 只能对内.</li>
<li>Kube-proxy 支持的 iptables/ipvs 规模有限.</li>
<li>IPVS 的性能和生产化问题。</li>
<li>kube-proxy 的 drift 问题</li>
<li>频繁的 Pod 变动(specchange，failover，crashLoop)导致LB 频繁变更</li>
<li>对外发布的 Service 需要与企业 ELB 即成。.</li>
<li>不支持 gRPC</li>
<li>不支持自定义 DNS 和高级路由功能</li>
</ul>
<p>Ingress</p>
<ul>
<li>Spec 要 deprecate</li>
</ul>
<p>其他可选方案?</p>
<h5 id="无状态应用管理"><a href="#无状态应用管理" class="headerlink" title="无状态应用管理"></a>无状态应用管理</h5><p>Replicaset 副本集</p>
<ul>
<li>用什么 Pod 模版创建多少个实例。</li>
<li><code>replicas:2</code></li>
</ul>
<p>Deployment</p>
<p>描述的是部署过程</p>
<p>版本管理</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">annotations.
  deployment.kubernetes.io/revision<span class="token punctuation">:</span><span class="token string">"1"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  revisionHistoryLimit<span class="token punctuation">:</span><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>滚动升级策略</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="有状态应用管理"><a href="#有状态应用管理" class="headerlink" title="有状态应用管理"></a>有状态应用管理</h5><p>Statefulset</p>
<p>与 deployment相比，多了</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ss<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Volume claim template</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> www
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="有状态应用-Operator"><a href="#有状态应用-Operator" class="headerlink" title="有状态应用 Operator"></a>有状态应用 Operator</h5><blockquote>
<p><code>Operator = CRD + Controller</code></p>
</blockquote>
<p>创建 Operator 的关键是 CRD (自定义资源)的设计</p>
<p>Kubernetes 对象是可扩展的，扩展的方式有</p>
<ul>
<li><p>基于原生对象</p>
<ul>
<li>生成 types 对象，并通过 client-go 生成相应的 clientset, lister, informer。</li>
<li>实现对象的 registery backend，即定义对象任何存储进 etcd。</li>
<li>注册对象的 scheme 至 apiserver。</li>
<li><p>创建该对象的 apiservice 生命，注册该对象所对应的 api handler。</p>
<p>基于原生对象往往需要通过 aggregation apiserver把不同对象组合起来，</p>
</li>
</ul>
</li>
<li><p>基于 CRD</p>
<ul>
<li>在不同应用业务环境下，对于平台可能有一些特殊的需求，这些需求可以抽象为 Kubernetes 的扩展资源，而 Kubernetes 的 CRD(CustomResourceDefinition) 为这样的需求提供了轻量级的机制，保证新的资源的快速注册和使用。</li>
<li>在更老的版本中，TPR(ThirdPartyResource)是与CRD类似的概念，但是在1.9以上的版本中被弃用而 CRD 则进入的 beta 状态。</li>
</ul>
</li>
</ul>
<h5 id="如何使用-CRD"><a href="#如何使用-CRD" class="headerlink" title="如何使用 CRD"></a>如何使用 CRD</h5><p>用户向 Kubernetes API 服务注册一个带特定 schema 的资源，并定义相关 API</p>
<ul>
<li>注册一系列该资源的实例</li>
<li>在 Kubernetes 的其它资源对象中引用这个新注册资源的对象实例</li>
<li>用户自定义的 controller 例程需要对这个引用进行释义和实施，让新的资源对象达到预期的状态</li>
</ul>
<h5 id="基于-CRD-的开发过程"><a href="#基于-CRD-的开发过程" class="headerlink" title="基于 CRD 的开发过程"></a>基于 CRD 的开发过程</h5><p>借助 Kubernetes RBAC和 authentication 机制来保证该扩展资源的 security、access control、authentication 和multitenancy.</p>
<p>将扩展资源的数据存储到 Kubernetes 的 etcd 集群。</p>
<p>借助 Kubernetes 提供的 controller 模式开发框架，实现新的 controller，并借助 APIServer 监听etcd 集群关于该资源的状态并定义状态变化的处理逻辑。</p>
<p>该功能可以让开发人员扩展添加新功能，更新现有的功能，并且可以自动执行一些管理任务，这些自定义的控制器就像 Kubernetes 原生的组件一样，Operator 直接使用 Kubernetes API 进行开发，也就是说他们可以根据这些控制器内部编写的自定义规则来监控集群、更改 Pods/Services、对正在运行的应用进行扩缩容。</p>
<h5 id="控制器模式"><a href="#控制器模式" class="headerlink" title="控制器模式"></a>控制器模式</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器的工作流程.png" alt="控制器的工作流程"></p>
<h5 id="控制器代码示例"><a href="#控制器代码示例" class="headerlink" title="控制器代码示例"></a>控制器代码示例</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/控制器代码示例.png" alt="控制器代码示例"></p>
<h5 id="安装-kubebuilder"><a href="#安装-kubebuilder" class="headerlink" title="安装 kubebuilder"></a>安装 kubebuilder</h5><p>下载至本地</p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubebuilder/releases">https://github.com/kubernetes-sigs/kubebuilder/releases</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> <span class="token operator">&lt;</span>your download binary<span class="token operator">&gt;</span> /usr/local/bin/kubebuilder<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="Kubebuilder"><a href="#Kubebuilder" class="headerlink" title="Kubebuilder"></a>Kubebuilder</h5><p>辅助生成 CRD</p>
<ul>
<li><code>kubebuilder init --domain example.com</code></li>
<li><code>kubebuilder create api --group infra --version v1 --kind WebService</code></li>
</ul>
<p>修改 Spec</p>
<p>Make install 更新 CRD 定义</p>
<h5 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h5><p>运行下面的命令创建项目</p>
<p><code>kubebuilderinit--domain myapps.cncamp.io</code></p>
<p>该命令生成如下文件</p>
<ul>
<li><code>go.mod</code>: 依赖管理</li>
<li><code>Makefile</code>: 编译文件</li>
<li><code>PROJECT</code>: Kubebuilder 为生成新组建的元数据配置</li>
</ul>
<h5 id="为项目添加新-API"><a href="#为项目添加新-API" class="headerlink" title="为项目添加新 API"></a>为项目添加新 API</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/为项目添加新API.png" alt="为项目添加新API"></p>
<h5 id="更新-CRD"><a href="#更新-CRD" class="headerlink" title="更新 CRD"></a>更新 CRD</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/更新CRD.png" alt="更新CRD"></p>
<h5 id="修改控制器代码并运行"><a href="#修改控制器代码并运行" class="headerlink" title="修改控制器代码并运行"></a>修改控制器代码并运行</h5><p>参考链接 <a target="_blank" rel="noopener" href="https://github.com/cncamp/httpclient">https://github.com/cncamp/httpclient</a></p>
<p>make run</p>
<p>创建 httpclient 对象</p>
<h5 id="kubebuilder-练习"><a href="#kubebuilder-练习" class="headerlink" title="kubebuilder 练习"></a>kubebuilder 练习</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/operator-demo">https://github.com/kibaamor/operator-demo</a></p>
<h4 id="有状态应用的复杂性讨论"><a href="#有状态应用的复杂性讨论" class="headerlink" title="有状态应用的复杂性讨论"></a>有状态应用的复杂性讨论</h4><h5 id="有状态应用部署示例-mysal"><a href="#有状态应用部署示例-mysal" class="headerlink" title="有状态应用部署示例-mysal"></a>有状态应用部署示例-mysal</h5><ol>
<li><p>高可用部署</p>
<p> 构建 Galara cluster，提供多活高可用 mysql集群。</p>
<p> 多实例跨集群/跨机架/跨主机</p>
</li>
<li><p>持久化存储</p>
<p> 需要为每个 Pod 创建 PVC 并 mount。</p>
<p> 读写性能保证</p>
<p> localdynamic 作为数据盘，cephfs 作为备份盘</p>
</li>
<li><p>有状态应用的复杂配置</p>
<p> 与无状态应用不一样，mysql 需要复杂配置以完成 galara 集群的构建</p>
<p> /etc/mysql/conf.d/galera.cnf</p>
</li>
</ol>
<h5 id="配置细节"><a href="#配置细节" class="headerlink" title="配置细节"></a>配置细节</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/MySql配置细节.png" alt="MySql配置细节"></p>
<h5 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h5><p>在 Primary Component 节点上运行</p>
<ul>
<li>mysqld bootstrap</li>
</ul>
<p>在其他节点上运行</p>
<ul>
<li>systemctl start mysgl</li>
</ul>
<p>发生了什么?</p>
<ul>
<li>当节点第一次启动时，会自动生成 UUID 以代表当前节点身份</li>
<li>启动后，garala 会在数据目录生成 gvwstate.dat 文件，该文件内容记录 Primary component 的 UUID 以及连接到当前Primary component 的节点的 UUID</li>
<li>如果 Primary component 出现故障，则剩余节点会重新选择新的 Primary component</li>
<li>若该文件已经存在，则无需额外执行 bootstrap 命令启动 Primarycompont，可依此规则编写 Operator 在多个节点构建此文件</li>
</ul>
<h5 id="健康检查-1"><a href="#健康检查-1" class="headerlink" title="健康检查"></a>健康检查</h5><p>mysql 提供健康检查 API</p>
<ul>
<li>检查集群成员是否能接受查询请求 <code>SHOW GLOBAL STATUS LIKE 'wsrep_ready';</code></li>
<li>检查节点是否与其他节点网络互通 <code>SHOW GLOBAL STATUS LIKE 'wsrep_connected';</code></li>
<li>检查节点自场次查询结束后接收到的查询请求数量，如果结果为非0，意味着写请求不能立即处理 <code>SHOW STATUS LIKE 'wsrep_local_recv_queue_avg';</code></li>
</ul>
<p>健康检査应该影响 Pod 的 readiness probe，在进行版本升级时，确保大多数集群节点状态一致。</p>
<h5 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h5><p>推荐为 mysql 创建不同类型的 volume</p>
<ul>
<li>Localvolume 用来做数据盘</li>
<li>Networkvolume 用来做数据备份</li>
</ul>
<p>创建 cronjob，每天将数据备份至 backup 目录</p>
<ul>
<li>备份文件为</li>
</ul>
<p>一键恢复能力</p>
<ul>
<li>导入备份目录的 sql file</li>
</ul>
<h5 id="版本发布和故障转移"><a href="#版本发布和故障转移" class="headerlink" title="版本发布和故障转移"></a>版本发布和故障转移</h5><p>针对配置了 Local disk 的 Pod，<strong>当发生因版本变更而引发的 Pod 重建时</strong> ，新 Pod 在进行调度时调度器会査询 Pod 挂载的 volume 所在节点，并将新 Pod 优先调度至该节点，此场景不涉及到数据恢复。</p>
<p>其开销与 mysql进程重启相差不大。</p>
<p><strong>如果节点出现故障，如硬件故障，Kubernetes 的 Evict Manager 会将该 Pod 从故障节点驱逐Operator 应确保新 Pod 会被重新构建。</strong> 而新 Pod 会被调度至新节点，此场景等价于替换 mysql 中的少数节点。</p>
<ul>
<li>galara 集群中的少数 mysql 节点替换，不涉及到数据迁移，qalara 会确保新节点的数据同步</li>
</ul>
<p><strong>若整个 mysql集群需要做数据恢复，则应该从 backup 目录对应的网络 volume 恢复数据。</strong>此时可选择:</p>
<ul>
<li>只恢复单一节点数据: 配置简单</li>
<li>恢复所有节点数据: 恢复速度快</li>
</ul>
<p>与基础架构的 Contract</p>
<ul>
<li>PodDisruptionBudget</li>
</ul>
<h5 id="业界高可用数据库方案分享"><a href="#业界高可用数据库方案分享" class="headerlink" title="业界高可用数据库方案分享"></a>业界高可用数据库方案分享</h5><p>参考链接: <a target="_blank" rel="noopener" href="https://cncamp.notion.site/mysql-on-kubernetes-eb043ee841dc41618ce4798bca187bbf">https://cncamp.notion.site/mysql-on-kubernetes-eb043ee841dc41618ce4798bca187bbf</a></p>
<h3 id="Spec-管理神器-Helm"><a href="#Spec-管理神器-Helm" class="headerlink" title="Spec 管理神器 - Helm"></a>Spec 管理神器 - Helm</h3><h4 id="什么是-Helm"><a href="#什么是-Helm" class="headerlink" title="什么是 Helm"></a>什么是 Helm</h4><p>Helm 特性</p>
<ul>
<li>Helm chart 是创建一个应用实例的必要的配置组，也就是一堆 Spec。</li>
<li>配置信息被归类为模版(Template)和值(Value)，这些信息经过渲染生成最终的对象。<br>= 所有配置可以被打包进一个可以发布的对象中。</li>
<li>-个 release 就是一个有特定配置的 chart 的实例。</li>
</ul>
<h4 id="Helm-的组件"><a href="#Helm-的组件" class="headerlink" title="Helm 的组件"></a>Helm 的组件</h4><p>Helm client</p>
<ul>
<li>本地 chart 开发</li>
<li>管理 repository</li>
<li>管理 release</li>
<li><p>与 helm library 交互</p>
<ul>
<li>发送需要安装的 chart</li>
<li>请求升级或着卸载存在的 release.</li>
</ul>
</li>
</ul>
<p>Helm library</p>
<ul>
<li>负责与 APIserver 交互，并提供以下功能<ul>
<li>基于 chart 和 confiquration 创建-个release</li>
<li>把 chart 安装进 kubernetes，并提供相应的 release 对象。</li>
<li>升级和卸载</li>
<li>Helm 采用 Kubernetes 存储所有配置信息，无需自己的数据库</li>
</ul>
</li>
</ul>
<h4 id="Kubernetes-Helm-架构"><a href="#Kubernetes-Helm-架构" class="headerlink" title="Kubernetes Helm 架构"></a>Kubernetes Helm 架构</h4><p>Helm 的目标</p>
<p>从头创建 chart</p>
<p>把 chart 打包成压缩文件(tgz)</p>
<p>与 chart 的存储仓库交互(chart repositry)</p>
<p>Kubernetes 集群中的 chart 安装与卸载</p>
<p>管理用 Helm 安装的 release 的生命周期</p>
<h4 id="Helm-的安装"><a href="#Helm-的安装" class="headerlink" title="Helm 的安装"></a>Helm 的安装</h4><p>下载</p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></p>
<p>安装</p>
<ul>
<li>解压</li>
<li><code>mv &lt;your downloaded binary&gt; /usr/local/bin/helm</code></li>
</ul>
<h4 id="Helm-chart-的基本使用"><a href="#Helm-chart-的基本使用" class="headerlink" title="Helm chart 的基本使用"></a>Helm chart 的基本使用</h4><p>创建一个 chart <code>helm create myapp</code></p>
<p>myapp/</p>
<ul>
<li>Chart.yaml  # 包含了 chart 信息的 YAML 文件</li>
<li>values.yaml # chart 默认的配置值</li>
<li>charts/     # 包含 chart 依赖的其他 chart</li>
<li>templates/  # 模板目录，当和 values 结合时，可生成有效的 Kubernetes manifest 文件</li>
</ul>
<h4 id="复用已存在的成熟-Helm-release"><a href="#复用已存在的成熟-Helm-release" class="headerlink" title="复用已存在的成熟 Helm release"></a>复用已存在的成熟 Helm release</h4><p>针对 Helm release repo 的操作</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm repo <span class="token function">add</span> grafana https://grafana.github.io/helm-charts
helm repo update
helm repo list
helm search repo grafana<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>从 remote repo 安装 Helm chart</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm upgrade --install loki grafana/loki-stack<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下载并从本地安装 helm chart</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm pull grafana/loki-stack
helm upgrade --install loki ./lock-stack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="metrics-server"><a href="#metrics-server" class="headerlink" title="metrics-server"></a>metrics-server</h3><h4 id="Aggregated-APIServer"><a href="#Aggregated-APIServer" class="headerlink" title="Aggregated APIServer"></a>Aggregated APIServer</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/AggregatedAPIServer.png" alt="AggregatedAPIServer"></p>
<h4 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics-Server"></a>Metrics-Server</h4><p><strong>metrics-server 是 Kubernetes 监控体系中的核心组件之一</strong>，它负责从 kubelet 收集资源指标然后对这些指标监控数据进行聚合(依赖kube-aggregator)，并在 Kubernetes Apiserver 中通过 Metrics API (/apis/metrics.k8s.io/) 公开暴露它们，但是 <strong>metrics-server 只存储最新的指标数据(CPU/Memory)</strong> 。</p>
<p>你的 kube-apiserver 要能访问到 metrics-server;</p>
<p>需要 kube-apiserver 启用聚合层;</p>
<p>组件要有认证配置并且绑定到 metrics-server;</p>
<p>Pod/Node 指标需要由 Summary API 通过 kubelet 公开。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/MetricsServer.png" alt="MetricsServer"></p>
<h4 id="metrics-server-的本质"><a href="#metrics-server-的本质" class="headerlink" title="metrics-server 的本质"></a>metrics-server 的本质</h4><p>将指标数据转换成 metrics.k8s.io 的 api 调用返回值</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get --raw <span class="token string">"/api/v1/nodes/node1/proxy/metrics/resource"</span>

$ kubectl <span class="token function">top</span> node
NAME    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>  CPU%    MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
node1   294m        <span class="token number">7</span>%      3003Mi          <span class="token number">25</span>%

$ kubectl <span class="token function">top</span> pod
NAME                                    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>  MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
centos-5fdd4bb694-bl62g                 3m          3Mi
httpserver-deployments-7df744646-jclhz  1m          5Mi
nginx-deployment-6799fc88d8-6pmrt       0m          5Mi
nginx-deployment-6799fc88d8-gv5f4       0m          5Mi
nginx-deployment-6799fc88d8-zkf9d       0m          5Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="自动扩容缩容-HPA"><a href="#自动扩容缩容-HPA" class="headerlink" title="自动扩容缩容-HPA"></a>自动扩容缩容-HPA</h3><h4 id="横向伸缩和纵向伸缩"><a href="#横向伸缩和纵向伸缩" class="headerlink" title="横向伸缩和纵向伸缩"></a>横向伸缩和纵向伸缩</h4><p>应用扩容是指在应用接收到的并发请求已经处于其处理请求极限边界的情形下，扩展处理能力而确保应用高可用的技术手段</p>
<p>Horizontal Scaling</p>
<ul>
<li>所谓横向伸缩是指通过增加应用实例数量分担负载的方式来提升应用整体处理能力的方式</li>
</ul>
<p>Vertical Scaling</p>
<ul>
<li>所谓纵向伸缩是指通过增加单个应用实例资源以提升单个实例处理能力，进而提升应用整体处理能力的方式</li>
</ul>
<h4 id="理解云原生的弹性能力"><a href="#理解云原生的弹性能力" class="headerlink" title="理解云原生的弹性能力"></a>理解云原生的弹性能力</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/理解云原生的弹性能力.png" alt="理解云原生的弹性能力"></p>
<h4 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h4><p>HPA(HorizontalPod Autoscaler) 是 Kubernetes 的一种资源对象，能够根据某些指标对在 statefulSet、replicaSet、deployment 等集合中的 Pod 数量进行横向动态伸缩，使运行在上面的服务对指标的变化有一定的自适应能力。</p>
<p>因节点计算资源固定，当 Pod 调度完成并运行以后，动态调整计算资源变得较为困难，因为横向扩展具有更大优势，HPA是扩展应用能力的第一选择，</p>
<p>多个冲突的 HPA 同时创建到同一个应用的时候会有无法预期的行为，因此需要小心维护 HPA 规则。</p>
<p>HPA 依赖于 Metrics-Server.</p>
<h4 id="HPA-Spec"><a href="#HPA-Spec" class="headerlink" title="HPA Spec"></a>HPA Spec</h4><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/tree/master/module11/hpa">https://github.com/kibaamor/101/tree/master/module11/hpa</a></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mynginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># HPA 的伸缩对象描述，HPA会动态修改该对象的 Pod 数量</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mynginx
  <span class="token comment"># HPA 的最小 Pod 数量和最大 Pod 数量</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token comment"># 监控的指标数组，支持多种类型的指标共存</span>
metrics<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="HPA-支持的指标类型"><a href="#HPA-支持的指标类型" class="headerlink" title="HPA 支持的指标类型"></a>HPA 支持的指标类型</h4><p>对于按 Pod 统计的资源指标(如 CPU)，控制器从资源指标API中获取每一个 <strong>HorizontalPodAutoscaler 指定的 Pod 的度量值</strong>，如果设置了目标使用率，控制器获取每个 Pod 中的容器资源使用情况，并计算资源使用率。如果设置了target值，将直接使用原始数据(不再计算百分比)。</p>
<p>如果 Pod 使用自定义指示，控制器机制与资源指标类似，区别在于自定义指标只使用原始值，而不是使用率。</p>
<p>如果 Pod 使用对象指标和外部指标(每个指标描述一个对象信息)。这个指标将直接根据目标设定值相比较，并生成一个上面提到的扩缩比例。 <strong>在 autoscaling/v2beta2 版本 API中，这个指标也可以根据 Pod 数量平分后再计算。</strong></p>
<h4 id="HPA-指标"><a href="#HPA-指标" class="headerlink" title="HPA 指标"></a>HPA 指标</h4><p>Resource 类型的指标（k8s自己支持的指标）</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
  <span class="token key atrule">resource</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
    <span class="token comment"># Utilization 类型的目标值，Resource 类型的指标只支持 Utilization 和 AverageValue 类型的目标值</span>
    <span class="token key atrule">target</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization
      <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Pods 类型的指标</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods
  <span class="token key atrule">pods</span><span class="token punctuation">:</span>
    <span class="token key atrule">metric</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> packets<span class="token punctuation">-</span>per<span class="token punctuation">-</span>second
    <span class="token comment"># AverageValue 类型的目标值，Pods 指标类型下只支持 AverageValue 类型的目标值</span>
    <span class="token key atrule">target</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
      <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 1k<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="算法细节"><a href="#算法细节" class="headerlink" title="算法细节"></a>算法细节</h4><p>HPA 算法非常简单</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">期望副本数 = ceil[当前副本数 * (当前指标 / 期望指标)]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当前度量值为 200m，目标设定值为 100m，那么由于 200.0/100.0-2.0，副本数量将会翻倍如果当前指标为 50m，副本数量将会减半，因为50.0/100.0=-0.5。如果计算出的扩缩比例接近1.0(根据 <code>--horizontal-pod-autoscaler-tolerance</code> 参数全局配置的容忍值，默认为 0.1)将会放弃本次扩缩。</p>
<h4 id="滚动升级时扩缩"><a href="#滚动升级时扩缩" class="headerlink" title="滚动升级时扩缩"></a>滚动升级时扩缩</h4><p>当你为一个 Deployment 配置自动扩缩时，你要为每个Deployment绑定一个 HorizontalPodAutoscaler.</p>
<p>HorizontalPodAutoscaler管理 Deployment 的 replicas 字段。Deployment Controller负责设置下层ReplicaSet的replicas 字段，以便确保在上线及后续过程副本个数合适。</p>
<p>想一想:为什么 deploymentspec 中的 replicas 字段的类型为 <code>*int</code>，而不是 int?</p>
<h4 id="冷却-延迟支持"><a href="#冷却-延迟支持" class="headerlink" title="冷却/延迟支持"></a>冷却/延迟支持</h4><p>当使用 HorizontalPod Autoscaler 管理一组副本扩缩时，有可能因为指标动态的变化造成副本数量频繁的变化，有时这被称为 <strong>抖动(Thrashing)</strong>。</p>
<p><code>--horizontal-pod-autoscaler-downscale-stabilization</code>:设置缩容冷却时间窗口长度。</p>
<p>水平 Pod 扩缩器能够记住过去建议的负载规模，并仅对此时间窗口内的最大规模执行操作。默认值是5分钟(5m0s)</p>
<h4 id="扩缩策略"><a href="#扩缩策略" class="headerlink" title="扩缩策略"></a>扩缩策略</h4><p>在 Spec 字段的 behavior 部分可以指定一个或多个扩缩策略。当指定多个策略时，默认选择允许更改最多的策略。下面的例子展示了缩容时的行为:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">behavior</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleDown</span><span class="token punctuation">:</span>
    <span class="token key atrule">policies</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">4</span>
      <span class="token key atrule">periodseconds</span><span class="token punctuation">:</span> <span class="token number">60</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Percent
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">periodseconds</span><span class="token punctuation">:</span> <span class="token number">60</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="HPA-练习"><a href="#HPA-练习" class="headerlink" title="HPA 练习"></a>HPA 练习</h4><p>安装 metrics-server(本质上是一个 aggregated Server)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> <span class="token number">101</span>/appsonk8s/hpa/metrics-server

$ kubectlapply-f components.yaml

$ kubectl <span class="token function">top</span> node
NAME    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>  CPU%    MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
k8snode 325m        <span class="token number">5</span>%      2148Mi          <span class="token number">18</span>%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="启动应用"><a href="#启动应用" class="headerlink" title="启动应用"></a>启动应用</h5><p>创建 php server</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token number">101</span>/appsonk8s/hpa
kubectl apply -f php-apache.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>设置 HPA 规则</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl autoscale deployment php-apache --cpu-percent<span class="token operator">=</span><span class="token number">50</span> --min<span class="token operator">=</span><span class="token number">1</span> --max<span class="token operator">=</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 HPASpec</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="测试-HPA"><a href="#测试-HPA" class="headerlink" title="测试 HPA"></a>测试 HPA</h5><p>为服务器加压</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl run -i --tty load-generator --rm --image<span class="token operator">=</span>busybox --restart<span class="token operator">=</span>Never -- /bin/sh -c <span class="token string">"while sleep 0.01; do wget -g -0- http://php-apache; done"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>观测 top pod，可以发现当 pod cpu 利用率大于 500m 的时候，会创建更多 pod 出来分担压力停止 load-generator 以后，等待一段时间，pod 数量会降为一个</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">watch</span> kubectl <span class="token function">top</span> pod
NAME                        CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>  MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 
load-generator              12m         1Mi
php-apache-6cd4b65f7b-4rwsq 240m        2Mi        
php-apache-6cd4b65f7b-p878h 488m1       2Mi        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="HPA-存在的问题"><a href="#HPA-存在的问题" class="headerlink" title="HPA 存在的问题"></a>HPA 存在的问题</h4><p>基于指标的弹性有滞后效应，因为弹性控制器操作的链路过长。</p>
<p>从应用负载超出阈值到 HPA 完成扩容之间的时间差包括:</p>
<ul>
<li>应用指标数据已经超出阈值;</li>
<li>HPA定期执行指标收集滞后效应;</li>
<li>HPA 控制 Deployment 进行扩容的时间</li>
<li>Pod 调度，运行时启动挂载存储和网络的时间;</li>
<li>应用启动到服务就绪的时间。</li>
</ul>
<p><strong>很可能在突发流量出现时，还没完成弹性扩容，既有的服务实例已经被流量击垮</strong></p>
<h3 id="自动扩容缩容-VPA"><a href="#自动扩容缩容-VPA" class="headerlink" title="自动扩容缩容-VPA"></a>自动扩容缩容-VPA</h3><h4 id="VPA"><a href="#VPA" class="headerlink" title="VPA"></a>VPA</h4><p><strong>VPA 全称 Vertical Pod Autoscaler，即垂直 Pod 自动扩缩容</strong> ，它根据容器资源使用率自动设置 CPU 和内存的 requests，从而允许在节点上进行适当的调度以便为每个 Pod 提供适当的资源，它既可以缩小过度请求资源的容器，也可以根据其使用情况随时提升资源不足的容量。</p>
<p>使用 VPA 的意义:</p>
<ul>
<li>Pod 资源用其所需，提升集群节点使用效率;</li>
<li>不必运行基准测试任务来确定 CPU 和内存请求的合适值;</li>
<li>VPA 可以随时调整 CPU 和内存请求，无需人为操作，因此可以减少维护时间，</li>
</ul>
<p>注意:VPA 目前还没有生产就绪，在使用之前需要了解资源调节对应用的影响。</p>
<h4 id="VPA-架构图"><a href="#VPA-架构图" class="headerlink" title="VPA 架构图"></a>VPA 架构图</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/VPA架构图.png" alt="VPA架构图"></p>
<h4 id="VPA-组件"><a href="#VPA-组件" class="headerlink" title="VPA 组件"></a>VPA 组件</h4><p>VPA 引入了一种新型的 AP|资源: <strong>VerticalPodAutoscaler</strong>。</p>
<p><strong>VPA Recommender</strong> 监视所有 Pod，不断为它们计算新的推荐资源，并将推荐值存储在 VPA对象中。它使用来自 Metrics-Server的集群中所有 Pod 的利用率和 OOM 事件。</p>
<p>所有 Pod 创建请求都通过 <strong>VPA Admission Controller</strong>。</p>
<p><strong>VPA Updater</strong> 是负责 Pod 实时更新的组件。如果 Pod 在 “Auto” 模式下使用 VPA，则 Updater 可以决定使用推荐器资源对其进行更新。</p>
<p><strong>History Storage</strong> 是一个存储组件(如Prometheus)，它使用来自 APIServer 的利用率信息和 OOM(与推荐器相同的数据)并将其持久存储。</p>
<p>VPA 更新模式:</p>
<ul>
<li>Off</li>
<li>Auto</li>
</ul>
<h4 id="VPA-工作原理"><a href="#VPA-工作原理" class="headerlink" title="VPA 工作原理"></a>VPA 工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/VPA工作原理.png" alt="VPA工作原理"></p>
<h4 id="Recommender-设计理念"><a href="#Recommender-设计理念" class="headerlink" title="Recommender 设计理念"></a>Recommender 设计理念</h4><p><strong>推荐模型(MVP)假设内存和 CPU 利用率是独立的随机变量，其分布等于过去 N 天观察到的变量(推荐值为 N=8 以捕获每周峰值)。</strong></p>
<ul>
<li><p>对于 CPU，目标是将容器使用率超过请求的高百分比(例如95%)时的时间部分保持在某个阈值(例如 1% 的时间)以下。在此模型中，”CPU 使用率” 被定义为在短时间间隔内测量的平均使用率。测量间隔越短，针对尖峰、延迟敏感的工作负载的建议质量就越高。最小合理分辨率为 1/min，推荐为 1/sec。</p>
</li>
<li><p>对于内存，目标是将特定时间窗口内容器使用率超过请求的概率保持在某个值以下(例如24 小时内低于 1%)。窗口必须很长(&gt;24 小时)以确保由 OOM 引起的驱逐不会明显影响(a)服务应用程序的可用性(b)批处理计算的进度(更高级的模型可以允许用户指定SLO来控制它)。</p>
</li>
</ul>
<h4 id="主要流程"><a href="#主要流程" class="headerlink" title="主要流程"></a>主要流程</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/VPA主要流程.png" alt="VPA主要流程"></p>
<h4 id="滑动窗口与半衰指数直方图"><a href="#滑动窗口与半衰指数直方图" class="headerlink" title="滑动窗口与半衰指数直方图"></a>滑动窗口与半衰指数直方图</h4><p>Recommender 的资源推荐算法主要受 Google AutoPilot moving window 推荐器的启发，<strong>假设 CPU 和 Memory 消耗是独立的随机变量，其分布等于过去 N 天观察到的变量分布(推荐值为 N=8 以捕获每周业务容器峰值)。</strong></p>
<p>Recommender 组件获取资源消耗实时数据，存到相应资源对象 CheckPoint 中。CheckPoint CRD 资源本质上是一个直方图</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/滑动窗口与半衰指数直方图.png" alt="滑动窗口与半衰指数直方图"></p>
<h4 id="直方图统一对外提供的接口"><a href="#直方图统一对外提供的接口" class="headerlink" title="直方图统一对外提供的接口"></a>直方图统一对外提供的接口</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/直方图统一对外提供的接口.png" alt="直方图统一对外提供的接口"></p>
<h4 id="直方图数据范围"><a href="#直方图数据范围" class="headerlink" title="直方图数据范围"></a>直方图数据范围</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/直方图数据范围.png" alt="直方图数据范围"></p>
<h4 id="半衰期和权重系数"><a href="#半衰期和权重系数" class="headerlink" title="半衰期和权重系数"></a>半衰期和权重系数</h4><p>为每个样本数据权重乘上 <code>指数2^((sampleTime-referenceTimestamp)/halfLife)</code>，以保证较新的样本被赋予更高的权重，而较老的样本随时间推移权重逐步衰减</p>
<p>默认情况下，<strong>每 24h 为一个半衰期</strong>，即每经过 24h，直方图中所有样本的权重(重要性)衰减为原来的一半。</p>
<p>当指数过大时，referenceTimestamp 就需要向前调整，以避免浮点乘法计算时向上溢出，</p>
<ul>
<li>CPU 使用量样本对应的权重是基于容器 CPUrequest 值确定的。当 CPUrequest 增加时对应的权重也随之增加。</li>
<li>而 Memory 使用量样本对应的权重固定为 1.0。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module11/vpa/readme.MD">https://github.com/kibaamor/101/blob/master/module11/vpa/readme.MD</a></p>
<h4 id="VPA-1"><a href="#VPA-1" class="headerlink" title="VPA"></a>VPA</h4><p>VPA 的成熟度还不足</p>
<ul>
<li>更新正在运行的 Pod 资源配置是 VPA的一项试验性功能，会导致 Pod 的重建和重启，而且有可能被调度到其他的节点上。</li>
<li>VPA 不会驱逐没有在副本控制器管理下的 Pod。<strong>目前对于这类 Pod，Auto 模式等同于 Initial 模式。</strong></li>
<li>目前 VPA 不能和监控 CPU 和内存度量的 <strong>Horizontal Pod Autoscaler(HPA)</strong> 同时运行除非 HPA 只监控其他定制化的或者外部的资源度量。</li>
<li>VPA 使用 admission webhook 作为其准入控制器。如果集群中有其他的 admissionwebhook，需要确保它们不会与VPA发生冲突。准入控制器的执行顺序定义在 APIServer的配置参数中。</li>
<li>VPA 会处理出现的绝大多数 OOM(Out Of Memory)的事件，但不保证所有的场景下都有效。</li>
<li>VPA的性能还没有在大型集群中测试过。</li>
<li>VPA 对 Pod 资源 requests 的修改值可能超过实际的资源上限，例如节点资源上限、空闲资源或资源配额，从而造成 Pod 处于 Pending 状态无法被调度。同时使用集群自动伸缩(ClusterAutoscaler)可以一定程度上解决这个问题。</li>
<li>多个 VPA 同时匹配同一个 Pod 会造成未定义的行为。</li>
</ul>
<h3 id="如何解决社区基础弹性能力不足的问题"><a href="#如何解决社区基础弹性能力不足的问题" class="headerlink" title="如何解决社区基础弹性能力不足的问题"></a>如何解决社区基础弹性能力不足的问题</h3><h4 id="弹性的意义"><a href="#弹性的意义" class="headerlink" title="弹性的意义"></a>弹性的意义</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/弹性的意义.png" alt="弹性的意义"></p>
<h4 id="成本优化的关键路径"><a href="#成本优化的关键路径" class="headerlink" title="成本优化的关键路径"></a>成本优化的关键路径</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/成本优化的关键路径.png" alt="成本优化的关键路径"></p>
<h4 id="开启降本之路"><a href="#开启降本之路" class="headerlink" title="开启降本之路"></a>开启降本之路</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/开启降本之路.png" alt="开启降本之路"></p>
<h4 id="统一思想-FinOps"><a href="#统一思想-FinOps" class="headerlink" title="统一思想 - FinOps"></a>统一思想 - FinOps</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/FinOps.png" alt="FinOps"></p>
<h4 id="流程建设-云原生成熟度模型"><a href="#流程建设-云原生成熟度模型" class="headerlink" title="流程建设-云原生成熟度模型"></a>流程建设-云原生成熟度模型</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云原生成熟度模型.png" alt="云原生成熟度模型"></p>
<h4 id="业务侧-Workload-评分"><a href="#业务侧-Workload-评分" class="headerlink" title="业务侧 Workload 评分"></a>业务侧 Workload 评分</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/业务侧Workload评分.png" alt="业务侧Workload评分"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/业务侧Workload评分辅助指标.png" alt="业务侧Workload评分辅助指标"></p>
<h4 id="平台集群评分"><a href="#平台集群评分" class="headerlink" title="平台集群评分"></a>平台集群评分</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/平台集群评分.png" alt="平台集群评分"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/平台集群评分辅助指标.png" alt="平台集群评分辅助指标"></p>
<h4 id="成熟度指标计算公式"><a href="#成熟度指标计算公式" class="headerlink" title="成熟度指标计算公式"></a>成熟度指标计算公式</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/成熟度指标计算公式.png" alt="成熟度指标计算公式"></p>
<h4 id="驱动力"><a href="#驱动力" class="headerlink" title="驱动力"></a>驱动力</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/驱动力.png" alt="驱动力"></p>
<h4 id="云成熟度模型成效"><a href="#云成熟度模型成效" class="headerlink" title="云成熟度模型成效"></a>云成熟度模型成效</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云成熟度模型成效.png" alt="云成熟度模型成效"></p>
<h4 id="Crane-工具链打通"><a href="#Crane-工具链打通" class="headerlink" title="Crane-工具链打通"></a>Crane-工具链打通</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Crane.png" alt="Crane"></p>
<h4 id="Crane-高层架构"><a href="#Crane-高层架构" class="headerlink" title="Crane 高层架构"></a>Crane 高层架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Crane高层架构.png" alt="Crane高层架构"></p>
<h4 id="资源预测"><a href="#资源预测" class="headerlink" title="资源预测"></a>资源预测</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/资源预测.png" alt="资源预测"></p>
<h4 id="多维的成本展示"><a href="#多维的成本展示" class="headerlink" title="多维的成本展示"></a>多维的成本展示</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多维的成本展示.png" alt="多维的成本展示"></p>
<h4 id="精准的浪费识别"><a href="#精准的浪费识别" class="headerlink" title="精准的浪费识别"></a>精准的浪费识别</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/精准的浪费识别.png" alt="精准的浪费识别"></p>
<h4 id="常规优化手段"><a href="#常规优化手段" class="headerlink" title="常规优化手段"></a>常规优化手段</h4><p>弹性</p>
<ul>
<li><p>按作业负载动态调节实例副本数或单实例的资源上</p>
<ul>
<li>负载高峰扩容以保证业务服务等级</li>
<li>负载低谷缩容以回收资源减少浪费</li>
</ul>
</li>
</ul>
<p>混部</p>
<ul>
<li><p>在负载低谷运行离线作业以提升总体资源利用率</p>
</li>
<li><p>TKE-Scheduler 专为离线场景优化:gang-scheduling、all-or-nothing，10X性能提升</p>
</li>
</ul>
<h4 id="社区原生弹性能力的不足"><a href="#社区原生弹性能力的不足" class="headerlink" title="社区原生弹性能力的不足"></a>社区原生弹性能力的不足</h4><p>HPA</p>
<ul>
<li>业务指标驱动，指标的滞后导致业务突发流量时来不及弹。</li>
</ul>
<p>VPA</p>
<ul>
<li>资源需求是 Pod 对象中的不可变属性，VPA纵向调整资源后，Pod 需要重建，而现实场景中，Pod 重建是大量业务不可接受的。</li>
</ul>
<p>CA</p>
<ul>
<li>当集群资源不足时，CA 可按照既定规则扩容集群节点，但这对基础架构层面的空闲资源和可靠性都有极高的要求。</li>
</ul>
<h4 id="AHPA-基于预测的横向伸缩"><a href="#AHPA-基于预测的横向伸缩" class="headerlink" title="AHPA-基于预测的横向伸缩"></a>AHPA-基于预测的横向伸缩</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于预测的横向伸缩.png" alt="基于预测的横向伸缩"></p>
<h4 id="IVPA-基于扩展资源回收的实时纵向仲缩"><a href="#IVPA-基于扩展资源回收的实时纵向仲缩" class="headerlink" title="IVPA-基于扩展资源回收的实时纵向仲缩"></a>IVPA-基于扩展资源回收的实时纵向仲缩</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于扩展资源回收的实时纵向仲缩.png" alt="基于扩展资源回收的实时纵向仲缩"></p>
<h4 id="基于分布式云虚拟节点技术的集群弹性"><a href="#基于分布式云虚拟节点技术的集群弹性" class="headerlink" title="基于分布式云虚拟节点技术的集群弹性"></a>基于分布式云虚拟节点技术的集群弹性</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于分布式云虚拟节点技术的集群弹性.png" alt="基于分布式云虚拟节点技术的集群弹性"></p>
<h4 id="服务质量保证-安心拉升资源利用率的秘密"><a href="#服务质量保证-安心拉升资源利用率的秘密" class="headerlink" title="服务质量保证-安心拉升资源利用率的秘密"></a>服务质量保证-安心拉升资源利用率的秘密</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/安心拉升资源利用率的秘密.png" alt="安心拉升资源利用率的秘密"></p>
<h4 id="资源隔离-OS-隔离-ROSM-框架"><a href="#资源隔离-OS-隔离-ROSM-框架" class="headerlink" title="资源隔离-OS 隔离-ROSM 框架"></a>资源隔离-OS 隔离-ROSM 框架</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ROSM框架.png" alt="ROSM框架"></p>
<h2 id="基于-Istio-的高级流量管理"><a href="#基于-Istio-的高级流量管理" class="headerlink" title="基于 Istio 的高级流量管理"></a>基于 Istio 的高级流量管理</h2><h3 id="微服务架构的演变"><a href="#微服务架构的演变" class="headerlink" title="微服务架构的演变"></a>微服务架构的演变</h3><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/单体架构.png" alt="单体架构"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/微服务架构.png" alt="微服务架构"></p>
<h4 id="从单体系统到微服务系统的演进"><a href="#从单体系统到微服务系统的演进" class="headerlink" title="从单体系统到微服务系统的演进"></a>从单体系统到微服务系统的演进</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/从单体系统到微服务系统的演进.png" alt="从单体系统到微服务系统的演进"></p>
<h4 id="微服务架构的演进"><a href="#微服务架构的演进" class="headerlink" title="微服务架构的演进"></a>微服务架构的演进</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/微服务架构的演进.png" alt="微服务架构的演进"></p>
<h4 id="典型的微服务业务场景"><a href="#典型的微服务业务场景" class="headerlink" title="典型的微服务业务场景"></a>典型的微服务业务场景</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/典型的微服务业务场景.png" alt="典型的微服务业务场景"></p>
<blockquote>
<p>CB: circuit breaker，熔断器。CB 一般在客户端做。</p>
<p>SD: Service Discovery，服务发现。</p>
<p>LD: Load balance，负载均衡。</p>
<p>AU：Authentication，认证。</p>
</blockquote>
<h4 id="更完整的微服务架构"><a href="#更完整的微服务架构" class="headerlink" title="更完整的微服务架构"></a>更完整的微服务架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/更完整的微服务架构.png" alt="更完整的微服务架构"></p>
<h4 id="系统边界"><a href="#系统边界" class="headerlink" title="系统边界"></a>系统边界</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/系统边界.png" alt="系统边界"></p>
<p>让业务只关心业务，CB、SD、LD、AU 交给平台。</p>
<h3 id="微服务到服务网格还缺什么"><a href="#微服务到服务网格还缺什么" class="headerlink" title="微服务到服务网格还缺什么?"></a>微服务到服务网格还缺什么?</h3><h4 id="Sidecar-的工作原理"><a href="#Sidecar-的工作原理" class="headerlink" title="Sidecar 的工作原理"></a>Sidecar 的工作原理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Sidecar的工作原理.png" alt="Sidecar的工作原理"></p>
<h4 id="Service-Mesh"><a href="#Service-Mesh" class="headerlink" title="Service Mesh"></a>Service Mesh</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ServiceMesh.png" alt="ServiceMesh"></p>
<p>适应性</p>
<ul>
<li>熔断</li>
<li>重试</li>
<li>超时处理失败处理负载均衡</li>
<li>Failover</li>
</ul>
<p>服务发现</p>
<ul>
<li>路由</li>
</ul>
<p>安全和访问控制</p>
<ul>
<li>TLS 和证书管理</li>
</ul>
<p>可观察性</p>
<ul>
<li>Metrics</li>
<li>监控</li>
<li>分布式日志</li>
<li>分布式 tracing</li>
</ul>
<p>部署</p>
<ul>
<li>容器</li>
</ul>
<p>通讯</p>
<ul>
<li>HTTP</li>
<li>WS</li>
<li>gRPC</li>
<li>TCP</li>
</ul>
<h4 id="微服务的优劣"><a href="#微服务的优劣" class="headerlink" title="微服务的优劣"></a>微服务的优劣</h4><p>优势</p>
<ul>
<li><p>将基础架构逻辑从业务代码中剥离出来</p>
<ul>
<li>分布式 tracing</li>
<li>日志</li>
</ul>
</li>
<li><p>自由选择技术栈</p>
</li>
<li><p>帮助业务开发部门只关注业务逻辑</p>
</li>
</ul>
<p>劣势</p>
<ul>
<li><p>复杂</p>
<ul>
<li>更多的运行实例</li>
</ul>
</li>
<li><p>可能带来额外的网络跳转</p>
<ul>
<li>每个服务调用都要经过 Sidecar</li>
</ul>
</li>
<li><p>解决了一部分问题，同时要付出代价</p>
</li>
<li><p>依然要处理复杂路由，类型映射，与外部系统整合等方面问题</p>
</li>
<li><p>不解决业务逻辑或服务整合，服务组合等问题</p>
</li>
</ul>
<h4 id="服务网格可选方案"><a href="#服务网格可选方案" class="headerlink" title="服务网格可选方案"></a>服务网格可选方案</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/服务网格可选方案.png" alt="服务网格可选方案"></p>
<h4 id="什么是服务网格"><a href="#什么是服务网格" class="headerlink" title="什么是服务网格"></a>什么是服务网格</h4><p><strong>服务网格(Service Mesh)这个术语通常用于描述构成这些应用程序的微服务网络以及应用之间的交互。</strong> 随着规模和复杂性的增长，服务网格越来越难以理解和管理。</p>
<p>它的需求包括服务发现、负载均衡、故障恢复、指标收集和监控以及通常更加复杂的运维需求例如 A/B 测试、金丝雀发布、限流、访问控制和端到端认证等。</p>
<h4 id="为什么要使用-Istio"><a href="#为什么要使用-Istio" class="headerlink" title="为什么要使用 Istio"></a>为什么要使用 Istio</h4><p>HTTP、gRPC、WebSocket 和 TCP 流量的自动负载均衡。</p>
<p>通过丰富的路由规则、重试、故障转移和故障注入，可以对流量行为进行细粒度控制。</p>
<p>可插入的策略层和配置 API，支持访问控制、速率限制和配额。</p>
<p>对出入集群入口和出口中所有流量的自动度量指标、日志记录和跟踪。</p>
<p>通过强大的基于身份的验证和授权，在集群中实现安全的服务间通信。</p>
<h4 id="Istio-功能概览"><a href="#Istio-功能概览" class="headerlink" title="Istio 功能概览"></a>Istio 功能概览</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Istio功能概览.png" alt="Istio功能概览"></p>
<h4 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h4><p>连接</p>
<ul>
<li>通过简单的规则配置和流量路由，可以控制服务之间的流量和 API调用。lstio 简化了断路器超时和重试等服务级别属性的配置，并且可以轻松设置 A/B 测试、金丝雀部署和基于百分比的流量分割的分阶段部署等重要任务。</li>
</ul>
<p>控制</p>
<ul>
<li>通过更好地了解流量和开箱即用的故障恢复功能，可以在问题出现之前先发现问题，使调用更可靠，并且使您的网络更加强大—无论您面临什么条件。</li>
</ul>
<h4 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h4><p><strong>使开发人员可以专注于应用程序级别的安全性。</strong> Istio 提供底层安全通信信道，并大规管理服务通信的认证、授权和加密。使用Istio，服务通信在默认情况下是安全的，它允许跨多种协议和运行时一致地实施策略——所有这些都很少或根本不需要应用程序更改。</p>
<p>虽然 Istio 与平台无关，但将其与 Kubernetes(或基础架构)网络策略结合使用，其优势会更大，包括在网络和应用层保护 Pod 间或服务间通信的能力。</p>
<h4 id="可观察性"><a href="#可观察性" class="headerlink" title="可观察性"></a>可观察性</h4><p>Istio 生成以下类型的遥测数据，以提供对整个服务网格的可观察性:</p>
<ul>
<li>指标: Istio 基于4个监控的黄金标识(延迟、流量、错误、饱和)生成了一系列服务指标。Istio 还为网格控制平面提供了更详细的指标。除此以外还提供了一组默认的基于这些指标的网格监控仪表板。</li>
<li>分布式追踪: Istio 为每个服务生成分布式追踪span，运维人员可以理解网格内服务的依赖和调用流程。</li>
<li>访问日志: 当流量流入网格中的服务时，Istio 可以生成每个请求的完整记录，包括源和目标的元数据。此信息使运维人员能够将服务行为的审查控制到单个工作负载实例的级别。</li>
</ul>
<p>所有这些功能可以更有效地设置、监控和实施服务上的 SLO，快速有效地检测和修复问题</p>
<h4 id="Istio-架构演进"><a href="#Istio-架构演进" class="headerlink" title="Istio 架构演进"></a>Istio 架构演进</h4><p>数据平面</p>
<ul>
<li>由一组以 Sidecar 方式部署的智能代理(Envoy)组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li>
</ul>
<p>控制平面</p>
<p>负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</p>
<p>架构演进</p>
<ul>
<li>从微服务回归单体。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Istio架构演进.png" alt="Istio架构演进"></p>
<h4 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h4><p>最大化透明度</p>
<ul>
<li>Istio 将自身自动注入到服务间所有的网络路径中，运维和开发人员只需付出很少的代价就可以从中受益</li>
<li>Istio 使用 Sidecar 代理来捕获流量，并且在尽可能的地方自动编程网络层，以路由流量通过这些代理而无需对已部署的应用程序代码进行任何改动。</li>
<li>在 Kubernetes 中，代理被注入到 Pod 中，通过编写 iptables 规则来捕获流量。注入 Sidecar 代理到Pod 中并且修改路由规则后，Istio 就能够调解所有流量。</li>
<li>所有组件和 API 在设计时都必须考虑性能和规模。</li>
</ul>
<p>增量</p>
<ul>
<li>预计最大的需求是扩展策略系统，集成其他策略和控制来源，并将网格行为信号传播到其他系统进行分析策略运行时支持标准扩展机制以便插入到其他服务中。</li>
</ul>
<p>可移植性</p>
<ul>
<li>将基于 Istio 的服务移植到新环境应该是轻而易举的，而使用 Istio 将一个服务同时部署到多个环境中也是可行的(例如，在多个云上进行几余部署)。</li>
</ul>
<p>策略一致性</p>
<ul>
<li>在服务间的 API 调用中，策略的应用使得可以对网格间行为进行全面的控制，但对于无需在 API 级别表达的资源来说，对资源应用策略也同样重要，</li>
<li>因此，策略系统作为独特的服务来维护，具有自己的 API，而不是将其放到代理 /sidecar 中，这容许服务根据需要直接与其集成。</li>
</ul>
<h3 id="深入理解数据平面-Envoy"><a href="#深入理解数据平面-Envoy" class="headerlink" title="深入理解数据平面 Envoy"></a>深入理解数据平面 Envoy</h3><h4 id="主流七层代理的比较"><a href="#主流七层代理的比较" class="headerlink" title="主流七层代理的比较"></a>主流七层代理的比较</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/主流七层代理的比较.png" alt="主流七层代理的比较"></p>
<blockquote>
<p>Connection draining：进程重启时，容许一定的时间等待正在的处理的网络链接请求被处理完成后再退出进程。</p>
</blockquote>
<h4 id="Envoy-的优势"><a href="#Envoy-的优势" class="headerlink" title="Envoy 的优势"></a>Envoy 的优势</h4><p>性能:</p>
<ul>
<li>在具备大量特性的同时，Envoy 提供极高的吞吐量和低尾部延迟差异，而 CPU 和 RAM 消耗却相对较少。</li>
</ul>
<p>可扩展性:</p>
<ul>
<li>Envoy 在 L4 和 L7 都提供了丰富的可插拔过滤器能力，使用户可以轻松添加 开源版本中没有的功能。</li>
</ul>
<p>API 可配置性:</p>
<ul>
<li>Envoy提供了一组可以通过控制平面服务实现的管理 API。如果控制平面实现所有的 API，则可以使用通用引导配置在整个基础架构上运行 Envoy。所有进一步的配置更改通过管理服务器以无缝方式动态传送，因此 Envoy 从不需要重新启动。这使得 Envoy 成为通用数据平面当它与一个足够复杂的控制平面相结合时，会极大的降低整体运维的复杂性。</li>
</ul>
<h4 id="Envoy-线程模式"><a href="#Envoy-线程模式" class="headerlink" title="Envoy 线程模式"></a>Envoy 线程模式</h4><p>Envoy 采用单进程多线程模式:</p>
<ul>
<li>主线程负责协调;</li>
<li>子线程负责监听过滤和转发</li>
</ul>
<p>当某连接被监听器接受，那么该连接的全部生命周期会与某线程绑定。</p>
<p>Envoy基于非阻塞模式(Epoll)。</p>
<p>建议 Envoy 配置的 worker 数量与 Envoy 所在的硬件线程数一致。</p>
<h4 id="Envoy-架构"><a href="#Envoy-架构" class="headerlink" title="Envoy 架构"></a>Envoy 架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Envoy架构.png" alt="Envoy架构"></p>
<h4 id="V1-API-的缺点和-v2-的引入"><a href="#V1-API-的缺点和-v2-的引入" class="headerlink" title="V1 API 的缺点和 v2 的引入"></a>V1 API 的缺点和 v2 的引入</h4><p><strong>V1 API 仅使用 JSON/REST，本质上是轮询。</strong> 这有几个缺点:</p>
<ul>
<li>尽管 Envoy 在内部使用的是 JSON 模式，但 API 本身并不是强类型，而且安全实现它们的通用服务器也很难。</li>
<li>虽然轮询工作在实践中是很正常的用法，但更强大的控制平面更喜欢 streaming API，当其就绪后，可以将更新推送给每个 Envoy。这可以将更新传播时间从 30-60 秒降低到 250-500 毫秒，即使在极其庞大的部署中也是如此。</li>
</ul>
<p>v2 API 具有以下属性:</p>
<ul>
<li>新的 API 模式使用 proto3 指定，并同时以 gRPC 和 REST+JSON/YAML 端点实现。</li>
<li>它们被定义在一个名为 envoy-api 的新的专用源代码仓库中。proto3 的使用意味着这些 API 是强类型的，同时仍然通过 proto3 的 JSON/YAML 表示来支持 JSON/YAML 变体。</li>
<li>专用存储仓库的使用意味着项目可以更容易的使用 API 并用 gRPC 支持的所有语言生成存根 <strong>(实际上，对于希望使用它的用户，我们将继续支持基于 REST 的 JSON/YAML 变体)</strong> 。</li>
</ul>
<h4 id="xDS-Envoy-的发现机制"><a href="#xDS-Envoy-的发现机制" class="headerlink" title="xDS-Envoy 的发现机制"></a>xDS-Envoy 的发现机制</h4><p>Endpoint Discovery Service (EDS):</p>
<ul>
<li>这是V1 SDS API的替代品。此外，gRPC的双向流性质将允许将负载/健康信息报告回管理服务器，为将来的全局负载均衡功能开启大门。</li>
</ul>
<p>Cluster Discovery Service (CDS):</p>
<ul>
<li>和 v1 没有实质性变化。</li>
</ul>
<p>Route Discovery Service (RDS):</p>
<ul>
<li>和 v1 没有实质性变化。</li>
</ul>
<p>Listener Discovery Service (LDS):</p>
<ul>
<li>和 v1 的唯一主要变化是: 现在允许监听器定义多个并发过滤栈，这些过滤栈可以基于一组监听器路由规则(例如，SNI，源/目的地 IP 匹配等)来选择。这是处理”原始目的地”策略路由的更简洁的方式，这种路由是透明数据平面解决方案(如Istio)所需要的。</li>
</ul>
<p>Secret Discovery Service (SDS):</p>
<ul>
<li>一个专用的 API 来传递 TLS 密钥材料。这将解耦通过 LDS/CDS 发送主要监听器、集群配置和通过专用密钥管理系统发送秘钥素材。</li>
</ul>
<p>Health Discovery Service (HDS):</p>
<ul>
<li>该 API 将允许 Envoy 成为分布式健康检查网络的成员。中央健康检查服务可以使用一组 Envoy 作为健康检查终点并将状态报告回来，从而缓解 N^2 健康检查问题，这个问题指的是其间的每个 Envoy都可能需要对每个其他 Envoy 进行健康检查。</li>
</ul>
<p>Aggregated Discovery Service(ADS):</p>
<ul>
<li>总的来说，Envoy 的设计是最终一致的。这意味着默认情况下，每个管理 API 都并发运行并且不会相互交互。在某些情况下，一次一个管理服务器处理单个 Envoy 的所有更新是有益的(例如，如果需要对更新进行排序以避免流量下降)。此API允许通过单个管理服务器的单个 gRPC 双向流对所有其他 API 进行编组，从而实现确定性排序。</li>
</ul>
<h4 id="Envoy-的过滤器模式"><a href="#Envoy-的过滤器模式" class="headerlink" title="Envoy 的过滤器模式"></a>Envoy 的过滤器模式</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Envoy的过滤器模式.png" alt="Envoy的过滤器模式"></p>
<h4 id="Envoy-实验"><a href="#Envoy-实验" class="headerlink" title="Envoy 实验"></a>Envoy 实验</h4><p><a target="_blank" rel="noopener" href="https://cncamp.notion.site/Envoy-Doc-notes-4f1d50edbd414c78a2943239dd5f5d0d">Envoy Doc notes</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># simple 的配置</span>
$ <span class="token function">cat</span> simple.yaml -p
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simple
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: simple
  template:
    metadata:
      annotations:
        prometheus.io/scrape: <span class="token string">"true"</span>
        prometheus.io/port: <span class="token string">"80"</span>
      labels:
        app: simple
    spec:
      containers:
        - name: simple
          imagePullPolicy: Always
          image: cncamp/httpserver:v1.0-metrics
          ports:
            - containerPort: <span class="token number">80</span>
---
apiVersion: v1
kind: Service
metadata:
  name: simple
spec:
  ports:
    - name: http
      port: <span class="token number">80</span>
      protocol: TCP
      targetPort: <span class="token number">80</span>
  selector:
    app: simple

<span class="token comment"># 创建 simple</span>
$ kubectl apply -f ./simple.yaml
deployment.apps/simple created
service/simple created

$ kubectl get svc simple
NAME     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
simple   ClusterIP   <span class="token number">10.108</span>.197.81   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    15m

$ <span class="token function">curl</span> <span class="token number">10.108</span>.197.81/hello
hello <span class="token punctuation">[</span>stranger<span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>Details of the http request header:<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
User-Agent<span class="token operator">=</span><span class="token punctuation">[</span>curl/7.81.0<span class="token punctuation">]</span>
<span class="token assign-left variable">Accept</span><span class="token operator">=</span><span class="token punctuation">[</span>*/*<span class="token punctuation">]</span>

<span class="token comment"># envoy的配置</span>
$ <span class="token function">cat</span> envoy.yaml
admin:
  address:
    socket_address: <span class="token punctuation">{</span> address: <span class="token number">127.0</span>.0.1, port_value: <span class="token number">9901</span> <span class="token punctuation">}</span>

static_resources:
  listeners:
    - name: listener_0
      address:
        socket_address: <span class="token punctuation">{</span> address: <span class="token number">0.0</span>.0.0, port_value: <span class="token number">10000</span> <span class="token punctuation">}</span>
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                <span class="token string">"@type"</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: local_service
                      domains: <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>
                      routes:
                        - match: <span class="token punctuation">{</span> prefix: <span class="token string">"/"</span> <span class="token punctuation">}</span>
                          route: <span class="token punctuation">{</span> cluster: some_service <span class="token punctuation">}</span>
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      <span class="token string">"@type"</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
    - name: some_service
      connect_timeout: <span class="token number">0</span>.25s
      type: LOGICAL_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: some_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: simple
                      port_value: <span class="token number">80</span>

$ kubectl create configmap envoy-config --from-file envoy.yaml
configmap/envoy-config created

$ <span class="token function">cat</span> envoy-deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: envoy
  name: envoy
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      run: envoy
  template:
    metadata:
      labels:
        run: envoy
    spec:
      containers:
        - image: envoyproxy/envoy-dev
          name: envoy
          volumeMounts:
            - name: envoy-config
              mountPath: <span class="token string">"/etc/envoy"</span>
              readOnly: <span class="token boolean">true</span>
      volumes:
        - name: envoy-config
          configMap:
            name: envoy-config

$ kubectl apply -f ./envoy-deploy.yaml
deployment.apps/envoy created

$ kubectl get pods -owide
NAME                      READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
envoy-7c8f878d77-f8mg7    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13m   <span class="token number">10.244</span>.1.4   minikube-m02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
simple-7b4d48d56b-lp8dq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20m   <span class="token number">10.244</span>.1.2   minikube-m02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ <span class="token function">curl</span> <span class="token number">10.244</span>.1.4:10000/hello
hello <span class="token punctuation">[</span>stranger<span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>Details of the http request header:<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
X-Envoy-Expected-Rq-Timeout-Ms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">15000</span><span class="token punctuation">]</span>
User-Agent<span class="token operator">=</span><span class="token punctuation">[</span>curl/7.81.0<span class="token punctuation">]</span>
<span class="token assign-left variable">Accept</span><span class="token operator">=</span><span class="token punctuation">[</span>*/*<span class="token punctuation">]</span>
X-Forwarded-Proto<span class="token operator">=</span><span class="token punctuation">[</span>http<span class="token punctuation">]</span>
X-Request-Id<span class="token operator">=</span><span class="token punctuation">[</span>4048f3e2-2e03-4900-a3fa-76eee47a6fc4<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Isito-流量管理"><a href="#Isito-流量管理" class="headerlink" title="Isito 流量管理"></a>Isito 流量管理</h3><p>可以使用命令 <code>istioctl analyze -n &lt;namespace&gt;</code> 来分析某个命名空间的istio配置是否正确。</p>
<h4 id="流量劫持实验"><a href="#流量劫持实验" class="headerlink" title="流量劫持实验"></a>流量劫持实验</h4><h5 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建集群</span>
$ minikube start --cpus<span class="token operator">=</span><span class="token number">4</span> --memory<span class="token operator">=</span><span class="token number">16384</span>

<span class="token comment"># 安装 istio</span>
$ istioctl <span class="token function">install</span> --set <span class="token assign-left variable">profile</span><span class="token operator">=</span>demo -y

<span class="token comment"># 下载教程相关资源</span>
$ <span class="token function">git</span> clone git@github.com:kibaamor/101.git
$ <span class="token builtin class-name">cd</span> <span class="token number">101</span>/module12/istio/4.sidecar

<span class="token comment"># 创建 sidecar 空间以及其他资源</span>
$ kubectl create ns sidecar
$ kubectl label ns sidecar istio-injection<span class="token operator">=</span>enabled
$ kubectl apply -f nginx.yaml -n sidecar
$ kubectl apply -f toolbox.yaml -n sidecar

<span class="token comment"># 确认部署成功</span>
$ kubectl -n sidecar <span class="token builtin class-name">exec</span> deploy/toolbox -- <span class="token function">curl</span> nginx
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="分析出站流量"><a href="#分析出站流量" class="headerlink" title="分析出站流量"></a>分析出站流量</h5><h6 id="查看-toolbox-容器-iptables-规则"><a href="#查看-toolbox-容器-iptables-规则" class="headerlink" title="查看 toolbox 容器 iptables 规则"></a>查看 toolbox 容器 iptables 规则</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入minikube所在的docker</span>
$ minikube <span class="token function">ssh</span>

<span class="token comment"># 查看toolbox容器的Id</span>
$ docker <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> -i toolbox
8d3e31b6693e   e748609498a4                <span class="token string">"/usr/local/bin/pilo…"</span>   <span class="token number">6</span> minutes ago    Up <span class="token number">6</span> minutes              k8s_istio-proxy_toolbox-65fdb8f7b8-d5b22_sidecar_44e06cc3-77b8-4004-86bc-cc6e3bd9da3d_0
96098aeea9e8   centos                      <span class="token string">"tail -f /dev/null"</span>      <span class="token number">6</span> minutes ago    Up <span class="token number">6</span> minutes              k8s_toolbox_toolbox-65fdb8f7b8-d5b22_sidecar_44e06cc3-77b8-4004-86bc-cc6e3bd9da3d_0
d452cae17d8d   registry.k8s.io/pause:3.9   <span class="token string">"/pause"</span>                 <span class="token number">7</span> minutes ago    Up <span class="token number">7</span> minutes              k8s_POD_toolbox-65fdb8f7b8-d5b22_sidecar_44e06cc3-77b8-4004-86bc-cc6e3bd9da3d_0

<span class="token comment"># 查看toolbox容器的Pid</span>
$ docker inspect 96098aeea9e8 <span class="token operator">|</span> <span class="token function">grep</span> -i pid
<span class="token string">"Pid"</span><span class="token builtin class-name">:</span> <span class="token number">4938</span>,
<span class="token string">"PidMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
<span class="token string">"PidsLimit"</span><span class="token builtin class-name">:</span> null,

<span class="token comment"># 查看toolbox容器的iptables规则</span>
$ <span class="token function">sudo</span> nsenter -t <span class="token number">4938</span> -n iptables-legacy-save
<span class="token comment"># Generated by iptables-save v1.8.7 on Tue Jul  9 11:14:24 2024</span>
*nat
:PREROUTING ACCEPT <span class="token punctuation">[</span><span class="token number">40</span>:2400<span class="token punctuation">]</span>
:INPUT ACCEPT <span class="token punctuation">[</span><span class="token number">40</span>:2400<span class="token punctuation">]</span>
:OUTPUT ACCEPT <span class="token punctuation">[</span><span class="token number">27</span>:2185<span class="token punctuation">]</span>
:POSTROUTING ACCEPT <span class="token punctuation">[</span><span class="token number">30</span>:2365<span class="token punctuation">]</span>
:ISTIO_INBOUND - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_IN_REDIRECT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_OUTPUT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_REDIRECT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15008</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15090</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15021</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15020</span> -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports <span class="token number">15006</span>
-A ISTIO_OUTPUT -s <span class="token number">127.0</span>.0.6/32 -o lo -j RETURN
-A ISTIO_OUTPUT <span class="token operator">!</span> -d <span class="token number">127.0</span>.0.1/32 -o lo -p tcp -m tcp <span class="token operator">!</span> --dport <span class="token number">15008</span> -m owner --uid-owner <span class="token number">1337</span> -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner <span class="token operator">!</span> --uid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT <span class="token operator">!</span> -d <span class="token number">127.0</span>.0.1/32 -o lo -p tcp -m tcp <span class="token operator">!</span> --dport <span class="token number">15008</span> -m owner --gid-owner <span class="token number">1337</span> -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner <span class="token operator">!</span> --gid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -d <span class="token number">127.0</span>.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports <span class="token number">15001</span>
COMMIT
<span class="token comment"># Completed on Tue Jul  9 11:14:24 2024</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的 iptables 规则可以看出，toolbox 容器访问 nginx pod 的流量会被重定向到本地的 15001 端口。</p>
<p>我们可以先看看 istio 规则的同步状态（命令 <code>ps</code> 是命令 <code>proxy-status</code> 的简写）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl <span class="token function">ps</span> -n sidecar
NAME                                         CLUSTER        CDS        LDS        EDS        RDS        ECDS         ISTIOD                      VERSION
nginx-deployment-bf5d5cf98-k5tlz.sidecar     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-869cfc56b5-ffktv     <span class="token number">1.22</span>.2
toolbox-65fdb8f7b8-d5b22.sidecar             Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-869cfc56b5-ffktv     <span class="token number">1.22</span>.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看容器中 istio 的代理配置情况（命令 <code>pc</code> 是命令 <code>proxy-config</code> 的简写）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods -n sidecar
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-bf5d5cf98-k5tlz   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16m
toolbox-65fdb8f7b8-d5b22           <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16m

$ istioctl pc listeners toolbox-65fdb8f7b8-d5b22 -n sidecar
ADDRESSES      PORT  MATCH                                                                    DESTINATION
<span class="token number">10.96</span>.0.10     <span class="token number">53</span>    ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">53</span><span class="token operator">||</span>kube-dns.kube-system.svc.cluster.local
<span class="token number">0.0</span>.0.0        <span class="token number">80</span>    Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c                                     Route: <span class="token number">80</span>
<span class="token number">0.0</span>.0.0        <span class="token number">80</span>    ALL                                                                      PassthroughCluster
<span class="token number">10.105</span>.7.120   <span class="token number">443</span>   ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>istio-egressgateway.istio-system.svc.cluster.local
<span class="token number">10.111</span>.188.103 <span class="token number">443</span>   ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>istiod.istio-system.svc.cluster.local
<span class="token number">10.111</span>.255.7   <span class="token number">443</span>   ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>istio-ingressgateway.istio-system.svc.cluster.local
<span class="token number">10.96</span>.0.1      <span class="token number">443</span>   ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>kubernetes.default.svc.cluster.local
<span class="token number">10.96</span>.0.10     <span class="token number">9153</span>  Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c                                     Route: kube-dns.kube-system.svc.cluster.local:9153
<span class="token number">10.96</span>.0.10     <span class="token number">9153</span>  ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">9153</span><span class="token operator">||</span>kube-dns.kube-system.svc.cluster.local
<span class="token number">0.0</span>.0.0        <span class="token number">15001</span> ALL                                                                      PassthroughCluster
<span class="token number">0.0</span>.0.0        <span class="token number">15001</span> Addr: *:15001                                                            Non-HTTP/Non-TCP
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Addr: *:15006                                                            Non-HTTP/Non-TCP
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> App: istio-http/1.0,istio-http/1.1,istio-h2<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0 InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                    InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> App: TCP TLS<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Trans: raw_buffer<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                       InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0        <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                              InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0        <span class="token number">15010</span> Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c                                     Route: <span class="token number">15010</span>
<span class="token number">0.0</span>.0.0        <span class="token number">15010</span> ALL                                                                      PassthroughCluster
<span class="token number">10.111</span>.188.103 <span class="token number">15012</span> ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">15012</span><span class="token operator">||</span>istiod.istio-system.svc.cluster.local
<span class="token number">0.0</span>.0.0        <span class="token number">15014</span> Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c                                     Route: <span class="token number">15014</span>
<span class="token number">0.0</span>.0.0        <span class="token number">15014</span> ALL                                                                      PassthroughCluster
<span class="token number">0.0</span>.0.0        <span class="token number">15021</span> ALL                                                                      Inline Route: /healthz/ready*
<span class="token number">10.111</span>.255.7   <span class="token number">15021</span> Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c                                     Route: istio-ingressgateway.istio-system.svc.cluster.local:15021
<span class="token number">10.111</span>.255.7   <span class="token number">15021</span> ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">15021</span><span class="token operator">||</span>istio-ingressgateway.istio-system.svc.cluster.local
<span class="token number">0.0</span>.0.0        <span class="token number">15090</span> ALL                                                                      Inline Route: /stats/prometheus*
<span class="token number">10.111</span>.255.7   <span class="token number">15443</span> ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">15443</span><span class="token operator">||</span>istio-ingressgateway.istio-system.svc.cluster.local
<span class="token number">10.111</span>.255.7   <span class="token number">31400</span> ALL                                                                      Cluster: outbound<span class="token operator">|</span><span class="token number">31400</span><span class="token operator">||</span>istio-ingressgateway.istio-system.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="查看-15001-端口的具体配置"><a href="#查看-15001-端口的具体配置" class="headerlink" title="查看 15001 端口的具体配置"></a>查看 15001 端口的具体配置</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc listeners toolbox-65fdb8f7b8-d5b22 -n sidecar --port <span class="token number">15001</span> -oyaml
- accessLog: <span class="token comment"># 端口访问日志</span>
  - filter:
      responseFlagFilter:
        flags:
        - NR
    name: envoy.access_loggers.file
    typedConfig:
      <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
      logFormat:
        textFormatSource:
          inlineString: <span class="token operator">|</span>
            <span class="token punctuation">[</span>%START_TIME%<span class="token punctuation">]</span> <span class="token string">"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"</span> %RESPONSE_CODE% %RESPONSE_FLAGS% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% <span class="token string">"%UPSTREAM_TRANSPORT_FAILURE_REASON%"</span> %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP<span class="token punctuation">(</span>X-ENVOY-UPSTREAM-SERVICE-TIME<span class="token punctuation">)</span>% <span class="token string">"%REQ(X-FORWARDED-FOR)%"</span> <span class="token string">"%REQ(USER-AGENT)%"</span> <span class="token string">"%REQ(X-REQUEST-ID)%"</span> <span class="token string">"%REQ(:AUTHORITY)%"</span> <span class="token string">"%UPSTREAM_HOST%"</span> %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%
      path: /dev/stdout
  address: <span class="token comment"># 端口监听配置</span>
    socketAddress:
      address: <span class="token number">0.0</span>.0.0
      portValue: <span class="token number">15001</span>
  filterChains: <span class="token comment"># 处理链（顺序很重要）</span>
  - filterChainMatch: <span class="token comment"># 第一个处理</span>
      destinationPort: <span class="token number">15001</span> <span class="token comment"># 如果转发后的请求的目的地是15001端口，即本来就是发给15001端口的流量</span>
    filters:
    - name: istio.stats
      typedConfig:
        <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/stats.PluginConfig
    - name: envoy.filters.network.tcp_proxy
      typedConfig:
        <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
        cluster: BlackHoleCluster <span class="token comment"># 则把请求转发到 BlackHoleCluster 集群</span>
        statPrefix: BlackHoleCluster
    name: virtualOutbound-blackhole
  - filters: <span class="token comment"># 第二个处理，没有filterChainMatch，表示会处理剩下的所有请求，即通过 iptable 拦截而来的流量</span>
    - name: istio.stats
      typedConfig:
        <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/stats.PluginConfig
    - name: envoy.filters.network.tcp_proxy
      typedConfig:
        <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
        accessLog:
        - name: envoy.access_loggers.file
          typedConfig:
            <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            logFormat:
              textFormatSource:
                inlineString: <span class="token operator">|</span>
                  <span class="token punctuation">[</span>%START_TIME%<span class="token punctuation">]</span> <span class="token string">"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"</span> %RESPONSE_CODE% %RESPONSE_FLAGS% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% <span class="token string">"%UPSTREAM_TRANSPORT_FAILURE_REASON%"</span> %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP<span class="token punctuation">(</span>X-ENVOY-UPSTREAM-SERVICE-TIME<span class="token punctuation">)</span>% <span class="token string">"%REQ(X-FORWARDED-FOR)%"</span> <span class="token string">"%REQ(USER-AGENT)%"</span> <span class="token string">"%REQ(X-REQUEST-ID)%"</span> <span class="token string">"%REQ(:AUTHORITY)%"</span> <span class="token string">"%UPSTREAM_HOST%"</span> %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%
            path: /dev/stdout
        cluster: PassthroughCluster <span class="token comment"># 把剩下的请求转发到 PassthroughCluster 集群</span>
        statPrefix: PassthroughCluster
    name: virtualOutbound-catchall-tcp
  name: virtualOutbound
  trafficDirection: OUTBOUND
  useOriginalDst: <span class="token boolean">true</span> <span class="token comment"># 表示会把请求向原始的地址转发</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据上面的配置可以看出，发送给 15001 端口的流量会被转发给原始的目标地址。如果原始目标地址就是 15001 端口，流量会被转发到 BlackHoleCluster 集群，其他流量则会被转发到 PassthroughCluster 集群。</p>
<blockquote>
<p>参考资料：<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener_components.proto#config-listener-v3-filterchainmatch">config.listener.v3.FilterChainMatch</a></p>
</blockquote>
<h6 id="BlackHoleCluster-和-PassthroughCluster"><a href="#BlackHoleCluster-和-PassthroughCluster" class="headerlink" title="BlackHoleCluster 和 PassthroughCluster"></a>BlackHoleCluster 和 PassthroughCluster</h6><blockquote>
<p>参考资料：<a target="_blank" rel="noopener" href="https://istio.io/latest/blog/2019/monitoring-external-service-traffic/#what-are-blackhole-and-passthrough-clusters">What are BlackHole and Passthrough clusters?</a></p>
</blockquote>
<p>查看 BlackHoleCluster 的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc cluster toolbox-65fdb8f7b8-d5b22 -n sidecar -o yaml --fqdn BlackHoleCluster
- connectTimeout: 10s
  name: BlackHoleCluster
  type: STATIC

$ istioctl pc endpoint toolbox-65fdb8f7b8-d5b22 -n sidecar --cluster BlackHoleCluster -o yaml
<span class="token punctuation">[</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 BlackHoleCluster 集群的类型是静态类型，但是却没有任何的 endpoint，所以所有发给 BlackHoleCluster 集群的流量都会被丢掉。</p>
<hr>
<p>查看 PassthroughCluster 的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc cluster toolbox-65fdb8f7b8-d5b22 -n sidecar -o yaml --fqdn PassthroughCluster
- circuitBreakers:
    thresholds:
    - maxConnections: <span class="token number">4294967295</span>
      maxPendingRequests: <span class="token number">4294967295</span>
      maxRequests: <span class="token number">4294967295</span>
      maxRetries: <span class="token number">4294967295</span>
      trackRemaining: <span class="token boolean">true</span>
  connectTimeout: 10s
  filters:
  - name: istio.metadata_exchange
    typedConfig:
      <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/udpa.type.v1.TypedStruct
      typeUrl: type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange
      value:
        enable_discovery: <span class="token boolean">true</span>
        protocol: istio-peer-exchange
  lbPolicy: CLUSTER_PROVIDED
  name: PassthroughCluster
  type: ORIGINAL_DST
  typedExtensionProtocolOptions:
    envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
      <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
      commonHttpProtocolOptions:
        idleTimeout: 300s
      useDownstreamProtocolConfig:
        http2ProtocolOptions: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        httpProtocolOptions: <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 PassthroughCluster 集群的类型是 ORIGINAL_DST ，表面这个集群使用了 <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery#original-destination">original destination load balancing</a> 策略，也就是会将流量转发给其原始的目标地址。</p>
<hr>
<p>综上，可以看出，本来就是发给15001端口的流量会被丢弃，而被 iptable 拦截并转发到 15001 端口的流量，会再发送给流量原来的地址。</p>
<h6 id="查看-80-端口的配置"><a href="#查看-80-端口的配置" class="headerlink" title="查看 80 端口的配置"></a>查看 80 端口的配置</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc listeners toolbox-65fdb8f7b8-d5b22 -n sidecar --port <span class="token number">80</span>
ADDRESSES PORT MATCH                                DESTINATION
<span class="token number">0.0</span>.0.0   <span class="token number">80</span>   Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c Route: <span class="token number">80</span>
<span class="token number">0.0</span>.0.0   <span class="token number">80</span>   ALL                                  PassthroughCluster<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，当 toolbox 容器访问 nginx service 的 80 端口时，使用 http/1.1或h2c协议时，会使用名为 80 的路由规则。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc route toolbox-65fdb8f7b8-d5b22 -n sidecar --name <span class="token number">80</span> -o yaml
- ignorePortInHostMatching: <span class="token boolean">true</span>
  maxDirectResponseBodySizeBytes: <span class="token number">1048576</span>
  name: <span class="token string">"80"</span>
  validateClusters: <span class="token boolean">false</span>
  virtualHosts:
  - domains:
    - istio-egressgateway.istio-system.svc.cluster.local
    - istio-egressgateway.istio-system
    - istio-egressgateway.istio-system.svc
    - <span class="token number">10.105</span>.7.120
    includeRequestAttemptCount: <span class="token boolean">true</span>
    name: istio-egressgateway.istio-system.svc.cluster.local:80
    routes:
    - decorator:
        operation: istio-egressgateway.istio-system.svc.cluster.local:80/*
      match:
        prefix: /
      name: default
      route:
        cluster: outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>istio-egressgateway.istio-system.svc.cluster.local
        maxGrpcTimeout: 0s
        retryPolicy:
          hostSelectionRetryMaxAttempts: <span class="token string">"5"</span>
          numRetries: <span class="token number">2</span>
          retriableStatusCodes:
          - <span class="token number">503</span>
          retryHostPredicate:
          - name: envoy.retry_host_predicates.previous_hosts
            typedConfig:
              <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate
          retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes
        timeout: 0s
  - domains:
    - istio-ingressgateway.istio-system.svc.cluster.local
    - istio-ingressgateway.istio-system
    - istio-ingressgateway.istio-system.svc
    - <span class="token number">10.111</span>.255.7
    includeRequestAttemptCount: <span class="token boolean">true</span>
    name: istio-ingressgateway.istio-system.svc.cluster.local:80
    routes:
    - decorator:
        operation: istio-ingressgateway.istio-system.svc.cluster.local:80/*
      match:
        prefix: /
      name: default
      route:
        cluster: outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>istio-ingressgateway.istio-system.svc.cluster.local
        maxGrpcTimeout: 0s
        retryPolicy:
          hostSelectionRetryMaxAttempts: <span class="token string">"5"</span>
          numRetries: <span class="token number">2</span>
          retriableStatusCodes:
          - <span class="token number">503</span>
          retryHostPredicate:
          - name: envoy.retry_host_predicates.previous_hosts
            typedConfig:
              <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate
          retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes
        timeout: 0s
  - domains:
    - nginx.sidecar.svc.cluster.local
    - nginx
    - nginx.sidecar.svc
    - nginx.sidecar
    - <span class="token number">10.97</span>.154.185
    includeRequestAttemptCount: <span class="token boolean">true</span>
    name: nginx.sidecar.svc.cluster.local:80
    routes:
    - decorator:
        operation: nginx.sidecar.svc.cluster.local:80/*
      match:
        prefix: /
      name: default
      route:
        cluster: outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local
        maxGrpcTimeout: 0s
        retryPolicy:
          hostSelectionRetryMaxAttempts: <span class="token string">"5"</span>
          numRetries: <span class="token number">2</span>
          retriableStatusCodes:
          - <span class="token number">503</span>
          retryHostPredicate:
          - name: envoy.retry_host_predicates.previous_hosts
            typedConfig:
              <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate
          retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes
        timeout: 0s
  - domains:
    - <span class="token string">'*'</span>
    includeRequestAttemptCount: <span class="token boolean">true</span>
    name: allow_any
    routes:
    - match:
        prefix: /
      name: allow_any
      route:
        cluster: PassthroughCluster
        maxGrpcTimeout: 0s
        timeout: 0s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，但访问的域名是 nginx 是时，流量会被路由到 outbound|80||nginx.sidecar.svc.cluster.local 集群。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc cluster toolbox-65fdb8f7b8-d5b22 -n sidecar --fqdn <span class="token string">'outbound|80||nginx.sidecar.svc.cluster.local'</span>
SERVICE FQDN                        PORT     SUBSET     DIRECTION     TYPE     DESTINATION RULE
nginx.sidecar.svc.cluster.local     <span class="token number">80</span>       -          outbound      EDS

$ istioctl pc endpoint toolbox-65fdb8f7b8-d5b22 -n sidecar --cluster <span class="token string">'outbound|80||nginx.sidecar.svc.cluster.local'</span>
ENDPOINT          STATUS      OUTLIER CHECK     CLUSTER
<span class="token number">10.244</span>.0.6:80     HEALTHY     OK                outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local

$ kubectl get pods -n sidecar -owide
NAME                               READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-bf5d5cf98-k5tlz   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          4h23m   <span class="token number">10.244</span>.0.6   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
toolbox-65fdb8f7b8-d5b22           <span class="token number">2</span>/2     Running   <span class="token number">0</span>          4h23m   <span class="token number">10.244</span>.0.7   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，流量最终会被路由到 nginx pod 中。</p>
<p>当 nginx deploy 扩容后</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl scale deployment nginx-deployment --replicas <span class="token number">3</span> -n sidecar
deployment.apps/nginx-deployment scaled

$ istioctl pc endpoint toolbox-65fdb8f7b8-d5b22 -n sidecar --cluster <span class="token string">'outbound|80||nginx.sidecar.svc.cluster.local'</span>
ENDPOINT          STATUS      OUTLIER CHECK     CLUSTER
<span class="token number">10.244</span>.0.6:80     HEALTHY     OK                outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local
<span class="token number">10.244</span>.0.8:80     HEALTHY     OK                outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local
<span class="token number">10.244</span>.0.9:80     HEALTHY     OK                outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local

$ kubectl get pods -n sidecar -owide
NAME                               READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-bf5d5cf98-5455w   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          104s    <span class="token number">10.244</span>.0.8   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-bf5d5cf98-8kb84   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          104s    <span class="token number">10.244</span>.0.9   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-bf5d5cf98-k5tlz   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          4h27m   <span class="token number">10.244</span>.0.6   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
toolbox-65fdb8f7b8-d5b22           <span class="token number">2</span>/2     Running   <span class="token number">0</span>          4h27m   <span class="token number">10.244</span>.0.7   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment"># 还原配置</span>
$ kubectl scale deployment nginx-deployment --replicas <span class="token number">1</span> -n sidecar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="分析入站流量"><a href="#分析入站流量" class="headerlink" title="分析入站流量"></a>分析入站流量</h5><h6 id="查看-nginx-容器-iptables-规则"><a href="#查看-nginx-容器-iptables-规则" class="headerlink" title="查看 nginx 容器 iptables 规则"></a>查看 nginx 容器 iptables 规则</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ minikube <span class="token function">ssh</span>

$ crictl <span class="token function">ps</span> -r --image nginx
CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
696d66a2cc3a6       nginx:latest        <span class="token number">22</span> hours ago        Running             nginx               <span class="token number">0</span>                   dcb43bcd3d41e       nginx-deployment-bf5d5cf98-k5tlz

$ crictl inspect dcb43bcd3d41e <span class="token operator">|</span> <span class="token function">grep</span> pid
<span class="token string">"pid"</span><span class="token builtin class-name">:</span> <span class="token number">4308</span>

$ <span class="token function">sudo</span> nsenter -t <span class="token number">4308</span> -n iptables-legacy-save
<span class="token comment"># Generated by iptables-save v1.8.7 on Wed Jul 10 09:22:26 2024</span>
*nat
:PREROUTING ACCEPT <span class="token punctuation">[</span><span class="token number">5353</span>:321180<span class="token punctuation">]</span>
:INPUT ACCEPT <span class="token punctuation">[</span><span class="token number">5355</span>:321300<span class="token punctuation">]</span>
:OUTPUT ACCEPT <span class="token punctuation">[</span><span class="token number">339</span>:31474<span class="token punctuation">]</span>
:POSTROUTING ACCEPT <span class="token punctuation">[</span><span class="token number">339</span>:31474<span class="token punctuation">]</span>
:ISTIO_INBOUND - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_IN_REDIRECT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_OUTPUT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
:ISTIO_REDIRECT - <span class="token punctuation">[</span><span class="token number">0</span>:0<span class="token punctuation">]</span>
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15008</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15090</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15021</span> -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport <span class="token number">15020</span> -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports <span class="token number">15006</span>
-A ISTIO_OUTPUT -s <span class="token number">127.0</span>.0.6/32 -o lo -j RETURN
-A ISTIO_OUTPUT <span class="token operator">!</span> -d <span class="token number">127.0</span>.0.1/32 -o lo -p tcp -m tcp <span class="token operator">!</span> --dport <span class="token number">15008</span> -m owner --uid-owner <span class="token number">1337</span> -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner <span class="token operator">!</span> --uid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT <span class="token operator">!</span> -d <span class="token number">127.0</span>.0.1/32 -o lo -p tcp -m tcp <span class="token operator">!</span> --dport <span class="token number">15008</span> -m owner --gid-owner <span class="token number">1337</span> -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner <span class="token operator">!</span> --gid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner <span class="token number">1337</span> -j RETURN
-A ISTIO_OUTPUT -d <span class="token number">127.0</span>.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports <span class="token number">15001</span>
COMMIT
<span class="token comment"># Completed on Wed Jul 10 09:22:26 2024</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的 iptables 规则可以看出，访问 nginx pod 的流量，如果目的端口不是 15008, 15090, 15021, 15020，就会被重定向到本地的 15006 端口。</p>
<h6 id="查看-15006-端口的具体配置"><a href="#查看-15006-端口的具体配置" class="headerlink" title="查看 15006 端口的具体配置"></a>查看 15006 端口的具体配置</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods -n sidecar -owide
NAME                               READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-bf5d5cf98-k5tlz   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          22h   <span class="token number">10.244</span>.0.6   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
toolbox-65fdb8f7b8-d5b22           <span class="token number">2</span>/2     Running   <span class="token number">0</span>          22h   <span class="token number">10.244</span>.0.7   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ istioctl pc listener nginx-deployment-bf5d5cf98-k5tlz -n sidecar --port <span class="token number">15006</span>
ADDRESSES PORT  MATCH                                                                                         DESTINATION
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Addr: *:15006                                                                                 Non-HTTP/Non-TCP
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> App: istio-http/1.0,istio-http/1.1,istio-h2<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                      InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                         InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> App: TCP TLS<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                                     InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: raw_buffer<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                                            InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> Addr: <span class="token number">0.0</span>.0.0/0                                                                   InboundPassthroughClusterIpv4
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: tls<span class="token punctuation">;</span> App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2<span class="token punctuation">;</span> Addr: *:80 Cluster: inbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>
<span class="token number">0.0</span>.0.0   <span class="token number">15006</span> Trans: raw_buffer<span class="token punctuation">;</span> Addr: *:80                                                                 Cluster: inbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据上面的配置可以看出，toolbox 访问 nginx 80 端口的流量会被路由到 InboundPassthroughClusterIpv4 集群。</p>
<h6 id="InboundPassthroughClusterIpv4"><a href="#InboundPassthroughClusterIpv4" class="headerlink" title="InboundPassthroughClusterIpv4"></a>InboundPassthroughClusterIpv4</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc clusters nginx-deployment-bf5d5cf98-k5tlz -n sidecar --fqdn InboundPassthroughClusterIpv4 -oyaml
- circuitBreakers:
    thresholds:
    - maxConnections: <span class="token number">4294967295</span>
      maxPendingRequests: <span class="token number">4294967295</span>
      maxRequests: <span class="token number">4294967295</span>
      maxRetries: <span class="token number">4294967295</span>
      trackRemaining: <span class="token boolean">true</span>
  connectTimeout: 10s
  lbPolicy: CLUSTER_PROVIDED
  name: InboundPassthroughClusterIpv4
  type: ORIGINAL_DST
  typedExtensionProtocolOptions:
    envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
      <span class="token string">'@type'</span><span class="token builtin class-name">:</span> type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
      commonHttpProtocolOptions:
        idleTimeout: 300s
      useDownstreamProtocolConfig:
        http2ProtocolOptions: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        httpProtocolOptions: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  upstreamBindConfig:
    sourceAddress:
      address: <span class="token number">127.0</span>.0.6
      portValue: <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 InboundPassthroughClusterIpv4 集群的类型与 PassthroughCluster 集群的类型一样，也是 ORIGINAL_DST，也就是会将流量转发给其原始的目标地址。</p>
<h6 id="查看-80-端口的配置-1"><a href="#查看-80-端口的配置-1" class="headerlink" title="查看 80 端口的配置"></a>查看 80 端口的配置</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc listener nginx-deployment-bf5d5cf98-k5tlz -n sidecar --port <span class="token number">80</span>
ADDRESSES PORT MATCH                                DESTINATION
<span class="token number">0.0</span>.0.0   <span class="token number">80</span>   Trans: raw_buffer<span class="token punctuation">;</span> App: http/1.1,h2c Route: <span class="token number">80</span>
<span class="token number">0.0</span>.0.0   <span class="token number">80</span>   ALL                                  PassthroughCluster<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>即访问 nginx 80 端口时会使用名为 80 的路由规则。</p>
<p>后面的流程就与 toolbox中一样了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc route nginx-deployment-bf5d5cf98-k5tlz -n sidecar --name <span class="token number">80</span> -oyaml
- ignorePortInHostMatching: <span class="token boolean">true</span>
  maxDirectResponseBodySizeBytes: <span class="token number">1048576</span>
  name: <span class="token string">"80"</span>
  validateClusters: <span class="token boolean">false</span>
  virtualHosts:
  - <span class="token punctuation">..</span>.
  - domains:
    - nginx.sidecar.svc.cluster.local
    - nginx
    - nginx.sidecar.svc
    - nginx.sidecar
    - <span class="token number">10.97</span>.154.185
    includeRequestAttemptCount: <span class="token boolean">true</span>
    name: nginx.sidecar.svc.cluster.local:80
    routes:
    - decorator:
        operation: nginx.sidecar.svc.cluster.local:80/*
      match:
        prefix: /
      name: default
      route:
        cluster: outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local
        <span class="token punctuation">..</span>.
  - <span class="token punctuation">..</span>.

$ istioctl pc cluster nginx-deployment-bf5d5cf98-k5tlz -n sidecar --fqdn <span class="token string">'outbound|80||nginx.sidecar.svc.cluster.local'</span>
SERVICE FQDN                        PORT     SUBSET     DIRECTION     TYPE     DESTINATION RULE
nginx.sidecar.svc.cluster.local     <span class="token number">80</span>       -          outbound      EDS

$ istioctl pc endpoint nginx-deployment-bf5d5cf98-k5tlz -n sidecar --cluster <span class="token string">'outbound|80||nginx.sidecar.svc.cluster.local'</span>
ENDPOINT          STATUS      OUTLIER CHECK     CLUSTER
<span class="token number">10.244</span>.0.6:80     HEALTHY     OK                outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>nginx.sidecar.svc.cluster.local

$ kubectl get pods -n sidecar -owide
NAME                               READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-bf5d5cf98-k5tlz   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          22h   <span class="token number">10.244</span>.0.6   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
toolbox-65fdb8f7b8-d5b22           <span class="token number">2</span>/2     Running   <span class="token number">0</span>          22h   <span class="token number">10.244</span>.0.7   minikube   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="查看pod中envoy的配置"><a href="#查看pod中envoy的配置" class="headerlink" title="查看pod中envoy的配置"></a>查看pod中envoy的配置</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> deploy/toolbox -n sidecar -- <span class="token function">curl</span> localhost:15000/help
  /: Admin home page
  /certs: print certs on machine
  /clusters: upstream cluster status
  /config_dump: dump current Envoy configs <span class="token punctuation">(</span>experimental<span class="token punctuation">)</span>
      resource: The resource to dump
      mask: The mask to apply. When both resource and mask are specified, the mask is applied to every element <span class="token keyword">in</span> the desired repeated field so that only a subset of fields are returned. The mask is parsed as a ProtobufWkt::FieldMask
      name_regex: Dump only the currently loaded configurations whose names match the specified regex. Can be used with both resource and mask query parameters.
      include_eds: Dump currently loaded configuration including EDS. See the response definition <span class="token keyword">for</span> <span class="token function">more</span> information
  /contention: dump current Envoy mutex contention stats <span class="token punctuation">(</span>if enabled<span class="token punctuation">)</span>
  /cpuprofiler <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: enable/disable the CPU profiler
      enable: enables the CPU profiler<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>y, n<span class="token punctuation">)</span>
  /drain_listeners <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: drain listeners
      graceful: When draining listeners, enter a graceful drain period prior to closing listeners. This behaviour and duration is configurable via server options or CLI
      skip_exit: When draining listeners, <span class="token keyword">do</span> not <span class="token builtin class-name">exit</span> after the drain period. This must be used with graceful
      inboundonly: Drains all inbound listeners. traffic_direction field <span class="token keyword">in</span> envoy_v3_api_msg_config.listener.v3.Listener is used to determine whether a listener is inbound or outbound.
  /healthcheck/fail <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: cause the server to fail health checks
  /healthcheck/ok <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: cause the server to pass health checks
  /heap_dump: dump current Envoy heap <span class="token punctuation">(</span>if supported<span class="token punctuation">)</span>
  /heapprofiler <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: enable/disable the heap profiler
      enable: enable/disable the heap profiler<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>y, n<span class="token punctuation">)</span>
  /help: print out list of admin commands
  /hot_restart_version: print the hot restart compatibility version
  /init_dump: dump current Envoy init manager information <span class="token punctuation">(</span>experimental<span class="token punctuation">)</span>
      mask: The desired component to dump unready targets. The mask is parsed as a ProtobufWkt::FieldMask. For example, get the unready targets of all listeners with /init_dump?mask<span class="token operator">=</span>listener`
  /listeners: print listener info
      format: File <span class="token function">format</span> to use<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>text, json<span class="token punctuation">)</span>
  /logging <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: query/change logging levels
      paths: Change multiple logging levels by setting to <span class="token operator">&lt;</span>logger_name<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>:<span class="token operator">&lt;</span>desired_level<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>,<span class="token operator">&lt;</span>logger_name<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>:<span class="token operator">&lt;</span>desired_level<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>.
      level: desired logging level<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>, trace, debug, info, warning, error, critical, off<span class="token punctuation">)</span>
  /memory: print current allocation/heap usage
  /quitquitquit <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: <span class="token builtin class-name">exit</span> the server
  /ready: print server state, <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token keyword">if</span> LIVE, otherwise <span class="token builtin class-name">return</span> <span class="token number">503</span>
  /reopen_logs <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: reopen access logs
  /reset_counters <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: reset all counters to zero
  /runtime: print runtime values
  /runtime_modify <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: Adds or modifies runtime values as passed <span class="token keyword">in</span> query parameters. To delete a previously added key, use an empty string as the value. Note that deletion only applies to overrides added via this endpoint<span class="token punctuation">;</span> values loaded from disk can be modified via override but not deleted. E.g. ?key1<span class="token operator">=</span>value1<span class="token operator">&amp;</span><span class="token assign-left variable">key2</span><span class="token operator">=</span>value2<span class="token punctuation">..</span>.
  /server_info: print server version/status information
  /stats: print server stats
      usedonly: Only include stats that have been written by system since restart
      filter: Regular expression <span class="token punctuation">(</span>Google re2<span class="token punctuation">)</span> <span class="token keyword">for</span> filtering stats
      format: Format to use<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>html, active-html, text, json<span class="token punctuation">)</span>
      type: Stat types to include.<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>All, Counters, Histograms, Gauges, TextReadouts<span class="token punctuation">)</span>
      histogram_buckets: Histogram bucket display mode<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>cumulative, disjoint, detailed, summary<span class="token punctuation">)</span>
  /stats/prometheus: print server stats <span class="token keyword">in</span> prometheus <span class="token function">format</span>
      usedonly: Only include stats that have been written by system since restart
      text_readouts: Render text_readouts as new gaugues with value <span class="token number">0</span> <span class="token punctuation">(</span>increases Prometheus data size<span class="token punctuation">)</span>
      filter: Regular expression <span class="token punctuation">(</span>Google re2<span class="token punctuation">)</span> <span class="token keyword">for</span> filtering stats
      histogram_buckets: Histogram bucket display mode<span class="token punctuation">;</span> One of <span class="token punctuation">(</span>cumulative, summary<span class="token punctuation">)</span>
  /stats/recentlookups: Show recent stat-name lookups
  /stats/recentlookups/clear <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: <span class="token function">clear</span> list of stat-name lookups and counter
  /stats/recentlookups/disable <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: disable recording of reset stat-name lookup names
  /stats/recentlookups/enable <span class="token punctuation">(</span>POST<span class="token punctuation">)</span>: <span class="token builtin class-name">enable</span> recording of reset stat-name lookup names

$ kubectl <span class="token builtin class-name">exec</span> deploy/toolbox -n sidecar -- <span class="token function">curl</span> localhost:15000/config_dump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="流量管理-1"><a href="#流量管理-1" class="headerlink" title="流量管理"></a>流量管理</h4><p>Gateway</p>
<p>Virtualservice</p>
<p>DestinationRule</p>
<p>ServieEntry</p>
<p>WorkloadEntry</p>
<p>Sidecar</p>
<h4 id="Istio-的流量劫持机制"><a href="#Istio-的流量劫持机制" class="headerlink" title="Istio 的流量劫持机制"></a>Istio 的流量劫持机制</h4><p>为用户应用注入 Sidecar</p>
<ul>
<li>自动注入</li>
<li><p>手动注入</p>
<ul>
<li><code>istioctl kube-inject -fyaml/istio-bookinfo/bookinfo.yaml</code></li>
</ul>
</li>
</ul>
<p>注入后的结果</p>
<ul>
<li><p>注入了init-container istio-init。</p>
<ul>
<li><code>istio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i * -x -b 9080 -d 15090,15021,15020</code></li>
<li>命令行参数 <code>-p 15001</code> 表示出向流量被 iptable 重定向到 Envoy 的 15001端口</li>
<li>命令行参数 <code>-z 15006</code> 表示入向流量被 iptable 重定向到 Envoy 的 15006端口</li>
<li>命令行参数 <code>-u 1337</code> 参数用于排除用户 ID 为 1337，即 Envoy 自身的流量，以避免 Iptable 把 Envoy 发出的数据又重定向到 Envoy，形成死循环。在 istio-proxy 容器中执行命令 <code>id</code>可以看到结果是 <code>uid=1337(istio-proxy) gid=1337(istio-proxy) groups=1337(istio-proxy</code>。</li>
</ul>
</li>
<li><p>注入了 sidecar container istio-proxy</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Istio的流量劫持机制.png" alt="Istio的流量劫持机制"></p>
<h4 id="Init-container"><a href="#Init-container" class="headerlink" title="Init container"></a>Init container</h4><p><strong>将应用容器的所有流量都转发到 Envoy 的 15001 端口。</strong></p>
<p>使用 istio-proxy 用户身份运行，UID 为 1337 即 Envoy 所处的用户空间，这也是 istio-proxy 容器默认使用的用户，见 YAML 配置中的 runAsUser 字段。</p>
<p>使用默认的 REDIRECT 模式来重定向流量。</p>
<p>将所有出站流量都重定向到 Envoy 代理。</p>
<p>将所有访问 9080 端口(即应用容器 productpage 的端口)的流量重定向到 Envoy 代理。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">//所有入站TCP流量走ISTIO_INBOUND
-A PREROUTING -p tcp -j ISTIO_INBOUND

//所有出站TCP流量走ISTIO_OUTPUT
-A OUTPUT -p tcp -j ISTIO_OUTPUT

//忽路ssh，health check等端口
-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN

//所有入站TCP流量走ISTIO_IN_REDIRECT
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT

// TCP流量转发至 15006 端口
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006

//loopback passthrough
-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN
//从loopback口出来，目标非本机地址，owner是envoy，交由ISTIO_IN_REDIRECT处理
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
//从lo口出来，owner非envoy，return
-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
//owner是envoy,return
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO OUTPUT -d 127.0.0.1/32 -j RETURN
//如以上规则都不匹配，则交给ISTIO_REDIRECT处理
-A ISTIO_OUTPUT -j ISTIO_REDIRECT

-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Sidecar-container"><a href="#Sidecar-container" class="headerlink" title="Sidecar container"></a>Sidecar container</h4><p>Istio 会生成以下监听器</p>
<ul>
<li>0.0.0.0:15001 上的监听器接收进出 Pod 的所有流量，然后将请求移交给虚拟监听器。</li>
<li>每个 service IP 一个虚拟监听器，每个出站TCP/HTTPS 流量一个非 HTTP 监听器。</li>
<li>每个 Pod 入站流量暴露的端口一个虚拟监听器</li>
<li>每个 出站 HTTP 流量的 HTTP 0.0.0.0 端口一个虚拟监听器。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">istioctl proxy-config listeners productpage-v1-8b96c8794-bttdd-n bookinfo --port <span class="token number">15001</span> -ojson<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"virtual"</span><span class="token punctuation">,</span>
  <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"socketAddress"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>
      <span class="token property">"portValue"</span><span class="token operator">:</span> <span class="token number">15001</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"filterChains"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"filters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"envoy.tcp_proxy"</span><span class="token punctuation">,</span>
        <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"BlackHoleCluster"</span><span class="token punctuation">,</span>
          <span class="token property">"stat_prefix"</span><span class="token operator">:</span> <span class="token string">"BlackHoleCluster"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"useOriginalDst"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们的请求是到 9080 端口的 HTTP 出站请求，这意味着它被切换到0.0.0.0:9080 虚拟监听器。然后，此监听器在其配置的 RDS 中查找路由配置。在这种情况下，它将查找由 Pilot 配置的 RDS 中的路由 9080(通过 ADS)。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">istioctl proxy-config listeners productpage-v1-8b96c8794-bttdd -n bookinfo --port 9080 --address 0.0.0.0-ojson<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> -na <span class="token operator">|</span> <span class="token function">grep</span> LISTEN
tcp     <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">127.0</span>.0.1:15000     <span class="token number">0.0</span>.0.0:*   LISTEN
tcp     <span class="token number">0</span>   <span class="token number">0</span>   <span class="token number">0.0</span>.0.0:15001       <span class="token number">0.0</span>.0.0:*   LISTEN
tcp6    <span class="token number">0</span>   <span class="token number">0</span>   :::9080             :::*        LISTEN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"rds"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"config_source"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"ads"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"route_config_name"</span><span class="token operator">:</span> <span class="token string">"9080"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>9080 路由配置仅为每个服务提供虚拟主机。</strong> 我们的请求正在前往 reviews 服务，因此 Envoy 将选择我们的请求与域匹配的虚拟主机。一旦在域上匹配，Envoy 会查找与请求匹配的第一条路径。在这种情况下，我们没有任何高级路由，因此只有一条路由匹配所有内容。</p>
<p>这条路由告诉 Envoy 将请求发送到 outbound|9080||reviews.default.svc.cluster.local集群。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">istioctl proxy-config routes productpage-v1-8b96c8794-bttdd --name 9080 -ojson -nbookinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"9080"</span><span class="token punctuation">,</span>
  <span class="token property">"virtualHosts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"reviews.bookinfo.svc.cluster.local:9080"</span><span class="token punctuation">,</span>
      <span class="token property">"domains"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"reviews.bookinfo.svc.cluster.local"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo.svc.cluster.local:9080"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews:9080"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo.svc.cluster"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo.svc.cluster:9080"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo.svc"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo.svc:9080"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo"</span><span class="token punctuation">,</span>
        <span class="token string">"reviews.bookinfo:9080"</span><span class="token punctuation">,</span>
        <span class="token string">"192.168.143.232"</span><span class="token punctuation">,</span>
        <span class="token string">"192.168.143.232:9080"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"routes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"prefix"</span><span class="token operator">:</span> <span class="token string">"/"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"route"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"outbound|9080||reviews.bookinfo.svc.cluster.local"</span><span class="token punctuation">,</span>
            <span class="token property">"timeout"</span><span class="token operator">:</span> <span class="token string">"0.000s"</span><span class="token punctuation">,</span>
            <span class="token property">"maxGrpcTimeout"</span><span class="token operator">:</span> <span class="token string">"0.000s"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>此集群配置为从 Pilot(通过 ADS)检索关联的端点。</strong> 因此，Envoy 将使用 serviceName 字段作为密钥来查找端点列表并将请求代理到其中一个端点。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">istioctl proxy-config clusters productpage-v1-8b96c8794-bttdd --fqdn reviews.bookinfo.svc.cluster.local -n bookinfo -ojson<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"outbound|9080||reviews.bookinfo.svc.cluster.local"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"EDS"</span><span class="token punctuation">,</span>
  <span class="token property">"edsClusterconfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"edsConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"ads"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"serviceName"</span><span class="token operator">:</span> <span class="token string">"outbound|9080||reviews.bookinfo.svc.cluster.local"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"connectTimeout"</span><span class="token operator">:</span> <span class="token string">"1.000s"</span><span class="token punctuation">,</span>
  <span class="token property">"circuitBreakers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"thresholds"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="流量管理-2"><a href="#流量管理-2" class="headerlink" title="流量管理"></a>流量管理</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/流量管理.png" alt="流量管理"></p>
<h4 id="请求路由"><a href="#请求路由" class="headerlink" title="请求路由"></a>请求路由</h4><p><strong>特定网格中服务的规范表示由 Pilot 维护。</strong> 服务的 Istio 模型和在底层平台(Kubernetes、Mesos以及 Cloud Foundry等)中的表达无关。特定平台的适配器负责从各自平台中获取元数据的各种字段，然后对服务模型进行填充。</p>
<p><strong>Istio 引入了服务版本的概念，可以通过版本(v1、v2)或环境(staging、prod)对服务进行进一步的细分。</strong>这些版本不一定是不同的 API版本:它们可能是部署在不同环境(prod、staging或者 dev 等)中的同一服务的不同迭代。使用这种方式的常见场景包括 A/B 测试或金丝雀部署</p>
<p><strong>Istio 的流量路由规则可以根据服务版本来对服务之间流量进行附加控制。</strong></p>
<h4 id="服务之间的通讯"><a href="#服务之间的通讯" class="headerlink" title="服务之间的通讯"></a>服务之间的通讯</h4><p><strong>服务的客户端不知道服务不同版本间的差异。</strong>它们可以使用服务的主机名或者 IP 地址继续访问服务。Envoy sidecar/ 代理拦截并转发客户端和服务器之间的所有请求和响应。</p>
<p>Istio 还为同一服务版本的多个实例提供流量负载均衡。可以在服务发现和负载均衡中找到更多信息。</p>
<p>Istio 不提供 DNS。<strong>应用程序可以尝试使用底层平台(kube-dns、mesos-dns等)中存在的DNS 服务来解析 FODN。</strong></p>
<h4 id="Ingress-和-Egress"><a href="#Ingress-和-Egress" class="headerlink" title="Ingress 和 Egress"></a>Ingress 和 Egress</h4><p><strong>Istio 假定进入和离开服务网络的所有流量都会通过 Envoy 代理进行传输</strong></p>
<p>通过将 Envoy 代理部署在服务之前，运维人员可以针对面向用户的服务进行 A/B 测试、部署金丝雀服务等</p>
<p>类似地，通过使用 Envoy将流量路由到外部 Web 服务(例如，访问 Maps API 或视频服务 API)的方式，运维人员可以为这些服务添加超时控制、重试、断路器等功能，同时还能从服务连接中获取各种细节指标。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Ingress和Egress.png" alt="Ingress和Egress"></p>
<h4 id="服务发现和负载均衡"><a href="#服务发现和负载均衡" class="headerlink" title="服务发现和负载均衡"></a>服务发现和负载均衡</h4><p><strong>Istio 负载均衡服务网格中实例之间的通信</strong></p>
<p>Istio 假定存在服务注册表，以跟踪应用程序中服务的 pod/VM。它还假设服务的新实例自动注册到服务注册表，并且不健康的实例将被自动删除。诸如 Kubernetes、Mesos 等平台已经为基于容器的应用程序提供了这样的功能。为基于虚拟机的应用程序提供的解决方案就更多了。</p>
<p>Pilot 使用来自服务注册的信息，并提供与平台无关的服务发现接口。网格中的 Envoy 实例执行服务发现，并相应地动态更新其负载均衡池。</p>
<p>网格中的服务使用其 DNS 名称访问彼此。服务的所有 HTTP 流量都会通过 Envoy 自动重新路由。Envoy 在负载均衡池中的实例之间分发流量。<strong>虽然 Envoy 支持多种复杂的负载均衡算法，但Istio 目前仅允许三种负载均衡模式:轮循、随机和带权重的最少请求。</strong></p>
<p><strong>除了负载均衡外，Envoy还会定期检查池中每个实例的运行状况。</strong> Envoy 遵循熔断器风格模式根据健康检查 API调用的失败率将实例分类为不健康和健康两种。当给定实例的健康检查失败次数超过预定阈值时，将会被从负载均衡池中弹出。类似地，当通过的健康检查数超过预定阈值时该实例将被添加回负载均衡池。您可以在处理故障中了解更多有关 Envoy的故障处理功能</p>
<p><strong>服务可以通过使用 HTTP 503 响应健康检查来主动减轻负担。在这种情况下，服务实例将立即从调用者的负载均衡池中删除。</strong></p>
<h4 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h4><p>超时处理</p>
<p>基于超时预算的重试机制</p>
<p>基于并发连接和请求的流量控制</p>
<p>对负载均衡器成员的健康检查</p>
<p>细粒度的熔断机制，可以针对Load Balancing Pool中的每个成员设置规则</p>
<h4 id="微调"><a href="#微调" class="headerlink" title="微调"></a>微调</h4><p><strong>Istio 的流量管理规则允许运维人员为每个服务/版本设置故障恢复的全局默认值。</strong> 然而，服务的消费者也可以通过特殊的 HTTP 头提供的请求级别值覆盖超时和重试的默认值。在 Envoy 代理的实现中，对应的 Header 分别是x-envoy-upstream-rq-timeout-ms 和 x-envoy-max-retries。</p>
<h4 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h4><p>为什么需要错误注入:</p>
<ul>
<li>微服务架构下，需要测试端到端的故障恢复能力，</li>
</ul>
<p>Istio 允许在网络层面按协议注入错误来模拟错误，无需通过应用层面删除 Pod，或者人为在 TCP层造成网络故障来模拟。</p>
<p>注入的错误可以基于特定的条件，可以设置出现错误的比例:</p>
<ul>
<li>Delay - 提高网络延时:</li>
<li>Aborts - 直接返回特定的错误码，</li>
</ul>
<h4 id="规则配置"><a href="#规则配置" class="headerlink" title="规则配置"></a>规则配置</h4><p>VirtualService 在 Istio 服务网格中定义路由规则，控制路由如何路由到服务上。</p>
<p>DestinationRule 是 Virtualservice 路由生效后，配置应用与请求的策略集</p>
<p>ServiceEntry 是通常用于在 Istio 服务网格之外启用对服务的请求。</p>
<p>Gateway 为 HTTP/TCP 流量配置负载均衡器，最常见的是在网格的边缘的操作，以启用应用程序的入口流量。</p>
<h5 id="简单测试-Gateway-和-VirtualService"><a href="#简单测试-Gateway-和-VirtualService" class="headerlink" title="简单测试 Gateway 和 VirtualService"></a>简单测试 Gateway 和 VirtualService</h5><h6 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> clone git@github.com:kibaamor/101.git
$ <span class="token builtin class-name">cd</span> module12/istio/1.http-gw

$ kubectl create ns simple
$ kubectl create -f simple.yaml -n simple
$ kubectl create -f istio-specs.yaml -n simple

$ kubectl -n istio-system get svc -l <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                      AGE
istio-ingressgateway   LoadBalancer   <span class="token number">10.111</span>.255.7   <span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span>     <span class="token number">15021</span>:30940/TCP,80:30265/TCP,443:32345/TCP,31400:31186/TCP,15443:30180/TCP   23h

$ <span class="token function">curl</span> <span class="token number">10.111</span>.255.7/hello -v
*   Trying <span class="token number">10.111</span>.255.7:80<span class="token punctuation">..</span>.
* Connected to <span class="token number">10.111</span>.255.7 <span class="token punctuation">(</span><span class="token number">10.111</span>.255.7<span class="token punctuation">)</span> port <span class="token number">80</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /hello HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">10.111</span>.255.7
<span class="token operator">&gt;</span> User-Agent: curl/7.81.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">404</span> Not Found
<span class="token operator">&lt;</span> date: Wed, <span class="token number">10</span> Jul <span class="token number">2024</span> <span class="token number">11</span>:01:54 GMT
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> content-length: <span class="token number">0</span>
<span class="token operator">&lt;</span>
* Connection <span class="token comment">#0 to host 10.111.255.7 left intact</span>

$ <span class="token function">curl</span> -H <span class="token string">"Host: simple.cncamp.io"</span> <span class="token number">10.111</span>.255.7/hello
hello <span class="token punctuation">[</span>stranger<span class="token punctuation">]</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>Details of the http request header:<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
X-Envoy-Internal<span class="token operator">=</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>
X-Envoy-Decorator-Operation<span class="token operator">=</span><span class="token punctuation">[</span>simple.simple.svc.cluster.local:80/*<span class="token punctuation">]</span>
X-Envoy-Peer-Metadata<span class="token operator">=</span><span class="token punctuation">[</span>ChoKCkNMVVNURVJfSUQSDBoKS3ViZXJuZXRlcwocCgxJTlNUQU5DRV9JUFMSDBoKMTAuMjQ0LjAuNAoZCg1JU1RJT19WRVJTSU9OEggaBjEuMjIuMgqcAwoGTEFCRUxTEpEDKo4DCh0KA2FwcBIWGhRpc3Rpby1pbmdyZXNzZ2F0ZXdheQoTCgVjaGFydBIKGghnYXRld2F5cwoUCghoZXJpdGFnZRIIGgZUaWxsZXIKNgopaW5zdGFsbC5vcGVyYXRvci5pc3Rpby5pby9vd25pbmctcmVzb3VyY2USCRoHdW5rbm93bgoZCgVpc3RpbxIQGg5pbmdyZXNzZ2F0ZXdheQoZCgxpc3Rpby5pby9yZXYSCRoHZGVmYXVsdAowChtvcGVyYXRvci5pc3Rpby5pby9jb21wb25lbnQSERoPSW5ncmVzc0dhdGV3YXlzChIKB3JlbGVhc2USBxoFaXN0aW8KOQofc2VydmljZS5pc3Rpby5pby9jYW5vbmljYWwtbmFtZRIWGhRpc3Rpby1pbmdyZXNzZ2F0ZXdheQovCiNzZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1yZXZpc2lvbhIIGgZsYXRlc3QKIgoXc2lkZWNhci5pc3Rpby5pby9pbmplY3QSBxoFZmFsc2UKGgoHTUVTSF9JRBIPGg1jbHVzdGVyLmxvY2FsCi4KBE5BTUUSJhokaXN0aW8taW5ncmVzc2dhdGV3YXktNWM1ODk5NTY3LTQ5MnJ6ChsKCU5BTUVTUEFDRRIOGgxpc3Rpby1zeXN0ZW0KXQoFT1dORVISVBpSa3ViZXJuZXRlczovL2FwaXMvYXBwcy92MS9uYW1lc3BhY2VzL2lzdGlvLXN5c3RlbS9kZXBsb3ltZW50cy9pc3Rpby1pbmdyZXNzZ2F0ZXdheQonCg1XT1JLTE9BRF9OQU1FEhYaFGlzdGlvLWluZ3Jlc3NnYXRld2F5<span class="token punctuation">]</span>
X-Envoy-Attempt-Count<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
X-Forwarded-Proto<span class="token operator">=</span><span class="token punctuation">[</span>http<span class="token punctuation">]</span>
X-Forwarded-For<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">10.244</span>.0.1<span class="token punctuation">]</span>
X-Request-Id<span class="token operator">=</span><span class="token punctuation">[</span>8ab668b4-4da9-9ae2-9ffc-6e2580b0c5a1<span class="token punctuation">]</span>
X-Envoy-Peer-Metadata-Id<span class="token operator">=</span><span class="token punctuation">[</span>router~10.244.0.4~istio-ingressgateway-5c5899567-492rz.istio-system~istio-system.svc.cluster.local<span class="token punctuation">]</span>
User-Agent<span class="token operator">=</span><span class="token punctuation">[</span>curl/7.81.0<span class="token punctuation">]</span>
<span class="token assign-left variable">Accept</span><span class="token operator">=</span><span class="token punctuation">[</span>*/*<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="simple-yaml"><a href="#simple-yaml" class="headerlink" title="simple.yaml"></a>simple.yaml</h6><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> simple
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"80"</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> simple
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> simple
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
          <span class="token key atrule">image</span><span class="token punctuation">:</span> cncamp/httpserver<span class="token punctuation">:</span>v1.0<span class="token punctuation">-</span>metrics
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> simple<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="istio-specs-yaml"><a href="#istio-specs-yaml" class="headerlink" title="istio-specs.yaml"></a>istio-specs.yaml</h6><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple.cncamp.io
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple.simple.svc.cluster.local
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> simple.cncamp.io
      <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>simple
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在文件 <code>istio-specs.yaml</code> 中，<code>Gateway</code> 对应 Envoy 中 <code>listener</code> 的配置。</p>
<p><code>Gateway</code> 的 <code>spec</code> 中的 <code>selector</code> 表示将使用什么 selector 选择 <code>istio-system</code> 命名空间中的 pod。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n istio-system get deploy --show-labels
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
istio-egressgateway    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           28h   <span class="token assign-left variable">app</span><span class="token operator">=</span>istio-egressgateway,install.operator.istio.io/owning-resource-namespace<span class="token operator">=</span>istio-system,install.operator.istio.io/owning-resource<span class="token operator">=</span>installed-state,istio.io/rev<span class="token operator">=</span>default,istio<span class="token operator">=</span>egressgateway,operator.istio.io/component<span class="token operator">=</span>EgressGateways,operator.istio.io/managed<span class="token operator">=</span>Reconcile,operator.istio.io/version<span class="token operator">=</span><span class="token number">1.22</span>.2,release<span class="token operator">=</span>istio
istio-ingressgateway   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           28h   <span class="token assign-left variable">app</span><span class="token operator">=</span>istio-ingressgateway,install.operator.istio.io/owning-resource-namespace<span class="token operator">=</span>istio-system,install.operator.istio.io/owning-resource<span class="token operator">=</span>installed-state,istio.io/rev<span class="token operator">=</span>default,istio<span class="token operator">=</span>ingressgateway,operator.istio.io/component<span class="token operator">=</span>IngressGateways,operator.istio.io/managed<span class="token operator">=</span>Reconcile,operator.istio.io/version<span class="token operator">=</span><span class="token number">1.22</span>.2,release<span class="token operator">=</span>istio
istiod                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           28h   <span class="token assign-left variable">app</span><span class="token operator">=</span>istiod,install.operator.istio.io/owning-resource-namespace<span class="token operator">=</span>istio-system,install.operator.istio.io/owning-resource<span class="token operator">=</span>installed-state,istio.io/rev<span class="token operator">=</span>default,istio<span class="token operator">=</span>pilot,operator.istio.io/component<span class="token operator">=</span>Pilot,operator.istio.io/managed<span class="token operator">=</span>Reconcile,operator.istio.io/version<span class="token operator">=</span><span class="token number">1.22</span>.2,release<span class="token operator">=</span>istio<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，label <code>istio=ingressgateway</code> 将会选中 pod <code>istio-ingressgateway-5c5899567-492rz</code> 。即 Gateway 中的配置将会添加到 deploy istio-ingressgateway 的所有 pod 中。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> simple.cncamp.io
    <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>simple
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>则表示对 istio-ingressgateway 中的 envoy 添加一个处理监听在 80 端口，域名为 simple.cncamp.io 的 listener 配置。</p>
<p>而监听成功后，具体的配置则由 <code>VirtualService</code> 来指定。 <code>Gateway</code> 和 <code>VirtualService</code> 之间的关联是通过 <code>VirtualService</code> 中 <code>spec</code> 中 <code>gateways</code> 字段来指定的。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> simple.cncamp.io
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> simple.simple.svc.cluster.local
          <span class="token key atrule">port</span><span class="token punctuation">:</span>
            <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面配置作用就是在设置在访问 host 是 simple.cncamp.io，端口是 80 时，将流量转发给 simple.simple.svc.cluster.local （即 simple namespace 中的 simple service） 的 80 端口。</p>
<h6 id="分析流量转发过程"><a href="#分析流量转发过程" class="headerlink" title="分析流量转发过程"></a>分析流量转发过程</h6><p>测试时，我们访问的是 istio-ingressgateway 的 clusterip 的 80 端口。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n istio-system get svc istio-ingressgateway -o yaml
apiVersion: v1
kind: Service
metadata:
  name: istio-ingressgateway
  namespace: istio-system
  <span class="token punctuation">..</span>.
spec:
  allocateLoadBalancerNodePorts: <span class="token boolean">true</span>
  clusterIP: <span class="token number">10.111</span>.255.7
  clusterIPs:
  - <span class="token number">10.111</span>.255.7
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http2
    nodePort: <span class="token number">30265</span>
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">8080</span>
  - <span class="token punctuation">..</span>.
  selector:
    app: istio-ingressgateway
    istio: ingressgateway
  sessionAffinity: None
  type: LoadBalancer
status:
  loadBalancer: <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到访问 cluster ip 的 80 端口，实际会转发到 pod 中的 8080 端口。</p>
<p>再来看看 pod 中 8080 端口的配置。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl -n istio-system get pod -l <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway
NAME                                   READY   STATUS    RESTARTS   AGE
istio-ingressgateway-5c5899567-492rz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28h

$ kubectl -n istio-system <span class="token builtin class-name">exec</span> pod/istio-ingressgateway-5c5899567-492rz -- ss -antp <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">8080</span>
LISTEN    <span class="token number">0</span>      <span class="token number">4096</span>              <span class="token number">0.0</span>.0.0:8080             <span class="token number">0.0</span>.0.0:*     users:<span class="token variable"><span class="token punctuation">((</span>"envoy"<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">))</span></span>
LISTEN    <span class="token number">0</span>      <span class="token number">4096</span>              <span class="token number">0.0</span>.0.0:8080             <span class="token number">0.0</span>.0.0:*     users:<span class="token variable"><span class="token punctuation">((</span>"envoy"<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">35</span><span class="token punctuation">))</span></span>

$ istioctl pc listener pod/istio-ingressgateway-5c5899567-492rz -n istio-system
ADDRESSES PORT  MATCH DESTINATION
<span class="token number">0.0</span>.0.0   <span class="token number">8080</span>  ALL   Route: http.8080
<span class="token number">0.0</span>.0.0   <span class="token number">15021</span> ALL   Inline Route: /healthz/ready*
<span class="token number">0.0</span>.0.0   <span class="token number">15090</span> ALL   Inline Route: /stats/prometheus*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，pod 中 8080 端口由进程 envoy 监听，而 envoy 在 8080 端口的流量会根据路由 <code>http.8080</code> 来确定。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ istioctl pc route pod/istio-ingressgateway-5c5899567-492rz -n istio-system
NAME          VHOST NAME              DOMAINS              MATCH                  VIRTUAL SERVICE
http.8080     simple.cncamp.io:80     simple.cncamp.io     /*                     simple.simple
              backend                 *                    /stats/prometheus*
              backend                 *                    /healthz/ready*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看路由规则就会发现，当访问目标是 <code>simple.cncamp.io:80</code> 时，流量就会被路由到 service <code>simple.simple</code>。这和yaml配置中一样。</p>
<h4 id="VirtualService"><a href="#VirtualService" class="headerlink" title="VirtualService"></a>VirtualService</h4><p>是在 Istio 服务网格内对服务的请求如何进行路由控制。</p>
<h5 id="规则的目标描述"><a href="#规则的目标描述" class="headerlink" title="规则的目标描述"></a>规则的目标描述</h5><p><strong>路由规则对应着一或多个用 Virtualservice 配置指定的请求目的主机。</strong>这些主机可以是也可以不是实际的目标负载，甚至可以不是同一网格内可路由的服务。例如要给到 reviews 服务的请求定义路由规则，可以使用内部的名称 reviews，也可以用域名 bookinfo.com，VirtualService 可以定义这样的 host 字段:</p>
<p>host 字段用显示或者隐式的方式定义了一或多个完全限定名(FQDN)。上面的 reviews，会隐式的扩展成为特定的 FODN，例如在 Kubernetes 环境中，全名会从 VirtualService 所在的集群和命名空间中继承而来(比如说reviews.default.svc.cluster.local)。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> reviews
<span class="token punctuation">-</span> bookinfo.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="在服务之间分拆流量"><a href="#在服务之间分拆流量" class="headerlink" title="在服务之间分拆流量"></a>在服务之间分拆流量</h5><p>例如下面的规则会把 25%的 reviews 服务流量分配给 v2 标签;其余的 75% 流量分配给 1。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Virtualservice
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">75</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">25</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="超时和重试"><a href="#超时和重试" class="headerlink" title="超时和重试"></a>超时和重试</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">reties</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="错误注入"><a href="#错误注入" class="headerlink" title="错误注入"></a>错误注入</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
       <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">10</span>
       <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="条件规则"><a href="#条件规则" class="headerlink" title="条件规则"></a>条件规则</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> productpage
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api/v1
<span class="token punctuation">...</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
<span class="token punctuation">...</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> reviews<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="流量镜像"><a href="#流量镜像" class="headerlink" title="流量镜像"></a>流量镜像</h5><p>mirror 规则可以使 Envoy 截取所有 request 并在转发请求的同时，将request 转发至 Mirror 版本同时在 Header 的 Host/Authority 加上 <code>-shadow</code>。</p>
<p>这些 mirror 请求会工作在 fire and forget 模式所有的 response 都会被废弃</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="规则委托"><a href="#规则委托" class="headerlink" title="规则委托"></a>规则委托</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Virtualservice
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"bookinfo.com"</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"/productpage"</span>
    <span class="token key atrule">delegate</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nsA
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"/reviews"</span>
    <span class="token key atrule">delegate</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nsB
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/vlalpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> <span class="token key atrule">Virtualservicemetadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nsA
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"/productpage/v1/"</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage<span class="token punctuation">-</span>v1.nsA.svc.cluster.local
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage.nsA.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="优先级-1"><a href="#优先级-1" class="headerlink" title="优先级"></a>优先级</h5><p><strong>当对同一目标有多个规则时，会按照在 Virtualservice 中的顺序进行应用，换句话说，列表中的第一条规则具有最高优先级。</strong></p>
<p>当对某个服务的路由是完全基于权重的时候，就可以在单一规则中完成。另一方面，如果有多重条件(例如来自特定用户的请求)用来进行路由，就会需要不止一条规则。这样就出现了优先级问题，需要通过优先级来保证根据正确的顺序来执行规则。</p>
<p>常见的路由模式是提供一或多个高优先级规则，这些优先规则使用源服务以及 Header 来进行路由判断，然后才提供一条单独的基于权重的规则，这些低优先级规则不设置匹配规则，仅根据权重对所有剩余流量进行分流。</p>
<h4 id="目标规则"><a href="#目标规则" class="headerlink" title="目标规则"></a>目标规则</h4><p><strong>在请求被 Virtualservice 路由之后 DestinationRule 配置的一系列策略就生效了</strong>， 这些策略由服务属主编写，包含断路器、负载均衡以及 TLS 等的配置内容。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h5><p><strong>可以用一系列的标准，例如连接数和请求数限制来定义简单的断路器。</strong></p>
<p>可以通过定义 outlierDetection 自定义健康检查模式。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxconnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerconnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutiveErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h4><p><strong>Istio 内部会维护一个服务注册表，可以用 ServiceEntry 向其中加入额外的条目。</strong>通常这个对象用来启用对 Istio 服务网格之外的服务发出请求。</p>
<p>ServiceEntry 中使用 hosts 字段来指定目标，字段值可以是一个完全限定名，也可以是个通配符域名。其中包含的白名单，包含一或多个允许网格中服务访问的服务。</p>
<p><strong>只要 ServiceEntry 涉及到了匹配 host 的服务，就可以和 Virtualservice 以及 DestinationRule 配合工作。</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> serviceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo<span class="token punctuation">-</span>ext<span class="token punctuation">-</span>SVc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token important">*.fo0.com</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="WorkloadEntry"><a href="#WorkloadEntry" class="headerlink" title="WorkloadEntry"></a>WorkloadEntry</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> serviceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> details.bookinfo.com
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_INTERNAL
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> STATIC
  <span class="token key atrule">workloadselector</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> details<span class="token punctuation">-</span>legacy
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkloadEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> details<span class="token punctuation">-</span>legacy
  <span class="token key atrule">address</span><span class="token punctuation">:</span> 2.2.2.2
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> details<span class="token punctuation">-</span>legacy
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> vm1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h4><p><strong>Gateway 为 HTTP/TCP 流量配置了一个负载均衡，多数情况下在网格边缘进行操作，用于启用一个服务的入口(ingress)流量。</strong></p>
<p>和 Kubernetes Ingress 不同，lstio Gateway 只配置四层到六层的功能(例如开放端口或者 TLS 配置)。绑定一个 VirtualService 到 Gateway上，用户就可以使用标准的 Istio 规则来控制进入的 HTTP 和 TCP 流量。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">serverCertificate</span><span class="token punctuation">:</span> /tmp/tls.crt
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /tmp/tls.key
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> bookinfo.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> bookinfo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /reviews
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="开启网关安全加固"><a href="#开启网关安全加固" class="headerlink" title="开启网关安全加固"></a>开启网关安全加固</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
        <span class="token key atrule">serverCertificate</span><span class="token punctuation">:</span> /tmp/tls.crt
        <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /tmp/tls.key
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="遥测-Telemetry-V2"><a href="#遥测-Telemetry-V2" class="headerlink" title="遥测(Telemetry V2)"></a>遥测(Telemetry V2)</h4><p>基本 Metrics</p>
<p>针对 HTTP，HTTP/2 和 GRPC 协议，Istio 收集以下指标:</p>
<ul>
<li>Request count (istio_requests_total) 请总数</li>
<li>Request Duration(istio_request_duration_milliseconds) 请求处理时长</li>
<li>Request Size (istio_request_bytes) 请求包大小</li>
<li>Response Size(istio_response_bytes) 响应包大小</li>
</ul>
<p>针对 TCP 协议, Istio 收集以下指标:</p>
<ul>
<li>Tcp Byte Sent(istio_tcp_sent_bytes_total) 发送的数据响应包的总大小</li>
<li>Tcp Byte Received (istio_tcp_received_bytes_total) 接收到的数据包大小</li>
<li>Tcp Connections Opened(istio_tcp_connections_opened_total) TCP 连接数</li>
<li>Tcp Connections Closed(istio_tcp_connections_closed_total) 关闭的 TCP 连接数</li>
<li>同时支持 WASM(Web Assembly) plugin 收集数据， 但启用 WASM 后资源开销显著上升</li>
</ul>
<h4 id="多集群网格扩展"><a href="#多集群网格扩展" class="headerlink" title="多集群网格扩展"></a>多集群网格扩展</h4><h5 id="基于Gateway"><a href="#基于Gateway" class="headerlink" title="基于Gateway"></a>基于Gateway</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多集群网格扩展基于Gateway.png" alt="多集群网格扩展基于Gateway"></p>
<h5 id="基于-VPN-或可互通的集群"><a href="#基于-VPN-或可互通的集群" class="headerlink" title="基于 VPN 或可互通的集群"></a>基于 VPN 或可互通的集群</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多集群网格扩展基于VPN或可互通的集群.png" alt="多集群网格扩展基于VPN或可互通的集群"></p>
<h3 id="跟踪采样"><a href="#跟踪采样" class="headerlink" title="跟踪采样"></a>跟踪采样</h3><h4 id="跟踪采样配置"><a href="#跟踪采样配置" class="headerlink" title="跟踪采样配置"></a>跟踪采样配置</h4><p><strong>Istio 默认捕获所有请求的跟踪。</strong>例如，何时每次访问时都使用上面的 Bookinfo 示例应用程序/productpage 你在Jaeger 看到了相应的痕迹仪表板。此采样率适用于测试或低流量目。</p>
<ul>
<li>在运行的网格中，编辑 istio-pilot 部署并使用以下步骤更改环境变量:</li>
</ul>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">istioctl upgrade --set values.global.tracer.zipkin.address=jaeger-collector:9411<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="应用程序埋点"><a href="#应用程序埋点" class="headerlink" title="应用程序埋点"></a>应用程序埋点</h4><p><strong>虽然 Istio 代理能够自动发送 Span 信息，但还是需要一些辅助手段来把整个跟踪过程统一起来。</strong> 应用程序应该自行传播跟踪相关的 HTTP Header，这样在代理发送 Span 信息的时候，才能正确的把同一个跟踪过程统一起来。</p>
<p>为了完成跟踪的传播过程，应用应该从请求源头中收集下列的 HTTP Header，并传播给外发请求:</p>
<ul>
<li>x-request-id</li>
<li>x-b3-traceid</li>
<li>x-b3-spanid</li>
<li>x-b3-parentspanid</li>
<li>x-b3-sampled</li>
<li>x-b3-flags</li>
<li>x-ot-span-context</li>
</ul>
<h4 id="分布式跟踪"><a href="#分布式跟踪" class="headerlink" title="分布式跟踪"></a>分布式跟踪</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分布式跟踪.png" alt="分布式跟踪"></p>
<h4 id="Service-Mesh-涉及的网络栈"><a href="#Service-Mesh-涉及的网络栈" class="headerlink" title="Service Mesh 涉及的网络栈"></a>Service Mesh 涉及的网络栈</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ServiceMesh涉及的网络栈.png" alt="ServiceMesh涉及的网络栈"></p>
<h4 id="Cilium-数据平面加速"><a href="#Cilium-数据平面加速" class="headerlink" title="Cilium 数据平面加速"></a>Cilium 数据平面加速</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Cilium数据平面加速.png" alt="Cilium数据平面加速"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><strong>微服务架构是当前业界普遍认可的架构模式，容器的封装性，隔离性为微服务架构的兴盛提供了有力的保障。</strong></p>
<p>Kubernetes 作为声明式集群管理系统，代表了分布式系统架构的大方向:</p>
<ul>
<li>kube-proxy本身提供了基于iptables/ipvs 的四层 Service Mesh 方案;</li>
<li>Istio/linkerd 作为基于 Kubernetes 的七层 Service Mesh 方案，近期会有比较多的生产部署案例。</li>
</ul>
<p>生产系统需要考虑的，除了 Service Mesh 架构带来的便利性，还需要考虑:</p>
<ul>
<li>配置一致性检查;</li>
<li>endpoint健康检查,</li>
<li>海量转发规则情况下的 scalability。</li>
</ul>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>把我们的 httpserver 服务以 Istio Ingress Gateway 的形式发布出来。以下是你需要考虑的几点:</p>
<ul>
<li>如何实现安全保证;</li>
<li>七层路由规则;</li>
<li>考虑 open tracing 的接入。</li>
</ul>
<h2 id="Kubernetes-集群联邦和-Istio-多集群管理"><a href="#Kubernetes-集群联邦和-Istio-多集群管理" class="headerlink" title="Kubernetes 集群联邦和 Istio 多集群管理"></a>Kubernetes 集群联邦和 Istio 多集群管理</h2><ol>
<li><p>分布式云是未来</p>
<ul>
<li>成本优化(Cost Effective)</li>
<li>更好的弹性及灵活性(Elasticity&amp; Flexibility)</li>
<li>避免厂商锁定(Avoid Vendor Lock-in)</li>
<li>第一时间获取云上的新功能(Innovation)</li>
<li>容灾(Resilience&amp;Recovery)</li>
<li>数据保护及风险管理(Data Protection&amp;Risk Management)</li>
<li>提升响应速度(NetworkPerformancelmprovements)</li>
</ul>
</li>
<li><p>分布式云的挑战</p>
<ul>
<li>Kubernetes 单集群承载能力有限</li>
<li>异构的基础设施</li>
<li>存量资源接入</li>
<li>配置变更及下发</li>
<li>跨地域、跨机房应用部署及管理</li>
<li>容灾与隔离性，异地多活</li>
<li>弹性调度及自动伸缩</li>
<li>监控告警</li>
</ul>
</li>
<li><p>如何应对</p>
<ul>
<li>通过 Kubernetes 屏蔽底层基础设施，提供统一的接入层</li>
<li>多云架构<ul>
<li>多集群 ≠ 多云。</li>
<li>多集群管控</li>
</ul>
</li>
<li>统一的管控面</li>
<li>方便接入，降低使用门槛</li>
</ul>
</li>
<li><p>跨地域的集群管理</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/跨地域的集群管理.png" alt="跨地域的集群管理"></p>
</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> region
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> beijing
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> topology.kubernetes.io/zone
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>app
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9376</span>
  <span class="token key atrule">topologyKeys</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> topology.kubernetes.io/zone
  <span class="token punctuation">-</span> topology.kubernetes.io/region<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="集群联邦"><a href="#集群联邦" class="headerlink" title="集群联邦"></a>集群联邦</h3><h4 id="集群联邦的必要性"><a href="#集群联邦的必要性" class="headerlink" title="集群联邦的必要性"></a>集群联邦的必要性</h4><p>单一集群的管理规模有上限</p>
<ul>
<li><p>数据库存储</p>
<ul>
<li>etcd 作为 Kubernetes 集群的后端存储数据库，对空间大小的要求比较苛刻，这限制了集群能存储的对象数量和大小。</li>
</ul>
</li>
<li><p>内存占用</p>
<ul>
<li>为提高系统效率，Kubernetes 的 APIServer 作为 API 网关，会对该集群的所有对象做缓存。集群越大，缓存需要的内存空间就越大。</li>
<li>其他 Kubernetes 控制器也需要对侦听的对象构建客户端缓存，这些都需要占用系统内存。这些内存需求都要求对系统的规模有所限制。</li>
</ul>
</li>
<li><p>控制器复杂度</p>
<ul>
<li>Kubernetes 的一个业务流程是由多个对象和控制器联动完成的，即使控制器遵循了设计原则，随着对象数量的增长，控制器的处理耗时也会越来越长，</li>
</ul>
</li>
</ul>
<p>单个计算节点资源上限</p>
<ul>
<li>单个计算节点的资源，不仅仅是 CPU、内存等可量化资源，</li>
<li>还有端口、进程数量等不可量化资源。比如 Linux 支持的TCP 端口上限是 65535，去除常用端口和程序源端口后，留给 Service nodePort 的端口数量是有限的，这限制了集群支持的 Service 的数量。</li>
</ul>
<p>故障域控制</p>
<ul>
<li>集群规模越大，控制平面组件出现故障时的影响范围就越大。为了更好地控制故障域(FaultDomain)，需要将大规模的数据中心切分成多个规模相对较小的集群，每个集群控制在一定规模。</li>
</ul>
<p>应用高可用部署</p>
<ul>
<li>生产应用通常需要多数据中心部署来保障跨地域高可用，以确保当其中一个数据中心出现故障，或者集群做技术迭代更新时，其他数据中心可以继续提供服务。</li>
</ul>
<p>混合云</p>
<ul>
<li>私有云加公有云的混合云模式逐渐成为企业的主流架构。</li>
</ul>
<h4 id="集群联邦的职责"><a href="#集群联邦的职责" class="headerlink" title="集群联邦的职责"></a>集群联邦的职责</h4><p>跨集群同步资源</p>
<ul>
<li>联邦可以将资源同步到多个集群并协调资源的分配。例如，联邦可以保证一个应用的Deployment 被部署到多个集群中，同时能够满足全局的调度策略。</li>
</ul>
<p>跨集群服务发现</p>
<ul>
<li>联邦汇总各个集群的服务和 Ingress，并暴露到全局 DNS 服务中。</li>
</ul>
<p>高可用</p>
<ul>
<li>联邦可以动态地调整每个集群的应用实例，且隐藏了具体的集群信息。</li>
</ul>
<p>避免厂商锁定</p>
<ul>
<li>每个集群都是部署在真实的硬件或云供应商提供的硬件(或虚拟硬件)之上的，若要更换供应商，只需在新供应商提供的硬件上部署新的集群，并加入联邦。联邦可以几乎透明地将应用从原集群迁移到新集群而无须对应用做更改。</li>
</ul>
<h4 id="混合云"><a href="#混合云" class="headerlink" title="混合云"></a>混合云</h4><p>混合云是指将公有云和私有云整合在一起的统一云平台。</p>
<p>用户业务可灵活部署或扩容在不同云中。</p>
<p>混合云避免厂商锁定。</p>
<p>混合云可支持更多复杂业务场景:</p>
<ul>
<li>Cloud Burst.</li>
<li>如 12306，低流量时运行在本地数据中心，当请求量突然爆发的时候，可以直接在公有云扩容，节省数据中心成本。</li>
<li>可将业务分为包含敏感数据和不包含敏感数据的业务，将敏感数据业务运行在私有云，将非敏感数据业务运行在公有云，</li>
<li>可重复利用公有云提供商数据中心靠近边缘的能力。</li>
</ul>
<h4 id="集群联邦-1"><a href="#集群联邦-1" class="headerlink" title="集群联邦"></a>集群联邦</h4><p>集群联邦(Federation)是将多个Kubernetes 集群注册到统一控制平面为用户提供统一 API 入口的多集群解决方案。</p>
<p>集群联邦设计的核心是提供在全局层面对应用的描述能力，并将联邦对象实例化为 Kubernetes 对象，分发到联邦下辖的各个成员集群中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群联邦.png" alt="集群联邦"></p>
<h4 id="基于集群联邦的高可用应用部署"><a href="#基于集群联邦的高可用应用部署" class="headerlink" title="基于集群联邦的高可用应用部署"></a>基于集群联邦的高可用应用部署</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于集群联邦的高可用应用部署.png" alt="基于集群联邦的高可用应用部署"></p>
<h4 id="集群联邦核心架构"><a href="#集群联邦核心架构" class="headerlink" title="集群联邦核心架构"></a>集群联邦核心架构</h4><p>etcd 作为分布式存储后端存储所有对象</p>
<p>APIServer作为 API网关，接收所有来自用户及控制平面组件的请求</p>
<p>不同的控制器对联邦层面的对象进行管理协调等</p>
<p>调度控制器在联邦层面对应用进行调度分配。</p>
<p>集群联邦支持灵活的对象扩展，允许将基本 Kubernetes 对象扩展为集群联邦对象并通过统一的联邦控制器推送和收集状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群联邦核心架构.png" alt="集群联邦核心架构"></p>
<h4 id="集群联邦管理的对象"><a href="#集群联邦管理的对象" class="headerlink" title="集群联邦管理的对象"></a>集群联邦管理的对象</h4><p>成员集群是联邦的基本管理单元，所有待管理集群均须注册到集群联邦。</p>
<p>集群联邦 V2 提供了统一的工具集(Kubefedctl)，允许用户对单个对象动态地创建联邦对象。</p>
<p>动态对象的生成基于 CRD。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群联邦管理的对象.png" alt="集群联邦管理的对象"></p>
<h4 id="集群注册中心"><a href="#集群注册中心" class="headerlink" title="集群注册中心"></a>集群注册中心</h4><p>集群注册中心(ClusterRegistry)提供了所有联邦下辖的集群清单，以及每个集群的认证信息状态信息等。</p>
<p>集群联邦本身不提供算力，它只承担多集群的协调工作，所有被管理的集群都应注册到集群联邦中。</p>
<p>集群联邦使用了单独的 KubeFedCluster 对象(同样适用 CRD 来定义)来管理集群注册信息:</p>
<ul>
<li>在该对象的定义中，不仅包含集群的注册信息，还包含集群的认证信息的引用，以明确每个集群使用的认证信息;</li>
<li>该对象还包含各个集群的健康状态、域名等,</li>
<li>当控制器行为出现异常时，直接通过集群状态信息即可获知控制器异常的原因。</li>
</ul>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p><a target="_blank" rel="noopener" href="https://github.com/kibaamor/101/blob/master/module13/federation/readme.MD">https://github.com/kibaamor/101/blob/master/module13/federation/readme.MD</a></p>
<p>下载 federation 代码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/kubernetes-sigs/kubefed.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>选择 HostCluster，确认 kubeconfig 符合federation 命名规范，用 vi 编辑 <code>kubeconfig</code>，确保 context属性没用 @ 字符;</p>
<p><code>vi ~/.kube/config</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span> kubernetes
  <span class="token key atrule">user</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>admin
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster1
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> cluster1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装</p>
<pre class="line-numbers language-none"><code class="language-none">cd kubefed/
./scripts/deploy-kubefed-latest.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>安装完成后，相关资源均可在 <code>kube-federation-system</code> 查看。</p>
<h4 id="集群类型"><a href="#集群类型" class="headerlink" title="集群类型"></a>集群类型</h4><p>Host:</p>
<ul>
<li>用于提供 KubeFed AP|与控制平面的集群，本质上就是 Federation 控制面。</li>
</ul>
<p>Member:</p>
<ul>
<li>通过 KubeFed API注册的集群，并提供相关身份凭证来让 KubeFed controler 能够存取集群,Host集群也可以作为 Member被加入。</li>
</ul>
<h4 id="注册集群-KubeFedCluster"><a href="#注册集群-KubeFedCluster" class="headerlink" title="注册集群 KubeFedCluster"></a>注册集群 KubeFedCluster</h4><p>用来定义哪些 Kubernetes 集群要被联邦。</p>
<p>可透过 <code>kubefedctl join/unjoin</code> 来加入/删除集群当成功加入时，会建立一个 KubeFedCluster 组件来储存集群相关信息，如 APIEndpoint、CA Bundle 等,</p>
<p>这些信息会被用在 KubeFedController 存取不同 Kubernetes 集群上，以确保能够建立 Kubernetes API资源。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/注册集群KubeFedCluster.png" alt="注册集群KubeFedCluster"></p>
<h5 id="KubeFedCluster"><a href="#KubeFedCluster" class="headerlink" title="KubeFedCluster"></a>KubeFedCluster</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> core.kubefed.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeFedCluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"cluster1"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiEndpoint</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//APServer.cluster1.example.com
  caBundle<span class="token punctuation">:</span>LSOtLS<span class="token important">****LSOK</span>
  <span class="token key atrule">disabledTLsValidations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'*'</span>
  <span class="token key atrule">secretRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster1<span class="token punctuation">-</span>vhvfw
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reason<span class="token punctuation">:</span>ClusterReady
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready
  <span class="token key atrule">region</span><span class="token punctuation">:</span> China
  <span class="token key atrule">zones</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/KubeFedCluster.png" alt="KubeFedCluster"></p>
<h4 id="Federation-支持的核心对象"><a href="#Federation-支持的核心对象" class="headerlink" title="Federation 支持的核心对象"></a>Federation 支持的核心对象</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Federation支持的核心对象.png" alt="Federation支持的核心对象"></p>
<h5 id="Type-Configuration"><a href="#Type-Configuration" class="headerlink" title="Type Configuration"></a>Type Configuration</h5><p>定义了哪些 Kubernetes API 资源要被用于联邦管理。</p>
<p>若想新增 Federated API 的话，可通过 <code>kubefedctl enable &lt;res&gt;</code> 指令来建立</p>
<p>比如说想将 ConfigMap 资源通过联邦机制建立在不同集群上时，就必须先在 Federation Host 集群中，通过 CRD 建立新资源 FederatedconfigMap，接着再建立名称为configmaps 的Type configuration(FederatedTypeConfig)资源，然后描述 ConfigMap 要被 FederatedconfigMap 所管理</p>
<p>这样 KubeFed controllers 才能知道如何建立 Federated 资源。</p>
<h5 id="FederatedConfigMap"><a href="#FederatedConfigMap" class="headerlink" title="FederatedConfigMap"></a>FederatedConfigMap</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">k get crd federatedconfigmaps.types.kubefed.io
NAME                                    CREATED AT
federatedconfigmaps.types.kubefed.io    <span class="token number">2021</span>-09-13T10:10:03Z<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> core.kubefed.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> FederatedTypeConfig
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmaps
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">federatedType</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> types.kubefed.io
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> FederatedConfigMap
    <span class="token key atrule">pluralName</span><span class="token punctuation">:</span> federatedconfigmaps
    <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
    <span class="token key atrule">version</span><span class="token punctuation">:</span> vlbeta1
  <span class="token key atrule">propagation</span><span class="token punctuation">:</span> Enabled
<span class="token key atrule">targetType</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
  <span class="token key atrule">pluralName</span><span class="token punctuation">:</span> configmaps
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="联邦对象组成"><a href="#联邦对象组成" class="headerlink" title="联邦对象组成"></a>联邦对象组成</h4><p>Template: 定义 Kubernetes 对象的模板</p>
<p>Placement: 定义联邦对象需要被同步的目标集群。</p>
<p>Overrides: 不同目标集群中，对 Kubernetes 对象模板的本地化属性</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/联邦对象组成.png" alt="联邦对象组成"></p>
<h5 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h5><p>Template 是联邦对象中定义 Kubernetes集群对象的模板部分，它的内容为完整的Kubernetes 对象。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> types.federation.k8s.io/vlalpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> FederatedDeployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample<span class="token punctuation">-</span>federated<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">placement</span><span class="token punctuation">:</span>
  <span class="token comment">#...</span>
  <span class="token key atrule">overrides</span><span class="token punctuation">:</span>
  <span class="token comment">#...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h5><p>Placement用来配置联邦对象的目标集群，其值可以是具体的集群名单，也可以是 clusterseletor 选择对应标签(label)的集群。</p>
<p>当两者同时存在时，明确定义的集群名单具有较高优先级</p>
<p>联邦根据优先级来定义要同步对象的目标集群，如果提供了集群名单(哪怕是一个空 List)，则无论 clusterselector提供什么内容，都会被忽略。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> types.federation.k8s.io/vlalpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> FederatedDeployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> sample
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token comment">#...</span>
  <span class="token key atrule">placement</span><span class="token punctuation">:</span>
    <span class="token key atrule">clusters</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster1
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster2
  <span class="token key atrule">clusterSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">region</span><span class="token punctuation">:</span> china
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> shanghai
  <span class="token key atrule">overrides</span><span class="token punctuation">:</span>
  <span class="token comment">#...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Overrides"><a href="#Overrides" class="headerlink" title="Overrides"></a>Overrides</h5><p>Overrides 用于针对每个集群进行本地化定制。</p>
<p>在实际部署应用时，通常会通过调整不同集群中的配置模板，部署符合特定集群需求的应用，以更好地发挥网络、计算资源、存储等的优势。</p>
<p>目前 Overrides 不支持 List(Array)。比如说无法修改 <code>spec.template.spec.containers0].image</code></p>
<p>Q: 思考一下为什么?</p>
<p>A: 数值可能会变。比如顺序变了、大小变了等。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> types.federation.k8s.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> FederatedDeployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>
  <span class="token key atrule">placement</span><span class="token punctuation">:</span>
    <span class="token key atrule">clusters</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster1
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster2
  <span class="token key atrule">overrides</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">clusterName</span><span class="token punctuation">:</span> cluster2
    <span class="token key atrule">clusterOverrides</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/replicas
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="使用-Federated-对象"><a href="#使用-Federated-对象" class="headerlink" title="使用 Federated 对象"></a>使用 Federated 对象</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">将 Namespace 设置为联邦对象
kubefedctl federate ns default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="联邦调度"><a href="#联邦调度" class="headerlink" title="联邦调度"></a>联邦调度</h4><p>KubeFed 提供了一种自动化机制来将工作负载实例分散到不同的集群中，这能够基于总副本数与集群的定义策略来将Deployment或 Replicaset 资源进行编排。</p>
<p>编排策略是通过建立ReplicaSchedulingPreference(RSP)文件，再由 KubeFed RSP Controller监听与撷取 RSP 内容来将工作负载实例建立到指定的集群上。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/联邦调度.png" alt="联邦调度"></p>
<h4 id="多集群-DNS"><a href="#多集群-DNS" class="headerlink" title="多集群 DNS"></a>多集群 DNS</h4><p>KubeFed 提供了一组 API 资源，以及 Controllers 来实现跨集群 Service/ingress 的 DNSrecords 自动产生机制。</p>
<p>需要结合 ExternalDNS 来同步更新至 DNS 服务供应商</p>
<p>在 2020 年被移出，这里提供一个 DNS 接入的思路。</p>
<blockquote>
<p>Kubefed v2 should be only focused on the federation of resources across kubefedclusters. In the Kubernetes ecosystem there are other third party tools (such as servicemeshes) that already provide support to the DNs based federated ingress.</p>
</blockquote>
<h5 id="ServiceDNSRecord-原理"><a href="#ServiceDNSRecord-原理" class="headerlink" title="ServiceDNSRecord 原理"></a>ServiceDNSRecord 原理</h5><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ServiceDNSRecord原理.png" alt="ServiceDNSRecord原理"></p>
<h3 id="Clusternet"><a href="#Clusternet" class="headerlink" title="Clusternet"></a>Clusternet</h3><h4 id="Clusternet简介"><a href="#Clusternet简介" class="headerlink" title="Clusternet简介"></a>Clusternet简介</h4><p>Clusternet(Cluster Internet)是一个兼具多集群管理和跨集群应用编排的开源云原生管控平台打通了跨 VPC、跨地域、跨云的集群管理。</p>
<p>Clusternet 面向未来混合云、分布式云和边缘计算场景设计，支持海量集群的接入和管理。Clusternet 在保证无侵入且轻量化的基础上，创建了一张集群网络，对子集群进行纳管，并支持多集群的应用编排与治理。</p>
<p>开源项目地址: <a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet">https://github.com/clusternet/clusternet</a></p>
<ul>
<li>最新版本 v0.6.0</li>
<li>多平台支持: linux/amd64,linux/arm64, linux/ppc64le,linux/s390x,linux/386linux/arm</li>
</ul>
<h4 id="Clusternet-能力一览"><a href="#Clusternet-能力一览" class="headerlink" title="Clusternet 能力一览"></a>Clusternet 能力一览</h4><ul>
<li>统一管控各类 Kubernetes 集群;</li>
<li>集群管理 Pull/ Push 模式;</li>
<li>轻量化，开箱即用，易于部署和维护;</li>
<li>跨集群的服务发现及服务互访，</li>
<li>Kubernetes 原生，没有额外的学习成本</li>
<li>完善的 RBAC 能力，访问任一子集群;</li>
<li>完善的接入能力: kubectl plugin/client-go;</li>
<li>支持分发各类原生应用/CRD/Helmchart。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Clusternet能力一览.png" alt="Clusternet能力一览"></p>
<h4 id="多集群管理的挑战"><a href="#多集群管理的挑战" class="headerlink" title="多集群管理的挑战"></a>多集群管理的挑战</h4><ul>
<li>集群无处不在</li>
<li>公有云、私有云、混合云、边缘、裸金属</li>
<li>提供一致的纳管能力</li>
<li>集群一键注册能力</li>
<li>一致性的集群访问体验，比如 exec，logs</li>
<li>权限管控 RBAC</li>
<li>架构要足够轻量化，方便一键接入</li>
</ul>
<h4 id="Clusternet-架构"><a href="#Clusternet-架构" class="headerlink" title="Clusternet 架构"></a>Clusternet 架构</h4><ul>
<li>最轻量化的架构</li>
<li>一站式连接各类集群</li>
<li>支持 Pull 和 Push 模式</li>
<li>跨集群路由访问</li>
<li>支持子集群 RBAC 访问</li>
<li>提供一致的集群访问体验，比如 exec，logs</li>
<li>原生 Kubernetes API</li>
<li>接入成本低，kubectl plugin/client-go</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Clusternet架构.png" alt="Clusternet架构"></p>
<h4 id="如何通过-Clusternet-访问任一子集群"><a href="#如何通过-Clusternet-访问任一子集群" class="headerlink" title="如何通过 Clusternet 访问任一子集群"></a>如何通过 Clusternet 访问任一子集群</h4><p>Clusternet支持通过 Bootstrap Token，Service Token，TLS 证书等 RBAC的方式访问子集群;</p>
<blockquote>
<p>子集群的 credential 信息不需要存在父集群中</p>
</blockquote>
<p>也支持通过 kubectl命令行的方式对子集群进行 create/get/list/watch/patch/exec 等操作。</p>
<p>更详细步骤及功能可以参照 <a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet/blob/main/docs/tutorials/visiting-child-clusters-with-rbac.md">https://github.com/clusternet/clusternet/blob/main/docs/tutorials/visiting-child-clusters-with-rbac.md</a></p>
<ul>
<li>使用 curl 进行访问</li>
<li>通过 kubectl 进行访问</li>
</ul>
<h4 id="Clusternet应用分发设计"><a href="#Clusternet应用分发设计" class="headerlink" title="Clusternet应用分发设计"></a>Clusternet应用分发设计</h4><ul>
<li>完全兼容 Kubernetes 的内置 API</li>
<li>支持 Helm Charts</li>
<li>支持 CRD</li>
<li>丰富灵活的分发策略配置、差异化策略</li>
</ul>
<h4 id="应用分发的差异化痛点"><a href="#应用分发的差异化痛点" class="headerlink" title="应用分发的差异化痛点"></a>应用分发的差异化痛点</h4><ol>
<li>在分发的资源上全部打上统一的标签，比如 apps.my.company/deployed-by: myplatform;</li>
<li>在分发到子集群的资源上标记集群的信息，比如 apps.my.company/running-in:cluster-01’</li>
<li>调整应用在每个集群中的副本数目、镜像名称等;</li>
<li>在分发到某集群前，调整应用在该集群中的一些配置，比如注入一个Sidecar 容器等,</li>
<li>灰度升级，变更可控，方便回滚;</li>
<li>重复定义怎么办?冲突吗?</li>
<li>…</li>
</ol>
<h4 id="Clusternet-应用分发模型"><a href="#Clusternet-应用分发模型" class="headerlink" title="Clusternet 应用分发模型"></a>Clusternet 应用分发模型</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Clusternet应用分发模型.png" alt="Clusternet应用分发模型"></p>
<h4 id="如何创建一个资源"><a href="#如何创建一个资源" class="headerlink" title="如何创建一个资源"></a>如何创建一个资源</h4><p>kubectl 插件 kubectl-clusternet</p>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl krew update
$ kubectl krew install clusternet
# check plugin version
$ kubectl clusternet version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 client-go wrapper</p>
<ul>
<li>一键接入，无需改造</li>
<li>兼容 client-go 各个版本</li>
<li>示例: <a target="_blank" rel="noopener" href="https://github,com/clusternet/clusternet/blob/main/examples/clientgO/READEME.md">https://github,com/clusternet/clusternet/blob/main/examples/clientgO/READEME.md</a></li>
</ul>
<h5 id="示例-声明多集群应用-Subscription"><a href="#示例-声明多集群应用-Subscription" class="headerlink" title="示例:声明多集群应用 Subscription"></a>示例:声明多集群应用 Subscription</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.clusternet.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Subscription
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>demo
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">subscribers</span><span class="token punctuation">:</span> <span class="token comment">#defines the clusters to be distributed to</span>
  <span class="token punctuation">-</span> <span class="token key atrule">clusterAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        clusters.clusternet<span class="token punctuation">,</span><span class="token key atrule">io/cluster-id</span><span class="token punctuation">:</span> dc91021d<span class="token punctuation">-</span>2361<span class="token punctuation">-</span>4f6d<span class="token punctuation">-</span>a404<span class="token punctuation">-</span>7c33b9e01118
  <span class="token key atrule">feeds</span><span class="token punctuation">:</span> <span class="token comment"># defines all the resources to be deployed with</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.clusternet.io/v1alpha1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmChart
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
    <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
    <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>svc
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> fo0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="示例-差异化策略Localization-Globalization"><a href="#示例-差异化策略Localization-Globalization" class="headerlink" title="示例:差异化策略Localization/Globalization"></a>示例:差异化策略Localization/Globalization</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.clusternet.io/vlalpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Localization
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>local<span class="token punctuation">-</span>overrides<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>lower<span class="token punctuation">-</span>priority
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> clusternet<span class="token punctuation">-</span><span class="token number">51821</span> <span class="token comment"># PLEASE UPDATE THIS TO YOUR Managedcluster NAMESPACE!! !</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># Priority is an integer defining the relative importance of this Localization compared to others</span>
  <span class="token comment"># Lower numbers are considered lower priority.</span>
  <span class="token comment"># Override values in lower Localization will be overridden by those in higher Localization.</span>
  <span class="token comment">#(0ptional)Default priority is 500.</span>
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">feed</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
  <span class="token key atrule">overrides</span><span class="token punctuation">:</span> <span class="token comment"># defines all the overrides to be processed with</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add<span class="token punctuation">-</span>update<span class="token punctuation">-</span>labels
    <span class="token key atrule">type</span><span class="token punctuation">:</span> MergePatch
    <span class="token comment"># Value is a YAML/JSON format patch that provides MergePatch to current resource defined by feed.</span>
    <span class="token comment"># This override adds or updates some labels.</span>
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'{"metadata": {"labels": {"deployed-in-cluster":"clusternet-5l82l"}}}'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> scale<span class="token punctuation">-</span>replicas
    <span class="token key atrule">type</span><span class="token punctuation">:</span> JSONPatch
    <span class="token comment"># Value is a YAML/JSON format patch that provides JSONPatch to current resource defined by feed</span>
    <span class="token comment"># This patch sets replicas to 1.</span>
    <span class="token comment"># But due to lower priority, this value will be overridden by above "nginx-local-overrides-demo-higher-priority" eventually</span>
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
        <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token key atrule">"path"</span><span class="token punctuation">:</span> <span class="token string">"/spec/replicas"</span><span class="token punctuation">,</span>
            "value"<span class="token punctuation">:</span><span class="token number">1</span>
            <span class="token key atrule">"op"</span><span class="token punctuation">:</span> <span class="token string">"replace"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="更多示例"><a href="#更多示例" class="headerlink" title="更多示例"></a>更多示例</h5><p>注册一个集群 <a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet/blob/main/docs/tutorials/installing.clusternet-with-helm.md">https://github.com/clusternet/clusternet/blob/main/docs/tutorials/installing.clusternet-with-helm.md</a></p>
<p>部署一个完整的多集群应用 <a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet/blob/main/docs/tutorials/deploying-applications-to-multiple-clusters.md">https://github.com/clusternet/clusternet/blob/main/docs/tutorials/deploying-applications-to-multiple-clusters.md</a></p>
<p>如何使用 client-go 创建多集群应用 <a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet/blob/main/examples/clientgo/READEMEmd">https://github.com/clusternet/clusternet/blob/main/examples/clientgo/READEMEmd</a></p>
<h3 id="Istio-多集群"><a href="#Istio-多集群" class="headerlink" title="Istio 多集群"></a>Istio 多集群</h3><h4 id="跨地域流量管理的挑战"><a href="#跨地域流量管理的挑战" class="headerlink" title="跨地域流量管理的挑战"></a>跨地域流量管理的挑战</h4><p>采用多活数据中心的网络拓扑，任何生产应用都需要完成跨三个数据中心的部署。</p>
<p>为满足单集群的高可用，针对每个数据中心，任何应用都需进行多副本部署，并配置负载均衡。</p>
<p>以实现全站微服务化，但为保证高可用服务之间的调用仍以南北流量为主。</p>
<p>针对核心应用，除集群本地负载均衡配置以外，还需配置跨数据中心负载均衡并通过权重控制将 99% 的请求转入本地数据中心，将1%的流量转向跨地域的数据中心。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/跨地域流量管理的挑战.png" alt="跨地域流量管理的挑战"></p>
<h4 id="规模化带来的挑战"><a href="#规模化带来的挑战" class="headerlink" title="规模化带来的挑战"></a>规模化带来的挑战</h4><p>3 主数据中心，20 边缘数据中心，100+Kubernetes 集群</p>
<p>规模化运营 Kubernetes 集群</p>
<ul>
<li>总计 100,000 物理节点</li>
<li>单集群物理机节点规模高达5,000</li>
</ul>
<p>业务服务全面容器化，单集群</p>
<ul>
<li>Pod 实例可达 100,000</li>
<li>发布服务 5,000-10000</li>
</ul>
<p>单集群多环境支持</p>
<ul>
<li>功能测试、集成测试、压力测试共用单集群</li>
<li>不同环境需要彼此隔离</li>
</ul>
<p>异构应用</p>
<ul>
<li>云业务，大数据，搜索服务</li>
<li>多种应用协议</li>
<li>灰度发布</li>
</ul>
<p>日益增长的安全需求</p>
<ul>
<li>全链路 TLS</li>
</ul>
<p>可见性需求</p>
<ul>
<li>访问日志</li>
<li>Tracing</li>
</ul>
<h4 id="多集群部署"><a href="#多集群部署" class="headerlink" title="多集群部署"></a>多集群部署</h4><p>Kubernetes 集群联邦</p>
<ul>
<li>集群联邦 APIServer作为用户访问 Kubernetes 集群入口</li>
<li>所有 Kubernetes 集群注册至集群联邦</li>
</ul>
<p>可用区</p>
<ul>
<li>数据中心中具有独立供电制冷设备的故障域</li>
<li>同一可用区有较小网络延迟</li>
<li>同一可用区部署了多个 Kubernetes 集群</li>
</ul>
<p>多集群部署</p>
<ul>
<li>同一可用区设定一个网关集群</li>
<li>网关集群中部署 lstio Primary</li>
<li>同一可用区的其他集群中部署 lstio Remote</li>
<li>所有集群采用相同 RootCA</li>
<li>相同环境 TrustDomain 相同</li>
</ul>
<p>东西南北流量统一管控</p>
<ul>
<li>同一可用区的服务调用基于 Sidecar</li>
<li>跨可用区的服务调用基于Istio Gateway</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/多集群部署.png" alt="多集群部署"></p>
<h4 id="入站流量架构-L4-L7"><a href="#入站流量架构-L4-L7" class="headerlink" title="入站流量架构 L4+L7"></a>入站流量架构 L4+L7</h4><p>为不同应用配置独立的网关服务以方便网络隔离。</p>
<p>基于IPVS/xDP 的 Service controller:</p>
<ul>
<li>四层网关调度;</li>
<li>虚拟 IP 地址分配;</li>
<li>基于 IPIP 协议的转发规则配置，</li>
<li>基于 BGP 的 IP 路由宣告,</li>
<li>在 Ingress Pod 中配置 Tunnel 设备并绑定虚拟 IP 地址以卸载 IPIP 包。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/入站流量架构.png" alt="入站流量架构"></p>
<h4 id="单网关集群多环境支持"><a href="#单网关集群多环境支持" class="headerlink" title="单网关集群多环境支持"></a>单网关集群多环境支持</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/单网关集群多环境支持.png" alt="单网关集群多环境支持"></p>
<h4 id="应用高可用接入方案"><a href="#应用高可用接入方案" class="headerlink" title="应用高可用接入方案"></a>应用高可用接入方案</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/应用高可用接入方案.png" alt="应用高可用接入方案"></p>
<h4 id="为应用发布服务"><a href="#为应用发布服务" class="headerlink" title="为应用发布服务"></a>为应用发布服务</h4><p>定义 LoadBalancer Type Service，提供集群外可访问的 LoadBalancerIP.</p>
<p>其他集群可通过定义 WorkloadEntry 指向该 LoadBalancerlP，以实现故障转移目的。</p>
<h5 id="创建-WorkloadEntry"><a href="#创建-WorkloadEntry" class="headerlink" title="创建 WorkloadEntry"></a>创建 WorkloadEntry</h5><p>创建 WorkloadEntry 指向其他数据中心 LoadBalancerIP</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> WorkloadEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> foo.bar.svc.cluster2
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> foo
  <span class="token key atrule">locality</span><span class="token punctuation">:</span> region1/zone1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="定义-ServiceEntry"><a href="#定义-ServiceEntry" class="headerlink" title="定义 ServiceEntry"></a>定义 ServiceEntry</h5><p>同时选择 WorkloadEntry 和本地 Pod。</p>
<p>ServiceEntry 对象可以将本地 Pod 和具有相同 Label的 WorkloadEntry定义成相同的Envoy Cluster。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> foo.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>default
    <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> STATIC
  <span class="token key atrule">workloadselector</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="在-VirtualService-中引用-ServiceEntry"><a href="#在-VirtualService-中引用-ServiceEntry" class="headerlink" title="在 VirtualService 中引用 ServiceEntry"></a>在 VirtualService 中引用 ServiceEntry</h5><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> foo
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> foo.com
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">route</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> foo.com
      <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>default
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="为-workload-添加-Locality-信息"><a href="#为-workload-添加-Locality-信息" class="headerlink" title="为 workload 添加 Locality 信息"></a>为 workload 添加 Locality 信息</h5><p>Istio 从如下配置中读取，基于这些配置，我们可以为lstio 中运行的所有 workload 添加地域属性。</p>
<p>Kubernetes Node 对象中的地域信息，所有 Pod 自动继承该 Locality 信息</p>
<ul>
<li>region: topology.kubernetes.io/region</li>
<li>zone: topology.kubernetes.io/zone</li>
<li>subzone: topology.istio.io/subzone</li>
</ul>
<p>Kubernetes Pod 的 istio-locality 标签，可覆盖节点 Locality 信息</p>
<ul>
<li>istio-locality:”region/zone/subzone”</li>
</ul>
<p>WorkloadEntry 的 Locality 属性</p>
<ul>
<li>locality:region/zone/subzone</li>
</ul>
<h5 id="定义基于-Locality-的流量转发规则"><a href="#定义基于-Locality-的流量转发规则" class="headerlink" title="定义基于 Locality 的流量转发规则"></a>定义基于 Locality 的流量转发规则</h5><p>Distribute</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">localityLbsetting</span><span class="token punctuation">:</span>
        <span class="token key atrule">distribute</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">"*/*"</span>
          <span class="token key atrule">to</span><span class="token punctuation">:</span>
            <span class="token key atrule">region1/zone1/*</span><span class="token punctuation">:</span> <span class="token number">99</span>
            <span class="token key atrule">region2/zone2/*</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
          <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 10s
          <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">100</span>
          <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> ISTIO_MUTUAL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Failover</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">localityLbsetting</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">failover</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region1/zone1
          <span class="token key atrule">to</span><span class="token punctuation">:</span> region2/zone2
        <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
          <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 10m
          <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">interval</span><span class="token punctuation">:</span> 2s
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    mode<span class="token punctuation">:</span>ISTIO_MUTUAL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="应对规模化集群挑战"><a href="#应对规模化集群挑战" class="headerlink" title="应对规模化集群挑战"></a>应对规模化集群挑战</h4><p>Istio xDs 默认发现集群中所有的配置和服务状态，在超大规模集群中，lstiod 或者 Envoy 都承受比较大的压力。</p>
<ul>
<li>集群中的有 10000 Service，每个Service 开放 80 和 443 两个端口，lstio 的 CDS 会 discover出 20000 个 Envoy Cluster。</li>
<li>如果开启多集群，Istio 还会为每个 cluster 创建符合域名规范的集群。</li>
<li>Istio 还需要发现 remote cluster 中的 Service，Endpoint和 Pod 信息，而这些信息的频繁变更，会导致网络带宽占用和控制面板的压力都很大。</li>
</ul>
<p>meshconfig 中控制可见性:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">defaultServiceExportTo</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token string">"."</span>
<span class="token key atrule">defaultVirtualServiceExportTo</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token string">"."</span>
<span class="token key atrule">defaultDestinationRuleExportTo</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token string">"."</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 Istio 对象中的 exportTo 属性覆盖默认配置。</p>
<h4 id="Istiod-自身的规模控制"><a href="#Istiod-自身的规模控制" class="headerlink" title="Istiod 自身的规模控制"></a>Istiod 自身的规模控制</h4><p>社区新增加了 discoverySelector 的支持，允许 Istiod 只发现添加了特定 label的 namespaces下的 lstio 以及 Kubernetes 对象</p>
<p>但因为 Kubernetes 框架的限制，改功能依然要让 lstiod 接收所有配置和状态变更新细，并且在Istiod 中进行对象过滤。在超大集群规模中，并未降低网络带宽占用和 lstiod 的处理压力。</p>
<p>需要继续寻求从 Kubernetes Server端过滤的解决方案。</p>
<h4 id="基于联邦的统一流量模型"><a href="#基于联邦的统一流量模型" class="headerlink" title="基于联邦的统一流量模型"></a>基于联邦的统一流量模型</h4><p>Spec</p>
<ul>
<li>Scope</li>
<li><p>TrafficTemplate</p>
<ul>
<li>Istio models</li>
<li>Kubernetes Services</li>
</ul>
</li>
<li><p>Override</p>
<ul>
<li>可为不同目标集群修改模板属性值</li>
<li>支持多种 override 方法<ul>
<li>jsonPatch</li>
<li>mergePatch</li>
</ul>
</li>
</ul>
</li>
<li><p>Policy</p>
<ul>
<li>PlacementPolicy</li>
<li>RolloutPolicy</li>
<li>RuntimePolicy</li>
</ul>
</li>
</ul>
<p>Status</p>
<ul>
<li><p>Conditions</p>
<ul>
<li>四层网关状态</li>
<li>七层网关配置完成度</li>
<li>证书版本</li>
<li>网关服务 IP 和 FODN</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于联邦的统一流量模型.png" alt="基于联邦的统一流量模型"></p>
<h5 id="统一流量模型-Nameservice"><a href="#统一流量模型-Nameservice" class="headerlink" title="统一流量模型 - Nameservice"></a>统一流量模型 - Nameservice</h5><p>Spec</p>
<ul>
<li>GlobalName FODN</li>
<li>TTL</li>
<li><p>DNSPolicy</p>
<ul>
<li>RoundRobin</li>
<li>Locality</li>
<li>Ratio</li>
</ul>
</li>
<li><p>HeathCheck Port</p>
</li>
<li><p>Target</p>
<ul>
<li>Target Service FQDN</li>
<li>Ratio</li>
</ul>
</li>
</ul>
<p>Status</p>
<ul>
<li><p>Conditions</p>
<ul>
<li>域名配置结果</li>
</ul>
</li>
<li><p>配置错误信息</p>
</li>
</ul>
<h4 id="AccessPoint-控制器"><a href="#AccessPoint-控制器" class="headerlink" title="AccessPoint 控制器"></a>AccessPoint 控制器</h4><p>PlacementPolicy控制，用户可以选择目标集群来完成流量配置，甚至可以选择关联的FederatedDeployment 对象，使得 AccessPoint 自动发现目标集群并完成配置。</p>
<p>完成了状态上报，包括网关虚拟IP地址，网关 FQDN，证书安装状态以及版本信息，路由策略是否配置完成等。这补齐了 Istio 自身的短板，使得任何部署在 lstio 的应用的网络配置状态一目了然。</p>
<p>发布策略控制，针对多集群的配置，可实现单集群的灰度发布，并且能够自动暂停发布，管理员验证单个集群的变更正确以后，再继续发布。通过此机制，避免因为全局流量变更产生的故障。</p>
<p>不同域名的 AccessPoint 可拥有不同的四层网关虚拟IP 地址，以实现基于 IP 地址的四层网络隔离。</p>
<p>控制器可以基于 AccessPoint 自动创建 WorkloadEntry，并设置 Locality 信息。</p>
<h4 id="未来展望"><a href="#未来展望" class="headerlink" title="未来展望"></a>未来展望</h4><p>全面构建基于 Mesh 的流量管理</p>
<p>在用户无感知的前提下将南北流量转成东西流量</p>
<p>数据平面加速 Cilium</p>
<h2 id="基于Kubernetes和Istio的安全保证"><a href="#基于Kubernetes和Istio的安全保证" class="headerlink" title="基于Kubernetes和Istio的安全保证"></a>基于Kubernetes和Istio的安全保证</h2><h3 id="云原生语境下的安全保证"><a href="#云原生语境下的安全保证" class="headerlink" title="云原生语境下的安全保证"></a>云原生语境下的安全保证</h3><ul>
<li>安全保证是贯穿软件整个生命周期的重要部分。</li>
<li>安全与效率有时候是相违背的。</li>
<li>如何将二者统一起来，提升整体效率是关键</li>
<li>这需要我们将安全思想贯穿到软件开发运维的所有环节</li>
</ul>
<h4 id="云原生层次模型"><a href="#云原生层次模型" class="headerlink" title="云原生层次模型"></a>云原生层次模型</h4><p>软件的生命周期: 开发-&gt;分发-&gt;部署-&gt;运行</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/云原生层次模型.png" alt="云原生层次模型"></p>
<h5 id="开发环节的安全保证"><a href="#开发环节的安全保证" class="headerlink" title="开发环节的安全保证"></a>开发环节的安全保证</h5><p>SaaS 应用的 12-factor 设计原则的一些理念与云原生安全不谋而合。</p>
<p>传统的安全三元素 CIA(Confidentiality,Integrity和 Availability)，在云原生安全中被充分应用，如对工作负载的完整性保护，与I(Integrity)完整性保护相对应</p>
<ul>
<li>机密性(Confidentiality)指只有授权用户可以获取信息。</li>
<li>完整性(integrity)指信息在输入和传输的过程中，不被非法授权修改和破坏，保证数据的一致性。</li>
<li>可用性(Availability)指保证合法用户对信息和资源的使用不会被不正当地拒绝。</li>
</ul>
<p>基础设施即代码(Infrastructure as code,简称 laC)也与云原生的实践紧密相关</p>
<p>这些方法和原则，都强调通过早期集成安全检测，以确保对过程的控制，使其按预期运行</p>
<p>通过早期检测的预防性成本，降低后续的修复成本，提升了安全的价值，</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/开发环节的安全保证.png" alt="开发环节的安全保证"></p>
<h5 id="分发环节的安全保证"><a href="#分发环节的安全保证" class="headerlink" title="分发环节的安全保证"></a>分发环节的安全保证</h5><p>云原生应用生命周期中的分发阶段不仅需要包括验证工作负载本身的完整性的方法，还需要包括创建工作负载的过程和操作手段。</p>
<p>对于软件生产周期流水线中产生的工件(如容器镜像)，需要进行持续的自动扫描和更新来确保安全，防止漏洞、恶意软件、不安全的编码和其他不安全的行为。</p>
<p>在完成这些检查后，更重要的是对产品进行加密签名，以确保产品的完整性及不可抵赖性</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/分发环节的安全保证.png" alt="分发环节的安全保证"></p>
<h5 id="部署环节的安全保证"><a href="#部署环节的安全保证" class="headerlink" title="部署环节的安全保证"></a>部署环节的安全保证</h5><p>在整个开发和集成发布阶段，应对候选工作负载的安全性进行实时和持续的验证，如，对签名的工件进行校验，确保容器镜像安全和运行时安全，并可验证主机的适用性。</p>
<p>安全工作负载的监控能力，应以可信的方式监控日志和可用指标，与工作负载一同部署来完善整体的安全性。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/部署环节的安全保证.png" alt="部署环节的安全保证"></p>
<h5 id="运行时环节的安全保证"><a href="#运行时环节的安全保证" class="headerlink" title="运行时环节的安全保证"></a>运行时环节的安全保证</h5><p>应用程序通常由多个独立和单一职责的微服务组成，容器编排层使得这些微服务通过服务层抽象进行相互通信。</p>
<p>确保这种相互关联的组件架构安全的最佳实践，包括以下几点:</p>
<ol>
<li>只有经过批准的进程能在容器命名空间内运行;</li>
<li>禁止并报告未经授权的资源访问;</li>
<li>监控网络流量以检测恶意的活动;</li>
<li>服务网格是另一种常见的服务层抽象，它为已经编排的服务提供了整合和补充功能，而不会改变工作负载软件本身(例如，API流量的日志记录、传输加密、可观察性标记、认证和授权)。</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/运行时环节的安全保证.png" alt="运行时环节的安全保证"></p>
<h3 id="容器运行时的安全保证"><a href="#容器运行时的安全保证" class="headerlink" title="容器运行时的安全保证"></a>容器运行时的安全保证</h3><h4 id="以-Non-root-身份运行容器"><a href="#以-Non-root-身份运行容器" class="headerlink" title="以 Non-root 身份运行容器"></a>以 Non-root 身份运行容器</h4><p>在 Dockerfile 中通过 USER 命令切换成非 root 用户</p>
<p>原因分析:</p>
<p>防止某些坏的镜像窃取主机的 root 权限并造成危害。</p>
<p>有些运行时容器内部的 root用户与主机的root 用户是同一个用户，如不进行用户切换很可能因为权限过大引发严重的问题，比如一个最简单的case，主机上的重要文件夹被 mount 到容器内部，并被容器修改配置。</p>
<p>即使在容器内部也应该进行权限隔离，比如当我们希望构建不可变配置的容器镜像时，应该将运行容器的用户切换为非 root用户，并且限制其读写权限和读写目录。</p>
<pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">FROM ubuntu
RUN user add patrick
USER patrick<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="User-Namespace-和-rootless-container"><a href="#User-Namespace-和-rootless-container" class="headerlink" title="User Namespace 和 rootless container"></a>User Namespace 和 rootless container</h4><p>User Namespace.</p>
<ul>
<li>依赖于 User namespace，任何容器内部的用户都会映射成主机的非root 用户</li>
<li>但该功能未被默认 enable，因其引入配置复杂性，比如系统不知道主机用户和容器用户的映射关系，在 mount 文件的时候无法设置适当的权限。</li>
</ul>
<p>Rootless container:</p>
<ul>
<li>rootless container 是指容器运行时以非 root 身份启动。</li>
<li>在该配置下，即使容器被突破，在主机层面获得的用户权限也是非 root 身份的用户，这确保了安全。</li>
<li>Docker 和其他运行时本身的后台 Daemon(如Docker Daemon)需要 root身份运行，然后其他用户的容器才能以 rootless 身份运行。</li>
<li>一些运行时，比如 Podman，无需 Daemon 进程，因为可以完全不需要root 身份。</li>
</ul>
<h4 id="集群的安全性保证"><a href="#集群的安全性保证" class="headerlink" title="集群的安全性保证"></a>集群的安全性保证</h4><p>保证容器与容器之间、容器与主机之间隔离，限制容器对其他容器和主机的消极影响。</p>
<p>保证组件、用户及容器应用程序都是最小权限，限制它们的权限范围。</p>
<p>保证集群的敏感数据的传输和存储安全。</p>
<p>常用手段</p>
<ul>
<li>Pod安全上下文(Pod Security Context)</li>
<li>APIServer的认证、授权、审计和准入控制</li>
<li>数据的加密机制等</li>
</ul>
<h3 id="Kubernetes-的安全保证"><a href="#Kubernetes-的安全保证" class="headerlink" title="Kubernetes 的安全保证"></a>Kubernetes 的安全保证</h3><h4 id="集群的安全通信"><a href="#集群的安全通信" class="headerlink" title="集群的安全通信"></a>集群的安全通信</h4><p>Kubernetes期望集群中所有的 API通信在默认情况下都使用 TLS 加密，大多数安装方法也允许创建所需的证书并且分发到集群组件中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/集群的安全通信.png" alt="集群的安全通信"></p>
<h4 id="控制面安全保证"><a href="#控制面安全保证" class="headerlink" title="控制面安全保证"></a>控制面安全保证</h4><p>认证</p>
<ul>
<li>小型的单用户集群可能希望使用简单的证书或静态承载令牌方法。</li>
<li>更大的集群则可能希望整合现有的、OIDC、LDAP 等允许用户分组的服务器。</li>
<li>所有 API客户端都必须经过身份验证，即使它是基础设施的一部分，比如节点、代理、调度程序和卷插件。这些客户端通常使用服务帐户或 X509 客户端证书，并在集群启动时自动创建或是作为集群安装的一部分进行设置。</li>
</ul>
<p>授权</p>
<ul>
<li>与身份验证一样，简单而广泛的角色可能适合于较小的集群，但是随着更多的用户与集群交互，可能.需要将团队划分成有更多角色限制的单独的命名空间。</li>
</ul>
<p>配额</p>
<ul>
<li>资源配额限制了授予命名空间的资源的数量或容量。这通常用于限制命名空间可以分配的 CPU、内存或持久磁盘的数量，但也可以控制每个命名空间中有多少个 Pod、服务或卷的存在。</li>
</ul>
<h4 id="NodeRestriction"><a href="#NodeRestriction" class="headerlink" title="NodeRestriction"></a>NodeRestriction</h4><p>准入控制器限制了 kubelet 可以修改的 Node 和 Pod 对象，kubelet 只可修改自己的 Node API对象，只能修改绑定到节点本身的 Pod 对象。</p>
<p>NodeRestriction 准入插件可防止 kubelet 删除 Node API 对象。</p>
<p>防止 kubelet 添加/删除/更新带有 <code>node-restriction.kubernetes.io/</code> 前缀的标签将来的版本可能会增加其他限制，以确保 kubelet具有正常运行所需的最小权限集。</p>
<p>思考为什么?</p>
<p>降低获得 kubelet kubeconfig 的人能做成的破坏。</p>
<h4 id="存储加密"><a href="#存储加密" class="headerlink" title="存储加密"></a>存储加密</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> APIServer.config.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> EncryptionConfiguration
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> secrets
  <span class="token key atrule">providers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">identity</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">aesgcm</span><span class="token punctuation">:</span>
      <span class="token key atrule">keys</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> key1
        <span class="token key atrule">secret</span><span class="token punctuation">:</span> c2VjcmVOlGlzIHNIY3VyZQ=
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> key2
        <span class="token key atrule">secret</span><span class="token punctuation">:</span> dGhpcyBpcyBWYXNzd29yZA=
    <span class="token punctuation">-</span> <span class="token key atrule">aescbc</span><span class="token punctuation">:</span>
      <span class="token key atrule">keys</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> key1
        <span class="token key atrule">secret</span><span class="token punctuation">:</span> c2VjcmV0lGlzIHNlY3VyZO==
      <span class="token punctuation">-</span> <span class="token key atrule">secretbox</span><span class="token punctuation">:</span>
        <span class="token key atrule">keys</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> key1
          <span class="token key atrule">secret</span><span class="token punctuation">:</span> YW<span class="token punctuation">]</span>jZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoxMjM0NTY
      <span class="token punctuation">-</span> <span class="token key atrule">kms</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> myKmsPlugin
        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///tmp/socketfile.sock
        <span class="token key atrule">cachesize</span><span class="token punctuation">:</span> <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="runAsUser"><a href="#runAsUser" class="headerlink" title="runAsUser"></a>runAsUser</h4><ul>
<li>SecurityContext</li>
<li>PodsecurityPolicy</li>
<li>MustRunAs</li>
<li>MustRunAsNonRoot</li>
</ul>
<h4 id="Security-Context"><a href="#Security-Context" class="headerlink" title="Security Context"></a>Security Context</h4><p>Pod 定义包含了一个安全上下文，用于描述允许它请求访问某个节点上的特定 Linux 用户(如root)、获得特权或访问主机网络，以及允许它在主机节点上不受约束地运行的其它控件。</p>
<p>Pod 安全策略可以限制哪些用户或服务帐户可以提供危险的安全上下文设置。例如:Pod 的安全策略可以限制卷挂载，尤其是 hostpath，这些都是 Pod 应该控制的一些方面。</p>
<p>一般来说，大多数应用程序需要限制对主机资源的访问，他们可以在不能访问主机信息的情况下成功以根进程(UID0)运行。但是，考虑到与root用户相关的特权，在编写应用程序容器时，你应该使用非 root用户运行。\</p>
<p>类似地，希望阻止客户端应用程序逃避其容器的管理员，应该使用限制性的 Pod 安全策略。</p>
<p>Kubernetes 提供了三种配置 Security context 的方法:</p>
<ul>
<li>Container-levelSecurity Context: 仅应用到指定的容器。</li>
<li>Pod-levelSecurity Context: 应用到 Pod 内所有容器以及 Volume。</li>
<li>Pod Security Policies(PSP): 应用到集群内部所有 Pod 以及 Volume。</li>
</ul>
<h4 id="Container-level-Security-Context"><a href="#Container-level-Security-Context" class="headerlink" title="Container-level Security Context"></a>Container-level Security Context</h4><p>Container-level Security Context 仅应用到指定的容器上，并且不会影响Volume。比如设置容器运行在特权模式:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world<span class="token punctuation">-</span>container
    <span class="token comment"># The container definition</span>
    <span class="token comment"># ...</span>
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Pod-level-Security-Context"><a href="#Pod-level-Security-Context" class="headerlink" title="Pod-level Security Context"></a>Pod-level Security Context</h4><p>Pod-level Security Context 应用到 Pod内所有容器，并且还会影响 Volume(包括fsGroup 和 selinuxOptions)</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token comment"># specification of the pod's containers</span>
  <span class="token comment"># ...</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1234</span>
    <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">5678</span> <span class="token punctuation">]</span>
    <span class="token key atrule">seLinuxOptions</span><span class="token punctuation">:</span>
      <span class="token key atrule">level</span><span class="token punctuation">:</span> <span class="token string">"s0:c123,c456"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Pod-Security-Policies-PSP"><a href="#Pod-Security-Policies-PSP" class="headerlink" title="Pod Security Policies(PSP)"></a>Pod Security Policies(PSP)</h4><p>Pod Security Policies(PSP)是集群级的 Pod 安全策略，自动为集群内的 Pod 和 Volume 设置Security Context.</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/PodSecurityPolicies.png" alt="PodSecurityPolicies"></p>
<h5 id="PSP-示例"><a href="#PSP-示例" class="headerlink" title="PSP 示例"></a>PSP 示例</h5><p>限制容器的 host 端口范围为 8000-8080:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> permissive
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">hostPorts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">8000</span>
    <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'*'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Taint"><a href="#Taint" class="headerlink" title="Taint"></a>Taint</h3><h4 id="为节点增加-taint"><a href="#为节点增加-taint" class="headerlink" title="为节点增加 taint"></a>为节点增加 taint</h4><p>使用命令 kubectl taint 给节点增加一个 Taint:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectltaint nodes node1 <span class="token assign-left variable">key</span><span class="token operator">=</span>value:Noschedule<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>运行如下命令删除 Taint:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectltaint nodes nodel key:NoSchedule-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 Podspec 中为容器设定容忍标签</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"key"</span>
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span>
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"value"</span>
  <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"Noschedule"</span>
<span class="token punctuation">---</span>
<span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"key"</span>
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>
  <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"Noschedule"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Taint-1"><a href="#Taint-1" class="headerlink" title="Taint"></a>Taint</h4><p>可以以租户为粒度，为不同租户的节点增加 Taint，使得节点彼此隔离。</p>
<p>Taint 的作用是让租户独占节点，无对应 Toleration 的 Pod 无法被调度到 Taint 节点上，实现了应用部署的隔离。</p>
<h3 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h3><h4 id="NetworkPolicy-1"><a href="#NetworkPolicy-1" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h4><p>如果你希望在 IP 地址或端口层面(OSl第3层或第4层)控制网络流量，则你可以考虑为集群中特定应用使用 Kubernetes网络策略(NetworkPolicy)</p>
<p>Pod 可以通信的 Pod 是通过如下三个标识符的组合来辩识的:</p>
<ul>
<li>其他被允许的 Pods;</li>
<li>被允许的名字空间;</li>
<li>IP 组块。</li>
</ul>
<p>网络策略通过网络插件来实现。要使用网络策略，你必须使用支持NetworkPolicv的网络解决方案。创建一个 NetworkPolicy资源对象而没有控制器来使它生效的话，是没有任何作用的。</p>
<h4 id="隔离和非隔离的-Pod"><a href="#隔离和非隔离的-Pod" class="headerlink" title="隔离和非隔离的 Pod"></a>隔离和非隔离的 Pod</h4><p>默认情况下，Pod 是非隔离的，它们接受任何来源的流量。</p>
<p>Pod 在被某 NetworkPolicy选中时进入被隔离状态。</p>
<p>一旦名字空间中有 NetworkPolicy选择了特定的 Pod，该 Pod 会拒绝该 NetworkPolicy 所不允许的连接</p>
<p>网络策略不会冲突，它们是累积的。如果任何一个或多个策略选择了一个Pod，则该 Pod 受限于这些策略的入站(Ingress)/出站(Egress)规则的并集。因此评估的顺序并不会影响策略的结果。</p>
<p>为了允许两个 Pods 之间的网络数据流，源端 Pod 上的出站(Egress)规则和目标端 Pod 上的入站(Ingress)规则都需要允许该流量。如果源端的出站(Egress)规则或目标端的入站(ingress)规则拒绝该流量，则流量将被拒绝。</p>
<h4 id="安全策略属性"><a href="#安全策略属性" class="headerlink" title="安全策略属性"></a>安全策略属性</h4><p>spec: </p>
<ul>
<li>NetworkPolicy规约中包含了在一个名字空间中定义特定网络策略所需的所有信息。</li>
</ul>
<p>podSelector:</p>
<ul>
<li>每个 NetworkPolicy都包括一个 podSelector，它对该策略所适用的一组 Pod 进行选择。</li>
<li>空的 podSelector 选择名字空间下的所有 Pod。</li>
</ul>
<p>policyTypes:</p>
<ul>
<li>每个 NetworkPolicy都包含一个 policyTypes 列表，其中包含 Ingress 或 Egress 或两者兼具</li>
<li>如果 NetworkPolicy 未指定 policyTypes 则默认情况下始终设置 Ingress;</li>
<li>如果 NetworkPolicy 有任何出口规则的话则设置 Egress。</li>
</ul>
<p>Ingress:</p>
<ul>
<li>每个 NetworkPolicy 可包含一个Ingress 规则的白名单列表。</li>
<li>每个规则都允许同时匹配 from 和 ports 部分的流量。</li>
</ul>
<p>Egress:</p>
<ul>
<li>每个 NetworkPolicy 可包含一个 Egress 规则的白名单列表。</li>
<li>每个规则都允许匹配 to 和 port 部分的流量。</li>
</ul>
<h4 id="NetworkPolicy-2"><a href="#NetworkPolicy-2" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>network<span class="token punctuation">-</span>policy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">role</span><span class="token punctuation">:</span> db <span class="token comment"># 隔离"default"名字空间下"role=db"的 Pod</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
  <span class="token punctuation">-</span> Egress
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token comment"># "default"名字空间下带有"role=frontend"标签的所有 Pod</span>
  <span class="token comment"># 带有"project=myproject"标签的所有名字空间中的 Pod</span>
  <span class="token comment"># IP 地址范围为 172.17.0.0-172.17.0.255 和172.17.2.0-172.17.255.255</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
      <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 172.17.0.0/16
      <span class="token key atrule">except</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 172.17.1.0/24
    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">project</span><span class="token punctuation">:</span> myproject
    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">role</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token comment"># 允许从带有"role=db"标签的名字空间下的任何 Poc到 CIDR 10.0.0.0/24下5978 TCP 端口</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
      <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 10.0.0.0/24
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5978</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="默认策略"><a href="#默认策略" class="headerlink" title="默认策略"></a>默认策略</h4><p>默认拒绝所有入站流量</p>
<blockquote>
<p>即使是同一个 POD 的流量也会拒绝。</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>deny<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认允许所有入站流量</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>all<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认允许所有出站流量</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>all<span class="token punctuation">-</span>egress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Egress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认拒绝所有入口和所有出站流量</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>deny<span class="token punctuation">-</span>all
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podselector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
  <span class="token punctuation">-</span> Egress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="依托于-Calico-的-NetworkPolicy"><a href="#依托于-Calico-的-NetworkPolicy" class="headerlink" title="依托于 Calico 的 NetworkPolicy"></a>依托于 Calico 的 NetworkPolicy</h3><h4 id="NetworkPolicy-3"><a href="#NetworkPolicy-3" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h4><p>NetworkPolicy是命名空间级别资源。规则应用于与标签选择器匹配的endpoint 的集合</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>tcp<span class="token punctuation">-</span><span class="token number">90</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> app =='envoy' <span class="token comment"># 应用此策略的endpoint</span>
  <span class="token key atrule">types</span><span class="token punctuation">:</span> <span class="token comment"># 应用策略的流量方向</span>
  <span class="token punctuation">-</span> Ingress
  <span class="token punctuation">-</span> Egress
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span> <span class="token comment"># 入口的流量规则</span>
  <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> Allow <span class="token comment">#流量的行为</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> ICMP <span class="token comment">#流量的协议</span>
    <span class="token key atrule">notProtocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 匹配流量协议不为值的流量</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span> <span class="token comment"># 流量的来源 src与 dst 的匹配关系为与，所有的都生效即生效</span>
      <span class="token key atrule">nets</span><span class="token punctuation">:</span> <span class="token comment"># 有效的来源IP</span>
      <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment">#标签选择器</span>
      <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span> <span class="token comment"># 名称空间选择器</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment">#端口</span>
      <span class="token punctuation">-</span> <span class="token number">80</span> <span class="token comment"># 单独端口</span>
      <span class="token punctuation">-</span> 6040<span class="token punctuation">:</span><span class="token number">6050</span> <span class="token comment"># 端口范围</span>
    <span class="token key atrule">destination</span><span class="token punctuation">:</span> <span class="token comment"># 流量的目标</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span> <span class="token comment"># 出口的流量规则</span>
  <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> Allow
  <span class="token key atrule">serviceAccountselector</span><span class="token punctuation">:</span> <span class="token comment">#使用与此规则的serviceAccount</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="GlobalNetworkPolicy"><a href="#GlobalNetworkPolicy" class="headerlink" title="GlobalNetworkPolicy"></a>GlobalNetworkPolicy</h4><p>GlobalNetworkPolicy与 NetworkPolicy功能一样，是整个集群级别的资源。</p>
<p>GlobalNetworkPolicy会在集群中所有 Namespace 生效，并且能限制主机(HostEndpoint)。</p>
<h4 id="创建-NetworkPolicy-并查看结果"><a href="#创建-NetworkPolicy-并查看结果" class="headerlink" title="创建 NetworkPolicy 并查看结果"></a>创建 NetworkPolicy 并查看结果</h4><p>创建 networkpolicy <code>kubectl apply -f module14/networkpolicy.yaml</code></p>
<p>查看创建结果 <code>kubectl get po -nns-calico-01</code></p>
<p>登陆toolbox 容器 <code>kubectlexec -it toolbox-68f79dd5f8-4664n bash</code></p>
<p>测试网络</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ping</span> <span class="token number">192.168</span>.119.84
PING <span class="token number">192.168</span>.119.84<span class="token punctuation">(</span><span class="token number">192.168</span>.119.84<span class="token punctuation">)</span>
<span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
^C
--- <span class="token number">192.168</span>.119.84 <span class="token function">ping</span> statistics ---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="理解-Calico-的防火墙规则"><a href="#理解-Calico-的防火墙规则" class="headerlink" title="理解 Calico 的防火墙规则"></a>理解 Calico 的防火墙规则</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/理解Calico的防火墙规则.png" alt="理解Calico的防火墙规则"></p>
<h4 id="创建-NetworkPolicy-并查看结果-1"><a href="#创建-NetworkPolicy-并查看结果-1" class="headerlink" title="创建 NetworkPolicy 并查看结果"></a>创建 NetworkPolicy 并查看结果</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/创建NetworkPolicy并查看结果.png" alt="创建NetworkPolicy并查看结果"></p>
<h4 id="创建规则允许ICMP"><a href="#创建规则允许ICMP" class="headerlink" title="创建规则允许ICMP"></a>创建规则允许ICMP</h4><p>创建规则允许ICMP 协议 <code>kubectl apply -f module14/allow-icmp-incluster.yaml</code></p>
<p>查看结果</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nsenter -t <span class="token number">5989</span> -n <span class="token function">ping</span> <span class="token number">192.168</span>.119.84
PING <span class="token number">192.168</span>.119.84<span class="token punctuation">(</span><span class="token number">192.168</span>.119.84<span class="token punctuation">)</span><span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytesof data.
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.119.84:icmp <span class="token assign-left variable">seg</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.061</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.119.84:icmp <span class="token assign-left variable">seg</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.071</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="查看规则变化"><a href="#查看规则变化" class="headerlink" title="查看规则变化"></a>查看规则变化</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/查看规则变化.png" alt="查看规则变化"></p>
<h3 id="零信任架构-ZTA"><a href="#零信任架构-ZTA" class="headerlink" title="零信任架构(ZTA)"></a>零信任架构(ZTA)</h3><h4 id="传统安全模型"><a href="#传统安全模型" class="headerlink" title="传统安全模型"></a>传统安全模型</h4><p>DMZ 模式</p>
<p>传统的网络安全架构理念是基于边界的安全架构，企业构建网络安全体系时，首先寻找安全边界，把网络划分为外网、内网、DMZ(DeMilitarized Zone)区等不同的区域然后在边界上部署防火墙、入侵检测、WAF 等产品。</p>
<p>这种网络安全架构假设或默认了内网比外网更安全，在某种程度上预设了对内网中的人、设备和系统的信任，忽视加强内网安全措施。</p>
<p>不法分子一旦突破企业的边界安全防护进入内网，会像进入无人之境，将带来严重的后果。</p>
<p>传统的认证，即信任、边界防护、静态访问控制、以网络为中心。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/DMZ模式.png" alt="DMZ模式"></p>
<h4 id="零信任架构-Zero-Trust-Architecture，ZTA"><a href="#零信任架构-Zero-Trust-Architecture，ZTA" class="headerlink" title="零信任架构(Zero Trust Architecture，ZTA)"></a>零信任架构(Zero Trust Architecture，ZTA)</h4><p>随着云计算、大数据、物联网、移动办公等新技术与业务的深度融合，网络安全边界也逐渐变得更加模糊，传统边界安全防护理念面临巨大挑战。</p>
<p>零信任核心原则: <strong>从不信任，始终验证</strong></p>
<p>动态安全架构:</p>
<ul>
<li>以身份为中心</li>
<li>以识别、持续认证、动态访问控制、授权、审计以及监测为链条</li>
<li>以最小化实时授权为核心</li>
<li>以多维信任算法为基础</li>
<li>认证达末端</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/零信任架构.png" alt="零信任架构"></p>
<p>与边界模型的”信任但验证”不同，零信任的核心原则是”从不信任、始终验证”</p>
<p>根据 Evan Gilman《Zero Trust Networks》书中所述，零信任网络建立在五个假设前提之下:</p>
<ul>
<li>应该始终假设网络充满威胁;</li>
<li>外部和内部威胁每时每刻都充斥着网络;</li>
<li>不能仅仅依靠网络位置来确认信任关系;</li>
<li>所有设备、用户、网络流量都应该被认证和授权，</li>
<li>访问控制策略应该动态地基于尽量多的数据源进行计算和评估</li>
</ul>
<h4 id="ZTA-安全模型"><a href="#ZTA-安全模型" class="headerlink" title="ZTA 安全模型"></a>ZTA 安全模型</h4><ul>
<li>零信任数据</li>
<li>零信任人员</li>
<li>零信任网络</li>
<li>零信任工作负载</li>
<li>零信任设备</li>
<li>可视化和分析</li>
<li>自动化和编排</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ZTA安全模型.png" alt="ZTA安全模型"></p>
<h4 id="零信任架构的三大技术-“SIM”"><a href="#零信任架构的三大技术-“SIM”" class="headerlink" title="零信任架构的三大技术 “SIM”"></a>零信任架构的三大技术 “SIM”</h4><p>零信任架构的三大技术”SIM”，即</p>
<ul>
<li>软件定义边界(SDP,Software Defined Perimeter)</li>
<li>身份识别与访问管理(IAM,Identityand Access Management)</li>
<li>微隔离(MSG,Micro Segmentation)</li>
</ul>
<h4 id="软件定义边界-SDP"><a href="#软件定义边界-SDP" class="headerlink" title="软件定义边界(SDP)"></a>软件定义边界(SDP)</h4><p>SDP 旨在使应用程序所有者能在需要时部署安全边界，以便将服务与不安全的网络隔离开</p>
<p>SDP 将物理设备替换为在应用程序所有者控制下运行的逻辑组件，仅在设备验证和身份验证后才允许访问企业应用基础架构。</p>
<p>基于 SDP 的系统通常会实施控制层与数据层的分离:</p>
<ul>
<li>控制流阶段，用户及其设备进行预认证来获取丰富的属性凭据作为身份主体，以此结合基于属性的预授权策略，映射得到仅供目标访问的特定设备和服务;</li>
<li>数据传输阶段直接建立相应安全连接并传输数据。</li>
</ul>
<h4 id="身份识别与访问管理-IAM"><a href="#身份识别与访问管理-IAM" class="headerlink" title="身份识别与访问管理(IAM)"></a>身份识别与访问管理(IAM)</h4><p>零信任强调基于身份的信任链条，即该身份在可信终端，该身份拥有权限才可对资源进行请求</p>
<p>传统的 IAM 系统可以协助解决身份唯一标识、身份属性、身份全生命周期管理的功能问题</p>
<p>通过 IAM 将身份信息(身份吊销离职、身份过期、身份异常等)传递给零信任系统后，零信任系统可以通过 IAM 系统的身份信息来分配相应权限</p>
<p>通过 IAM 系统对身份的唯一标识，可有利于零信任系统确认用户可信，通过唯一标识对用户身份建立起终端、资源的信任关系，并在发现风险时实施针对关键用户相关的访问连接进行阻断等控制。</p>
<h4 id="微隔离-MSG"><a href="#微隔离-MSG" class="headerlink" title="微隔离(MSG)"></a>微隔离(MSG)</h4><p>微隔离本质上是一种网络安全隔离技术</p>
<ul>
<li>能够在逻辑上将数据中心划分为不同的安全段，一直到各个工作负载级别;。</li>
<li>为每个独立的安全段定义访问控制策略。</li>
</ul>
<p>它主要聚焦在云平台东西向流量的隔离</p>
<ul>
<li>一是区别传统物理防火墙的隔离作用;</li>
<li>二是更加贴近云计算环境中的真实需求</li>
</ul>
<p>微隔离将网络边界安全理念发挥到极致，将网络边界分割到尽可能的小，能够很好的缓解传统边界安全理念下的边界过度信任带来的安全风险。</p>
<h3 id="基于-Istio-的安全保证"><a href="#基于-Istio-的安全保证" class="headerlink" title="基于 Istio 的安全保证"></a>基于 Istio 的安全保证</h3><h4 id="微服务架构下的安全挑战"><a href="#微服务架构下的安全挑战" class="headerlink" title="微服务架构下的安全挑战"></a>微服务架构下的安全挑战</h4><p>为了抵御中间人攻击，需要流量加密</p>
<p>为了提供灵活的服务访问控制，需要双向 TLS 和细粒度的访问策略</p>
<p>要确定谁在什么时候做了什么，需要审计工具。</p>
<h4 id="Istio-的安全保证"><a href="#Istio-的安全保证" class="headerlink" title="Istio 的安全保证"></a>Istio 的安全保证</h4><p>Istio 安全功能提供</p>
<ul>
<li>身份识别;</li>
<li>灵活策略</li>
<li>透明的 TLS 加密;</li>
<li>认证，授权和审计(AAA)工具来保护你的服务和数据。</li>
</ul>
<p>Istio 安全的目标是</p>
<ul>
<li>默认安全:应用程序代码和基础设施无需更改。</li>
<li>深度防御:与现有安全系统集成以提供多层防御</li>
<li>零信任网络:在不受信任的网络上构建安全解决方案，</li>
</ul>
<h4 id="高层架构"><a href="#高层架构" class="headerlink" title="高层架构"></a>高层架构</h4><p>用于密钥和证书管理的证书颁发机构(CA)。</p>
<p>配置 API服务器分发给代理:</p>
<ul>
<li>认证策略</li>
<li>授权策略</li>
</ul>
<p>安全命名信息</p>
<p>Sidecar和边缘代理作为 Policy Enforcement Points(PEPS)以保护客户端和服务器之间的通信安全。</p>
<p>一组 Envoy 代理扩展，用于管理遥测和审计。</p>
<h4 id="Istio-安全架构"><a href="#Istio-安全架构" class="headerlink" title="Istio 安全架构"></a>Istio 安全架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Istio安全架构.png" alt="Istio安全架构"></p>
<h4 id="Istio-身份"><a href="#Istio-身份" class="headerlink" title="Istio 身份"></a>Istio 身份</h4><p>身份是任何安全基础架构的基本概念</p>
<p>在工作负载间通信开始时，双方必须交换包含身份信息的凭证以进行双向验证。</p>
<p>在客户端，根据安全命名信息检查服务器的标识，以查看它是否是该服务的授权运行程序</p>
<p>在服务器端，服务器可以根据授权策略确定客户端可以访问哪些信息，审计谁在什么时间访问了什么，根据他们使用的工作负载向客户收费，并拒绝任何未能支付账单的客户访问工作负载</p>
<p>Istio 身份模型使用 service identity(服务身份)来确定一个请求源端的身份。</p>
<ul>
<li>Kubernetes: Kubernetes服务帐户</li>
<li>GKE/GCE: 可以使用 GCP 服务帐户</li>
<li>GCP: GCP 服务帐户</li>
<li>AWS: AWS IAM 用户/角色 帐户</li>
<li>On-premises(非 Kubernetes): 用户帐户、自定义服务帐户、服务名称、Istio 服务帐户或 GCP 服务帐户。</li>
</ul>
<p>Istio 安全与 SPIFFE:</p>
<ul>
<li>Istio 和 SPIFFE共享相同的身份文件:SVID(SPIFFE 可验证身份证件)。例如:在 Kubernetes 中X.509 证书的 URI 字段格式为 <code>spiffe://&lt;domain&gt;/ns/&lt;namespace&gt;/sa/&lt;serviceaccount&gt;</code>。这使 Istio 服务能够建立和接受与其他 SPIFFE 兼容系统的连接。</li>
</ul>
<h4 id="SDS"><a href="#SDS" class="headerlink" title="SDS"></a>SDS</h4><p>Istio 供应身份是通过 secret discovery service(SDs)来实现的:</p>
<ul>
<li>istiod 提供 gRPC服务以接受证书签名请求(CSRS)</li>
<li>当工作负载启动时，Envoy通过秘密发现服务(SDS)API向同容器内的 istio-agent 发送证书和密钥请求。</li>
<li>在收到 SDS 请求后,，istio-agent创建私钥和CSR然后将 CSR 及其凭据发送到 istiod CA 进行签名。</li>
<li>istiod CA 验证 CSR 中携带的凭据，成功验证后签署CSR 以生成证书。</li>
<li>istio-agent 通过 Envoy SDS API将私钥和从 lstio CA收到的证书发送给 Envoy。</li>
<li>istio-agent 会监工作负载证书的有效期。上述 CSR过程会周期性地重复，以处理证书和密钥轮换。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/SDS.png" alt="SDS"></p>
<h3 id="认证-2"><a href="#认证-2" class="headerlink" title="认证"></a>认证</h3><h4 id="基于-Istio-的认证"><a href="#基于-Istio-的认证" class="headerlink" title="基于 Istio 的认证"></a>基于 Istio 的认证</h4><p>Istio 通过客户端和服务器端 Policy Enforcement Points(PEPS)建立服务到服务的通信通道</p>
<p>PEPS 在 Istio 架构中的实现是 Envoy。</p>
<p>Peer authentication:</p>
<ul>
<li>用于服务到服务的认证，以验证进行连接的客户端，</li>
</ul>
<p>Istio 提供双向 TLS 作为传输认证的全栈解决方案，无需更改服务代码就可以启用它。这个解决方案为:</p>
<ul>
<li>为每个服务提供强大的身份，表示其角色，以实现跨群集和云的互操作性。</li>
<li>保护服务到服务的通信。</li>
<li>提供密钥管理系统，以自动进行密钥和证书的生成，分发和轮换，</li>
</ul>
<p>Request authentication</p>
<ul>
<li>用于最终用户认证，以验证附加到请求的凭据</li>
<li>Istio 使用 ISON Web Token(WT)验证启用请求级认证，并使用自定义认证实现或任何OpenID Connect的认证实现(例如下面列举的)来简化的开发人员体验。</li>
</ul>
<h4 id="Istio-认证架构"><a href="#Istio-认证架构" class="headerlink" title="Istio 认证架构"></a>Istio 认证架构</h4><p>未设置模式的网格范围的 peer认证策略默认使用 PERMISSIVE 模式。</p>
<p>发送请求的客户端服务负责遵循必要的认证机制。</p>
<p>RequestAuthentication</p>
<ul>
<li>应用程序负责获取JWT 凭证并将其附加到请求，</li>
</ul>
<p>PeerAuthentication</p>
<ul>
<li>Istio 会自动将两个 PEPS 之间的所有流量升级为双向 TLS。</li>
<li>如果认证策略禁用了双向 TLS 模式，则lstio 将继续在 PEPS 之间使用纯文本。</li>
<li>要覆盖此行为，destination rules 显式禁用双向TLS 模式。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Istio认证架构.png" alt="Istio认证架构"></p>
<h4 id="双向-TLS-认证"><a href="#双向-TLS-认证" class="headerlink" title="双向 TLS 认证"></a>双向 TLS 认证</h4><p>当一个工作负载使用双向 TLS 认证向另一个工作负载发送请求时，该请求的处理方式如下:</p>
<ul>
<li>Istio 将出站流量从客户端重新路由到客户端的本地 sidecar Envoy。</li>
<li>客户端 Envoy 与服务器端 Envoy 开始双向 TLS 握手。在握手期间，客户端 Envoy 还做了安全命名检查，以验证服务器证书中显示的服务帐户是否被授权运行目标服务。</li>
<li>客户端 Envoy 和服务器端 Envoy 建立了一个双向的 TLS 连接，lstio 将流量从客户端 Envoy转发到服务器端 Envoy。</li>
<li>授权后，服务器端 Envoy通过本地 TCP 连接将流量转发到服务器服务，</li>
</ul>
<h4 id="宽容模式-permissive-mode"><a href="#宽容模式-permissive-mode" class="headerlink" title="宽容模式(permissive mode)"></a>宽容模式(permissive mode)</h4><p>允许服务同时接受纯文本流量和双向 TLS 流量</p>
<p>这个功能极大地提升了双向 TLS 的入门体验</p>
<p>在运维人员希望将服务移植到启用了双向 TLS 的Istio 上时，许多非Istio 客户端和非 Istio 服务端通信时会产生问题。</p>
<p>通常情况下，运维人员无法同时为所有客户端安装 Istio sidecar，甚至没有这样做的权限。即使在服务端上安装了 Istio sidecar，运维人员也无法在不中断现有连接的情况下启用双向 TLS。</p>
<h4 id="安全命名"><a href="#安全命名" class="headerlink" title="安全命名"></a>安全命名</h4><p>服务器身份(serveridentities)被编码在证书里，但服务名称(service names)通过服务发现或 DNS 被检索</p>
<p>安全命名信息将服务器身份映射到服务名称。</p>
<p>身份 A到服务名称 B的映射表示 “授权 A运行服务 B”</p>
<p>控制平面监视 apiserver，生成安全命名映射，并将其安全地分发到 PEPS。以下示例说明了为什么安全命名对身份验证至关重要。</p>
<h4 id="认证策略"><a href="#认证策略" class="headerlink" title="认证策略"></a>认证策略</h4><p>认证策略是对服务收到的请求生效的，要在双向 TLS 中指定客户端认证策略，需要在 DetinationRule 中设置 TLSSettings。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>mtls
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> mydbserver.prod.svc.cluster.local
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client private key.pem
      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"*.foo.com"</span>
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token punctuation">-</span>istio<span class="token punctuation">-</span>mtls
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings.prod.svc.cluster.local
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> ISTIO MUTUAL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="认证策略-1"><a href="#认证策略-1" class="headerlink" title="认证策略"></a>认证策略</h4><p>相应的需要通过 PeerAuthentication配置服务端接受何种认证方式</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"security.istio.io/v1beta1"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> <span class="token string">"PeerAuthentication"</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"example-peer-policy"</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"foo"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"security.istio.io/v1beta1"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> <span class="token string">"PeerAuthentication"</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"example-workload-policy"</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"foo"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>app
  <span class="token key atrule">portLevelMtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">80</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> DISABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ReouestAuthentication"><a href="#ReouestAuthentication" class="headerlink" title="ReouestAuthentication"></a>ReouestAuthentication</h4><p>Request 认证策略指定验证JSON Web Token(JWT)所需的值。这些值包括</p>
<ul>
<li>token 在请求中的位置</li>
<li>请求的 issuer</li>
<li>公共JSON Web Key Set(JWKS)</li>
</ul>
<p>Istio 会根据 request认证策略中的规则检查提供的令牌(如果已提供)，并拒绝令牌无效的请求当请求不带有令牌时，默认情况下将接受它们。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/vibeta
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RequestAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"default"</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">iwtRules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">issuer</span><span class="token punctuation">:</span> <span class="token string">"testing@secure.istio.io"</span>
    <span class="token key atrule">jwksUri</span><span class="token punctuation">:</span> <span class="token string">"https://raw.githubusercontent.com/istio/istio/release.1.12/security/tools/iwt/samples/iwks.json"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="鉴权-1"><a href="#鉴权-1" class="headerlink" title="鉴权"></a>鉴权</h3><h4 id="授权架构"><a href="#授权架构" class="headerlink" title="授权架构"></a>授权架构</h4><p>每个 Envoy 代理都运行一个授权引擎该引擎在运行时授权请求。</p>
<ul>
<li>当请求到达代理时，授权引擎根据当前授权策略评估请求上下文，并返回授权结果 ALLOW 或 DENY.</li>
<li>授权策略支持 ALLOW 和 DENY 动作拒绝策略优先于允许策略。</li>
<li>如果将任何允许策略应用于工作负载则默认情况下，不符合该策略的访问都将被禁止。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/授权架构.png" alt="授权架构"></p>
<h4 id="授权策略-AuthorizationPolicy"><a href="#授权策略-AuthorizationPolicy" class="headerlink" title="授权策略(AuthorizationPolicy)"></a>授权策略(AuthorizationPolicy)</h4><p>selector 字段指定策略的目标</p>
<p>action 字段指定允许还是拒绝请求</p>
<p>rules 指定何时触发动作</p>
<ul>
<li>rules 下的 from 字段指定请求的来源</li>
<li>rules 下的 to 字段指定请求的操作</li>
<li>rules 下的 when 字段指定应用规则所需的条件</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>deny
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">action</span><span class="token punctuation">:</span> DENY
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># 若非来自 foo，则拒绝</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">notNamespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># 若来自 default/sleep 或 dev，则允许</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cluster.local/ns/default/sa/sleep"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"dev"</span><span class="token punctuation">]</span> <span class="token comment"># OR 关系</span>
    <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span>
    <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> request.auth.claims<span class="token punctuation">[</span>iss<span class="token punctuation">]</span>
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"https://accounts.google.com"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="策略目标"><a href="#策略目标" class="headerlink" title="策略目标"></a>策略目标</h4><p>可以通过 metadata/namespace 字段和可选的 selector字段来指定策略的范围或目标。</p>
<p>metadata/namespace 告诉该策略适用于哪个命名空间。如果将其值设置为根名称空间，则该策略将应用于网格中的所有名称空间。</p>
<p>根命名空间的值是可配置的，默认值为istio-system。</p>
<p>您可以使用 selector 字段来进一步限制策略以应用于特定工作负载。</p>
<p>如果未设置，则授权策略将应用于与授权策略相同的命名空间中的所有工作负载。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>read
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> products
    <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
        <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"HEAD"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="值匹配"><a href="#值匹配" class="headerlink" title="值匹配"></a>值匹配</h4><p>授权策略中的大多数字段都支持以下所有匹配模式</p>
<ul>
<li>完全匹配: 即完整的字符串匹配，</li>
<li>前缀匹配: <code>*</code> 结尾的字符串。例如 <code>test.abc.*</code> 匹配 “test.abc.com”、”test.abc.com.cn”、”test.abc.org” 等等。</li>
<li>后缀匹配: <code>*</code> 开头的字符串。例如 <code>*.abc.com</code> 匹配 “eng.abc.com”、”test.eng.abc.com” 等等。</li>
<li>存在匹配: <code>*</code> 用于指定非空的任意内容。您可以使用格式 <code>fieldname:"*"</code> 指定必须存在的字段。这意味着该字段可以匹配任意内容，但是不能为空。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tester
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> products
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/test/*"</span><span class="token punctuation">,</span> <span class="token string">"*/info"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="全部允许和默认全部拒绝授权策略"><a href="#全部允许和默认全部拒绝授权策略" class="headerlink" title="全部允许和默认全部拒绝授权策略"></a>全部允许和默认全部拒绝授权策略</h4><p>允许完全访问 default 命名空间中的所有工作负载</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>all
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不允许任何对 admin 命名空间工作负载的访问</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deny<span class="token punctuation">-</span>all
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> admin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="自定义条件"><a href="#自定义条件" class="headerlink" title="自定义条件"></a>自定义条件</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      version<span class="token punctuation">:</span>v1
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cluster.local/ns/default/sa/sleep"</span><span class="token punctuation">]</span>
    <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span>
    <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> request.headers<span class="token punctuation">[</span>version<span class="token punctuation">]</span>
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="认证与未认证身份"><a href="#认证与未认证身份" class="headerlink" title="认证与未认证身份"></a>认证与未认证身份</h4><p>如果要使工作负载可公开访问，则需要将 source 部分留空</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      version<span class="token punctuation">:</span>v1
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将 principal 设置为 <code>*</code> 代表仅允许经过认证的用户</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      version<span class="token punctuation">:</span>v1
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>
    <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在普通-TCP-协议上使用-Istio-授权"><a href="#在普通-TCP-协议上使用-Istio-授权" class="headerlink" title="在普通 TCP 协议上使用 Istio 授权"></a>在普通 TCP 协议上使用 Istio 授权</h4><p>如果您授权策略中对 TCP 工作负载使用了任何只适用于 HTTP 的字段，lstio 将会忽略它们。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"security.istio.io/v1beta1"</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>policy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
  <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cluster.local/ns/default/sa/bookinfo-ratings-v2"</span><span class="token punctuation">]</span>
    <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"27017"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="微服务项目的开发和部署案例"><a href="#微服务项目的开发和部署案例" class="headerlink" title="微服务项目的开发和部署案例"></a>微服务项目的开发和部署案例</h2><h3 id="应用管理的实践分享"><a href="#应用管理的实践分享" class="headerlink" title="应用管理的实践分享"></a>应用管理的实践分享</h3><h4 id="多租户系统"><a href="#多租户系统" class="headerlink" title="多租户系统"></a>多租户系统</h4><ul>
<li>基于 Kubernetes 构建多租户平台</li>
<li>基于 Account 的租户治理</li>
<li>基于 Application 的应用治理</li>
</ul>
<h4 id="ApplicationInstance"><a href="#ApplicationInstance" class="headerlink" title="ApplicationInstance"></a>ApplicationInstance</h4><p>Applicationlnstance 描述应用实例，每一组有特定业务目的独立的部署(deploymentstatefulset, daemonset)可定义为一个ApplicationInstance。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/ApplicationInstance.png" alt="ApplicationInstance"></p>
<h4 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h4><p>Application 是对应用的抽象</p>
<p>ApplicationInstance 是应用的部署实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Application.png" alt="Application"></p>
<p>Application 是一个或多个具有相同业务目的的应用实例的抽象。</p>
<p>包含应用配置，应用代码定义，责任人，联系方式等等，</p>
<p>Application 被 Account 管理</p>
<p>Application 定义如下属性:</p>
<ul>
<li>Application type:web,bigdata等是</li>
<li>否要加密Data classification:数据安全需求，</li>
<li>Owner:责任人</li>
<li>Admin Account:管理账号</li>
<li>IssueTracker:问题跟踪地址</li>
<li>GitHub:源代码地址</li>
<li>…</li>
</ul>
<h4 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h4><p>Account是管理应用的账号</p>
<p>Account 也是集群费用分摊实体</p>
<p>Account 是多租户集群中的租户</p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Account.png" alt="Account"></p>
<h4 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Group.png" alt="Group"></p>
<h4 id="Account-树状分级"><a href="#Account-树状分级" class="headerlink" title="Account 树状分级"></a>Account 树状分级</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Account树状分级.png" alt="Account树状分级"></p>
<h4 id="基于-Account-管理的企业组织架构"><a href="#基于-Account-管理的企业组织架构" class="headerlink" title="基于 Account 管理的企业组织架构"></a>基于 Account 管理的企业组织架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/基于Account管理的企业组织架构.png" alt="基于Account管理的企业组织架构"></p>
<h4 id="新模型与-Kubernetes-原生对象的关联"><a href="#新模型与-Kubernetes-原生对象的关联" class="headerlink" title="新模型与 Kubernetes 原生对象的关联"></a>新模型与 Kubernetes 原生对象的关联</h4><p>将 Namespace 定义为应用运行的隔离环境</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
   <span class="token key atrule">application.k8s.io/name</span><span class="token punctuation">:</span> mynginx <span class="token comment"># 该 Namespace 的默认 application</span>
   <span class="token key atrule">account.l8s.io/name</span><span class="token punctuation">:</span> jesse
  name<span class="token punctuation">:</span>mynginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/新模型与Kubernetes原生对象的关联.png" alt="新模型与Kubernetes原生对象的关联"></p>
<h4 id="Kubernetes-应用实战回顾"><a href="#Kubernetes-应用实战回顾" class="headerlink" title="Kubernetes 应用实战回顾"></a>Kubernetes 应用实战回顾</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes应用实战回顾.png" alt="Kubernetes应用实战回顾"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes应用实战回顾二.png" alt="Kubernetes应用实战回顾二"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Kubernetes应用实战回顾三.png" alt="Kubernetes应用实战回顾三"></p>
<h3 id="基于-Bookinfo-的服务治理"><a href="#基于-Bookinfo-的服务治理" class="headerlink" title="基于 Bookinfo 的服务治理"></a>基于 Bookinfo 的服务治理</h3><h4 id="Bookinfo-简介"><a href="#Bookinfo-简介" class="headerlink" title="Bookinfo 简介"></a>Bookinfo 简介</h4><p>Bookinfo 应用分为四个单独的微服务</p>
<ul>
<li>productpage 会调用 details和reviews 两个微服务，用来生成页面。</li>
<li>details 中包含了书籍的信息。</li>
<li>reviews 中包含了书籍相关的评论。它还会调用ratings 微服务</li>
<li>ratings 中包含了由书籍评价组成的评级信息。</li>
</ul>
<p>reviews 微服务有3个版本，可用来展示各服务之间的不同的调用链路</p>
<ul>
<li>v1 版本不会调用 ratings 服务</li>
<li>v2 版本会调用 ratings 服务，并使用1到5个黑色星形图标来显示评分信息</li>
<li>v3 版本会调用 ratings 服务，并使用1到5个红色星形图标来显示评分信息</li>
</ul>
<h4 id="Bookinfo-应用架构"><a href="#Bookinfo-应用架构" class="headerlink" title="Bookinfo 应用架构"></a>Bookinfo 应用架构</h4><p><img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/images/《云原生训练营》学习笔记/Bookinfo应用架构.png" alt="Bookinfo应用架构"></p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载</span>
curl-L https://istio.io/downloadlstiosh

<span class="token comment"># 安装应用</span>
<span class="token builtin class-name">cd</span> /root/istio-1.12.0
kubectl label namespace default istio-injection<span class="token operator">=</span>enabled
kubectl apply -f<span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject -fsamples/bookinfo/platform/kube/bookinfo.yaml<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步:将应用发布至istio ingress 网关</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 Istio 配置对象</span>
$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml

<span class="token comment"># 查看 Istio 网关入口</span>
$ kubectlget svc -n istio-system
istio-ingressgateway LoadBalancer <span class="token number">10.109</span>.127.136 <span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span> <span class="token number">15021</span>:30784/TCP,80:31783/TCP,443:31106/TCP,31400:31463/TCP,15443:31663/TCP  13d

<span class="token comment"># 通过 istio ingress 网关访问 Bookinfo</span>
http://192.168.34.2:31783/productpage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二步:安全保证</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将 http 网关转换为 https 网关</span>
opensslreq -x509-sha256 -nodes -days <span class="token number">365</span> -newkeyrsa:2048 -subj <span class="token string">'/0=cncampInc./CN=192.168.34.2'</span> -keyout bookinfo.key -out bookinfo.crt

kubectl create -n istio-system secret tls bookinfo-credential --key<span class="token operator">=</span>bookinfo.key -cert<span class="token operator">=</span>bookinfo.crt

kubectlapply -f https-gateway.yaml

<span class="token comment"># 通过 https 端口访问 Bookinfo</span>
https://192.168.34.2:31106/productpage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三步:开启全链路 mTLS</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在开启全链路 mTLS 之前，直接访问 productpage 返回成功;</span>

<span class="token comment"># 创建全局默认 PeerAuthentication</span>
$ kubectl apply -f mtls.yaml -n istio-system

<span class="token comment"># 在开启全链路 mTLS 之后，直接访问 productpage 返回不成功</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第四步:开启服务认证授权</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 RequestAuthentication，解密JWT token,</span>
kubectl apply -f requestauthentication.yaml

<span class="token comment"># 创建 AuthorizationPolicy，开启 details 服务基于 JWT 授权;</span>
kubectl apply -f authorizationpolicy.yaml

<span class="token comment"># 访问 productpage 页面，会看到 details 已经无法显示，</span>
<span class="token comment"># Sorry, product details are currently unavailable for this book.</span>

<span class="token comment"># 改造 productpage 应用;</span>
<span class="token comment"># cat productpage-v2/productpage.py</span>

<span class="token comment"># 部署 productpage v2.</span>
kubectl apply -f productpage-v2/productpage.yaml
<span class="token comment"># scale down productpage v1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第五步:开启 http 到 https 的跳转</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新 gateway，增加 80 端口并设置 TLS 转发规则;</span>
kubectl apply -f https-gateway.yaml

<span class="token comment"># 访问 gateway(基于浏览器的跳转不工作，因为 http redirect 跳转至默认端口)</span>
<span class="token function">curl</span> <span class="token number">10.109</span>.127.136/productpage -v -L -k<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第六步:开启 Kiali</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 Prometheus;</span>
kubectl apply -f prometheus.yaml

<span class="token comment"># 安装 Kiali;</span>
kubectl apply -f samples/addons/kiali.yaml

<span class="token comment"># 更新 Kiali service 为 NodePort 类型;</span>
k edit svc kiali -n istio-system

<span class="token comment"># 登录 Kialia，进入 Graph 页面查看调用视图</span>
<span class="token comment"># http://192.168.34.2:31816/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第七步:灰度发布</p>
<p><strong>灰度，就是存在于黑与白之间的一个平滑过渡的区域。</strong> 对于互联网产品来说，上线和未上线就是黑与白之分，而实现未上线功能平稳过渡的一种方式就叫做灰度发布。</p>
<ol>
<li><p>按流量百分比</p>
<p> 先到先得的方式，比如: 限制10% 的用户体验的是新版本，90%的用户体验的是老版本。先访问网站的用户就优先命中新版本，直到流量用完为止。</p>
</li>
<li><p>按人群划分</p>
<p> 按用户 ID、用户 IP、设备类型划分，比如:可通过平时的埋点上报数据得知用户的 PV、UV、页面平均访问时长等数据，根据用户活跃度来让用户优先体验新版本，进而快速观察使用效果。</p>
<p> 按地域、性别、年龄等用户画像划分，比如:可通过用户的性别、年龄等做下新老版本的对比效果来看看目标用户在新版本的使用年龄段，性别范围是多少。</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 为每个服务创建 destinationrule，该步骤将所有服务按版本切分为不同子集;</span>
kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml

<span class="token comment"># 将所有流量转发至v1;</span>
kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml

<span class="token comment"># 访问 Bookinfo，可看到 ratings 从三个版本轮番切换变成了不显示，因为reviews v1 版本不调用ratings;</span>

<span class="token comment"># 定义灰度流量规则，将jason用户切换至reviews v2;</span>
kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml

<span class="token comment"># 访问 Bookinfo，课看到 ratings 变为固定版本。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第八步:故障注入</p>
<blockquote>
<p>故障注入通常用于混乱测试场景，确保单个服务出现故障不会引起联动效应，导致局部错误引起全局系统性故障;</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 为 ratings 服务 v2 添加固定延迟时间:</span>
kubectl apply-fsamples/bookinfo/networking/virtual-service-ratings-test-delay.yaml

<span class="token comment"># 更新后，延迟超出了客户端的等待时间，当登录用户为jason时，productpage页面出错，其他用户</span>
<span class="token comment"># Sorry, product reviews are currently unavailable for this book.</span>

<span class="token comment"># 为 ratings 服务添加错误返回值;</span>
kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml

<span class="token comment"># 更新后 ratings 服务不可用。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第九步:最佳实践</p>
<p>记得为客户端添加超时时间</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">http</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
    <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 0.5s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>记得加断路器规则</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
  <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
    <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxRequestsPerconnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
    <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
    <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
    <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="全课总结"><a href="#全课总结" class="headerlink" title="全课总结"></a>全课总结</h3><h4 id="回顾一下内容"><a href="#回顾一下内容" class="headerlink" title="回顾一下内容"></a>回顾一下内容</h4><p>Go语言</p>
<ul>
<li>核心知识点和原理</li>
</ul>
<p>容器技术</p>
<ul>
<li>Namespace</li>
<li>Cgroup</li>
<li>OverlayFS</li>
<li>Network</li>
<li>最佳实践</li>
</ul>
<p>Kubernetes</p>
<ul>
<li>架构基础</li>
<li>核心组件</li>
<li>生产集群管理</li>
<li>集群运维</li>
<li>应用上云</li>
</ul>
<p>服务网格</p>
<ul>
<li>流量管理</li>
<li>安全</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn" rel="external nofollow noreferrer">Kiba Amor</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://kibazen.cn/yun-yuan-sheng-xun-lian-ying-xue-xi-bi-ji/">https://kibazen.cn/yun-yuan-sheng-xun-lian-ying-xue-xi-bi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://kibazen.cn" target="_blank">Kiba Amor</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                                    <span class="chip bg-color">极客时间</span>
                                </a>
                            
                                <a href="/tags/kubernetes/">
                                    <span class="chip bg-color">kubernetes</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/service-mesh-shi-zhan-xue-xi-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/13.jpg" class="responsive-img" alt="《Service Mesh实战》学习笔记">
                        
                        <span class="card-title">《Service Mesh实战》学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/">
                        <span class="chip bg-color">极客时间</span>
                    </a>
                    
                    <a href="/tags/ServiceMesh/">
                        <span class="chip bg-color">ServiceMesh</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/ling-yu-qu-dong-she-ji-xiang-guan-de-ruan-jian-jia-gou/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/medias/featureimages/21.jpg" class="responsive-img" alt="领域驱动设计相关的软件架构">
                        
                        <span class="card-title">领域驱动设计相关的软件架构</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-11-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="post-category">
                                    软件工程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/">
                        <span class="chip bg-color">领域驱动设计</span>
                    </a>
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/">
                        <span class="chip bg-color">软件架构</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Kiba Amor</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/kibaamor" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:5093911+kibaamor@users.noreply.github.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/kibaamor/kibaamor.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
